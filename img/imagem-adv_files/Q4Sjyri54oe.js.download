;/*FB_PKG_DELIM*/

__d("ArmadilloReceiveWriteDbFailureFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(a,b,c,d,e,f,g){"use strict";a=c("getFalcoLogPolicy_DO_NOT_USE")("5720");b=d("FalcoLoggerInternal").create("armadillo_receive_write_db_failure",a);e=b;g["default"]=e}),98);
__d("MAWCommonWebWorkerErrorLogging",["Env","ErrorGuard","ErrorPubSub","ErrorSetup","ErrorTransport","JSErrorLoggingConfig","SiteData","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function a(){(h||(h=c("ErrorGuard"))).skipGuardGlobal((i||(i=c("Env"))).nocatch),c("ErrorSetup").setup({appId:c("JSErrorLoggingConfig").appId,client_revision:c("SiteData").client_revision,extra:c("JSErrorLoggingConfig").extra,loggingFramework:"worker",projectBlocklist:c("JSErrorLoggingConfig").projectBlocklist,report_source:c("JSErrorLoggingConfig").report_source,report_source_ref:c("JSErrorLoggingConfig").report_source_ref,sample_weight:c("JSErrorLoggingConfig").sampleWeight!=null?c("JSErrorLoggingConfig").sampleWeight:0,site_category:"armadillo-worker"},d("ErrorTransport").log),self.addEventListener("unhandledrejection",function(a){a=a.reason;(j||(j=c("ErrorPubSub"))).reportError(c("getErrorSafe")(a))})}c("ErrorSetup").preSetup();g.init=a}),98);
__d("MAWPREListeners",["MAWODSProxy","MAWQplProxy","SiteData","WALogger","WAMapWithDefault","WAOdsEnums","WAPREList","WAPREMetrics","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p;function a(){d("WAPREMetrics").subscribe(r)}var q=new(d("WAMapWithDefault").MapWithDefault)(function(){return new Map()});function b(a){return r(a)}function r(a){switch(a.name){case d("WAPREList").PRE_METRIC.EBDB_INIT:t(c("qpl")._(521473151,"2593"),a);break;case d("WAPREList").PRE_METRIC.DELETE_THREAD:t(c("qpl")._(1056845732,"691"),a);break;case d("WAPREList").PRE_METRIC.FRANKING_VALIDATION:t(c("qpl")._(25299246,"150"),a);break;case d("WAPREList").PRE_METRIC.QUERY_GROUPS:t(c("qpl")._(741087294,"2028"),a);break;case d("WAPREList").PRE_METRIC.QUERY_GROUP:s(d("WAOdsEnums").Entity.WA_QUERY_GROUP,a);break;case d("WAPREList").PRE_METRIC.OFFLINE_RETRY:t(c("qpl")._(25309990,"124"),a);break;case d("WAPREList").PRE_METRIC.MEDIA_DOWNLOAD:t(c("qpl")._(25312150,"83"),a);break;case d("WAPREList").PRE_METRIC.MEDIA_UPLOAD:t(c("qpl")._(25313100,"131"),a);break;case d("WAPREList").PRE_METRIC.MEDIA_VALIDATE:t(c("qpl")._(25304678,"2352"),a);break;case d("WAPREList").PRE_METRIC.GET_DEVICES:s(d("WAOdsEnums").Entity.GET_DEVICES,a);break;case d("WAPREList").PRE_METRIC.MESSAGE_DECRYPTION:t(c("qpl")._(25306682,"11176"),a);s(d("WAOdsEnums").Entity.DECRYPTION,a);break;case d("WAPREList").PRE_METRIC.DECRYPT_MESSAGE_FINAL:t(c("qpl")._(741087294,"2028"),a);break;case d("WAPREList").PRE_METRIC.MESSAGE_ENCRYPTION:t(c("qpl")._(25299294,"12933"),a);t(c("qpl")._(741087294,"2028"),a);break;case d("WAPREList").PRE_METRIC.OFFLINE_QUEUE:t(c("qpl")._(25306361,"5664"),a);break;case d("WAPREList").PRE_METRIC.SYNCD_FATAL_ERROR:t(c("qpl")._(25310891,"540"),a);break;case d("WAPREList").PRE_METRIC.SEND_MESSAGE:t(c("qpl")._(25313175,"1551"),a);break;case d("WAPREList").PRE_METRIC.CREATE_GROUP:t(c("qpl")._(25307987,"970"),a);break;case d("WAPREList").PRE_METRIC.REMOVE_PARTICIPANTS:t(c("qpl")._(25312342,"971"),a);break;case d("WAPREList").PRE_METRIC.RECEIVE_MESSAGE:t(c("qpl")._(1056840931,"814"),a);break;case d("WAPREList").PRE_METRIC.SYNCD_CRITICAL_EVENT:t(c("qpl")._(25311142,"804"),a);break;case d("WAPREList").PRE_METRIC.SYNCD_CRITICAL_BOOTSTRAP_STAGE:t(c("qpl")._(741087294,"2028"),a);break;case d("WAPREList").PRE_METRIC.SYNCD_BOOTSTRAP_APP_STATE_DOWNLOAD:t(c("qpl")._(741087294,"2028"),a);break;case d("WAPREList").PRE_METRIC.SYNCD_DECRYPT_MUTATIONS:t(c("qpl")._(741087294,"2028"),a);break;case d("WAPREList").PRE_METRIC.SYNCD_BOOTSTRAP_DATA_APPLIED:t(c("qpl")._(741087294,"2028"),a);break;case d("WAPREList").PRE_METRIC.SYNCD:t(c("qpl")._(741087294,"2028"),a);break;case d("WAPREList").PRE_METRIC.APP_STATE_SYNC_DAILY:t(c("qpl")._(25306941,"813"),a);break;case d("WAPREList").PRE_METRIC.ICDC_ERROR:t(c("qpl")._(25313187,"948"),a);break;case d("WAPREList").PRE_METRIC.WA_DISCONNECT:s(d("WAOdsEnums").Entity.WA_DISCONNECT,a);break;case d("WAPREList").PRE_METRIC.WA_FAIL_STANZA_QUEUE_ITEM:s(d("WAOdsEnums").Entity.WA_FAIL_STANZA_QUEUE_ITEM,a);break;case d("WAPREList").PRE_METRIC.WA_JOBS_ORCHESTRATOR:t(c("qpl")._(25311870,"1004"),a);break;case d("WAPREList").PRE_METRIC.WA_JOB_MANAGER:t(c("qpl")._(25308825,"136"),a);break;case d("WAPREList").PRE_METRIC.SYNCD_KEY_ROTATION:t(c("qpl")._(25304909,"1204"),a);break;case d("WAPREList").PRE_METRIC.STANZA_QUEUE_MESSAGE_CONSUMER:break;case d("WAPREList").PRE_METRIC.DOWNLOAD_AND_DECRYPT:d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Event "," not implemented"])),a.name);break;case d("WAPREList").PRE_METRIC.ONE_QUEUE:t(c("qpl")._(25308201,"2007"),a);break;case d("WAPREList").PRE_METRIC.WA_NO_SIGNED_PRE_KEY:s(d("WAOdsEnums").Entity.WA_NO_SIGNED_PRE_KEY,a);break}}function s(a,b){var c;switch(b.stage){case"START":break;case"RESUME":case"POINT":case"ANNOTATE":case"CANCEL":break;case"SUCCESS":d("MAWODSProxy").odsBumpEntityKey({entity:a,key:(c=(c=b.annotations)==null||(c=c.string)==null?void 0:c.key)!=null?c:"success"},!0);break;case"FAIL":d("MAWODSProxy").odsBumpEntityKey({entity:a,key:b.reason},!0);break;default:b.stage;d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Received unreachable stage value for the ODS event"])));break}}function t(a,b){var e=babelHelpers["extends"]({},b.annotations);switch(b.stage){case"START":if(q.get(a).has(b.instanceKey))return;var f=babelHelpers["extends"]({},e,{"int":babelHelpers["extends"]({},e["int"],{sharedWorkerRev:c("SiteData").client_revision})});f=d("MAWQplProxy").startQplUserFlow(a,f,{providedTimeoutInMs:b.timeoutInMs});q.get(a).set(b.instanceKey,f);break;case"ANNOTATE":f=q.get(a).get(b.instanceKey);if(f==null){d("WALogger").WARN(j||(j=babelHelpers.taggedTemplateLiteralLoose(["The QPL event of "," was completed or failed already"])),b.name);return}f.addAnnotations(e);break;case"RESUME":if(b.instanceKey==null){d("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Cannot RESUME without instanceKey"])));return}if(u(a,b.instanceKey))return;f=d("MAWQplProxy").startQplUserFlow(a,e,{providedInstanceKey:b.instanceKey});q.get(a).set(b.instanceKey,f);break;case"POINT":f=q.get(a).get(b.instanceKey);if(f==null){d("WALogger").WARN(l||(l=babelHelpers.taggedTemplateLiteralLoose(["The QPL event of "," was completed or failed already"])),b.name);return}f.addPoint(b.reason,e);break;case"SUCCESS":f=q.get(a).get(b.instanceKey);if(f==null){d("WALogger").WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["The QPL event of "," was processed already"])),b.name);return}f.endSuccess(e);q.get(a)["delete"](b.instanceKey);break;case"CANCEL":f=q.get(a).get(b.instanceKey);if(f==null){d("WALogger").WARN(n||(n=babelHelpers.taggedTemplateLiteralLoose(["The QPL event of "," was processed already"])),b.name);return}f.endCancel(e);q.get(a)["delete"](b.instanceKey);break;case"FAIL":f=q.get(a).get(b.instanceKey);if(f==null){d("WALogger").WARN(o||(o=babelHelpers.taggedTemplateLiteralLoose(["The QPL event of "," was processed already"])),b.name);return}f.endFail(b.reason,e);q.get(a)["delete"](b.instanceKey);break;default:d("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Received unreachable stage value for the event"])));break}}function u(a,b){return q.get(a).has(b)||a===c("qpl")._(25313175,"1551")}g.initializeWAPREMetrics=a;g.testOnly_logger=b}),98);
__d("WAAbPropConverters",[],(function(a,b,c,d,e,f){"use strict";function a(a){if(!a)return{};var b={};Object.keys(a).forEach(function(c){var d=a[c];d!=null&&(b[c]=d)});return b}f.convertAbPropsToPlainObject=a}),66);
__d("WAAbPropsCache",["WAAbPropConverters"],(function(a,b,c,d,e,f,g){"use strict";var h=86400;a=function(){function a(a){var b=a.abKey,c=a.abHash,d=a.lastSyncTime,e=a.expoKeyStr,f=a.refresh,g=a.internalExpoKeys,h=a.propExpoKeys,i=a.propValues;a=a.overridePropValues;this.$1=a!=null?a:{};this.$2=i;this.$4=c;this.$3=b;this.$5=d;this.$7=f;this.$6=e;this.$8=g;this.$9=h}var b=a.prototype;b.getAbProp=function(a){var b;return this.$1[a]!=null?this.$1[a]:(b=this.$2)==null?void 0:b[a]};b.getHash=function(){return this.$4};b.getRefreshSecs=function(){var a;return(a=this.$7)!=null?a:h};b.overrideAbProp=function(a,b){this.$1[a]=b};b.readAll=function(){var a={abKey:this.$3,hash:this.getHash(),refresh:this.getRefreshSecs(),lastSyncTime:this.$5||0};this.$9!=null&&(a.propExpoKeys=this.$9);this.$8!=null&&(a.internalExpoKeys=this.$8);this.$6!=null&&(a.expoKeyStr=this.$6);if(this.$2!=null){var b=this.$2;b!=null&&(a.propValues=d("WAAbPropConverters").convertAbPropsToPlainObject(b),this.$1!=null&&(a.propValues=babelHelpers["extends"]({},a.propValues,d("WAAbPropConverters").convertAbPropsToPlainObject(this.$1))))}return a};b.rewrite=function(a){var b=a.abKey,c=a.abHash,d=a.lastSyncTime,e=a.expoKeyStr,f=a.refresh,g=a.internalExpoKeys,h=a.propExpoKeys;a=a.propValues;this.$2=a;this.$4=c;this.$3=b;this.$5=d;this.$7=f;this.$6=e;this.$8=g;this.$9=h};return a}();g.AbPropsCache=a}),98);
__d("WAAbPropsConverters",["WAAbPropsTypes","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a){var b={expoKeyStr:a.expoKeyStr,internalExpoKeys:a.internalExpoKeys?Array.from(a.internalExpoKeys):[],lastSyncTime:a.lastSyncTime,refresh:a.refresh};a.abHash!=null&&(b.abHash=a.abHash);a.abKey!=null&&(b.abKey=a.abKey);if(a.propExpoKeys){var c=a.propExpoKeys,e=[];Object.keys(c).forEach(function(a){a=Number(a);var b={expoKey:a};c[a]!=null&&(b.value=c[a]);e.push(b)});b.propExpoKeys=e}if(a.propValues){var f=a.propValues,g=[];Object.keys(f).forEach(function(a){var b={name:a,value:{}};switch(typeof f[a]){case"boolean":b.value.boolValue=f[a];break;case"number":b.value.intValue=f[a];break;case"string":b.value.strValue=f[a];break;default:d("WALogger").WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["convertAbPropsParsedToDbEntity: unsure how to read ",""])),f[a]);return}g.push(b)});b.propValues=g}return b}function b(a){var b={expoKeyStr:a.expoKeyStr,internalExpoKeys:a.internalExpoKeys,lastSyncTime:a.lastSyncTime,propExpoKeys:a.propExpoKeys,refresh:a.refresh};a.hash!=null&&(b.abHash=a.hash);a.abKey!=null&&(b.abKey=a.abKey);if(a.propValues){var c=a.propValues,d={};Object.keys(c).forEach(function(a){c[a]!=null&&(d[a]=c[a])});b.propValues=d}return b}function c(a){var b=a.abHash,c=a.abKey,e=a.expoKeyStr,f=a.internalExpoKeys,g=a.lastSyncTime,h=a.propExpoKeys,j=a.propValues;a=a.refresh;b={abHash:b,abKey:c,expoKeyStr:e,lastSyncTime:g,refresh:a};f!=null&&(b.internalExpoKeys=new Set(f));if(h!=null){var k={};h.forEach(function(a){a.expoKey!=null&&(k[a.expoKey]=a.value)});b.propExpoKeys=k}if(j!=null){var l={};j.forEach(function(a){var b=a.name,c=d("WAAbPropsTypes").ABPropConfigs[b];if(c==null||c.length<3)return;c=c[2];switch(typeof c){case"boolean":l[b]=a.value.boolValue;return;case"number":l[b]=a.value.intValue;return;case"string":l[b]=a.value.strValue;return;default:d("WALogger").WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["convertDbAbPropsToParsed: unsure how to read ",""])),c);return}});b.propValues=l}return b}g.convertAbPropsParsedToDbEntity=a;g.convertAbPropsDataToParsed=b;g.convertDbAbPropsToParsed=c}),98);
__d("WAGetAbPropsApi",["WAGetMetaApi"],(function(a,b,c,d,e,f,g){"use strict";a=function(){return d("WAGetMetaApi").getMeta().then(function(a){a=a.abProps;return a})};g.getAbProps=a}),98);
__d("WASetAbPropsApi",["WASetMetaApi"],(function(a,b,c,d,e,f,g){"use strict";a=function(a){return d("WASetMetaApi").setMeta({abProps:a})};g.setAbProps=a}),98);
__d("WAAbPropsInit",["Promise","WAAbProps","WAAbPropsCache","WAAbPropsConverters","WAAbPropsToUI","WAAbPropsTypes","WABridge","WAGetAbPropsApi","WALogger","WASetAbPropsApi","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;function a(){if(!k)throw c("err")("Trying to get hash before AbProps gets initialized");return(j||(j=b("Promise"))).resolve(k.getHash())}function e(){if(!k)throw c("err")("Trying to get refresh secs before AbProps gets initialized");return(j||(j=b("Promise"))).resolve(k.getRefreshSecs())}var l={getAbProps:function(){if(!k)throw c("err")("Trying to read ABProps before they gets initialized");return(j||(j=b("Promise"))).resolve(k.readAll())},getHash:a,getRefreshSecs:e,setAbProps:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b;a=d("WAAbPropsConverters").convertAbPropsDataToParsed(a);(b=k)==null||b.rewrite(a);yield d("WASetAbPropsApi").setAbProps(d("WAAbPropsConverters").convertAbPropsParsedToDbEntity(a));m(a)});function c(b){return a.apply(this,arguments)}return c}()};function m(a){if(!a.propValues)return;a=d("WAAbPropsToUI").prepareAbPropsForUI(a.propValues);d("WABridge").getBridge().fireAndForget("event","abPropsUpdated",{abProps:a})}function f(){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Starting ABProps store"])));var a=(yield d("WAGetAbPropsApi").getAbProps()),b={};a&&(b=d("WAAbPropsConverters").convertDbAbPropsToParsed(a));k=new(d("WAAbPropsCache").AbPropsCache)(b);d("WAAbProps").startAbProps(l,d("WAAbPropsTypes").ABPropConfigs);m(b);d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["ABProps inited"])))});return n.apply(this,arguments)}function o(a,b){if(k==null)throw c("err")("Trying to override ABProp before they get initialized");var e=k;e.overrideAbProp(a,b);m(d("WAAbPropsConverters").convertAbPropsDataToParsed(e.readAll()))}function p(a){return d("WAAbPropsTypes").ABPropConfigs[a][2]}function q(){if(!k)throw c("err")("Trying to read ABProps before they get initialized");return k.readAll()}function r(a){if(!k)throw c("err")("Trying to read ABProp "+a+" before AbProps gets initialized");var b=k.getAbProp(a);return b!=null?b:p(a)}g.getHash=a;g.getRefreshSecs=e;g.initAbProps=f;g.overrideAbProp=o;g.getAbDefault=p;g.getAbProps=q;g.getAbProp=r}),98);
__d("MAWWebWorkerLogger",["MAWBridge","MAWConsoleLogger","MAWLeakDetection","MAWLoggingSwitches","MAWSaveLogToDisk","WAAbPropsInit","WAJids","WATagsLogger","asyncToGeneratorRuntime","err","fb-error"],(function(a,b,c,d,e,f,g){"use strict";var h=2;function a(){d("WATagsLogger").initializeWaLogger(i)}var i={count:function(a,b){k("count",a,b),d("MAWConsoleLogger").logToConsole("count",a,b)},debug:function(a,b,c){d("MAWConsoleLogger").logToConsole("log",a,b,c)},devConsole:function(a,b,c,e){for(var f=arguments.length,g=new Array(f>4?f-4:0),h=4;h<f;h++)g[h-4]=arguments[h];switch(a){case"COUNT":d("MAWConsoleLogger").logToConsole.apply(void 0,["count",b,c,e].concat(g));break;case"DEV":d("MAWConsoleLogger").logToConsole.apply(void 0,["log",b,c,e].concat(g));break;case"DEV_XMPP":d("MAWConsoleLogger").logToConsole.apply(void 0,["log",b,c,e].concat(g));break;case"LOG":d("MAWConsoleLogger").logToConsole.apply(void 0,["info",b,c,e].concat(g));break;case"WARN":d("MAWConsoleLogger").logToConsole.apply(void 0,["warn",b,c,e].concat(g));break;case"ERROR":d("MAWConsoleLogger").logToConsole.apply(void 0,["error",b,c,e].concat(g));break;case"CATCHING":d("MAWConsoleLogger").logToConsole.apply(void 0,["error",b,c,e].concat(g));break}},error:function(a,b,e){a=d("MAWLeakDetection").maybeReplaceVaultedString(a);e?m(a,b,e):m("webworker",b,c("err")(d("WAJids").maybeSanitizeLogLineText(a)));d("MAWConsoleLogger").logToConsole("error",a,b)},info:function(a,b){k("log",a,b),d("MAWConsoleLogger").logToConsole("info",a,b)},logRestricted:function(a,b){k("logRestricted",a,b),d("MAWConsoleLogger").logToConsole("log",a,b)},warn:function(a,b){k("warn",a,b),d("MAWConsoleLogger").logToConsole("warn",a,b)}};function j(){try{return d("WAAbPropsInit").getAbProp("msgrw_logger_entries")}catch(a){return d("WAAbPropsInit").getAbDefault("msgrw_logger_entries")}}function k(a,b,c){if(d("MAWLoggingSwitches").removeLoggingFromBridge){d("MAWSaveLogToDisk").saveLogEntry("worker",d("MAWSaveLogToDisk").formatLog({date:Date.now(),logLevel:a,logString:b,tags:c}));a==="count"&&d("MAWBridge").getBridge().fireAndForget("event","log",{logLevel:a,logString:b,tags:c},!0);return}a!=="debug"&&d("MAWBridge").getBridge().fireAndForget("event","log",{logLevel:a,logString:b,tags:c},!0)}function e(){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield d("MAWSaveLogToDisk").forceCachedLogEntryPersist()});return l.apply(this,arguments)}function m(a,b,e){var f=0;if(e.taalOpcodes!=null){var g;(g=e.taalOpcodes)==null||g.forEach(function(a){a===c("fb-error").TAALOpcode.PREVIOUS_FRAME&&f++})}else f=h;d("MAWLoggingSwitches").removeLoggingFromBridge&&d("MAWSaveLogToDisk").saveLogEntry("worker",d("MAWSaveLogToDisk").formatErrorForLogging(a,b,e,f,j(),e.stack));d("MAWBridge").getBridge().fireAndForget("event","logError",{entriesToReport:j(),framesToPop:f,logString:a,message:e.message,stack:e.stack,tags:b},!0)}g.setupWebWorkerWaLogger=a;g.flushLogs=e}),98);
__d("WAQPLProxy",["WALogger","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a,b,e,f,g){g===void 0&&(g=!0);if(j==null){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["WAQPLProxy: Proxy implementation is not provided for ",""])),a);throw c("err")("WAQPLProxy: Proxy implementation is not provided")}return j.start(a,b,e,f,g)}function b(a,b){if(j==null){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["WAQPLProxy: Proxy implementation is not provided for ",""])),a);throw c("err")("WAQPLProxy: Proxy implementation is not provided")}return j.resume(a,b)}var j=null;function e(a){j=a}g.waQPLProxyStart=a;g.waQPLProxyStartResume=b;g.provideProxyImplementationForWAQPLProxy=e}),98);
__d("BackendInitLoggingUtils",["ErrorMetadata","MAWCommonWebWorkerErrorLogging","MAWLoggerUtils","MAWPREListeners","MAWQplProxy","MAWWebWorkerLogger","MWSetupDBEncryption","WAQPLProxy","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h=function(a,b){return d("MAWQplProxy").measurePerfInQPL_USE_WITH_CARE(c("qpl")._(25310776,"6155"),"backend_"+a,b)};b=function(a){return d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25310776,"6155"),a)};e=function(a){return d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(1056839232,"112"),a)};function a(){d("MAWWebWorkerLogger").setupWebWorkerWaLogger(),d("MAWCommonWebWorkerErrorLogging").init(),c("ErrorMetadata").addGlobalMetadata("MESSENGER_E2EE_WEB","ENVIRONMENT","worker"),d("MAWLoggerUtils").initMessengerWebLogging(),d("WAQPLProxy").provideProxyImplementationForWAQPLProxy({resume:d("MAWQplProxy").makeQplUserFlowFromExistedInstance,start:function(a,b,c,e,f){return d("MAWQplProxy").startQplUserFlow(a,b,{callBridgeWithTimestamp:f,providedInstanceKey:c,providedTimeoutInMs:e})}}),d("MAWPREListeners").initializeWAPREMetrics(),d("MWSetupDBEncryption").setPerformanceMeasurementTool(h)}g.measureMawInit=h;g.MAWInitPoint=b;g.MAWMICPoint=e;g.initializeBackendLogging=a}),98);
__d("BlobStorageTypes",[],(function(a,b,c,d,e,f){"use strict";function a(a){return a}f.toBlobFileName=a}),66);
__d("BroadcastChannelClientServerHandshake",["FBLogger","Promise","Random","setTimeout"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){a.addEventListener("message",function(b){var c;((c=b.data)==null?void 0:c.type)==="BroadcastChannelHandshake-syn"&&a.postMessage({nonce:b.data.nonce,type:"BroadcastChannelHandshake-syn-ack"})})}function e(a,e){var f=d("Random").random(),g=0;return new(h||(h=b("Promise")))(function(b,d){var h=!1,i=function(){if(g===6){h=!0;a.removeEventListener("message",j);try{throw c("FBLogger")("messenger_web").mustfixThrow("[LS] BC handshake failed, failing, likely worker failure%s",e!=null?" for"+e:"")}catch(a){d(a)}return}if(h)return;a.postMessage({nonce:f,type:"BroadcastChannelHandshake-syn"});c("setTimeout")(i,100*Math.pow(2,g++))},j=function(c){var d;((d=c.data)==null?void 0:d.type)==="BroadcastChannelHandshake-syn-ack"&&((d=c.data)==null?void 0:d.nonce)===f&&(b(),h=!0,a.removeEventListener("message",j))};a.addEventListener("message",j);i()})}g.listen=a;g.checkAlive=e}),98);
__d("CoalescingLoader",["Promise","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f){"use strict";var g;function h(){return new(g||(g=b("Promise")))(function(a){return globalThis.setTimeout(a,0)})}a=function(){function a(a,b){b===void 0&&(b=h),this.$1=a,this.$2=[],this.$3=null,this.$4=b}var c=a.prototype;c.gen=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){this.$2.push(a);a=this.$2.length-1;var b=(yield this.$5());return b[a]});function c(b){return a.apply(this,arguments)}return c}();c.$5=function(){if(this.$3!=null)return this.$3;this.$3=this.$6();return this.$3};c.$6=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield this.$4();var a=this.$2;this.$2=[];this.$3=null;return this.$1([].concat(a))});function c(){return a.apply(this,arguments)}return c}();return a}();f.CoalescingLoader=a}),66);
__d("CometTaskFrameworkTypes",["$InternalEnum"],(function(a,b,c,d,e,f){"use strict";a=b("$InternalEnum").Mirrored(["UNKNOWN","BACKGROUND","CURRENT_THREAD","LS_WORKER","MAW_WORKER","TEST"]);c="comet_task_framework";f.ExecutionContext=a;f.TASK_FRAMEWORK_PREFIX=c}),66);
__d("WorkerBootstrap",["HasteSupportData","ServerJSDefine"],(function(a,b,c,d,e,f,g){"use strict";function h(a){Object.keys(a).forEach(function(b){c("ServerJSDefine").handleDefine(b,[],a[b],-1,null)})}function a(a,c){var f,g;a.hsdp&&d("HasteSupportData").handle(a.hsdp);var i=(f=(g=a.jsmods)!=null?g:a.dynamicModules)!=null?f:{};h(i);var j=b.call(null,c);a.rds!=null&&a.rds.length>0&&e.call(null,a.rds,function(){});if(typeof j==="function"||j!==null)try{for(var k=arguments.length,l=new Array(k>2?k-2:0),m=2;m<k;m++)l[m-2]=arguments[m];j.apply(void 0,l)}catch(a){}}function f(a){a=a;if(typeof a==="function"||a!==null)try{a()}catch(a){}}g.initDynamicModules=h;g.start=a;g.startServerJS=f}),98);
__d("CurrentSharedWorker",["HasteSupportData","QPLUserFlow","SharedWorkerStatusLock","WorkerBootstrap","emptyFunction","err","justknobx","qpl","structuredClone"],(function(a,b,c,d,e,f,g){"use strict";var h=null,i=[],j=new Set(),k=[],l=!1,m=!1,n=null,o=!1,p=c("qpl")._(931609794,"2369");c("QPLUserFlow").start(p);var q=d("SharedWorkerStatusLock").getStatusLock();c("QPLUserFlow").addPoint(p,"status_lock");c("QPLUserFlow").addAnnotations(p,{string:{id:self.worker_id}});self.setTimeout(function(){if(!o){try{var a;(a=j.values().next().value)==null||a.postMessage({type:"self-terminate",response:{from:"bundle",workerID:self.worker_id}})}catch(a){c("QPLUserFlow").endFailure(p,"timeout_termination_error"),x(a)}self.close()}},3e5);function r(){m=!0,n=null,h!==null&&(c("QPLUserFlow").addPoint(p,"process_message_buffer"),c("QPLUserFlow").addAnnotations(p,{"int":{message_buffer_size:i.length}}),i.forEach(function(a){return a()}),i=[]),c("QPLUserFlow").endSuccess(p)}function s(a,f){var g=a.data;if(typeof g==="object"&&(g==null?void 0:g.type)==="execute-worker"){var k=!l;try{if(!l&&g.args instanceof Array){var t=g.args[0],u=t.hsdp,v=t.jsmods,w=t.dynamicModules;t=t.rds;c("QPLUserFlow").addPoint(p,"first_init");u!=null&&d("HasteSupportData").handle(u);d("WorkerBootstrap").initDynamicModules((u=v!=null?v:w)!=null?u:{});t!=null&&t.length>0&&e.call(null,t,function(){});q.init({requestWorkerIdStatusLockToo:c("justknobx")._("4202")});c("QPLUserFlow").addPoint(p,"status_lock_init");l=!0;n!=null&&(n(),r())}v=b.call(b,"SiteData");j.size>1&&f.postMessage({type:"execute-worker-imports",response:{}});f.postMessage({type:"execute-worker-ack",response:{firstInit:k,workerRevision:v.client_revision,spinMode:v.spin,spinTime:v.__spin_t}});o=!0}catch(a){c("QPLUserFlow").endFailure(p,"worker_init_error"),q.release(),f.postMessage({type:"execute-worker-ack",response:{firstInit:k,error:a.message}}),self.close()}}else if(typeof g==="object"&&(g==null?void 0:g.type)==="sw-get-rev")try{w=b.call(b,"SiteData");f.postMessage({type:"sw-get-rev",response:{workerRevision:w.client_revision,spinMode:w.spin,spinTime:w.__spin_t}})}catch(a){f.postMessage({type:"sw-get-rev",response:{error:a.message}})}else if(typeof g==="object"&&(g==null?void 0:g.type)==="sw-shutdown"){u=Array.isArray(g.args)?g.args[0]:null;typeof u==="object"&&(u==null?void 0:u.upgrade)===!0?y("requested-upgrade"):typeof u==="object"&&typeof (u==null?void 0:u.reason)==="string"?y(u==null?void 0:u.reason):y()}else if(typeof g==="object"&&(g==null?void 0:g.type)==="sw-uptime-tracking"){v=typeof (g==null?void 0:g.args)==="object"?(t=g.args)==null?void 0:t.trackerID:null;f.postMessage({type:"sw-uptime-tracking",response:{trackerID:v}})}else typeof g==="object"&&(g==null?void 0:g.type)==="ww-hrp-init"?f.postMessage({type:"ww-hrp-init",response:{}}):typeof g==="object"&&(g==null?void 0:g.type)==="ww-connection-ack"?f.postMessage({type:"connection-ack",response:{from:"bundle",workerID:self.worker_id,hrpStatus:"processed"}}):h!==null&&m?h(g):i.push(function(){return s(a,f)})}function a(a){var b=h==null;h=a!=null?a:c("emptyFunction");b&&m&&(i.forEach(function(a){return a()}),i=[])}function t(a,b){j.forEach(function(c){try{c.postMessage(a,b)}catch(b){c.postMessage(a)}})}function f(a){if(l){c("QPLUserFlow").addPoint(p,"init_complete_handler_ran");a();r();return}c("QPLUserFlow").addPoint(p,"init_complete_handler_attached");n=a}["log","error","info","debug","warn"].forEach(function(a){if(self.console[a]==null)throw c("err")('"'+a+'" is not a valid console method.');var b=self.console[a];self.console[a]=function(){for(var d=arguments.length,e=new Array(d),f=0;f<d;f++)e[f]=arguments[f];b.apply(void 0,e);var g=!1;try{c("structuredClone")!=null&&c("structuredClone")(e),g=!0}catch(a){}if(!g){t({type:"console",response:{method:"error",args:["DataCloneError: Failed to forward console message from web worker due to args not being serializable."]}});return}t({type:"console",response:{method:a,args:e}})}});try{c("QPLUserFlow").addPoint(p,"bootstrap_start");var u=self.shared_worker_bootstrap_buffer==null?void 0:self.shared_worker_bootstrap_buffer(y);if(u!=null){var v=u.ports,w=u.messages;c("QPLUserFlow").addAnnotations(p,{"int":{bootstrap_ports_num:v.length}});v==null||v.forEach(function(a){try{a.postMessage({type:"connection-ack",response:{from:"bundle",workerID:self.worker_id,hrpStatus:"processed"}}),a.addEventListener("message",function(b){return s(b,a)}),j.add(a)}catch(a){c("QPLUserFlow").addPoint(p,"connection_fail"),x(a)}});w==null||w.forEach(function(a){try{s(a.e,a.port)}catch(b){c("QPLUserFlow").addPoint(p,"message_processing_fail");c("QPLUserFlow").addAnnotations(p,{string:{failed_msg_type:(a=(a=a.e.data)==null?void 0:a.type)!=null?a:"unknown"}});x(b)}c("QPLUserFlow").addAnnotations(p,{"int":{msg_num:w.length},string_array:{msgs:w.map(function(a){return(a=a.e.data)==null?void 0:a.type})}})})}else c("QPLUserFlow").addPoint(p,"bootstrap_buffer_empty")}catch(a){x(a),c("QPLUserFlow").endFailure(p,"uncaught_bootstrap_error")}function x(a){try{t({type:"sw-uncaught-error",e:{message:a.message,lineno:a.lineno,colno:a.colno,filename:a.filename,error:a.error}})}catch(b){c("QPLUserFlow").addPoint(p,"sending_error_failed");c("QPLUserFlow").addAnnotations(p,{string:{error:String((a=b.message)!=null?a:b)}})}}self.addEventListener("error",function(a){if(j.size===0){k.push(a);return}x(a)});self.addEventListener("connect",function(a){var b=a.ports[0];b.postMessage({type:"connection-ack",response:{from:"bundle",workerID:self.worker_id,hrpStatus:"processed"}});b.addEventListener("message",function(a){return s(a,b)});b.start();j.add(b);k.length>0&&(k.forEach(x),k.splice(0,k.length))});function y(a){q.release(),t({type:"sw-shutdown",response:{reason:a,workerID:self.worker_id,isInitialized:o}}),self.close()}g.setMessageHandler=a;g.postMessage=t;g.onInitComplete=f;g.shutdownWorker=y}),98);
__d("CurrentSharedWorkerAdapter",["CurrentSharedWorker","FBLogger"],(function(a,b,c,d,e,f,g){a=function(){function a(){}var b=a.prototype;b.addEventListener=function(a,b,e){switch(a){case"message":d("CurrentSharedWorker").setMessageHandler(function(a){return b({data:a})});break;case"error":break;default:c("FBLogger")("worker").mustfix("Unexpected message type %",a)}};b.removeEventListener=function(a,b,e){switch(a){case"message":d("CurrentSharedWorker").setMessageHandler(null);break;case"error":break;default:c("FBLogger")("worker").mustfix("Unexpected message type %",a)}};b.postMessage=function(a,b){d("CurrentSharedWorker").postMessage(a,b)};return a}();g.CurrentSharedWorkerAdapter=a}),98);
__d("CurrentWorkerMessagePort",["err","ifRequired"],(function(a,b,c,d,e,f,g){"use strict";var h=null;function a(){if(h==null)if("SharedWorkerGlobalScope"in self&&self instanceof self.SharedWorkerGlobalScope){var a;h=(a=c("ifRequired")("SharedWorkerBootstrapExperimental",function(a){return new a.CurrentSharedWorkerExperimentalAdapter()},function(){return null}))!=null?a:c("ifRequired")("CurrentSharedWorkerAdapter",function(a){return new a.CurrentSharedWorkerAdapter()},function(){return null})}else if("DedicatedWorkerGlobalScope"in self&&self instanceof self.DedicatedWorkerGlobalScope)h=self;else throw new Error("CurrentWorkerAdapter: Unsupported worker type");if(h==null)throw c("err")("CurrentWorkerAdapter: None of shared worker adapters are available");return h}g.getMessagePort=a}),98);
__d("EBMessagePointQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="24207115425591416"}),null);
__d("EBMessagePointQuery.graphql",["EBMessagePointQuery_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a={defaultValue:null,kind:"LocalArgument",name:"app_id"},c={defaultValue:null,kind:"LocalArgument",name:"restore_payload_string"},d={defaultValue:null,kind:"LocalArgument",name:"restore_type"},e=[{kind:"Variable",name:"app_id",variableName:"app_id"},{kind:"Variable",name:"restore_payload_string",variableName:"restore_payload_string"},{kind:"Variable",name:"restore_type",variableName:"restore_type"}],f={alias:null,args:null,kind:"ScalarField",name:"encryption_version",storageKey:null},g={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},h={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},i={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf_stanza",storageKey:null},j={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp_ms",storageKey:null},k={alias:null,args:null,kind:"ScalarField",name:"sk_ciphertext",storageKey:null},l=[g,h];return{fragment:{argumentDefinitions:[a,c,d],kind:"Fragment",metadata:null,name:"EBMessagePointQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:e,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages_point_restore",plural:!1,selections:[{args:null,kind:"FragmentSpread",name:"handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages"}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[c,d,a],kind:"Operation",name:"EBMessagePointQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:e,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages_point_restore",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMessage",kind:"LinkedField",name:"encrypted_messages",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEchoDocument",kind:"LinkedField",name:"echo_document",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"echo_document_string",storageKey:null},f,g,h,{alias:null,args:null,kind:"ScalarField",name:"epoch_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"otid",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanzas",kind:"LinkedField",name:"protobuf_stanzas",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"message_tags",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"top_level_protobuf",plural:!1,selections:[i,f,g,h,j,k],storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs",plural:!0,selections:[i,f,g,h,j,k,{alias:null,args:null,kind:"ScalarField",name:"supplemental_key",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},{alias:null,args:null,concreteType:"XFBMessageRangeInfo",kind:"LinkedField",name:"message_range_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"has_more_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"has_more_after",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_after",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"should_delete_mailbox",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"thread_not_found",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochDerivationSet",kind:"LinkedField",name:"epoch_derivation_set",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupsEpochEdge",kind:"LinkedField",name:"epoch_edges",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"backward_edge",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochForwardEdge",kind:"LinkedField",name:"forward_edge",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"auth_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_entropy",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"entropy_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"psk_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"from_epoch",plural:!1,selections:l,storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"to_epoch",plural:!1,selections:l,storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"from_epoch_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"to_epoch_fingerprint",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null}],storageKey:null}],storageKey:null}]},params:{id:b("EBMessagePointQuery_facebookRelayOperation"),metadata:{},name:"EBMessagePointQuery",operationKind:"query",text:null}}}();e.exports=a}),null);
__d("EBMessagePointQuery",["Base64Utils","EBAPIDecryptionModule","EBAPIQPLPoints","EBAPIWorkerCheck","EBDeriveAndStoreEpochs","EBLS","EBMessagePointQuery.graphql","EBgenerateMPSMessageQuery","FBLogger","I64","LSDecryptMessageProtobufsStoredProcedure","LSDecryptMessagesStoredProcedure","LSFactory","LSMEBTaskCreationSource","LSShape","LSVec","MAWConvertEchoMessagesToEBProtobufs","MAWCurrentUser","MAWEncryptedBackupUtils","MAWJobDefinitions","QPLUserFlow","WAGetSafeQPLError","WAHashStringToNumber","WAJids","WAResultOrError","WorkerRelay","WorkerRelayNetwork","asyncToGeneratorRuntime","gkx","handleRestoreMessagesGraphQLResponse","qpl","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=h!==void 0?h:h=b("EBMessagePointQuery.graphql");function a(a){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.chatJid,e=a.instanceKey,g=a.messageIds;a=a.source;var h=c("qpl")._(521474469,"2612");e=e!=null?e:d("WAHashStringToNumber").hashStringToNumber(c("uuidv4")());try{var k,l,m;if(!d("EBAPIWorkerCheck").runningInWorker())return d("WAResultOrError").makeError("unsupported-context");c("QPLUserFlow").start(h,{annotations:{"int":{source:a!=null?a:c("LSMEBTaskCreationSource").UNKNOWN}},instanceKey:e});a=(yield d("EBLS").init()).db;c("QPLUserFlow").addPoint(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.LSDB_SINGLETON_RETRIEVED,{instanceKey:e});var n=(yield d("handleRestoreMessagesGraphQLResponse").getClientState(a));c("QPLUserFlow").addPoint(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.CLIENT_STATE_RETRIEVED,{data:{string:{device_id:(i||(i=d("I64"))).to_string((k=n==null?void 0:n.device_id)!=null?k:(i||(i=d("I64"))).zero)}},instanceKey:e});if(n==null){c("QPLUserFlow").endFailure(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE}},instanceKey:e});return d("WAResultOrError").makeError("no-client-state")}var o=d("WAJids").threadIdForChatJid(b);k=n.backupId;var p=n.device_id,q=n.locally_available_epochs,r=n.mailboxRootKey;n=n.ocmfClientStateBlob;if(k==null||p==null||r==null||n==null){c("QPLUserFlow").endFailure(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE}},instanceKey:e});return d("WAResultOrError").makeError("invalid-client-state")}l=""+((l=d("MAWCurrentUser").getAppID())!=null?l:0);q={restore_context:{act_thread_id:o,site:"www",tam_thread_subtype:0},success:{device_context:{device_id:i.to_string(p),locally_available_epochs:q,raw_tokens:{mailbox_root_key:d("Base64Utils").fromArrayBuffer(r),ocmf_client_state_blob:d("Base64Utils").fromArrayBuffer(n)}},mps_message_query:JSON.stringify(d("EBgenerateMPSMessageQuery").generateMPSMessageQuery(o,[].concat(g)))}};r={app_id:l,restore_payload_string:JSON.stringify(q),restore_type:"MESSAGE_QUERY_RESTORE"};c("QPLUserFlow").addPoint(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.CREATE_WORKER_NETWORK_EXECUTE_START,{instanceKey:e});yield d("WorkerRelayNetwork").createWorkerNetworkExecute();c("QPLUserFlow").addPoint(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.CREATE_WORKER_NETWORK_EXECUTE_END,{instanceKey:e});c("QPLUserFlow").addPoint(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_START,{instanceKey:e});n=(yield d("WorkerRelay").createWorkerQuery(j,r));c("QPLUserFlow").addPoint(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_END,{instanceKey:e});g=n==null||(m=n.viewer)==null||(m=m.encrypted_backup)==null||(m=m.mailbox)==null?void 0:m.messages_point_restore;if(g==null){c("QPLUserFlow").endFailure(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}},instanceKey:e});return d("WAResultOrError").makeError("invalid-graphql-response")}if((g==null?void 0:g.encrypted_messages)==null){c("QPLUserFlow").endFailure(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}},instanceKey:e});return d("WAResultOrError").makeError("invalid-graphql-response")}l=g.backup_id;q=g.encrypted_messages;r=g.epoch_derivation_set;n=g.exception_string;if(n!=null){c("QPLUserFlow").endFailure(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,exception:n}},instanceKey:e});return d("WAResultOrError").makeError("server-side-exception")}l==null&&c("QPLUserFlow").addPoint(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.BACKUP_ID_NULL,{instanceKey:e});c("QPLUserFlow").addPoint(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_START,{instanceKey:e});c("QPLUserFlow").addAnnotations(h,{bool:{hasEpochs:r!=null&&r.epoch_edges.length>0,nonLS:c("gkx")("7473")}},{instanceKey:e});c("gkx")("7473")?yield d("EBDeriveAndStoreEpochs").deriveAndStoreEpochsNonLS(a,r):yield d("handleRestoreMessagesGraphQLResponse").deriveAndStoreEpochs(r,a,p,void 0,!0);c("QPLUserFlow").addPoint(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_END,{instanceKey:e});g=d("handleRestoreMessagesGraphQLResponse").processMessageArray(q,l!=null?l:(i||(i=d("I64"))).to_string(k));var s=g.encryptedLSEchoMessages,t=g.encryptedMessagesWithProtobufs;n=g.encryptedNonLSEchoMessages;r=g.encryptedNonLSProtobufs;if(c("gkx")("7473")){c("QPLUserFlow").addPoint(h,"native_decryption_start",{instanceKey:e});p=(yield d("EBAPIDecryptionModule").decryptUsingNativeJS(a,o,r,n));if(!p.success){c("QPLUserFlow").addPoint(h,"native_decryption_error",{instanceKey:e});return d("WAResultOrError").makeError("native-decryption-error")}q=p.value.decryptedEchoMessages;l=p.value.decryptedProtobufs;k=d("EBAPIDecryptionModule").convertNativeDecryptionResponseToDecryptedMessageType(q,l);c("QPLUserFlow").addPoint(h,"native_decryption_success",{instanceKey:e});g=c("LSVec").toArray(k.echo);r=k.protobuf;n=g.map(function(a){return d("MAWJobDefinitions").toEncodedEchoMessage(a)});p=[];q.length>0?p=d("MAWConvertEchoMessagesToEBProtobufs").convertEchoMessagesToEBProtobufs(n,b):p=d("MAWEncryptedBackupUtils").convertLSTypesToJSTypesForRestoreJob(r);c("QPLUserFlow").endSuccess(h,{annotations:{bool:{isEcho:q.length>0,isProtobuf:l.length>0}},instanceKey:e});return d("WAResultOrError").makeResult(p)}if(t.length!==0&&s.length!==0){c("QPLUserFlow").endSuccess(h,{instanceKey:e});return d("WAResultOrError").makeResult([])}if(t.length!==0){k={decryptedProtobufs:[],protobufDecryptionFailures:!1};c("QPLUserFlow").addPoint(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_PROTOBUF_START,{instanceKey:e});g=(yield a.runInTransaction(function(a){return c("LSDecryptMessageProtobufsStoredProcedure")(c("LSFactory")(a),{actThreadId:o,encryptedMessagesWithProtobufs:c("LSVec").ofArray(t)})},"readwrite",void 0,void 0,f.id+":501"));n=g[0];r=g[1];if(r!=null){k.protobufDecryptionFailures=!0;c("QPLUserFlow").endFailure(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.PROTOBUF_DECRYPTION_FAILURE,{instanceKey:e});return d("WAResultOrError").makeError("empty-decryption-response")}if(n!=null){q=d("MAWEncryptedBackupUtils").convertLSTypesToJSTypesForRestoreJob(n);k.decryptedProtobufs=[].concat(q)}c("QPLUserFlow").addPoint(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_PROTOBUF_END,{instanceKey:e});c("QPLUserFlow").endSuccess(h,{annotations:{bool:{isEcho:!1,isProtobuf:!0}},instanceKey:e});return d("WAResultOrError").makeResult(k.decryptedProtobufs)}else{l={decryptedEchoDocuments:[],echoDecryptionFailures:!1};c("QPLUserFlow").addPoint(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_START,{instanceKey:e});p=(yield a.runInTransaction(function(a){return c("LSDecryptMessagesStoredProcedure")(c("LSFactory")(a),{actThreadId:o,encryptedMessages:c("LSVec").ofArray(s)})},"readwrite",void 0,void 0,f.id+":574"));g=p[0];r=p[1];if(r!=null){l.echoDecryptionFailures=!0;c("QPLUserFlow").endFailure(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.ECHO_DECRYPTION_FAILURE,{instanceKey:e});return d("WAResultOrError").makeError("empty-decryption-response")}if(g!=null){n=c("LSVec").toArray(g).map(function(a){return d("MAWJobDefinitions").toEncodedEchoMessage(d("LSShape").toRecord(a).value)});q=d("MAWConvertEchoMessagesToEBProtobufs").convertEchoMessagesToEBProtobufs(n,b);l.decryptedEchoDocuments=[].concat(q);c("QPLUserFlow").addPoint(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_END,{instanceKey:e})}c("QPLUserFlow").endSuccess(h,{annotations:{bool:{isEcho:!0,isProtobuf:!1}},instanceKey:e});return d("WAResultOrError").makeResult(l.decryptedEchoDocuments)}}catch(a){c("QPLUserFlow").endFailure(h,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,{annotations:{string:{error_description:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a),errorStackTrace:(k=a.stack)!=null?k:""}},error:a,instanceKey:e});c("FBLogger")("wmi_eb").catching(a).mustfix("Runtime error performing messagePointQuery: %s",a);return d("WAResultOrError").DEPRECATED_makeError("runtime-error",a)}});return k.apply(this,arguments)}g.messagePointQuery=a}),98);
__d("EBAPIMessagePointQuery",["EBMessagePointQuery"],(function(a,b,c,d,e,f,g){"use strict";g["default"]=d("EBMessagePointQuery").messagePointQuery}),98);
__d("EncryptedBackupsCreateAttachmentContext",["EBLogger","EncryptedBackupsUploadEntity","MAWProtobufDeserializers","WAMediaTransport.pb","WAMediaUtils","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";var h=d("EBLogger").EBLogger.tags(["labyrinth_web","CreateAttachmentContext"]);function a(a){var b=new Map();try{a=d("MAWProtobufDeserializers").DeserializedBackupMessage.create(a);a=a.encryptedTransportMessage();if(a==null){h.warn("transport message subprotocol is undefined");return[]}a=k(a);if(a!=null)if(a.type!==d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA)j(a,b);else{a=a.payload;i(a.favicon,b);i(a.headerImage,b);a.previews!=null&&a.previews.forEach(function(a){i(a,b)});a=a.associatedMessage;if(a!=null&&a.payload!=null){a=new(d("MAWProtobufDeserializers").DeserializedMessageApplication)(a.payload);a=k(a);a!=null&&j(a,b)}}}catch(a){h.warn("Unable to create attachment context for message")}return Array.from(b.entries()).map(function(a){var b=a[0];a=a[1];return{mediaObjectId:b,mediaType:a}})}function i(a,b){if(a==null)return;a=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").ImageTransportSpec,a.payload);a=(a=a.integral)==null||(a=a.transport)==null||(a=a.ancillary)==null?void 0:a.objectId;a!=null&&b.set(d("WAMediaUtils").stringToDeliveryObjectId(a),d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA)}function j(a,b){var c,e,f,g=a.type;a=a.payload;a=a.integral;if((a==null||(c=a.transport)==null||(c=c.ancillary)==null?void 0:c.objectId)==null){h.warn("object id for attachment is null");return}var i=d("WAMediaUtils").stringToDeliveryObjectId(a==null||(e=a.transport)==null||(e=e.ancillary)==null?void 0:e.objectId);b.set(i,g);g=a==null||(f=a.transport)==null||(f=f.ancillary)==null||(f=f.thumbnail)==null||(f=f.downloadableThumbnail)==null?void 0:f.objectId;if(g!=null&&g!==i){a=d("WAMediaUtils").stringToDeliveryObjectId(g);b.set(a,d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.MESSENGER_PREVIEW)}}function k(a){var b=a.consumerMessage();a=a.armadillo();if(b!=null){var c,e,f,g,h;b=b.payload;if((b==null||(c=b.content)==null?void 0:c.imageMessage)!=null){var i;return{payload:d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").ImageTransportSpec,b==null||(i=b.content)==null||(i=i.imageMessage.image)==null?void 0:i.payload),type:d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.IMAGE}}if((b==null||(e=b.content)==null?void 0:e.videoMessage)!=null){var j,k,l,m=d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").VideoTransportSpec,b==null||(j=b.content)==null||(j=j.videoMessage.video)==null?void 0:j.payload);return{payload:m,type:(m==null||(k=m.ancillary)==null?void 0:k.gifPlayback)!==!0||(m==null||(l=m.ancillary)==null?void 0:l.gifAttribution)!=null?d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.GIF:d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.VIDEO}}if((b==null||(f=b.content)==null?void 0:f.stickerMessage)!=null){var n;return{payload:d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").StickerTransportSpec,b==null||(n=b.content)==null||(n=n.stickerMessage.sticker)==null?void 0:n.payload),type:d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.STICKER}}if((b==null||(g=b.content)==null?void 0:g.audioMessage)!=null){var o;return{payload:d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").AudioTransportSpec,b==null||(o=b.content)==null||(o=o.audioMessage.audio)==null?void 0:o.payload),type:d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.PTT}}if((b==null||(h=b.content)==null?void 0:h.documentMessage)!=null){var p;return{payload:d("decodeProtobuf").decodeProtobuf(d("WAMediaTransport.pb").DocumentTransportSpec,b==null||(p=b.content)==null||(p=p.documentMessage.document)==null?void 0:p.payload),type:d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.DOCUMENT}}}if(a!=null){var q;m=a.payload;if((m==null||(q=m.content)==null?void 0:q.extendedContentMessage)!=null){var r;return{payload:m==null||(r=m.content)==null?void 0:r.extendedContentMessage,type:d("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA}}}}g.createAttachmentContext=a}),98);
__d("EncryptedBackupsCreateUploadEntity",["EBGenerateMessageTags","EBLogger","EncryptedBackupsConvertToLegacyAttachmentContext","EncryptedBackupsCreateAttachmentContext","EncryptedBackupsUploadEntity","EncryptedBackupsUtils","I64","MAWEBSwitch","MAWProtobufDeserializers","WAGlobals","WAJids","WAResultOrError","WATimeUtils","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=d("EBLogger").EBLogger.tags(["CreateUploadEntity"]),m=d("WAJids").createJidUtils({platform:"msgr"});function a(a,b,e){var f=a.backupDirective,g=a.externalId,n=a.payload,o=a.threadId;try{a=d("MAWProtobufDeserializers").DeserializedBackupMessage.create(n);var p=a.encryptedTransportMessage();if(p==null){l.WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["transport message subprotocol is undefined"])));return d("WAResultOrError").makeError("invalid-protobuf-no-transport-message")}p=a.proto.metadata;if((p==null?void 0:p.senderId)==null||(p==null?void 0:p.timestampMs)==null||typeof (p==null?void 0:p.timestampMs)!=="number"){l.WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Backup message has incorrect metadata"])));return d("WAResultOrError").makeError("invalid-protobuf-no-metadata")}a=p.senderId;p=p.timestampMs;var q=!c("MAWEBSwitch").isEnabled(),r=d("WATimeUtils").castMilliSecondsToUnixTime(p),s=m.toUserJid(a);s=s===d("WAGlobals").getMyUserJid()?d("WAJids").AUTHOR_ME:s;var t={author:s,chat:o,externalId:g};s=d("EncryptedBackupsCreateAttachmentContext").createAttachmentContext(n);var u=[],v=c("EncryptedBackupsConvertToLegacyAttachmentContext")(s),w=s.map(function(a){return d("EBGenerateMessageTags").generateEBMessageTags(a.mediaType)}).filter(Boolean);v.length>0&&v.forEach(function(a){var b=a.mediaObjectId;a=a.mediaType;u.push({deliveryObjectId:b,mediaType:a,messageId:t.externalId,productType:"msgr",threadId:d("WAJids").threadIdForChatJid(o),threadJid:o,ts:r})});v={backupActionType:f.actionType,backupDirective:f,failTsMs:d("WATimeUtils").castToMillisTime(0),instanceKey:b,isRetroactiveUpload:q,msgId:t,msgIdKey:d("EncryptedBackupsUtils").convertWAMsgIdToStringId(t),msgType:"text",originalMsgProtocolId:f.originalMsgProtocolId,protobuf:n,senderId:(k||(k=d("I64"))).of_string(a),serverTs:r,sortOrderMs:d("WATimeUtils").castLongIntToMillisTime(p),tags:w,triggerSource:e,uploadStatus:d("EncryptedBackupsUploadEntity").EbUploadStatus.NEEDS_BACKUP,uploadTsSec:d("WATimeUtils").unixTime()};s.length>0&&(v=babelHelpers["extends"]({},v,{attachmentContext:s,legacyAttachmentContext:u,msgType:"media"}));return d("WAResultOrError").makeResult(v)}catch(a){l.catching(c("getErrorSafe")(a)).MUSTFIX(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Cannot generate upload entity for message ",""])),g);return d("WAResultOrError").makeError("runtime-error")}}g.createUploadEntity=a}),98);
__d("EBEnqueueMessagesForUpload",["EBAPIQPLPoints","EBLogger","EncryptedBackupsCreateUploadEntity","EncryptedBackupsUploadQueue","MWEBODSEntityName.enum","MWEBODSUtils","QPLFlow","WAHashStringToNumber","WAResultOrError","asyncToGeneratorRuntime","justknobx","qpl","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h,i=d("EBLogger").EBLogger.tags(["EBEnqueueMessagesForUpload"]);function a(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.messages,e=a.triggerSource,f=new Map(),g=new Map();if(b.length===0)return f;a=d("EncryptedBackupsUploadQueue").ebUploadQueue();d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload.api.receive.process",b.length);var j=[],k=c("qpl")._(521477113,"2698");b.forEach(function(a){var b=d("WAHashStringToNumber").hashStringToNumber(c("uuidv4")());g.set(a.externalId,d("QPLFlow").startQPLFlow(k,{instanceKey:b,timeoutInMs:c("justknobx")._("308")}));b=d("EncryptedBackupsCreateUploadEntity").createUploadEntity(a,b,e);if(b.success){var h;j.push(b.value);(h=g.get(a.externalId))==null||h.addPoint(d("EBAPIQPLPoints").EBUploadQueueQPLPoints.UPLOAD_PAYLOAD_CREATED)}else{f.set(a.externalId,d("WAResultOrError").makeError(b.error));(h=g.get(a.externalId))==null||h.endFail(d("EBAPIQPLPoints").EBUploadQueueQPLPoints.UPLOAD_PAYLOAD_CREATION_FAILURE)}});d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload.api.receive.enqueue",j.length);try{yield a.addAndCommit(j),j.forEach(function(a){f.set(a.msgId.externalId,d("WAResultOrError").makeResult());(a=g.get(a.msgId.externalId))==null||a.endSuccess()})}catch(a){i.MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Failed to enqueue entities: ",""])),String(a)),j.forEach(function(a){f.set(a.msgId.externalId,d("WAResultOrError").makeError("enqueue-error"));(a=g.get(a.msgId.externalId))==null||a.endFail(d("EBAPIQPLPoints").EBUploadQueueQPLPoints.ENQUEUE_FAILURE)})}return f});return j.apply(this,arguments)}g["default"]=a}),98);
__d("EBQPLPoints",[],(function(a,b,c,d,e,f){"use strict";a={ATTACHMENT_CONTEXT_END:"attachment_context_end",ATTACHMENT_CONTEXT_START:"attachment_context_start",DIRECTIVE_GENERATION_END:"directive_generation_end",DIRECTIVE_GENERATION_FAIL:"directive_generation_fail",DIRECTIVE_GENERATION_START:"directive_generation_start",MESSAGE_TAG_GENERATION_END:"message_tag_generation_end",MESSAGE_TAG_GENERATION_START:"message_tag_generation_start"};f.EBEnqueueMinosQPLCommonPoints=a}),66);
__d("MAWMPSCreateBackupDirective",["EBLogger","MpsMessageToBridgeWrapper","MpsTypes","WAStanzaUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=d("EBLogger").EBLogger.tags(["mps"]);function i(a){switch(a){case d("MpsTypes").ActionType.UpsertTopLevel:return 1;case d("MpsTypes").ActionType.UpsertSupplemental:return 2;case d("MpsTypes").ActionType.DeleteTopLevel:return 3;case d("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder:return 4;case d("MpsTypes").ActionType.DeleteSupplemental:case d("MpsTypes").ActionType.Preprocess:case d("MpsTypes").ActionType.Noop:case d("MpsTypes").ActionType.DeleteThread:case d("MpsTypes").ActionType.Unknown:h.warn("Action type %d not supported on EB upload",a);return 0}}function a(a,b){var c=i(a.actionType);if(c===0){h.warn("Unknown EB upload action type - cannot upload message");return}c={actionType:c,originalMsgProtocolId:b};a.supplementalKey!=null&&(c=babelHelpers["extends"]({},c,{supplementalKey:a.supplementalKey}));return c}function b(a,b){var c=d("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(b);return{author:c.getAuthor(),chat:c.getChatJid(),externalId:a.actionType===d("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder?d("WAStanzaUtils").toStanzaId(b.messageId):d("WAStanzaUtils").toStanzaId(a.targetMessageId)}}g.createBackupDirectiveFromMPSMessage=a;g.getTargetProtocolMsgIdForMessage=b}),98);
__d("EBEnqueueMinosMessage",["EBGenerateMessageTags","EBMinosFakeData","EBMinosFalcoLoggerUtils","EBMinosLoadMailboxKeys","EBMinosLogger","EBMinosQplFlow","EBMinosTypes","EBQPLPoints","EBSenderUploadQueue","EncryptedBackupsCreateAttachmentContext","EncryptedBackupsUploadEntity","FBLogger","MAWEBSwitch","MAWMPSCreateBackupDirective","MessageBackupSupplementalKeyGenerator","Promise","WAErrorMessage","WAJids","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime","getErrorSafe","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p=d("WATagsLogger").TAGS(["enqueueMinosMsg"]);function q(a){return r.apply(this,arguments)}function r(){r=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){try{a=(yield (o||(o=b("Promise"))).all(a.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield d("EBMinosLoadMailboxKeys").loadMailboxKeys(a));if((b==null?void 0:b.epoch_head)==null||(b==null?void 0:b.encryption_public_key)==null||(b==null?void 0:b.public_key_fbid)==null){(b==null?void 0:b.epoch_head)!=null&&((b==null?void 0:b.encryption_public_key)==null||(b==null?void 0:b.public_key_fbid)==null)&&p.ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Missing required fields for mailbox keys: ",""])),b);return}return{epochHead:b.epoch_head,mailboxKey:b.encryption_public_key,mailboxKeyFbid:b.public_key_fbid,participantId:a}});return function(b){return a.apply(this,arguments)}}())));return d("WAResultOrError").makeResult(a.filter(Boolean))}catch(b){a=c("getErrorSafe")(b);c("FBLogger")("wmi_minos").catching(a).MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Runtime error in getEpochHeadsForContacts"])));return d("WAResultOrError").makeError("runtime-error")}});return r.apply(this,arguments)}function s(a){a=d("WAJids").unsafeCoerceToUserJid(a);return d("EBMinosTypes").unsafeCastToUserFbId(d("WAJids").userIdFromJid(a))}function a(a){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.message;a=a.updateDirective;d("EBMinosLogger").minosLogger.DEV(j||(j=babelHelpers.taggedTemplateLiteralLoose(["start enqueueing message"])));var e=d("EBMinosQplFlow").startMinosMessageEnqueueQpl({threadId:b.threadId}),f={isEbEnabled:c("MAWEBSwitch").isEnabled(),messageId:b.messageId,threadId:b.threadId};try{e.addPoint(d("EBQPLPoints").EBEnqueueMinosQPLCommonPoints.DIRECTIVE_GENERATION_START);var g=d("MAWMPSCreateBackupDirective").getTargetProtocolMsgIdForMessage(a,b);g=d("MAWMPSCreateBackupDirective").createBackupDirectiveFromMPSMessage(a,g);if(g==null){e.endFailWithError(d("EBQPLPoints").EBEnqueueMinosQPLCommonPoints.DIRECTIVE_GENERATION_FAIL,"null backup directive");d("EBMinosFalcoLoggerUtils").logEBMinosArmadilloReceiveWriteDbFailure(f);p.ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Failed to generate backup directive"])));return d("WAResultOrError").makeError("directives-generation-error")}e.addPoint(d("EBQPLPoints").EBEnqueueMinosQPLCommonPoints.DIRECTIVE_GENERATION_END);var h=w(g.actionType,b.messageId,a.targetMessageId);e.addPoint(d("EBQPLPoints").EBEnqueueMinosQPLCommonPoints.ATTACHMENT_CONTEXT_START);var i=d("EncryptedBackupsCreateAttachmentContext").createAttachmentContext(d("EncryptedBackupsUploadEntity").toEbBackupMessageBytes(b.payload));e.addPoint(d("EBQPLPoints").EBEnqueueMinosQPLCommonPoints.ATTACHMENT_CONTEXT_END);e.addPoint(d("EBQPLPoints").EBEnqueueMinosQPLCommonPoints.MESSAGE_TAG_GENERATION_START);var o=i==null?void 0:i.map(function(a){return d("EBGenerateMessageTags").generateEBMessageTags(a.mediaType)}).filter(Boolean);e.addPoint(d("EBQPLPoints").EBEnqueueMinosQPLCommonPoints.MESSAGE_TAG_GENERATION_END);var r=s(b.threadId),t=d("EBMinosTypes").unsafeCastToUserFbId(b.senderId);e.addPoint("get_participant_epoch_heads_start");t=c("gkx")("14827")?yield q([t,r]):yield d("EBMinosFakeData").getFakeMinosData().then(function(a){return d("WAResultOrError").makeResult([{epochHead:a.recipientEpochHead,mailboxKey:a.recipientEncryptionKeyPair.pk,mailboxKeyFbid:a.recipientMailboxKeyFbId,participantId:a.recipientUserFbId}])});if(t.success===!1){e.endFailWithError("get_participant_epoch_heads_failed");return d("WAResultOrError").makeError("unable-to-fetch-epoch-heads-error")}r=t.value;if(r.length===0){d("EBMinosLogger").minosLogger.DEV(l||(l=babelHelpers.taggedTemplateLiteralLoose(["skip enqueueing message. No recipient epoch heads."])));e.addPoint("get_participant_epoch_heads_end",{bool:{no_recipient_epoch_heads:!0}});e.endSuccess();return d("WAResultOrError").makeResult()}e.addPoint("get_participant_epoch_heads_end");var x=u({attachmentContext:i,deletionOfflineThreadingId:h,directive:g,mailboxKeys:r,message:b,supplementalOpToken:v(a),tags:o});p.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Enqueueing message"])));yield d("EBSenderUploadQueue").enqueueMessages([x]).then(function(){d("EBMinosFalcoLoggerUtils").logEBMinosArmadilloReceiveWriteDbSuccess(babelHelpers["extends"]({},f,{isSupplementalUpload:x.directive.originalMsgProtocolId!==x.messageId})),e.endSuccess()});return d("WAResultOrError").makeResult()}catch(a){t=d("WAErrorMessage").maybeGetMessageFromError(a);p.ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose(["Failed to enqueue: ",""])),t);e.endFailWithError("runtime-error",t);d("EBMinosFalcoLoggerUtils").logEBMinosArmadilloReceiveWriteDbFailure(f);return d("WAResultOrError").makeError("runtime-error")}});return t.apply(this,arguments)}function u(a){var b=a.attachmentContext,c=a.deletionOfflineThreadingId,d=a.directive,e=a.mailboxKeys,f=a.message,g=a.supplementalOpToken;a=a.tags;return babelHelpers["extends"]({attachmentContext:b,deletionOfflineThreadingId:c,directive:d,mailboxKeys:e},f,{supplementalOpToken:g,tags:a})}function v(a){a=a.supplementalKey;if(a==null)return void 0;a=d("MessageBackupSupplementalKeyGenerator").parseIdentifierString(a);return d("EBMinosTypes").castToSupplementalOpToken(a.type)}function w(a,b,c){switch(a){case 4:return c;case 3:return b;default:return void 0}}g.enqueueSentMinosMessageForUpload=a}),98);
__d("EBWorkerAddDeviceWithKeys",["EBGating","EBLS","EBSMAPI","EBWorkerAddDeviceUtils","EBWorkerEBDBApiDeferred","EBWorkerEBSMStateUtils","EBWorkerODSEntityName.enum","MessengerWebInitData","ODS","ReQL","WALogger","asyncToGeneratorRuntime","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x;function a(a){return y.apply(this,arguments)}function y(){y=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with key triggered"])));if(c("gkx")("6240"))return;if(!d("EBGating").isEBSMv2Phase1Enabled()){d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with key returned early - not in worker or gk not passed"])));return}var b=d("MessengerWebInitData").sessionId;if(b==null){d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] Add device with key: session id is null from MessengerWebInitData"])));return}var e=a;d("WALogger").LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with key start"])));(x||(x=d("ODS"))).bumpEntityKey(7319,c("EBWorkerODSEntityName.enum").EB_WORKER_ADD_DEVICE_WITH_KEYS,e+".start");var f=a===c("EBWorkerODSEntityName.enum").MW_EB_AUTO_RESTORE_WORKER,g=(yield d("EBLS").getLSStorage()),p=(yield d("EBWorkerEBSMStateUtils").getEBSMWorkerStateRow(g));d("WALogger").LOG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with key got client state row"])));if(p!=null&&!f){d("WALogger").LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with key not run, device already exist"])));E(e);return}f=(yield f&&p!=null?z(g,p,e):p==null?B(g,e):null);d("WALogger").LOG(n||(n=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with key got add device param, param is ",""])),f!=null?"not null":"null");if(f!=null){d("WALogger").LOG(o||(o=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with key calling EBAPI"])));E(e);return c("EBSMAPI").addDeviceWithEBKeys(babelHelpers["extends"]({},f,{db:g,isInWorker:!0,newDeviceRegistrationId:b,source:a,trackAddingDevice:function(a){void d("EBWorkerEBDBApiDeferred").addNewDevice(a)}}))}});return y.apply(this,arguments)}function z(a,b,c){return A.apply(this,arguments)}function A(){A=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){d("WALogger").LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with key get auto restore param start"])));var e=b==null?void 0:b.deviceId;a=(yield d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.secure_encrypted_backups_epochs)).then(function(a){return a!=null}));if(a&&e!=null){d("WALogger").LOG(q||(q=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with key get auto restore param end"])));return{backupId:b.backupId,previousDeviceId:e}}d("WALogger").ERROR(r||(r=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with key get auto restore param failed: ",""])),a?"epoch not found":"device id is null");D(c);return null});return A.apply(this,arguments)}function B(a,b){return C.apply(this,arguments)}function C(){C=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){d("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with key copy eb state tables start"])));yield c("EBSMAPI").fetchBackupIds(a,{isInWorker:!0});var e=(yield d("EBWorkerAddDeviceUtils").copyEBStateTablesFromMainthreadToWorker(["secure_encrypted_backups_epochs","secure_encrypted_backups_client_state"],a)["catch"](function(a){d("WALogger").ERROR(t||(t=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with key copy failed, error: ",""])),a);D(b);return null}));d("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with key copy done: ",""])),e);if(e==="success"){d("WALogger").LOG(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with key copy successful"])));a=(yield d("EBWorkerEBSMStateUtils").getEBSMWorkerStateRow(a));var f=a==null?void 0:a.deviceId;if(a==null||f==null){d("WALogger").ERROR(w||(w=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with key copy successful but ",""])),a==null?"client state row is null":"device id is null");return null}return{backupId:a.backupId,previousDeviceId:f}}else if(e==="fail"){D(b);return null}else{E(b,e);return null}});return C.apply(this,arguments)}function D(a){(x||(x=d("ODS"))).bumpEntityKey(7319,c("EBWorkerODSEntityName.enum").EB_WORKER_ADD_DEVICE_WITH_KEYS,a+".fail")}function E(a,b){(x||(x=d("ODS"))).bumpEntityKey(7319,c("EBWorkerODSEntityName.enum").EB_WORKER_ADD_DEVICE_WITH_KEYS,a+".success"+(b!=null?"."+b:""))}g.addDeviceWithKeysInWorker=a}),98);
__d("MAWEncryptedBackupsClearRecoveryCode",["Promise","ReQL"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return(h||(h=b("Promise"))).all([d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.secure_recovery_code_data)),d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.secure_encrypted_backups_recovery_code_status))]).then(function(c){var d=c[0],e=c[1];if(d!=null||e!=null)return a.runInTransaction(function(a){return(h||(h=b("Promise"))).all([(d==null?void 0:d.taskId)!=null?a.secure_recovery_code_data["delete"](d.taskId):(h||(h=b("Promise"))).resolve(),(e==null?void 0:e.pk)!=null?a.secure_encrypted_backups_recovery_code_status["delete"](e.pk):(h||(h=b("Promise"))).resolve()])},"readwrite",void 0,void 0,f.id+":27")})}g.encryptedBackupsClearRecoveryCode=a}),98);
__d("EBWorkerAddDeviceWithPin",["EBGating","EBLS","EBSMAPI","EBWorkerEBDBApiDeferred","EBWorkerODSEntityName.enum","MAWEncryptedBackupsClearRecoveryCode","ODS","Promise","WALogger","asyncToGeneratorRuntime","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r;function a(a,b){return s.apply(this,arguments)}function s(){s=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with rc triggered"])));if(c("gkx")("6240"))return;if(!d("EBGating").isEBSMv2Phase1Enabled()){d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with rc returned early - gk not passed"])));return}d("WALogger").LOG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with rc start"])));(r||(r=d("ODS"))).bumpEntityKey(7319,c("EBWorkerODSEntityName.enum").EB_WORKER_ADD_DEVICE_WITH_RC,"start");yield d("EBLS").init();yield d("EBLS").clearEBSMStorage();var f=(yield d("EBLS").getLSStorage());yield c("EBSMAPI").fetchBackupIds(f,{isInWorker:!0})["catch"](function(a){d("WALogger").LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with rc failed, error: ",""])),a);(r||(r=d("ODS"))).bumpEntityKey(7319,c("EBWorkerODSEntityName.enum").EB_WORKER_ADD_DEVICE_WITH_RC,"fail");throw a});d("WALogger").LOG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with rc fetch backup id done"])));yield d("MAWEncryptedBackupsClearRecoveryCode").encryptedBackupsClearRecoveryCode(f);yield c("EBSMAPI").addDeviceWithRecoveryCode({environment:null,isInWorker:!0,onFailure:function(a){d("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with rc failed, error: ",""])),a)},onInvalidRecoveryCode:function(){d("WALogger").ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with rc failed with invalid recovery code"])))},onStart:function(){d("WALogger").LOG(o||(o=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with rc EBAPI start"])))},onSuccess:function(){d("WALogger").LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] worker add device with rc success"]))),c("promiseDone")(c("EBSMAPI").fetchBackupIds(f,{isInWorker:!0}))},recoveryCode:a,storage:f,trackAddingDevice:function(){return d("EBWorkerEBDBApiDeferred").addNewDevice()},trackOverprompting:function(){return(q||(q=b("Promise"))).resolve()},userId:e});r.bumpEntityKey(7319,c("EBWorkerODSEntityName.enum").EB_WORKER_ADD_DEVICE_WITH_RC,"success")});return s.apply(this,arguments)}g.addDeviceWithPinInWorker=a}),98);
__d("EBWorkerGetEBState",["EBLS","I64","LSAuthorityLevel","LSIntEnum","ReQL","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a;yield d("EBLS").init();var b=(yield d("EBLS").getLSStorage()),e=(yield (a=d("ReQL")).firstAsync(a.fromTableAscending(b.tables.encrypted_backups)));a=(yield a.firstAsync(a.fromTableAscending(b.tables.secure_encrypted_backups_client_state)));if(e==null)return 2;else if((h||(h=d("I64"))).equal(e.authorityLevel,(i||(i=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").OPTIMISTIC)))return 1;else if((h||(h=d("I64"))).equal(e.authorityLevel,(i||(i=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").AUTHORITATIVE)))return l(a,e);else return-1});return j.apply(this,arguments)}var k="-1";function l(a,b){b=b.backupId;if(b==null)return 2;if((h||(h=d("I64"))).to_string(b)===k)return-1;if(a==null||!(h||(h=d("I64"))).equal(a.authorityLevel,(i||(i=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").AUTHORITATIVE)))return 4;return!(h||(h=d("I64"))).equal(a.backupId,b)?4:3}g.getEBWorkerState=a}),98);
__d("LSOptOutOfBackup",["LSAppendDataTraceAddon","LSIsMobileClient","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop","justknobx"],(function(a,b,c,d,e,f,g){function a(){var a=arguments,d=a[a.length-1],e=[],f=[];return d.sequence([function(g){return d.sequence([function(f){return e[0]=d.i64.of_float(Date.now()),function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsOptOutOfBackupStoredProcedure] Beginning execution."),c("justknobx")._("1099")?d.sequence([function(a){return d.sequence([function(a){return void 0!==void 0?d.storedProcedure(b("LSAppendDataTraceAddon"),void 0,d.i64.cast([0,1469]),d.i64.cast([0,2]),void 0,void 0):d.resolve()},function(a){return d.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,e[11]=a[0],a})},function(a){return e[11]?e[12]=!0:e[12]=!1,e[12]&&!0?(function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),e[14]="LSDataTraceMciTraceLog native op not supported",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",e[14]].join("")),e[13]=d.createArray(),void 0!==void 0?e[15]=(e[13].push(void 0),e[13]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",e[14],e[13],d.i64.cast([0,3]))):d.resolve()}])},function(c){return e[8]=new d.Map(),e[8].set("backup_id",a[0]),e[8].set("trace_id",void 0),e[9]=d.toJSON(e[8]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_opt_out",d.i64.cast([0,50019]),e[9],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),void 0,d.i64.cast([0,0])).then(function(a){return a=a,e[10]=a[0],a})},function(a){return e[1]=d.i64.cast([0,0])}]):d.resolve((function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsOptOutOfBackupStoredProcedure] backup opt out flow is not enabled"),e[1]=d.i64.cast([0,1])))},function(a){return e[2]=d.i64.of_float(Date.now()),e[3]=d.i64.random(),e[5]="Finishing execution. Execution time: ",e[6]=d.i64.to_string(d.i64.sub(e[2],e[0])),e[7]=" ms",e[4]="",function(a){d.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsOptOutOfBackupStoredProcedure] ",e[4],e[5],e[4],e[6],e[4],e[7]].join("")),d.i64.eq(d.i64.mod_(e[3],d.i64.cast([0,1e3])),d.i64.cast([0,0]))?(e[8]=",",e[9]=d.createArray(),void 0!==void 0?e[10]=(e[9].push(void 0),e[9]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsOptOutOfBackupStoredProcedure",[e[5],e[8],e[6],e[8],e[7]].join(""),e[9],d.i64.cast([0,4]))):d.resolve()},function(a){return f[0]=e[1]}])},function(a){return d.resolve(f)}])}a.__sproc_name__="LSEncryptedBackupsOptOutOfBackupStoredProcedure";a.__tables__=[];d=a;g["default"]=d}),98);
__d("LSOptOutOfBackupStoredProcedure",["LSOptOutOfBackup","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSOptOutOfBackup"),e.backupId);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("encryptedBackupsOptOutOfBackup",["LSEncryptedBackupsOpStatus","LSFactory","LSIntEnum","LSOptOutOfBackupStoredProcedure","ReQL"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.tables.encrypted_backups)).then(function(b){if(b==null)return[(h||(h=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsOpStatus").FAILURE)];var e=b.backupId;return e!=null?a.runInTransaction(function(a){return c("LSOptOutOfBackupStoredProcedure")(c("LSFactory")(a),{backupId:e})},"readwrite",void 0,void 0,f.id+":32"):[(h||(h=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsOpStatus").FAILURE)]})}g.optOutOfBackupStoredProcedure=a}),98);
__d("EBWorkerOptOut",["EBGating","EBLS","EBSMAPI","EBWorkerODSEntityName.enum","ODS","ReQL","asyncToGeneratorRuntime","encryptedBackupsOptOutOfBackup","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(c("gkx")("6240"))return;if(!d("EBGating").isEBSMv2Phase1Enabled())return;(h||(h=d("ODS"))).bumpEntityKey(7319,c("EBWorkerODSEntityName.enum").EB_WORKER_OPT_OUT,"start");yield d("EBLS").init();var a=(yield d("EBLS").getLSStorage());yield d("encryptedBackupsOptOutOfBackup").optOutOfBackupStoredProcedure(a).then(function(e){var f=a.tables.secure_encrypted_backups_client_state.subscribe(function(){c("promiseDone")(d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.tables.secure_encrypted_backups_client_state)),function(){var e=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){if(b!=null)if(b.length===0){yield c("EBSMAPI").fetchBackupIds(a,{isInWorker:!0});(h||(h=d("ODS"))).bumpEntityKey(7319,c("EBWorkerODSEntityName.enum").EB_WORKER_OPT_OUT,"success");return f()}else return;else{(h||(h=d("ODS"))).bumpEntityKey(7319,c("EBWorkerODSEntityName.enum").EB_WORKER_OPT_OUT,"fail");return f()}});return function(a){return e.apply(this,arguments)}}())})})});return i.apply(this,arguments)}g.ebOptOutInWorker=a}),98);
__d("EncryptedBackupsDYIMediaManager",["Promise","WAMediaManager","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";var h,i=null,j=new Map(),k=new Map();function a(a,b,c){var d=j.get(a);d==null?j.set(a,new Map([[b,c]])):d.set(b,c)}function c(a,b,c){k.set(a,{protocolMsgId:b,sortOrderMs:c})}function e(a){k["delete"](a)}function f(){j.clear(),k.clear(),i=null}function l(){i==null&&(i=d("WAMediaManager").createMediaManager({dbCallbacks:{getMediaEntries:function(a){a=j.get(a);return a==null?(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeError("no-media-by-plaintext-hash")):(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult(a))},getProtocolMsgIdAndSortOrderMs:function(a){return(h||(h=b("Promise"))).resolve(k.get(a))},updateMediaEntryForMsg:function(){return(h||(h=b("Promise"))).resolve()}}}));return i}g.addMediaEntry=a;g.addMessage=c;g.deleteMessage=e;g.cleanup=f;g.dyiMediaManager=l}),98);
__d("MAWShadowTestMediaStorage",["MAWBridge","MAWQplProxy","MWFBLogger","Random","WAErrorMessage","asyncToGeneratorRuntime","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=d("MWFBLogger").MWMediaLogger.tags(["MediaStorageShadowTest"]),l=["webcache","opfs"],m=9e4;function a(a){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){k.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["runMediaStorageShadowTesting started"])));var b=function(b){var e=d("Random").uint32(),f=d("MAWQplProxy").startQplUserFlow(c("qpl")._(521472095,"2859"),{"int":{input_file_size:a.byteLength},string:{storage_type:b}},{providedInstanceKey:e,providedTimeoutInMs:m});return d("MAWBridge").getBridge().sendAndReceive("event","getMediaStorageResult",{file_bytes:a,storage_type:b},!0,void 0,{toLastActiveClient:!0}).then(function(a){if(a.success)k.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["runMediaStorageShadowTesting succeeded for "," storage type"])),b),f.endSuccess({"double":{cleanup_latency:a.value.cleanupLatency,read_latency:a.value.readLatency,setup_latency:a.value.setupLatency,write_latency:a.value.writeLatency}});else{f.addAnnotations({string:{error_name:a.error.errorName,fail_error_message:(a=a.error.errorMessage)!=null?a:"unknown"}});f.endFail("shadow_test_fail")}})["catch"](function(a){k.MUSTFIX(j||(j=babelHelpers.taggedTemplateLiteralLoose(["runMediaStorageShadowTesting failed: ",""])),a),f.endFail("shadow_test_bridge_fail",{string:{error_message:d("WAErrorMessage").maybeGetMessageFromError(a)}})})};for(var e of l)yield b(e)});return n.apply(this,arguments)}g.runMediaStorageShadowTesting=a}),98);
__d("WAIsDownloadMediaErrorRetryable",[],(function(a,b,c,d,e,f){"use strict";a=function(a){switch(a){case"media-entry-invalid":case"media-entry-invalid-direct-path":case"media-entry-invalid-file-enc-sha256":case"media-entry-invalid-file-sha256":case"media-entry-invalid-media-key":case"media-entry-invalid-server-media-type":case"hash-mismatch":case"ciphertext-hash-mismatch":case"enc-hash-mismatch":case"decryption-error":case"invalid-webp":case"invalid-mp4":case"http-fetch-aborted":return!1;case"create-payload-failed":case"resign-cdn-url-request-error":case"resign-cdn-url-runtime-error":case"resign-cdn-url-gql-error":case"direct-path-undefined":case"direct-path-corrupted":case"direct-path-empty":case"resign-cdn-url-timeout":case"missing-media-entry":case"missing-media-entry-for-restore":case"missing-sort-order-ms-for-restore":case"signature-expired":case"max-attempts-exceeded":case"request-error":case"download-throttled":case"media-not-found":case"no-host":case"backoff":case"body-network-error":case"disconnected":case"runtime-error":case"access-expired":case"http-fetch-exception":case"unspecified-http-error":case"server-timeout":case"preview-not-supported":return!0;default:a;return!0}};f.isDownloadMediaErrorRetryable=a}),66);
__d("MAWDownloadAndHandleMedia",["BlobStorageTypes","MAWBridge","MAWHandleMediaDownloadApi","MAWHandleMediaPreviewBeforeDownloadApi","MAWHandleMediaPreviewDownloadApi","MAWHandleMediaPreviewDownloadAsFailedApi","MAWJobManager","MAWLoggerUtils","MAWMediaDownloadStatus","MAWMediaDownloadStatusForUI","MAWMediaManager","MAWMediaManagerUiIntegrationCheck","MAWMsgType","MAWQplProxy","MAWShadowTestMediaStorage","MAWVideoAudioValidationUtils","MWFBLogger","Promise","Random","WAErrorMessage","WAIsDownloadMediaErrorRetryable","WAMediaCrypto","WAMediaManager","WAResultOrError","WAStartMediaDownloadQplFlow","asyncToGeneratorRuntime","gkx","justknobx","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p=d("MWFBLogger").MWMediaLogger.tags([d("MAWLoggerUtils").Tag.MediaDownload,d("MAWLoggerUtils").Tag.MessageReceive]);a=d("MAWJobManager").getPersistedJobsApi().definePersistedJob().finalStep("downloadAndHandleMedia",function(a){var b=a.downloadType,c=a.hash,e=a.msgType,f=a.protocolMsgId;a=a.qplEntryPoint;var g=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:a,msgType:e,protocolMsgId:f,triggerUIView:null});return q({downloadEntry:a,downloadType:b,hash:c,mediaDownloadFlow:g,msgType:e,protocolMsgId:f})}).end();function q(a){return r.apply(this,arguments)}function r(){r=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.downloadEntry,c=a.downloadType;c=c===void 0?"fullsizeAndPreview":c;var d=a.hash,e=a.mediaDownloadFlow,f=a.msgType;a=a.protocolMsgId;x(d,"download_and_handle_media");yield s({downloadEntry:b,downloadType:c,hash:d,mediaDownloadFlow:e,msgType:f,protocolMsgId:a})});return r.apply(this,arguments)}function s(a){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.downloadEntry,c=a.downloadType,e=a.hash,f=a.mediaDownloadFlow,g=a.msgType,h=a.protocolMsgId;p.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["start Media Manager downloadAndHandleMedia. msgType: ",""])),g);f.addAnnotations({string:{msgType:g}});var i={fullSizePlaintextHash:e,mediaDownloadFlow:f,priority:E(b)};if(c==="preview"&&d("MAWMediaManagerUiIntegrationCheck").getIsMediaManagerUiIntegrationEnabled()){a=d("MAWMediaManager").getMawMediaManager().enqueueDownloadPreview(i);return u({hash:e,msgType:g,previewPromise:a,protocolMsgId:h}).then(function(a){f.endSuccess();return a})["catch"](function(){f.addPoint("fallback_to_fullsize_download");var a=d("MAWMediaManager").getMawMediaManager().enqueueDownloadFullSize(i);return v({fullsizePromise:a,hash:e,mediaDownloadFlow:f,protocolMsgId:h})})}if(c==="fullsize"&&d("MAWMediaManagerUiIntegrationCheck").getIsMediaManagerUiIntegrationEnabled()){b=d("MAWMediaManager").getMawMediaManager().enqueueDownloadFullSize(i);return v({fullsizePromise:b,hash:e,mediaDownloadFlow:f,protocolMsgId:h})}g=(yield d("MAWMediaManager").getMawMediaManager().enqueueDownloadFullSizeAndPreview(i));a=g.fullsizePromise;c=g.previewPromise;void u({hash:e,previewPromise:c,protocolMsgId:h});return v({fullsizePromise:a,hash:e,mediaDownloadFlow:f,protocolMsgId:h})});return t.apply(this,arguments)}function u(a){var c=a.hash,e=a.msgType,f=a.previewPromise,g=a.protocolMsgId;return d("MAWHandleMediaPreviewBeforeDownloadApi").handleMediaPreviewBeforeDownload(c).then(function(){return f}).then(function(a){if(a.success===!1){if(a.error==="preview-not-supported"&&e!==d("MAWMsgType").MSG_TYPE.IMAGE&&e!==d("MAWMsgType").MSG_TYPE.VIDEO){p.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Error: preview not supported"])));return}return(o||(o=b("Promise"))).reject(a.error)}else{var f=d("WAMediaCrypto").convertServerMediaTypeToPreviewMediaType(a.value.serverMediaType);return f==null?(o||(o=b("Promise"))).reject("unsupported preview media type "+a.value.serverMediaType):d("MAWHandleMediaPreviewDownloadApi").handleMediaPreviewDownload(c,a.value.validatedResult.validatedPlaintext,f,g).then(function(){y(c,a.value.validatedResult,"preview")})}})["catch"](function(a){p.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media preview: ",""])),a);return d("MAWHandleMediaPreviewDownloadAsFailedApi").handleMediaPreviewDownloadFailed(c,a.toString()).then(function(){return(o||(o=b("Promise"))).reject(a)})})}function v(a){return w.apply(this,arguments)}function w(){w=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b,e=a.fullsizePromise,f=a.hash,g=a.mediaDownloadFlow;a=a.protocolMsgId;e=(yield e["catch"](function(a){p.catching(a).MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["fullsize download runtime-error"])));return d("WAResultOrError").DEPRECATED_makeError("runtime-error",a)}));if(e.success===!1){p.DEBUG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media for ",""])),String(a));g.endFail(e.error,{string:{failReason:e.payload==null?e.error:d("WAErrorMessage").maybeGetMessageFromError(e.payload)}});z(f,e.error);return}b=(b=e.value.validatedResult.mimeType)!=null?b:e.value.unvalidatedMimeType;g.addPoint("handle_media_download_start");var h=window.performance.now();b=(yield d("MAWHandleMediaDownloadApi").handleMediaDownload(f,b,e.value.validatedResult.validatedPlaintext,a,e.value.validatedResult)["catch"](function(a){p.catching(a).MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Persist media runtime-error"])));return d("WAResultOrError").DEPRECATED_makeError("runtime-error",a)}));c("gkx")("6236")&&(p.DEBUG(n||(n=babelHelpers.taggedTemplateLiteralLoose(["writing blob to storage"]))),yield d("MAWBridge").getBridge().fireAndForget("event","writeToMediaStorage",{blob:e.value.validatedResult.validatedPlaintext,fileName:d("BlobStorageTypes").toBlobFileName(f)}));a=window.performance.now();c("gkx")("14317")&&C({filePlaintext:e.value.validatedResult.validatedPlaintext,idbReadLatency:a-h});b.success||(g.endFail("handle_media_download_fail",{string:{failReason:b.payload==null?b.error:d("WAErrorMessage").maybeGetMessageFromError(b.payload)}}),A(f,b.error));g.addPoint("handle_media_download_end");g.endSuccess();y(f,e.value.validatedResult)});return w.apply(this,arguments)}function x(a,b){d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:b,hash:a,status:c("MAWMediaDownloadStatus").DOWNLOADING,type:"main"})}function y(a,b,e){e===void 0&&(e="main");b=b!=null?b:{};var f=b.audioStreamReport,g=b.mimeType;b=b.videoStreamReport;d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:"handle_media_download_end",hash:a,status:c("MAWMediaDownloadStatus").SUCCESS,type:e,validationResult:d("MAWVideoAudioValidationUtils").normalizeValidationResult({audioAvgBitsPerSecond:f==null?void 0:f.avgBitsPerSecond,audioNumberOfChannels:f==null?void 0:f.numberOfChannels,audioSamplingRate:f==null?void 0:f.samplingRate,audioStreamType:f==null?void 0:f.streamType,validatedMimeType:g,videoAvgBitsPerSecond:b==null?void 0:b.avgBitsPerSecond,videoCalculatedFps:b==null?void 0:b.calculatedFps,videoDuration:b==null?void 0:b.duration,videoHeight:b==null?void 0:b.videoHeight,videoNominalFps:b==null?void 0:b.nominalFps,videoStreamType:b==null?void 0:b.streamType,videoWidth:b==null?void 0:b.videoWidth})})}function z(a,b,c){c===void 0&&(c="main"),d("WAIsDownloadMediaErrorRetryable").isDownloadMediaErrorRetryable(b)?A(a,b,c):B(a,b,c)}function A(a,b,e){e===void 0&&(e="main"),d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:b,hash:a,status:c("MAWMediaDownloadStatus").MANUAL_RETRYABLE_FAILURE,type:e})}function B(a,b,e){e===void 0&&(e="main"),d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:b,hash:a,status:c("MAWMediaDownloadStatus").NOT_MANUAL_RETRYABLE_FAILURE,type:e})}function C(a){var b=a.filePlaintext;a=a.idbReadLatency;var e=d("Random").random()<D()/100;if(!e)return;e=d("Random").uint32();e=d("MAWQplProxy").startQplUserFlow(c("qpl")._(521472095,"2859"),{"int":{input_file_size:b.byteLength},string:{storage_type:"idb"}},{providedInstanceKey:e});e.addAnnotations({"double":{read_latency:a}});e.endSuccess();void d("MAWShadowTestMediaStorage").runMediaStorageShadowTesting(b)}function D(){return c("gkx")("2067")?100:c("justknobx")._("4271")}function E(a){switch(a){case"UILayout":case"DYIMediaManager":case"ForwardMedia":return d("WAMediaManager").MediaTaskPriority.HIGH;case"MebWAMediaDownloader":case"InstamadilloAddMessageMediaContent":case"MAWDyiDownloadMedia":case"WAIncomingMsg":return d("WAMediaManager").MediaTaskPriority.MEDIUM;case"MAWHandleFutureproofMsg":case"handleEchoMediaMsgsRestore":case"SyncMedia":case"EBRestore":return d("WAMediaManager").MediaTaskPriority.LOW}}g.downloadAndHandleMedia=a;g.downloadAndHandleMediaImpl=q;g.sendUIStatusDownloading=x;g.sendUIStatusSuccess=y;g.sendUIStatusFailure=z;g.getPriorityFromDownloadEntry=E}),98);
__d("EncryptedBackupsDYIMediaDownload",["EncryptedBackupsDYIMediaManager","FBLogger","MAWDbMsg","MAWDownloadAndHandleMedia","Promise","WAHashUtils","WAResultOrError","WAStartMediaDownloadQplFlow","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.mediaEntry,f=a.plaintextHash,g=a.protocolMsgId;a=a.sortOrderMs;var i=d("EncryptedBackupsDYIMediaManager").dyiMediaManager(),j=c("FBLogger")("labyrinth_web").tags(["labyrinth_web","labyrinth_dyi"]),k=d("MAWDbMsg").toMsgId(g.chat+"_"+g.externalId+"_m");if(k==null){j.mustfix("Failed to construct the msgId from protocolMsgId for media with plaintext hash: %s",d("WAHashUtils").sanitisePlaintextHash(f));return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeError("missing-media-entry"))}d("EncryptedBackupsDYIMediaManager").addMediaEntry(f,k,e);d("EncryptedBackupsDYIMediaManager").addMessage(k,g,a);e="DYIMediaManager";k=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:e,msgType:null,protocolMsgId:null,triggerUIView:null});j.debug("Enqueuing DYI media download for media with plaintext hash: %s",d("WAHashUtils").sanitisePlaintextHash(f));g=(yield i.enqueueDownloadFullSize({fullSizePlaintextHash:f,mediaDownloadFlow:k,priority:d("MAWDownloadAndHandleMedia").getPriorityFromDownloadEntry(e)}));g.success?k.endSuccess():k.endFail(g.error);return g});return i.apply(this,arguments)}g.downloadDYIMedia=a}),98);
__d("EncryptedBackupsUploadQueueAckUtils",["EBLogger","EncryptedBackupsUploadQueueProcessor","ExecutionEnvironment","MAWBridgeSafeActionsWorkerAndUI","Promise","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p=d("EBLogger").EBLogger.tags(["EncryptedBackupsUploadQueueAckUtils"]);function a(a){return q.apply(this,arguments)}function q(){q=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.instancesWithOutcomes;if(b.length===0){p.WARN(j||(j=babelHelpers.taggedTemplateLiteralLoose(["No instance keys provided to ackWithInstanceKeyBatched"])));return}if((o||(o=c("ExecutionEnvironment"))).isInWorker)try{yield r(b)}catch(a){p.catching(a).MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["ackWithInstanceKey failed with error"])))}else d("MAWBridgeSafeActionsWorkerAndUI").fireAndForgetBackendWorkerAndUIShared("ackWithInstanceKeyBatched",a)});return q.apply(this,arguments)}function r(a){return(n||(n=b("Promise"))).all(a.map(function(a){var b=a.instanceKey;a=a.success;if(Number.isNaN(b)){p.MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Invalid instanceKey provided to ackWithInstanceKeyBatchedWorker: ",""])),b);return}try{b=parseInt(b,10);return d("EncryptedBackupsUploadQueueProcessor").ackWithInstanceKeyWorkerOnly(b,a)}catch(a){p.catching(a).MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["ackWithInstanceKeyBatchedWorker failed with error"])))}}))}function e(a,b){return s.apply(this,arguments)}function s(){s=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e){if(Number.isNaN(a)){p.MUSTFIX(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Invalid instanceKey provided to ackWithInstanceKey: ",""])),a);return(n||(n=b("Promise"))).resolve()}if((o||(o=c("ExecutionEnvironment"))).isInWorker)try{return yield d("EncryptedBackupsUploadQueueProcessor").ackWithInstanceKeyWorkerOnly(a,e)}catch(a){p.catching(a).MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["ackWithInstanceKey failed with error"])))}else d("MAWBridgeSafeActionsWorkerAndUI").fireAndForgetBackendWorkerAndUIShared("ackWithInstanceKey",{instanceKey:a,success:e});return(n||(n=b("Promise"))).resolve()});return s.apply(this,arguments)}g.ackWithInstanceKeyBatched=a;g.ackWithInstanceKey=e}),98);
__d("IGDAWAdminWriteICDCMsgTxn",["Promise","cr:10743","cr:2327"],(function(a,b,c,d,e,f,g){"use strict";var h,i=(c=b("cr:2327"))!=null?c:b("cr:10743");function a(a,c,d){return i?i.writeICDCAdminMsg(a,c,d):(h||(h=b("Promise"))).resolve()}g.writeICDCAdminMsg=a}),98);
__d("IGDAWAdminWriteUserDeviceMsgTxn",["Promise","cr:10744","cr:2693"],(function(a,b,c,d,e,f,g){"use strict";var h,i=(c=b("cr:2693"))!=null?c:b("cr:10744");function a(a,c,d,e,f,g){return i?i.writeUserDeviceAdminMsg(a,c,d,e,f,g):(h||(h=b("Promise"))).resolve()}g.writeUserDeviceAdminMsg=a}),98);
__d("IGDAWDbAddDeviceChangeAlertsTxn",["asyncToGeneratorRuntime"],(function(a,b,c,d,e,f){"use strict";function a(a,b){return g.apply(this,arguments)}function g(){g=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){yield a.e2ee_deviceChangeAlerts.put(b)});return g.apply(this,arguments)}f.addDeviceChangeAlertsTxn=a}),66);
__d("IGDAWDbUpdateDeviceChangeAlertsTxn",["I64","MAWUnsafeCoerce","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){yield a.e2ee_deviceChangeAlerts.upsert([b.deviceChangeAlertsId],b)});return i.apply(this,arguments)}function c(a){return d("MAWUnsafeCoerce").unsafeCoerce((h||(h=d("I64"))).of_float(a))}g.updateDeviceChangeAlertsTxn=a;g.convertDeviceChangeAlertsId=c}),98);
__d("IGDAWDbUpdateDeviceChangeAlertsLogInStatusTxn",["IGDAWDbUpdateDeviceChangeAlertsTxn","Promise","ReQL","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c){c=(yield d("ReQL").toArrayAsync(d("ReQL").fromTableDescending(a.e2ee_deviceChangeAlerts.index("deviceJid")).getKeyRange(c).filter(function(a){return!a.loggedOut})));yield (h||(h=b("Promise"))).all(c.map(function(b){return d("IGDAWDbUpdateDeviceChangeAlertsTxn").updateDeviceChangeAlertsTxn(a,babelHelpers["extends"]({},b,{loggedOut:!0}))}))});return i.apply(this,arguments)}g.updateDeviceChangeAlertsLogInStatusTxn=a}),98);
__d("IGDDbThreadTxns",["I64","Promise","ReQL","WAJids","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a,b){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c){return new Map(yield a.runInTransaction(function(a){return(i||(i=b("Promise"))).all(c.map(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var c;b=d("WAJids").extractUserId(b);return[b,yield (c=d("ReQL")).toArrayAsync(c.mergeJoin(c.fromTableAscending(a.participants.index("contactIdThreadKey"),[]).getKeyRange((h||(h=d("I64"))).of_string(b)),d("ReQL").fromTableAscending(a.threads)).map(function(a){a[0];a=a[1];return a}))]});return function(a){return c.apply(this,arguments)}}()))},"readonly",void 0,void 0,f.id+":24"))});return j.apply(this,arguments)}g.getAllThreadsForUsers=a}),98);
__d("IGDHandleICDCErrorInstruction",["IGDAWAdminWriteICDCMsgTxn","MAWODSProxy","Promise","WAOdsEnums","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e){var g=e.shouldShowAdminMessages,i=e.threads;if(!g)return;yield a.runInTransaction(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){yield (h||(h=b("Promise"))).all(i.map(function(b){return d("IGDAWAdminWriteICDCMsgTxn").writeICDCAdminMsg(a,b,c.notificationTs)})),d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.ICDC,key:"icdc"})});return function(b){return a.apply(this,arguments)}}(),"readwrite",void 0,void 0,f.id+":30")});return i.apply(this,arguments)}g.handleICDCError=a}),98);
__d("IGDHandleIdentityAddedInstruction",["IGDAWAdminWriteUserDeviceMsgTxn","IGDAWDbAddDeviceChangeAlertsTxn","MAWAdminWriteUserDeviceMsgTxn","MAWDbDeviceChangeAlerts","MAWODSProxy","Promise","WAOdsEnums","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e){var g=e.allowSecurityAlertForSelf,i=e.contactId,k=e.isMe,l=e.shouldShowAdminMessages,m=e.threads;yield a.runInTransaction(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=j(a,c,k,g),f=e.promise;e=e.showSelfAlerts;var n=l?m.map(function(b){return d("IGDAWAdminWriteUserDeviceMsgTxn").writeUserDeviceAdminMsg(a,i,k,b,d("MAWAdminWriteUserDeviceMsgTxn").DeviceChange.add,c.notificationTs)}):[];yield (h||(h=b("Promise"))).all([f].concat(n));(e||l)&&d("MAWODSProxy").odsBumpEntityKey({entity:k?d("WAOdsEnums").Entity.SECURITY_ALERT_FOR_SELF:d("WAOdsEnums").Entity.SECURITY_ALERT_FOR_CONTACT,key:d("MAWDbDeviceChangeAlerts").ADD})});return function(b){return a.apply(this,arguments)}}(),"readwrite",void 0,void 0,f.id+":47")});return i.apply(this,arguments)}function j(a,c,e,f){var g=!1,i=(h||(h=b("Promise"))).resolve();if(e&&c.model!=null&&c.platform!=null&&c.notificationTs!=null){g=!0;e=c.instruction==="identityChanged"?d("MAWDbDeviceChangeAlerts").KEY_CHANGE:d("MAWDbDeviceChangeAlerts").ADD;i=d("IGDAWDbAddDeviceChangeAlertsTxn").addDeviceChangeAlertsTxn(a,{action:e,deviceJid:c.device,identity:c.identity,isArchived:!f,isConfirmed:!1,isNotified:!1,model:c.model,platform:c.platform,ts:c.notificationTs})}return{promise:i,showSelfAlerts:g}}g.handleIdentityAdded=a;g.addDeviceChangeAlerts=j}),98);
__d("IGDHandleIdentityChangedInstruction",["IGDAWAdminWriteUserDeviceMsgTxn","IGDHandleIdentityAddedInstruction","MAWAdminWriteUserDeviceMsgTxn","MAWDbDeviceChangeAlerts","MAWODSProxy","Promise","WAJids","WAOdsEnums","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e){var g=e.allowSecurityAlertForSelf,i=e.isMe,j=e.shouldShowAdminMessages,k=e.threads;yield a.runInTransaction(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=d("IGDHandleIdentityAddedInstruction").addDeviceChangeAlerts(a,c,i,g),f=e.promise;e=e.showSelfAlerts;var l=j?k.map(function(b){return d("IGDAWAdminWriteUserDeviceMsgTxn").writeUserDeviceAdminMsg(a,d("WAJids").extractUserId(c.jid),i,b,d("MAWAdminWriteUserDeviceMsgTxn").DeviceChange.update,c.notificationTs)}):[];yield (h||(h=b("Promise"))).all([f].concat(l));(e||j)&&d("MAWODSProxy").odsBumpEntityKey({entity:i?d("WAOdsEnums").Entity.SECURITY_ALERT_FOR_SELF:d("WAOdsEnums").Entity.SECURITY_ALERT_FOR_CONTACT,key:d("MAWDbDeviceChangeAlerts").KEY_CHANGE})});return function(b){return a.apply(this,arguments)}}(),"readwrite",void 0,void 0,f.id+":31")});return i.apply(this,arguments)}g.handleIdentityChanged=a}),98);
__d("IGDHandleIdentityRemovedInstruction",["IGDAWAdminWriteUserDeviceMsgTxn","IGDAWDbUpdateDeviceChangeAlertsLogInStatusTxn","MAWAdminWriteUserDeviceMsgTxn","MAWDbDeviceChangeAlerts","MAWODSProxy","Promise","WAOdsEnums","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e){var g=e.contactId,i=e.isMe,j=e.shouldShowAdminMessages,k=e.threads;yield a.runInTransaction(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=i?d("IGDAWDbUpdateDeviceChangeAlertsLogInStatusTxn").updateDeviceChangeAlertsLogInStatusTxn(a,c.device):(h||(h=b("Promise"))).resolve(),f=j?k.map(function(b){return d("IGDAWAdminWriteUserDeviceMsgTxn").writeUserDeviceAdminMsg(a,g,i,b,d("MAWAdminWriteUserDeviceMsgTxn").DeviceChange.remove,c.notificationTs)}):[];yield (h||(h=b("Promise"))).all([e].concat(f));(i||j)&&d("MAWODSProxy").odsBumpEntityKey({entity:i?d("WAOdsEnums").Entity.SECURITY_ALERT_FOR_SELF:d("WAOdsEnums").Entity.SECURITY_ALERT_FOR_CONTACT,key:d("MAWDbDeviceChangeAlerts").REMOVE})});return function(b){return a.apply(this,arguments)}}(),"readwrite",void 0,void 0,f.id+":30")});return i.apply(this,arguments)}g.handleIdentityRemoved=a}),98);
__d("IGDAWProtocolQueueInstructions",["FBLogger","IGDDbThreadTxns","IGDHandleICDCErrorInstruction","IGDHandleIdentityAddedInstruction","IGDHandleIdentityChangedInstruction","IGDHandleIdentityRemovedInstruction","MAWDbAppMeta","MAWReStoreDb","Promise","WAAssertUnreachable","WAGlobals","WAJids","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield d("MAWReStoreDb").getDB(f.id+":33")),e=(yield j(b,a)),g=e[0],h=g.allowSecurityAlertForContact;g=g.allowSecurityAlertForSelf;e=e[1];var i=[];for(a of a){var k=a.jid,m=d("WAJids").extractUserId(k);k=k===d("WAGlobals").getMyUserJid();var n=l({allowSecurityAlertForContact:h,isICDCError:a.instruction==="icdcError",isMe:k});n={allowSecurityAlertForSelf:g,contactId:m,isMe:k,shouldShowAdminMessages:n,threads:(k=e.get(m))!=null?k:[]};try{yield o(b,a,n),i.push(a.stanzaQueueId)}catch(a){c("FBLogger")("igd_web").warn("Failed to handle instruction. The error is %s",a)}}return{followUpParams:void 0,toAck:i}});return i.apply(this,arguments)}function j(a,b){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=new Set(b.map(function(a){return a.jid})),e=(yield m(a)),f=e.allowSecurityAlertForContact&&b.some(function(a){return a.jid!==d("WAGlobals").getMyUserJid()});b=b.some(function(a){return a.instruction==="icdcError"});f=f||b;b=f?yield d("IGDDbThreadTxns").getAllThreadsForUsers(a,Array.from(c)):new Map();return[e,b]});return k.apply(this,arguments)}function l(a){var b=a.allowSecurityAlertForContact,c=a.isICDCError;a=a.isMe;return!a&&(b||c)}function m(a){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=(yield (h||(h=b("Promise"))).all([a.tables.e2ee_appMeta.get(d("MAWDbAppMeta").AppMetaKeysEnum.allowSecurityAlertForSelf),a.tables.e2ee_appMeta.get(d("MAWDbAppMeta").AppMetaKeysEnum.allowSecurityAlert)]));var c=a[0];a=a[1];return{allowSecurityAlertForContact:(a=a==null?void 0:a.value.allowSecurityAlert)!=null?a:!1,allowSecurityAlertForSelf:(a=c==null?void 0:c.value.allowSecurityAlertForSelf)!=null?a:!0}});return n.apply(this,arguments)}function o(a,b,e){switch(b.instruction){case"identityChanged":return d("IGDHandleIdentityChangedInstruction").handleIdentityChanged(a,b,e);case"identityAdded":return d("IGDHandleIdentityAddedInstruction").handleIdentityAdded(a,b,e);case"identityRemoved":return d("IGDHandleIdentityRemovedInstruction").handleIdentityRemoved(a,b,e);case"icdcError":return d("IGDHandleICDCErrorInstruction").handleICDCError(a,b,e);default:throw c("WAAssertUnreachable")(b)}}g.handleInstructions=a;g.getShouldShowAdminMessages=l}),98);
__d("WAParseMessageTransport",["WALogger","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a){return{version:"v3",type:"error",error:a}}function j(a,b){return a!=null&&(b.dsm==null||b.dsm.destinationJid==null||b.dsm.destinationJid!==a)}function a(a,b){var c=a.payload,e=a.protocol;if(c==null&&e==null)return i("There is no payload and protocol in the message transport");else if(e==null)return i("There is no protocol part in the message transport");var f=e.integral;if(f==null)return i("There is no integral part in the message transport");else if(f.padding==null)return i("There is no padding in the message transport");else if(j(b,f))return i("The recipient does not match the device sent message recipient");else if(d("decodeProtobuf").getUnknownFields(f)!=null){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["There are unknown fields in the integral"])));return babelHelpers["extends"]({},i("There are unknown fields in the integral"),{futureProof:c==null?void 0:c.futureProof})}if(c!=null){b=c.applicationPayload;return b==null?i("There is no applicationPayload payload in the message transport"):{type:"applicationPayload",applicationPayload:b,skdm:l(e.ancillary),icdc:m(e.ancillary)}}f=l(e.ancillary);if(f!=null)return{type:"skdm",skdm:f,icdc:m(e.ancillary)};return k(a)===!0?{type:"empty",version:"v3"}:{type:"unknown"}}function k(a){var b;if(a.payload!=null)return!1;if(a.protocol==null)return!0;a=a.protocol;var c=new Set(["$$unknownFieldCount","padding"]);b=Object.keys((b=a.integral)!=null?b:{}).filter(function(a){return!c.has(a)});a=Object.keys((a=a.ancillary)!=null?a:{}).filter(function(a){return!c.has(a)});return a.length===0&&b.length===0}function l(a){return a==null?null:a.skdm}function m(a){return a==null?null:a.icdc}g.parseMessageTransport=a}),98);
__d("MAWFbCat",["FBLogger"],(function(a,b,c,d,e,f,g){"use strict";var h=null;function a(a){h=a}function b(){if(h==null)throw c("FBLogger")("messenger_web").mustfixThrow("FBCat is not set");return h}g.setFbCat=a;g.getFbCat=b}),98);
__d("MAWRotateCAT",["FBLogger","MAWBridge","MAWCatQuery.graphql","MAWCryptoAuthToken","MAWFbCat","MAWODSProxy","MAWQplProxy","Promise","WAArrayBufferUtils","WADbDeviceRegistration","WADbMetaTxns","WALogger","WAOdsEnums","WAPromiseRetryLoop","WARetryUtils","asyncToGeneratorRuntime","createWorkerQuery","getErrorSafe","gkx","qpl","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n=c("requireDeferred")("WorkerRelayNetwork").__setRef("MAWRotateCAT"),o=c("qpl")._(1056847537,"2667"),p=0;function q(a){var e=a.initiator;a=a.qplAnnotations;p++;var f=d("MAWQplProxy").startQplUserFlow(o,{"int":babelHelpers["extends"]({},a["int"],{totalRotationCounter:p}),string:babelHelpers["extends"]({},a.string,{initiator:e})});d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.CAT_ROTATION,key:"rotateCAT"});d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Starting rotate CAT Task Bridge event"])));c("gkx")("8216")?(f.addAnnotations({string:{fetchFrom:"worker"}}),a=s(f)["catch"](function(a){f.addPoint("fallback_to_ui");return u()["catch"](function(d){d=c("getErrorSafe")(d);f.addPoint("fallback_error",{string:{errorDescriptionUI:d.message}});return(m||(m=b("Promise"))).reject(a)})})):(f.addAnnotations({string:{fetchFrom:"tab"}}),a=u());return a.then(function(a){if(!a){f.addPoint("no_valid_result");throw c("FBLogger")("messenger_web").mustfixThrow("CAT Rotation failed: no valid result")}return d("WADbMetaTxns").saveCAT(a)}).then(function(a){f.addPoint("set_fb_cat");d("MAWFbCat").setFbCat(d("WAArrayBufferUtils").stringToArrayBuffer(a.encrypted_serialized_cat));d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["CAT Finished Rotating"])));f.endSuccess();return a})["catch"](function(a){a=c("getErrorSafe")(a);d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[MAWRotateCAT] Got an error while attempting to rotate CAT: ",""])),a);f.endFail("error",{string:{errorDescription:a.message}});return null})}var r=null;function a(a){var e;if(r!=null)return r.promise();var f=(e=a==null?void 0:a.retries)!=null?e:d("WADbDeviceRegistration").MAX_ROTATE_CRYPTO_AUTH_TOKEN_RETRIES,g=0;e=new(d("WAPromiseRetryLoop").PromiseRetryLoop)({code:function(){var e=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var e;if(g===f){d("WALogger").COUNT(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Unable to rotate CAT"])));throw c("FBLogger")("messenger_web").mustfixThrow("Unable to rotate CAT")}e=(yield q({initiator:"MAWRotateCAT::tryRotateCAT",qplAnnotations:{"int":babelHelpers["extends"]({},(e=a.qplAnnotations)==null?void 0:e["int"],{retryLoopAllowedRetries:f,retryLoopZeroBasedIteration:g}),string:babelHelpers["extends"]({},(e=a.qplAnnotations)==null?void 0:e.string,{retryLoopInitiator:a.initiator})}}));e!=null&&(d("WALogger").LOG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Rotate CAT finished, ending rotate CAT promise retry loop"]))),b());g++});function h(a){return e.apply(this,arguments)}return h}(),name:"rotateCAT",timer:d("WARetryUtils").fibonacciBackoff(!0)});e.start();e.promise()["finally"](function(){r=null});r=e;return e.promise()}function s(a){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){yield n.load().then(function(a){a=a.createWorkerNetworkExecute;a()});return c("createWorkerQuery")(c("MAWCatQuery.graphql"),{},{onExecute:function(){a.addPoint("query_executed")},onResponse:function(b){a.addPoint("response_received",{bool:{response_is_array:Array.isArray(b),response_is_null:b===null},"int":{response_array_size:Array.isArray(b)?b.length:void 0},string:{response_type:typeof b}});if(typeof b==="object"){b=Array.isArray(b)?b[0]:b;b!=null&&a.addAnnotations({string:{response_payload:JSON.stringify(b.payload)},string_array:{response_keys:Object.keys(b)}})}}}).then(function(a){return d("MAWCryptoAuthToken").processCatResponse(a)}).then(function(a){if(a.error!=null)throw c("FBLogger")("messenger_web").mustfixThrow(a.error);return a.success})});return t.apply(this,arguments)}function u(){return v.apply(this,arguments)}function v(){v=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield d("MAWQplProxy").workerBridgeDeferred.getPromise();return d("MAWBridge").getBridge().sendAndReceive("event","rotateCryptoAuthToken",{})});return v.apply(this,arguments)}g.rotateCAT=q;g.tryRotateCAT=a}),98);
__d("MAWSharedOfflineResumeUINotifier",["MAWBridge","MAWQplProxy","MAWSharedProtocolQueueConst","MWFBLogger","WAOfflineUtils","WAThrottle","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=1e3/3,m=d("MWFBLogger").MWLogger.tags(["ProtocolQueue","MAWConsumer"]);a=function(){function a(){var a=this;this.$1={};this.$2={};this.$3=0;this.$4="wa";this.$5=!1;this.$6=0;this.$7=0;this.$8=0;this.$9=0;this.$10=null;this.$16=d("WAThrottle").throttle(function(){if(a.$5)return;a.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing)},l);this.$12=d("WAThrottle").throttle(function(){a.$4==="wa"&&a.$5===!1&&a.$11(d("WAOfflineUtils").WAClientInfraOfflineProgress.Processing)},l)}var b=a.prototype;b.subscribeToWAEvents=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"offline-start":b.$10=d("MAWQplProxy").performanceAbsoluteNow();b.$6=a.offlineStats.count;b.$8=a.offlineStats.message;b.$11(d("WAOfflineUtils").WAClientInfraOfflineProgress.Initializing,b.$10);b.$5=!1;b.$4="wa";break;case"offline-processed":break;case"offline-entity":b.$7++;b.$12();break;case"offline-end":b.$11(d("WAOfflineUtils").WAClientInfraOfflineProgress.Complete);b.$4="maw";break;case"connection-lost":b.$11(d("WAOfflineUtils").WAClientInfraOfflineProgress.Failed);break;default:a}})};b.subscribeToMawEvents=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"maw-infra-start":b.$10==null&&(b.$10=d("MAWQplProxy").performanceAbsoluteNow());b.$13();break;case"maw-infra-end":a.success?b.notifyUICurrentProcessingSucceeded():b.$14();b.$10=null;break}})};b.subscribeToMessageEvents=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"new-message":if(a.commonMessageBase.offline==null)return;b.addWAMessage();break}})};b.addWAMessage=function(){this.$9++,this.$12()};b.$13=function(){this.$3=0,this.$5=!1,this.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Initializing)};b.setThreadMetadata=function(a){var b=a.reduce(function(a,b){a[b.from]=b.t;return a},{});a=a.reduce(function(a,b){b=b.from;a[b]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing};return a},{});m.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Set thread metadata: ",", ",""])),JSON.stringify(b),JSON.stringify(a));this.$1=b;this.$2=a};b.notifyUIChatReady=function(a){this.$2[a]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete},this.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing)};b.updateChatState=function(a){var b=this;Object.entries(a).forEach(function(a){var c=a[0];a=a[1];if(b.$1[c]!=null){var e=b.$1[c];a>=e&&(b.$2[c]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete})}});this.$16()};b.addMAWEntity=function(a){this.$3+=a,this.$16()};b.notifyUICurrentProcessingSucceeded=function(){var a=this;Object.keys(this.$2).forEach(function(b){a.$2[b]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete}});this.$5=!0;this.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete);this.$1={};this.$2={}};b.$14=function(){var a=this;Object.keys(this.$2).forEach(function(b){a.$2[b]={chatStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete}});this.$15(d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Failed);this.$1={};this.$2={}};b.maybeNotifyUI=function(){this.$16()};b.$11=function(a,b){d("MAWBridge").getBridge().fireAndForget("event","offlineSnapshot",{downloaded:{count:this.$7,message:this.$9},expected:{count:this.$6,message:this.$8},status:a,timestamp:b!=null?b:d("MAWQplProxy").performanceAbsoluteNow()})};b.$15=function(a){var b=d("MAWQplProxy").performanceAbsoluteNow();b={chatJidStatus:this.$2,startTime:this.$10!=null?this.$10:null,status:a,timestamp:b,totalExpectedCount:this.$6,totalProcessedCount:this.$3};m.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["MAW UI: ",""])),JSON.stringify(b));a===d("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete?c("promiseDone")(d("MAWBridge").getBridge().sendAndReceive("event","offlineConsumerProgress",b),function(){m.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose([' -> "Offline Complete" bridge event sent'])))},function(a){m.MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose([' -> Unable to send "Offline Complete" event ',""])),a)}):d("MAWBridge").getBridge().fireAndForget("event","offlineConsumerProgress",b)};return a}();b=new a();g.ConsumerUINotifier=a;g.offlineResumeUINotifier=b}),98);
__d("MAWExpiredXMACleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=null;function a(a){j==null&&(j=new(d("MAWMsgCleaner").MsgCleaner)(a,d("MAWMsgCleaner").CLEANER_TYPE.XMA))}function b(a){if(j==null){var b="Trying to add new addNewExpiredXMACleanerTimestamp before the cleaner is initialized!";d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["",""])),b);throw c("FBLogger")("messenger_web").mustfixThrow(b)}else d("WALogger").DEV(i||(i=babelHelpers.taggedTemplateLiteralLoose(["ExpiredXMACleaner: Adding timestamps backend(",")"])),a),j.update(a)}function e(){return j}function f(){j=null}g.startExpiredXMACleaner=a;g.addNewExpiredXMACleanerTimestamp=b;g.getExpiredXMACleaner_FOR_TESTING_ONLY=e;g.resetExpiredXMACleaner_FOR_TESTING_ONLY=f}),98);
__d("WAFtsTokenizerBaseNormalizer",[],(function(a,b,c,d,e,f){"use strict";a=function(){function a(a){var b=this,c=[];this.$1=new Map();a.forEach(function(a){var d=a[0];a=a[1];b.$1.set(d,a);c.push(d)});this.$2=new RegExp(c.join("|"),"g")}var b=a.prototype;b.normalize=function(a){var b=this;a===void 0&&(a="");return a.replace(this.$2,function(a){var c=b.$1.get(a);return c!=null?c:a})};return a}();f["default"]=a}),66);
__d("WAFtsTokenizerPostLowercaseNormalizer",["WAFtsTokenizerBaseNormalizer"],(function(a,b,c,d,e,f,g){"use strict";a=[["\u0131","i"],["\u0629","\u0647"],["\u0640",""],["\u0649","\u064a"],["\u0671","\u0627"],["\u06a4","\u0641"],["\u06a9","\u0643"],["\u06ba","\u0646"],["\u06be","\u0647"],["\u06c3","\u06c2"],["\u06cc","\u064a"],["\u06d2","\u064a"],["\u06d5","\u0647"],["\u06f0","\u0660"],["\u06f1","\u0661"],["\u06f2","\u0662"],["\u06f3","\u0663"],["\u06f4","\u0664"],["\u06f5","\u0665"],["\u06f6","\u0666"],["\u06f7","\u0667"],["\u06f8","\u0668"],["\u06f9","\u0669"],["\u08bb","\u0641"],["\u08bc","\u0642"],["\u08bd","\u0646"],["\u200c",""],["\u0966","0"],["\u0967","1"],["\u0968","2"],["\u0969","3"],["\u096a","4"],["\u096b","5"],["\u096c","6"],["\u096d","7"],["\u096e","8"],["\u096f","9"],["\u0901","\u0902"],["\u0903",""],["\u093c",""],["\u09e6","0"],["\u09e7","1"],["\u09e8","2"],["\u09e9","3"],["\u09ea","4"],["\u09eb","5"],["\u09ec","6"],["\u09ed","7"],["\u09ee","8"],["\u09ef","9"],["\u0a66","0"],["\u0a67","1"],["\u0a68","2"],["\u0a69","3"],["\u0a6a","4"],["\u0a6b","5"],["\u0a6c","6"],["\u0a6d","7"],["\u0a6e","8"],["\u0a6f","9"],["\u0c66","0"],["\u0c67","1"],["\u0c68","2"],["\u0c69","3"],["\u0c6a","4"],["\u0c6b","5"],["\u0c6c","6"],["\u0c6d","7"],["\u0c6e","8"],["\u0c6f","9"],["\u0ae6","0"],["\u0ae7","1"],["\u0ae8","2"],["\u0ae9","3"],["\u0aea","4"],["\u0aeb","5"],["\u0aec","6"],["\u0aed","7"],["\u0aee","8"],["\u0aef","9"],["\u0ce6","0"],["\u0ce7","1"],["\u0ce8","2"],["\u0ce9","3"],["\u0cea","4"],["\u0ceb","5"],["\u0cec","6"],["\u0ced","7"],["\u0cee","8"],["\u0cef","9"],["\u0d66","0"],["\u0d67","1"],["\u0d68","2"],["\u0d69","3"],["\u0d6a","4"],["\u0d6b","5"],["\u0d6c","6"],["\u0d6d","7"],["\u0d6e","8"],["\u0d6f","9"],["\u0142","l"]];b=new(c("WAFtsTokenizerBaseNormalizer"))(a);d=b;g["default"]=d}),98);
__d("WAFtsTokenizerPreNFKDNormalizer",["WAFtsTokenizerBaseNormalizer"],(function(a,b,c,d,e,f,g){"use strict";a=[["\u0675","\u0674\u0627"],["\u0676","\u0674\u0648"],["\u0677","\u0674\u06c7"],["\u0678","\u0674\u0649"],["\u0905\u0946","\u0904"],["\u0905\u093e","\u0906"],["\u0930\u094d\u0907","\u0908"],["\u0909\u0941","\u090a"],["\u090f\u0945","\u090d"],["\u090f\u0946","\u090e"],["\u090f\u0947","\u0910"],["\u0905\u0949","\u0911"],["\u0906\u0945","\u0911"],["\u0905\u094a","\u0912"],["\u0906\u0946","\u0912"],["\u0905\u094b","\u0913"],["\u0906\u0947","\u0913"],["\u0905\u094c","\u0914"],["\u0906\u0948","\u0914"],["\u0905\u0945","\u0972"],["\u0905\u093a","\u0973"],["\u0905\u093b","\u0974"],["\u0906\u093a","\u0974"],["\u0905\u094f","\u0975"],["\u0905\u0956","\u0976"],["\u0905\u0957","\u0977"],["\u0985\u09be","\u0986"],["\u098b\u09c3","\u09e0"],["\u098c\u09e2","\u09e1"],["\u0a05\u0a3e","\u0a06"],["\u0a72\u0a3f","\u0a07"],["\u0a72\u0a40","\u0a08"],["\u0a73\u0a41","\u0a09"],["\u0a73\u0a42","\u0a0a"],["\u0a72\u0a47","\u0a0f"],["\u0a05\u0a48","\u0a10"],["\u0a73\u0a4b","\u0a13"],["\u0a05\u0a4c","\u0a14"],["\u0a85\u0abe","\u0a86"],["\u0a85\u0ac5","\u0a8d"],["\u0a85\u0ac7","\u0a8f"],["\u0a85\u0ac8","\u0a90"],["\u0a85\u0ac9","\u0a91"],["\u0a85\u0acb","\u0a93"],["\u0a85\u0abe\u0ac5","\u0a93"],["\u0a85\u0acc","\u0a94"],["\u0a85\u0abe\u0ac8","\u0a94"],["\u0ac5\u0abe","\u0ac9"],["\u0b05\u0b3e","\u0b06"],["\u0b0f\u0b57","\u0b10"],["\u0b13\u0b57","\u0b14"],["\u0bb8\u0bcd\u0bb0\u0bc0","\u0bb6\u0bcd\u0bb0\u0bc0"],["\u0c12\u0c55","\u0c13"],["\u0c12\u0c4c","\u0c14"],["\u0c3f\u0c55","\u0c40"],["\u0c46\u0c55","\u0c47"],["\u0c4a\u0c55","\u0c4b"],["\u0c89\u0cbe","\u0c8a"],["\u0c92\u0ccc","\u0c94"],["\u0c8b\u0cbe","\u0ce0"],["\u0d07\u0d57","\u0d08"],["\u0d09\u0d57","\u0d0a"],["\u0d0e\u0d46","\u0d10"],["\u0d12\u0d3e","\u0d13"],["\u0d12\u0d57","\u0d14"],["\u0d23\u0d4d\u200d","\u0d7a"],["\u0d28\u0d4d\u200d","\u0d7b"],["\u0d30\u0d4d\u200d","\u0d7c"],["\u0d32\u0d4d\u200d","\u0d7d"],["\u0d33\u0d4d\u200d","\u0d7e"],["\u0d85\u0dcf","\u0d86"],["\u0d85\u0dd0","\u0d87"],["\u0d85\u0dd1","\u0d88"],["\u0d8b\u0ddf","\u0d8c"],["\u0d8d\u0dd8","\u0d8e"],["\u0d8f\u0ddf","\u0d90"],["\u0d91\u0dca","\u0d92"],["\u0d91\u0dd9","\u0d93"],["\u0d94\u0ddf","\u0d96"]];b=new(c("WAFtsTokenizerBaseNormalizer"))(a);d=b;g["default"]=d}),98);
__d("WAFtsMultiLangTokenizer",["WAFtsTokenizerPostLowercaseNormalizer","WAFtsTokenizerPreNFKDNormalizer"],(function(a,b,c,d,e,f,g){"use strict";var h={NFC_CHARACTER:/(?!(?:[0-9\xB2\xB3\xB9\xBC-\xBE\u0660-\u0669\u06F0-\u06F9\u07C0-\u07C9\u0966-\u096F\u09E6-\u09EF\u09F4-\u09F9\u0A66-\u0A6F\u0AE6-\u0AEF\u0B66-\u0B6F\u0B72-\u0B77\u0BE6-\u0BF2\u0C66-\u0C6F\u0C78-\u0C7E\u0CE6-\u0CEF\u0D58-\u0D5E\u0D66-\u0D78\u0DE6-\u0DEF\u0E50-\u0E59\u0ED0-\u0ED9\u0F20-\u0F33\u1040-\u1049\u1090-\u1099\u1369-\u137C\u16EE-\u16F0\u17E0-\u17E9\u17F0-\u17F9\u1810-\u1819\u1946-\u194F\u19D0-\u19DA\u1A80-\u1A89\u1A90-\u1A99\u1B50-\u1B59\u1BB0-\u1BB9\u1C40-\u1C49\u1C50-\u1C59\u2070\u2074-\u2079\u2080-\u2089\u2150-\u2182\u2185-\u2189\u2460-\u249B\u24EA-\u24FF\u2776-\u2793\u2CFD\u3007\u3021-\u3029\u3038-\u303A\u3192-\u3195\u3220-\u3229\u3248-\u324F\u3251-\u325F\u3280-\u3289\u32B1-\u32BF\uA620-\uA629\uA6E6-\uA6EF\uA830-\uA835\uA8D0-\uA8D9\uA900-\uA909\uA9D0-\uA9D9\uA9F0-\uA9F9\uAA50-\uAA59\uABF0-\uABF9\uFF10-\uFF19]|\uD800[\uDD07-\uDD33\uDD40-\uDD78\uDD8A\uDD8B\uDEE1-\uDEFB\uDF20-\uDF23\uDF41\uDF4A\uDFD1-\uDFD5]|\uD801[\uDCA0-\uDCA9]|\uD802[\uDC58-\uDC5F\uDC79-\uDC7F\uDCA7-\uDCAF\uDCFB-\uDCFF\uDD16-\uDD1B\uDDBC\uDDBD\uDDC0-\uDDCF\uDDD2-\uDDFF\uDE40-\uDE48\uDE7D\uDE7E\uDE9D-\uDE9F\uDEEB-\uDEEF\uDF58-\uDF5F\uDF78-\uDF7F\uDFA9-\uDFAF]|\uD803[\uDCFA-\uDCFF\uDD30-\uDD39\uDE60-\uDE7E\uDF1D-\uDF26\uDF51-\uDF54\uDFC5-\uDFCB]|\uD804[\uDC52-\uDC6F\uDCF0-\uDCF9\uDD36-\uDD3F\uDDD0-\uDDD9\uDDE1-\uDDF4\uDEF0-\uDEF9]|\uD805[\uDC50-\uDC59\uDCD0-\uDCD9\uDE50-\uDE59\uDEC0-\uDEC9\uDF30-\uDF3B]|\uD806[\uDCE0-\uDCF2\uDD50-\uDD59]|\uD807[\uDC50-\uDC6C\uDD50-\uDD59\uDDA0-\uDDA9\uDFC0-\uDFD4]|\uD809[\uDC00-\uDC6E]|\uD81A[\uDE60-\uDE69\uDF50-\uDF59\uDF5B-\uDF61]|\uD81B[\uDE80-\uDE96]|\uD834[\uDEE0-\uDEF3\uDF60-\uDF78]|\uD835[\uDFCE-\uDFFF]|\uD838[\uDD40-\uDD49\uDEF0-\uDEF9]|\uD83A[\uDCC7-\uDCCF\uDD50-\uDD59]|\uD83B[\uDC71-\uDCAB\uDCAD-\uDCAF\uDCB1-\uDCB4\uDD01-\uDD2D\uDD2F-\uDD3D]|\uD83C[\uDD00-\uDD0C]|\uD83E[\uDFF0-\uDFF9]))(?:[#\*0-9\xA9\xAE\u203C\u2049\u2122\u2139\u2194-\u2199\u21A9\u21AA\u231A\u231B\u2328\u23CF\u23E9-\u23F3\u23F8-\u23FA\u24C2\u25AA\u25AB\u25B6\u25C0\u25FB-\u25FE\u2600-\u2604\u260E\u2611\u2614\u2615\u2618\u261D\u2620\u2622\u2623\u2626\u262A\u262E\u262F\u2638-\u263A\u2640\u2642\u2648-\u2653\u265F\u2660\u2663\u2665\u2666\u2668\u267B\u267E\u267F\u2692-\u2697\u2699\u269B\u269C\u26A0\u26A1\u26A7\u26AA\u26AB\u26B0\u26B1\u26BD\u26BE\u26C4\u26C5\u26C8\u26CE\u26CF\u26D1\u26D3\u26D4\u26E9\u26EA\u26F0-\u26F5\u26F7-\u26FA\u26FD\u2702\u2705\u2708-\u270D\u270F\u2712\u2714\u2716\u271D\u2721\u2728\u2733\u2734\u2744\u2747\u274C\u274E\u2753-\u2755\u2757\u2763\u2764\u2795-\u2797\u27A1\u27B0\u27BF\u2934\u2935\u2B05-\u2B07\u2B1B\u2B1C\u2B50\u2B55\u2E80-\u2E99\u2E9B-\u2EF3\u2F00-\u2FD5\u3005\u3007\u3021-\u3029\u3030\u3038-\u303B\u303D\u3041-\u3096\u309D-\u309F\u30A1-\u30FA\u30FD-\u30FF\u31F0-\u31FF\u3297\u3299\u32D0-\u32FE\u3300-\u3357\u3400-\u4DBF\u4E00-\u9FFC\uA000-\uA48C\uA490-\uA4C6\uF900-\uFA6D\uFA70-\uFAD9\uFF66-\uFF6F\uFF71-\uFF9D]|\uD81B[\uDFF0\uDFF1]|\uD82C[\uDC00-\uDD1E\uDD50-\uDD52\uDD64-\uDD67]|\uD83C[\uDC04\uDCCF\uDD70\uDD71\uDD7E\uDD7F\uDD8E\uDD91-\uDD9A\uDDE6-\uDE02\uDE1A\uDE2F\uDE32-\uDE3A\uDE50\uDE51\uDF00-\uDF21\uDF24-\uDF93\uDF96\uDF97\uDF99-\uDF9B\uDF9E-\uDFF0\uDFF3-\uDFF5\uDFF7-\uDFFF]|\uD83D[\uDC00-\uDCFD\uDCFF-\uDD3D\uDD49-\uDD4E\uDD50-\uDD67\uDD6F\uDD70\uDD73-\uDD7A\uDD87\uDD8A-\uDD8D\uDD90\uDD95\uDD96\uDDA4\uDDA5\uDDA8\uDDB1\uDDB2\uDDBC\uDDC2-\uDDC4\uDDD1-\uDDD3\uDDDC-\uDDDE\uDDE1\uDDE3\uDDE8\uDDEF\uDDF3\uDDFA-\uDE4F\uDE80-\uDEC5\uDECB-\uDED2\uDED5-\uDED7\uDEE0-\uDEE5\uDEE9\uDEEB\uDEEC\uDEF0\uDEF3-\uDEFC\uDFE0-\uDFEB]|\uD83E[\uDD0C-\uDD3A\uDD3C-\uDD45\uDD47-\uDD78\uDD7A-\uDDCB\uDDCD-\uDDFF\uDE70-\uDE74\uDE78-\uDE7A\uDE80-\uDE86\uDE90-\uDEA8\uDEB0-\uDEB6\uDEC0-\uDEC2\uDED0-\uDED6]|[\uD840-\uD868\uD86A-\uD86C\uD86F-\uD872\uD874-\uD879\uD880-\uD883][\uDC00-\uDFFF]|\uD869[\uDC00-\uDEDD\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF34\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEA1\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A])/g,NFC_WORD:/((?!(?:[0-9\xB2\xB3\xB9\xBC-\xBE\u0660-\u0669\u06F0-\u06F9\u07C0-\u07C9\u0966-\u096F\u09E6-\u09EF\u09F4-\u09F9\u0A66-\u0A6F\u0AE6-\u0AEF\u0B66-\u0B6F\u0B72-\u0B77\u0BE6-\u0BF2\u0C66-\u0C6F\u0C78-\u0C7E\u0CE6-\u0CEF\u0D58-\u0D5E\u0D66-\u0D78\u0DE6-\u0DEF\u0E50-\u0E59\u0ED0-\u0ED9\u0F20-\u0F33\u1040-\u1049\u1090-\u1099\u1369-\u137C\u16EE-\u16F0\u17E0-\u17E9\u17F0-\u17F9\u1810-\u1819\u1946-\u194F\u19D0-\u19DA\u1A80-\u1A89\u1A90-\u1A99\u1B50-\u1B59\u1BB0-\u1BB9\u1C40-\u1C49\u1C50-\u1C59\u2070\u2074-\u2079\u2080-\u2089\u2150-\u2182\u2185-\u2189\u2460-\u249B\u24EA-\u24FF\u2776-\u2793\u2CFD\u3007\u3021-\u3029\u3038-\u303A\u3192-\u3195\u3220-\u3229\u3248-\u324F\u3251-\u325F\u3280-\u3289\u32B1-\u32BF\uA620-\uA629\uA6E6-\uA6EF\uA830-\uA835\uA8D0-\uA8D9\uA900-\uA909\uA9D0-\uA9D9\uA9F0-\uA9F9\uAA50-\uAA59\uABF0-\uABF9\uFF10-\uFF19]|\uD800[\uDD07-\uDD33\uDD40-\uDD78\uDD8A\uDD8B\uDEE1-\uDEFB\uDF20-\uDF23\uDF41\uDF4A\uDFD1-\uDFD5]|\uD801[\uDCA0-\uDCA9]|\uD802[\uDC58-\uDC5F\uDC79-\uDC7F\uDCA7-\uDCAF\uDCFB-\uDCFF\uDD16-\uDD1B\uDDBC\uDDBD\uDDC0-\uDDCF\uDDD2-\uDDFF\uDE40-\uDE48\uDE7D\uDE7E\uDE9D-\uDE9F\uDEEB-\uDEEF\uDF58-\uDF5F\uDF78-\uDF7F\uDFA9-\uDFAF]|\uD803[\uDCFA-\uDCFF\uDD30-\uDD39\uDE60-\uDE7E\uDF1D-\uDF26\uDF51-\uDF54\uDFC5-\uDFCB]|\uD804[\uDC52-\uDC6F\uDCF0-\uDCF9\uDD36-\uDD3F\uDDD0-\uDDD9\uDDE1-\uDDF4\uDEF0-\uDEF9]|\uD805[\uDC50-\uDC59\uDCD0-\uDCD9\uDE50-\uDE59\uDEC0-\uDEC9\uDF30-\uDF3B]|\uD806[\uDCE0-\uDCF2\uDD50-\uDD59]|\uD807[\uDC50-\uDC6C\uDD50-\uDD59\uDDA0-\uDDA9\uDFC0-\uDFD4]|\uD809[\uDC00-\uDC6E]|\uD81A[\uDE60-\uDE69\uDF50-\uDF59\uDF5B-\uDF61]|\uD81B[\uDE80-\uDE96]|\uD834[\uDEE0-\uDEF3\uDF60-\uDF78]|\uD835[\uDFCE-\uDFFF]|\uD838[\uDD40-\uDD49\uDEF0-\uDEF9]|\uD83A[\uDCC7-\uDCCF\uDD50-\uDD59]|\uD83B[\uDC71-\uDCAB\uDCAD-\uDCAF\uDCB1-\uDCB4\uDD01-\uDD2D\uDD2F-\uDD3D]|\uD83C[\uDD00-\uDD0C]|\uD83E[\uDFF0-\uDFF9]))[\u1100-\u11FF\u302E\u302F\u3131-\u318E\u3200-\u321E\u3260-\u327E\uA960-\uA97C\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uFFA0-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC])+|((?!(?:[0-9\xB2\xB3\xB9\xBC-\xBE\u0660-\u0669\u06F0-\u06F9\u07C0-\u07C9\u0966-\u096F\u09E6-\u09EF\u09F4-\u09F9\u0A66-\u0A6F\u0AE6-\u0AEF\u0B66-\u0B6F\u0B72-\u0B77\u0BE6-\u0BF2\u0C66-\u0C6F\u0C78-\u0C7E\u0CE6-\u0CEF\u0D58-\u0D5E\u0D66-\u0D78\u0DE6-\u0DEF\u0E50-\u0E59\u0ED0-\u0ED9\u0F20-\u0F33\u1040-\u1049\u1090-\u1099\u1369-\u137C\u16EE-\u16F0\u17E0-\u17E9\u17F0-\u17F9\u1810-\u1819\u1946-\u194F\u19D0-\u19DA\u1A80-\u1A89\u1A90-\u1A99\u1B50-\u1B59\u1BB0-\u1BB9\u1C40-\u1C49\u1C50-\u1C59\u2070\u2074-\u2079\u2080-\u2089\u2150-\u2182\u2185-\u2189\u2460-\u249B\u24EA-\u24FF\u2776-\u2793\u2CFD\u3007\u3021-\u3029\u3038-\u303A\u3192-\u3195\u3220-\u3229\u3248-\u324F\u3251-\u325F\u3280-\u3289\u32B1-\u32BF\uA620-\uA629\uA6E6-\uA6EF\uA830-\uA835\uA8D0-\uA8D9\uA900-\uA909\uA9D0-\uA9D9\uA9F0-\uA9F9\uAA50-\uAA59\uABF0-\uABF9\uFF10-\uFF19]|\uD800[\uDD07-\uDD33\uDD40-\uDD78\uDD8A\uDD8B\uDEE1-\uDEFB\uDF20-\uDF23\uDF41\uDF4A\uDFD1-\uDFD5]|\uD801[\uDCA0-\uDCA9]|\uD802[\uDC58-\uDC5F\uDC79-\uDC7F\uDCA7-\uDCAF\uDCFB-\uDCFF\uDD16-\uDD1B\uDDBC\uDDBD\uDDC0-\uDDCF\uDDD2-\uDDFF\uDE40-\uDE48\uDE7D\uDE7E\uDE9D-\uDE9F\uDEEB-\uDEEF\uDF58-\uDF5F\uDF78-\uDF7F\uDFA9-\uDFAF]|\uD803[\uDCFA-\uDCFF\uDD30-\uDD39\uDE60-\uDE7E\uDF1D-\uDF26\uDF51-\uDF54\uDFC5-\uDFCB]|\uD804[\uDC52-\uDC6F\uDCF0-\uDCF9\uDD36-\uDD3F\uDDD0-\uDDD9\uDDE1-\uDDF4\uDEF0-\uDEF9]|\uD805[\uDC50-\uDC59\uDCD0-\uDCD9\uDE50-\uDE59\uDEC0-\uDEC9\uDF30-\uDF3B]|\uD806[\uDCE0-\uDCF2\uDD50-\uDD59]|\uD807[\uDC50-\uDC6C\uDD50-\uDD59\uDDA0-\uDDA9\uDFC0-\uDFD4]|\uD809[\uDC00-\uDC6E]|\uD81A[\uDE60-\uDE69\uDF50-\uDF59\uDF5B-\uDF61]|\uD81B[\uDE80-\uDE96]|\uD834[\uDEE0-\uDEF3\uDF60-\uDF78]|\uD835[\uDFCE-\uDFFF]|\uD838[\uDD40-\uDD49\uDEF0-\uDEF9]|\uD83A[\uDCC7-\uDCCF\uDD50-\uDD59]|\uD83B[\uDC71-\uDCAB\uDCAD-\uDCAF\uDCB1-\uDCB4\uDD01-\uDD2D\uDD2F-\uDD3D]|\uD83C[\uDD00-\uDD0C]|\uD83E[\uDFF0-\uDFF9]))[\u0E01-\u0E3A\u0E40-\u0E5B])+|((?!(?:[0-9\xB2\xB3\xB9\xBC-\xBE\u0660-\u0669\u06F0-\u06F9\u07C0-\u07C9\u0966-\u096F\u09E6-\u09EF\u09F4-\u09F9\u0A66-\u0A6F\u0AE6-\u0AEF\u0B66-\u0B6F\u0B72-\u0B77\u0BE6-\u0BF2\u0C66-\u0C6F\u0C78-\u0C7E\u0CE6-\u0CEF\u0D58-\u0D5E\u0D66-\u0D78\u0DE6-\u0DEF\u0E50-\u0E59\u0ED0-\u0ED9\u0F20-\u0F33\u1040-\u1049\u1090-\u1099\u1369-\u137C\u16EE-\u16F0\u17E0-\u17E9\u17F0-\u17F9\u1810-\u1819\u1946-\u194F\u19D0-\u19DA\u1A80-\u1A89\u1A90-\u1A99\u1B50-\u1B59\u1BB0-\u1BB9\u1C40-\u1C49\u1C50-\u1C59\u2070\u2074-\u2079\u2080-\u2089\u2150-\u2182\u2185-\u2189\u2460-\u249B\u24EA-\u24FF\u2776-\u2793\u2CFD\u3007\u3021-\u3029\u3038-\u303A\u3192-\u3195\u3220-\u3229\u3248-\u324F\u3251-\u325F\u3280-\u3289\u32B1-\u32BF\uA620-\uA629\uA6E6-\uA6EF\uA830-\uA835\uA8D0-\uA8D9\uA900-\uA909\uA9D0-\uA9D9\uA9F0-\uA9F9\uAA50-\uAA59\uABF0-\uABF9\uFF10-\uFF19]|\uD800[\uDD07-\uDD33\uDD40-\uDD78\uDD8A\uDD8B\uDEE1-\uDEFB\uDF20-\uDF23\uDF41\uDF4A\uDFD1-\uDFD5]|\uD801[\uDCA0-\uDCA9]|\uD802[\uDC58-\uDC5F\uDC79-\uDC7F\uDCA7-\uDCAF\uDCFB-\uDCFF\uDD16-\uDD1B\uDDBC\uDDBD\uDDC0-\uDDCF\uDDD2-\uDDFF\uDE40-\uDE48\uDE7D\uDE7E\uDE9D-\uDE9F\uDEEB-\uDEEF\uDF58-\uDF5F\uDF78-\uDF7F\uDFA9-\uDFAF]|\uD803[\uDCFA-\uDCFF\uDD30-\uDD39\uDE60-\uDE7E\uDF1D-\uDF26\uDF51-\uDF54\uDFC5-\uDFCB]|\uD804[\uDC52-\uDC6F\uDCF0-\uDCF9\uDD36-\uDD3F\uDDD0-\uDDD9\uDDE1-\uDDF4\uDEF0-\uDEF9]|\uD805[\uDC50-\uDC59\uDCD0-\uDCD9\uDE50-\uDE59\uDEC0-\uDEC9\uDF30-\uDF3B]|\uD806[\uDCE0-\uDCF2\uDD50-\uDD59]|\uD807[\uDC50-\uDC6C\uDD50-\uDD59\uDDA0-\uDDA9\uDFC0-\uDFD4]|\uD809[\uDC00-\uDC6E]|\uD81A[\uDE60-\uDE69\uDF50-\uDF59\uDF5B-\uDF61]|\uD81B[\uDE80-\uDE96]|\uD834[\uDEE0-\uDEF3\uDF60-\uDF78]|\uD835[\uDFCE-\uDFFF]|\uD838[\uDD40-\uDD49\uDEF0-\uDEF9]|\uD83A[\uDCC7-\uDCCF\uDD50-\uDD59]|\uD83B[\uDC71-\uDCAB\uDCAD-\uDCAF\uDCB1-\uDCB4\uDD01-\uDD2D\uDD2F-\uDD3D]|\uD83C[\uDD00-\uDD0C]|\uD83E[\uDFF0-\uDFF9]))[\u0E81\u0E82\u0E84\u0E86-\u0E8A\u0E8C-\u0EA3\u0EA5\u0EA7-\u0EBD\u0EC0-\u0EC4\u0EC6\u0EC8-\u0ECD\u0ED0-\u0ED9\u0EDC-\u0EDF])+|((?!(?:[0-9\xB2\xB3\xB9\xBC-\xBE\u0660-\u0669\u06F0-\u06F9\u07C0-\u07C9\u0966-\u096F\u09E6-\u09EF\u09F4-\u09F9\u0A66-\u0A6F\u0AE6-\u0AEF\u0B66-\u0B6F\u0B72-\u0B77\u0BE6-\u0BF2\u0C66-\u0C6F\u0C78-\u0C7E\u0CE6-\u0CEF\u0D58-\u0D5E\u0D66-\u0D78\u0DE6-\u0DEF\u0E50-\u0E59\u0ED0-\u0ED9\u0F20-\u0F33\u1040-\u1049\u1090-\u1099\u1369-\u137C\u16EE-\u16F0\u17E0-\u17E9\u17F0-\u17F9\u1810-\u1819\u1946-\u194F\u19D0-\u19DA\u1A80-\u1A89\u1A90-\u1A99\u1B50-\u1B59\u1BB0-\u1BB9\u1C40-\u1C49\u1C50-\u1C59\u2070\u2074-\u2079\u2080-\u2089\u2150-\u2182\u2185-\u2189\u2460-\u249B\u24EA-\u24FF\u2776-\u2793\u2CFD\u3007\u3021-\u3029\u3038-\u303A\u3192-\u3195\u3220-\u3229\u3248-\u324F\u3251-\u325F\u3280-\u3289\u32B1-\u32BF\uA620-\uA629\uA6E6-\uA6EF\uA830-\uA835\uA8D0-\uA8D9\uA900-\uA909\uA9D0-\uA9D9\uA9F0-\uA9F9\uAA50-\uAA59\uABF0-\uABF9\uFF10-\uFF19]|\uD800[\uDD07-\uDD33\uDD40-\uDD78\uDD8A\uDD8B\uDEE1-\uDEFB\uDF20-\uDF23\uDF41\uDF4A\uDFD1-\uDFD5]|\uD801[\uDCA0-\uDCA9]|\uD802[\uDC58-\uDC5F\uDC79-\uDC7F\uDCA7-\uDCAF\uDCFB-\uDCFF\uDD16-\uDD1B\uDDBC\uDDBD\uDDC0-\uDDCF\uDDD2-\uDDFF\uDE40-\uDE48\uDE7D\uDE7E\uDE9D-\uDE9F\uDEEB-\uDEEF\uDF58-\uDF5F\uDF78-\uDF7F\uDFA9-\uDFAF]|\uD803[\uDCFA-\uDCFF\uDD30-\uDD39\uDE60-\uDE7E\uDF1D-\uDF26\uDF51-\uDF54\uDFC5-\uDFCB]|\uD804[\uDC52-\uDC6F\uDCF0-\uDCF9\uDD36-\uDD3F\uDDD0-\uDDD9\uDDE1-\uDDF4\uDEF0-\uDEF9]|\uD805[\uDC50-\uDC59\uDCD0-\uDCD9\uDE50-\uDE59\uDEC0-\uDEC9\uDF30-\uDF3B]|\uD806[\uDCE0-\uDCF2\uDD50-\uDD59]|\uD807[\uDC50-\uDC6C\uDD50-\uDD59\uDDA0-\uDDA9\uDFC0-\uDFD4]|\uD809[\uDC00-\uDC6E]|\uD81A[\uDE60-\uDE69\uDF50-\uDF59\uDF5B-\uDF61]|\uD81B[\uDE80-\uDE96]|\uD834[\uDEE0-\uDEF3\uDF60-\uDF78]|\uD835[\uDFCE-\uDFFF]|\uD838[\uDD40-\uDD49\uDEF0-\uDEF9]|\uD83A[\uDCC7-\uDCCF\uDD50-\uDD59]|\uD83B[\uDC71-\uDCAB\uDCAD-\uDCAF\uDCB1-\uDCB4\uDD01-\uDD2D\uDD2F-\uDD3D]|\uD83C[\uDD00-\uDD0C]|\uD83E[\uDFF0-\uDFF9]))[\u0F00-\u0F47\u0F49-\u0F6C\u0F71-\u0F97\u0F99-\u0FBC\u0FBE-\u0FCC\u0FCE-\u0FD4\u0FD9\u0FDA])+|((?!(?:[0-9\xB2\xB3\xB9\xBC-\xBE\u0660-\u0669\u06F0-\u06F9\u07C0-\u07C9\u0966-\u096F\u09E6-\u09EF\u09F4-\u09F9\u0A66-\u0A6F\u0AE6-\u0AEF\u0B66-\u0B6F\u0B72-\u0B77\u0BE6-\u0BF2\u0C66-\u0C6F\u0C78-\u0C7E\u0CE6-\u0CEF\u0D58-\u0D5E\u0D66-\u0D78\u0DE6-\u0DEF\u0E50-\u0E59\u0ED0-\u0ED9\u0F20-\u0F33\u1040-\u1049\u1090-\u1099\u1369-\u137C\u16EE-\u16F0\u17E0-\u17E9\u17F0-\u17F9\u1810-\u1819\u1946-\u194F\u19D0-\u19DA\u1A80-\u1A89\u1A90-\u1A99\u1B50-\u1B59\u1BB0-\u1BB9\u1C40-\u1C49\u1C50-\u1C59\u2070\u2074-\u2079\u2080-\u2089\u2150-\u2182\u2185-\u2189\u2460-\u249B\u24EA-\u24FF\u2776-\u2793\u2CFD\u3007\u3021-\u3029\u3038-\u303A\u3192-\u3195\u3220-\u3229\u3248-\u324F\u3251-\u325F\u3280-\u3289\u32B1-\u32BF\uA620-\uA629\uA6E6-\uA6EF\uA830-\uA835\uA8D0-\uA8D9\uA900-\uA909\uA9D0-\uA9D9\uA9F0-\uA9F9\uAA50-\uAA59\uABF0-\uABF9\uFF10-\uFF19]|\uD800[\uDD07-\uDD33\uDD40-\uDD78\uDD8A\uDD8B\uDEE1-\uDEFB\uDF20-\uDF23\uDF41\uDF4A\uDFD1-\uDFD5]|\uD801[\uDCA0-\uDCA9]|\uD802[\uDC58-\uDC5F\uDC79-\uDC7F\uDCA7-\uDCAF\uDCFB-\uDCFF\uDD16-\uDD1B\uDDBC\uDDBD\uDDC0-\uDDCF\uDDD2-\uDDFF\uDE40-\uDE48\uDE7D\uDE7E\uDE9D-\uDE9F\uDEEB-\uDEEF\uDF58-\uDF5F\uDF78-\uDF7F\uDFA9-\uDFAF]|\uD803[\uDCFA-\uDCFF\uDD30-\uDD39\uDE60-\uDE7E\uDF1D-\uDF26\uDF51-\uDF54\uDFC5-\uDFCB]|\uD804[\uDC52-\uDC6F\uDCF0-\uDCF9\uDD36-\uDD3F\uDDD0-\uDDD9\uDDE1-\uDDF4\uDEF0-\uDEF9]|\uD805[\uDC50-\uDC59\uDCD0-\uDCD9\uDE50-\uDE59\uDEC0-\uDEC9\uDF30-\uDF3B]|\uD806[\uDCE0-\uDCF2\uDD50-\uDD59]|\uD807[\uDC50-\uDC6C\uDD50-\uDD59\uDDA0-\uDDA9\uDFC0-\uDFD4]|\uD809[\uDC00-\uDC6E]|\uD81A[\uDE60-\uDE69\uDF50-\uDF59\uDF5B-\uDF61]|\uD81B[\uDE80-\uDE96]|\uD834[\uDEE0-\uDEF3\uDF60-\uDF78]|\uD835[\uDFCE-\uDFFF]|\uD838[\uDD40-\uDD49\uDEF0-\uDEF9]|\uD83A[\uDCC7-\uDCCF\uDD50-\uDD59]|\uD83B[\uDC71-\uDCAB\uDCAD-\uDCAF\uDCB1-\uDCB4\uDD01-\uDD2D\uDD2F-\uDD3D]|\uD83C[\uDD00-\uDD0C]|\uD83E[\uDFF0-\uDFF9]))[\u1000-\u109F\uA9E0-\uA9FE\uAA60-\uAA7F])+|((?!(?:[0-9\xB2\xB3\xB9\xBC-\xBE\u0660-\u0669\u06F0-\u06F9\u07C0-\u07C9\u0966-\u096F\u09E6-\u09EF\u09F4-\u09F9\u0A66-\u0A6F\u0AE6-\u0AEF\u0B66-\u0B6F\u0B72-\u0B77\u0BE6-\u0BF2\u0C66-\u0C6F\u0C78-\u0C7E\u0CE6-\u0CEF\u0D58-\u0D5E\u0D66-\u0D78\u0DE6-\u0DEF\u0E50-\u0E59\u0ED0-\u0ED9\u0F20-\u0F33\u1040-\u1049\u1090-\u1099\u1369-\u137C\u16EE-\u16F0\u17E0-\u17E9\u17F0-\u17F9\u1810-\u1819\u1946-\u194F\u19D0-\u19DA\u1A80-\u1A89\u1A90-\u1A99\u1B50-\u1B59\u1BB0-\u1BB9\u1C40-\u1C49\u1C50-\u1C59\u2070\u2074-\u2079\u2080-\u2089\u2150-\u2182\u2185-\u2189\u2460-\u249B\u24EA-\u24FF\u2776-\u2793\u2CFD\u3007\u3021-\u3029\u3038-\u303A\u3192-\u3195\u3220-\u3229\u3248-\u324F\u3251-\u325F\u3280-\u3289\u32B1-\u32BF\uA620-\uA629\uA6E6-\uA6EF\uA830-\uA835\uA8D0-\uA8D9\uA900-\uA909\uA9D0-\uA9D9\uA9F0-\uA9F9\uAA50-\uAA59\uABF0-\uABF9\uFF10-\uFF19]|\uD800[\uDD07-\uDD33\uDD40-\uDD78\uDD8A\uDD8B\uDEE1-\uDEFB\uDF20-\uDF23\uDF41\uDF4A\uDFD1-\uDFD5]|\uD801[\uDCA0-\uDCA9]|\uD802[\uDC58-\uDC5F\uDC79-\uDC7F\uDCA7-\uDCAF\uDCFB-\uDCFF\uDD16-\uDD1B\uDDBC\uDDBD\uDDC0-\uDDCF\uDDD2-\uDDFF\uDE40-\uDE48\uDE7D\uDE7E\uDE9D-\uDE9F\uDEEB-\uDEEF\uDF58-\uDF5F\uDF78-\uDF7F\uDFA9-\uDFAF]|\uD803[\uDCFA-\uDCFF\uDD30-\uDD39\uDE60-\uDE7E\uDF1D-\uDF26\uDF51-\uDF54\uDFC5-\uDFCB]|\uD804[\uDC52-\uDC6F\uDCF0-\uDCF9\uDD36-\uDD3F\uDDD0-\uDDD9\uDDE1-\uDDF4\uDEF0-\uDEF9]|\uD805[\uDC50-\uDC59\uDCD0-\uDCD9\uDE50-\uDE59\uDEC0-\uDEC9\uDF30-\uDF3B]|\uD806[\uDCE0-\uDCF2\uDD50-\uDD59]|\uD807[\uDC50-\uDC6C\uDD50-\uDD59\uDDA0-\uDDA9\uDFC0-\uDFD4]|\uD809[\uDC00-\uDC6E]|\uD81A[\uDE60-\uDE69\uDF50-\uDF59\uDF5B-\uDF61]|\uD81B[\uDE80-\uDE96]|\uD834[\uDEE0-\uDEF3\uDF60-\uDF78]|\uD835[\uDFCE-\uDFFF]|\uD838[\uDD40-\uDD49\uDEF0-\uDEF9]|\uD83A[\uDCC7-\uDCCF\uDD50-\uDD59]|\uD83B[\uDC71-\uDCAB\uDCAD-\uDCAF\uDCB1-\uDCB4\uDD01-\uDD2D\uDD2F-\uDD3D]|\uD83C[\uDD00-\uDD0C]|\uD83E[\uDFF0-\uDFF9]))[\u1780-\u17DD\u17E0-\u17E9\u17F0-\u17F9\u19E0-\u19FF])+|((?!(?:[0-9\xB2\xB3\xB9\xBC-\xBE\u0660-\u0669\u06F0-\u06F9\u07C0-\u07C9\u0966-\u096F\u09E6-\u09EF\u09F4-\u09F9\u0A66-\u0A6F\u0AE6-\u0AEF\u0B66-\u0B6F\u0B72-\u0B77\u0BE6-\u0BF2\u0C66-\u0C6F\u0C78-\u0C7E\u0CE6-\u0CEF\u0D58-\u0D5E\u0D66-\u0D78\u0DE6-\u0DEF\u0E50-\u0E59\u0ED0-\u0ED9\u0F20-\u0F33\u1040-\u1049\u1090-\u1099\u1369-\u137C\u16EE-\u16F0\u17E0-\u17E9\u17F0-\u17F9\u1810-\u1819\u1946-\u194F\u19D0-\u19DA\u1A80-\u1A89\u1A90-\u1A99\u1B50-\u1B59\u1BB0-\u1BB9\u1C40-\u1C49\u1C50-\u1C59\u2070\u2074-\u2079\u2080-\u2089\u2150-\u2182\u2185-\u2189\u2460-\u249B\u24EA-\u24FF\u2776-\u2793\u2CFD\u3007\u3021-\u3029\u3038-\u303A\u3192-\u3195\u3220-\u3229\u3248-\u324F\u3251-\u325F\u3280-\u3289\u32B1-\u32BF\uA620-\uA629\uA6E6-\uA6EF\uA830-\uA835\uA8D0-\uA8D9\uA900-\uA909\uA9D0-\uA9D9\uA9F0-\uA9F9\uAA50-\uAA59\uABF0-\uABF9\uFF10-\uFF19]|\uD800[\uDD07-\uDD33\uDD40-\uDD78\uDD8A\uDD8B\uDEE1-\uDEFB\uDF20-\uDF23\uDF41\uDF4A\uDFD1-\uDFD5]|\uD801[\uDCA0-\uDCA9]|\uD802[\uDC58-\uDC5F\uDC79-\uDC7F\uDCA7-\uDCAF\uDCFB-\uDCFF\uDD16-\uDD1B\uDDBC\uDDBD\uDDC0-\uDDCF\uDDD2-\uDDFF\uDE40-\uDE48\uDE7D\uDE7E\uDE9D-\uDE9F\uDEEB-\uDEEF\uDF58-\uDF5F\uDF78-\uDF7F\uDFA9-\uDFAF]|\uD803[\uDCFA-\uDCFF\uDD30-\uDD39\uDE60-\uDE7E\uDF1D-\uDF26\uDF51-\uDF54\uDFC5-\uDFCB]|\uD804[\uDC52-\uDC6F\uDCF0-\uDCF9\uDD36-\uDD3F\uDDD0-\uDDD9\uDDE1-\uDDF4\uDEF0-\uDEF9]|\uD805[\uDC50-\uDC59\uDCD0-\uDCD9\uDE50-\uDE59\uDEC0-\uDEC9\uDF30-\uDF3B]|\uD806[\uDCE0-\uDCF2\uDD50-\uDD59]|\uD807[\uDC50-\uDC6C\uDD50-\uDD59\uDDA0-\uDDA9\uDFC0-\uDFD4]|\uD809[\uDC00-\uDC6E]|\uD81A[\uDE60-\uDE69\uDF50-\uDF59\uDF5B-\uDF61]|\uD81B[\uDE80-\uDE96]|\uD834[\uDEE0-\uDEF3\uDF60-\uDF78]|\uD835[\uDFCE-\uDFFF]|\uD838[\uDD40-\uDD49\uDEF0-\uDEF9]|\uD83A[\uDCC7-\uDCCF\uDD50-\uDD59]|\uD83B[\uDC71-\uDCAB\uDCAD-\uDCAF\uDCB1-\uDCB4\uDD01-\uDD2D\uDD2F-\uDD3D]|\uD83C[\uDD00-\uDD0C]|\uD83E[\uDFF0-\uDFF9]))[\u02EA\u02EB\u3105-\u312F\u31A0-\u31BF])+/g},i=/(?![\u0902\u094D])(?:[\^`\xA8\xAF\xB4\xB7\xB8\u02B0-\u034E\u0350-\u0357\u035D-\u0362\u0374\u0375\u037A\u0384\u0385\u0483-\u0487\u0559\u0591-\u05A1\u05A3-\u05BD\u05BF\u05C1\u05C2\u05C4\u064B-\u0652\u0657\u0658\u06DF\u06E0\u06E5\u06E6\u06EA-\u06EC\u0730-\u074A\u07A6-\u07B0\u07EB-\u07F5\u0818\u0819\u08E3-\u08FE\u093C\u094D\u0951-\u0954\u0971\u09BC\u09CD\u0A3C\u0A4D\u0ABC\u0ACD\u0AFD-\u0AFF\u0B3C\u0B4D\u0B55\u0BCD\u0C4D\u0CBC\u0CCD\u0D3B\u0D3C\u0D4D\u0DCA\u0E47-\u0E4C\u0E4E\u0EBA\u0EC8-\u0ECC\u0F18\u0F19\u0F35\u0F37\u0F39\u0F3E\u0F3F\u0F82-\u0F84\u0F86\u0F87\u0FC6\u1037\u1039\u103A\u1063\u1064\u1069-\u106D\u1087-\u108D\u108F\u109A\u109B\u135D-\u135F\u17C9-\u17D3\u17DD\u1939-\u193B\u1A75-\u1A7C\u1A7F\u1AB0-\u1ABD\u1B34\u1B44\u1B6B-\u1B73\u1BAA\u1BAB\u1C36\u1C37\u1C78-\u1C7D\u1CD0-\u1CE8\u1CED\u1CF4\u1CF7-\u1CF9\u1D2C-\u1D6A\u1DC4-\u1DCF\u1DF5-\u1DF9\u1DFD-\u1DFF\u1FBD\u1FBF-\u1FC1\u1FCD-\u1FCF\u1FDD-\u1FDF\u1FED-\u1FEF\u1FFD\u1FFE\u2CEF-\u2CF1\u2E2F\u302A-\u302F\u3099-\u309C\u30FC\uA66F\uA67C\uA67D\uA67F\uA69C\uA69D\uA6F0\uA6F1\uA700-\uA721\uA788-\uA78A\uA7F8\uA7F9\uA8C4\uA8E0-\uA8F1\uA92B-\uA92E\uA953\uA9B3\uA9C0\uA9E5\uAA7B-\uAA7D\uAABF-\uAAC2\uAAF6\uAB5B-\uAB5F\uAB69-\uAB6B\uABEC\uABED\uFB1E\uFE20-\uFE2F\uFF3E\uFF40\uFF70\uFF9E\uFF9F\uFFE3]|\uD800\uDEE0|\uD802[\uDEE5\uDEE6]|\uD803[\uDD22-\uDD27\uDF46-\uDF50]|\uD804[\uDCB9\uDCBA\uDD33\uDD34\uDD73\uDDC0\uDDCA-\uDDCC\uDE35\uDE36\uDEE9\uDEEA\uDF3C\uDF4D\uDF66-\uDF6C\uDF70-\uDF74]|\uD805[\uDC42\uDC46\uDCC2\uDCC3\uDDBF\uDDC0\uDE3F\uDEB6\uDEB7\uDF2B]|\uD806[\uDC39\uDC3A\uDD3D\uDD3E\uDD43\uDDE0\uDE34\uDE47\uDE99]|\uD807[\uDC3F\uDD42\uDD44\uDD45\uDD97]|\uD81A[\uDEF0-\uDEF4\uDF30-\uDF36]|\uD81B[\uDF8F-\uDF9F\uDFF0\uDFF1]|\uD834[\uDD67-\uDD69\uDD6D-\uDD72\uDD7B-\uDD82\uDD85-\uDD8B\uDDAA-\uDDAD]|\uD838[\uDD30-\uDD36\uDEEC-\uDEEF]|\uD83A[\uDCD0-\uDCD6\uDD44-\uDD46\uDD48-\uDD4A])+/g,j=/(?:[!-#%-\/:-@\[-`\{-~\xA1\xA7\xA8\xAB\xAC\xAF\xB1\xB4\xB6-\xB8\xBB\xBF\xD7\xF7\u02C2-\u02C5\u02D2-\u02DF\u02E5-\u02EB\u02ED\u02EF-\u02FF\u0375\u037E\u0384\u0385\u0387\u03F6\u055A-\u055F\u0589\u058A\u05BE\u05C0\u05C3\u05C6\u05F3\u05F4\u0606-\u060A\u060C\u060D\u061B\u061E\u061F\u066A-\u066D\u06D4\u0700-\u070D\u07F7-\u07F9\u0830-\u083E\u085E\u0964\u0965\u0970\u09FD\u0A76\u0AF0\u0C77\u0C84\u0DF4\u0E4F\u0E5A\u0E5B\u0F04-\u0F12\u0F14\u0F3A-\u0F3D\u0F85\u0FD0-\u0FD4\u0FD9\u0FDA\u104A-\u104F\u10FB\u1360-\u1368\u1400\u166E\u169B\u169C\u16EB-\u16ED\u1735\u1736\u17D4-\u17D6\u17D8-\u17DA\u1800-\u180A\u1944\u1945\u1A1E\u1A1F\u1AA0-\u1AA6\u1AA8-\u1AAD\u1B5A-\u1B60\u1BFC-\u1BFF\u1C3B-\u1C3F\u1C7E\u1C7F\u1CC0-\u1CC7\u1CD3\u1FBD\u1FBF-\u1FC1\u1FCD-\u1FCF\u1FDD-\u1FDF\u1FED-\u1FEF\u1FFD\u1FFE\u200D\u2010-\u2027\u2030-\u205E\u207A-\u207E\u208A-\u208E\u2118\u2140-\u2144\u214B\u2190-\u2194\u219A\u219B\u21A0\u21A3\u21A6\u21AE\u21CE\u21CF\u21D2\u21D4\u21F4-\u22FF\u2308-\u230B\u2320\u2321\u2329\u232A\u237C\u239B-\u23B3\u23DC-\u23E1\u25B7\u25C1\u25F8-\u25FF\u266F\u2768-\u2775\u27C0-\u27FF\u2900-\u2AFF\u2B30-\u2B44\u2B47-\u2B4C\u2CF9-\u2CFC\u2CFE\u2CFF\u2D70\u2E00-\u2E2E\u2E30-\u2E4F\u2E52\u3001-\u3003\u3008-\u3011\u3014-\u301F\u3030\u303D\u309B\u309C\u30A0\u30FB\uA4FE\uA4FF\uA60D-\uA60F\uA673\uA67E\uA6F2-\uA6F7\uA700-\uA716\uA720\uA721\uA789\uA78A\uA874-\uA877\uA8CE\uA8CF\uA8F8-\uA8FA\uA8FC\uA92E\uA92F\uA95F\uA9C1-\uA9CD\uA9DE\uA9DF\uAA5C-\uAA5F\uAADE\uAADF\uAAF0\uAAF1\uAB5B\uAB6A\uAB6B\uABEB\uFB29\uFBB2-\uFBC1\uFD3E\uFD3F\uFE10-\uFE19\uFE30-\uFE52\uFE54-\uFE66\uFE68\uFE6A\uFE6B\uFF01-\uFF03\uFF05-\uFF0F\uFF1A-\uFF20\uFF3B-\uFF40\uFF5B-\uFF65\uFFE2\uFFE3\uFFE9-\uFFEC]|\uD800[\uDD00-\uDD02\uDF9F\uDFD0]|\uD801\uDD6F|\uD802[\uDC57\uDD1F\uDD3F\uDE50-\uDE58\uDE7F\uDEF0-\uDEF6\uDF39-\uDF3F\uDF99-\uDF9C]|\uD803[\uDEAD\uDF55-\uDF59]|\uD804[\uDC47-\uDC4D\uDCBB\uDCBC\uDCBE-\uDCC1\uDD40-\uDD43\uDD74\uDD75\uDDC5-\uDDC8\uDDCD\uDDDB\uDDDD-\uDDDF\uDE38-\uDE3D\uDEA9]|\uD805[\uDC4B-\uDC4F\uDC5A\uDC5B\uDC5D\uDCC6\uDDC1-\uDDD7\uDE41-\uDE43\uDE60-\uDE6C\uDF3C-\uDF3E]|\uD806[\uDC3B\uDD44-\uDD46\uDDE2\uDE3F-\uDE46\uDE9A-\uDE9C\uDE9E-\uDEA2]|\uD807[\uDC41-\uDC45\uDC70\uDC71\uDEF7\uDEF8\uDFFF]|\uD809[\uDC70-\uDC74]|\uD81A[\uDE6E\uDE6F\uDEF5\uDF37-\uDF3B\uDF44]|\uD81B[\uDE97-\uDE9A\uDFE2]|\uD82F\uDC9F|\uD835[\uDEC1\uDEDB\uDEFB\uDF15\uDF35\uDF4F\uDF6F\uDF89\uDFA9\uDFC3]|\uD836[\uDE87-\uDE8B]|\uD83A[\uDD5E\uDD5F]|\uD83B[\uDEF0\uDEF1]|\uD83C[\uDFFB-\uDFFF])/g,k=/(^|(?:[\t\n\r -#%-\*,-\/:;\?@\[-\]_\{\}\xA0\xA1\xA7\xAB\xB6\xB7\xBB\xBF\u037E\u0387\u055A-\u055F\u0589\u058A\u05BE\u05C0\u05C3\u05C6\u05F3\u05F4\u0609\u060A\u060C\u060D\u061B\u061E\u061F\u066A-\u066D\u06D4\u0700-\u070D\u07F7-\u07F9\u0830-\u083E\u085E\u0964\u0965\u0970\u09FD\u0A76\u0AF0\u0C77\u0C84\u0DF4\u0E4F\u0E5A\u0E5B\u0F04-\u0F12\u0F14\u0F3A-\u0F3D\u0F85\u0FD0-\u0FD4\u0FD9\u0FDA\u104A-\u104F\u10FB\u1360-\u1368\u1400\u166E\u1680\u169B\u169C\u16EB-\u16ED\u1735\u1736\u17D4-\u17D6\u17D8-\u17DA\u1800-\u180A\u1944\u1945\u1A1E\u1A1F\u1AA0-\u1AA6\u1AA8-\u1AAD\u1B5A-\u1B60\u1BFC-\u1BFF\u1C3B-\u1C3F\u1C7E\u1C7F\u1CC0-\u1CC7\u1CD3\u2000-\u200A\u2010-\u2029\u202F-\u2043\u2045-\u2051\u2053-\u205F\u207D\u207E\u208D\u208E\u2308-\u230B\u2329\u232A\u2768-\u2775\u27C5\u27C6\u27E6-\u27EF\u2983-\u2998\u29D8-\u29DB\u29FC\u29FD\u2CF9-\u2CFC\u2CFE\u2CFF\u2D70\u2E00-\u2E2E\u2E30-\u2E4F\u2E52\u3000-\u3003\u3008-\u3011\u3014-\u301F\u3030\u303D\u30A0\u30FB\uA4FE\uA4FF\uA60D-\uA60F\uA673\uA67E\uA6F2-\uA6F7\uA874-\uA877\uA8CE\uA8CF\uA8F8-\uA8FA\uA8FC\uA92E\uA92F\uA95F\uA9C1-\uA9CD\uA9DE\uA9DF\uAA5C-\uAA5F\uAADE\uAADF\uAAF0\uAAF1\uABEB\uFD3E\uFD3F\uFE10-\uFE19\uFE30-\uFE52\uFE54-\uFE61\uFE63\uFE68\uFE6A\uFE6B\uFF01-\uFF03\uFF05-\uFF0A\uFF0C-\uFF0F\uFF1A\uFF1B\uFF1F\uFF20\uFF3B-\uFF3D\uFF3F\uFF5B\uFF5D\uFF5F-\uFF65]|\uD800[\uDD00-\uDD02\uDF9F\uDFD0]|\uD801\uDD6F|\uD802[\uDC57\uDD1F\uDD3F\uDE50-\uDE58\uDE7F\uDEF0-\uDEF6\uDF39-\uDF3F\uDF99-\uDF9C]|\uD803[\uDEAD\uDF55-\uDF59]|\uD804[\uDC47-\uDC4D\uDCBB\uDCBC\uDCBE-\uDCC1\uDD40-\uDD43\uDD74\uDD75\uDDC5-\uDDC8\uDDCD\uDDDB\uDDDD-\uDDDF\uDE38-\uDE3D\uDEA9]|\uD805[\uDC4B-\uDC4F\uDC5A\uDC5B\uDC5D\uDCC6\uDDC1-\uDDD7\uDE41-\uDE43\uDE60-\uDE6C\uDF3C-\uDF3E]|\uD806[\uDC3B\uDD44-\uDD46\uDDE2\uDE3F-\uDE46\uDE9A-\uDE9C\uDE9E-\uDEA2]|\uD807[\uDC41-\uDC45\uDC70\uDC71\uDEF7\uDEF8\uDFFF]|\uD809[\uDC70-\uDC74]|\uD81A[\uDE6E\uDE6F\uDEF5\uDF37-\uDF3B\uDF44]|\uD81B[\uDE97-\uDE9A\uDFE2]|\uD82F\uDC9F|\uD836[\uDE87-\uDE8B]|\uD83A[\uDD5E\uDD5F]))((?:[0-9A-Z\^`-z\xA8\xAA\xAF\xB2-\xB5\xB7-\xBA\xBC-\xBE\xC0-\xD6\xD8-\xF6\xF8-\u034E\u0350-\u0357\u035D-\u0362\u0370-\u0377\u037A-\u037D\u037F\u0384-\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u0483-\u0487\u048A-\u052F\u0531-\u0556\u0559\u0560-\u0588\u0591-\u05A1\u05A3-\u05BD\u05BF\u05C1\u05C2\u05C4\u05D0-\u05EA\u05EF-\u05F2\u0620-\u0652\u0657\u0658\u0660-\u0669\u066E\u066F\u0671-\u06D3\u06D5\u06DF\u06E0\u06E5\u06E6\u06EA-\u06EC\u06EE-\u06FC\u06FF\u0710\u0712-\u074A\u074D-\u07B1\u07C0-\u07F5\u07FA\u0800-\u0815\u0818-\u081A\u0824\u0828\u0840-\u0858\u0860-\u086A\u08A0-\u08B4\u08B6-\u08C7\u08E3-\u08FE\u0904-\u0939\u093C\u093D\u094D\u0950-\u0954\u0958-\u0961\u0966-\u096F\u0971-\u0980\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BC\u09BD\u09CD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09E6-\u09F1\u09F4-\u09F9\u09FC\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A3C\u0A4D\u0A59-\u0A5C\u0A5E\u0A66-\u0A6F\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABC\u0ABD\u0ACD\u0AD0\u0AE0\u0AE1\u0AE6-\u0AEF\u0AF9\u0AFD-\u0AFF\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3C\u0B3D\u0B4D\u0B55\u0B5C\u0B5D\u0B5F-\u0B61\u0B66-\u0B6F\u0B71-\u0B77\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BCD\u0BD0\u0BE6-\u0BF2\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D\u0C4D\u0C58-\u0C5A\u0C60\u0C61\u0C66-\u0C6F\u0C78-\u0C7E\u0C80\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBC\u0CBD\u0CCD\u0CDE\u0CE0\u0CE1\u0CE6-\u0CEF\u0CF1\u0CF2\u0D04-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3D\u0D4D\u0D4E\u0D54-\u0D56\u0D58-\u0D61\u0D66-\u0D78\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0DCA\u0DE6-\u0DEF\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E4C\u0E4E\u0E50-\u0E59\u0E81\u0E82\u0E84\u0E86-\u0E8A\u0E8C-\u0EA3\u0EA5\u0EA7-\u0EB0\u0EB2\u0EB3\u0EBA\u0EBD\u0EC0-\u0EC4\u0EC6\u0EC8-\u0ECC\u0ED0-\u0ED9\u0EDC-\u0EDF\u0F00\u0F18\u0F19\u0F20-\u0F33\u0F35\u0F37\u0F39\u0F3E-\u0F47\u0F49-\u0F6C\u0F82-\u0F84\u0F86-\u0F8C\u0FC6\u1000-\u102A\u1037\u1039\u103A\u103F-\u1049\u1050-\u1055\u105A-\u105D\u1061\u1063-\u1066\u1069-\u1070\u1075-\u1081\u1087-\u109B\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u135D-\u135F\u1369-\u137C\u1380-\u138F\u13A0-\u13F5\u13F8-\u13FD\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16EE-\u16F8\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17C9-\u17D3\u17D7\u17DC\u17DD\u17E0-\u17E9\u17F0-\u17F9\u1810-\u1819\u1820-\u1878\u1880-\u1884\u1887-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191E\u1939-\u193B\u1946-\u196D\u1970-\u1974\u1980-\u19AB\u19B0-\u19C9\u19D0-\u19DA\u1A00-\u1A16\u1A20-\u1A54\u1A75-\u1A7C\u1A7F-\u1A89\u1A90-\u1A99\u1AA7\u1AB0-\u1ABD\u1B05-\u1B34\u1B44-\u1B4B\u1B50-\u1B59\u1B6B-\u1B73\u1B83-\u1BA0\u1BAA\u1BAB\u1BAE-\u1BE5\u1C00-\u1C23\u1C36\u1C37\u1C40-\u1C49\u1C4D-\u1C7D\u1C80-\u1C88\u1C90-\u1CBA\u1CBD-\u1CBF\u1CD0-\u1CFA\u1D00-\u1DBF\u1DC4-\u1DCF\u1DF5-\u1DF9\u1DFD-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FC4\u1FC6-\u1FD3\u1FD6-\u1FDB\u1FDD-\u1FEF\u1FF2-\u1FF4\u1FF6-\u1FFE\u2070\u2071\u2074-\u2079\u207F-\u2089\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2150-\u2189\u2460-\u249B\u24EA-\u24FF\u2776-\u2793\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CF3\u2CFD\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2E2F\u3005-\u3007\u3021-\u302F\u3031-\u3035\u3038-\u303C\u3041-\u3096\u3099-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312F\u3131-\u318E\u3192-\u3195\u31A0-\u31BF\u31F0-\u31FF\u3220-\u3229\u3248-\u324F\u3251-\u325F\u3280-\u3289\u32B1-\u32BF\u3400-\u4DBF\u4E00-\u9FFC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA62B\uA640-\uA66F\uA67C\uA67D\uA67F-\uA69D\uA6A0-\uA6F1\uA700-\uA7BF\uA7C2-\uA7CA\uA7F5-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA830-\uA835\uA840-\uA873\uA882-\uA8B3\uA8C4\uA8D0-\uA8D9\uA8E0-\uA8F7\uA8FB\uA8FD\uA8FE\uA900-\uA925\uA92B-\uA92E\uA930-\uA946\uA953\uA960-\uA97C\uA984-\uA9B3\uA9C0\uA9CF-\uA9D9\uA9E0-\uA9FE\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA50-\uAA59\uAA60-\uAA76\uAA7A-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAABF-\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAAF6\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB6B\uAB70-\uABE2\uABEC\uABED\uABF0-\uABF9\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE20-\uFE2F\uFE70-\uFE74\uFE76-\uFEFC\uFF10-\uFF19\uFF21-\uFF3A\uFF3E\uFF40-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC\uFFE3]|\uD800[\uDC00-\uDC0B\uDC0D-\uDC26\uDC28-\uDC3A\uDC3C\uDC3D\uDC3F-\uDC4D\uDC50-\uDC5D\uDC80-\uDCFA\uDD07-\uDD33\uDD40-\uDD78\uDD8A\uDD8B\uDE80-\uDE9C\uDEA0-\uDED0\uDEE0-\uDEFB\uDF00-\uDF23\uDF2D-\uDF4A\uDF50-\uDF75\uDF80-\uDF9D\uDFA0-\uDFC3\uDFC8-\uDFCF\uDFD1-\uDFD5]|\uD801[\uDC00-\uDC9D\uDCA0-\uDCA9\uDCB0-\uDCD3\uDCD8-\uDCFB\uDD00-\uDD27\uDD30-\uDD63\uDE00-\uDF36\uDF40-\uDF55\uDF60-\uDF67]|\uD802[\uDC00-\uDC05\uDC08\uDC0A-\uDC35\uDC37\uDC38\uDC3C\uDC3F-\uDC55\uDC58-\uDC76\uDC79-\uDC9E\uDCA7-\uDCAF\uDCE0-\uDCF2\uDCF4\uDCF5\uDCFB-\uDD1B\uDD20-\uDD39\uDD80-\uDDB7\uDDBC-\uDDCF\uDDD2-\uDE00\uDE10-\uDE13\uDE15-\uDE17\uDE19-\uDE35\uDE40-\uDE48\uDE60-\uDE7E\uDE80-\uDE9F\uDEC0-\uDEC7\uDEC9-\uDEE6\uDEEB-\uDEEF\uDF00-\uDF35\uDF40-\uDF55\uDF58-\uDF72\uDF78-\uDF91\uDFA9-\uDFAF]|\uD803[\uDC00-\uDC48\uDC80-\uDCB2\uDCC0-\uDCF2\uDCFA-\uDD27\uDD30-\uDD39\uDE60-\uDE7E\uDE80-\uDEA9\uDEB0\uDEB1\uDF00-\uDF27\uDF30-\uDF54\uDFB0-\uDFCB\uDFE0-\uDFF6]|\uD804[\uDC03-\uDC37\uDC52-\uDC6F\uDC83-\uDCAF\uDCB9\uDCBA\uDCD0-\uDCE8\uDCF0-\uDCF9\uDD03-\uDD26\uDD33\uDD34\uDD36-\uDD3F\uDD44\uDD47\uDD50-\uDD73\uDD76\uDD83-\uDDB2\uDDC0-\uDDC4\uDDCA-\uDDCC\uDDD0-\uDDDA\uDDDC\uDDE1-\uDDF4\uDE00-\uDE11\uDE13-\uDE2B\uDE35\uDE36\uDE80-\uDE86\uDE88\uDE8A-\uDE8D\uDE8F-\uDE9D\uDE9F-\uDEA8\uDEB0-\uDEDE\uDEE9\uDEEA\uDEF0-\uDEF9\uDF05-\uDF0C\uDF0F\uDF10\uDF13-\uDF28\uDF2A-\uDF30\uDF32\uDF33\uDF35-\uDF39\uDF3C\uDF3D\uDF4D\uDF50\uDF5D-\uDF61\uDF66-\uDF6C\uDF70-\uDF74]|\uD805[\uDC00-\uDC34\uDC42\uDC46-\uDC4A\uDC50-\uDC59\uDC5F-\uDC61\uDC80-\uDCAF\uDCC2-\uDCC5\uDCC7\uDCD0-\uDCD9\uDD80-\uDDAE\uDDBF\uDDC0\uDDD8-\uDDDB\uDE00-\uDE2F\uDE3F\uDE44\uDE50-\uDE59\uDE80-\uDEAA\uDEB6-\uDEB8\uDEC0-\uDEC9\uDF00-\uDF1A\uDF2B\uDF30-\uDF3B]|\uD806[\uDC00-\uDC2B\uDC39\uDC3A\uDCA0-\uDCF2\uDCFF-\uDD06\uDD09\uDD0C-\uDD13\uDD15\uDD16\uDD18-\uDD2F\uDD3D-\uDD3F\uDD41\uDD43\uDD50-\uDD59\uDDA0-\uDDA7\uDDAA-\uDDD0\uDDE0\uDDE1\uDDE3\uDE00\uDE0B-\uDE32\uDE34\uDE3A\uDE47\uDE50\uDE5C-\uDE89\uDE99\uDE9D\uDEC0-\uDEF8]|\uD807[\uDC00-\uDC08\uDC0A-\uDC2E\uDC3F\uDC40\uDC50-\uDC6C\uDC72-\uDC8F\uDD00-\uDD06\uDD08\uDD09\uDD0B-\uDD30\uDD42\uDD44-\uDD46\uDD50-\uDD59\uDD60-\uDD65\uDD67\uDD68\uDD6A-\uDD89\uDD97\uDD98\uDDA0-\uDDA9\uDEE0-\uDEF2\uDFB0\uDFC0-\uDFD4]|\uD808[\uDC00-\uDF99]|\uD809[\uDC00-\uDC6E\uDC80-\uDD43]|[\uD80C\uD81C-\uD820\uD822\uD840-\uD868\uD86A-\uD86C\uD86F-\uD872\uD874-\uD879\uD880-\uD883][\uDC00-\uDFFF]|\uD80D[\uDC00-\uDC2E]|\uD811[\uDC00-\uDE46]|\uD81A[\uDC00-\uDE38\uDE40-\uDE5E\uDE60-\uDE69\uDED0-\uDEED\uDEF0-\uDEF4\uDF00-\uDF36\uDF40-\uDF43\uDF50-\uDF59\uDF5B-\uDF61\uDF63-\uDF77\uDF7D-\uDF8F]|\uD81B[\uDE40-\uDE96\uDF00-\uDF4A\uDF50\uDF8F-\uDF9F\uDFE0\uDFE1\uDFE3\uDFF0\uDFF1]|\uD821[\uDC00-\uDFF7]|\uD823[\uDC00-\uDCD5\uDD00-\uDD08]|\uD82C[\uDC00-\uDD1E\uDD50-\uDD52\uDD64-\uDD67\uDD70-\uDEFB]|\uD82F[\uDC00-\uDC6A\uDC70-\uDC7C\uDC80-\uDC88\uDC90-\uDC99]|\uD834[\uDD67-\uDD69\uDD6D-\uDD72\uDD7B-\uDD82\uDD85-\uDD8B\uDDAA-\uDDAD\uDEE0-\uDEF3\uDF60-\uDF78]|\uD835[\uDC00-\uDC54\uDC56-\uDC9C\uDC9E\uDC9F\uDCA2\uDCA5\uDCA6\uDCA9-\uDCAC\uDCAE-\uDCB9\uDCBB\uDCBD-\uDCC3\uDCC5-\uDD05\uDD07-\uDD0A\uDD0D-\uDD14\uDD16-\uDD1C\uDD1E-\uDD39\uDD3B-\uDD3E\uDD40-\uDD44\uDD46\uDD4A-\uDD50\uDD52-\uDEA5\uDEA8-\uDEC0\uDEC2-\uDEDA\uDEDC-\uDEFA\uDEFC-\uDF14\uDF16-\uDF34\uDF36-\uDF4E\uDF50-\uDF6E\uDF70-\uDF88\uDF8A-\uDFA8\uDFAA-\uDFC2\uDFC4-\uDFCB\uDFCE-\uDFFF]|\uD838[\uDD00-\uDD2C\uDD30-\uDD3D\uDD40-\uDD49\uDD4E\uDEC0-\uDEF9]|\uD83A[\uDC00-\uDCC4\uDCC7-\uDCD6\uDD00-\uDD46\uDD48-\uDD4B\uDD50-\uDD59]|\uD83B[\uDC71-\uDCAB\uDCAD-\uDCAF\uDCB1-\uDCB4\uDD01-\uDD2D\uDD2F-\uDD3D\uDE00-\uDE03\uDE05-\uDE1F\uDE21\uDE22\uDE24\uDE27\uDE29-\uDE32\uDE34-\uDE37\uDE39\uDE3B\uDE42\uDE47\uDE49\uDE4B\uDE4D-\uDE4F\uDE51\uDE52\uDE54\uDE57\uDE59\uDE5B\uDE5D\uDE5F\uDE61\uDE62\uDE64\uDE67-\uDE6A\uDE6C-\uDE72\uDE74-\uDE77\uDE79-\uDE7C\uDE7E\uDE80-\uDE89\uDE8B-\uDE9B\uDEA1-\uDEA3\uDEA5-\uDEA9\uDEAB-\uDEBB]|\uD83C[\uDD00-\uDD0C]|\uD83E[\uDFF0-\uDFF9]|\uD869[\uDC00-\uDEDD\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF34\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEA1\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A])+)[\"\'\xAB\xBB\u2018-\u201F\u2039\u203A\u2E42\u300C-\u300F\u301D-\u301F\uFE41-\uFE44\uFF02\uFF07\uFF62\uFF63]((?:[0-9A-Z\^`-z\xA8\xAA\xAF\xB2-\xB5\xB7-\xBA\xBC-\xBE\xC0-\xD6\xD8-\xF6\xF8-\u034E\u0350-\u0357\u035D-\u0362\u0370-\u0377\u037A-\u037D\u037F\u0384-\u0386\u0388-\u038A\u038C\u038E-\u03A1\u03A3-\u03F5\u03F7-\u0481\u0483-\u0487\u048A-\u052F\u0531-\u0556\u0559\u0560-\u0588\u0591-\u05A1\u05A3-\u05BD\u05BF\u05C1\u05C2\u05C4\u05D0-\u05EA\u05EF-\u05F2\u0620-\u0652\u0657\u0658\u0660-\u0669\u066E\u066F\u0671-\u06D3\u06D5\u06DF\u06E0\u06E5\u06E6\u06EA-\u06EC\u06EE-\u06FC\u06FF\u0710\u0712-\u074A\u074D-\u07B1\u07C0-\u07F5\u07FA\u0800-\u0815\u0818-\u081A\u0824\u0828\u0840-\u0858\u0860-\u086A\u08A0-\u08B4\u08B6-\u08C7\u08E3-\u08FE\u0904-\u0939\u093C\u093D\u094D\u0950-\u0954\u0958-\u0961\u0966-\u096F\u0971-\u0980\u0985-\u098C\u098F\u0990\u0993-\u09A8\u09AA-\u09B0\u09B2\u09B6-\u09B9\u09BC\u09BD\u09CD\u09CE\u09DC\u09DD\u09DF-\u09E1\u09E6-\u09F1\u09F4-\u09F9\u09FC\u0A05-\u0A0A\u0A0F\u0A10\u0A13-\u0A28\u0A2A-\u0A30\u0A32\u0A33\u0A35\u0A36\u0A38\u0A39\u0A3C\u0A4D\u0A59-\u0A5C\u0A5E\u0A66-\u0A6F\u0A72-\u0A74\u0A85-\u0A8D\u0A8F-\u0A91\u0A93-\u0AA8\u0AAA-\u0AB0\u0AB2\u0AB3\u0AB5-\u0AB9\u0ABC\u0ABD\u0ACD\u0AD0\u0AE0\u0AE1\u0AE6-\u0AEF\u0AF9\u0AFD-\u0AFF\u0B05-\u0B0C\u0B0F\u0B10\u0B13-\u0B28\u0B2A-\u0B30\u0B32\u0B33\u0B35-\u0B39\u0B3C\u0B3D\u0B4D\u0B55\u0B5C\u0B5D\u0B5F-\u0B61\u0B66-\u0B6F\u0B71-\u0B77\u0B83\u0B85-\u0B8A\u0B8E-\u0B90\u0B92-\u0B95\u0B99\u0B9A\u0B9C\u0B9E\u0B9F\u0BA3\u0BA4\u0BA8-\u0BAA\u0BAE-\u0BB9\u0BCD\u0BD0\u0BE6-\u0BF2\u0C05-\u0C0C\u0C0E-\u0C10\u0C12-\u0C28\u0C2A-\u0C39\u0C3D\u0C4D\u0C58-\u0C5A\u0C60\u0C61\u0C66-\u0C6F\u0C78-\u0C7E\u0C80\u0C85-\u0C8C\u0C8E-\u0C90\u0C92-\u0CA8\u0CAA-\u0CB3\u0CB5-\u0CB9\u0CBC\u0CBD\u0CCD\u0CDE\u0CE0\u0CE1\u0CE6-\u0CEF\u0CF1\u0CF2\u0D04-\u0D0C\u0D0E-\u0D10\u0D12-\u0D3D\u0D4D\u0D4E\u0D54-\u0D56\u0D58-\u0D61\u0D66-\u0D78\u0D7A-\u0D7F\u0D85-\u0D96\u0D9A-\u0DB1\u0DB3-\u0DBB\u0DBD\u0DC0-\u0DC6\u0DCA\u0DE6-\u0DEF\u0E01-\u0E30\u0E32\u0E33\u0E40-\u0E4C\u0E4E\u0E50-\u0E59\u0E81\u0E82\u0E84\u0E86-\u0E8A\u0E8C-\u0EA3\u0EA5\u0EA7-\u0EB0\u0EB2\u0EB3\u0EBA\u0EBD\u0EC0-\u0EC4\u0EC6\u0EC8-\u0ECC\u0ED0-\u0ED9\u0EDC-\u0EDF\u0F00\u0F18\u0F19\u0F20-\u0F33\u0F35\u0F37\u0F39\u0F3E-\u0F47\u0F49-\u0F6C\u0F82-\u0F84\u0F86-\u0F8C\u0FC6\u1000-\u102A\u1037\u1039\u103A\u103F-\u1049\u1050-\u1055\u105A-\u105D\u1061\u1063-\u1066\u1069-\u1070\u1075-\u1081\u1087-\u109B\u10A0-\u10C5\u10C7\u10CD\u10D0-\u10FA\u10FC-\u1248\u124A-\u124D\u1250-\u1256\u1258\u125A-\u125D\u1260-\u1288\u128A-\u128D\u1290-\u12B0\u12B2-\u12B5\u12B8-\u12BE\u12C0\u12C2-\u12C5\u12C8-\u12D6\u12D8-\u1310\u1312-\u1315\u1318-\u135A\u135D-\u135F\u1369-\u137C\u1380-\u138F\u13A0-\u13F5\u13F8-\u13FD\u1401-\u166C\u166F-\u167F\u1681-\u169A\u16A0-\u16EA\u16EE-\u16F8\u1700-\u170C\u170E-\u1711\u1720-\u1731\u1740-\u1751\u1760-\u176C\u176E-\u1770\u1780-\u17B3\u17C9-\u17D3\u17D7\u17DC\u17DD\u17E0-\u17E9\u17F0-\u17F9\u1810-\u1819\u1820-\u1878\u1880-\u1884\u1887-\u18A8\u18AA\u18B0-\u18F5\u1900-\u191E\u1939-\u193B\u1946-\u196D\u1970-\u1974\u1980-\u19AB\u19B0-\u19C9\u19D0-\u19DA\u1A00-\u1A16\u1A20-\u1A54\u1A75-\u1A7C\u1A7F-\u1A89\u1A90-\u1A99\u1AA7\u1AB0-\u1ABD\u1B05-\u1B34\u1B44-\u1B4B\u1B50-\u1B59\u1B6B-\u1B73\u1B83-\u1BA0\u1BAA\u1BAB\u1BAE-\u1BE5\u1C00-\u1C23\u1C36\u1C37\u1C40-\u1C49\u1C4D-\u1C7D\u1C80-\u1C88\u1C90-\u1CBA\u1CBD-\u1CBF\u1CD0-\u1CFA\u1D00-\u1DBF\u1DC4-\u1DCF\u1DF5-\u1DF9\u1DFD-\u1F15\u1F18-\u1F1D\u1F20-\u1F45\u1F48-\u1F4D\u1F50-\u1F57\u1F59\u1F5B\u1F5D\u1F5F-\u1F7D\u1F80-\u1FB4\u1FB6-\u1FC4\u1FC6-\u1FD3\u1FD6-\u1FDB\u1FDD-\u1FEF\u1FF2-\u1FF4\u1FF6-\u1FFE\u2070\u2071\u2074-\u2079\u207F-\u2089\u2090-\u209C\u2102\u2107\u210A-\u2113\u2115\u2119-\u211D\u2124\u2126\u2128\u212A-\u212D\u212F-\u2139\u213C-\u213F\u2145-\u2149\u214E\u2150-\u2189\u2460-\u249B\u24EA-\u24FF\u2776-\u2793\u2C00-\u2C2E\u2C30-\u2C5E\u2C60-\u2CE4\u2CEB-\u2CF3\u2CFD\u2D00-\u2D25\u2D27\u2D2D\u2D30-\u2D67\u2D6F\u2D80-\u2D96\u2DA0-\u2DA6\u2DA8-\u2DAE\u2DB0-\u2DB6\u2DB8-\u2DBE\u2DC0-\u2DC6\u2DC8-\u2DCE\u2DD0-\u2DD6\u2DD8-\u2DDE\u2E2F\u3005-\u3007\u3021-\u302F\u3031-\u3035\u3038-\u303C\u3041-\u3096\u3099-\u309F\u30A1-\u30FA\u30FC-\u30FF\u3105-\u312F\u3131-\u318E\u3192-\u3195\u31A0-\u31BF\u31F0-\u31FF\u3220-\u3229\u3248-\u324F\u3251-\u325F\u3280-\u3289\u32B1-\u32BF\u3400-\u4DBF\u4E00-\u9FFC\uA000-\uA48C\uA4D0-\uA4FD\uA500-\uA60C\uA610-\uA62B\uA640-\uA66F\uA67C\uA67D\uA67F-\uA69D\uA6A0-\uA6F1\uA700-\uA7BF\uA7C2-\uA7CA\uA7F5-\uA801\uA803-\uA805\uA807-\uA80A\uA80C-\uA822\uA830-\uA835\uA840-\uA873\uA882-\uA8B3\uA8C4\uA8D0-\uA8D9\uA8E0-\uA8F7\uA8FB\uA8FD\uA8FE\uA900-\uA925\uA92B-\uA92E\uA930-\uA946\uA953\uA960-\uA97C\uA984-\uA9B3\uA9C0\uA9CF-\uA9D9\uA9E0-\uA9FE\uAA00-\uAA28\uAA40-\uAA42\uAA44-\uAA4B\uAA50-\uAA59\uAA60-\uAA76\uAA7A-\uAAAF\uAAB1\uAAB5\uAAB6\uAAB9-\uAABD\uAABF-\uAAC2\uAADB-\uAADD\uAAE0-\uAAEA\uAAF2-\uAAF4\uAAF6\uAB01-\uAB06\uAB09-\uAB0E\uAB11-\uAB16\uAB20-\uAB26\uAB28-\uAB2E\uAB30-\uAB6B\uAB70-\uABE2\uABEC\uABED\uABF0-\uABF9\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFA6D\uFA70-\uFAD9\uFB00-\uFB06\uFB13-\uFB17\uFB1D-\uFB28\uFB2A-\uFB36\uFB38-\uFB3C\uFB3E\uFB40\uFB41\uFB43\uFB44\uFB46-\uFBB1\uFBD3-\uFD3D\uFD50-\uFD8F\uFD92-\uFDC7\uFDF0-\uFDFB\uFE20-\uFE2F\uFE70-\uFE74\uFE76-\uFEFC\uFF10-\uFF19\uFF21-\uFF3A\uFF3E\uFF40-\uFF5A\uFF66-\uFFBE\uFFC2-\uFFC7\uFFCA-\uFFCF\uFFD2-\uFFD7\uFFDA-\uFFDC\uFFE3]|\uD800[\uDC00-\uDC0B\uDC0D-\uDC26\uDC28-\uDC3A\uDC3C\uDC3D\uDC3F-\uDC4D\uDC50-\uDC5D\uDC80-\uDCFA\uDD07-\uDD33\uDD40-\uDD78\uDD8A\uDD8B\uDE80-\uDE9C\uDEA0-\uDED0\uDEE0-\uDEFB\uDF00-\uDF23\uDF2D-\uDF4A\uDF50-\uDF75\uDF80-\uDF9D\uDFA0-\uDFC3\uDFC8-\uDFCF\uDFD1-\uDFD5]|\uD801[\uDC00-\uDC9D\uDCA0-\uDCA9\uDCB0-\uDCD3\uDCD8-\uDCFB\uDD00-\uDD27\uDD30-\uDD63\uDE00-\uDF36\uDF40-\uDF55\uDF60-\uDF67]|\uD802[\uDC00-\uDC05\uDC08\uDC0A-\uDC35\uDC37\uDC38\uDC3C\uDC3F-\uDC55\uDC58-\uDC76\uDC79-\uDC9E\uDCA7-\uDCAF\uDCE0-\uDCF2\uDCF4\uDCF5\uDCFB-\uDD1B\uDD20-\uDD39\uDD80-\uDDB7\uDDBC-\uDDCF\uDDD2-\uDE00\uDE10-\uDE13\uDE15-\uDE17\uDE19-\uDE35\uDE40-\uDE48\uDE60-\uDE7E\uDE80-\uDE9F\uDEC0-\uDEC7\uDEC9-\uDEE6\uDEEB-\uDEEF\uDF00-\uDF35\uDF40-\uDF55\uDF58-\uDF72\uDF78-\uDF91\uDFA9-\uDFAF]|\uD803[\uDC00-\uDC48\uDC80-\uDCB2\uDCC0-\uDCF2\uDCFA-\uDD27\uDD30-\uDD39\uDE60-\uDE7E\uDE80-\uDEA9\uDEB0\uDEB1\uDF00-\uDF27\uDF30-\uDF54\uDFB0-\uDFCB\uDFE0-\uDFF6]|\uD804[\uDC03-\uDC37\uDC52-\uDC6F\uDC83-\uDCAF\uDCB9\uDCBA\uDCD0-\uDCE8\uDCF0-\uDCF9\uDD03-\uDD26\uDD33\uDD34\uDD36-\uDD3F\uDD44\uDD47\uDD50-\uDD73\uDD76\uDD83-\uDDB2\uDDC0-\uDDC4\uDDCA-\uDDCC\uDDD0-\uDDDA\uDDDC\uDDE1-\uDDF4\uDE00-\uDE11\uDE13-\uDE2B\uDE35\uDE36\uDE80-\uDE86\uDE88\uDE8A-\uDE8D\uDE8F-\uDE9D\uDE9F-\uDEA8\uDEB0-\uDEDE\uDEE9\uDEEA\uDEF0-\uDEF9\uDF05-\uDF0C\uDF0F\uDF10\uDF13-\uDF28\uDF2A-\uDF30\uDF32\uDF33\uDF35-\uDF39\uDF3C\uDF3D\uDF4D\uDF50\uDF5D-\uDF61\uDF66-\uDF6C\uDF70-\uDF74]|\uD805[\uDC00-\uDC34\uDC42\uDC46-\uDC4A\uDC50-\uDC59\uDC5F-\uDC61\uDC80-\uDCAF\uDCC2-\uDCC5\uDCC7\uDCD0-\uDCD9\uDD80-\uDDAE\uDDBF\uDDC0\uDDD8-\uDDDB\uDE00-\uDE2F\uDE3F\uDE44\uDE50-\uDE59\uDE80-\uDEAA\uDEB6-\uDEB8\uDEC0-\uDEC9\uDF00-\uDF1A\uDF2B\uDF30-\uDF3B]|\uD806[\uDC00-\uDC2B\uDC39\uDC3A\uDCA0-\uDCF2\uDCFF-\uDD06\uDD09\uDD0C-\uDD13\uDD15\uDD16\uDD18-\uDD2F\uDD3D-\uDD3F\uDD41\uDD43\uDD50-\uDD59\uDDA0-\uDDA7\uDDAA-\uDDD0\uDDE0\uDDE1\uDDE3\uDE00\uDE0B-\uDE32\uDE34\uDE3A\uDE47\uDE50\uDE5C-\uDE89\uDE99\uDE9D\uDEC0-\uDEF8]|\uD807[\uDC00-\uDC08\uDC0A-\uDC2E\uDC3F\uDC40\uDC50-\uDC6C\uDC72-\uDC8F\uDD00-\uDD06\uDD08\uDD09\uDD0B-\uDD30\uDD42\uDD44-\uDD46\uDD50-\uDD59\uDD60-\uDD65\uDD67\uDD68\uDD6A-\uDD89\uDD97\uDD98\uDDA0-\uDDA9\uDEE0-\uDEF2\uDFB0\uDFC0-\uDFD4]|\uD808[\uDC00-\uDF99]|\uD809[\uDC00-\uDC6E\uDC80-\uDD43]|[\uD80C\uD81C-\uD820\uD822\uD840-\uD868\uD86A-\uD86C\uD86F-\uD872\uD874-\uD879\uD880-\uD883][\uDC00-\uDFFF]|\uD80D[\uDC00-\uDC2E]|\uD811[\uDC00-\uDE46]|\uD81A[\uDC00-\uDE38\uDE40-\uDE5E\uDE60-\uDE69\uDED0-\uDEED\uDEF0-\uDEF4\uDF00-\uDF36\uDF40-\uDF43\uDF50-\uDF59\uDF5B-\uDF61\uDF63-\uDF77\uDF7D-\uDF8F]|\uD81B[\uDE40-\uDE96\uDF00-\uDF4A\uDF50\uDF8F-\uDF9F\uDFE0\uDFE1\uDFE3\uDFF0\uDFF1]|\uD821[\uDC00-\uDFF7]|\uD823[\uDC00-\uDCD5\uDD00-\uDD08]|\uD82C[\uDC00-\uDD1E\uDD50-\uDD52\uDD64-\uDD67\uDD70-\uDEFB]|\uD82F[\uDC00-\uDC6A\uDC70-\uDC7C\uDC80-\uDC88\uDC90-\uDC99]|\uD834[\uDD67-\uDD69\uDD6D-\uDD72\uDD7B-\uDD82\uDD85-\uDD8B\uDDAA-\uDDAD\uDEE0-\uDEF3\uDF60-\uDF78]|\uD835[\uDC00-\uDC54\uDC56-\uDC9C\uDC9E\uDC9F\uDCA2\uDCA5\uDCA6\uDCA9-\uDCAC\uDCAE-\uDCB9\uDCBB\uDCBD-\uDCC3\uDCC5-\uDD05\uDD07-\uDD0A\uDD0D-\uDD14\uDD16-\uDD1C\uDD1E-\uDD39\uDD3B-\uDD3E\uDD40-\uDD44\uDD46\uDD4A-\uDD50\uDD52-\uDEA5\uDEA8-\uDEC0\uDEC2-\uDEDA\uDEDC-\uDEFA\uDEFC-\uDF14\uDF16-\uDF34\uDF36-\uDF4E\uDF50-\uDF6E\uDF70-\uDF88\uDF8A-\uDFA8\uDFAA-\uDFC2\uDFC4-\uDFCB\uDFCE-\uDFFF]|\uD838[\uDD00-\uDD2C\uDD30-\uDD3D\uDD40-\uDD49\uDD4E\uDEC0-\uDEF9]|\uD83A[\uDC00-\uDCC4\uDCC7-\uDCD6\uDD00-\uDD46\uDD48-\uDD4B\uDD50-\uDD59]|\uD83B[\uDC71-\uDCAB\uDCAD-\uDCAF\uDCB1-\uDCB4\uDD01-\uDD2D\uDD2F-\uDD3D\uDE00-\uDE03\uDE05-\uDE1F\uDE21\uDE22\uDE24\uDE27\uDE29-\uDE32\uDE34-\uDE37\uDE39\uDE3B\uDE42\uDE47\uDE49\uDE4B\uDE4D-\uDE4F\uDE51\uDE52\uDE54\uDE57\uDE59\uDE5B\uDE5D\uDE5F\uDE61\uDE62\uDE64\uDE67-\uDE6A\uDE6C-\uDE72\uDE74-\uDE77\uDE79-\uDE7C\uDE7E\uDE80-\uDE89\uDE8B-\uDE9B\uDEA1-\uDEA3\uDEA5-\uDEA9\uDEAB-\uDEBB]|\uD83C[\uDD00-\uDD0C]|\uD83E[\uDFF0-\uDFF9]|\uD869[\uDC00-\uDEDD\uDF00-\uDFFF]|\uD86D[\uDC00-\uDF34\uDF40-\uDFFF]|\uD86E[\uDC00-\uDC1D\uDC20-\uDFFF]|\uD873[\uDC00-\uDEA1\uDEB0-\uDFFF]|\uD87A[\uDC00-\uDFE0]|\uD87E[\uDC00-\uDE1D]|\uD884[\uDC00-\uDF4A])+)($|(?:[\t\n\r -#%-\*,-\/:;\?@\[-\]_\{\}\xA0\xA1\xA7\xAB\xB6\xB7\xBB\xBF\u037E\u0387\u055A-\u055F\u0589\u058A\u05BE\u05C0\u05C3\u05C6\u05F3\u05F4\u0609\u060A\u060C\u060D\u061B\u061E\u061F\u066A-\u066D\u06D4\u0700-\u070D\u07F7-\u07F9\u0830-\u083E\u085E\u0964\u0965\u0970\u09FD\u0A76\u0AF0\u0C77\u0C84\u0DF4\u0E4F\u0E5A\u0E5B\u0F04-\u0F12\u0F14\u0F3A-\u0F3D\u0F85\u0FD0-\u0FD4\u0FD9\u0FDA\u104A-\u104F\u10FB\u1360-\u1368\u1400\u166E\u1680\u169B\u169C\u16EB-\u16ED\u1735\u1736\u17D4-\u17D6\u17D8-\u17DA\u1800-\u180A\u1944\u1945\u1A1E\u1A1F\u1AA0-\u1AA6\u1AA8-\u1AAD\u1B5A-\u1B60\u1BFC-\u1BFF\u1C3B-\u1C3F\u1C7E\u1C7F\u1CC0-\u1CC7\u1CD3\u2000-\u200A\u2010-\u2029\u202F-\u2043\u2045-\u2051\u2053-\u205F\u207D\u207E\u208D\u208E\u2308-\u230B\u2329\u232A\u2768-\u2775\u27C5\u27C6\u27E6-\u27EF\u2983-\u2998\u29D8-\u29DB\u29FC\u29FD\u2CF9-\u2CFC\u2CFE\u2CFF\u2D70\u2E00-\u2E2E\u2E30-\u2E4F\u2E52\u3000-\u3003\u3008-\u3011\u3014-\u301F\u3030\u303D\u30A0\u30FB\uA4FE\uA4FF\uA60D-\uA60F\uA673\uA67E\uA6F2-\uA6F7\uA874-\uA877\uA8CE\uA8CF\uA8F8-\uA8FA\uA8FC\uA92E\uA92F\uA95F\uA9C1-\uA9CD\uA9DE\uA9DF\uAA5C-\uAA5F\uAADE\uAADF\uAAF0\uAAF1\uABEB\uFD3E\uFD3F\uFE10-\uFE19\uFE30-\uFE52\uFE54-\uFE61\uFE63\uFE68\uFE6A\uFE6B\uFF01-\uFF03\uFF05-\uFF0A\uFF0C-\uFF0F\uFF1A\uFF1B\uFF1F\uFF20\uFF3B-\uFF3D\uFF3F\uFF5B\uFF5D\uFF5F-\uFF65]|\uD800[\uDD00-\uDD02\uDF9F\uDFD0]|\uD801\uDD6F|\uD802[\uDC57\uDD1F\uDD3F\uDE50-\uDE58\uDE7F\uDEF0-\uDEF6\uDF39-\uDF3F\uDF99-\uDF9C]|\uD803[\uDEAD\uDF55-\uDF59]|\uD804[\uDC47-\uDC4D\uDCBB\uDCBC\uDCBE-\uDCC1\uDD40-\uDD43\uDD74\uDD75\uDDC5-\uDDC8\uDDCD\uDDDB\uDDDD-\uDDDF\uDE38-\uDE3D\uDEA9]|\uD805[\uDC4B-\uDC4F\uDC5A\uDC5B\uDC5D\uDCC6\uDDC1-\uDDD7\uDE41-\uDE43\uDE60-\uDE6C\uDF3C-\uDF3E]|\uD806[\uDC3B\uDD44-\uDD46\uDDE2\uDE3F-\uDE46\uDE9A-\uDE9C\uDE9E-\uDEA2]|\uD807[\uDC41-\uDC45\uDC70\uDC71\uDEF7\uDEF8\uDFFF]|\uD809[\uDC70-\uDC74]|\uD81A[\uDE6E\uDE6F\uDEF5\uDF37-\uDF3B\uDF44]|\uD81B[\uDE97-\uDE9A\uDFE2]|\uD82F\uDC9F|\uD836[\uDE87-\uDE8B]|\uD83A[\uDD5E\uDD5F]))/g,l=/(?:[\t\n\r -#%-\*,-\/:;\?@\[-\]_\{\}\xA0\xA1\xA7\xAB\xB6\xB7\xBB\xBF\u037E\u0387\u055A-\u055F\u0589\u058A\u05BE\u05C0\u05C3\u05C6\u05F3\u05F4\u0609\u060A\u060C\u060D\u061B\u061E\u061F\u066A-\u066D\u06D4\u0700-\u070D\u07F7-\u07F9\u0830-\u083E\u085E\u0964\u0965\u0970\u09FD\u0A76\u0AF0\u0C77\u0C84\u0DF4\u0E4F\u0E5A\u0E5B\u0F04-\u0F12\u0F14\u0F3A-\u0F3D\u0F85\u0FD0-\u0FD4\u0FD9\u0FDA\u104A-\u104F\u10FB\u1360-\u1368\u1400\u166E\u1680\u169B\u169C\u16EB-\u16ED\u1735\u1736\u17D4-\u17D6\u17D8-\u17DA\u1800-\u180A\u1944\u1945\u1A1E\u1A1F\u1AA0-\u1AA6\u1AA8-\u1AAD\u1B5A-\u1B60\u1BFC-\u1BFF\u1C3B-\u1C3F\u1C7E\u1C7F\u1CC0-\u1CC7\u1CD3\u2000-\u200A\u2010-\u2029\u202F-\u2043\u2045-\u2051\u2053-\u205F\u207D\u207E\u208D\u208E\u2308-\u230B\u2329\u232A\u2768-\u2775\u27C5\u27C6\u27E6-\u27EF\u2983-\u2998\u29D8-\u29DB\u29FC\u29FD\u2CF9-\u2CFC\u2CFE\u2CFF\u2D70\u2E00-\u2E2E\u2E30-\u2E4F\u2E52\u3000-\u3003\u3008-\u3011\u3014-\u301F\u3030\u303D\u30A0\u30FB\uA4FE\uA4FF\uA60D-\uA60F\uA673\uA67E\uA6F2-\uA6F7\uA874-\uA877\uA8CE\uA8CF\uA8F8-\uA8FA\uA8FC\uA92E\uA92F\uA95F\uA9C1-\uA9CD\uA9DE\uA9DF\uAA5C-\uAA5F\uAADE\uAADF\uAAF0\uAAF1\uABEB\uFD3E\uFD3F\uFE10-\uFE19\uFE30-\uFE52\uFE54-\uFE61\uFE63\uFE68\uFE6A\uFE6B\uFF01-\uFF03\uFF05-\uFF0A\uFF0C-\uFF0F\uFF1A\uFF1B\uFF1F\uFF20\uFF3B-\uFF3D\uFF3F\uFF5B\uFF5D\uFF5F-\uFF65]|\uD800[\uDD00-\uDD02\uDF9F\uDFD0]|\uD801\uDD6F|\uD802[\uDC57\uDD1F\uDD3F\uDE50-\uDE58\uDE7F\uDEF0-\uDEF6\uDF39-\uDF3F\uDF99-\uDF9C]|\uD803[\uDEAD\uDF55-\uDF59]|\uD804[\uDC47-\uDC4D\uDCBB\uDCBC\uDCBE-\uDCC1\uDD40-\uDD43\uDD74\uDD75\uDDC5-\uDDC8\uDDCD\uDDDB\uDDDD-\uDDDF\uDE38-\uDE3D\uDEA9]|\uD805[\uDC4B-\uDC4F\uDC5A\uDC5B\uDC5D\uDCC6\uDDC1-\uDDD7\uDE41-\uDE43\uDE60-\uDE6C\uDF3C-\uDF3E]|\uD806[\uDC3B\uDD44-\uDD46\uDDE2\uDE3F-\uDE46\uDE9A-\uDE9C\uDE9E-\uDEA2]|\uD807[\uDC41-\uDC45\uDC70\uDC71\uDEF7\uDEF8\uDFFF]|\uD809[\uDC70-\uDC74]|\uD81A[\uDE6E\uDE6F\uDEF5\uDF37-\uDF3B\uDF44]|\uD81B[\uDE97-\uDE9A\uDFE2]|\uD82F\uDC9F|\uD836[\uDE87-\uDE8B]|\uD83A[\uDD5E\uDD5F])+/g,m=/(?:[\$\xA2-\xA5\u058F\u060B\u07FE\u07FF\u09F2\u09F3\u09FB\u0AF1\u0BF9\u0E3F\u17DB\u20A0-\u20BF\uA838\uFDFC\uFE69\uFF04\uFFE0\uFFE1\uFFE5\uFFE6]|\uD807[\uDFDD-\uDFE0]|\uD838\uDEFF|\uD83B\uDCB0)+/g;function n(a){return a.replace(k,function(a,b,c,d,e){return" "+c+d+" "+c+" "+d+" "})}function o(a){return a.split(l)}function p(a){return a.replace(j,"")}function q(a){return a.replace(i,"")}function r(a){return a.normalize("NFC").replace(h.NFC_CHARACTER,function(a){return" "+a+" "})}function s(a){return a.normalize("NFC").replace(h.NFC_WORD,function(a){return" "+a+" "})}function t(a){return a.replace(m,function(a){return" "+a+" "})}a=function(){function a(){}var b=a.prototype;b.tokenize=function(a){a===void 0&&(a="");a=n(a);a=t(r(s(a)));a=o(a);a=a.map(function(a){a=a;a=p(a);if(!a.length)return a;else a.match(h.NFC_CHARACTER)?a=a.normalize("NFC"):a.match(h.NFC_WORD)?a=a.normalize("NFC"):(a=q(c("WAFtsTokenizerPreNFKDNormalizer").normalize(a).normalize("NFKD")),a=a.toLocaleLowerCase("en-US"),a=c("WAFtsTokenizerPostLowercaseNormalizer").normalize(a));return a});return new Set(a.filter(function(a){return!!a&&!!a.trim()&&!a.match(l)}))};return a}();g["default"]=a}),98);
__d("MAWFTSIsMessageValidForSearch",["MAWMsgType"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return a.ephemeralSetting!=null&&a.ephemeralSetting.ephemeralExpirationInSec>0}function a(a){var b=a.msgContent,c=a.sortOrderMs,e=a.type;b=b==null?void 0:b.content;if(b==null||c==null)return null;if(e!==d("MAWMsgType").MSG_TYPE.TEXT&&e!==d("MAWMsgType").MSG_TYPE.XMA)return null;return h(a)?null:{content:b,sortOrderMs:c}}g.verifyMessageValidity=a}),98);
__d("MpsMessageToSearchBridge",["MpsMessageToBridgeWrapper"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=d("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(a.toplevelProtobuf);if(a.expiryTimestampMs!=null)return;a=(a=b.deserialize().encryptedTransportMessage())==null||(a=a.consumerMessage())==null||(a=a.payload)==null||(a=a.content)==null||(a=a.messageText)==null?void 0:a.text;return a==null?null:{chatJid:b.getChatJid(),externalId:b.getExternalId(),msg:{content:a,sender:b.message.senderId,ts:b.getUnixTs()},sortOrderMs:b.message.timestampMs}}g.messageToSearchBridge=a}),98);
__d("MAWDbGroupInviteTxns",["MAWDexieTable","MAWMsgType"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return a.groupInvites.put(b).then(function(){return b})}function b(a,b,c){return a.groupInvites.where(["threadJid","inviteeJid"]).anyOf([[b,c]])["delete"]()}function h(a,b,c){return a.groupInvites.where(["threadJid","inviteeJid"]).equals([b,c]).first()}function c(a,b,c){return a.groupInvites.where(["threadJid","inviteeJid"]).anyOf([[b,c]]).toArray()}function e(a,b){return b.type===d("MAWMsgType").MSG_TYPE.GROUP_INVITE?b.invitedParticipantUserJid==null?d("MAWDexieTable").dexieResolve():h(a,b.threadJid,b.invitedParticipantUserJid):d("MAWDexieTable").dexieResolve()}g.putGroupInvite=a;g.deleteGroupInvitesByThreadAndInvitedParticipant=b;g.maybeGetGroupInvite=h;g.getGroupInvitesByThreadAndInvitedParticipant=c;g.getAndCheckGroupInviteFromMsg=e}),98);
__d("MAWRemoveGroupInvitesApi",["MAWDbGroupInviteTxns","MAWIndexedDb","MAWTransactionMode","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;a=d("MAWIndexedDb").makeMsgrTransactor({groupInvites:d("MAWTransactionMode").READWRITE},"removeGroupInvites",function(a){return function(b,c){return d("MAWDbGroupInviteTxns").deleteGroupInvitesByThreadAndInvitedParticipant(a,b,c).then(function(a){d("WALogger").DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose(["removeGroupInvites deleted "," record(s) from "," for ",""])),a,b,c),d("MAWIndexedDb").afterTransaction({tag:"DeleteGroupInvite",value:{threadJid:b}})}).then(function(){d("MAWIndexedDb").afterTransaction({tag:"GroupInviteLoaded",value:{actorId:c,threadJid:b}})})}});g.removeGroupInvites=a}),98);
__d("MAWLoadGroupInvitesTxns",["MAWBridgeTypesCreators","MAWDbGroupInviteTxns","MAWDexieTable","MAWIndexedDb","MAWUserJidWrapper","WAJids","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var e=[],f=d("MAWUserJidWrapper").getMyUserJid();b.forEach(function(b){return d("WAJids").switchOnMsgrChatJidType(b.jid,{group:function(){e.push(d("MAWDbGroupInviteTxns").getGroupInvitesByThreadAndInvitedParticipant(a,b.jid,f))},user:c("emptyFunction")})});return d("MAWDexieTable").dexieAll(e).then(function(a){a.forEach(function(a,b){a.forEach(function(b,a){d("MAWIndexedDb").afterTransaction({tag:"GroupInviteUpdate",value:d("MAWBridgeTypesCreators").createBridgeGroupInvite(b)})})})})}g.loadGroupInvites=a}),98);
__d("MAWDbPollTxns",["MAWIndexedDb","MAWTransactionMode","WAStanzaUtils"],(function(a,b,c,d,e,f,g){"use strict";e=d("MAWIndexedDb").makeMsgrTransactor({poll:d("MAWTransactionMode").READONLY},"handleIncomingMessagesStanzas",function(a){return function(b,c){return a.poll.get([b,d("WAStanzaUtils").toStanzaId(c)])}});function a(a,b){return a.poll.put(b).then(function(){return b})}function b(a,b,c){return a.poll.get([b,d("WAStanzaUtils").toStanzaId(c)])}function c(a,b,c){return a.messages.where(["threadJid","pollStanzaId","sortOrderMs"]).between([c,b,Number.MIN_SAFE_INTEGER],[c,b,Number.MAX_SAFE_INTEGER],!1,!1).reverse().first()}g.getDbPoll=e;g.updatePoll=a;g.getPoll=b;g.maybeGetLatestPollUpdateMsg=c}),98);
__d("MAWLoadMessagesRequest",["FBLogger","MAWMessagesCompare","MAWMessagesDirection","MessagesRangesV2ExternalIds","WAStanzaUtils"],(function(a,b,c,d,e,f,g){"use strict";b={admin:!1,editMsgHistory:!1,media:!1,polls:!1,reactions:!1,receiverFetch:!1,xma:!1};function h(a,b,e){if(a.length===0)return[];e=d("MAWMessagesCompare").getSortComparisonFunctionForDirection(d("MAWMessagesDirection").translateMawDirectionToMwpDirection(e));a=[].concat(a).sort(e);if(b.lowerBoundExternalId!=null&&((e=b.lowerBoundExternalId)==null?void 0:e.toString())!==d("MessagesRangesV2ExternalIds").MIN_EXTERNAL_ID&&((e=b.lowerBoundExternalId)==null?void 0:e.toString())!==d("MessagesRangesV2ExternalIds").MAX_EXTERNAL_ID){e=a.findIndex(function(a){return a.externalId===b.lowerBoundExternalId});e!==-1?a=a.slice(e):c("FBLogger")("messenger_web").mustfix("Get messages for range: no external id in source msgs list")}a=i(a,b);return a.slice(0,b.numMsgs)}function a(a,b,c,e){a=a.filter(function(a){var c;return((c=a.sortOrderMs)!=null?c:Number.MAX_SAFE_INTEGER)>=b.gte[0]&&((c=a.sortOrderMs)!=null?c:Number.MIN_SAFE_INTEGER)<=b.lte[0]});var f=d("MAWMessagesDirection").switchOnMAWMessagesDirection(c,{after:[b.gte,b.lte],before:[b.lte,b.gte]}),g=f[0],i=g[0];g=g[1];f=f[1];f[0];var j=f[1];f=h(a,{includeLowerBoundMsg:!0,lowerBoundExternalId:d("WAStanzaUtils").toStanzaId(g),lowerBoundSortOrderMs:i,numMsgs:e},c);if(j!==d("MessagesRangesV2ExternalIds").MIN_EXTERNAL_ID&&j!==d("MessagesRangesV2ExternalIds").MAX_EXTERNAL_ID){a=f.findIndex(function(a){return a.externalId===j});if(a!==-1)return f.slice(0,a)}return f}function i(a,b){if(b.includeLowerBoundMsg||a.length===0)return a;return a[0].externalId===b.lowerBoundExternalId||a[0].sortOrderMs===b.lowerBoundSortOrderMs?a.slice(1):a}g.loadMsgsConfigForCheckingOnly=b;g.getMsgsForRange=h;g.getMsgsForBounds=a}),98);
__d("MAWLoadMsgsDedupper",["MAWDbMsgUtil","WAMsg"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a=new Set();return function(b){b=d("MAWDbMsgUtil").getProtocolMsgIdFromDbMsg(b);if(b==null)return!0;b=d("WAMsg").craftWAMsgIdString(b);if(b!=null){if(a.has(b))return!1;a.add(b)}return!0}}g["default"]=a}),98);
__d("MAWLoadMsgsUtil",[],(function(a,b,c,d,e,f){"use strict";function a(a,b,c){var d=0,e=0,f=!1,g=null;return function(h){e++;if(g!=null&&g===h.sortOrderMs)return!1;if(e>b&&h.sortOrderMs!==a)return!0;h.msgId===c&&(f=!0);f&&d++;if(d>b)return!0;g=h.sortOrderMs;return!1}}function b(a){var b=!0,c=0,d=null;return function(e){if(d===null)c++;else if(d===e.sortOrderMs){c+=b?0:1;return!1}else c++,b=!1;if(c>a)return!0;d=e.sortOrderMs;return!1}}f.makeUntilWithRangeExtension=a;f.makeUntilWithRangeExtensionBothDirections=b}),66);
__d("MAWLoadMsgsTxnsV2",["I64","MAWBridgeMsg","MAWBridgeMsgCountdown","MAWBridgeReceiverFetchInfo","MAWBridgeTypesCreators","MAWBridgeXMA","MAWCurrentUser","MAWDbChunkTxns","MAWDbEditMsgHistoryTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWDbPollTxns","MAWDbReactionsTxns","MAWDbReceiverFetchTxns","MAWDbXMATxns","MAWDexieTable","MAWGetIsMediaDownloadStatusEnabled","MAWHandleXmaTransactionUtil","MAWLoadMessagesRequest","MAWLoadMsgsDedupper","MAWLoadMsgsUtil","MAWLoadReplyMediaTxns","MAWLoggerUtils","MAWMediaUtils","MAWMessagesDirection","MAWODSProxy","MAWRavenUtils","MAWXMAUtils","MWFBLogger","WAMsgType","WAOdsEnums","WATimeUtils","gkx","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m;function n(a,b,d,e,f,g){switch(d){case"before":return h();case"after":return i().then(function(a){return a.reverse()})}function h(){var d=c("MAWLoadMsgsDedupper")();return a.messages.where(["threadJid","sortOrderMs"]).between([b,0],[b,e],!0,!0).reverse().filter(f).filter(d).filter(function(a){return c("justknobx")._("3227")?a.source!=="media_restore":a!=null}).until(g,!0).toArray()}function i(){var d=c("MAWLoadMsgsDedupper")();return a.messages.where(["threadJid","sortOrderMs"]).between([b,e],[b,Number.MAX_SAFE_INTEGER],!0,!0).filter(f).filter(d).filter(function(a){return c("justknobx")._("3227")?a.source!=="media_restore":a!=null}).until(g,!0).toArray()}}function o(a,b){return d("MAWDbReactionsTxns").getReactionsFromMessages(a,b).then(function(a){return a.map(function(a){var b=a.author,c=a.reaction,e=a.reactToMsgId,f=a.threadJid;a=a.ts;if(e==null)return;return c==null?{reaction:d("MAWBridgeTypesCreators").createBridgeDeleteReaction({author:b,chatJid:f,reactToMsgId:e}),type:"delete"}:{reaction:d("MAWBridgeTypesCreators").createBridgeUpsertReaction({author:b,chatJid:f,reaction:c||"",reactToMsgId:e,ts:a}),type:"upsert"}}).filter(Boolean)})}function p(a,b){return d("MAWDbMediaTxns").getMsgMediaPairFromMsgs(a,b).then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b[0],e=b[1];return d("MAWDbChunkTxns").hasMediaChunk(a,e.hashedPlaintextHash).then(function(b){return q(a,c.threadJid,e).then(function(f){var g=f.map(function(a){return a.msgId}),h=d("MAWMediaUtils").createHdTypesForBridgeMedia(f);g=c.ravenEphemeralType!=null&&c.ravenEphemeralMediaState!=null?d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:c.threadJid,filteredMsgIds:g,hasMediaForUI:b,hdTypes:h,media:e,ravenSettings:d("MAWRavenUtils").deriveRavenSettings(c.ravenEphemeralType,c.ravenEphemeralMediaState),sortOrderMs:c.sortOrderMs}):d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:c.threadJid,filteredMsgIds:g,hasMediaForUI:b,hdTypes:h,media:e,sortOrderMs:c.sortOrderMs});return d("MAWMediaUtils").getBridgeMediaAnnotatedForDisplay(a,g,f)})})}))})}function q(a,b,c){return a.messages.where("msgId").anyOf(c.msgIds).toArray().then(function(a){return a.filter(function(a){return a.threadJid===b})})}function r(a,b){return d("MAWDbXMATxns").getXMAFromMsgs(a,b).then(function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){if(d("MAWXMAUtils").isXMAStoryReply(b.targetType))return d("MAWDexieTable").dexieResolve(null);if(d("MAWGetIsMediaDownloadStatusEnabled").getIsMediaDownloadStatusForXMAsEnabledWithChunkVerification()){var c=[b.defaultPreviewMediaId,b.faviconMediaId,b.headerMediaId].filter(Boolean);return d("MAWDbMediaTxns").maybeBulkGetMediaFromMediaId(a,c).then(function(c){if(c.size===0)return d("MAWBridgeXMA").createBridgeXMA(null,b,{hasMedia:!1,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1});var e=b.defaultPreviewMediaId!=null?c.get(b.defaultPreviewMediaId):null,f=b.headerMediaId!=null?c.get(b.headerMediaId):null;c=b.faviconMediaId!=null?c.get(b.faviconMediaId):null;return d("MAWHandleXmaTransactionUtil").verifyAllMediaChunksForXMA(e,c,f,a).then(function(a){var c=a.hasMedia,f=a.hasXmaFaviconMedia;a=a.hasXmaHeaderMedia;return d("MAWBridgeXMA").createBridgeXMA(e,b,{hasMedia:c,hasXmaFaviconMedia:f,hasXmaHeaderMedia:a})})})}return d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,b.defaultPreviewMediaId).then(function(c){return c==null?d("MAWBridgeXMA").createBridgeXMA(c,b,{hasMedia:!1,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1}):d("MAWDexieTable").dexieAll([c,d("MAWDbChunkTxns").hasMediaChunk(a,c==null?void 0:c.hashedPlaintextHash)]).then(function(a){var c=a[0];a=a[1];return d("MAWBridgeXMA").createBridgeXMA(c,b,{hasMedia:a,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})})})}))}).then(function(a){return a.filter(Boolean)})}function s(a,b){return d("MAWDexieTable").dexieAll(b.map(function(b){return b.receiverFetchId==null?d("MAWDexieTable").dexieResolve(null):d("MAWDbReceiverFetchTxns").maybeGetReceiverFetchInfoFromReceiverFetchId(a,b.receiverFetchId).then(function(a){return a==null?d("MAWDexieTable").dexieResolve(null):d("MAWBridgeReceiverFetchInfo").createBridgeReceiverFetchInfoPayloadFromDbInfo(b.threadJid,b.msgId,b.sortOrderMs,b.ts,a)})})).then(function(a){return a.filter(Boolean)})}function t(a,b){var c=new Map();return d("MAWDexieTable").dexieAll(b.map(function(b){if(b.type!==d("WAMsgType").MSG_TYPE.GROUP_POLL_CREATE&&b.type!==d("WAMsgType").MSG_TYPE.GROUP_POLL_UPDATE)return null;var e=b.type===d("WAMsgType").MSG_TYPE.GROUP_POLL_CREATE?b.externalId:b.pollStanzaId;if(e==null){d("MWFBLogger").MWMediaLogger.tags(["GroupPollsE2EE"]).mustfix("pollStanzaId is null for poll msg in MLV2");return null}var f=c.get(e);if(f!=null){if(f.externalId===b.externalId){return u(a,b.threadJid,e,f.msgId,d("WATimeUtils").castToMillisTime((f=f==null?void 0:f.sortOrderMs)!=null?f:0))}return null}return d("MAWDbPollTxns").maybeGetLatestPollUpdateMsg(a,e,b.threadJid).then(function(f){if(f==null){var g;return u(a,b.threadJid,e,b.msgId,d("WATimeUtils").castToMillisTime((g=b.sortOrderMs)!=null?g:0))}c.set(e,f);if(f.externalId===b.externalId){return u(a,b.threadJid,e,f.msgId,d("WATimeUtils").castToMillisTime((g=f==null?void 0:f.sortOrderMs)!=null?g:0))}else return null})})).then(function(a){return a.filter(Boolean)})["finally"](function(){c.clear()})}function u(a,b,c,e,f){return a.poll.get([b,c]).then(function(a){if(a==null){d("MWFBLogger").MWMediaLogger.tags(["GroupPollsE2EE"]).mustfix("Poll is null in MLV2");return null}return{contactIdForCurrentUser:(m||(m=d("I64"))).of_string(d("MAWCurrentUser").getID()),dbPoll:a,latestUpdateMsgId:e,latestUpdateTimestampMs:f}})}function v(a,b,e){if(!c("gkx")("15418"))return d("MAWDexieTable").dexieResolve([e,[]]);var f=e.map(function(c){return c.quote==null?null:d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,c.quote.content.externalId,b,(c=c.quote)==null?void 0:c.content.author)}).filter(Boolean);return f.length<=0?d("MAWDexieTable").dexieResolve([e,[]]):d("MAWDexieTable").dexieAll(f).then(function(a){return[e,a.filter(Boolean)]})}function w(a,b,c,e,f,g,h){h===void 0&&(h=function(){return!0});var i=d("WATimeUtils").unixTime(),j=function(a){return a.messageExpirationTs==null||a.messageExpirationTs>i};c=d("MAWLoadMsgsUtil").makeUntilWithRangeExtension(f,c,g);return n(a,b,e,f,function(a){return h(a)&&j(a)},c).then(function(c){return v(a,b,c)}).then(function(b){var c=b[0],e=b[1];return d("MAWDexieTable").dexieAll([].concat(c,e).map(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b)})).then(function(a){return{msgs:c,quoteMsgs:e,replyMediaInfo:a}})})}function x(a,b){return a.messages.where("externalId").equals(b).toArray()}function y(a,b){return x(a,b).then(function(c){c.length>1&&d("MWFBLogger").MWLogger.tags(["Pinned"]).warn("duplicate MAW msg returned for externalId",b);return d("MAWDexieTable").dexieAll(c.map(function(b){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,b)})).then(function(a){return{msgs:c,replyMediaInfo:a}})})}function z(a){a=a.filter(function(a){return a.ephemeralCounterStarted});if(a.length>0){d("MWFBLogger").MWLogger.tags([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.Countdown,d("MAWLoggerUtils").Tag.OnLoad]).DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCounter: Showing UI counter for ",""])),String(a.map(function(a){return a.msgId})));return d("MAWBridgeMsgCountdown").createBridgeMsgsStartCountdown(a).msgs}return[]}function A(a,b){return a!=null?a:d("MAWMessagesDirection").switchOnMAWMessagesDirection(b,{after:Number.MIN_SAFE_INTEGER,before:Number.MAX_SAFE_INTEGER})}function a(a){var b=a.chatJid,c=a.config,e=a.db,f=a.direction,g=a.range,h=d("WATimeUtils").unixTime();a=function(a){var b=a.messageExpirationTs!=null&&a.messageExpirationTs<h,e=a.type===d("WAMsgType").MSG_TYPE.ADMIN&&!c.admin;a=a.isCollapsed===!0;return!b&&!e&&!a};var j=g.includeLowerBoundMsg?g.numMsgs:g.numMsgs+1;j=d("MAWLoadMsgsUtil").makeUntilWithRangeExtensionBothDirections(j);var k=A(g.lowerBoundSortOrderMs,f);return n(e,b,f,k,a,j).then(function(a){return v(e,b,a)}).then(function(a){var b=a[0],c=a[1],h=d("MAWLoadMessagesRequest").getMsgsForRange(b,g,f);return d("MAWDexieTable").dexieAll([].concat(h,c).map(function(a){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,a)})).then(function(a){return{msgsForRange:h,quotedMsgs:c,replyMediaInfo:a}})}).then(function(a){var h=a.msgsForRange,j=a.quotedMsgs;a=a.replyMediaInfo;d("MWFBLogger").MWLogger.tags(["MAWSecureLocalDBDataSource"]).DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["LoadMoreMsgs, chatJid: ",", range: ",".}"])),b,String(g));return B(e,h,j,a,f,g.numMsgs,c,b)})}function b(a,b,c,e,f,g,h,i){var k=A(f,e);return w(a,b,c,e,k,h,function(a){var b=a.isCollapsed===!0;a=!i.admin&&a.type===d("WAMsgType").MSG_TYPE.ADMIN;return!(b||a)}).then(function(f){var l=f.msgs,m=f.quoteMsgs;f=f.replyMediaInfo;var n=l;g||(n=n.filter(function(a){return a.msgId!==h}),n.length===l.length&&l.length!==0&&d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.LOAD_MORE_NO_ORIGINAL_MSG_IN_MAW,key:"mismatch"}));d("MWFBLogger").MWLogger.tags(["MAWSecureLocalDBDataSource"]).DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["LoadMoreMsgs: From:"," orignalMsgId:",", chatJid: ",""])),k,h,b);return B(a,n,m,f,e,c,i,b)})}function B(a,b,c,e,f,g,h,i){var j=b.length;if(j===0)return d("MAWDexieTable").dexieResolve({editMsgHistory:[],expiringCountdown:[],hasMoreAfter:D(j,g,f),hasMoreBefore:C(j,g,f),medias:[],msgs:[],polls:[],quotedMsgs:[],reactions:[],receiverFetchInfoPayloads:[],xmas:[]});var l=b.map(function(a,b){if(d("MAWXMAUtils").isXMAStoryReply(a.xmaMessageType))return;return d("MAWBridgeMsg").createBridgeMsg(a,void 0,(e||[])[b])}).filter(Boolean),m=z(b);d("MWFBLogger").MWLogger.tags(["MAWSecureLocalDBDataSource"]).DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["LoadMoreMsgs, chatJid: ",", result: ",""])),i,String(l.map(function(a){return a.msgId+":"+a.sortOrderMs})));return d("MAWDexieTable").dexieAll([h.reactions?o(a,b):d("MAWDexieTable").dexieResolve([]),h.media?p(a,b):d("MAWDexieTable").dexieResolve([]),h.xma?r(a,b):d("MAWDexieTable").dexieResolve([]),h.editMsgHistory?d("MAWDbEditMsgHistoryTxns").loadEditMsgHistory(a,b):d("MAWDexieTable").dexieResolve([]),h.receiverFetch?s(a,b):d("MAWDexieTable").dexieResolve([]),h.polls?t(a,b):d("MAWDexieTable").dexieResolve([])]).then(function(a){var b=a[0],e=a[1],h=a[2],i=a[3],k=a[4];a=a[5];return{editMsgHistory:i,expiringCountdown:m,hasMoreAfter:D(j,g,f),hasMoreBefore:C(j,g,f),medias:e,msgs:l,polls:a,quotedMsgs:c.map(function(a){return d("MAWBridgeMsg").createBridgeMsg(a)}),reactions:b,receiverFetchInfoPayloads:k,xmas:h}})}function C(a,b,c){switch(c){case"before":return a>=b;default:c;return!0}}function D(a,b,c){switch(c){case"after":return a>=b;default:c;return!0}}function e(a,b,c){return y(a,b).then(function(e){var f=e.msgs,g=e.replyMediaInfo;if(f.length===0)return{editMsgHistory:[],medias:[],msgs:[],polls:[],reactions:[],receiverFetchInfoPayloads:[],xmas:[]};var h=f.map(function(a,b){if(d("MAWXMAUtils").isXMAStoryReply(a.xmaMessageType))return;return d("MAWBridgeMsg").createBridgeMsg(a,void 0,(g||[])[b])}).filter(Boolean);d("MWFBLogger").MWLogger.tags(["MAWFetchMessageByPinnedExternalId"]).DEBUG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["LoadMsgsByExternalId: From: externalId:",". ",""])),b,String(h.map(function(a){return""+a.msgId})));return d("MAWDexieTable").dexieAll([c.reactions?o(a,f):d("MAWDexieTable").dexieResolve([]),c.media?p(a,f):d("MAWDexieTable").dexieResolve([]),c.xma?r(a,f):d("MAWDexieTable").dexieResolve([]),c.editMsgHistory?d("MAWDbEditMsgHistoryTxns").loadEditMsgHistory(a,f):d("MAWDexieTable").dexieResolve([]),c.receiverFetch?s(a,f):d("MAWDexieTable").dexieResolve([]),c.polls?t(a,f):d("MAWDexieTable").dexieResolve([])]).then(function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4];a=a[5];return{editMsgHistory:e,medias:c,msgs:h,polls:a,reactions:b,receiverFetchInfoPayloads:f,xmas:d}})})}g.loadMoreMsgsAndMediaForRange=a;g.loadMoreMsgsAndMediaFromTs=b;g.loadMsgsAndMediaByExternalId=e}),98);
__d("MAWLoadMsgsTxns",["MAWIndexedDb","MAWLoadMsgsTxnsV2","qex"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e,f,g){f===void 0&&(f=!1);g===void 0&&(g="before");return d("MAWLoadMsgsTxnsV2").loadMoreMsgsAndMediaFromTs(a,b,e,g,null,f,null,{admin:!0,editMsgHistory:!0,media:!0,polls:!0,reactions:!0,receiverFetch:!0,xma:!0}).then(function(a){var b=a.editMsgHistory,e=a.expiringCountdown,f=a.hasMoreAfter,g=a.hasMoreBefore,h=a.medias,i=a.msgs,j=a.reactions,k=a.receiverFetchInfoPayloads;a=a.xmas;var l=!c("qex")._("4739");i.length>0&&d("MAWIndexedDb").afterTransaction({tag:"NewMsgs",value:{msgs:i}});e.length>0&&d("MAWIndexedDb").afterTransaction({tag:"MsgsStartCountdown",value:{msgs:e}});j.filter(function(a){return a.type==="upsert"}).forEach(function(a){return d("MAWIndexedDb").afterTransaction({tag:"UpsertReaction",value:a.reaction},l)});j.filter(function(a){return a.type==="delete"}).forEach(function(a){return d("MAWIndexedDb").afterTransaction({tag:"DeleteReaction",value:a.reaction},l)});a.forEach(function(a){return d("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:a})});b.length>0&&d("MAWIndexedDb").afterTransaction({tag:"EditMsgHistoryAdded",value:b},l);h.forEach(function(a){return d("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:a})});k.forEach(function(a){return d("MAWIndexedDb").afterTransaction({tag:"NewReceiverFetchInfo",value:a})});return{hasMoreAfter:f,hasMoreBefore:g}})}g.loadMsgAndMedia_COMPAT=a}),98);
__d("MAWLoadOneToOneMessageRequestCapabilitiesTxn",["MAWDexieTable","MAWIndexedDb","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a){a.map(d("WAJids").interpretAsUserJid).forEach(function(a){return a!=null&&d("MAWIndexedDb").afterTransaction({tag:"OneToOneMessageRequestLoaded",value:{fbid:d("WAJids").extractUserId(a),threadJid:a}})});return d("MAWDexieTable").dexieResolve()}g.loadOneToOneMessageRequestCapabilities=a}),98);
__d("MAWLoadThreadsTxns",["FBLogger","I64","MAWBridgeThread","MAWBridgeTypesCreators","MAWDbParticipantTxns","MAWDexieTable","MAWIndexedDb","MAWLoadGroupInvitesTxns","MAWLoadMsgsTxns","MAWLoadOneToOneMessageRequestCapabilitiesTxn","MAWMpsGating","MAWThreadMappingQPL","MAWTransactionMode","MAWUserJidWrapper","WAJids","WALogger","emptyFunction","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c,e,f){f===void 0&&(f="unknown");b.forEach(function(a){var b=d("MAWThreadMappingQPL").getInstanceKeyForJidInWorker(a.jid);d("MAWThreadMappingQPL").startInWorker({instanceKey:b,jid:a.jid,threadKey:a.optimisticThreadKey==null?void 0:(h||(h=d("I64"))).of_string(a.optimisticThreadKey),trigger:"loadContentsForThreads_"+f});d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(a,e==null?void 0:e.get(a.jid),void 0,"loadContentsForThreads_"+f,null,b)})});return d("MAWMpsGating").isFullMpsEnabled()?d("MAWDexieTable").dexieResolve(b):d("MAWDexieTable").dexieAll([].concat(b.map(function(b){return d("MAWLoadMsgsTxns").loadMsgAndMedia_COMPAT(a,b.jid,c,!0)}),[i(a,b),d("MAWLoadOneToOneMessageRequestCapabilitiesTxn").loadOneToOneMessageRequestCapabilities(b.map(function(a){return a.jid})),d("MAWLoadGroupInvitesTxns").loadGroupInvites(a,b)])).then(function(){return b})}function i(a,b){var e=[];b.forEach(function(a){return d("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(a){return e.push(a)},user:c("emptyFunction")})});return a.groupInfo.bulkGet(e).then(function(a){a.forEach(function(a){a!=null&&d("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(a)})})})}b=function(a){a=a.threadJid;return j(a)};var j=d("MAWIndexedDb").makeMsgrTransactor({participants:d("MAWTransactionMode").READONLY},"checkIfGroupParticipant",function(a){return function(){for(var b=arguments.length,c=new Array(b),d=0;d<b;d++)c[d]=arguments[d];return k.apply(void 0,[a].concat(c))}});function k(a,b,e,f,g,h){e===void 0&&(e=!0);f===void 0&&(f=!0);var i=d("MAWUserJidWrapper").getMyUserJid();return d("MAWDbParticipantTxns").getParticipant(a,b,i).then(function(a){if(!a.success){var j=e?"group":"one_to_one";d("WALogger").LOG(["[Occamadillo] User is not a participant of "+j+" thread\n        "+b.toString()+", showing a VIEWER_NOT_SUBSCRIBED composer blocker"]);if(g==null){var k;c("FBLogger")("maw_db","checkIfParticipant").catching((k=a.payload)!=null?k:c("err")(a.error)).warn("[Occamadillo] User %s is not a participant of %s thread %s, occam: %s, archived: %s, cannotReplyReason null.",i,j,b.toString(),f,h)}c("FBLogger")("labyrinth_web","checkIfParticipant").warn("[Occamadillo] User not a participant from checkIfParticipant");k={cannotReplyReason:"viewer_not_subscribed",threadJid:b};d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread(k)})}})}g.loadContentsForThreads=a;g.loadGroups=i;g.checkIfGroupParticipant=b}),98);
__d("MAWDbGroupInfoTxns",["MAWBridgeTypesCreators","MAWIndexedDb","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return h(a,b.jid).then(function(c){var d=b.participantVersion;c.success&&c.value.participantVersion!=null&&b.participantVersion==null&&(d=c.value.participantVersion);c=b.subject.content;c!=null&&c.length===0&&(c=void 0);var e={creationTs:b.creationTs,creator:b.creator,groupJid:b.jid,inviter:b.inviter,memberAddMode:b.memberAddMode,name:c,nameOwner:b.subject.user,nameTs:b.subject.ts,participantVersion:d};return i(a,e).then(function(){return e})})}function h(a,b){return a.groupInfo.get({groupJid:b}).then(function(a){return a==null?d("WAResultOrError").makeError("missing"):d("WAResultOrError").makeResult(a)})}function i(a,b){return a.groupInfo.put(b).then(function(){d("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(b)})})}function b(a,b){return a.groupInfo.bulkPut(b).then(function(){b.forEach(function(a){return d("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(a)})})})}function c(a,b){return a.groupInfo.bulkGet(b)}function e(a,b){return a.groupInfo["delete"](b)}g.putGroupInfo=a;g.getGroupInfo=h;g.updateGroupInfo=i;g.bulkUpdateGroupInfo=b;g.getGroupInfos=c;g.deleteGroupInfo=e}),98);
__d("MAWGroupInviteManagementTxns",["MAWDbGroupInviteTxns","MAWDbParticipantTxns","MAWDexieTable","MAWUserJidWrapper"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=!1;return d("MAWDbParticipantTxns").getInvitedParticipantsInThread(a,b).then(function(e){if(e.length===0){c=!0;var f=d("MAWUserJidWrapper").getMyUserJid();return d("MAWDbGroupInviteTxns").deleteGroupInvitesByThreadAndInvitedParticipant(a,b,f).then(function(){return c})}else{var g=[];e.forEach(function(c){g.push(d("MAWDbGroupInviteTxns").deleteGroupInvitesByThreadAndInvitedParticipant(a,b,c.userJid))});return d("MAWDexieTable").dexieAll(g).then(function(){return c})}})}g.deleteGroupInvitesByThread=a}),98);
__d("MAWThreadManagementTxns",["MAWBridgeEventTransmitter","MAWBridgeParticipants","MAWBridgeTypesCreators","MAWDbGroupInfoTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbParticipantTxns","MAWDbReactionsTxns","MAWDbThreadTxns","MAWDexieTable","MAWGetOrCreateThreadTxns","MAWGroupInviteManagementTxns","MAWIndexedDb","MAWLoadOneToOneMessageRequestCapabilitiesTxn","MAWQplProxy","WAJids","WALogger","WAMsgType","WASortedLists","WATimeUtils","qex","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,e,f){var g=b.authoritativeThreadKey,h=b.createTs,i=b.description,j=b.folder,k=b.lastActivityTimestamp,m=b.lastReadWatermarkTimestamp,n=b.offlineThreadingId,o=b.skipVerifyThread,p=b.userJid;return d("MAWGetOrCreateThreadTxns").getOrCreateThread(a,{authoritativeThreadKey:g,clientThreadKey:n,createTs:h,description:i,folder:j,instanceKey:f,jid:p,lastActivityTimestamp:k,lastReadWatermarkTimestamp:m,skipVerifyThread:o},e).then(function(b){var g=b.created;b=b.thread;e!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25313175,"1551"),"process-setup-thread-start",{instanceKey:e});f!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(1056836502,"2778"),"process_setup_thread_start",{instanceKey:f});g=l(a,p,g,b);e!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25313175,"1551"),"process-setup-thread-end",{instanceKey:e});f!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(1056836502,"2778"),"process_setup_thread_end",{instanceKey:f});return g})}function b(a,b,c,e){return d("MAWDbGroupInfoTxns").getGroupInfo(a,b).then(function(b){if(!b.success)return null;var f=b.value;return d("MAWGetOrCreateThreadTxns").getOrCreateThread(a,{createTs:d("WATimeUtils").castUnixTimeToMillisTime(f.creationTs),description:"getOrRepairGroupThread",folder:c,jid:f.groupJid,skipVerifyThread:e}).then(function(a){var b=a.created;a=a.thread;return{created:b,groupInfo:f,thread:a}})})}function i(a,b){var c=[],e=[];b.forEach(function(a){d("MAWDbMsg").isMediaMsg(a)&&a.mediaId!=null&&(c.push(a.mediaId),e.push(a.msgId))});return a.media.bulkGet(c).then(function(b){var c=[],f=[];b.forEach(function(a,b){if(a!=null){var g=e[b];a.msgIds=d("WASortedLists").filter(a.msgIds,function(a){return a!==g});a.mediaEntries["delete"](g);a.msgIds.length===0&&a.mediaEntries.size===0&&(a.plaintextHash!=null&&c.push(a.hashedPlaintextHash),f.push(a.mediaId))}});b=a.media.bulkDelete(f);var g=a.chunk.where("hashedPlaintextHash").anyOf(c)["delete"]();return d("MAWDexieTable").dexieAll([b,g]).then(function(){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted "," media rows and "," chunk rows"])),f.length,c.length)})})}function j(a,b){return d("MAWDbMsgTxns").getThreadNewestMessageMs(a,b.jid).then(function(c){return a.messages.where("threadJid").equals(b.jid).toArray().then(function(d){return k(a,b,c,d,!0)})})}function e(a,b,c,e){var f=c==null?void 0:c.lastMessageTimestamp;if(c==null)return j(a,b);var g=a.messages.where("threadJid").equals(b.jid).toArray(),h=d("MAWDbMsgTxns").getThreadNewestMessageMs(a,b.jid);return d("MAWDexieTable").dexieAll([g,h]).then(function(g){var h=g[0];g=g[1];var i=[],j=new Set();f!=null&&h.forEach(function(a){var b;b=(b=a.originalTs)!=null?b:a.ts;b<=f+1&&(j.add(a.msgId),i.push(a))});if((c==null?void 0:c.messages.length)!==0){var l=new Set();c.messages.forEach(function(a){l.add((a=a.key)==null?void 0:a.id)});h.forEach(function(a){l.has(a.externalId)&&!j.has(a.msgId)&&(j.add(a.msgId),i.push(a))})}if(i.length!==h.length)for(var m of h)if(!j.has(m.msgId)&&m.type!==d("WAMsgType").ADMIN)return k(a,b,g,i,!1,e);return k(a,b,g,h,!0,e)})}function k(a,b,e,f,g,h){var j=d("WAJids").interpretAsGroupJid(b.jid),k=g?d("MAWDbThreadTxns").deleteThread(a,b.jid):d("MAWDexieTable").dexieResolve(),l=g?d("MAWDbParticipantTxns").deleteAllParticipantsForThread(a,b.jid):d("MAWDexieTable").dexieResolve(),m=d("MAWDexieTable").dexieResolve(!1),n=d("MAWDexieTable").dexieResolve();j!=null&&g&&(m=d("MAWGroupInviteManagementTxns").deleteGroupInvitesByThread(a,j),n=d("MAWDbGroupInfoTxns").deleteGroupInfo(a,j));return d("MAWDexieTable").dexieAll([i(a,f),d("MAWDbReactionsTxns").deleteAllReactionsForMessages(a,f),d("MAWDbMsgTxns").deleteMessages(a,f,h),k,l,n,m]).then(function(a){a[0];a[1];a[2];a[3];a[4];a[5];a=a[6];g?(d("MAWBridgeEventTransmitter").deleteMessagesOfThreadAfterTxn(b,e),j!=null&&a&&d("MAWIndexedDb").afterTransaction({tag:"DeleteGroupInvite",value:d("MAWBridgeTypesCreators").createBridgeDeleteGroupInvite(b.jid)}),d("MAWIndexedDb").afterTransaction({tag:"ThreadHiddenV2",value:b.jid})):c("qex")._("4486")||d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(b.jid,f)});return{deletedMessages:f.map(function(a){return d("MAWDbMsg").getWAMsgId(a)})}})}function l(a,b,c,e){a=d("MAWDbParticipantTxns").bulkRemoveIncorrectAndInsertMissingParticipantsInOneToOneThread(a,b).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:d("MAWBridgeParticipants").createBridgeParticipants(a)})});return d("MAWDexieTable").dexieAll([d("MAWLoadOneToOneMessageRequestCapabilitiesTxn").loadOneToOneMessageRequestCapabilities([e.jid]),a]).then(function(){return{created:c,thread:e}})}g.getOrSetupOneToOneThread=a;g.getGroupThread=b;g.deleteAllThreadData=j;g.metaSyncChatDeleteThread=e}),98);
__d("MAWGroupInfoStore",["MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieCastToPromise","MAWDexieTable","MAWFolderTypes","MAWGetOrCreateThreadTxns","MAWIndexedDb","MAWLoadThreadsTxns","MAWThreadManagementTxns","MAWTransactionMode","WAResultOrError","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return a!=null&&typeof a==="object"&&a.groupStatus!=null&&typeof a.groupStatus==="string"?a.groupStatus:void 0}function i(a){return a!=null&&typeof a==="object"&&a.clientThreadKey!=null&&typeof a.clientThreadKey==="string"?a.clientThreadKey:void 0}function j(a){return a!=null&&typeof a==="object"&&a.folder!=null&&typeof a.folder==="number"?a.folder:void 0}function k(a){return a!=null&&typeof a==="object"&&a.updateParticipantMedatadata!=null&&typeof a.updateParticipantMedatadata==="boolean"?a.updateParticipantMedatadata:void 0}function l(a){return a===null?{}:a}a=function(){function a(a){var b=this;this.get=function(a,c){c=j(c);return d("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(d("MAWThreadManagementTxns").getGroupThread(b.db,a,c).then(function(a){return a!=null?a:null}).then(function(a){return a==null?d("WAResultOrError").makeError("missing_group"):d("MAWLoadThreadsTxns").loadContentsForThreads(b.db,[a.thread],1,null,"getGroupInfoStore").then(function(){return a.groupInfo}).then(function(a){return d("WAResultOrError").makeResult(m(a))})}))};this.create=function(a,c){var e=h(c)==="added"?d("WATimeUtils").millisTime():d("WATimeUtils").castUnixTimeToMillisTime(a.creationTs);return d("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(d("MAWGetOrCreateThreadTxns").getOrCreateThread(b.db,{clientThreadKey:i(c),createTs:e,description:"MAWGroupInfoStore-create",folder:d("MAWFolderTypes").FOLDER_ID.INBOX,jid:a.jid}).then(function(c){var e=c.created,f=c.thread,g=n(a);return d("MAWDexieTable").dexieAll([b.db.groupInfo.put(g),d("MAWDbMsgTxns").getThreadNewestMessageId(b.db,f.jid)]).then(function(a){a[0],a[1],d("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(g)})}).then(function(){return f.archived===!0?d("MAWDbThreadTxns").unarchiveThreads(b.db,[f.jid]):d("MAWDexieTable").dexieResolve()}).then(function(){return e?d("WAResultOrError").makeResult(g.groupJid):d("WAResultOrError").makeError("existing")})}))};this["delete"]=function(a){return d("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(d("MAWDexieTable").dexieAll([b.db.threads.get({jid:a}),b.db.groupInfo["delete"](a)]).then(function(a){a=a[0];return a==null?d("WAResultOrError").makeError("missing_group"):d("MAWDexieTable").dexieAll([d("MAWDbThreadTxns").deleteThread(b.db,a.jid),b.db.participants.where("threadJid").equals(a.jid)["delete"]()]).then(function(){return d("WAResultOrError").makeResult()})}))};this.update=function(a,c,e){return d("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(b.db.threads.get({jid:a}).then(function(f){return f==null?d("WAResultOrError").makeError("missing_group"):b.db.groupInfo.get(a).then(function(a){if(a==null)return d("WAResultOrError").makeError("missing_group");a=m(a);a=c(a);var g=n(a);return b.db.groupInfo.put(g).then(function(){d("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(g)});k(e)===!0&&d("MAWIndexedDb").afterTransaction({tag:"UpdateE2EEMetadataParticipants",value:d("MAWBridgeTypesCreators").createBridgeUpdateE2EEMetadataParticipants(f.jid)});return d("WAResultOrError").makeResult()})})}))};this.clear=function(){return d("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(b.db.groupInfo.clear())};this.db=a}var b=a.prototype;b.has=function(a){return d("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(this.db.groupInfo.get(a).then(function(a){return a!=null?!0:!1}))};return a}();a.tableLocks={chunk:(b=d("MAWTransactionMode")).READONLY,editMsgHistory:b.READONLY,groupInfo:b.READWRITE,groupInvites:b.READONLY,media:b.READONLY,messages:b.READWRITE,participants:b.READWRITE,poll:b.READONLY,reactions:b.READONLY,receiverFetchInfo:b.READONLY,threads:b.READWRITE,xma:b.READONLY};function m(a){return babelHelpers["extends"]({jid:a.groupJid},l(a.creator!=null?{creator:a.creator}:null),{creationTs:a.creationTs},l(a.participantVersion!=null?{participantVersion:a.participantVersion}:null),{inviter:a.inviter,memberAddMode:a.memberAddMode,subject:babelHelpers["extends"]({content:a.name},l(a.nameOwner!=null?{user:a.nameOwner}:null),l(a.nameTs!=null?{ts:a.nameTs}:null))})}function n(a){var b=a.subject.content;b!=null&&b.length===0&&(b=void 0);return{creationTs:a.creationTs,creator:a.creator,groupJid:a.jid,inviter:a.inviter,memberAddMode:a.memberAddMode,name:b,nameOwner:a.subject.user,nameTs:a.subject.ts,participantVersion:a.participantVersion}}g.MAWGroupInfoStore=a}),98);
__d("MAWThreadFetchAndEmitTxns",["MAWDexieTable","MAWLoadGroupInvitesTxns","MAWLoadOneToOneMessageRequestCapabilitiesTxn","MAWLoadThreadsTxns","MAWThreadManagementTxns","WAJids","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f){f===void 0&&(f="fetchAndEmitThread");return d("WAJids").switchOnMsgrChatJidType(b,{group:function(b){return d("MAWThreadManagementTxns").getGroupThread(a,b,c).then(function(a){return a==null?null:{created:a.created,thread:a.thread}})},user:function(b){return d("MAWThreadManagementTxns").getOrSetupOneToOneThread(a,{createTs:e==null?void 0:d("WATimeUtils").castUnixTimeToMillisTime(e),description:f,folder:c!=null?c:void 0,userJid:b})}}).then(function(b){return b==null||b.thread==null?null:d("MAWLoadThreadsTxns").loadContentsForThreads(a,[b.thread],1,null,f).then(function(){return b})})}function b(a,b){if(b.size===0)return d("MAWDexieTable").dexieResolve();b=Array.from(b);return a.threads.where("jid").anyOf(b).toArray().then(function(b){b=b.filter(Boolean);return d("MAWDexieTable").dexieAll([d("MAWLoadThreadsTxns").loadGroups(a,b),d("MAWLoadOneToOneMessageRequestCapabilitiesTxn").loadOneToOneMessageRequestCapabilities(b.map(function(a){return a.jid})),d("MAWLoadGroupInvitesTxns").loadGroupInvites(a,b)])}).then(c("emptyFunction"))}g.fetchAndEmitThread=a;g.emitThreadContents=b}),98);
__d("MAWMessageStore",["MAWAckLevel","MAWAuthor","MAWBridgeMsg","MAWDbMsgTxns","MAWDbThread","MAWDexieCastToPromise","MAWDexieTable","MAWFolderTypes","MAWIndexedDb","MAWLocalizationUtils","MAWMsgType","MAWThreadFetchAndEmitTxns","MAWTransactionMode","MAWWriteMsgTxns","WAJids","WALogger","WAResultOrError","WATimeUtils","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a){if(a!=null&&typeof a==="object"&&a.optimisticMsg!=null){a=a.optimisticMsg;if(typeof a.msgId==="string"&&typeof a.ts==="number")return{msgId:a.msgId,ts:a.ts}}return void 0}function j(a){return a!=null&&typeof a==="object"&&a.openMessageOtid!=null&&typeof a.openMessageOtid==="string"?a.openMessageOtid:void 0}function k(a){if(a!=null&&typeof a==="object"&&a.folder!=null&&typeof a.folder==="number")if(a.folder===d("MAWFolderTypes").FOLDER_ID.INBOX)return d("MAWFolderTypes").FOLDER_ID.INBOX;else if(a.folder===d("MAWFolderTypes").FOLDER_ID.PENDING)return d("MAWFolderTypes").FOLDER_ID.PENDING;else if(a.folder===d("MAWFolderTypes").FOLDER_ID.OTHER)return d("MAWFolderTypes").FOLDER_ID.OTHER;else if(a.folder===d("MAWFolderTypes").FOLDER_ID.ARCHIVED)return d("MAWFolderTypes").FOLDER_ID.ARCHIVED;return null}a=function(){function a(a){this.db=a}var b=a.prototype;b.create=function(a,b){var e=this,f=i(b),g=j(b);b=k(b);return d("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(d("MAWThreadFetchAndEmitTxns").fetchAndEmitThread(this.db,a.id.chat,b,void 0,"MAWMessageStore_DEPRECATED-create").then(function(b){if(b==null)return d("WAResultOrError").makeError({type:"missing_thread"});b=b.thread;if(a.type===d("MAWMsgType").MSG_TYPE.TEXT){var h=void 0;a.ephemeralSetting!=null&&(h={ephemeralExpirationInSec:a.ephemeralSetting.expirationTs,ephemeralLastUpdatedOrSetTimestamp:a.ephemeralSetting.updatedTs});h={ack:a.ack,altIndex:void 0,author:a.id.author,ephemeralSetting:h,externalId:a.id.externalId,forwardingScore:a.forwardingScore,isForwarded:a.forwardingScore>0,msgContent:{content:((h=a.msgContent)==null?void 0:h.content)||""},serverTs:a.serverTs,threadJid:b.jid,ts:a.ts,type:d("MAWMsgType").MSG_TYPE.TEXT};return d("MAWWriteMsgTxns").writeMsg(e.db,h,b,{openMessageOtid:g,optimisticMsg:f}).then(function(){return d("WAResultOrError").makeResult()})}else if(a.type===d("MAWMsgType").MSG_TYPE.ICDC_ALERT){h={ack:a.ack,altIndex:void 0,author:a.id.author,externalId:a.id.externalId,msgContent:{adminType:a.msgContent.adminType,authorName:a.msgContent.authorName},serverTs:a.serverTs,threadJid:b.jid,ts:a.ts,type:d("MAWMsgType").MSG_TYPE.ICDC_ALERT};return d("MAWWriteMsgTxns").writeMsg(e.db,h,b,{openMessageOtid:g,optimisticMsg:f}).then(function(){a.hasUnknownName&&!d("WAJids").isAuthorMe(a.id.author)&&!d("WAJids").isAuthorSystem(a.id.author)&&d("MAWIndexedDb").afterTransaction({tag:"SyncContacts",value:[d("WAJids").userIdFromJid(a.id.author)]});return d("WAResultOrError").makeResult()})}else if(a.type===d("MAWMsgType").MSG_TYPE.ADMIN){h={ack:a.ack,altIndex:void 0,author:d("WAJids").AUTHOR_SYSTEM,externalId:a.id.externalId,msgContent:babelHelpers["extends"]({},a.msgContent,{version:d("MAWLocalizationUtils").isAdminMsgNormalized(a.msgContent.adminType)?1:0}),serverTs:a.serverTs,threadJid:b.jid,ts:a.ts,type:a.type};return d("MAWWriteMsgTxns").writeMsg(e.db,h,b).then(function(){return d("WAResultOrError").makeResult()})}throw c("err")("non renderable store not implemented yet")}))};b.get=function(a){return d("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(d("MAWDexieTable").dexieAll([this.db.threads.get({jid:a.chat}),this.db.messages.where("externalId").equals(a.externalId).toArray()]).then(function(b){var c,e=b[0];b=b[1];if(e==null)return d("MAWDexieTable").dexieResolve(null);b=b.find(function(b){return b.threadJid===e.jid&&b.author===a.author});return b==null||b.type!=="Text"?d("MAWDexieTable").dexieResolve(null):d("MAWDexieTable").dexieResolve({ack:b.ack,forwardingScore:(c=b.forwardingScore)!=null?c:0,id:a,msgContent:{content:b.msgContent.content},ts:b.ts,type:b.type})}))};b.update=function(a){var b=this;return d("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(d("MAWDexieTable").dexieAll([this.db.threads.get({jid:a.id.chat}),this.db.messages.where("externalId").equals(a.id.externalId).toArray()]).then(function(c){var e=c[0];c=c[1];if(e==null)return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("missing"));var f=c.find(function(b){return b.threadJid===e.jid&&b.author===a.id.author});if(f==null||f.type!=="Text")return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("missing"));c=f.ack<d("MAWAckLevel").ACK.sent;f.ack=a.ack;f.ts=a.ts;f.serverTs=a.sentTs;var g=void 0;a.ephemeralSetting!=null&&(g={ephemeralExpirationInSec:a.ephemeralSetting.expirationTs,ephemeralLastUpdatedOrSetTimestamp:a.ephemeralSetting.updatedTs});f.ephemeralSetting=g;g=a.sentTs;g=g==null?g:d("WATimeUtils").castUnixTimeToMillisTime(g);c=g!=null&&c?b.db.threads.put(babelHelpers["extends"]({},e,{newestMsgTs:g,threadOrder:d("MAWDbThread").craftThreadOrder(g,e.jid)})):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([b.db.messages.put(f),c]).then(function(){var a=null;d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(f,void 0,a)});return d("WAResultOrError").makeResult()})}))};b.deleteReactionsForMsg=function(a){var b=this;return d("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(this.db.reactions.where("reactToExternalId").equals(a.externalId).filter(function(b){return d("MAWAuthor").getAuthorUserJid(b.reactToAuthor)===d("MAWAuthor").getAuthorUserJid(a.author)&&b.threadJid===a.chat}).toArray().then(function(a){return b.db.reactions.bulkDelete(a.map(function(a){return a.rowId}))}))};b.bulkDelete=function(a){var b=this,c=d("MAWDexieTable").dexieAll(a.map(function(a){var c=a.author,e=a.chat;a=a.externalId;var f=d("MAWAuthor").getAuthorUserJid(c);return b.db.reactions.where("reactToExternalId").equals(a).filter(function(a){return d("MAWAuthor").getAuthorUserJid(a.reactToAuthor)===f&&a.threadJid===e}).toArray()})).then(function(a){return a.flat()}).then(function(a){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted: "," reactions rows."])),a.length);return b.db.reactions.bulkDelete(a.map(function(a){return a.rowId}))});return d("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(d("MAWDbMsgTxns").getMsgsByProtocolMsgId(this.db,a).then(function(a){var e=a.map(function(a){return a.rowId});return d("MAWDexieTable").dexieAll([b.db.messages.bulkDelete(e),c]).then(function(){return e.length})}))};b.bulkGetInGroup=function(a){return d("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(this.db.messages.where("threadJid").equals(a).toArray()).then(function(b){return b==null||b.length===0?[]:b.map(function(b){return{author:b.author,chat:a,externalId:b.externalId}})})};return a}();a.tableLocks={chunk:(b=d("MAWTransactionMode")).READONLY,ftsBackloggedMessages:b.READWRITE,groupInfo:b.READWRITE,groupInvites:b.READONLY,media:b.READONLY,messages:b.READWRITE,participants:b.READWRITE,poll:b.READONLY,reactions:b.READWRITE,receiverFetchInfo:b.READONLY,threads:b.READWRITE,xma:b.READONLY};g.MAWMessageStore_DEPRECATED_DO_NOT_USE=a}),98);
__d("WAResultOrErrorUtils",[],(function(a,b,c,d,e,f){"use strict";function a(a){var b=[];a.forEach(function(a){a.success&&b.push(a.value)});return b}function b(a){var b=[];a.forEach(function(a){a.success||b.push(a.error)});return b}f.unpackValues=a;f.unpackErrors=b}),66);
__d("MAWParticipantsStore",["MAWBridgeParticipants","MAWBridgeTypesCreators","MAWDbParticipant","MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieCastToPromise","MAWDexieTable","MAWIndexedDb","MAWTransactionMode","WAArrayGroupBy","WAArrayZip","WAGlobals","WAResultOrError","WAResultOrErrorUtils","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";a=function(a){var b=this;this.bulkGetInGroup=function(a){return d("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(b.db.threads.get({jid:a}).then(function(a){return a!=null?d("MAWDbParticipantTxns").getParticipantsInThread(b.db,a.jid).then(function(b){return d("WAResultOrError").makeResult(b.map(function(b){return h(b,a.jid)}))}):d("WAResultOrError").makeError("missing_group")}))};this.bulkPut=function(a){return d("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(k(b.db,a.map(function(a){a=a.chatJid;return a})).then(function(b){return d("WAResultOrErrorUtils").unpackValues(a.map(function(a){return!b.has(a.chatJid)?d("WAResultOrError").makeError():d("WAResultOrError").makeResult({participantId:d("MAWDbParticipant").craftParticipantId(a.chatJid,a.user),waParticipant:a})}))}).then(function(a){return b.db.participants.bulkGet(a.map(function(a){a=a.participantId;return a})).then(function(b){return d("WAArrayZip").zip(a,b).map(function(a){var b=a[0].waParticipant;a=a[1];return{chatJid:b.chatJid,dbParticipantToPut:babelHelpers["extends"]({deliveredWatermarkTs:d("WATimeUtils").castToUnixTime(0),lastReadWatermarkTs:d("WATimeUtils").castToUnixTime(0)},a,i(b)),existed:a!=null,participant:b}})})}).then(function(a){var c=a.map(function(a){a=a.dbParticipantToPut;return babelHelpers["extends"]({},a)});c.forEach(function(a){return d("MAWDbParticipantTxns").logIfIllegalParticipant(a,"MAWParticipantsStore::bulkPut")});return b.db.participants.bulkPut(c).then(function(){return l(b.db,a)})}))};this.bulkDelete=function(a,c){c=c||{};var e=c.remover,f=d("WAArrayGroupBy").groupBy(a.map(function(a,b){return{index:b,key:a}}),function(a){a=a.key;return a.groupJid});c=f.map(function(a){a=a[0];return a});return d("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(k(b.db,c).then(function(a){return f.flatMap(function(b){var c=b[0];b=b[1];return b.map(function(b){var e=b.index;b=b.key;return!a.has(c)?d("WAResultOrError").makeError({index:e,message:"missing_group"}):d("WAResultOrError").makeResult({groupJid:c,index:e,participantId:d("MAWDbParticipant").craftParticipantId(c,b.userJid),participantKey:[c,b.userJid],userJid:b.userJid})})})}).then(function(a){var c=d("WAResultOrErrorUtils").unpackValues(a),e=d("WAResultOrErrorUtils").unpackErrors(a).map(function(a){return d("WAResultOrError").makeError(a)});a=c.map(function(a){a=a.participantId;return a});return b.db.participants.bulkGet(a).then(function(a){return d("WAArrayZip").zip(c,a).map(function(a){var b=a[0];a=a[1];return a==null?d("WAResultOrError").makeError({index:b.index,message:"missing_participant"}):d("WAResultOrError").makeResult(b)}).concat(e)})}).then(function(a){var c=d("WAResultOrErrorUtils").unpackValues(a),f=c.map(function(a){a=a.participantKey;return a}),g=c.map(function(a){var b=a.groupJid;a=a.userJid;return{groupJid:b,userJid:a}});return d("MAWDbParticipantTxns").bulkDeleteParticipants(b.db,f).then(function(){return m(b.db,g,e)}).then(function(){return a})}).then(function(a){return a.map(function(a){return a.success?{index:a.value.index,result:d("WAResultOrError").makeResult()}:{index:a.error.index,result:d("WAResultOrError").makeError(a.error.message)}}).sort(function(a,b){a=a.index;b=b.index;return a-b}).map(function(a){a=a.result;return a})}))};this.clear=function(){return d("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(b.db.participants.clear())};this.db=a};a.tableLocks={participants:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE};function h(a,b){var c=a.addressable!=null?{addressable:a.addressable}:null;return babelHelpers["extends"]({chatJid:b,type:a.type,user:a.userJid},c)}function i(a){return{addressable:a.addressable,id:d("MAWDbParticipant").craftParticipantId(a.chatJid,a.user),threadJid:a.chatJid,type:a.type,userJid:a.user}}function j(a){return a.map(function(a){return a.user}).filter(function(a){return a===d("WAGlobals").getMyUserJid()||a==="@me"}).length>0}function k(a,b){a=a.threads;return a.where("jid").anyOf(b).toArray().then(function(a){return new Set(a.map(function(a){a=a.jid;return a}))})}function l(a,b){var c=b.filter(function(a){a=a.existed;return!a}).map(function(a){var b=a.chatJid;a=a.participant;return{chatJid:b,participant:a}});c=d("WAArrayGroupBy").groupBy(c,function(a){a=a.chatJid;return a}).map(function(a){var b=a[0];a=a[1];return[b,a.map(function(a){a=a.participant;return a})]});b.forEach(function(a){a=a.dbParticipantToPut;d("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:{participants:[d("MAWBridgeParticipants").createBridgeParticipant(a)]}})});b=c.filter(function(a){a[0];a=a[1];return j(a)}).map(function(a){a=a[0];return a});return d("MAWDbThreadTxns").subscribeToThreads(a,b)}function m(a,b,c){b=Array.from(b);b.forEach(function(a){a=a.groupJid;return d("MAWIndexedDb").afterTransaction({tag:"UpdateE2EEMetadataParticipants",value:d("MAWBridgeTypesCreators").createBridgeUpdateE2EEMetadataParticipants(a)})});var e=new Set(b.filter(function(a){return a.userJid===d("WAGlobals").getMyUserJid()&&(c===d("WAGlobals").getMyUserJid()||c==="@me")}).map(function(a){return a.groupJid}));b=new Set(b.filter(function(a){a=a.userJid;return a!==c&&(a===d("WAGlobals").getMyUserJid()||a==="@me")}).filter(function(a){a=a.groupJid;return!e.has(a)}).map(function(a){a=a.groupJid;return a}));return d("MAWDexieTable").dexieAll([d("MAWDbThreadTxns").archiveThreads(a,Array.from(e),!0),d("MAWDbThreadTxns").unsubscribeFromThreads(a,Array.from(b))])}g.MAWParticipantsStore=a}),98);
__d("MAWRunInTransaction",["MAWDexie","MAWGroupInfoStore","MAWIndexedDb","MAWMessageStore","MAWParticipantsStore","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";var h={GroupInfoStore:d("MAWGroupInfoStore").MAWGroupInfoStore.tableLocks,MessagesStore:d("MAWMessageStore").MAWMessageStore_DEPRECATED_DO_NOT_USE.tableLocks,ParticipantsStore:d("MAWParticipantsStore").MAWParticipantsStore.tableLocks};a=function(a,b,e){var f=[];for(var g in a)a[g]===!0&&f.push(g);g=f.flatMap(function(a){return Object.entries(h[a])}).reduce(function(a,b){var c=b[0];b=b[1];if(a[c]===d("MAWTransactionMode").READWRITE)return a;c=c;return babelHelpers["extends"]({},a,(a={},a[""+c]=b,a))},{});f=d("MAWIndexedDb").makeMsgrTransactor(g,e!=null?e:"runInTransaction",function(e){return function(){var f={CollectionVersionStore:null,GroupInfoStore:a.GroupInfoStore===!0?new(d("MAWGroupInfoStore").MAWGroupInfoStore)(e):null,MessagesStore:a.MessagesStore===!0?new(d("MAWMessageStore").MAWMessageStore_DEPRECATED_DO_NOT_USE)(e):null,MissingKeyStore:null,ParticipantsStore:a.ParticipantsStore===!0?new(d("MAWParticipantsStore").MAWParticipantsStore)(e):null,PendingMutationStore:null,SyncActionStore:null,SyncKeyStore:null};return new(c("MAWDexie").Promise)(function(a){a(b(f))})}});return f()};g.runInTransaction=a}),98);
__d("MAWAddGroupParticipantsApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";a=function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return d("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0,ParticipantsStore:!0},function(a){return h.apply(void 0,[a].concat(b))},"addGroupParticipants")};var h=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f,g,h,i){h=a.GroupInfoStore;var j=a.MessagesStore;a=a.ParticipantsStore;var k=(yield h.get(c));if(!k.success)return d("WAResultOrError").makeError("missing_group");k=f.map(function(a){return{addressable:a.addressable,chatJid:c,type:a.type,user:a.user}});yield a.bulkPut(k);if(b!=null){f=d("MAWAdminMsgHelpers").createParticipantAddAdminMessage(c,k.map(function(a){return a.user}),e,i);yield j.create(f);yield h.update(c,function(a){return babelHelpers["extends"]({},a,{participantVersion:b.current})},{updateParticipantMedatadata:g})}return d("WAResultOrError").makeResult()});return function(b,c,d,e,f,g,h,i){return a.apply(this,arguments)}}();g.addGroupParticipants=a;g.addGroupParticipantsTransactor=h}),98);
__d("MAWMarkMsgDroppedApi",["MAWAckLevel","MAWDbMsgTxns","MAWDbReactionsTxns","MAWDexieTable","MAWIndexedDb","MAWQplProxy","MAWTransactionMode","gkx"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,media:a.READONLY,messages:a.READWRITE,reactions:a.READWRITE,receiverFetchInfo:a.READONLY,threads:a.READWRITE,xma:a.READONLY},"markMsgDropped",function(a){return function(b,e,f){f!=null&&d("MAWQplProxy").sendQplPointThroughBridge(f.qplEventType,"mark_msg_dropped_msg_and_reaction_fetch_start",{instanceKey:f.qplInstanceKey});return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b),d("MAWDbReactionsTxns").maybeGetReactionByProtocolMsgId(a,b)]).then(function(b){var g=b[0];b=b[1];f!=null&&d("MAWQplProxy").sendQplPointThroughBridge(f.qplEventType,"mark_msg_dropped_msg_and_reaction_fetch_end",{instanceKey:f.qplInstanceKey});if(g!=null){var h=(e==null?void 0:e.isRetriable)===!0?d("MAWAckLevel").ACK.failedRetryable:d("MAWAckLevel").ACK.expired,i=c("gkx")("7471");f!=null&&d("MAWQplProxy").sendQplPointThroughBridge(f.qplEventType,"mark_msg_dropped_update_system_ack_start",{annotations:{"int":{ack:h}},instanceKey:f.qplInstanceKey});return d("MAWDbMsgTxns").updateSystemAck(a,g.msgId,h,void 0,void 0,i&&(e==null?void 0:e.applicationErrorCode)!=null?e==null?void 0:e.applicationErrorCode:void 0).then(function(a){f!=null&&d("MAWQplProxy").sendQplPointThroughBridge(f.qplEventType,"mark_msg_dropped_update_system_ack_end",{instanceKey:f.qplInstanceKey});return a==null?"missing":a.ack<=d("MAWAckLevel").ACK.clock?"dropped":"sent"})}if(b!=null){f!=null&&d("MAWQplProxy").sendQplPointThroughBridge(f.qplEventType,"mark_msg_dropped_update_delete_reaction_start",{instanceKey:f.qplInstanceKey});return d("MAWDbReactionsTxns").deleteReaction(a,b).then(function(){f!=null&&d("MAWQplProxy").sendQplPointThroughBridge(f.qplEventType,"mark_msg_dropped_update_delete_reaction_end",{instanceKey:f.qplInstanceKey});return"dropped"})}f!=null&&d("MAWQplProxy").sendQplPointThroughBridge(f.qplEventType,"mark_msg_dropped_msg_and_reaction_missing",{instanceKey:f.qplInstanceKey});return"missing"})}});g.markMsgDropped=b}),98);
__d("MAWMessageSendScheduler",["WorkerScheduler"],(function(a,b,c,d,e,f,g){"use strict";var h=24e4,i;function a(){i==null&&(i=d("WorkerScheduler").makeScheduler("message-send",{concurrency:5,defaultSamplingRate:500,maxConcurrency:5,maxThrottleMs:500,timeToStuckMs:h}));return i}g.messageSendScheduler=a}),98);
__d("MAWMessageSendsCommon",["MAWMarkMsgDroppedApi","MAWMessageSendScheduler","MAWQplProxy","MWFBLogger","WAGetSafeQPLError","WAPromiseDelays","WAResultOrError","WATimeUtils","WAWaitForComms","WorkerScheduler","asyncToGeneratorRuntime","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=1e3,k=d("MWFBLogger").MWLogger.tags(["MessageSend"]);function l(){if(!c("justknobx")._("4635"))return{activeTasks:[],pendingTasks:[]};var a=d("MAWMessageSendScheduler").messageSendScheduler().getDebugState();return{activeTasks:a.activeTasks.map(function(a){return"executionTimeMs"+a.executionTimeMs+" priority: "+a.priority+" name: "+a.task+" waitTimeMs:"+a.waitTimeMs}),pendingTasks:a.pendingTasksByPriority.map(function(a){return a.map(function(a){return"name: "+a.task+" waitTimeMs:"+a.waitTimeMs})}).flat()}}function m(a,b,c,d,e){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g){d("MAWQplProxy").sendQplPointThroughBridge(a,"backend_reached",{annotations:{bool:{backendSetupReadyFromWorker:!d("WAWaitForComms").isStillWaitingForComms()}},instanceKey:b});var n;try{d("MAWQplProxy").sendQplPointThroughBridge(a,"wait_for_comms_start",{annotations:{},instanceKey:b});yield d("WAWaitForComms").waitForComms();d("MAWQplProxy").sendQplPointThroughBridge(a,"wait_for_comms_end",{annotations:{},instanceKey:b});var o=l(),p=o.activeTasks;o=o.pendingTasks;d("MAWQplProxy").sendQplPointThroughBridge(a,"message_send_start",{annotations:c("justknobx")._("4635")?{string_array:{activeTasksBeforeSchedule:p,pendingTasksByPriorityBeforeSchedule:o}}:{},instanceKey:b});n=(yield d("MAWMessageSendScheduler").messageSendScheduler().runTask({customFlags:{runtimeReliability:!0},fn:function(){return e(d("WATimeUtils").unixTime())},name:f,priority:d("WorkerScheduler").BLOCKING_PRIORITY}));if(n.success===!0)d("MAWQplProxy").sendQplPointThroughBridge(a,"message_send_end",{instanceKey:b});else{var q;p=l();o=p.activeTasks;p=p.pendingTasks;d("MAWQplProxy").sendQplPointThroughBridge(a,"message_send_fail",{annotations:{string:{errorType:(q=(q=n.error)==null?void 0:q.type)!=null?q:"unknown-error"},string_array:c("justknobx")._("4635")?{activeTasksBeforeSchedule:o,pendingTasksByPriorityBeforeSchedule:p}:{}},instanceKey:b})}}catch(e){q=l();o=q.activeTasks;p=q.pendingTasks;k.catching(e).MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Message send fail. Error: ",""])),d("WAGetSafeQPLError").getSafeQPLErrorMessage(e));d("MAWQplProxy").sendQplPointThroughBridge(a,"message_send_fail",{annotations:{string:{errorDescription:d("WAGetSafeQPLError").getSafeQPLErrorMessage(e),errorType:"runtime-error",sendFailureError:d("WAGetSafeQPLError").getSafeQPLErrorMessage(e)},string_array:c("justknobx")._("4635")?{activeTasksBeforeSchedule:o,pendingTasksByPriorityBeforeSchedule:p}:{}},instanceKey:b});g!=null&&(yield d("MAWMarkMsgDroppedApi").markMsgDropped(g,void 0,{qplEventType:a,qplInstanceKey:b}));throw e}if(!n){q="null-response-from-message-send";k.MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Guard: should not happen, result is null"])));d("MAWQplProxy").sendQplPointThroughBridge(a,"message_send_fail",{instanceKey:b});return d("WAResultOrError").makeError({applicationErrorCode:null,details:q,isRetriable:!0,type:"unexpected-message-codepath"})}if(n.success===!0)return n;n.success;g!=null&&(yield d("MAWMarkMsgDroppedApi").markMsgDropped(g,n.error,{qplEventType:a,qplInstanceKey:b}));if(((o=n.error)==null?void 0:o.type)==="retryable-error"){q=(p=n.error.backoff)!=null?p:j;yield d("WAPromiseDelays").delayMs(q);return m(a,b,e,f,g)}else return n});return n.apply(this,arguments)}g.messageSendLogger=k;g.messageSendObserver=m}),98);
__d("MAWDebugMsg",["MAWBridgeMsg","MAWDbMsg","MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieTable","MAWExternalId","MAWIndexedDb","MAWJidUtils","MAWLocalizationType","MAWLocalizationUtils","MAWMsgType","MAWTransactionMode","MAWTransactor","MAWUseProtocolMsgIdForMsgId","OfflineThreadingId","WAStanzaUtils","WATimeUtils","gkx"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWTransactor").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,threads:a.READWRITE},"writeDebugMsg",function(a){return function(b,e,f){return!c("gkx")("23958")?d("MAWDexieTable").dexieResolve():d("MAWDbThreadTxns").getThread(a,b).then(function(b){if(!b.success)return;var c=b.value;return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").getThreadNewestMessageBySortOrder(a,c.jid),d("MAWDbMsgTxns").getThreadNewestMessageMs(a,c.jid),(f==null?void 0:f.decryptionError)==="errDuplicateMsg"?d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,f.protocolMsgId).then(function(a){if(a==null)return", no existing message";return a.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT?", existing ciphertext message":",  existing message"}):d("MAWDexieTable").dexieResolve(""),d("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId()?d("MAWDexieTable").dexieResolve(null):d("MAWDbMsgTxns").getNextMsgIdNumberForThread(a,c)]).then(function(a){var b=a[0],f=a[1],g=a[2];a=a[3];a=a!=null?d("MAWDbMsg").craftDebugMsgId(c.chatId,a-1):d("MAWJidUtils").formatProtocolMsgIdFromExternalId(c.jid,d("WAStanzaUtils").toStanzaId(d("OfflineThreadingId").createOfflineThreadingID()));f=d("WATimeUtils").castToMillisTime(((b=(b=b==null?void 0:b.sortOrderMs)!=null?b:f)!=null?b:0)+1);b=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:["[fb-only][DEBUG]: "+(e+g)],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.DEBUG_MSG,version:0},c.jid,d("MAWExternalId").generateExternalId());d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(babelHelpers["extends"]({},b,{msgId:a,sortOrderMs:f}))})})})}});g.writeDebugMsg=b}),98);
__d("MAWGetEditMsgForSending",["FBLogger","MAWAckLevel","MAWAsMessageApplication","MAWDbEditMsgHistoryTxns","MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWTransactionMode","WAJids","WALogger","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;b=d("MAWIndexedDb").makeMsgrTransactor({editMsgHistory:(a=d("MAWTransactionMode")).READONLY,messages:a.READONLY,reactions:a.READONLY,threads:a.READONLY},"getEditMsgForSending",function(a){return function(b,e){return l(a,b,e).then(function(a){if(!a.success)return{type:a.error};a=a.value.msg;var e=d("MAWAsMessageApplication").asEditMessageApplication(a);if(d("WAJids").isAuthorSystem(a.author))throw c("FBLogger")("messenger_web").mustfixThrow("This cannot happen because there are no system edit");return{dbMsg:a,editOriginalExternalId:a.originalMsgExternalId,messageApplication:e,messageType:{isEdit:!0,isRevoked:!1,type:"text"},protocolMsgId:b,type:"unsent"}})}});function l(a,b,c){return d("MAWDbEditMsgHistoryTxns").getEditHistoryMsgByEditedProtocolMsgId(a,b,c).then(function(b){if(b==null){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[SendEditMsg] Failed to get edit history"])));return d("WAResultOrError").makeError("missing_history")}else if(b.sendStatus!=null&&b.sendStatus>d("MAWAckLevel").ACK.clock)return d("WAResultOrError").makeError("sent");var c=d("MAWJidUtils").maybeToProtocolMsgId(b.author,b.threadJid,b.originalMsgExternalId);if(c==null){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[SendEditMsg] Failed to get originalMsgProtocolMsgId"])));return d("WAResultOrError").makeError("missing_msg")}return d("MAWDexieTable").dexieAll([d("MAWDbThreadTxns").getThread(a,b.threadJid),d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,c)]).then(function(a){var c=a[0];a=a[1];if(!c.success){d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[SendEditMsg] Failed to get thread (success:",")"])),c.success);return d("WAResultOrError").makeError("missing_thread")}if(a==null){d("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[SendEditMsg] Failed to get originalMsg"])));return d("WAResultOrError").makeError("missing_msg")}return a.ack>d("MAWAckLevel").ACK.clock?d("WAResultOrError").makeError("sent"):d("WAResultOrError").makeResult({msg:b,thread:c.value})})})}g.getEditMsgForSending=b}),98);
__d("MAWMediaType",["WAServerMediaType"],(function(a,b,c,d,e,f,g){"use strict";function a(a){switch(a){case"XMA":return"xma-image";case"EphemeralScreenshotAction":case"Raven":case"RavenAction":case"EditAction":case"BumpExistingMessage":return null;default:return d("WAServerMediaType").getMediaType(a)}}g.getMediaType=a}),98);
__d("MAWSendMsgUtil",["MAWMediaType","WAConsumerApplication.pb","WAMsgType","decodeProtobuf","getMediaTypeFromConsumerMessage"],(function(a,b,c,d,e,f,g){"use strict";({});function h(a){var b=d("MAWMediaType").getMediaType(a),c=a===d("WAMsgType").MSG_TYPE.REVOKED;if(b!=null)return{mediaType:b,type:"media"};else if(a===d("WAMsgType").MSG_TYPE.SK_DISTRIBUTION)return{isInvisible:!0,isRevoked:!1,type:"text"};else return{isRevoked:c,type:"text"}}function a(a){var b=d("MAWMediaType").getMediaType(a);if(b!=null)return{mediaType:b,type:"media"};switch(a){case"XMA":case"Raven":case"RavenAction":case"EphemeralScreenshotAction":case"EditAction":case"BumpExistingMessage":return{isRevoked:!1,type:"text"};default:return h(a)}}function b(a){var b;a=(a=a.payload)==null||(a=a.subProtocol)==null?void 0:a.consumerMessage;if(a==null)return{isRevoked:!1,type:"text"};a=d("decodeProtobuf").decodeProtobuf(d("WAConsumerApplication.pb").ConsumerApplicationSpec,a.payload);if(a!=null&&(b=a.payload)!=null&&(b=b.applicationData)!=null&&b.revoke)return{isRevoked:!0,type:"text"};a=d("getMediaTypeFromConsumerMessage").getMediaTypeFromConsumerMessage(a);return a!=null?{mediaType:a,type:"media"}:{isRevoked:!1,type:"text"}}g.waGetMessageTypeFromMsg=h;g.getMessageTypeFromMsg=a;g.getMessageTypeFromMessageApplication=b}),98);
__d("MAWGetMsgForSendingApi",["FBLogger","MAWAckLevel","MAWAsMessageApplication","MAWDbGroupInviteTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbUnrenderedMsgTxns","MAWDbXMATxns","MAWDexieTable","MAWIndexedDb","MAWMsgType","MAWSendMsgUtil","MAWTransactionMode","MAWXMAUtils","WAJids","WALogger","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l;b=d("MAWIndexedDb").makeMsgrTransactor({groupInvites:(a=d("MAWTransactionMode")).READONLY,media:a.READONLY,messages:a.READONLY,reactions:a.READONLY,threads:a.READONLY,unrenderedMessages:a.READONLY,xma:a.READONLY},"getMsgForSending",function(a){return function(b){return m(a,b).then(function(a){if(!a.success){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg "," -- MAWGetMsgForSendingAPI -- Error: ",""])),b,a.error);return{type:a.error}}a=a.value;var e=a.groupInvite,f=a.isReplyMsg,g=a.media,k=a.msg;a=a.xmaPayload;if(!d("MAWDbMsg").NO_CONTENT_MESSAGE_TYPES_ALLOWLIST.includes(k.type)&&!d("MAWDbMsg").isContentMsg(k)){d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg "," -- MAWGetMsgForSendingAPI -- Unrecognized type ",""])),b,k.type);throw c("FBLogger")("messenger_web").mustfixThrow("We do not support message sending with "+k.type+" type")}var l=d("MAWAsMessageApplication").asMessageApplication(k,g,e,a,k.threadJid),m=null;k.type===d("MAWMsgType").MSG_TYPE.GROUP_INVITE&&e?m={invitedParticipantUserJid:e.inviteeJid,isRevoked:!1,type:"text"}:m=d("MAWSendMsgUtil").getMessageTypeFromMsg(k.type);if(d("WAJids").isAuthorSystem(k.author))throw c("FBLogger")("messenger_web").mustfixThrow("A system message cannot be sent");d("WALogger").LOG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg "," -- MAWGetMsgForSendingAPI -- Done"])),b);return{dbMsg:k,isReplyMsg:f,isXMAMsg:a!=null,media:g,messageApplication:l,messageType:m,protocolMsgId:{author:k.author,chat:k.threadJid,externalId:a!=null&&a.associatedMessage!=null?a.associatedMessage.externalId:k.externalId},type:"unsent",xmaPayload:a}})}});function m(a,b){return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b),d("MAWDbUnrenderedMsgTxns").maybeGetUnrenderedMsgByProtocolMsgId(a,b)]).then(function(c){var e=c[0];c=c[1];var f=c.value,g=e||f;if(g==null){d("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[SendMsg] Failed to get message"])));return d("WAResultOrError").makeError("missing_msg")}else if(g.ack>d("MAWAckLevel").ACK.clock)return d("WAResultOrError").makeError("sent");var h=d("MAWXMAUtils").maybeXMAMessage(e),i=g.quote!=null;return d("MAWDexieTable").dexieAll([e?d("MAWDbMediaTxns").getAndCheckMediaFromMsg(a,e):d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult()),c.success?d("MAWDbGroupInviteTxns").getAndCheckGroupInviteFromMsg(a,c.value):d("MAWDexieTable").dexieResolve(),h?d("MAWDbXMATxns").maybeGetXMAPayloadFromProtocolMsgId(a,b):null]).then(function(a){var b=a[0],c=a[1];a=a[2];if(!b.success)return b;if(a!=null&&!a.success){d("WALogger").ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["[SendMsg] Failed to get XMA: isXma: ",", type: "," "])),h,g.type);return d("WAResultOrError").makeError("missing_xma")}b=b.value;return d("WAResultOrError").makeResult({groupInvite:c,isReplyMsg:i,media:b,msg:g,xmaPayload:a!=null?a.value:null})})})}g.getMsgForSending=b}),98);
__d("MAWGetNoteReplyMsgForSendingApi",["MAWAckLevel","MAWAsMessageApplication","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWSendMsgUtil","MAWTransactionMode","WAJids","WALogger","WAResultOrError","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,b){return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b)]).then(function(a){a=a[0];a=a;if(a==null){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[SendMsg] Failed to get message"])));return d("WAResultOrError").makeError("missing_msg")}else if(a.ack>d("MAWAckLevel").ACK.clock)return d("WAResultOrError").makeError("sent");return d("WAResultOrError").makeResult({msg:a})})}b=d("MAWIndexedDb").makeMsgrTransactor({media:(a=d("MAWTransactionMode")).READONLY,messages:a.READONLY,threads:a.READONLY,unrenderedMessages:a.READONLY},"getNoteReplyForSending",function(a){return function(b){return i(a,b).then(function(a){if(!a.success)return{type:a.error};a=a.value.msg;var b=d("MAWAsMessageApplication").asNoteReplyMessageApplication(a),e=d("MAWSendMsgUtil").getMessageTypeFromMsg(a.type);if(d("WAJids").isAuthorSystem(a.author))throw c("err")("A system message cannot be sent");return{dbMsg:a,messageApplication:b,messageType:e,protocolMsgId:{author:a.author,chat:a.threadJid,externalId:a.externalId},type:"unsent"}})}});g.getNoteReplyForSending=b}),98);
__d("MAWGetReactionForSending",["FBLogger","MAWAckLevel","MAWAsMessageApplication","MAWDbReactionsTxns","MAWDbThreadTxns","MAWIndexedDb","MAWTransactionMode","WAJids","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b){return d("MAWDbReactionsTxns").maybeGetReactionByProtocolMsgId(a,b).then(function(b){if(b==null)return d("WAResultOrError").makeError("missing");else if(b.ack>d("MAWAckLevel").ACK.clock)return d("WAResultOrError").makeError("sent");return d("MAWDbThreadTxns").getThread(a,b.threadJid).then(function(a){return!a.success?d("WAResultOrError").makeError(a.error):d("WAResultOrError").makeResult({msg:b})})})}a=d("MAWIndexedDb").makeMsgrTransactor({reactions:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY},"getReactionForSending",function(a){return function(b){return h(a,b).then(function(a){if(!a.success)return{type:a.error};a=a.value.msg;var b=d("MAWAsMessageApplication").asReactionMessageApplication(a);if(d("WAJids").isAuthorSystem(a.author))throw c("FBLogger")("messenger_web").mustfixThrow("This cannot happen because there are no system reactions");return{chat:a.threadJid,dbMsg:a,externalId:a.externalId,messageApplication:b,messageType:{isInvisible:!0,type:"reaction"},protocolMsgId:{author:a.author,chat:a.threadJid,externalId:a.externalId},type:"unsent"}})}});g.getReactionForSending=a}),98);
__d("MAWLoadThreadParticipantsApi",["MAWDbParticipantTxns","MAWIndexedDb","MAWTransactionMode","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;a=d("MAWIndexedDb").makeMsgrTransactor({participants:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY},"loadThreadParticipants",function(a){return function(b){return a.threads.get({jid:b}).then(function(b){if(b==null){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["MAWLoadThreadParticipantsApi -- loadThreadParticipants -- there is no thread in db"])));return[]}return d("MAWDbParticipantTxns").getParticipantsInThread(a,b.jid).then(function(a){return a.map(function(a){return a.userJid})})})}});g.loadThreadParticipants=a}),98);
__d("MAWMarkEditMsgDroppedApi",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWDbEditMsgHistoryTxns","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWTransactionMode","WAGlobals","WAJids","WALogger","WAMsgType","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o;a=d("MAWIndexedDb").makeMsgrTransactor({editMsgHistory:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE},"markEditMsgDropped",function(a){return function(b,e){var f=d("MAWJidUtils").maybeToProtocolMsgId(b.author,b.chat,e);if(f==null){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] originalProtocolMsgId is null"])));return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("missing_original_protocol_msg_id"))}return d("MAWDexieTable").dexieAll([a.threads.get({jid:b.chat}),d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,f),d("MAWDbEditMsgHistoryTxns").maybeGetEditMsgHistoryFromProtocolMsgId(a,f)]).then(function(f){var g=f[0],h=f[1],p=f[2];f=p.sort(function(a,b){return b.editTs-a.editTs});var q=p.find(function(a){return a.editExternalId===b.externalId}),r=f[1];if(h==null){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] originalMsg is null"])));return d("WAResultOrError").makeError("missing_original_msg")}if(q==null){d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] newestEditedMsg is null"])));return d("WAResultOrError").makeError("missing_newest_edited_msg")}if(r==null){d("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] previousEditedMsg is null"])));return d("WAResultOrError").makeError("missing_previous_edited_msg")}if(q.editExternalId!==f[0].editExternalId){d("WALogger").ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] newestEditedMsg is not the newest edit"])));return d("WAResultOrError").makeError("invalid_newest_edited_msg")}if(g==null){d("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] thread is null"])));return d("WAResultOrError").makeError("missing_thread")}if(h.type!==d("WAMsgType").MSG_TYPE.TEXT){d("WALogger").ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] originalMsg is not a text message"])));return d("WAResultOrError").makeError("invalid_original_msg")}return a.messages.where("quoteExternalId").equals(e).toArray().then(function(e){var f,g=babelHelpers["extends"]({},h,{ack:d("MAWAckLevel").ACK.sent,editCount:((f=h.editCount)!=null?f:0)-1,msgContent:r.msgContent}),i=d("WAGlobals").getMyUserJid(),j=[];f=e.find(function(a){var c;return(((c=a.quote)==null?void 0:c.content.author)===d("WAJids").AUTHOR_ME||((c=a.quote)==null?void 0:c.content.author)===i)&&a.threadJid===b.chat});if(f!=null){e=f.quote;var k=f.quoteExternalId;if(e==null)c("FBLogger")("messenger_web").warn("[markEditMsgDropped] Failed to get the quoted content for a msg that has been quoted.",k);else{k=babelHelpers["extends"]({},f,{quote:babelHelpers["extends"]({},e,{content:babelHelpers["extends"]({},e.content,{msgContent:babelHelpers["extends"]({},g.msgContent)})})});j.push(k)}}f=[];h.editCount===1&&p.length===2&&f.push(r.editMsgHistoryId);f.push(q.editMsgHistoryId);return d("MAWDexieTable").dexieAll([a.messages.put(g),a.editMsgHistory.bulkDelete(f)]).then(function(){d("WALogger").LOG(o||(o=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] editMsgHistory updated"])));d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(g)});j.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a)})});return d("WAResultOrError").makeResult()})})})}});g.markEditMsgDropped=a}),98);
__d("MAWMarkEditMsgSentApi",["ArmadilloDataTraceType","MAWAckLevel","MAWBridgeMsg","MAWBridgeTrace","MAWBridgeTraceEvent","MAWDbEditMsgHistory","MAWDbEditMsgHistoryTxns","MAWDbMsgTxns","MAWDexieTable","MAWFTSTxns","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWTransactionMode","WAJids","WALogger","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n;b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,editMsgHistory:a.READWRITE,ftsBackloggedMessages:a.READWRITE,media:a.READONLY,messages:a.READWRITE,receiverFetchInfo:a.READONLY,xma:a.READONLY},"markEditMsgSent",function(a){return function(b,e,f,g){var o=d("MAWJidUtils").maybeToProtocolMsgId(b.author,b.chat,e);if(o==null){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] originalProtocolMsgId is null"])));return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError("missing_original_protocol_msg_id"))}return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,o),d("MAWDbEditMsgHistoryTxns").maybeGetEditMsgHistoryFromProtocolMsgId(a,o),d("MAWFTSTxns").maybePutMessageToBacklog(a,e)]).then(function(h){var o=h[0];h=h[1];var p=h.find(function(a){return a.editExternalId===e}),q=h.find(function(a){return a.editExternalId===b.externalId});if(o==null){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] originalMsg is null"])));return d("WAResultOrError").makeError("missing_original_msg")}if(p==null){d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] originalMsgHistory is null"])));return d("WAResultOrError").makeError("missing_original_msg_edit_history")}if((q==null?void 0:q.editExternalId)==null){d("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] editedMsg?.editExternalId is null"])));return d("WAResultOrError").makeError("missing_edit_external_id")}if(q.sendStatus!=null&&q.sendStatus>d("MAWAckLevel").ACK.clock&&o.ack>d("MAWAckLevel").ACK.clock){d("WALogger").LOG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] editMsgHistory has already been sent"])));return d("WAResultOrError").makeError("already_sent")}if(q.author!==d("WAJids").AUTHOR_ME){d("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] on incoming message"])));return d("WAResultOrError").makeError("not_author")}d("MAWIndexedDb").afterTransaction({tag:"UpdateTrace",value:d("MAWBridgeTrace").createBridgeUpdateTraceData([q.editExternalId],c("MAWBridgeTraceEvent").ReceivedSent,d("ArmadilloDataTraceType").armadilloMessageSend)});var r=[];if(h.length===2&&o.editCount===1){h=babelHelpers["extends"]({},p,{sendStatus:d("MAWAckLevel").ACK.sent});r.push(h)}p=babelHelpers["extends"]({},q,{editTs:f,sendStatus:d("MAWAckLevel").ACK.sent});r.push(p);var s=r.map(function(a){return babelHelpers["extends"]({},a,{editMsgHistoryId:d("MAWDbEditMsgHistory").convertToEditMsgHistoryId64(a.editMsgHistoryId),originalMsgId:o.msgId})}),t=babelHelpers["extends"]({},o,{ack:d("MAWAckLevel").ACK.sent});g!=null&&(t.reportingMeta=g);return d("MAWDexieTable").dexieAll([a.editMsgHistory.bulkPut(r),a.messages.put(t),d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,t)]).then(function(a){a[0];a=a[2];d("WALogger").LOG(n||(n=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] editMsgHistory updated"])));d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(t,void 0,a)});d("MAWIndexedDb").afterTransaction({tag:"EditMsgHistoryAdded",value:s});return d("WAResultOrError").makeResult()})})}});g.markEditMsgSent=b}),98);
__d("MAWMarkMsgSentApi",["ArmadilloDataTraceType","MAWAckLevel","MAWBridgeTrace","MAWBridgeTraceEvent","MAWDbMsgTxns","MAWDbThread","MAWDbThreadTxns","MAWDbUnrenderedMsgTxns","MAWDexieTable","MAWEphemeralMsgTxns","MAWEphemeralSettingsTxns","MAWIndexedDb","MAWMsgType","MAWTransactionMode","MAWUpdateThreadActivity","WALogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,ephemeralSettings:a.READWRITE,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,reactions:a.READONLY,receiverFetchInfo:a.READONLY,threads:a.READWRITE,unrenderedMessages:a.READWRITE,xma:a.READONLY},"markMsgSent",function(a){return function(b,e,f){return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b),d("MAWDbUnrenderedMsgTxns").maybeGetUnrenderedMsgByProtocolMsgId(a,b)]).then(function(g){var k=g[0];g=g[1];if(k==null&&!g.success){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Msg missing from DB"])));return}else if(k!=null){d("MAWIndexedDb").afterTransaction({tag:"UpdateTrace",value:d("MAWBridgeTrace").createBridgeUpdateTraceData([k.externalId],c("MAWBridgeTraceEvent").ReceivedSent,d("ArmadilloDataTraceType").armadilloMessageSend)});g.success&&d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Found both regular and unrendered message with the same protocol msg ID"])));var l=k.ack<d("MAWAckLevel").ACK.sent;return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").updateSystemAck(a,k.msgId,d("MAWAckLevel").ACK.sent,e,f),d("MAWDbThreadTxns").getThread(a,k.threadJid)]).then(function(b){var c=b[0];b=b[1];if(!b.success){d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Thread missing from DB"])));return}var f=b.value;b=d("WATimeUtils").castUnixTimeToMillisTime(e);b=babelHelpers["extends"]({},f,{lastReadMsgTs:b,newestMsgTs:b,threadOrder:d("MAWDbThread").craftThreadOrder(b,f.jid)});b=l?d("MAWDbThreadTxns").updateThread(a,b):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([d("MAWEphemeralMsgTxns").markEphemeralMessageAsSent(a,c),b]).then(function(){if(c!=null)return d("MAWUpdateThreadActivity").updateThreadActivityFromInsertionTxn(a,c,f.jid,"outgoing_msg")})})}else if(g.success){var m=g.value;return d("MAWDbUnrenderedMsgTxns").updateSystemAckForUnrenderedMsg(a,m.msgId,d("MAWAckLevel").ACK.sent).then(function(){if(m.type===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE)return d("MAWEphemeralSettingsTxns").updateContactWhenEphemeralSettingChangeMarkedSent(a,b.chat,e)})}})}});g.markMsgSent=b}),98);
__d("MAWSendWrittenMsg",["EBAPI","EBLogger","MAWBridge","MAWDebugMsg","MAWGetEditMsgForSending","MAWGetMsgForSendingApi","MAWGetNoteReplyMsgForSendingApi","MAWGetReactionForSending","MAWJids","MAWLoadThreadParticipantsApi","MAWMarkEditMsgDroppedApi","MAWMarkEditMsgSentApi","MAWMarkMsgDroppedApi","MAWMarkMsgSentApi","MAWMessageSendsCommon","MAWMpsGating","MAWODSProxy","MAWSendMsgUtil","MpsTypes","WAAPI","WAAsMessageApplication","WABuildMpsPayload","WAFrankingTypes","WAGlobals","WAMsgApplication.pb","WAOdsEnums","WAResultOrError","WebMps","asyncToGeneratorRuntime","encodeProtobuf","err","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;function l(a,b,c){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){d("MAWMessageSendsCommon").messageSendLogger.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg ",""])),String(a.protocolMsgId));b.addPoint("get_msg_for_sending_start",{string:{type:a.type}});var f,g,l,m,n=null,o;if(e==null){if(a.type==="message"||a.type==="revoke"||a.type==="bump")n=(yield d("MAWGetMsgForSendingApi").getMsgForSending(a.protocolMsgId));else if(a.type==="reaction")n=(yield d("MAWGetReactionForSending").getReactionForSending(a.protocolMsgId));else if(a.type==="edit")n=(yield d("MAWGetEditMsgForSending").getEditMsgForSending(a.protocolMsgId,a.referencedOriginalExternalId));else if(a.type==="noteReply")n=(yield d("MAWGetNoteReplyMsgForSendingApi").getNoteReplyForSending(a.protocolMsgId));else{a.type;throw c("err")("This cannot happen because type has `message` as default argument but flow does not know that")}if(n.type!=="unsent"){d("MAWMessageSendsCommon").messageSendLogger.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg not sending message: ",""])),n.type);return d("WAResultOrError").makeError({details:n.type,isRetriable:!0,type:"wrong-message-state"})}var p=n,q=p.dbMsg,r=p.isReplyMsg;p=p.isXMAMsg;o=n.protocolMsgId;f=n.messageApplication;l=n.messageType;g=q==null?void 0:q.type;m=n.editOriginalExternalId;q=(q==null?void 0:q.ephemeralSetting)!=null&&((q=(q=q.ephemeralSetting)==null?void 0:q.ephemeralExpirationInSec)!=null?q:0)>0;b.addPoint("get_msg_for_sending_end",{bool:{isEditMsg:m!=null,isEphemeralMsg:q,isReplyMsg:r,isXMAMsg:p},string:{msgType:l.type}});q&&d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_OLD_MESSAGE_SEND,key:"sendEphemeralMsg"},!0)}else f=e.messageApplication,l=d("MAWSendMsgUtil").getMessageTypeFromMessageApplication(f),m=null,o=a.protocolMsgId;r=d("encodeProtobuf").encodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,f).readBuffer();p={bytes:d("WAAsMessageApplication").castToMessageApplicationBytes(new Uint8Array(r)),version:"v3"};b.addPoint("wa_send_msg_start");q=(yield c("WAAPI").sendChatMessage({loadThreadParticipants:d("MAWLoadThreadParticipantsApi").loadThreadParticipants,messagePayload:{backupDirective:null,frankingKey:(q=f.metadata)!=null&&q.frankingKey?d("WAFrankingTypes").castToFrankingKey(new Uint8Array((e=f.metadata)==null?void 0:e.frankingKey)):null,frankingVersion:(a=f.metadata)==null?void 0:a.frankingVersion,messageBytes:p,messageType:l,protocolMsgId:o}},b));if(q.success===!1){b.addPoint("wa_send_msg_fail",{string:{errorType:q.error.type,msgType:g}});m!=null?yield d("MAWMarkEditMsgDroppedApi").markEditMsgDropped(o,m):yield d("MAWMarkMsgDroppedApi").markMsgDropped(o,q.error);d("MAWMessageSendsCommon").messageSendLogger.MUSTFIX(j||(j=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg END "," : ",""])),q.error.type,String((e=q.payload)!=null?e:""));switch(q.error.type){case"non-retryable-error":if(q.error.applicationErrorCode!=null&&q.error.applicationErrorCode===10009)try{d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"RefreshContact",value:d("MAWJids").convertChatJidToIntJid(o.chat)}]})}catch(a){d("EBLogger").EBLogger.catching(a).mustfix("Failed to call bridge handler RefreshContact for JID %s and mediaType %s",o.chat,g)}return q;case"missing-receipt":case"wrong-message-state":case"unexpected-message-codepath":case"result-parsing-error":case"retryable-error":case"no-recipients":case"encryption-error":case"too-many-retries":return q;default:q.error.type;throw c("err")("Unreachable code")}}q.success;b.addPoint("wa_send_msg_end");(a=q.value.meta)!=null&&a.pOrDhashMismatch&&(b.addPoint("dhash_phash_mismatch"),c("promiseDone")(d("MAWDebugMsg").writeDebugMsg(o.chat,"Outgoing msg "+o.externalId+" got a phash mismatch")));n!=null&&(b.addPoint("mark_edit_msg_sent_start"),m!=null?yield d("MAWMarkEditMsgSentApi").markEditMsgSent(o,m,q.value.serverTs,q.value.reportingMeta):yield d("MAWMarkMsgSentApi").markMsgSent(o,q.value.serverTs,q.value.reportingMeta),b.addPoint("mark_edit_msg_sent_end"));try{yield d("WebMps").mps().saveNewMessages([{directive:null,insertionSource:d("MpsTypes").InsertionSource.Send,message:d("WABuildMpsPayload").buildMpsMessage({encryptedTransportMessage:r},{externalId:o.externalId,senderJid:d("WAGlobals").getMyUserJid(),serverTs:q.value.serverTs,threadId:o.chat})}],{source:"wa-message-sent"})}catch(a){d("MAWMessageSendsCommon").messageSendLogger.MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Failed to save message to MPS: ",""])),a)}if(n!=null&&!d("MAWMpsGating").isEbUploadViaMpsEnabled()){b.addPoint("eb_upload_scheduling_start");l=n;e=l.dbMsg;a=l.isXMAMsg;m=l.media;r=l.xmaPayload;yield c("EBAPI").uploadSentMessage({dbMsg:e,instanceKey:o.externalId,isXMAMsg:a,media:m,messageApplication:f,messageApplicationBytes:p.bytes,protocolMsgId:o,serverTs:q.value.serverTs,xmaPayload:r});b.addPoint("eb_upload_scheduling_end")}return q});return m.apply(this,arguments)}function a(a,b,c,d){b.addAnnotations({bool:{is_secure:!0},string:{description:c,jid:a.protocolMsgId.chat}});return l(a,b,d)}g.sendWrittenMsgExternal=a}),98);
__d("MAWWriteGroupInviteTxns",["MAWBridgeTypesCreators","MAWDbGroupInviteTxns","MAWDbParticipant","MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWLowLevelApiTypes","MAWThreadManagementTxns","MAWUserJidWrapper","WAGroupInviteUtils","WAJids","WAResultOrError","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c){return d("MAWDbThreadTxns").getThread(a,c).then(function(c){return!c.success?d("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.MISSING_GROUP:d("MAWDbGroupInviteTxns").maybeGetGroupInvite(a,b.threadJid,b.inviteeJid).then(function(c){return c&&!d("WATimeUtils").isInFuture(c.inviteExpirationTs)?d("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.EXISTING_GROUP_INVITE:d("MAWDbGroupInviteTxns").putGroupInvite(a,b)})})}function b(a,b,c,e){var f=b.caption,g=b.groupJid,h=b.inviteCode;b=b.inviteExpiration;var i=d("WAJids").interpretAsUserJid(c);if(g==null||b==null||h==null||i==null)return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError({type:"invalid_args"}));c=[d("WATimeUtils").castLongIntToUnixTime(b),d("WAJids").toGroupJid(g),d("WAGroupInviteUtils").toInviteCode(h)];var j=c[0];b=c[1];var k=c[2],l={folder:e,groupJid:b,inviteCode:k,inviteExpireTs:j,inviterJid:i,type:"group_invite"};return d("MAWThreadManagementTxns").getGroupThread(a,b,e,!0).then(function(b){return b==null?d("WAResultOrError").makeError(l):d("MAWDbParticipantTxns").getParticipant(a,b.thread.jid,i)}).then(function(b){if(!b.success)return d("WAResultOrError").makeError(l);var c=d("MAWUserJidWrapper").getMyUserJid(),e=d("MAWDbParticipant").craftParticipantId(b.value.threadJid,c);return d("MAWDbGroupInviteTxns").putGroupInvite(a,{caption:f==null?void 0:f.text,inviteCode:k,invitedParticipantId:e,inviteeJid:c,inviteExpirationTs:j,inviterJid:i,threadJid:b.value.threadJid}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"GroupInviteUpdate",value:d("MAWBridgeTypesCreators").createBridgeGroupInvite(a)});return d("WAResultOrError").makeResult()})})}g.writeGroupInvite=a;g.writeIncomingGroupInviteMsg=b}),98);
__d("MAWBuildNewMsgPayload",["FBLogger","MAWAdminMsgType","MAWAuthor","MAWDbMsg","MAWJids","MAWMsgType","WAArmadilloXMA.pb","WAAssertUnreachable","WAJids","WALogger","WAMsgType","WAStanzaUtils","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a,b,e,f){if(d("MAWDbMsg").isUnrenderedMsgType(a))throw c("FBLogger")("messenger_web").mustfixThrow("getNewMsg called for wrong message type "+a);var g,h;if(e.quote!=null&&(f==null?void 0:f.content)!=null){var i;h=f==null||(i=f.content)==null?void 0:i.externalId;g={content:f==null?void 0:f.content,remoteJid:(f=f==null?void 0:f.remoteJid)!=null?f:void 0}}if(e.noteContent!=null){f=d("MAWJids").toUserJid(b.threadJid);g={content:{author:f,expirationTs:d("WATimeUtils").castToUnixTime(e.noteExpirationTs),externalId:b.externalId,msgContent:{content:e.noteContent},ts:b.ts,type:d("WAMsgType").NOTE_REPLY},remoteJid:void 0}}f=babelHelpers["extends"]({},b,{quote:g,quoteExternalId:h});var j=e.mediaGroupMetadata;switch(a){case"Text":return babelHelpers["extends"]({},f,{msgContent:{commands:e.commands,content:e.content!=null?e.content:"",mentionedJids:e.mentionedJids},type:d("MAWMsgType").MSG_TYPE.TEXT});case"Image":return babelHelpers["extends"]({},f,{hdType:e.hdType,type:d("MAWMsgType").MSG_TYPE.IMAGE},j);case"Video":return babelHelpers["extends"]({},f,{type:d("MAWMsgType").MSG_TYPE.VIDEO});case"Ptt":return babelHelpers["extends"]({},f,{type:d("MAWMsgType").MSG_TYPE.PTT});case"Gif":return babelHelpers["extends"]({},f,{type:d("MAWMsgType").MSG_TYPE.GIF});case"Sticker":return babelHelpers["extends"]({},f,{type:d("MAWMsgType").MSG_TYPE.STICKER});case"DocumentFile":return babelHelpers["extends"]({},f,{type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE});case"XMA":if(e.xmaMessageType==null)throw c("FBLogger")("messenger_web").mustfixThrow("XMA Message Missing xmaMessageType");j=e.content!=null&&e.xmaMessageType===d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE?e.content:"";return babelHelpers["extends"]({},f,{msgContent:{commands:e.commands,content:j,mentionedJids:e.mentionedJids},type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:e.xmaMessageType});case"EditAction":throw c("FBLogger")("messenger_web").mustfixThrow("EditAction is not supported yet");case"BumpExistingMessage":return babelHelpers["extends"]({},f,{type:d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE});case"ReceiverFetch":throw c("FBLogger")("messenger_web").mustfixThrow("ReceiverFetch is not supported yet");case"GroupPollCreate":return babelHelpers["extends"]({},b,{msgContent:{adminMsgContent:[(j=e.title)!=null?j:""],adminType:d("MAWAdminMsgType").CURRENT_USER_CREATED_POLL,version:1},type:d("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE});case"GroupPollUpdate":throw c("FBLogger")("messenger_web").mustfixThrow("GroupPollUpdate is not supported yet");case"Revoked":case"DeleteForMe":case"Ciphertext":case"Futureproof":case"Unavailable":case"Admin":case"ExpiredEphemeral":case"EphemeralSettingAdmin":case"EphemeralScreenshotAction":case"AlertICDC":case"GroupInvite":case"Reaction":case"Raven":case"RavenAction":throw c("FBLogger")("messenger_web").mustfixThrow("Should not be writing ciphertext, futureproof, unsent, admin,\n        ephemeral setting messages, ephemeral screenshot action, group invite messages");default:throw c("WAAssertUnreachable")(a)}}function b(a,b,e,f){if(!d("MAWDbMsg").isUnrenderedMsgType(a))throw c("FBLogger")("messenger_web").mustfixThrow("getNewUnrenderedMsg called for wrong message type "+a);switch(a){case"EphemeralSyncResponse":if(e.ephemeralSetting==null)throw c("FBLogger")("messenger_web").mustfixThrow("Ephemeral Sync Response without ephemeral settings");return babelHelpers["extends"]({},b,{ephemeralSetting:e.ephemeralSetting,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE});case"EphemeralSettingChangeFromCurrentDevice":var g;if(e.ephemeralSetting==null)throw c("FBLogger")("messenger_web").mustfixThrow("Ephemeral Setting Change without ephemeral settings");return babelHelpers["extends"]({},b,{ephemeralSetting:e.ephemeralSetting,isEphemeralSettingReset:(g=e.isEphemeralSettingReset)!=null?g:!1,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE});case"GroupInvite":g=d("WAJids").interpretAsGroupJid(b.threadJid);if(g==null)throw c("FBLogger")("messenger_web").mustfixThrow("Group Invite without valid group jid");if(e.invitedParticipantUserJid==null)throw c("FBLogger")("messenger_web").mustfixThrow("Group Invite without invited user jid");return babelHelpers["extends"]({},b,{groupName:e.groupName==null?void 0:e.groupName,invitedParticipantUserJid:e.invitedParticipantUserJid,type:d("MAWMsgType").MSG_TYPE.GROUP_INVITE});case"SenderKeyDistribution":return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.SK_DISTRIBUTION});case"RavenAction":if(f==null)throw c("FBLogger")("messenger_web").mustfixThrow("Raven Action without Raven Message External Id");if(e.actionType==null)throw c("FBLogger")("messenger_web").mustfixThrow("Raven Action without Action Type");return babelHelpers["extends"]({},b,{actionType:e.actionType,ravenActionToMsgExternalId:d("WAStanzaUtils").toStanzaId(f),type:d("MAWMsgType").MSG_TYPE.RAVEN_ACTION});case"EditAction":throw c("FBLogger")("messenger_web").mustfixThrow("Edit action not implemented yet");default:throw c("WAAssertUnreachable")(a)}}function e(a){var b,e={author:d("MAWAuthor").getAuthorUserJid(a.author)||d("WAJids").AUTHOR_ME,externalId:a.externalId,mediaId:a.mediaId,msgId:a.msgId,plaintextHash:a.plaintextHash,specialTextSize:a.specialTextSize,ts:a.ts,xmaMessageType:a.xmaMessageType};switch(a.type){case d("MAWMsgType").MSG_TYPE.IMAGE:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.IMAGE});case d("MAWMsgType").MSG_TYPE.VIDEO:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.VIDEO});case d("MAWMsgType").MSG_TYPE.PTT:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.PTT});case d("MAWMsgType").MSG_TYPE.TEXT:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.TEXT});case d("MAWMsgType").MSG_TYPE.STICKER:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.STICKER});case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE});case d("MAWMsgType").MSG_TYPE.GIF:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.GIF});case d("MAWMsgType").MSG_TYPE.XMA:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:a.xmaMessageType});case d("MAWMsgType").MSG_TYPE.REVOKED:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.UNAVAILABLE});case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:if(((b=a.quote)==null?void 0:b.content)==null){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["BumpExistingMessage does not have quote content when replying"])));return null}return babelHelpers["extends"]({},a.quote.content,{author:d("MAWAuthor").getAuthorUserJid(a.quote.content.author)||d("WAJids").AUTHOR_ME});case d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return babelHelpers["extends"]({},e,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH});case d("MAWMsgType").MSG_TYPE.RAVEN:return babelHelpers["extends"]({},e,{ravenEphemeralMediaState:a.ravenEphemeralMediaState,ravenEphemeralType:a.ravenEphemeralType,ravenMediaType:a.ravenMediaType,type:d("MAWMsgType").MSG_TYPE.RAVEN});default:d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["msgToQuotedMsg: Unsupported message type ",""])),a.type);throw c("FBLogger")("messenger_web").mustfixThrow("Trying to reply to a message type that does not support replies")}}g.buildNewMsg=a;g.getNewUnrenderedMsg=b;g.msgToQuotedMsg=e}),98);
__d("MAWWriteOutgoingMsgApi",["MAWAckLevel","MAWBuildNewMsgPayload","MAWDbMsg","MAWDbMsgTxns","MAWDbRavenActionTxns","MAWDexieTable","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","MAWQplProxy","MAWTransactionMode","MAWVault","MAWWriteMsgTxns","WAJids","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h=function(a,b,c,e){b!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c,a,{annotations:e,instanceKey:b})};b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,ephemeralSettings:a.READWRITE,ftsBackloggedMessages:a.READWRITE,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,receiverFetchInfo:a.READONLY,threads:a.READWRITE,unrenderedMessages:a.READWRITE,xma:a.READONLY},"writeOutgoingMsg",function(a){return function(b,c,d,e,f,g,h){return i(a,b,c,d,e,f,g,h)}});function i(a,b,c,e,f,g,i,l){f.content!=null&&(f.content=d("MAWVault").vault(f.content));h("write_outgoing_msg_start",l,i);return d("MAWDexieTable").dexieAll([a.threads.get({jid:c}),a.messages.where("externalId").equals(b).toArray(),j(a,f.quote,c),d("MAWDbRavenActionTxns").maybeGetRavenMsgQueryByProtocolMsgId(a,f.ravenProtocolMsgId,g)]).then(function(c){var j=c[0],m=c[1],n=c[2];c=c[3];h("write_outgoing_msg_data_fetched",l,i,{bool:{isUnrenderedMsgType:d("MAWDbMsg").isUnrenderedMsgType(g)}});if(j==null)return{type:"missing_thread"};m=m.find(function(a){return a.threadJid===j.jid&&a.author===d("WAJids").AUTHOR_ME});if(m!=null)return m.ack>=d("MAWAckLevel").ACK.sent?{msgId:m.msgId,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:j.jid,externalId:m.externalId},type:"already_sent"}:{msgId:m.msgId,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:j.jid,externalId:m.externalId},type:"not_sent"};else{if(!d("MAWDbMsg").isUnrenderedMsgType(g)){m={ack:d("MAWAckLevel").ACK.clock,altIndex:void 0,author:d("WAJids").AUTHOR_ME,ephemeralSetting:f.ephemeralSetting,externalId:b,isForwarded:f.isForwarded,specialTextSize:f.specialTextSize,threadJid:j.jid,ts:e};var o=d("MAWBuildNewMsgPayload").buildNewMsg(g,m,f,n),p=f.isFirstMsg,q=f.openMessageOtid,r=f.openMessageParticipantCount,s=f.optimisticMsg,t=f.participantCount;m=d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,o).then(function(b){return d("MAWWriteMsgTxns").writeMsg(a,o,j,{isFirstMsg:p,isOutgoing:!0,openMessageOtid:q,openMessageParticipantCount:r,optimisticMsg:s,participantCount:t,quotedReplyAttachmentMeta:b})})}else{n={ack:d("MAWAckLevel").ACK.clock,author:d("WAJids").AUTHOR_ME,externalId:b,threadJid:j.jid,ts:e};n=d("MAWBuildNewMsgPayload").getNewUnrenderedMsg(g,n,f,c==null?void 0:c.externalId);m=d("MAWWriteMsgTxns").writeUnrenderedMsg(a,n,j)}return m.then(function(c){h("write_outgoing_msg_promise_resolved",l,i);return k(a,g,j.jid,e).then(function(){return{msgId:c.msgId,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:j.jid,externalId:b},type:"not_sent"}})})}})}function j(a,b,c){return b==null?d("MAWDexieTable").dexieResolve(null):d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(b){return b==null?null:a.threads.get({jid:b.threadJid}).then(function(a){var e=d("MAWBuildNewMsgPayload").msgToQuotedMsg(b);if(e==null)return null;b.messageExpirationTs!=null&&b.messageExpirationTs<d("WATimeUtils").unixTime()&&(e=babelHelpers["extends"]({},e,{mediaId:void 0,msgContent:void 0,type:d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL,xmaMessageType:void 0}));if(a==null||a.jid===c)return{content:e,remoteJid:null};a=d("WAJids").interpretAndValidateJid(a.jid);a=a.jidType==="group"?a.groupJid:null;return{content:e,remoteJid:a}})})}function k(a,b,e,f){if(b===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE)return d("WAJids").switchOnMsgrChatJidType(e,{group:function(){return d("MAWDexieTable").dexieResolve()},user:function(b){return a.ephemeralSettings.get({userJid:b}).then(function(b){var c;if(b==null)return d("MAWDexieTable").dexieResolve();b.ephemeralSyncResponseBackoffInfo={syncResponseRetries:((c=(c=b.ephemeralSyncResponseBackoffInfo)==null?void 0:c.syncResponseRetries)!=null?c:0)+1,syncResponseSentTs:f};return a.ephemeralSettings.put(b)}).then(c("emptyFunction"))}});return b===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE?d("WAJids").switchOnMsgrChatJidType(e,{group:function(){return d("MAWDexieTable").dexieResolve()},user:function(b){return a.ephemeralSettings.get({userJid:b}).then(function(b){if(b==null||b.ephemeralSyncResponseBackoffInfo==null)return d("MAWDexieTable").dexieResolve();b.ephemeralSyncResponseBackoffInfo=void 0;return a.ephemeralSettings.put(b).then(c("emptyFunction"))})}}):d("MAWDexieTable").dexieResolve()}g.writeOutgoingMsg=b;g.writeOutgoingMsgImpl=i;g.getQuoteInfo=j}),98);
__d("MAWWriteMetaSyncsTxns",["MAWDbDeletedMessages","MAWDbPendingStanza","MAWDbPendingStanzaTxns","MAWDbThreadTxns","MAWDexieTable","MAWFTSTxns","MAWThreadManagementTxns","WALogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=30*d("WATimeUtils").DAY_SECONDS;function a(a,b){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Received chatDelete: ",""])),b);var c=b.messageRange;c=c!=null?d("MAWDbPendingStanzaTxns").putPendingStanza(a,{content:{metaSyncMessageRange:c},type:d("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD},j,b.chatJid,d("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([d("MAWDbThreadTxns").getThread(a,b.chatJid),c,d("MAWFTSTxns").maybePutThreadToPurgeBacklog(a,b.chatJid)]).then(function(c){c=c[0];if(c.success)return d("MAWThreadManagementTxns").metaSyncChatDeleteThread(a,c.value,b.messageRange,d("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.cast(b.type));else{d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[MAWWriteMetaSyncsTxns] Thread delete stanza was processed before thread insertion ",""])),b.chatJid);return{deletedMessages:[]}}})}g.PENDING_DELETE_THREAD_EXPIRATION_IN_SEC=j;g.handleChatDelete=a}),98);
__d("WADeleteReceiptsApi",["MAWTransactionMode","WADbTransactor"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b){return a.receipts.where("waMsgId").anyOf(b)["delete"]().then(function(){})}a=d("WADbTransactor").makeSignalTransactor({receipts:d("MAWTransactionMode").READWRITE},"deleteReceipts",function(a){return function(b){return h(a,b)}});g.deleteAllReceiptsForWAMsgIds=h;g.deleteReceipts=a}),98);
__d("MAWHandleMetaSyncAction",["MAWIndexedDb","MAWTransactionMode","MAWWriteDeleteMessageTxns","MAWWriteMetaSyncsTxns","Promise","WAAssertUnreachable","WADeleteReceiptsApi","WALogger","asyncToGeneratorRuntime","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){for(a of a.actions)a.chatAction?yield k(a.chatAction):a.messageAction&&(yield n(a.messageAction))});return j.apply(this,arguments)}function k(a){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Received action: ",""])),a);switch(a.type){case"chat_archive":return l(a);case"chat_delete":return o(a).then(function(a){a=a.deletedMessages;return d("WADeleteReceiptsApi").deleteReceipts(a)});default:a.type;return m(a)}}function l(a){return(i||(i=b("Promise"))).resolve()}function m(a){return(i||(i=b("Promise"))).resolve()}function n(a){switch(a.type){case"delete_for_me":return p(a).then(c("emptyFunction"));default:return c("WAAssertUnreachable")(a.type)}}var o=d("MAWIndexedDb").makeMsgrTransactor({chunk:(e=d("MAWTransactionMode")).READWRITE,deletedMessages:e.READWRITE,editMsgHistory:e.READWRITE,ftsPurgeThreadBacklog:e.READWRITE,groupInfo:e.READWRITE,groupInvites:e.READWRITE,media:e.READWRITE,messages:e.READWRITE,participants:e.READWRITE,pendingStanzas:e.READWRITE,reactions:e.READWRITE,threads:e.READWRITE,unrenderedMessages:e.READWRITE,xma:e.READWRITE},"handleChatDeleteTxn",function(a){return function(b){return d("MAWWriteMetaSyncsTxns").handleChatDelete(a,b)}}),p=d("MAWIndexedDb").makeMsgrTransactor({chunk:e.READWRITE,editMsgHistory:e.READWRITE,ftsPurgeBacklog:e.READWRITE,groupInfo:e.READWRITE,groupInvites:e.READWRITE,media:e.READWRITE,messages:e.READWRITE,pendingStanzas:e.READWRITE,reactions:e.READWRITE,threads:e.READWRITE,unrenderedMessages:e.READWRITE,xma:e.READWRITE},"handleDeleteForMeTxn",function(a){return function(b){return d("MAWWriteDeleteMessageTxns").handleDeleteForMe(a,b)}});g.handleMetaSyncActions=a}),98);
__d("MAWChangeGroupParticipantAdminStatusApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";a=function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return d("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0,ParticipantsStore:!0},function(a){return h.apply(void 0,[a].concat(b))},"changeGroupParticipantAdminStatus")};var h=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f,g,h){var i=a.GroupInfoStore,j=a.MessagesStore;a=a.ParticipantsStore;var k=(yield i.get(c));if(!k.success)return d("WAResultOrError").makeError("missing_group");k=f.map(function(a){return{addressable:a.addressable,chatJid:c,type:g,user:a.user}});yield a.bulkPut(k);if(b!=null){yield i.update(c,function(a){return babelHelpers["extends"]({},a,{participantVersion:b.current})});for(f=0;f<k.length;f++)g==="admin"?a=d("MAWAdminMsgHelpers").createParticipantPromoteAdminMsg(c,k[f].user,e,h):a=d("MAWAdminMsgHelpers").createParticipantDemoteAdminMsg(c,k[f].user,e,h),yield j.create(a)}return d("WAResultOrError").makeResult()});return function(b,c,d,e,f,g,h){return a.apply(this,arguments)}}();g.changeGroupParticipantAdminStatus=a;g.changeGroupParticipantAdminStatusTransactor=h}),98);
__d("WADecodeIncomingMsg",["WALogger","WALongInt","WAMsgApplication.pb","WAMsgTransport.pb","WAParseMessageApplication","WAParseMessageTransport","WAStanzaUtils","WATimeUtils","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function j(a,b,c){return a.futureProof&&c!=null?{version:"v3",type:"futureProof",futureProof:a.futureProof,protobuf:b,applicationPayload:c,subtype:null}:{version:"v3",type:"error",error:a.error}}function a(a,b,c,e){if(b==="v2")return{version:"v2",encoded:a};else if(b==="v3"){var f=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMsgTransport.pb").MessageTransportSpec,a);c=d("WAParseMessageTransport").parseMessageTransport(f,c);f=n(f);if(c.type==="error")return j(c,a);if(c.type==="skdm")return k(c.skdm,c.icdc);else if(c.type==="applicationPayload"){if(e===!0){if(c.applicationPayload.payload==null){d("WALogger").DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose(["instamadillo decodeIncomingMsg called with null applicationPayload"])));return{version:"v3",type:"error",error:"instamadillo unhandled proto"}}return{version:"v3",type:"instamadillo",applicationPayload:new Uint8Array(c.applicationPayload.payload),backupDirective:f}}e=l(c.applicationPayload,a,c.icdc,f);if(c.skdm!=null){a=k(c.skdm,c.icdc);return{version:"v3",type:"msgWithSKDM",msg:e,skdm:a}}return e}else if(c.type==="empty")return{version:"v3",type:"empty"};else{c.type;return{version:"v3",type:"error",error:"unhandled proto with type "+c.type}}}else{d("WALogger").DEV(i||(i=babelHelpers.taggedTemplateLiteralLoose(["decodeIncomingMsg called with unexpected encoding version: ",""])),b);return{type:"error",version:"v3",error:"decodeIncomingMsg called with unexpected encoding version: "+b}}}function k(a,b){var c=a.axolotlSenderKeyDistributionMessage;a=a.groupId;if(c==null)return{type:"error",version:"v3",error:"parseSKDM called with null axolotlSenderKeyDistributionMessage"};else if(a==null)return{type:"error",version:"v3",error:"parseSKDM called with null groupId"};return{version:"v3",type:"skdm",msg:{senderKey:c,groupId:a},icdc:b}}function l(a,b,c,e){var f=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMsgApplication.pb").MessageApplicationSpec,a.payload);if(f.payload==null)return m(f.metadata,a.payload);var g=d("WAParseMessageApplication").parseMessageApplication(f);if(g.type==="error")return j(g,b);return a.payload==null?j({error:"Empty application payload",type:"error",version:"v3"},b):{version:"v3",type:"subprotocol",metadata:(f=f.metadata)!=null?f:null,subprotocolType:g.subprotocolType,subprotocol:g.payload,applicationPayload:a.payload,protobuf:b,frankingContent:a.payload,backupDirective:e,icdc:c}}function m(a,b){a=a==null?void 0:a.chatEphemeralSetting;if(a!=null){var c=a.ephemeralExpiration,e=a.ephemeralSettingTimestamp;if(c==null)return{version:"v3",type:"error",error:"Ephemeral setting without expiration"};if(b==null)return{error:"Empty application payload",type:"error",version:"v3"};try{e=e!=null?d("WATimeUtils").castToUnixTime(d("WALongInt").numberOrThrowIfTooLarge(e)/1e3):d("WATimeUtils").DEFAULT_UNIXTIME;return{version:"v3",type:"ephemeral",ephemeralExpirationInSec:c,ephemeralLastUpdatedOrSetTimestamp:e,isEphemeralSettingReset:(e=a.isEphemeralSettingReset)!=null?e:!1,applicationPayload:b}}catch(f){return{version:"v3",type:"ephemeral",ephemeralExpirationInSec:c,ephemeralLastUpdatedOrSetTimestamp:d("WATimeUtils").DEFAULT_UNIXTIME,isEphemeralSettingReset:(e=a.isEphemeralSettingReset)!=null?e:!1,applicationPayload:b}}}else return{version:"v3",type:"error",error:"MessageApplication has no payload and is not ephemeral"}}function n(a){a=(a=a.protocol)==null||(a=a.ancillary)==null?void 0:a.backupDirective;if(a==null)return null;var b=a.messageId,c=a.actionType;a=a.supplementalKey;return b==null||c==null?null:{messageId:d("WAStanzaUtils").toStanzaId(b),actionType:c,supplementalKey:a}}g.decodeIncomingMsg=a;g.parseEphemeralSetting=m}),98);
__d("WAParseV3Protocol",["WAAckLevel","WAAssertUnreachable","WAGlobals","WAHex","WAMsgType","WAParseConsumerMessageProtocol","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return function(b,e,f,g,h,i){var j;f={id:{chat:e,author:g,externalId:f},ts:h,serverTs:h,ack:d("WAAckLevel").ACK.RECEIVED,forwardingScore:b.type!=="futureProof"?(g=b==null||(j=b.metadata)==null?void 0:j.forwardingScore)!=null?g:0:0};h=b.type!=="futureProof"&&((h=b.metadata)==null||(h=h.chatEphemeralSetting)==null?void 0:h.ephemeralExpiration)!=null&&((g=b.metadata)==null||(g=g.chatEphemeralSetting)==null?void 0:g.ephemeralExpiration)>0;if(b.type==="futureProof"||h&&!d("WAGlobals").getConfig().isEphemeralMessagesEnabled())return{unstoredMsg:{type:d("WAMsgType").FUTUREPROOF,msgContent:{subtype:null,protobuf:d("WAHex").bytesToBuffer(b.protobuf)},id:f.id,ts:f.ts,sentTs:f.sentTs,serverTs:f.serverTs,ack:f.ack,reportingMeta:f.reportingMeta},unstoredMedia:null,unstoredQuotedMedia:null};else if(b.type==="subprotocol"){g=a==null?void 0:a.get(b.subprotocolType);if(g!=null)return g(e,b.subprotocol,f,b.protobuf,b.metadata,i);switch(b.subprotocolType){case"consumerMessage":return d("WAParseConsumerMessageProtocol").parseConsumerMessageProtocol(e,b.subprotocol,f,b.protobuf,b.metadata,i);case"businessMessage":throw c("err")("unsupported subprotocolType: "+b.subprotocolType);case"paymentMessage":throw c("err")("unsupported subprotocolType: "+b.subprotocolType);case"multiDevice":throw c("err")("unsupported subprotocolType: "+b.subprotocolType);case"voip":throw c("err")("unsupported subprotocolType: "+b.subprotocolType);default:throw c("err")("Subprotocol parser for: "+b.subprotocolType+" was not found")}}else return c("WAAssertUnreachable")(b.type)}}g.createV3ProtocolParser=a}),98);
__d("MAWMessageRequestUtils",["MAWFolderTypes","WADbContact"],(function(a,b,c,d,e,f,g){"use strict";function a(a){a=a===d("MAWFolderTypes").FOLDER_ID.PENDING||a===d("MAWFolderTypes").FOLDER_ID.OTHER;return a}function b(a,b){return(a===null||a===d("MAWFolderTypes").FOLDER_ID.INBOX)&&(b===d("WADbContact").REVERSED_ONE_WAY_CONTACT||b===d("WADbContact").NON_CONTACT)}g.isMessageRequestOrSpamThread=a;g.isInboxRequest=b}),98);
__d("MAWMarkThreadAsReadTxns",["FBLogger","MAWDbMsgTxns","MAWDexieTable","MAWMessageRequestUtils","MAWTimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,d,e,f){f===void 0&&(f=!1);var g=new Map();g.set(b,{msgId:d,sortOrderMs:e});return h(a,g,f).then(function(a){a=a.get(b);if(a==null)throw c("FBLogger")("messenger_web_devx","maw_mark_thread_as_read").warn("ThreadReadReceiptInfo unexpectedly unavailable for thread\n         in markThreadAsReadUpToMsgSortOrderMs()");return a})}function h(a,b,c){c===void 0;return j(a,b).then(function(b){var c=b.threadJidToReadReceiptInfo,d=b.updatedThreads;return a.threads.bulkPut(d).then(function(){d.forEach(function(a){c.set(a.jid,{isReadReceiptExpectedToBeSent:(a=(a=c.get(a.jid))==null?void 0:a.isReadReceiptExpectedToBeSent)!=null?a:!1,type:"success"})});return c})})}function i(a,b,c){return d("MAWDbMsgTxns").getThreadOldestMessageId(a,b.jid).then(function(a){if(a==null)return null;a=d("MAWTimeUtils").ensureValidMillisTime(b.newestMsgTs);return babelHelpers["extends"]({},b,{lastReadMsg:c.msgId,newestMsgTs:a})})}function j(a,b){var e=new Map(),f=Array.from(b.keys()),g=[];return a.threads.where("jid").anyOf(f).toArray().then(function(h){var j=new Map();h.forEach(function(a){return j.set(a.jid,a)});f.forEach(function(a){j.has(a)||j.set(a,null)});h=Array.from(j).map(function(d){var f=d[0];d=d[1];if(d==null){e.set(f,{isReadReceiptExpectedToBeSent:!1,type:"missing"});return}f=k(d.folder);e.set(d.jid,{isReadReceiptExpectedToBeSent:f,type:"success"});f=b.get(d.jid);if(f==null)throw c("FBLogger")("maw_threads","maw_mark_thread_as_read").warn("ThreadReadReceiptInfo unexpectedly unavailable for thread\n            in getThreadJidToReadReceiptInfo()");return i(a,d,f).then(function(a){a!=null&&g.push(a)})});return d("MAWDexieTable").dexieAll(h).then(function(){return{threadJidToReadReceiptInfo:e,updatedThreads:g}})})}function k(a){return!d("MAWMessageRequestUtils").isMessageRequestOrSpamThread(a)}g.markThreadAsReadUpToMsgSortOrderMs=a;g.bulkMarkThreadAsReadUpToMsgSortOrderMs=h;g.isReadReceiptExpectedToBeSentFor=k}),98);
__d("MAWRemoveGroupParticipantsApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAAPI","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";a=function(){for(var a=arguments.length,e=new Array(a),f=0;f<a;f++)e[f]=arguments[f];return d("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0,ParticipantsStore:!0},function(a){return h.apply(void 0,[a].concat(e))},"removeGroupParticipants").then(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a.success&&(yield c("WAAPI").setRotateSenderKeyToTrue([e[1]]));return a});return function(b){return a.apply(this,arguments)}}())};var h=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f,g,h){var i=a.GroupInfoStore,j=a.MessagesStore;a=a.ParticipantsStore;var k=(yield i.get(c));if(!k.success)return d("WAResultOrError").makeError("missing_group");k=f.map(function(a){return a.user});f=k.map(function(a){return{groupJid:c,userJid:a}});yield a.bulkDelete(f,{remover:e});if(b!=null){a=d("MAWAdminMsgHelpers").createParticipantRemoveAdminMsg(c,k,e,h);yield j.create(a);yield i.update(c,function(a){return babelHelpers["extends"]({},a,{participantVersion:b.current})},{updateParticipantMedatadata:g})}return d("WAResultOrError").makeResult()});return function(b,c,d,e,f,g,h){return a.apply(this,arguments)}}();g.removeGroupParticipants=a;g.removeGroupParticipantsTransactor=h}),98);
__d("createInstamadilloAddMessagePayload",["I64","InstamadilloMessageIdUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a){return a!=null?{ephemeralityParams:{ephemeralDurationSec:(h||(h=d("I64"))).to_int32(a)}}:{}}function j(a){return a.isForwarded===!0?{forwardingParams:{forwardedThreadId:(h||(h=d("I64"))).to_string(a.threadKey)}}:{}}function k(a){if(a.replySourceId==null&&a.replySourceTimestampMs==null)return{};function b(){return a.replySourceId!=null?{repliedToMessageOtid:d("InstamadilloMessageIdUtils").fromInstamadilloMessageId(a.replySourceId).stanzaId}:{}}function c(){return a.replySourceTimestampMs!=null?{repliedToMessageWaServerTimeSec:(h||(h=d("I64"))).to_string(a.replySourceTimestampMs)}:{}}return{repliedToMessage:babelHelpers["extends"]({},b(),c())}}function a(a,b){b={content:{text:{text:b?void 0:a.text}},metadata:babelHelpers["extends"]({},i(a.ephemeralDurationInSec),j(a),k(a))};return b}function b(a,b){b={content:{media:b},metadata:babelHelpers["extends"]({},i(a.ephemeralDurationInSec),j(a),k(a))};return b}function c(a,b){b={content:{receiverFetchXma:JSON.parse(b)},metadata:babelHelpers["extends"]({},i(a.ephemeralDurationInSec),j(a),k(a))};return b}g.createInstamadilloAddMessageTextPayload=a;g.createInstamadilloAddMessageMediaPayload=b;g.createInstamadilloAddMessageReceiverFetchXmaPayload=c}),98);
__d("createInstamadilloTransportPayload",[],(function(a,b,c,d,e,f){"use strict";function a(a){a={add:a};return a}function b(a){a={supplement:a};return a}function c(a){a={"delete":a};return a}function d(a){a={franking:a};return a}f.createInstamadilloAddMessageTransportPayload=a;f.createInstamadilloSupplementMessageTransportPayload=b;f.createInstamadilloDeleteMessageTransportPayload=c;f.createInstamadilloFrankingTransportPayload=d}),66);
__d("MWBUtil",[],(function(a,b,c,d,e,f){"use strict";a=30;b=["impersonation"];c=["ig_user_impersonation"];d=Array.of.apply(Array,b.concat(c));f.SPAM_REPORT_MESSAGE_COUNT=a;f.MSGR_IMPERSONATION_TAGS=b;f.IG_IMPERSONATION_TAGS=c;f.ALL_IMPERSONATION_TAGS=d}),66);
__d("MAWHIMLogger",["MWFBLogger"],(function(a,b,c,d,e,f,g){"use strict";a=d("MWFBLogger").MWLogger.tags(["HandleIncomingMessage"]);g["default"]=a}),98);
__d("MAWEphemeralAdminMsgBuildTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDexieTable","MAWEphemeralUtils","MAWIndexedDb","MAWMsgType","MAWODSProxy","MAWUserJidWrapper","MAWWriteMsgTxns","WAJids","WAOdsEnums","WATimeUtils","qex"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e,f,g,h,i,j){if(e<0)throw c("FBLogger")("messenger_web").mustfixThrow("Received unexpected ephemeral time setting");e=d("MAWEphemeralUtils").getEphemeralSettingChangeData(b,e,h,i);var k={ack:d("MAWAckLevel").ACK.sent,altIndex:void 0,author:b!=null?b:d("WAJids").AUTHOR_SYSTEM,msgContent:e,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN};h=b!=null?d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,j,g.jid,b):d("MAWDexieTable").dexieResolve();return h.then(function(b){if(b==null){var e=babelHelpers["extends"]({},k,{externalId:j,sortOrderMs:d("WATimeUtils").castUnixTimeToMillisTime(f),threadJid:g.jid,ts:f});return d("MAWWriteMsgTxns").writeDedupedEphemeralSettingAdminMessage(a,e,g,d("WATimeUtils").castUnixTimeToMillisTime(f)).then(function(a){return babelHelpers["extends"]({},e,{msgId:a.msgId,protocolMsgId:a.protocolMsgId,rowId:a.rowId})})}else if(b.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT){d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_LS_SYNC_IMPROVEMENTS,key:"ephemeral_setting_admin_msg_ciphertext_replacement"});var h=babelHelpers["extends"]({},b,k);return a.messages.put(h).then(function(){c("qex")._("4486")?d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(h)}):(c("qex")._("4486")||d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(b.threadJid,[b])}),d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(h)}));return h})}else return null})}function b(a,b,e,f,g,h,i){var j=b===d("MAWUserJidWrapper").getMyUserJid(),k=d("MAWEphemeralUtils").getEphemeralScreenshotActionData(g,b,j),l=k.ephemeralScreenshotActionContent;k=k.ephemeralScreenshotActionType;if(i==null){var m={ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:j?d("WAJids").AUTHOR_ME:b,externalId:h,msgContent:{adminMsgContent:l,adminType:k,screenshotActionType:g,version:1},sortOrderMs:d("WATimeUtils").castUnixTimeToMillisTime(f),threadJid:e.jid,ts:f,type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION};return d("MAWWriteMsgTxns").writeDedupedEphemeralSettingAdminMessage(a,m,e,d("WATimeUtils").castUnixTimeToMillisTime(f)).then(function(a){return babelHelpers["extends"]({},m,{msgId:a.msgId,protocolMsgId:a.protocolMsgId,rowId:a.rowId})})}else if(i.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT){d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_LS_SYNC_IMPROVEMENTS,key:"ephemeral_screenshot_action_msg_ciphertext_replacement"});var n=babelHelpers["extends"]({},i,{ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:j?d("WAJids").AUTHOR_ME:b,msgContent:{adminMsgContent:l,adminType:k,screenshotActionType:g,version:1},type:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION});return a.messages.put(n).then(function(){c("qex")._("4486")?d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(n)}):(d("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:d("MAWBridgeTypesCreators").createBridgeDeleteMessages(i.threadJid,[i])}),d("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:d("MAWBridgeMsg").createBridgeMsg(n)}));return n})}else return d("MAWDexieTable").dexieResolve(null)}g.writeEphemeralSettingAdminMsg=a;g.writeEphemeralScreenshotActionMsg=b}),98);
__d("MAWMsgActionType",[],(function(a,b,c,d,e,f){"use strict";a={DELETE_FOR_ME:"DELETE_FOR_ME",NO_ACTION:"NO_ACTION",REVOKE:"REVOKE",UPDATE_CIPHERTEXT:"UPDATE_CIPHERTEXT",UPDATE_CIPHERTEXT_WITH_ASSOCIATED:"UPDATE_CIPHERTEXT_WITH_ASSOCIATED",WRITE:"WRITE",WRITE_WITH_ASSOCIATED:"WRITE_WITH_ASSOCIATED"};f.MSG_ACTION=a}),66);
__d("MAWDbReceiptTxns",["MAWDexieTable","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c){return i([{deliveryReceipts:b==="delivered"?c:[],msgId:a,readReceipts:b==="read"?c:[],senderReceipts:b==="sender"?c:[]}]).then(function(a){return a[0]||{type:"missing"}})}function i(a){var b=a.map(function(a){return a.msgId}),c=new Map();a.forEach(function(a){c.set(a.msgId,a)});a=b.map(function(a){var b=c.get(a);if(b==null){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Unexpectedly fetched null data from a msgIdToReceiptData map"])));return null}var e=new Set(),f=new Map(),g=b.deliveryReceipts,i=b.readReceipts;b=b.senderReceipts;[{receiptType:"delivered",receivers:g},{receiptType:"read",receivers:i},{receiptType:"sender",receivers:b}].forEach(function(a){var b=a.receiptType;a=a.receivers;a.forEach(function(a){var c=a.device;a=a.ts;c=d("WAJids").extractUserJid(c);var g=!1;if(b!=="sender"){var h=f.get(c);a=j(h,b,a);f.set(c,a);g=k(h,a)}g&&e.add(c)})});return{affectedUserJids:e,receipt:{msgId:a,statusTsPerUser:f}}}).filter(Boolean);return d("MAWDexieTable").dexieResolve(a.map(function(a){return{affectedUserJids:a.affectedUserJids,receipt:a.receipt}}))}function j(a,b,c){var d;d=(d=a==null?void 0:a.deliveredTs)!=null?d:c;a=a==null?void 0:a.readTs;b==="read"&&a==null&&(a=c);return{deliveredTs:d,readTs:a}}function k(a,b){return((b==null?void 0:b.deliveredTs)||0)>((a==null?void 0:a.deliveredTs)||0)||((b==null?void 0:b.readTs)||0)>((a==null?void 0:a.readTs)||0)}function b(a,b){return a.receipts.bulkDelete(b)}g.writeReceiptsForDevices=a;g.bulkWriteReceiptsForDevices=i;g.bulkDeleteAllReceiptsForMessages=b}),98);
__d("MAWPendingReceiptProcessingTxns",["MAWDbMsg","MAWDbParticipantTxns","MAWDbReceiptTxns","MAWDexieTable","MAWMarkThreadAsReadTxns","WAJids","WALogger","WAMsg","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c){var e=d("WAMsg").craftWAMsgIdString({author:c.author,chat:b,externalId:c.externalId});return a.pendingReceipts.get(e).then(function(b){if(b==null)return;d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Processing pending receipts for "," from ",""])),c.externalId,c.author);if(b.author===d("WAJids").AUTHOR_ME){var f=d("MAWDexieTable").dexieResolve();b.deliveryReceipts.length>0&&(f=f.then(function(){return d("MAWDbReceiptTxns").writeReceiptsForDevices(c.msgId,"delivered",b.deliveryReceipts)}));b.readReceipts.length>0&&(f=f.then(function(){return d("MAWDbReceiptTxns").writeReceiptsForDevices(c.msgId,"read",b.readReceipts)}));return f.then(function(b){var f=[];b!=null&&b.type!=="missing"&&b.receipt.statusTsPerUser.forEach(function(b,e){var g=b.deliveredTs!=null?c.ts:d("WATimeUtils").castToUnixTime(0),h=b.readTs!=null?c.ts:d("WATimeUtils").castToUnixTime(0);b=(b=b.readTs)!=null?b:d("WATimeUtils").castToUnixTime(0);f.push(d("MAWDbParticipantTxns").updateParticipantTimestamps(a,[c.threadJid,e],g,h,b))});return d("MAWDexieTable").dexieAll(f).then(function(){a.pendingReceipts["delete"](e)})})}else return d("MAWDexieTable").dexieAll([d("MAWMarkThreadAsReadTxns").markThreadAsReadUpToMsgSortOrderMs(a,c.threadJid,c.msgId,d("WATimeUtils").castToMillisTime(d("MAWDbMsg").getSortOrderWithFallback(c)))]).then(function(){return a.pendingReceipts["delete"](e)})})}g.processPendingReceipts=a}),98);
__d("MAWUpdateIsCollapsedMsgTxns",["MAWBridgeMsg","MAWDexieTable","MAWIndexedDb","MWXMAV2IsDataclassLiveLocationXMA","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h=1e3;function a(a,b,c,e){var f=b.collapsibleId;return f==null?d("MAWDexieTable").dexieResolve(b):a.messages.where(["threadJid","collapsibleId","sortOrderMs"]).between([e,f,Number.MIN_SAFE_INTEGER],[e,f,Number.MAX_SAFE_INTEGER],!1,!1).reverse().first().then(function(e){if(e!=null)if(b.serverTs!=null&&b.serverTs>e.serverTs){var f=babelHelpers["extends"]({},e,{isCollapsed:!0});return a.messages.put(f).then(function(){return d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(f)})}).then(function(){return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},b,{isCollapsed:!1}))})}else return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},b,{isCollapsed:!0}));else return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},b,{isCollapsed:i(c,b.serverTs)}))})}var i=function(a,b){var e,f=c("justknobx")._("4207");f=Math.floor(Date.now()/h)-f;var g=a!=null?JSON.parse(a):null;return b!=null&&b<f&&d("MWXMAV2IsDataclassLiveLocationXMA").isDataclassLiveLocationXMA(a)&&(g==null||(e=g.content.custom_template_data)==null||(e=e.location_metadata)==null?void 0:e.session_state)==="STARTED"};g.maybeUpdatePreviousCollapsibleMsgs=a}),98);
__d("MAWWriteEditTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWBulkEditMsgsTxns","MAWDbEditMsgHistoryTxns","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWUnsafeCoerce","MAWUserJidWrapper","MAWWriteMsgTxns","WAJids","WAMsgType","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var e=b.args,f=b.externalId,g=e.editMsgContent;e=e.originalProtocolMsgId;var i=e.chat,j=e.externalId;return d("MAWDexieTable").dexieAll([a.threads.get({jid:i}),d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,e)]).then(function(e){var k=e[0],l=e[1];if(k==null)return d("WAResultOrError").makeError("missing_thread");if(l==null)return d("WAResultOrError").makeError("missing_msg");if(l.type!==d("WAMsgType").MSG_TYPE.TEXT)throw c("FBLogger")("messenger_web").mustfixThrow("Only text or cipher text can be edited. Original msg type: %s",l.type);return d("MAWDexieTable").dexieAll([a.messages.where("quoteExternalId").equals(j).toArray(),a.editMsgHistory.where("originalMsgExternalId").equals(j).toArray()]).then(function(e){var k=e[0];e=e[1];var m=e.find(function(a){return a.author===d("WAJids").AUTHOR_ME&&a.threadJid===i&&a.editExternalId===f});if((m==null?void 0:m.sendStatus)!=null&&m.sendStatus>d("MAWAckLevel").ACK.clock)return d("WAResultOrError").makeError("already_sent");m=[];m.push(h(b,i,j));e=e.find(function(a){return a.author===d("WAJids").AUTHOR_ME&&a.threadJid===i&&a.editExternalId===j});e==null&&(l.editCount==null||l.editCount===0)&&m.push(h(l,i,j));return d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,m,!1).then(function(){var b,e=babelHelpers["extends"]({},l,{ack:d("MAWAckLevel").ACK.clock,editCount:((b=l.editCount)!=null?b:0)+1,msgContent:g}),h=[],m=d("MAWUserJidWrapper").getMyUserJid();k.filter(function(a){var b;return(((b=a.quote)==null?void 0:b.content.author)===d("WAJids").AUTHOR_ME||((b=a.quote)==null?void 0:b.content.author)===m)&&a.threadJid===i}).forEach(function(a){if(a!=null){var b=a.quote,d=a.quoteExternalId;if(b==null)c("FBLogger")("messenger_web").warn("[edit message] Failed to get the quoted content for a msg that has been quoted.",d);else{d=babelHelpers["extends"]({},a,{quote:babelHelpers["extends"]({},b,{content:babelHelpers["extends"]({},b.content,{msgContent:babelHelpers["extends"]({},e.msgContent)})})});h.push(d)}}});return a.messages.bulkPut([e].concat(h)).then(function(){return d("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(a,l)}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(e,void 0,a)})}).then(function(){h.forEach(function(a){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(a)})});return d("WAResultOrError").makeResult({originalMsgExternalId:j,originalMsgId:l.msgId,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:i,externalId:f}})})})})})}function h(a,b,c){var e;return{author:d("WAJids").AUTHOR_ME,editExternalId:a.externalId,editTs:(e=a.serverTs)!=null?e:a.ts,msgContent:(e=(e=a.args)==null?void 0:e.editMsgContent)!=null?e:d("MAWUnsafeCoerce").unsafeCoerce(a.msgContent),originalMsgExternalId:c,sendStatus:d("MAWAckLevel").ACK.clock,specialTextSize:a.specialTextSize,threadJid:b}}function b(a,b,c,e,f,g){if(b.type!==d("WAMsgType").MSG_TYPE.TEXT||!e||e.length===0)return d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b,c,f,g);var h=e.sort(function(a,b){return b.editTs-a.editTs})[0].msgContent;e=e.length;return d("MAWWriteMsgTxns").writeNewIncomingMsg(a,babelHelpers["extends"]({},b,{editCount:e,msgContent:h}),c,f,g).then(function(c){return(c.type===d("WAMsgType").MSG_TYPE.TEXT?d("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(a,[d("MAWBulkEditMsgsTxns").getMessageHistory(babelHelpers["extends"]({},c,{msgContent:b.msgContent}),c.threadJid)],f):d("MAWDexieTable").dexieResolve()).then(function(){return c})})}g.writeEdit=a;g.writeNewIncomingMsgAndEditHistory=b}),98);
__d("MAWWriteGroupPollCreateTxns",["I64","MAWArmadilloPollTableSchema.pb","MAWCurrentUser","MAWDbParticipantTxns","MAWDexieTable","MAWIndexedDb","MAWWriteMsgTxns","WAResultOrError","WATimeUtils","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c,e){var f=c.optionsHashed;if(f==null)return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError({type:"invalid_args_poll_option_hashes"}));f=b.author;var g=b.externalId,h=b.ts,k=e.jid;return d("MAWDexieTable").dexieAll([i(a,k,c,f,g),d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b,e)]).then(function(a){var b=a[0];a=a[1];j(b,a.msgId,d("WATimeUtils").castUnixTimeToMillisTime(h))}).then(function(){return d("WAResultOrError").makeResult()})}function i(a,b,e,f,g){var h=e.encKey,i=e.latestSenderTimestampsMs,j=e.name,k=e.optionsHashed,l=e.selectableOptionsCount;return d("MAWDbParticipantTxns").getParticipantsInThread(a,b).then(function(e){var m={chatJid:b,encKey:h,latestSenderTimestampsMs:i,pollAuthor:f,pollOptions:c("nullthrows")(k),pollParticipantCount:e.length,pollStanzaId:g,pollState:d("MAWArmadilloPollTableSchema.pb").POLL_STATE.OPEN,selectableOptionsCount:l,title:j};return a.poll.put(m).then(function(){return m})})}function j(a,b,c){d("MAWIndexedDb").afterTransaction({tag:"NewPoll",value:{contactIdForCurrentUser:(h||(h=d("I64"))).of_string(d("MAWCurrentUser").getID()),dbPoll:a,latestUpdateMsgId:b,latestUpdateTimestampMs:c}})}g.handleIncomingGroupPollCreate=a;g.savePollToDb=i;g.sendPollToUI=j}),98);
__d("MAWDbPollUtils",["FBLogger","MAWLocalizationType","WAJids","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,d,e){var f=a.pollAuthor,g=new Map(a.pollOptions.entries().map(function(a){var d=a[0];a=a[1];return a.optionText==null||!a.voteAuthors.has(b)?null:[d.toString(),c("nullthrows")(a.optionText)]}).filter(Boolean)),h=new Map(e.map(function(a){return[a.hashedOptionName,a.optionName]}));e=e.filter(function(a){return!g.has(a.hashedOptionName)}).map(function(a){return a.optionName});var k=Array.from(g.entries().map(function(a){var b=a[0];a=a[1];return h.has(b)?null:a}).filter(Boolean));if(d.length>0)if(e.length>0||k.length>0)return i(a,f);else return j(a,b,d);if(e.length>0)if(k.length===0)return m(a,b,e);else if(e.length===k.length)return p(a,b,e);else return i(a,f);if(k.length>0)return s(a,b,k);throw c("FBLogger")("messenger_web").mustfixThrow("Not a valid update for poll")}function h(a){if(a===d("WAJids").AUTHOR_SYSTEM||a===d("WAJids").AUTHOR_ME)throw c("FBLogger")("messenger_web").mustfixThrow("Not a valid author for poll vote");return d("WAJids").userIdFromJid(a)}function i(a,b){var c=b===d("WAJids").AUTHOR_ME;return c?{adminMsgContent:[a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_MIXED_POLL_UPDATE,version:1}:{adminMsgContent:[h(b),a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_MIXED_POLL_UPDATE,version:1}}function j(a,b,c){if(c.length===1)return k(a,b,c[0]);else return l(a,b,c[0],c.length)}function k(a,b,c){return b===d("WAJids").AUTHOR_ME?{adminMsgContent:[c,a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_POLL_OPTION,version:1}:{adminMsgContent:[h(b),c,a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_POLL_OPTION,version:1}}function l(a,b,c,e){return b===d("WAJids").AUTHOR_ME?{adminMsgContent:[c,e.toString(),a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_MULTIPLE_POLL_OPTIONS,version:1}:{adminMsgContent:[h(b),c,e.toString(),a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_MULTIPLE_POLL_OPTIONS,version:1}}function m(a,b,c){if(c.length===1)return n(a,b,c[0]);else return o(a,b,c[0],c.length)}function n(a,b,c){return b===d("WAJids").AUTHOR_ME?{adminMsgContent:[c,a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_POLL_VOTE,version:1}:{adminMsgContent:[h(b),c,a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_POLL_VOTE,version:1}}function o(a,b,c,e){return b===d("WAJids").AUTHOR_ME?{adminMsgContent:[c,e.toString(),a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_MULTIPLE_POLL_VOTES,version:1}:{adminMsgContent:[h(b),c,e.toString(),a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_MULTIPLE_POLL_VOTES,version:1}}function p(a,b,c){if(c.length===1)return q(a,b,c[0]);else return r(a,b,c[0],c.length)}function q(a,b,c){return b===d("WAJids").AUTHOR_ME?{adminMsgContent:[c,a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CHANGED_POLL_VOTE,version:1}:{adminMsgContent:[h(b),c,a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CHANGED_POLL_VOTE,version:1}}function r(a,b,c,e){return b===d("WAJids").AUTHOR_ME?{adminMsgContent:[c,e.toString(),a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CHANGED_MULTIPLE_POLL_VOTES,version:1}:{adminMsgContent:[h(b),c,e.toString(),a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CHANGED_MULTIPLE_POLL_VOTES,version:1}}function s(a,b,c){if(c.length===1)return t(a,b,c[0]);else return u(a,b,c[0],c.length)}function t(a,b,c){return b===d("WAJids").AUTHOR_ME?{adminMsgContent:[c,a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_POLL_VOTE,version:1}:{adminMsgContent:[h(b),c,a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_POLL_VOTE,version:1}}function u(a,b,c,e){return b===d("WAJids").AUTHOR_ME?{adminMsgContent:[c,e.toString(),a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_MULTIPLE_POLL_VOTES,version:1}:{adminMsgContent:[h(b),c,e.toString(),a.title],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_MULTIPLE_POLL_VOTES,version:1}}g.getAdminMessageForUpdate=a}),98);
__d("MAWWriteGroupPollMessageTxns",["FBLogger","I64","MAWCurrentUser","MAWDbPoll","MAWDbPollTxns","MAWDbPollUtils","MAWDexieTable","MAWGroupPollsDualEncryptionUtils","MAWIndexedDb","MAWMsgType","MAWWriteMsgTxns","WALongInt","WAResultOrError","WAStanzaUtils","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c,e){var f=c.decrypted;c=c.encryptedMessage;var g=b.author,k=(c=c.pollCreationMessageKey)==null?void 0:c.id;return k==null||g==null||f==null?d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError({type:"invalid_args_poll_update_message"})):d("MAWDbPollTxns").getPoll(a,e.jid,k).then(function(c){if(c==null)return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeError({type:"missing_poll_for_update"}));var l=i(c,f),m=l.optionsToAdd;l=l.selectedOptions;m=d("MAWDbPollUtils").getAdminMessageForUpdate(c,g,m,l);var n=d("WAStanzaUtils").toStanzaId(k);l=babelHelpers["extends"]({},b,{msgContent:m,pollStanzaId:n,type:d("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE});return d("MAWDexieTable").dexieAll([j(a,c,g,f),d("MAWWriteMsgTxns").writeNewIncomingMsg(a,l,e)]).then(function(b){var c=b[0],f=b[1];return d("MAWDbPollTxns").maybeGetLatestPollUpdateMsg(a,n,e.jid).then(function(a){var b;d("MAWIndexedDb").afterTransaction({tag:"NewPoll",value:{contactIdForCurrentUser:(h||(h=d("I64"))).of_string(d("MAWCurrentUser").getID()),dbPoll:c,latestUpdateMsgId:(b=a==null?void 0:a.msgId)!=null?b:f.msgId,latestUpdateTimestampMs:d("WATimeUtils").castUnixTimeToMillisTime((b=a==null?void 0:a.ts)!=null?b:f.ts)}});return d("WAResultOrError").makeResult()})})})}function i(a,b){var c=b.optionsToAdd;b=b.vote;var e=a.pollOptions;b=((a=b==null?void 0:b.selectedOptions)!=null?a:[]).map(function(a){var b;a=d("MAWGroupPollsDualEncryptionUtils").getBase64EncodedHash(a);b=(b=e.get(a))==null?void 0:b.optionText;return b==null?null:{hashedOptionName:d("MAWDbPoll").convertOptionHashToString(a),optionName:b}}).filter(Boolean);return{optionsToAdd:(c!=null?c:[]).map(function(a){return a.optionName}),selectedOptions:b}}function j(a,b,e,f){var g,h=f.optionsToAdd;f=f.vote;var i=b.pollOptions;h=h;k(h,i);h=d("WALongInt").maybeNumber((h=f==null?void 0:f.senderTimestampMs)!=null?h:0);if(h!=null&&h>((g=b.latestSenderTimestampsMs.get(e))!=null?g:0)){b.latestSenderTimestampsMs.set(e,d("WATimeUtils").castToMillisTime(h));g=f;l(g,i,e)}else h===0?c("FBLogger")("GroupPollsE2EE").warn("Poll vote message doesn't have a timestamp"):h==null?c("FBLogger")("GroupPollsE2EE").warn("Poll vote message timestamp is not a valid number"):h===0?c("FBLogger")("GroupPollsE2EE").mustfix("Poll vote message doesn't have a timestamp"):h==null?c("FBLogger")("GroupPollsE2EE").mustfix("Poll vote message timestamp is not a valid number"):c("FBLogger")("GroupPollsE2EE").info("Dropping poll vote message since we already have a newer vote message from this author %s",e);f=babelHelpers["extends"]({},b,{pollOptions:i});return d("MAWDbPollTxns").updatePoll(a,f).then(function(){return b})}function k(a,b){a==null||a.forEach(function(a){var c=a.hashedOptionName,d={optionText:a.optionName,voteAuthors:new Set()},e=b.get(c);e==null?b.set(c,d):e.optionText===void 0&&b.set(c,{optionText:a.optionName,voteAuthors:e.voteAuthors})})}function l(a,b,c){b.values().forEach(function(a){a.voteAuthors["delete"](c)}),a==null||a.selectedOptions.forEach(function(a){a=d("MAWGroupPollsDualEncryptionUtils").getBase64EncodedHash(a);if(!b.has(a)){var e={optionText:void 0,voteAuthors:new Set()};b.set(a,e)}(e=b.get(a))==null||e.voteAuthors.add(c)})}g.handleGroupPollUpdate=a;g.writeIncomingGroupPollUpdateMsg=j}),98);
__d("MAWXMAManagementTxns",["FBLogger","MAWDexieTable","MAWMediaManagementTxns","MAWXMAUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e,f,g){var i=b.unstoredDbXMA,j=b.unstoredFavicon,k=b.unstoredHeaderMedia,l=b.unstoredPreviews;f===void 0&&(f=!1);g===void 0&&(g="wa");var m=new Map(),n=function(b){return b!=null?d("MAWMediaManagementTxns").handleUnstoredDbMedia(a,b,c,g,!0).then(function(a){return[b.plaintextHash,a]}):d("MAWDexieTable").dexieResolve([void 0,void 0])};f||(m.set(j==null?void 0:j.plaintextHash,n(j)).set(k==null?void 0:k.plaintextHash,n(k)),l==null||l.forEach(function(a){m.set(a==null?void 0:a.plaintextHash,n(a))}));b=Array.from(m.values());return d("MAWDexieTable").dexieAll(b).then(function(b){var g=new Map(b),m=(l!=null?l:[]).map(function(a){return g.get(a.plaintextHash)}).filter(Boolean);return h(a,f?d("MAWXMAUtils").buildUnstoredTombstonedXMA(i):i,g.get(j==null?void 0:j.plaintextHash),g.get(k==null?void 0:k.plaintextHash),m,c,e).then(function(a){return{dbMedias:b.map(function(a){a[0];a=a[1];return a}).filter(Boolean),dbXMA:a,firstPreview:m[0]}})})}function h(a,b,d,e,f,g,h){b=babelHelpers["extends"]({},b,{associatedMessageId:h!=null?h:void 0,defaultPreviewMediaId:(b=f[0])==null?void 0:b.mediaId,defaultPreviewMediaPlaintextHash:(h=f[0])==null?void 0:h.plaintextHash,faviconMediaId:d==null?void 0:d.mediaId,faviconPlaintextHash:d==null?void 0:d.plaintextHash,headerMediaId:e==null?void 0:e.mediaId,headerMediaPlaintextHash:e==null?void 0:e.plaintextHash,msgId:g.msgId,previewMediaIds:f.map(function(a){return a.mediaId})});return a.xma.add(b).then(function(b){return a.xma.get(b)}).then(function(a){if(a==null)throw c("FBLogger")("messenger_web").mustfixThrow("Failed to write XMA to db");return a})}function b(a,b,c,e,f,g,h,i,j,k,l,m,n){var o=d("MAWXMAUtils").isXMAExpired(!1,j.targetExpiringAtSec);j=babelHelpers["extends"]({},j,{associatedMessageId:h!=null?h:void 0,author:i.author,externalId:i.externalId,isTombstoned:o,msgId:g,offlineAttachmentId:k,targetType:f,threadJid:i.chat});var p=o?j:babelHelpers["extends"]({},j,{defaultPreviewMediaId:b!=null?b:void 0,defaultPreviewMediaPlaintextHash:l!=null?l:void 0,faviconMediaId:e!=null?e:void 0,faviconPlaintextHash:n!=null?n:void 0,headerMediaId:c!=null?c:void 0,headerMediaPlaintextHash:m!=null?m:void 0,previewMediaIds:b!=null?[b]:[]});return a.xma.add(p).then(function(a){return babelHelpers["extends"]({},p,{xmaId:a})})}g.handleUnstoredXMAContent=a;g.saveXMA=b}),98);
__d("MAWWriteXMAMessageTxns",["FBLogger","MAWBridgeMsg","MAWDbXMATxns","MAWDexieTable","MAWExpiredXMACleaner","MAWGetIsMediaDownloadStatusEnabled","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWMsgType","MAWWriteMsgTxns","MAWXMAManagementTxns","MAWXMAUtils","MWPBumpEntityKey","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";f=6*d("WATimeUtils").HOUR_SECONDS;var h=new Set([d("MAWMsgType").MSG_TYPE.TEXT,d("MAWMsgType").MSG_TYPE.GIF,d("MAWMsgType").MSG_TYPE.STICKER]);function a(a,b,c,e){var f=c.unstoredAssociatedMedia,g=c.unstoredAssociatedMsg,h=c.unstoredDbXMA;return d("MAWDbXMATxns").maybeGetAssociatedXMAMsg(a,g,e.jid).then(function(c){var i=b;if(c!=null&&c.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT){var j=c.serverTs,k=c.sortOrderMs;c=c.ts;i=babelHelpers["extends"]({},b,{serverTs:j,sortOrderMs:k!=null?k-1:k,ts:c})}j=[h.targetExpiringAtSec,h.targetType];k=j[0];c=j[1];d("MAWXMAUtils").isXMAStoryReaction(c)&&(g==null?void 0:g.msgContent)!=null&&(i=babelHelpers["extends"]({},b,{msgContent:g.msgContent}));j=d("MAWXMAUtils").isXMAExpired(h.isTombstoned,k);i.isExpiredXmaMsg=j;k=!d("MAWXMAUtils").isXMAStoryReaction(c)&&g!=null?d("MAWWriteMsgTxns").prepareMsgWriteData(a,g,e):d("MAWDexieTable").dexieResolve(null);return d("MAWDexieTable").dexieAll([d("MAWWriteMsgTxns").prepareMsgWriteData(a,i,e),k]).then(function(a){var b=a[0];a=a[1];return{associatedData:a,associatedMedia:f,associatedMsg:g,xmaData:b,xmaMsg:i}})})}function b(a,b,c,e,f){var g=c.unstoredDbXMA,h=[g.targetExpiringAtSec,g.targetType],i=h[0];h=h[1];if(b==null||b.type===d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME)return d("MAWDexieTable").dexieResolve({dbMedias:null,dbXMA:null});b.isExpiredXmaMsg!==!0&&i!=null&&d("MAWExpiredXMACleaner").addNewExpiredXMACleanerTimestamp(i);d("MAWXMAUtils").isXMAStoryReaction(h)&&d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(b)});return d("MAWXMAManagementTxns").handleUnstoredXMAContent(a,babelHelpers["extends"]({},c,{unstoredDbXMA:g}),b,f,b.isExpiredXmaMsg===!0,e).then(function(c){var e=c.dbMedias,f=c.dbXMA;c=c.firstPreview;var g=d("MAWDexieTable").dexieResolve();if(f!=null&&!d("MAWXMAUtils").isXMAStoryReply(f.targetType)&&b.isExpiredXmaMsg!==!0)if(d("MAWGetIsMediaDownloadStatusEnabled").getIsMediaDownloadStatusForXMAsEnabledWithChunkVerification()){var h=new Map(e.map(function(a){return[a.mediaId,a]})),i=f.headerMediaId!=null?h.get(f.headerMediaId):null;h=f.faviconMediaId!=null?h.get(f.faviconMediaId):null;g=d("MAWHandleXmaTransactionUtil").checkAllMediaChunksAndHandleXmaAfterTransaction(a,f,c,h,i)}else g=d("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(a,f,c);return g.then(function(){return{dbMedias:e,dbXMA:f}})})}function e(a,b,e,f,g,i,j,k){var l;if(!h.has(g.type))throw c("FBLogger")("messenger_web").mustfixThrow("flow check, this message type is not supported for XMA replies: "+g.type);var m=b.author;if(m==="@system")throw c("FBLogger")("messenger_web").mustfixThrow("wrong author of story reply");var n=d("WAJids").interpretAsUserJid(f);if(n==null)throw c("FBLogger")("messenger_web").mustfixThrow("this is a flow check, participant jid can not be null");var o=(k=k==null||(l=k[0])==null?void 0:l.plaintextHash)!=null?k:g.plaintextHash;(i?void 0:e==null?void 0:e.defaultPreviewMediaId)!=null&&o==null&&d("MWPBumpEntityKey").bumpEntityKeyWithAppId("maw.reply_attachment_media_missing_plaintext_hash","write_xma_message_txns_handle_xma_reply_msg");k={author:m===d("WAJids").AUTHOR_ME?n:d("WAJids").AUTHOR_ME,expirationTs:e.targetExpiringAtSec,externalId:e.externalId,mediaId:i?void 0:e==null?void 0:e.defaultPreviewMediaId,plaintextHash:i?void 0:o,sourceId:(m=(k=e.defaultCTA)==null?void 0:k.nativeUrl)!=null?m:(n=e.defaultCTA)==null?void 0:n.actionUrl,ts:b.ts,type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:e.targetType};var p=babelHelpers["extends"]({},g,{mediaId:(m=j==null?void 0:j.mediaId)!=null?m:g.mediaId,quote:{content:k,remoteJid:f}});return a.messages.put(p).then(function(){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:i?d("MAWBridgeMsg").createBridgeMsg(p):d("MAWBridgeMsg").createBridgeMsg(p,void 0,{replyPlaintextHash:o})})})}g.REVOKE_CONTENT_EXPIRATION_IN_SEC=f;g.XMA_REPLY_MSG_SUPPORTED_TYPES=h;g.prepareXMAWriteData=a;g.handleIncomingXMA=b;g.handleXMAReplyMsg=e}),98);
__d("MAWHandleIncomingMsgApi",["MAWDbMsgTxns","MAWDbPendingStanzaTxns","MAWDbRavenActionTxns","MAWDexieTable","MAWEphemeralAdminMsgBuildTxns","MAWEphemeralMsgTxns","MAWEphemeralSettingsTxns","MAWHIMLogger","MAWJidUtils","MAWMediaManagementTxns","MAWMsgActionType","MAWMsgType","MAWODSProxy","MAWPendingReceiptProcessingTxns","MAWUpdateIsCollapsedMsgTxns","MAWUpdateQuotedMsgTxns","MAWUseProtocolMsgIdForMsgId","MAWWriteEditTxns","MAWWriteGroupInviteTxns","MAWWriteGroupPollCreateTxns","MAWWriteGroupPollMessageTxns","MAWWriteMsgTxns","MAWWriteReceiverFetchTxns","MAWWriteRevokeMessageTxns","MAWWriteXMAMessageTxns","MAWXMAUtils","MWXMAV2IsCollapsibleXMA","WAGetPlatformFromStanzaId","WAJids","WAOdsEnums","WAResultOrError","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult(void 0));function a(a,b,e){var f,g;b.receiveFlow.addPoint("him_write_message_start");var h=((f=b==null||(g=b.msg)==null||(g=g.ephemeralSetting)==null?void 0:g.ephemeralExpirationInSec)!=null?f:0)>0;return l(a,b,e).then(function(a){var e,f,g,i;b.receiveFlow.addPoint("him_write_message_end",{bool:{isEphemeralMsg:h,outOfSync:(a==null||(e=a.value)==null?void 0:e.outOfSyncEphemeralSetting)!=null},string:{msgWrittenResultType:(f=a==null||(g=a.value)==null?void 0:g.msgType)!=null?f:"unknown"}});h&&d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.TOTAL_INCOMING_MESSAGE,key:"ephemeralMsgs"});if((b.action===d("MAWMsgActionType").MSG_ACTION.WRITE||d("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED)&&(a==null||(i=a.value)==null?void 0:i.msgType)===null){var j;c("MAWHIMLogger").warn("write action didn't produce result in DB. msg type: "+((f=b==null||(j=b.msg)==null?void 0:j.type)!=null?f:"unknown"))}return a})["catch"](function(a){var e;if(a.name==="ConstraintError"){b.type!==d("MAWMsgType").MSG_TYPE.XMA&&c("MAWHIMLogger").mustfix("encounted a ConstraintError for type %s",b.type);return d("WAResultOrError").makeError({type:"constraint_error"})}a.message="[handleIncomingMsg] ["+((e=b.type)!=null?e:"")+"/"+b.action+"] "+a.message;throw a})}function l(a,b,e){if(b.action===d("MAWMsgActionType").MSG_ACTION.NO_ACTION)return k;var f=function(c,e,f){return d("MAWEphemeralMsgTxns").syncEphemeralSettingOnIncomingMsg(a,c,e,b.thread,f)};switch(b.type){case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:return d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b.msg,b.thread,e,b.stanzaSource).then(function(){return d("WAResultOrError").makeResult(null)});case d("MAWMsgType").MSG_TYPE.RAVEN_ACTION:return d("MAWDbRavenActionTxns").writeRavenActionMsg(a,b.msg,b.thread).then(function(){return d("WAResultOrError").makeResult(null)});case d("MAWMsgType").MSG_TYPE.REACTION:return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult({reactToExternalId:b.msg.reactToExternalId}));case d("MAWMsgType").MSG_TYPE.GROUP_INVITE:return d("WAJids").isAuthorMe(b.id.author)?k:d("MAWWriteGroupInviteTxns").writeIncomingGroupInviteMsg(a,b.msg,b.thread.jid,b.folder);case d("MAWMsgType").MSG_TYPE.TEXT:case d("MAWMsgType").MSG_TYPE.FUTUREPROOF:case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.VIDEO:case d("MAWMsgType").MSG_TYPE.PTT:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:case d("MAWMsgType").MSG_TYPE.RAVEN:case d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:case d("MAWMsgType").MSG_TYPE.ADMIN:return b.action===d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME?d("MAWWriteMsgTxns").handleDeleteForMeMessage(a,b.msg,b.thread,b.pendingDeleteForMeStanza).then(function(a){return n(a)}):r(a,b.msg,b.thread.jid).then(function(c){if(c)return k;c=b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT?d("MAWWriteMsgTxns").writeCiphertextUpdate(a,b.msg,b.existingMsg,b.thread,b.existingEditMsgHistory,b.stanzaSource):b.action===d("MAWMsgActionType").MSG_ACTION.REVOKE?d("MAWWriteMsgTxns").handleOutOfOrderRevokedMessage(a,b.msg,b.thread,b.pendingRevokedStanza,b.pendingRevokedStanza!=null):d("MAWWriteEditTxns").writeNewIncomingMsgAndEditHistory(a,b.msg,b.thread,b.editMsgHistories,e,b.stanzaSource);var g=function(c,e){return d("MAWDexieTable").dexieAll([o(a,b.id,c,c.type!==d("MAWMsgType").MSG_TYPE.FUTUREPROOF),f(c,d("MAWJidUtils").getAuthorJid(b.id.author),b.ts)]).then(function(a){a[0];a=a[1];return n(c,a,e==null?null:[e])}).then(function(e){var f={author:c.author,chat:c.threadJid,externalId:c.externalId};return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,f).then(function(c){if(c!=null)return d("MAWUpdateQuotedMsgTxns").associateAllReplies(a,c,b.thread.jid)}).then(function(){return e})})};if(d("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId()){var h=b.thread.jid,i=d("MAWJidUtils").formatProtocolMsgIdFromExternalId(h,b.msg.externalId);h=b.type===d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH?d("MAWWriteReceiverFetchTxns").handleUnstoredReceiverFetchInfo(a,h,i,b.msg.sortOrderMs,b.msg.ts,b.receiverFetchInfo):d("MAWDexieTable").dexieResolve();i=b.media!=null?d("MAWMediaManagementTxns").handleUnstoredDbMediaCreation(a,b.media,i,b.msg.type,void 0):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([c,h,i]).then(function(c){var f=c[0];c[1];c=c[2];return d("MAWDexieTable").dexieAll([f,c!=null&&b.media!=null?d("MAWMediaManagementTxns").handleUnstoredDbMediaLinking(a,b.media,f,c,void 0,void 0,e):d("MAWDexieTable").dexieResolve()])}).then(function(a){var c=a[0];a=a[1];c.quote!=null&&b.receiveFlow.addAnnotations({bool:{isQuote:!0},string:{quoteType:c.quote.content.type}});return g(c,a)})}return c.then(function(c){var f=b.type===d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH?d("MAWWriteReceiverFetchTxns").handleUnstoredReceiverFetchInfo(a,c.threadJid,c.msgId,c.sortOrderMs,c.ts,b.receiverFetchInfo):d("MAWDexieTable").dexieResolve(),h=b.media!=null?d("MAWMediaManagementTxns").handleUnstoredDbMedia(a,b.media,c,b.stanzaSource,void 0,void 0,void 0,e):d("MAWDexieTable").dexieResolve();c.quote!=null&&b.receiveFlow.addAnnotations({bool:{isQuote:!0},string:{quoteType:c.quote.content.type}});return d("MAWDexieTable").dexieAll([f,h]).then(function(a){a[0];a=a[1];return g(c,a)})})});case d("MAWMsgType").MSG_TYPE.REVOKED:return d("MAWWriteRevokeMessageTxns").writeIncomingRevokeMsg(a,b.msg,b.thread,b.originalMsg,b.previousRevokeMsg,b.ebTimestampMs).then(function(c){return d("MAWDexieTable").dexieAll([o(a,b.id,c),f(c,d("MAWJidUtils").getAuthorJid(b.id.author),b.ts)]).then(function(a){a[0];a=a[1];return n(c,a)})});case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return d("MAWEphemeralSettingsTxns").handleAndWriteIncomingEphemeralSetting(a,d("MAWJidUtils").getAuthorJid(b.id.author),b.msg.ephemeralExpirationInSec,b.msg.ephemeralLastUpdatedOrSetTimestamp,b.msg.isEphemeralSettingReset,b.thread,b.ts,b.id.externalId,!0).then(function(a){return n(null,a==null?void 0:a.outOfSyncEphemeralSetting)});case d("MAWMsgType").MSG_TYPE.ICDC_ALERT:return d("MAWDexieTable").dexieResolve(d("WAResultOrError").makeResult({msgType:void 0,outOfSyncEphemeralSetting:void 0,plaintextHashs:void 0}));case d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:return d("MAWEphemeralAdminMsgBuildTxns").writeEphemeralScreenshotActionMsg(a,d("MAWJidUtils").getAuthorJid(b.id.author),b.thread,b.ts,b.screenshotActionType,b.id.externalId,b.existingMsg).then(function(c){return d("MAWDexieTable").dexieAll([o(a,b.id,c),f(c,d("MAWJidUtils").getAuthorJid(b.id.author),b.ts)]).then(function(a){a[0];a=a[1];return n(c,a)})});case d("MAWMsgType").MSG_TYPE.XMA:if(b.action===d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME)return d("MAWWriteMsgTxns").handleDeleteForMeMessage(a,b.msg,b.thread,b.pendingDeleteForMeStanza).then(function(a){return n(a)});var g=b.xma!=null&&d("MWXMAV2IsCollapsibleXMA").isCollapsibleXMA(b.xma.unstoredDbXMA.xmaDataclass)&&c("gkx")("12844")?d("MAWUpdateIsCollapsedMsgTxns").maybeUpdatePreviousCollapsibleMsgs(a,b.msg,b.xma.unstoredDbXMA.xmaDataclass,b.thread.jid):d("MAWDexieTable").dexieResolve(b.msg);g=b.action===d("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED||b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED?p(a,b,e):b.action===d("MAWMsgActionType").MSG_ACTION.REVOKE?m(a,b,e):g.then(function(c){return m(a,babelHelpers["extends"]({},b,{msg:c}),e).then(function(c){return d("MAWWriteXMAMessageTxns").handleIncomingXMA(a,c,b.xma,b.stanzaSource,null).then(function(a){return babelHelpers["extends"]({},a,{dbMsg:c})})})});return g.then(function(e){var g=e.dbAssociatedMsg,i=e.dbMedias,j=e.dbMsg;c("MAWHIMLogger").DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["handleIncomingMsgInternal: Finished writing the incoming xma, has associated data = ",""])),b.action===d("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED||b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED);return d("MAWDexieTable").dexieAll([o(a,b.id,j,!0,g),f(j,d("MAWJidUtils").getAuthorJid(b.id.author),b.ts)]).then(function(c){c[0];var e=c[1];return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b.id).then(function(c){if(c!=null)return d("MAWUpdateQuotedMsgTxns").associateAllReplies(a,c,b.thread.jid)}).then(function(){return e})}).then(function(a){return n(j,a,i)})});case d("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE:return d("MAWWriteGroupPollCreateTxns").handleIncomingGroupPollCreate(a,b.msg,b.pollInfo,b.thread);case d("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE:return d("MAWWriteGroupPollMessageTxns").handleGroupPollUpdate(a,b.msg,b.pollInfo,b.thread);default:throw c("MAWHIMLogger").mustfixThrow("We do not support handleIncomingMsgInternal with type: "+((g=b.type)!=null?g:""))}}function m(a,b,c){return b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT||b.action===d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED?d("MAWWriteMsgTxns").writeCiphertextUpdate(a,b.msg,b.existingMsg,b.thread,null,b.stanzaSource):b.action===d("MAWMsgActionType").MSG_ACTION.REVOKE?d("MAWWriteMsgTxns").handleOutOfOrderRevokedMessage(a,b.msg,b.thread,b.pendingRevokedStanza,b.pendingRevokedStanza!=null):d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b.msg,b.thread,c,b.stanzaSource)}function n(a,b,c){return d("WAResultOrError").makeResult({msgType:a==null?void 0:a.type,outOfSyncEphemeralSetting:b!=null?b:void 0,plaintextHashs:c==null?void 0:c.map(function(a){return a.plaintextHash})})}function o(a,b,e,f,g){var h=b.author;b=b.chat;f===void 0;if(e==null)return d("MAWDexieTable").dexieResolve();if(e==null)return d("MAWDexieTable").dexieResolve();f=d("MAWPendingReceiptProcessingTxns").processPendingReceipts(a,b,e);e=h===d("WAJids").AUTHOR_ME&&g!=null&&g.type!==d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME?d("MAWPendingReceiptProcessingTxns").processPendingReceipts(a,b,g):d("MAWDexieTable").dexieResolve();return d("MAWDexieTable").dexieAll([f,e]).then(function(){c("MAWHIMLogger").DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["handleIncomingMsgInternal: Finished writing the incoming message"])))})}function p(a,b,e){e===void 0&&(e=!0);b.associatedMsg.externalId===b.msg.externalId&&c("MAWHIMLogger").tags(["XMA"]).mustfix("associatedMsg and msg have the same externalId, platform %s",d("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(b.msg.externalId));var f=b.existingAssociatedMsg,g;f!=null?f.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT?g=d("MAWWriteMsgTxns").writeCiphertextUpdate(a,b.associatedMsg,f,b.thread,null,b.stanzaSource):g=d("MAWDexieTable").dexieResolve(f):g=d("MAWWriteMsgTxns").writeNewIncomingMsg(a,b.associatedMsg,b.thread,e,b.stanzaSource);return g.then(function(c){return c.type===d("MAWMsgType").MSG_TYPE.REVOKED?d("MAWDexieTable").dexieResolve({dbAssociatedMsg:null,dbMedias:null,dbMsg:null}):m(a,b,e).then(function(e){if(b.associatedMedia!=null)return d("MAWMediaManagementTxns").handleUnstoredDbMedia(a,b.associatedMedia,c,b.stanzaSource).then(function(d){return q(a,e,c,b.xma,b.msg,b.associatedMsg,b.thread.jid,b.stanzaSource,d)});else return q(a,e,c,b.xma,b.msg,b.associatedMsg,b.thread.jid,b.stanzaSource)})})}function q(a,b,e,f,g,h,i,k,l){return d("MAWWriteXMAMessageTxns").handleIncomingXMA(a,b,f,k,e.msgId).then(function(f){var k=f.dbMedias;f=f.dbXMA;e==null&&c("MAWHIMLogger").MUSTFIX(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Could not write dbAssociatedMsg but it exists: ",""])),h.externalId);return(e!=null&&f!=null&&d("MAWXMAUtils").isXMAStoryReply(f.targetType)?d("MAWWriteXMAMessageTxns").handleXMAReplyMsg(a,g,f,i,e,g.isExpiredXmaMsg===!0,l,k):d("MAWDexieTable").dexieResolve()).then(function(){return l!=null?{dbAssociatedMsg:e,dbMedias:k!=null?[].concat(k,[l]):[l],dbMsg:b}:{dbAssociatedMsg:e,dbMedias:k,dbMsg:b}})})}function r(a,b,c){var e;if(b.type!==d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE)return d("MAWDexieTable").dexieResolve(!1);e=(e=b.quote)==null||(e=e.content)==null?void 0:e.externalId;var f=(b=b.quote)==null?void 0:b.content.author;if(e==null||f==null)return d("MAWDexieTable").dexieResolve(!1);b=d("MAWJidUtils").maybeToProtocolMsgId(f,c,e);return d("MAWDexieTable").dexieAll([a.deletedMessages.get(babelHelpers["extends"]({},b)),a.unrenderedMessages.get({externalId:e}),d("MAWDbPendingStanzaTxns").maybeGetPendingRevokedStanza(a,e,f,c),d("MAWDbPendingStanzaTxns").maybeGetPendingDeletedStanza(a,e,f,c)]).then(function(a){var b=a[0],d=a[1],e=a[2];a=a[3];d=d!=null&&d.author===f&&d.threadJid===c;return b!=null||d||e!=null||a!=null})}g.handleIncomingMsg=a;g.processReceipts=o}),98);
__d("MAWLinkReactionsToMsgsTxns",["MAWDbMsgTxns","MAWDbReactionUtils","WAMsgMap"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return a.reduce(function(a,b){var c,d={author:b.reactToAuthor,chat:b.threadJid,externalId:b.reactToExternalId};c=(c=a.get(d))!=null?c:[];c.push(b);return a.set(d,c)},new(d("WAMsgMap").MsgMap)())}function i(a){a.forEach(function(a){d("MAWDbReactionUtils").dispatchReaction(a)})}function j(a,b){return a.reactions.where("reactToExternalId").anyOf(b).toArray().then(function(a){return h(a.filter(function(a){return a.reactToMsgId==null}))})}function a(a,b){return j(a,b).then(function(b){return d("MAWDbMsgTxns").getMsgsByProtocolMsgId(a,b.keys()).then(function(a){return a.flatMap(function(a){var c={author:a.author,chat:a.threadJid,externalId:a.externalId};c=(c=b.get(c))!=null?c:[];return c.map(function(b){b.reactToMsgId=a.msgId;return b})})})})}function b(a,b){return a.reactions.bulkPut(b).then(function(){i(b)})}g.getReactionLinkUpdatesForExternalIds=a;g.updateReactionLinks=b}),98);
__d("MAWOfflineThreadTxns",["I64","MAWBridgeThread","MAWDbGroupInfoTxns","MAWDbParticipantTxns","MAWDbThread","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWLoadOneToOneMessageRequestCapabilitiesTxn","MAWThreadMappingQPL","MAWUserJidWrapper","MAWWriteBulkWriteIncomingAdminMsgTxns","MWFBLogger","WAArrayZip","WAJids","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=new Set();function a(a,b,c){var e=[],f=new Set(b),g=new Map(),i=new Map();c.forEach(function(a){i.set(a.jid,"exists"),g.set(a.jid,a),f["delete"](a.jid),e.push(a)});f.forEach(function(a){j.has(a)&&d("MWFBLogger").MWLogger.tags(["occamadillo","incoming_processing"]).DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Duplicated thread creation for ",""])),a)});return o(a,f).then(function(b){b.oneToOneThreadsCreationData.forEach(function(a){j.add(a.thread.jid)});b.groupThreadsCreationData.forEach(function(a,b){j.add(b),a.groupInfo==null&&i.set(b,"missing")});return a.threads.bulkAdd(p(b),{allKeys:!0}).then(function(b){return d("MAWDbThreadTxns").getThreads(a,Array.from(f.values())).then(function(b){e.push.apply(e,b);m(e);var c=q(b);return d("MAWDexieTable").dexieAll([k(a,c),d("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreadsWithAfterTxns(a,b)]).then(function(){b.forEach(function(a){return g.set(a.jid,a)});return{threadCreationResult:i,threads:g}})})})})}function k(a,b){return d("MAWDexieTable").dexieAll([l(a,b),d("MAWLoadOneToOneMessageRequestCapabilitiesTxn").loadOneToOneMessageRequestCapabilities(Array.from(b.values()).map(function(a){return a.jid}))])}function l(a,b){var e=[],f=d("MAWUserJidWrapper").getMyUserJid();b.forEach(function(a,b){e.push({chatJid:b,type:"participant",userJid:b}),f!==b&&e.push({chatJid:b,type:"participant",userJid:f})});return d("MAWDbParticipantTxns").bulkAddParticipantsInThreads(a,e).then(c("emptyFunction"))}function m(a){a.forEach(function(a){var b=d("MAWThreadMappingQPL").getInstanceKeyForJidInWorker(a.jid);d("MAWThreadMappingQPL").startInWorker({instanceKey:b,jid:a.jid,threadKey:a.optimisticThreadKey==null?void 0:(i||(i=d("I64"))).of_string(a.optimisticThreadKey),trigger:"createAllThreadsForOfflineMsgs"});d("MAWThreadMappingQPL").addPoint("verify_optimistic_maw_thread",b);d("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:d("MAWBridgeThread").createBridgeThread(a,a.optimisticThreadKey,a.authoritativeThreadKey,"createAllThreadsForOfflineMsgs",null,b)})})}function n(a,b){return{folder:null,jid:a,lastReadMsg:null,lastReadMsgReceiptSent:null,lastReadMsgTs:null,newestMsgTs:b!=null?d("WATimeUtils").castUnixTimeToMillisTime(b):null,oldestMsg:null,optimisticThreadKey:void 0,threadOrder:d("MAWDbThread").craftThreadOrder(d("WATimeUtils").millisTime(),a)}}function o(a,b){var c=[],e=[];b.forEach(function(a){d("WAJids").switchOnMsgrChatJidType(a,{group:function(a){return c.push(a)},user:function(a){return e.push(a)}})});return d("MAWDbGroupInfoTxns").getGroupInfos(a,c).then(function(a){var b=new Map(d("WAArrayZip").zip(c,a));a=new Map(c.map(function(a){var c=b.get(a);return[a,{groupInfo:c,thread:n(a,c==null?void 0:c.creationTs)}]}));var f=new Map(e.map(function(a){return[a,{thread:n(a,null)}]}));return{groupThreadsCreationData:a,oneToOneThreadsCreationData:f}})}function p(a){var b=a.groupThreadsCreationData;a=a.oneToOneThreadsCreationData;return Array.from(b.values()).map(function(a){a=a.thread;return a}).concat(Array.from(a.values()).map(function(a){a=a.thread;return a}))}function q(a){var b=new Map();a.forEach(function(a){d("WAJids").switchOnMsgrChatJidType(a.jid,{group:c("emptyFunction"),user:function(c){return b.set(c,a)}})});return b}g.createAllThreadsForOfflineMsgs=a}),98);
__d("MAWPreprocessMsgs",["LSMEBTaskCreationSource","MAWBuildIncomingMsgs","MAWDbMsgTxns","MAWDexieTable","MAWHIMLogger","MAWMediaGalleryEBTaggingUtils","MAWMediaManagementTxns","MAWMsgActionType","MAWMsgType","MAWWriteMsgTxns","MAWWriteXMAMessageTxns","WAGlobals","WAJids"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m=c("MAWHIMLogger").tags(["MAWPreprocessMsgs"]);function a(a){var b=[],c=[];a.forEach(function(a){var d=a.msgData;a=a.unstoredContent;switch(d.type){case"IncomingMsg":if(a==null){m.MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["No unstored content for incoming message: SHOULD NEVER HAPPEN"])));return}var e=a.unstoredDbEditActionMsg;a=a.unstoredDbReaction;if(a!=null){a={chatJid:d.id.chat,unstoredReaction:a};b.push(a)}e!=null&&c.push({chatJid:d.id.chat,msg:e});break;case"IncomingCiphertextMsg":default:break}});return{editActionMsgs:c,reactionMsgs:b}}function b(a,b,c,d){b.receiveFlow.addPoint("him_get_preprocessing_data_start");return n(a,b,c,d).then(function(a){var c;b.receiveFlow.addPoint("him_get_preprocessing_data_end",{string:{action:a.action,type:(c=a.type)!=null?c:""}});return a})}function n(a,b,e,f){var g=b.msgData,h=b.receiveFlow,n=b.stanzaSource,p=b.unstoredContent;b=g.folder;var q=g.id,r=g.ts,s={id:q,receiveFlow:h,stanzaSource:n,thread:e,ts:r},t=d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.NO_ACTION,msg:null,type:null}));switch(g.type){case"IncomingMsg":if(p==null)return t;var u=p.unstoredDbGroupPollCreateInfo;h=p.unstoredDbGroupPollUpdateInfo;var v=p.unstoredDbMsg,w=p.unstoredDbRavenActionMsg,x=p.unstoredDbReaction,y=p.unstoredDbReceiverFetchInfo,z=p.unstoredIncomingDbGroupInvite;if(w!=null)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:w,type:d("MAWMsgType").MSG_TYPE.RAVEN_ACTION}));else if(x!=null)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:x,type:d("MAWMsgType").MSG_TYPE.REACTION}));else if(z!=null)return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,folder:b,msg:z,type:d("MAWMsgType").MSG_TYPE.GROUP_INVITE}));else if(v==null)return t;else if(v.type===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN){w=g.msg;if(w.version==="v3"&&w.type==="ephemeral")return d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:w,type:v.type}));else{m.MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Unexpected msg type when writing ephemeral setting message. Should not happen"])));return t}}else if(v.type===d("MAWMsgType").MSG_TYPE.TEXT||v.type===d("MAWMsgType").MSG_TYPE.FUTUREPROOF||v.type===d("MAWMsgType").MSG_TYPE.ADMIN)return d("MAWWriteMsgTxns").prepareTextMsgWriteData(a,v,e).then(function(a){var b=a.editMsgHistories,c=a.existingEditMsgHistory,e=a.existingMsg,f=a.isDeletedWithThread,g=a.isDeleteForMeOrRevoked,h=a.pendingDeleteForMeStanza;a=a.pendingRevokedStanza;var i=o(e,v,c);if(g||f||e!=null&&i!==!0)return t;if(i&&e!=null)return babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,existingEditMsgHistory:c,existingMsg:e,msg:v,type:v.type});if(h!=null)return babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:v,pendingDeleteForMeStanza:h,type:v.type});return a!=null?babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.REVOKE,msg:v,pendingRevokedStanza:a,type:v.type}):babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,editMsgHistories:b,msg:n==="ebrestore"?babelHelpers["extends"]({},v,{source:"eb_restore"}):v,type:v.type})});else if(v.type===d("MAWMsgType").MSG_TYPE.IMAGE||v.type===d("MAWMsgType").MSG_TYPE.VIDEO||v.type===d("MAWMsgType").MSG_TYPE.PTT||v.type===d("MAWMsgType").MSG_TYPE.GIF||v.type===d("MAWMsgType").MSG_TYPE.STICKER||v.type===d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE||v.type===d("MAWMsgType").MSG_TYPE.RAVEN){var A;v.type===d("MAWMsgType").MSG_TYPE.IMAGE&&((x=g.msg.metadata)==null?void 0:x.groupId)!=null&&(v.groupId=g.msg.metadata.groupId,v.groupIndex=g.msg.metadata.groupIndex,v.groupSize=g.msg.metadata.groupSize);v.type===d("MAWMsgType").MSG_TYPE.IMAGE&&(p==null||(A=p.unstoredDbMedia)==null||(A=A.validatedImageInfo)==null?void 0:A.hdType)!=null&&(v.hdType=p==null?void 0:p.unstoredDbMedia.validatedImageInfo.hdType);m.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Preparing media for msg with StanzaID ",""])),v.externalId);return d("MAWMediaManagementTxns").prepareMediaWriteData(a,v,p==null?void 0:p.unstoredDbMedia,e).then(function(a){var b=a.existingMsg,e=a.isDeletedWithThread,g=a.isDeleteForMeOrRevoked,h=a.pendingDeleteForMeStanza,i=a.pendingRevokedStanza;a=a.shouldDropDocument;var j=[p==null?void 0:p.unstoredDbMedia,o(b,v)],l=j[0];j=j[1];l==null&&m.DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Media is null for StanzaID ",""])),v.externalId);if(n==="ebrestore"&&b!=null&&l!=null&&b.source==="media_restore"&&(!d("MAWMediaGalleryEBTaggingUtils").isMediaGalleryEBTaggingRestoreEnabled()||f!==c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE)){var q=!d("MAWMediaGalleryEBTaggingUtils").isMediaGalleryEBTaggingRestoreEnabled()&&f===c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE?"media_restore":"eb_restore";return babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,existingMsg:b,media:l,msg:babelHelpers["extends"]({},v,{source:q}),type:v.type})}if(a===!0||g||e||l==null||b!=null&&!j)return t;if(j&&b!=null)return babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,existingMsg:b,media:l,msg:v,type:v.type});if(h!=null)return babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:v,pendingDeleteForMeStanza:h,type:v.type});return i!=null?babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.REVOKE,msg:v,pendingRevokedStanza:i,type:v.type}):babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,media:l,msg:n==="ebrestore"?babelHelpers["extends"]({},v,{source:f===c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE?"media_restore":"eb_restore"}):v,type:v.type})})}else if(v.type===d("MAWMsgType").MSG_TYPE.XMA){var B=p==null?void 0:p.unstoredXMA;return B==null?t:d("MAWWriteXMAMessageTxns").prepareXMAWriteData(a,v,B,e).then(function(a){var b=a.xmaData.existingMsg,c=o(b,v),e=n==="ebrestore"?babelHelpers["extends"]({},a.xmaMsg,{source:"eb_restore"}):a.xmaMsg;if(a.associatedMsg!=null&&a.associatedData!=null&&!a.associatedData.isDeletedWithThread&&!a.associatedData.isDeleteForMeOrRevoked){var f,g=a.associatedMsg,h=a.associatedData.existingMsg;if(c&&b!=null)return babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED,associatedMsg:g,existingAssociatedMsg:h,existingMsg:b,msg:e,type:v.type,xma:B});if(b!=null&&a.associatedData.existingMsg!=null)return t;if([b,(f=a.associatedData)==null?void 0:f.existingMsg].filter(function(a){return a==null}).length===1){m.mustfix("[duplicate msgs] XMA and associated inconsistency: existing message not found for %s, xmaMessageType: %s, authorMe: %s, xma data: existingMsgType: %s, isDeletedWithThread: %s, isDeleteForMeOrRevoked: %s, hasPendingDeleteForMeStanza: %s, hasPendingRevokedStanza: %s, associated data: existingMsgType: %s, isDeletedWithThread: %s, isDeleteForMeOrRevoked: %s, hasPendingDeleteForMeStanza: %s, hasPendingRevokedStanza: %s",b==null?"XMA":"Associated",e==null?void 0:e.xmaMessageType,d("WAJids").isAuthorMe(e==null?void 0:e.author),b==null?void 0:b.type,(f=a.xmaData)==null?void 0:f.isDeletedWithThread,(f=a.xmaData)==null?void 0:f.isDeleteForMeOrRevoked,((f=a.xmaData)==null?void 0:f.pendingDeleteForMeStanza)!=null,((f=a.xmaData)==null?void 0:f.pendingRevokedStanza)!=null,h==null?void 0:h.type,(f=a.associatedData)==null?void 0:f.isDeletedWithThread,(f=a.associatedData)==null?void 0:f.isDeleteForMeOrRevoked,((f=a.associatedData)==null?void 0:f.pendingDeleteForMeStanza)!=null,((f=a.associatedData)==null?void 0:f.pendingRevokedStanza)!=null)}return babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED,associatedMedia:a.associatedMedia,associatedMsg:g,existingAssociatedMsg:h,msg:e,type:v.type,xma:B})}if(c&&b!=null)return babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,existingMsg:b,msg:e,type:v.type,xma:B});f=a.xmaData;g=f.isDeletedWithThread;h=f.isDeleteForMeOrRevoked;c=f.pendingDeleteForMeStanza;f=f.pendingRevokedStanza;if(g||h||b!=null)return t;if(c!=null)return babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:a.xmaMsg,pendingDeleteForMeStanza:c,type:v.type});return f!=null?babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.REVOKE,msg:a.xmaMsg,pendingRevokedStanza:f,type:v.type}):babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:e,type:v.type,xma:B})})}else if(v.type===d("MAWMsgType").MSG_TYPE.REVOKED)return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,v.revokedExternalId,e.jid,q.author),d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,v.externalId,e.jid,q.author)]).then(function(a){var b=a[0];a=a[1];return a!=null?t:babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,ebTimestampMs:v.ebTimestampMs,msg:v,originalMsg:b,previousRevokeMsg:a,type:v.type})});else if(v.type===d("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION){b=d("WAJids").isAuthorMe(q.author)?d("WAGlobals").getMyUserJid():q.author;return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,q.externalId,e.jid,b)]).then(function(a){a=a[0];return babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,existingMsg:a,screenshotActionType:v.msgContent.screenshotActionType,type:v.type})})}else if(v.type===d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE)return d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,q.externalId,e.jid,q.author).then(function(a){return a!=null?t:babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:v,type:v.type})});else if(v.type===d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH&&y!=null)return d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,q.externalId,e.jid,q.author).then(function(a){return a!=null?t:babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:v,receiverFetchInfo:y,type:v.type})});else if(v.type===d("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE)return d("MAWDbMsgTxns").maybeGetMsgByExternalId(a,q.externalId,e.jid,q.author).then(function(a){return a!=null||u==null?t:babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:v,pollInfo:u,type:v.type})});else if(v.type===d("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE)return h==null||h.decrypted===void 0?t:d("MAWDexieTable").dexieResolve(babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:v,pollInfo:h,type:v.type}));else{m.MUSTFIX(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Unsupported message type on preprocessing ",""])),v.type);return t}case"IncomingCiphertextMsg":if(!((z=g==null?void 0:g.createPlaceholder)!=null?z:!1))return t;var C=d("MAWBuildIncomingMsgs").buildUnstoredCiphertextMsg(q,r);return d("MAWWriteMsgTxns").prepareMsgWriteData(a,C,e).then(function(a){var b=a.existingMsg,c=a.isDeletedWithThread;a=a.isDeleteForMeOrRevoked;return a||c||b!=null?t:babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:C,type:d("MAWMsgType").MSG_TYPE.CIPHERTEXT})});case"UnavailableMsg":case"FrankingInvalidMsg":var D=d("MAWBuildIncomingMsgs").buildUnstoredUnavailableMsg(q,r);return d("MAWWriteMsgTxns").prepareMsgWriteData(a,D,e).then(function(a){var b=a.existingMsg,c=a.isDeletedWithThread;a=a.isDeleteForMeOrRevoked;return a||c||b!=null?t:babelHelpers["extends"]({},s,{action:d("MAWMsgActionType").MSG_ACTION.WRITE,msg:D,type:d("MAWMsgType").MSG_TYPE.UNAVAILABLE})})}}function o(a,b,c){if(a==null&&c==null)return!1;return b.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT?!1:(a==null?void 0:a.type)===d("MAWMsgType").MSG_TYPE.CIPHERTEXT||(c==null?void 0:c.msgContent.content)===""}g.classifyIncomingMsgs=a;g.getMessageDataByType=b;g.isCiphertextUpdate=o}),98);
__d("MAWBulkHandleIncomingMsgApi",["LSMEBTaskCreationSource","MAWBulkEditMsgsTxns","MAWBulkWriteReactionsTxns","MAWDbThreadTxns","MAWDexieTable","MAWHIMLogger","MAWHandleIncomingMsgApi","MAWIndexedDb","MAWLinkReactionsToMsgsTxns","MAWMsgActionType","MAWMsgType","MAWODSProxy","MAWOfflineThreadTxns","MAWPreprocessMsgs","MAWSharedOfflineQueueMetric","MAWSharedOfflineResumeUINotifier","MAWThreadFetchAndEmitTxns","MAWTransactionMode","MAWUseProtocolMsgIdForMsgId","WAMsgMap","WAOdsEnums","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p;function a(a,b){var e;return d("MAWIndexedDb").makeMsgrTransactor({chunk:(e=d("MAWTransactionMode")).READONLY,deletedMessages:e.READWRITE,deviceChangeAlerts:e.READWRITE,editMsgHistory:e.READWRITE,ephemeralSettings:e.READWRITE,ftsBackloggedMessages:e.READWRITE,ftsPurgeBacklog:e.READWRITE,groupInfo:e.READWRITE,groupInvites:e.READWRITE,media:e.READWRITE,mediaBackup:e.READWRITE,messages:e.READWRITE,participants:e.READWRITE,pendingReceipts:e.READWRITE,pendingStanzas:e.READWRITE,poll:e.READWRITE,reactions:e.READWRITE,receiverFetchInfo:e.READWRITE,threads:e.READWRITE,unrenderedMessages:e.READWRITE,xma:e.READWRITE},"bulkHandleIncomingMsgs",function(e){return function(){var f=new(d("WAMsgMap").MsgMap)();d("MAWODSProxy").odsBumpEntityKey({amount:a.length,entity:d("WAOdsEnums").Entity.TOTAL_INCOMING_MESSAGE,key:"msgs"});d("MAWDexieTable").setDexiePSDItem("offlineQueueSize",a.length);var g=new Set(a.map(function(a){a=a.msgData;return a.id.chat})),l=d("MAWPreprocessMsgs").classifyIncomingMsgs(a),m=l.editActionMsgs,n=l.reactionMsgs,o=function(a,b){var e=f.get(a);!b.success?f.set(a,b):e==null?c("MAWHIMLogger").MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["ERROR!!! At this point we must have fields in the map, ",""])),String(b)):!e.success?c("MAWHIMLogger").WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Previous message processing action failed so subsequent one can't succeed"]))):f.set(a,d("WAResultOrError").makeResult(babelHelpers["extends"]({},e.value,b.value)))},p=function(a,b){f.set(a,d("WAResultOrError").makeResult({protocolMsgId:a,unknownGroup:b==="missing"}))},s=function(f){var g=f.threadCreationResult,h=f.threads;return d("MAWDexieTable").dexieAll(a.map(function(a){var f,i=h.get(a.msgData.id.chat);f=(f=g.get(a.msgData.id.chat))!=null?f:"missing";if(i==null){c("MAWHIMLogger").MUSTFIX(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Cannot create thread for message. Reason: ","."])),f);c("MAWHIMLogger").DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Cannot create thread for message. Reason: ",". StanzaID ",""])),f,a.msgData.id.externalId);return}p(a.msgData.id,f);return d("MAWPreprocessMsgs").getMessageDataByType(e,a,i,b)}).filter(Boolean))["catch"](function(a){a.message="[getAllMessagesProcessingData] "+a.message;throw a})},v=b!==c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE,w=function(a){a=t(a);var b=d("MAWDexieTable").dexieResolve();a.forEach(function(a){b=b.then(function(){return d("MAWHandleIncomingMsgApi").handleIncomingMsg(e,a,v)}).then(function(b){o(a.id,b),r(a.id,a.ts)})});b["catch"](function(a){a.message="[writeIncomingMsgs] "+a.message;throw a});return b},x=function(){return m.length===0?d("MAWDexieTable").dexieResolve():d("MAWBulkEditMsgsTxns").prepareDataForMessageEdit(e,m).then(function(a){return d("MAWBulkEditMsgsTxns").bulkEditMsgs(e,m,a)})};return q(e,g).then(function(a){return d("MAWDexieTable").dexieAll([s(a),d("MAWBulkWriteReactionsTxns").prepareReactionsData(e,n)]).then(function(a){var b=a[0];a=a[1];return d("MAWBulkWriteReactionsTxns").bulkWriteReactions(e,a).then(function(){return w(b)}).then(function(){return x()}).then(function(){return d("MAWThreadFetchAndEmitTxns").emitThreadContents(e,g)}).then(function(){return u(e,f)}).then(function(){return{msgResults:f}})})})}})()}function q(a,b){var c=Array.from(b);return d("MAWDbThreadTxns").getThreads(a,c).then(function(b){return d("MAWOfflineThreadTxns").createAllThreadsForOfflineMsgs(a,c,b)})}function r(a,b){var c;a=a.chat.toString();d("MAWSharedOfflineResumeUINotifier").offlineResumeUINotifier.updateChatState((c={},c[a]=b,c));d("MAWSharedOfflineResumeUINotifier").offlineResumeUINotifier.addMAWEntity(1);(a=d("MAWSharedOfflineQueueMetric").getOfflineQueueMetric())==null||a.addMAWEntity(1)}var s=c("MAWHIMLogger").tags(["MergeActions"]);function t(a){s.DEBUG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Handling "," messages"])),a.length);var b=new(d("WAMsgMap").MsgMap)();for(var c of a){s.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Handling message with StanzaID ",", action "," and type ",""])),c.id.externalId,c.action,c.type);c.receiveFlow.addPoint("him_merge_actions");var e=b.get(c.id);if(e==null){b.set(c.id,c);continue}if(e.action===c.action&&e.type===c.type){c.receiveFlow.addAnnotations({bool:{merge_actions_duplicate:!0}});continue}switch(c.action){case d("MAWMsgActionType").MSG_ACTION.NO_ACTION:continue;case d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT:case d("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED:if(e.action===d("MAWMsgActionType").MSG_ACTION.REVOKE||e.action===d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME){s.MUSTFIX(n||(n=babelHelpers.taggedTemplateLiteralLoose(["Should never have 'update ciphertext' and 'delete' in same OQ batch"])));continue}b.set(c.id,c);continue;case d("MAWMsgActionType").MSG_ACTION.WRITE:case d("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED:if(e.action===d("MAWMsgActionType").MSG_ACTION.REVOKE||e.action===d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME){s.MUSTFIX(o||(o=babelHelpers.taggedTemplateLiteralLoose(["Should never have 'write' and 'delete' in same OQ batch"])));continue}switch(c.type){case d("MAWMsgType").MSG_TYPE.UNAVAILABLE:break;case d("MAWMsgType").MSG_TYPE.CIPHERTEXT:e.type===d("MAWMsgType").MSG_TYPE.UNAVAILABLE&&b.set(c.id,c);break;default:e.type!==d("MAWMsgType").MSG_TYPE.CIPHERTEXT&&s.MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Unexpected overwrite on WRITE action. Current type: ",", next type: ",""])),e.type,c.type),b.set(c.id,c)}break;case d("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME:case d("MAWMsgActionType").MSG_ACTION.REVOKE:e.action!==d("MAWMsgActionType").MSG_ACTION.REVOKE&&b.set(c.id,c);break}}e=[];for(c of a){var f;a=b.get(c.id);c.receiveFlow.addAnnotations({string:{final_action:(f=a==null?void 0:a.action)!=null?f:"undefined",final_msg_type:(f=a==null?void 0:a.type)!=null?f:"undefined",has_replaced_action:(c!==a).toString(),initial_action:c.action,initial_msg_type:c.type}});if(a==null||a.action===d("MAWMsgActionType").MSG_ACTION.NO_ACTION)continue;e.push(a);b["delete"](c.id)}return e}function u(a,b){if(d("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId())return d("MAWDexieTable").dexieResolve();var c=new Set();b.values().forEach(function(a){if(a.success){a=a.value;var b=a.protocolMsgId;a=a.reactToExternalId;a!=null?c.add(a):b!=null&&c.add(b.externalId)}});return d("MAWLinkReactionsToMsgsTxns").getReactionLinkUpdatesForExternalIds(a,Array.from(c)).then(function(b){return d("MAWLinkReactionsToMsgsTxns").updateReactionLinks(a,b)})}g.bulkHandleIncomingMsgs=a;g.linkMsgsToReactions=u}),98);
__d("MAWCommonScheduler",["WorkerScheduler"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){h==null&&(h=d("WorkerScheduler").makeScheduler("msgr-common",{concurrency:1,maxConcurrency:10,maxThrottleMs:5e3}));return h}g.mawCommonScheduler=a}),98);
__d("MAWIsQuotaExceededError",[],(function(a,b,c,d,e,f){"use strict";a=function(a){return a.name==="QuotaExceededError"||a.inner&&a.inner.name==="QuotaExceededError"};f.isQuotaExceededError=a}),66);
__d("MAWIncomingMsgUtils",["FBLogger","MAWCurrentUser","MAWEphemeralUtil","MAWLocalizationUtils","MAWParseArmadilloProtocol","MAWUnstoredContentToUnstoredDbContentUtils","MpsAdminMsgToBridge","WAJids","WAParseV3Protocol"],(function(a,b,c,d,e,f,g){"use strict";var h=["threadJid"],i=null;function j(){if(i==null){var a=function(a,b,c,e,f,g){return d("MAWParseArmadilloProtocol").parseArmadilloProtocol(a,b,c,e,f,g)};i=d("WAParseV3Protocol").createV3ProtocolParser(new Map([["armadillo",a]]))}return i}function a(a){var b=a.author,e=a.chat,f=a.ebTimestampMs,g=a.externalId,h=a.msg,i=a.reportingMeta;a=a.serverTs;if(h.version==="v2")throw c("FBLogger")("messenger_web").mustfixThrow("Armadillo does not support protobuf v2");if(h.type==="ephemeral"){var l=d("MAWEphemeralUtil").buildUnstoredDbEphemeralSettingMsgWithoutContentPlaceholder(a);i!=null&&l.unstoredDbMsg!=null&&(l.unstoredDbMsg.reportingMeta=i);return l}if(h.type==="admin"){l=b==="@me"?d("MAWCurrentUser").getID():d("WAJids").extractUserId(b);return k(l,e,g,h,a,f)}l=babelHelpers["extends"]({unstoredXMA:null},j()(h,e,g,b,a,f));i!=null&&l.unstoredMsg!=null&&(l.unstoredMsg.reportingMeta=i);return d("MAWUnstoredContentToUnstoredDbContentUtils").unstoredContentToUnstoredDbContent(l)}function k(a,b,c,e,f,g){a=d("MpsAdminMsgToBridge").getMessageContent(a,e.content);if(a==null)return{unstoredDbMedia:null,unstoredDbMsg:null,unstoredDbReaction:null};e=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:a.adminMsgContent,adminType:a.adminType,version:1},b,c,f,void 0,g!=null?g:f*1e3);e.threadJid;a=babelHelpers.objectWithoutPropertiesLoose(e,h);return{unstoredDbMedia:null,unstoredDbMsg:a,unstoredDbReaction:null}}g.getDbMsg=a;g.getMiTransportAdminDbMsg=k}),98);
__d("MAWProtocolQueueDecodeProto",["MAWIncomingMsgUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){switch(a.type){case"IncomingMsg":var c=a.folder,e=a.id,f=a.msg,g=a.reportingMeta;a=a.ts;var h=e.author,i=e.chat;e=e.externalId;return d("MAWIncomingMsgUtils").getDbMsg({author:h,chat:i,ebTimestampMs:b,externalId:e,folder:c,msg:f,reportingMeta:g,serverTs:a});case"InvisibleMsg":case"IncomingCiphertextMsg":default:return}}g.decodeMsg=a}),98);
__d("isUseridAnnotationEnabled",["gkx"],(function(a,b,c,d,e,f,g){"use strict";function a(){return c("gkx")("24163")}g["default"]=a}),98);
__d("MAWUserHash",["MAWCurrentUser","WAGlobals","WAJids","isUseridAnnotationEnabled"],(function(a,b,c,d,e,f,g){"use strict";function a(){return d("MAWCurrentUser").isEmployee()&&c("isUseridAnnotationEnabled")()?d("WAJids").extractUserId(d("WAGlobals").getMyUserJid()).slice(-5):null}g.getUserHash=a}),98);
__d("MAWIncomingMsg",["MAWUserHash","MWFBLogger","WAGetPlatformFromStanzaId","WAHashStringToNumber","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";a=d("MWFBLogger").MWLogger.tags(["ServerRPC","HandleIncomingMsg"]);b=function(a){var b=a.encTypes,c=a.incomingType,e=a.msg,f=a.queueType,g=a.retryCount;a=a.taskSource;var h=e.details;e=e.decrypted;return{"int":{messageAge:d("WATimeUtils").unixTime()-h.ts,msgId:d("WAHashStringToNumber").hashStringToNumber(h.externalId.toString()),offlineDelivery:h.offline,retryCount:g,taskSource:a},string:{e2eePlatform:d("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(h.externalId),incomingType:c,jid:h.from.chat,msgDecryptedDataType:e.type,msgType:h.type,queueType:f,threadType:h.from.type,userHash:d("MAWUserHash").getUserHash()},string_array:{encTypes:b}}};g.logger=a;g.prepareAnnotationsForIncomingMessage=b}),98);
__d("MAWMessageReceiveReliabilityLogger",["WAHashStringToNumber","WAQPLProxy","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h=c("qpl")._(1056840931,"814"),i=c("qpl")._(521477947,"2395"),j=60*1e3;function a(a){return d("WAQPLProxy").waQPLProxyStart(a.incomingType==="wa"?h:i,{"int":{msgId:d("WAHashStringToNumber").hashStringToNumber(a.stanzaId)},string:{incomingType:a.incomingType,jid:a.jid,msgType:a.type}},d("WAHashStringToNumber").hashStringToNumber(a.stanzaId),j)}b=5*60*1e3;g.logRRStartForMessage=a;g.RECEIVE_RELIABILITY_TIMEOUT=b}),98);
__d("MAWProtocolQueueUtils",["MAWIncomingMsg","MAWMessageReceiveReliabilityLogger","WAGetStorageQplAnnotations","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=d("MAWMessageReceiveReliabilityLogger").logRRStartForMessage(a);c.addAnnotations(d("MAWIncomingMsg").prepareAnnotationsForIncomingMessage({incomingType:a.incomingType,msg:a.message,queueType:a.message.details.offline!=null?"offline":"online",retryCount:a.message.details.retryCount,taskSource:b}));return c}function b(a,b){c("promiseDone")(d("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(a){b.addAnnotations(a)}));b.addPoint("consumer_handle_message_stanza_start");return babelHelpers["extends"]({},a,{receiveFlow:b})}g.startMetricForIncomingMsgV2=a;g.addAnnotationsToMessage=b}),98);
__d("MAWGetSyncResponseBackoffInfoByJidApi",["MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({ephemeralSettings:d("MAWTransactionMode").READONLY},"getSyncResponseBackoffInfoByJid",function(a){return function(b){return a.ephemeralSettings.get({userJid:b}).then(function(a){return a==null?null:a.ephemeralSyncResponseBackoffInfo})}});g.getSyncResponseBackoffInfoByJid=a}),98);
__d("MAWSendEphemeralSettingMsg",["MAWGetSyncResponseBackoffInfoByJidApi","MAWLoggerUtils","MAWMessageSendsCommon","MAWMsgType","MAWSendWrittenMsg","MAWWriteOutgoingMsgApi","MWFBLogger","WAAPI","WAJids","WAQPLProxy","WAResultOrError","WATimeUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=d("MWFBLogger").MWLogger.tags([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.SettingSync]);function m(a,b,c,d,e,f){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,m){if(a.isForSyncResponse){var n=(yield d("WAJids").switchOnMsgrChatJidType(b,{group:function(){throw l.mustfixThrow("ChatJid is not supposed to be a group")},user:function(a){return d("MAWGetSyncResponseBackoffInfoByJidApi").getSyncResponseBackoffInfoByJid(a)}}));if(o(f,n)){l.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["ephemeral sync response backed off"])));return d("WAResultOrError").makeResult({description:"send not needed",messageType:"fixMe"})}}n=a.isForSyncResponse?d("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:d("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE;yield c("WAAPI").getDevicesBeforeSend({chatJid:b,reason:"SendEphemeralSettings"});f=(yield d("MAWWriteOutgoingMsgApi").writeOutgoingMsg(e,b,f,a,n,g,m));l.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["send ephemeral setting message: chatJid ",", type ",", externalId ",""])),b,n,e);if(f.type==="already_sent"){l.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["sendMsg already sent message"])));return d("WAResultOrError").makeError({isRetriable:!1,type:"already-sent"})}else if(f.type==="missing_thread"){l.DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["sendMsg cannot send to a non-existent thread"])));return d("WAResultOrError").makeError({isRetriable:!1,type:"missing-thread"})}b=(yield d("MAWSendWrittenMsg").sendWrittenMsgExternal({protocolMsgId:f.protocolMsgId,type:"message"},d("WAQPLProxy").waQPLProxyStartResume(g,m),"MAWSendEphemeralSettingMsg"));if(b.success===!1)return d("WAResultOrError").makeError(b.error);else return d("WAResultOrError").makeResult({chatJid:f.protocolMsgId.chat,content:a.content,ephemeralSetting:a.ephemeralSetting,externalId:f.protocolMsgId.externalId,initiatingSource:a.initiatingSource,messageType:"sendMsg",quote:a.quote,source:a.source,specialTextSize:a.specialTextSize,xmaMessageType:a.xmaMessageType})});return n.apply(this,arguments)}function a(a){var b=a.args,c=a.chatJid,e=a.externalId,f=a.qplEventType,g=a.qplInstanceKey;return d("MAWMessageSendsCommon").messageSendObserver(f,g,function(a){return m(b,c,e,a,f,g)},"ephemeral",{author:d("WAJids").AUTHOR_ME,chat:c,externalId:e})}function o(a,b){if(b==null)return!1;var c=b.syncResponseRetries;b=b.syncResponseSentTs;switch(c){case 1:return d("WATimeUtils").happenedWithinAt(a,b,3*60);case 2:return d("WATimeUtils").happenedWithinAt(a,b,15*60);default:return!0}}g.sendEphemeralSettingMsgFn=a}),98);
__d("MAWSharedCOPLogger",["MWFBLogger"],(function(a,b,c,d,e,f,g){"use strict";a=d("MWFBLogger").MWLogger.tags(["COP"]);g["default"]=a}),98);
__d("MAWThreadUpdateMiddlewareGatingUtil",["qex"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a;return(a=c("qex")._("4760"))!=null?a:!1}g.isReverseMsgOrderForThreadUpdateProcessingEnabled=a}),98);
__d("MAWUpdateThreadActivityFromCOP",["I64","MAWDbMsgTxns","MAWDeletedReactionsCache","MAWDexieTable","MAWGetBumpTimestampMs","MAWIndexedDb","MAWMsgType","MAWThreadUpdateMiddlewareGatingUtil","MAWTransactionMode","MAWUpdateThreadActivity","WALogger","asyncToGeneratorRuntime","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=p(a);if(a.length===0)return;yield k(a)});return j.apply(this,arguments)}var k=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY},"updateThreadActivityFromCOP",function(a){return function(b){return l(a,b)}});function l(a,b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b.protocolMsgId,e=b.source;b=b.unstoredDbContent;var f=b.unstoredDbMsg;b=b.unstoredDbReaction;if(b!=null)return m(a,b,c,e);return f!=null?f.type===d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE?o(a,c,e):n(a,f,c,e):d("MAWDexieTable").dexieResolve()})).then(c("emptyFunction"))}function m(a,b,c,e){return q(a,b,c).then(function(f){if(f)return;if(b.reaction!=null)return d("MAWUpdateThreadActivity").updateThreadActivityFromInsertionTxn(a,b,c.chat,e);f=d("MAWDeletedReactionsCache").DeletedReactionsCache.get(c);d("MAWDeletedReactionsCache").DeletedReactionsCache["delete"](c);if(f!=null)return d("MAWUpdateThreadActivity").updateThreadActivityFromDeletionTxn(a,f,f.threadJid)})}function n(a,b,c,e){return d("MAWUpdateThreadActivity").updateThreadActivityFromInsertionTxn(a,b,c.chat,e)}function o(a,b,c){return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(e){if(e==null){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[MAWUpdateThreadActivityFromCOP] Bump message not found in db"])));return}d("MAWUpdateThreadActivity").updateThreadActivityFromInsertionTxn(a,e,b.chat,c)})}function p(a){a=a.map(function(a){var b=a[0],c=b.decodedMsg;b=b.stanza;a[1];a=a[2];return c==null||a==null||!a.success?null:{protocolMsgId:a.value.protocolMsgId,source:b.incomingType==="ebrestore"?"eb_restore":"incoming_msg",unstoredDbContent:c}}).filter(Boolean);d("MAWThreadUpdateMiddlewareGatingUtil").isReverseMsgOrderForThreadUpdateProcessingEnabled()&&a.sort(r);return a}function q(a,b,c){return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,{author:b.reactToAuthor,chat:c.chat,externalId:b.reactToExternalId}).then(function(a){return a==null})}function r(a,b){return(i||(i=d("I64"))).compare(s(b.unstoredDbContent),s(a.unstoredDbContent))}function s(a){var b=a.unstoredDbMsg;a=a.unstoredDbReaction;if(a!=null)return d("MAWGetBumpTimestampMs").getBumpTimestampMs(a);return b!=null?d("MAWGetBumpTimestampMs").getBumpTimestampMs(b):(i||(i=d("I64"))).zero}g.maybeUpdateThreadActivityFromCOPMessagesHandler=a}),98);
__d("WAQueryGroupInvite",["WADeprecatedSendIq","WAPREList","WAPREMetrics","WAQueryGroup","WAResultOrError","WAWap","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,d){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e){var f,g=d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.QUERY_GROUP,{string:{key:"query_group_invite"}});a=(f=d("WAWap")).wap("iq",{id:f.generateId(),to:f.GROUP_JID(a),type:"get",xmlns:"w:g2"},f.wap("query",null,f.wap("add_request",{admin:f.USER_JID(e),code:f.CUSTOM_STRING(b),expiration:f.CUSTOM_STRING(c.toString(10))})));e=(yield d("WADeprecatedSendIq").deprecatedSendIq(a,d("WAQueryGroup").parseQueryGroupResponse));if(!e.success){g.endFail("query_group_for_invitee_fail");return d("WAResultOrError").makeError(e)}g.endSuccess();return d("WAResultOrError").makeResult(e.result.group)});return h.apply(this,arguments)}g.queryGroupInvite=a}),98);
__d("MAWCOPMessagesHandler",["EBAPI","FBLogger","IGDInstamadilloUtils","LSMEBTaskCreationSource","LSMessagingThreadAttributionType","MAWBridge","MAWCommonScheduler","MAWDebugMsg","MAWDownloadAndHandleMedia","MAWExternalId","MAWIsQuotaExceededError","MAWJobDefinitions","MAWJobManager","MAWLoggerUtils","MAWMediaManagerUiIntegrationCheck","MAWMessageDropError","MAWMessageParseError","MAWMpsGating","MAWMsgType","MAWODSProxy","MAWProtocolQueueDecodeProto","MAWProtocolQueueMsg","MAWProtocolQueueUtils","MAWQplProxy","MAWSendEphemeralSettingMsg","MAWSharedCOPLogger","MAWUpdateThreadActivityFromCOP","MWEBODSEntityName.enum","MWEBODSUtils","MWSharedS2SBaseAnnotations","Promise","WACreateGroup","WAGlobals","WAHashUtils","WAIsMediaDownloadRemovePersistedJobEnable","WAJids","WAJobOrchestratorTypes","WAMsgMap","WAOdsEnums","WAProtocolQueue","WAQueryGroup","WAQueryGroupInvite","WAResultOrError","WAStartMediaDownloadQplFlow","WATimeUtils","WorkerScheduler","asyncToGeneratorRuntime","err","gkx","promiseDone","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q;function a(a,b){b===void 0&&(b=c("LSMEBTaskCreationSource").UNKNOWN);return r(a,b)["catch"](function(a){if(d("MAWIsQuotaExceededError").isQuotaExceededError(a))throw a;c("MAWSharedCOPLogger").catching(a).MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Message consumer error"])));return[]})}function r(a,b){return s.apply(this,arguments)}function s(){s=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){if(a.length===0)return[];var e=new Set();x(a);var f=new(d("WAMsgMap").MsgMap)(),g=c("gkx")("8488"),h=new Map(a.map(function(a){a=y(a);a=d("WAProtocolQueue").mapProcolQueueMessageV2toV1(a);var g=a.incomingType==="ebrestore",h=d("MAWProtocolQueueUtils").startMetricForIncomingMsgV2(a,b);try{if(a.message.decrypted.type==="InstamadilloMsg")if(c("gkx")("3577")){d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.IGDW_INSTAMADILLO_MESSAGE_ON_OLD_WORKER,key:"message"});e.add(a.stanzaQueueId);h.endFail("instamadillo_msg_on_old_worker");return null}else{h.endFail("instamadillo_msg_not_supported_on_msgr");throw c("FBLogger")("messenger_web").mustfixThrow("InstamadilloMsg is not supported in MSGR. Should never happen "+d("IGDInstamadilloUtils").getE2EEGatingStateAsString())}var i=d("MAWProtocolQueueDecodeProto").decodeMsg(a.message.decrypted,a.ebTimestampMs);f.set(a.message.decrypted.id,a.incomingType);g&&(a.message.details.type=(i==null?void 0:i.unstoredDbReaction)!=null?"reaction":(i==null?void 0:i.unstoredXMA)!=null||(i==null?void 0:i.unstoredDbMedia)!=null?"media":"text");return[a.stanzaQueueId,d("MAWProtocolQueueUtils").addAnnotationsToMessage({decodedMsg:i!=null?i:void 0,stanza:babelHelpers["extends"]({},a)},h)]}catch(b){g=b instanceof Error?b:c("err")("Unknown error");c("MAWSharedCOPLogger").catching(g).MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Decode error"])));i=b instanceof d("MAWMessageParseError").MAWMessageParseError?b:null;var j=b instanceof d("MAWMessageDropError").MAWMessageDropError;if(j){e.add(a.stanzaQueueId);h.addPoint("network_verification_msg_dropped");h.endSuccess({string:{isDropped:"true"}});return null}e.add(a.stanzaQueueId);h.endFail("decoding_error",{string:{errorDescription:(a=(j=i==null?void 0:i.message)!=null?j:g==null?void 0:g.message)!=null?a:"",isDropped:"true"}});return null}}).filter(Boolean)),i=0;if(g&&!d("MAWMpsGating").isEbUploadViaMpsEnabled())try{d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload.api.receive.call",h.size);var j=Array.from(h.values()).filter(function(a){return a.stanza.incomingType==="wa"});i=j.length;yield c("EBAPI").uploadReceivedMessagesProtobufOnly({uploadArray:j})}catch(a){c("MAWSharedCOPLogger").catching(a).MUSTFIX(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Cannot prepare msgs to put to EBUploadQueue"])))}var q=(yield d("MAWProtocolQueueMsg").handleIncomingMessagesStanzas(Array.from(h.values()),b));q.toAck.forEach(function(a){return e.add(a)});j=a.map(function(a){var b=h.get(a.stanzaQueueId);if(b==null)return null;b=b;var c=q.followUpParams.incomingMsgResults.get(b.stanza.message.decrypted.id);return[b,e.has(a.stanzaQueueId),c]}).filter(Boolean);if(!g&&!d("MAWMpsGating").isEbUploadViaMpsEnabled())try{d("MWEBODSUtils").markODSForEB(c("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload.api.receive.call",h.size),yield c("EBAPI").uploadReceivedMessages({incomingMessages:Array.from(h.values()).filter(function(a){return a.stanza.incomingType==="wa"}),msgResults:q.followUpParams.incomingMsgResults})}catch(a){c("MAWSharedCOPLogger").catching(a).MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Cannot prepare msgs to put to EBUploadQueue"])))}e.size!==a.length&&c("MAWSharedCOPLogger").WARN(n||(n=babelHelpers.taggedTemplateLiteralLoose(["Errors occurred while processing messages batch, see transactor error reports."])));var r=new Map(),s=new Set();j.forEach(function(a){var e=a[0],g=a[1];a=a[2];e.receiveFlow.addPoint("consumer_handle_message_stanza_end",{bool:{dbSuccess:!!(a!=null&&a.success)}});if(g){e.receiveFlow.addPoint("ack_received");var h=e.stanza.message.decrypted.type;h==="UnavailableMsg"||h==="IncomingCiphertextMsg"?e.receiveFlow.endFail(h):(e.stanza.message.details.type==="media"&&e.receiveFlow.addPoint("message_with_media"),e.receiveFlow.endSuccess())}if(!a&&!g){c("MAWSharedCOPLogger").MUSTFIX(o||(o=babelHelpers.taggedTemplateLiteralLoose(["Cannot find db result for message"])));e.receiveFlow.endFail("db_result_not_found");return}if(!a)return;if(a.success===!1){h=a.error;switch(h.type){case"group_invite":e.receiveFlow.endFail("end_with_db_error_group_invite");r.set(h.groupJid,{folder:h.folder,inviteCode:h.inviteCode,inviteExpireTs:h.inviteExpireTs,inviterJid:h.inviterJid});e.receiveFlow.endFail("need_group_invite");break;case"invalid_args":e.receiveFlow.endFail("invlid_args");break;default:e.receiveFlow.endFail(h.type);break}return}a.success;if(a.value!=null){g=a.value;var i=g.msgType;h=g.outOfSyncEphemeralSetting;a=g.plaintextHashs;var j=g.protocolMsgId;g=g.unknownGroup;if(g){g=d("WAJids").interpretAsGroupJid(j.chat);g!=null&&s.add(g)}t(h,j);g=b!==c("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE;g&&(a==null||a.forEach(function(a){c("MAWSharedCOPLogger").DEBUG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Media: externalId="," - plaintextFollowUp - plaintextHash=",""])),e.stanza.message.details.externalId,d("WAHashUtils").sanitisePlaintextHash(a));u({msgType:i,plaintextHash:a,protocolMsgId:j,source:(a=f.get(j))!=null?a:"wa"})}))}});yield d("MAWUpdateThreadActivityFromCOP").maybeUpdateThreadActivityFromCOPMessagesHandler(j);v(s);w(r);g&&i>0&&i>e.size&&d("MAWODSProxy").odsBumpEntityKey({amount:i-e.size,entity:d("WAOdsEnums").Entity.EB_UPLOAD,key:"upload_count_higher_than_acks"});return Array.from(e)});return s.apply(this,arguments)}function t(a,e){a!=null&&(c("MAWSharedCOPLogger").tags([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.SettingSync]).DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["handleMsg: detected out-of-sync ephemeral setting for ",", sending EPHEMERAL_SYNC_RESPONSE"])),e==null?void 0:e.externalId),c("promiseDone")(d("MAWCommonScheduler").mawCommonScheduler().runTask({fn:function(){var e=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var b=d("MAWLoggerUtils").getInstanceKey(),e=d("MAWQplProxy").startQplUserFlow(c("qpl")._(25313175,"1551"),yield d("MWSharedS2SBaseAnnotations").getSendToSentBaseAnnotations(d("MWSharedS2SBaseAnnotations").getMessageTypeParams({isEphemeralSetting:!0}),c("LSMessagingThreadAttributionType").UNKNOWN),{providedInstanceKey:b});try{b=(yield d("MAWSendEphemeralSettingMsg").sendEphemeralSettingMsgFn({args:{ephemeralSetting:{ephemeralExpirationInSec:a.correctEphemeralExpirationInSec,ephemeralLastUpdatedOrSetTimestamp:a.correctEphemeralLastUpdatedOrSetTimestamp},isEphemeralSettingReset:!1,isForSyncResponse:!0},chatJid:a.chatJid,externalId:d("MAWExternalId").generateExternalId(),qplEventType:c("qpl")._(25313175,"1551"),qplInstanceKey:b}));if(b.success){e.endSuccess();if(b.value!=null){var f=b.value;d("MAWBridge").getBridge().fireAndForget("event","handleMessageSendResult",{report:f,success:!0},!0)}}else e.endFail(b.error.type)}catch(a){f=a instanceof Error?a:null;e==null||e.endFail("failed_to_send_empemeral_settings",{string:{errorDescription:(b=f==null?void 0:f.message)!=null?b:""}})}});function f(){return e.apply(this,arguments)}return f}(),name:"ephemeral_sync_response",priority:d("WorkerScheduler").BACKGROUND_PRIORITY})))}function u(a){var b=a.msgType,e=a.plaintextHash,f=a.protocolMsgId;a=a.source;if(f!=null&&e!=null&&b!==d("MAWMsgType").MSG_TYPE.RAVEN){c("MAWSharedCOPLogger").tags(["downloadAndHandleMedia"]).DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Scheduling job for ",", plaintextHash: ",""])),String(f),d("WAHashUtils").sanitisePlaintextHash(e));var g=a==="ebrestore"?"EBRestore":"WAIncomingMsg";if(d("WAIsMediaDownloadRemovePersistedJobEnable").isMediaDownloadRemovePersistedJobEnable()){if(c("gkx")("1614")&&a==="ebrestore")return;var h=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:g,msgType:b,protocolMsgId:f,triggerUIView:null});void d("MAWDownloadAndHandleMedia").downloadAndHandleMediaImpl({downloadEntry:g,downloadType:b===d("MAWMsgType").MSG_TYPE.IMAGE&&d("MAWMediaManagerUiIntegrationCheck").getIsMediaManagerUiIntegrationEnabled()?"preview":"fullsizeAndPreview",hash:e,mediaDownloadFlow:h,msgType:b,protocolMsgId:f});b===d("MAWMsgType").MSG_TYPE.IMAGE&&d("MAWMediaManagerUiIntegrationCheck").getIsMediaManagerUiIntegrationEnabled()&&a==="ebrestore"&&void d("MAWDownloadAndHandleMedia").downloadAndHandleMediaImpl({downloadEntry:g,downloadType:"fullsize",hash:e,mediaDownloadFlow:h,msgType:b,protocolMsgId:f})}else d("MAWJobManager").getJobManager().fireAndForget(d("MAWJobDefinitions").jobSerializers.downloadAndHandleMedia(f,e,g,b,b===d("MAWMsgType").MSG_TYPE.IMAGE&&d("MAWMediaManagerUiIntegrationCheck").getIsMediaManagerUiIntegrationEnabled()?"preview":"fullsizeAndPreview",null)),b===d("MAWMsgType").MSG_TYPE.IMAGE&&d("MAWMediaManagerUiIntegrationCheck").getIsMediaManagerUiIntegrationEnabled()&&a==="ebrestore"&&d("MAWJobManager").getJobManager().fireAndForget(d("MAWJobDefinitions").jobSerializers.downloadAndHandleMedia(f,e,g,b,"fullsize",void 0,void 0,{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.LOW}))}}function v(a){if(a.size===0)return;c("promiseDone")(d("MAWCommonScheduler").mawCommonScheduler().runTask({fn:function(){return e()},name:"queryGroup",priority:d("WorkerScheduler").BACKGROUND_PRIORITY}));function e(){return f.apply(this,arguments)}function f(){f=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var c=(yield (q||(q=b("Promise"))).all(Array.from(a).map(function(a){return d("WAQueryGroup").queryGroup(a,"interactive")["catch"](function(a){return d("WAResultOrError").makeError()})})));c=c.map(function(a){if(a.success===!0){a={extras:null,folder:null,groupStatus:"added",groupToCreate:a.value,key:null,serverTs:d("WATimeUtils").unixTime()};return a}return null}).filter(Boolean);yield d("WACreateGroup").createGroups(c)});return f.apply(this,arguments)}}function w(a){if(a.size===0)return;c("promiseDone")(d("MAWCommonScheduler").mawCommonScheduler().runTask({fn:function(){return e()},name:"queryGroupInvite",priority:d("WorkerScheduler").BACKGROUND_PRIORITY}));function e(){return f.apply(this,arguments)}function f(){f=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var c=(yield (q||(q=b("Promise"))).all(Array.from(a.entries()).map(function(a){var b=a[0];a=a[1];var c=a.inviteCode,e=a.inviteExpireTs;a=a.inviterJid;return d("WAQueryGroupInvite").queryGroupInvite(b,c,e,a)["catch"](function(a){return d("WAResultOrError").makeError()})})));c=c.map(function(a){if(a.success===!0){a={extras:null,folder:null,groupStatus:"added",groupToCreate:a.value,key:null,serverTs:d("WATimeUtils").unixTime()};return a}return null}).filter(Boolean);yield d("WACreateGroup").createGroups(c)});return f.apply(this,arguments)}}function x(a){if(c("gkx")("23915"))for(a of a)a.subtype==="ciphertext"&&c("promiseDone")(d("MAWDebugMsg").writeDebugMsg(a.jid,"Message "+a.stanzaId+" has decryption error: "+a.decryptionError+" from user "+a.from,{decryptionError:a.decryptionError,protocolMsgId:{author:d("WAGlobals").getMyDeviceJid()===a.from?"@me":d("WAJids").extractUserJid(a.from),chat:a.jid,externalId:a.stanzaId}}))}function y(a){if(a.message==null)return a;if(a.message.type!=="ephemeral")return a;var b=a.serverTs;a.message.ephemeralLastUpdatedOrSetTimestamp=a.message.ephemeralLastUpdatedOrSetTimestamp===d("WATimeUtils").DEFAULT_UNIXTIME?b:a.message.ephemeralLastUpdatedOrSetTimestamp;return a}g["default"]=a}),98);
__d("MAWDbHistorySyncQRCodeData",[],(function(a,b,c,d,e,f){"use strict";a="qrCodeRowId";f.qrCodeRowId=a}),66);
__d("MAWHandleEncryptedBackupsSecretsApi",["MAWDbHistorySyncQRCodeData","MAWIndexedDb","MAWTransactionMode","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({historySyncQRCodeData:d("MAWTransactionMode").READWRITE},"handleEncryptedBackupsSecret",function(a){return function(b){var e=b.backupId,f=b.epoch,g=b.mailboxRootKey,i=b.obliviousValidationToken,j=b.serverDataId,k=b.tempOcmfClientState;return a.historySyncQRCodeData.get(d("MAWDbHistorySyncQRCodeData").qrCodeRowId).then(function(b){if(!(b!=null&&b.isQRScanned))return a.historySyncQRCodeData.put({isQRScanned:!0,rowId:d("MAWDbHistorySyncQRCodeData").qrCodeRowId}).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"CallFinishAddDevice",value:{backupId:e.toString(),epoch:h(f),mailboxRootKey:g,obliviousValidationToken:i,serverDataId:j.toString(),tempOcmfClientState:k}});return})["catch"](function(b){return a.historySyncQRCodeData.put({isQRScanned:!1,rowId:d("MAWDbHistorySyncQRCodeData").qrCodeRowId}).then(c("emptyFunction"))})})}});function h(a){return a.map(function(a){var b=a.anonId,c=a.id,d=a.rootKey;a=a.status;return{epoch_anon_id:b,epoch_id:c.toString(),epoch_root_key:d,epoch_status:a.toString()}})}g.handleEncryptedBackupsSecret=a}),98);
__d("MAWProtocolQueueAppdata",["MAWHandleEncryptedBackupsSecretsApi","MAWHandleMetaSyncAction","MAWSharedCOPLogger","Promise","WAConvertAppData","WAMsgApplication.pb","WAParseMessageApplication","WAProtocolQueue","WAResultOrError","decodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n;function a(a){var c=a.map(function(a){return o(a.appdata)});return(n||(n=b("Promise"))).all(c.map(function(a){a=p(a);return a})).then(function(b){var c=[];b.map(function(b,d){b.success===!0&&c.push(a[d].stanzaQueueId)});return{followUpParams:void 0,toAck:c}})}function o(a){c("MAWSharedCOPLogger").DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Parse Appdata application protocol"])));a=d("decodeProtobuf").decodeProtobufWithUnknowns(d("WAMsgApplication.pb").MessageApplicationSpec,d("WAProtocolQueue").extractSubProtocolFromAppdataProtocol(a).payload);a=d("WAParseMessageApplication").parseMessageApplication(a);if(a.type==="error"){c("MAWSharedCOPLogger").MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Appdata contains unparseable message application."])));return}return d("WAConvertAppData").parseAppData(a)}function p(a){c("MAWSharedCOPLogger").DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Handle appdata"])));if(a==null)return(n||(n=b("Promise"))).resolve(d("WAResultOrError").makeResult());switch(a.type){case"meta_sync":c("MAWSharedCOPLogger").DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Handle appdata: meta sync"])));return d("MAWHandleMetaSyncAction").handleMetaSyncActions(a).then(function(){return d("WAResultOrError").makeResult()});case"backups_secrets":c("MAWSharedCOPLogger").DEBUG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Handle appdata: backup secret"])));return d("MAWHandleEncryptedBackupsSecretsApi").handleEncryptedBackupsSecret(a.encryptedBackupsSecrets).then(function(){return d("WAResultOrError").makeResult()});case"sync_key_share":return(n||(n=b("Promise"))).resolve(d("WAResultOrError").makeResult());case"sync_key_request":return(n||(n=b("Promise"))).resolve(d("WAResultOrError").makeResult());default:a.type;c("MAWSharedCOPLogger").WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Unknown appdata type: ",""])),a.type);return(n||(n=b("Promise"))).resolve(d("WAResultOrError").makeResult())}}g.handleAppdataStanzas=a}),98);
__d("MAWCOPAppdataHandler",["MAWIsQuotaExceededError","MAWProtocolQueueAppdata","MAWSharedCOPLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a){return j(a)["catch"](function(a){if(d("MAWIsQuotaExceededError").isQuotaExceededError(a))throw a;c("MAWSharedCOPLogger").catching(a).MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Appdata consumer error"])));return[]})}function j(a){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(a.length===0)return[];var b=(yield d("MAWProtocolQueueAppdata").handleAppdataStanzas(a));b.toAck.length!==a.length&&c("MAWSharedCOPLogger").WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Errors occurred while processing appdata batch, see transactor error reports."])));return b.toAck});return k.apply(this,arguments)}g["default"]=a}),98);
__d("MAWDbGetAlertsWithDeviceJidTxn",["err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return a.deviceChangeAlerts.filter(function(a){return a.deviceJid===b&&!a.loggedOut}).toArray().then(function(a){a.length>1&&c("err")("Invalid result, more than one active devices with the same deviceJid: "+b);return a[0]})}g.getAlertsWithDeviceJidTxn=a}),98);
__d("MAWDbGetUnArchivedDeviceChangeAlertsCountTxn",["MAWIndexedDb"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return a.deviceChangeAlerts.filter(function(a){return a.isArchived===!1}).toArray().then(function(a){return d("MAWIndexedDb").afterTransaction({tag:"UnArchivedSelfDeviceChangeAlerts",value:a.length})})}g.getUnArchivedDeviceChangeAlertsCountTxn=a}),98);
__d("MAWDbUpdateDeviceChangeAlertsTxn",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){return a.deviceChangeAlerts.put(b)}f.updateDeviceChangeAlertsTxn=a}),66);
__d("MAWDbUpdateDeviceChangeAlertsLogInStatusTxn",["MAWDbGetAlertsWithDeviceJidTxn","MAWDbUpdateDeviceChangeAlertsTxn"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return d("MAWDbGetAlertsWithDeviceJidTxn").getAlertsWithDeviceJidTxn(a,b).then(function(b){return d("MAWDbUpdateDeviceChangeAlertsTxn").updateDeviceChangeAlertsTxn(a,babelHelpers["extends"]({},b,{loggedOut:!0}))})}g.updateDeviceChangeAlertsLogInStatusTxn=a}),98);
__d("WAUpdateDevicesForUserApi",[],(function(a,b,c,d,e,f){"use strict";function a(a){var b=a.allowSecurityAlertForContact;a=a.isMe;return!a&&b}f.getShouldShowAdminMessages=a}),66);
__d("WAUpdateRotateSenderKeyToTrue",["WASignalDB","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";a=function(a){return d("WASignalDB").getDb().runInTransaction(["personalSenderKeyStatuses"],"readwrite",function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var c=(yield b.stores.personalSenderKeyStatuses.bulkGet(a));c=c.filter(function(a){return a!=null}).map(function(a){return babelHelpers["extends"]({},a,{rotateSenderKey:!0})});yield b.stores.personalSenderKeyStatuses.bulkPut(c);return c});return function(a){return c.apply(this,arguments)}}(),d("WASignalDB").signalOp("updateRotateSenderKeyToTrue"))};g.updateRotateSenderKeyToTrue=a}),98);
__d("MAWProtocolQueueInstructions",["MAWAdminWriteUserDeviceMsgTxn","MAWBridge","MAWDbAddDeviceChangeAlertsTxn","MAWDbDeviceChangeAlerts","MAWDbGetAlertsWithDeviceJidTxn","MAWDbGetUnArchivedDeviceChangeAlertsCountTxn","MAWDbMsgTypeVersionTxns","MAWDbThreadTxns","MAWDbUpdateDeviceChangeAlertsLogInStatusTxn","MAWDexieTable","MAWIndexedDb","MAWODSProxy","MAWTransactionMode","WAAssertUnreachable","WADbContact","WAGlobals","WAJids","WALogger","WAOdsEnums","WAUpdateDevicesForUserApi","WAUpdateRotateSenderKeyToTrue","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,b){b=new Set(b.map(function(a){return a.jid}));return d("MAWDexieTable").dexieAll([d("MAWDbMsgTypeVersionTxns").maybeBulkGetSecuritySetting(a),d("MAWDbThreadTxns").getAllThreadsForUsers(a,Array.from(b))])}function a(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield d("MAWBridge").getBridge().sendAndReceive("event","getLSDBUsersRelationships",{users:Array.from(new Set(a.map(function(a){return a.jid})))}));a=(yield k(a,b));b=a.followUpParams;a=a.toAck;b=b.groupsToUpdateForIdentityRemoved.flat();yield d("WAUpdateRotateSenderKeyToTrue").updateRotateSenderKeyToTrue(b);return{followUpParams:void 0,toAck:a}});return j.apply(this,arguments)}var k=d("MAWIndexedDb").makeMsgrTransactor({appMeta:(e=d("MAWTransactionMode")).READONLY,deviceChangeAlerts:e.READWRITE,ftsBackloggedMessages:e.READWRITE,groupInfo:e.READONLY,messages:e.READWRITE,participants:e.READONLY,threads:e.READWRITE},"handleInstructions",function(a){return function(b,c){return i(a,b).then(function(e){var f=e[0],g=f.allowSecurityAlertForContact,h=f.allowSecurityAlertForSelf,i=e[1];return d("MAWDexieTable").dexieSequentialAll(b.map(function(b){var e=b.jid,f=e===d("WAGlobals").getMyUserJid(),j=d("WAUpdateDevicesForUserApi").getShouldShowAdminMessages({allowSecurityAlertForContact:g,isMe:f})&&c.get(e)===d("WADbContact").TWO_WAY_CONTACT,k={allowSecurityAlertForSelf:h,isMe:f,shouldShowAdminMessages:j,threads:(f=i.get(e))!=null?f:[],user:e};return function(){return l(a,b,k)}})).then(function(){var a=b.filter(function(a){return a.instruction==="identityRemoved"}).map(function(a){a=(a=i.get(a.jid))!=null?a:[];a=a.map(function(a){return d("WAJids").interpretAsGroupJid(a.jid)}).filter(Boolean);return a});return{followUpParams:{groupsToUpdateForIdentityRemoved:a},toAck:b.map(function(a){return a.stanzaQueueId})}})})}});function l(a,b,d){switch(b.instruction){case"identityChanged":return m(a,b,d);case"identityAdded":return n(a,b,d);case"identityRemoved":return o(a,b,d);case"icdcError":return p(a,b,d);default:throw c("WAAssertUnreachable")(b)}}function m(a,b,c){var e=c.allowSecurityAlertForSelf,f=c.isMe,g=c.shouldShowAdminMessages;c=c.threads;var h=f&&b.model!=null&&b.platform!=null&&b.notificationTs!=null;return d("MAWDexieTable").dexieAll([h&&b.model!=null&&b.platform!=null&&b.notificationTs!=null?d("MAWDbAddDeviceChangeAlertsTxn").addDeviceChangeAlertsTxn(a,{action:d("MAWDbDeviceChangeAlerts").KEY_CHANGE,deviceJid:b.device,identity:b.identity,isArchived:!e,model:b.model,platform:b.platform,ts:b.notificationTs}).then(function(){return d("MAWDbGetUnArchivedDeviceChangeAlertsCountTxn").getUnArchivedDeviceChangeAlertsCountTxn(a)}):d("MAWDexieTable").dexieResolve()].concat(g?c.map(function(c){return d("WAJids").interpretAsGroupJid(c.jid)==null&&d("MAWAdminWriteUserDeviceMsgTxn").writeUserDeviceAdminMsg(a,b.jid,c,d("MAWAdminWriteUserDeviceMsgTxn").DeviceChange.update,b.notificationTs)}):[])).then(function(){(h||g)&&d("MAWODSProxy").odsBumpEntityKey({entity:f?d("WAOdsEnums").Entity.SECURITY_ALERT_FOR_SELF:d("WAOdsEnums").Entity.SECURITY_ALERT_FOR_CONTACT,key:d("MAWDbDeviceChangeAlerts").KEY_CHANGE})})}function n(a,b,c){var e=c.allowSecurityAlertForSelf,f=c.isMe,g=c.shouldShowAdminMessages,h=c.threads,i=c.user,j=f&&b.model!=null&&b.platform!=null&&b.notificationTs!=null;return d("MAWDexieTable").dexieAll([j&&b.model!=null&&b.platform!=null&&b.notificationTs!=null?d("MAWDbAddDeviceChangeAlertsTxn").addDeviceChangeAlertsTxn(a,{action:d("MAWDbDeviceChangeAlerts").ADD,deviceJid:b.device,identity:b.identity,isArchived:!e,model:b.model,platform:b.platform,ts:b.notificationTs}).then(function(){return d("MAWDbGetUnArchivedDeviceChangeAlertsCountTxn").getUnArchivedDeviceChangeAlertsCountTxn(a)}):d("MAWDexieTable").dexieResolve()].concat(g?h.map(function(c){return d("WAJids").interpretAsGroupJid(c.jid)==null&&d("MAWAdminWriteUserDeviceMsgTxn").writeUserDeviceAdminMsg(a,i,c,d("MAWAdminWriteUserDeviceMsgTxn").DeviceChange.add,b.notificationTs)}):[])).then(function(){(j||g)&&d("MAWODSProxy").odsBumpEntityKey({entity:f?d("WAOdsEnums").Entity.SECURITY_ALERT_FOR_SELF:d("WAOdsEnums").Entity.SECURITY_ALERT_FOR_CONTACT,key:d("MAWDbDeviceChangeAlerts").ADD})})}function o(a,b,c){var e=c.isMe,f=c.shouldShowAdminMessages,g=c.threads,h=c.user;return d("MAWDexieTable").dexieAll([e?d("MAWDbGetAlertsWithDeviceJidTxn").getAlertsWithDeviceJidTxn(a,b.device).then(function(){return d("MAWDbUpdateDeviceChangeAlertsLogInStatusTxn").updateDeviceChangeAlertsLogInStatusTxn(a,b.device)}).then(function(){return d("MAWDbGetUnArchivedDeviceChangeAlertsCountTxn").getUnArchivedDeviceChangeAlertsCountTxn(a)}):d("MAWDexieTable").dexieResolve()].concat(f?g.map(function(c){return d("WAJids").interpretAsGroupJid(c.jid)==null&&d("MAWAdminWriteUserDeviceMsgTxn").writeUserDeviceAdminMsg(a,h,c,d("MAWAdminWriteUserDeviceMsgTxn").DeviceChange.remove,b.notificationTs)}):[])).then(function(){(e||f)&&d("MAWODSProxy").odsBumpEntityKey({entity:e?d("WAOdsEnums").Entity.SECURITY_ALERT_FOR_SELF:d("WAOdsEnums").Entity.SECURITY_ALERT_FOR_CONTACT,key:d("MAWDbDeviceChangeAlerts").REMOVE})})}function p(a,b,c){c=c.threads;if(!d("WAGlobals").getConfig().isICDCErrorEnabled())return d("MAWDexieTable").dexieResolve();c=c.find(function(a){return a.jid===b.jid});if(c==null){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["ICDC error instruction for thread "," not found"])),b.jid);return d("MAWDexieTable").dexieResolve()}return d("MAWAdminWriteUserDeviceMsgTxn").writeICDCAlert(a,b.jid,c,b.notificationTs)}g.handleInstructions=a}),98);
__d("MAWCOPInstructionsHandler",["MAWIsQuotaExceededError","MAWProtocolQueueInstructions","MAWSharedCOPLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a){return j(a)["catch"](function(a){if(d("MAWIsQuotaExceededError").isQuotaExceededError(a))throw a;c("MAWSharedCOPLogger").catching(a).MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Instruction consumer error"])));return[]})}function j(a){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(a.length===0)return[];var b=(yield d("MAWProtocolQueueInstructions").handleInstructions(a));b.toAck.length!==a.length&&c("MAWSharedCOPLogger").WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Errors occurred while processing instructions batch, see transactor error reports."])));return b.toAck});return k.apply(this,arguments)}g["default"]=a}),98);
__d("MAWChangeGroupMemberAddModeApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";a=function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return d("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0},function(a){return h.apply(void 0,[a].concat(b))},"changeGroupMemberAddMode")};var h=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f,g){var h=a.GroupInfoStore;a=a.MessagesStore;var i=(yield h.get(b));if(!i.success)return d("WAResultOrError").makeError("missing_group");yield h.update(b,function(a){return babelHelpers["extends"]({},a,{memberAddMode:e})});if(g==="create_admin_message"){i=d("MAWAdminMsgHelpers").createMemberAddModeChangeAdminMsg(b,e,c,f);i!=null&&(yield a.create(i))}return d("WAResultOrError").makeResult()});return function(b,c,d,e,f,g){return a.apply(this,arguments)}}();g.changeGroupMemberAddMode=a;g.changeGroupMemberAddModeTransactor=h}),98);
__d("MAWAdminAddParticipantMsg",["MAWLocalizationType","MAWUserJidWrapper","WAJids"],(function(a,b,c,d,e,f,g){"use strict";var h=1;function i(a,b,c){switch(a){case 1:return{adminMsgContent:[b],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU};case 2:return{adminMsgContent:[b,c],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_ONE_USER};default:return{adminMsgContent:[b,(a-1).toString()],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_YOU_AND_MORE_THAN_ONE_USERS}}}function j(a,b,c){switch(a){case 1:return{adminMsgContent:[b],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_ONE_PARTICIPANT};case 2:return{adminMsgContent:[b,c],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_TWO_PARTICIPANTS};default:return{adminMsgContent:[b,(a-1).toString()],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_MORE_THAN_TWO_PARTICIPANTS}}}function k(a,b,c,e){switch(a){case 1:return{adminMsgContent:[b,c],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_ONE_USER};case 2:return{adminMsgContent:[b,c,e],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_TWO_USER}}return{adminMsgContent:[b,c,(a-1).toString()],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_MORE_THAN_TWO_USER}}function l(a,b){switch(a){case 1:return{adminMsgContent:[],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU};case 2:return{adminMsgContent:[b],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU_AND_ONE_USER}}return{adminMsgContent:[(a-1).toString()],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_YOU_AND_MORE_THAN_ONE_USER}}function m(a,b,c){switch(a){case 1:return{adminMsgContent:[b],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_ONE_USER};case 2:return{adminMsgContent:[b,c],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_TWO_USER}}return{adminMsgContent:[b,(a-1).toString()],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.UNKNOWN_USER_ADDED_MORE_THAN_TWO_USER}}function n(a,b){var c=d("MAWUserJidWrapper").getMyUserJid(),e=b[0],f=b[1],g=d("WAJids").userIdFromJid(e);f=f!=null?d("WAJids").userIdFromJid(f):"";if(a==null)return b.includes(c)?l(b.length,e===c?f:g):m(b.length,g,f);if(a===c)return j(b.length,g,f);a=d("WAJids").userIdFromJid(a);return b.includes(c)?i(b.length,a,e===c?f:g):k(b.length,a,g,f)}function a(a,b){return babelHelpers["extends"]({},n(a,b),{version:h})}g.createAddParticipantsAdminMessage=a}),98);
__d("MAWAdminRemoveParticipantMsg",["MAWAdminMsgType","MAWUserJidWrapper","WAJids"],(function(a,b,c,d,e,f,g){"use strict";var h=1;function i(a,b,c){switch(a){case 1:return{adminMsgContent:[b],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.PARTICIPANT_REMOVED_YOU};case 2:return{adminMsgContent:[b,c],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.PARTICIPANT_REMOVED_YOU_AND_ONE_USER};default:return{adminMsgContent:[b,(a-1).toString()],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.PARTICIPANT_REMOVED_YOU_AND_MORE_THAN_ONE_USERS}}}function j(a,b,c,e){switch(a){case 1:return e?{adminMsgContent:[],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.CURRENT_USER_LEFT_GROUP}:{adminMsgContent:[b],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.CURRENT_USER_REMOVED_ONE_PARTICIPANT};case 2:return{adminMsgContent:[b,c],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.CURRENT_USER_REMOVED_TWO_PARTICIPANTS};default:return{adminMsgContent:[b,(a-1).toString()],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.CURRENT_USER_REMOVED_MORE_THAN_TWO_PARTICIPANTS}}}function k(a,b,c,e,f){switch(a){case 1:return f?{adminMsgContent:[b],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.PARTICIPANT_LEFT_GROUP}:{adminMsgContent:[b,c],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.PARTICIPANT_REMOVED_ONE_USER};case 2:return{adminMsgContent:[b,c,e],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.PARTICIPANT_REMOVED_TWO_USER}}return{adminMsgContent:[b,c,(a-1).toString()],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.PARTICIPANT_REMOVED_MORE_THAN_TWO_USER}}function l(a,b){var c=d("MAWUserJidWrapper").getMyUserJid(),e=b[0],f=b[1],g=d("WAJids").userIdFromJid(e);f=f!=null?d("WAJids").userIdFromJid(f):"";if(a==null)return b.includes(c)?{adminMsgContent:[],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.UNKNOWN_USER_REMOVED_YOU}:{adminMsgContent:[g],adminType:d("MAWAdminMsgType").ADMIN_MSG_TYPE.UNKNOWN_USER_REMOVED_ONE_USER};if(a===c)return j(b.length,g,f,e===c);var h=d("WAJids").userIdFromJid(a);return b.includes(c)?i(b.length,h,e===c?f:g):k(b.length,h,g,f,e===a)}function a(a,b){return babelHelpers["extends"]({},l(a,b),{version:h})}g.createRemoveParticipantsAdminMessage=a}),98);
__d("MAWAdminWriteChangeParticipantsAdminMsgTxn",["FBLogger","MAWAdminAddParticipantMsg","MAWAdminRemoveParticipantMsg","MAWDbThreadTxns","MAWLocalizationUtils","MAWUserJidWrapper","MAWWriteMsgTxns","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return h(a,b,d("MAWAdminAddParticipantMsg").createAddParticipantsAdminMessage)}function b(a,b){return h(a,b,d("MAWAdminRemoveParticipantMsg").createRemoveParticipantsAdminMessage)}function h(a,b,e){var f=b.admin,g=b.chatJid,h=b.participants,i=b.serverTs;if(h.length===0)throw c("FBLogger")("messenger_web").mustfixThrow("invalid number of participants when writing participants change admin msg");return d("MAWDbThreadTxns").getThread(a,g).then(function(g){if(!g.success)throw c("FBLogger")("messenger_web").mustfixThrow("no thread when writing participants change admin msg");g=g.value;var j=d("MAWUserJidWrapper").getMyUserJid();j=f==="@me"?j:f;if(j==null)return;j=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg(e(j,h),g.jid,b.externalId,i);return d("MAWWriteMsgTxns").writeMsg(a,j,g).then(c("emptyFunction"))})}g.writeAddParticipantAdminMsg=a;g.writeRemoveParticipantAdminMsg=b}),98);
__d("MAWAdminWriteGroupNameChangeTxn",["MAWAdminMsgType","MAWDexieTable","MAWExternalId","MAWLocalizationUtils","MAWUserJidWrapper","MAWWriteMsgTxns","WAJids","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e){var f=b.name;if(f==null)return d("MAWDexieTable").dexieResolve();var g=d("MAWUserJidWrapper").getMyUserJid(),h=[];b.nameOwner===g?(g=d("MAWAdminMsgType").ADMIN_MSG_TYPE.CURRENT_USER_NAMED_GROUP,h.push(f)):b.nameOwner==null?(g=d("MAWAdminMsgType").ADMIN_MSG_TYPE.UNKNOWN_USER_NAMED_GROUP,h.push(f)):(g=d("MAWAdminMsgType").ADMIN_MSG_TYPE.PARTICIPANT_NAMED_GROUP,h.push(d("WAJids").userIdFromJid(b.nameOwner),f));b=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:h,adminType:g,version:1},e.jid,d("MAWExternalId").generateExternalId(),d("WATimeUtils").castMillisTimeToUnixTime(d("WATimeUtils").millisTime()));return d("MAWWriteMsgTxns").writeMsg(a,b,e).then(c("emptyFunction"))}g.writeGroupNameChangeInfo=a}),98);
__d("MAWParticipantManagementTxns",["MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieTable","MAWUserJidWrapper"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c){return d("MAWDbParticipantTxns").getParticipantsInThread(a,b).then(function(e){if(c.length===0&&e.length===0)return{addedJids:[],participants:e,removedJids:[],typeUpdateJids:[]};var f=new Map();e.forEach(function(a){f.set(a.userJid,a)});var g=new Set(c.map(function(a){return a.userJid})),h=[],i=[],j=[],k=[];f.forEach(function(a,b){g.has(b)||(a.type!=="invitedParticipant"?h.push(b):(k.push({type:a.type,userJid:a.userJid}),j.push(babelHelpers["extends"]({},a))))});c.forEach(function(a){var b=f.get(a.userJid);b==null?(i.push(a),a.type==="admin"&&k.push({type:a.type,userJid:a.userJid})):(b.type!==a.type&&k.push({type:a.type,userJid:a.userJid}),j.push(babelHelpers["extends"]({},b,a)))});var l=h.indexOf(d("MAWUserJidWrapper").getMyUserJid())>=0;e=function(){return[d("MAWDbParticipantTxns").bulkAddParticipants(a,b,i),d("MAWDbParticipantTxns").bulkUpdateParticipants(a,j),d("MAWDbParticipantTxns").bulkDeleteParticipantsInThread(a,b,h),l?d("MAWDbThreadTxns").archiveThreads(a,[b],!0):d("MAWDexieTable").dexieResolve()]};return d("MAWDexieTable").dexieAll(e()).then(function(a){var b=a[0];a=a[1];return{addedJids:i.map(function(a){return a.userJid}),participants:[].concat(b,a),removedJids:h,typeUpdateJids:k}})})}g.syncParticipantList=a}),98);
__d("MAWGroupManagementTxns",["MAWAdminWriteChangeParticipantsAdminMsgTxn","MAWAdminWriteGroupNameChangeTxn","MAWDbGroupInfoTxns","MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieTable","MAWExternalId","MAWFolderTypes","MAWGetOrCreateThreadTxns","MAWParticipantManagementTxns","MAWThreadManagementTxns","MAWUserJidWrapper","WATimeUtils","isGroupInvitesEnabled"],(function(a,b,c,d,e,f,g){"use strict";var h=["description","participants"];function a(a,b,c){return d("MAWDexieTable").dexieAll([d("MAWThreadManagementTxns").deleteAllThreadData(a,c),d("MAWDbGroupInfoTxns").deleteGroupInfo(a,b)]).then(function(a){a=a[0];return a}).then(function(a){return a})}b=function(a,b){var e=b.authoritativeThreadKey,f=b.deduplicationKey,g=b.extras,i=b.folder,j=b.groupStatus,k=b.groupToCreate,l=b.serverTs;b=j==="added"?d("WATimeUtils").unixTime():k.creationTs;return d("MAWGetOrCreateThreadTxns").getOrCreateThread(a,{authoritativeThreadKey:e,clientThreadKey:g==null?void 0:g.clientThreadKey,createTs:d("WATimeUtils").castUnixTimeToMillisTime(b),deduplicationKey:f,description:"createGroup",folder:i==null?d("MAWFolderTypes").FOLDER_ID.INBOX:i,jid:k.jid}).then(function(b){var e=b.created,f=b.thread;b=k.participants.map(function(a){return a.error?c("isGroupInvitesEnabled")()&&a.error.errorCode===403?{addressable:!0,type:"invitedParticipant",userJid:a.error.user}:null:{addressable:a.value.addressable,type:a.value.type,userJid:a.value.user}}).filter(Boolean);var g=e?d("MAWDbParticipantTxns").bulkAddParticipants:d("MAWParticipantManagementTxns").syncParticipantList;g=g(a,f.jid,b);b=d("MAWUserJidWrapper").getMyUserJid();b=j==="added"&&!e&&k.creator!==b?d("MAWAdminWriteChangeParticipantsAdminMsgTxn").writeAddParticipantAdminMsg(a,{admin:k.inviter,chatJid:f.jid,externalId:d("MAWExternalId").generateExternalId(),participants:[b],serverTs:l}):d("MAWDexieTable").dexieResolve();k.description;k.participants;var i=babelHelpers.objectWithoutPropertiesLoose(k,h);return d("MAWDexieTable").dexieAll([g,d("MAWDbGroupInfoTxns").putGroupInfo(a,i),b]).then(function(b){b[0];b=b[1];return e&&j==="added"?d("MAWAdminWriteGroupNameChangeTxn").writeGroupNameChangeInfo(a,b,f):d("MAWDexieTable").dexieResolve()}).then(function(){return f.archived===!0?d("MAWDbThreadTxns").unarchiveThreads(a,[f.jid]):d("MAWDbThreadTxns").subscribeToThreads(a,[f.jid])}).then(function(a){return f.jid})})};g.deleteGroup=a;g.createGroupInternal=b}),98);
__d("MAWThreadTypes",["MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";b={chunk:(a=d("MAWTransactionMode")).READWRITE,deletedMessages:a.READWRITE,editMsgHistory:a.READWRITE,groupInfo:a.READWRITE,groupInvites:a.READWRITE,media:a.READWRITE,messages:a.READWRITE,participants:a.READWRITE,pendingStanzas:a.READWRITE,reactions:a.READWRITE,threads:a.READWRITE,unrenderedMessages:a.READWRITE,xma:a.READWRITE};g.ThreadRelatedTablesPermissions=b}),98);
__d("MAWDeleteGroupsApi",["MAWDbThreadTxns","MAWDexieTable","MAWGroupManagementTxns","MAWIndexedDb","MAWThreadTypes","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor(d("MAWThreadTypes").ThreadRelatedTablesPermissions,"deleteGroups",function(a){return function(b){return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b.group;return d("MAWDbThreadTxns").getThread(a,c).then(function(b){return!b.success?d("WAResultOrError").makeError("missing_thread"):d("MAWGroupManagementTxns").deleteGroup(a,c,b.value).then(function(a){return d("WAResultOrError").makeResult({deletedGroupId:c,deletedMsgIds:a.deletedMessages})})})})).then(function(a){return a})}});g.deleteGroupsFromMAW=a}),98);
__d("WADeleteGroupFollowUpLowLevelApi",["Promise","WASignalDB","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(a){return d("WASignalDB").getDb().runInTransaction(["senderKeySessions","personalSenderKeyStatuses"],"readwrite",function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(c){yield (h||(h=b("Promise"))).all([c.stores.senderKeySessions.readIndex("groupJid",[a]).then(function(a){return c.stores.senderKeySessions.bulkDelete(a.map(function(a){return a.id}))}),c.stores.personalSenderKeyStatuses["delete"](a)])});return function(a){return c.apply(this,arguments)}}(),d("WASignalDB").signalOp("deleteGroupFollowUpLowLevel"))};g.deleteGroupFollowUpLowLevel=a}),98);
__d("MAWDeleteGroup",["MAWDeleteGroupsApi","Promise","WADeleteGroupFollowUpLowLevelApi","WALogger","asyncToGeneratorRuntime","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a,b){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e){e=(yield d("MAWDeleteGroupsApi").deleteGroupsFromMAW(e.map(function(b){return{deleter:a,group:b}})));return(i||(i=b("Promise"))).all(e.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(!a.success)d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["deleteGroups failed to delete group to a non-existent thread"])));else{a=a.value;var b=a.deletedGroupId;a=a.deletedMsgIds;yield d("WADeleteGroupFollowUpLowLevelApi").deleteGroupFollowUpLowLevel(b,a)}});return function(b){return a.apply(this,arguments)}}())).then(c("emptyFunction"))});return j.apply(this,arguments)}g["default"]=a}),98);
__d("MAWUpdateGroupSubjectApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAJids","WAResultOrError","WATimeUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";a=function(){for(var a=arguments.length,b=new Array(a),c=0;c<a;c++)b[c]=arguments[c];return d("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0,ParticipantsStore:!0},function(a){return h.apply(void 0,[a].concat(b))},"updateGroupSubject")};var h=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){var e=a.GroupInfoStore;a=a.MessagesStore;var f=(yield e.get(b));if(!f.success)return d("WAResultOrError").makeError("missing_group");f=f.value;if(f.subject.ts!=null&&(c.ts==null||f.subject.ts>c.ts))return d("WAResultOrError").makeResult();yield e.update(b,function(a){return babelHelpers["extends"]({},a,{subject:c})});e=(yield e.get(f.jid));if(!e.success)return d("WAResultOrError").makeError("missing_group");f=e.value;e=f.subject.user;f=d("MAWAdminMsgHelpers").createGroupNameChangeAdminMsg(b,f,e!=null?d("WAJids").userIdFromJid(e):void 0,(b=c.ts)!=null?b:d("WATimeUtils").unixTime());f!=null&&(yield a.create(f));return d("WAResultOrError").makeResult()});return function(b,c,d){return a.apply(this,arguments)}}();g.updateGroupSubject=a;g.updateGroupSubjectTransactor=h}),98);
__d("MAWHandleGroupNotifications",["FBLogger","MAWAddGroupParticipantsApi","MAWChangeGroupMemberAddModeApi","MAWChangeGroupParticipantAdminStatusApi","MAWDeleteGroup","MAWRemoveGroupInvitesApi","MAWRemoveGroupParticipantsApi","MAWUpdateGroupSubjectApi","Promise","WAAPI","WACreateGroup","WAGlobals","WAResultOrError","asyncToGeneratorRuntime","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){a=a.notification;switch(a.type){case"join":return i(a).then(function(){return d("WAResultOrError").makeResult()});case"add":return k(a);case"remove":return l(a);case"promote":return n(a);case"demote":return m(a);case"delete":var e=a.groupJid,f=a.participant;if(f==null)throw c("FBLogger")("messenger_web").mustfixThrow("Group delete notification without deleter JID: "+e);return c("MAWDeleteGroup")(f,[e]).then(function(){return d("WAResultOrError").makeResult()});case"subject":return o(a).then(function(){return d("WAResultOrError").makeResult()});case"memberAddMode":return p(a);default:a.type;return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult())}}function i(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(a.isE2EEMigration)return;var b=a.group,e=a.isNew,f=a.key,g=a.serverTs;yield d("WACreateGroup").createGroups([{extras:f!=null?{deduplicationKey:f,platform:"msgr"}:null,folder:null,groupStatus:e?"new":"added",groupToCreate:b,key:f,serverTs:g}]);e=a.group.participants.map(function(a){if(a.success)return a.value.user;else return a.error.user});var h=d("WAGlobals").getMyUserJid();e.find(function(a){return a===h})&&(yield d("MAWRemoveGroupInvitesApi").removeGroupInvites(b.jid,h));yield c("WAAPI").getDevices({ignoreDhash:!1,reason:"added-to-group",users:new Set(e)})});return j.apply(this,arguments)}function k(a){var b=a.groupJid,e=a.participant,f=a.participants,g=a.previousVersionId,h=a.reason,i=a.serverTs;a=a.versionId;if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("Group add participant notification without adder JID: "+b);return d("MAWAddGroupParticipantsApi").addGroupParticipants({current:a,previous:g},b,e,f,!1,h,i)}function l(a){var b=a.groupJid,e=a.participant,f=a.participants,g=a.previousVersionId,h=a.serverTs;a=a.versionId;if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("Group remove participant notification without remover JID: "+b);var i=null;a!=null&&(i={current:a,previous:g});return d("MAWRemoveGroupParticipantsApi").removeGroupParticipants(i,b,e,f,!1,h)}function m(a){var b=a.groupJid,c=a.participant,e=a.participants,f=a.previousVersionId,g=a.serverTs;a=a.versionId;return d("MAWChangeGroupParticipantAdminStatusApi").changeGroupParticipantAdminStatus({current:a,previous:f},b,c,e,"participant",g)}function n(a){var b=a.groupJid,c=a.participant,e=a.participants,f=a.previousVersionId,g=a.serverTs;a=a.versionId;return d("MAWChangeGroupParticipantAdminStatusApi").changeGroupParticipantAdminStatus({current:a,previous:f},b,c,e,"admin",g)}function o(a){var b=a.groupJid,e=a.participant,f=a.subject;a=a.ts;return d("MAWUpdateGroupSubjectApi").updateGroupSubject(b,{content:f,ts:a,user:e}).then(c("emptyFunction"))}function p(a){var b=a.groupJid,c=a.memberAddMode,e=a.participant;a=a.serverTs;return d("MAWChangeGroupMemberAddModeApi").changeGroupMemberAddMode(b,e,c,a,"create_admin_message")}g.persistGroupNotification=a}),98);
__d("WAParticipant",[],(function(a,b,c,d,e,f){"use strict";function a(a){switch(a){case"admin":case"superadmin":return!0;default:return!1}}f.isGroupAdminParticipantType=a}),66);
__d("WASyncParticipantsApi",["WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){a=a.ParticipantsStore;var e=(yield a.bulkGetInGroup(b));if(e.success!==!0)return d("WAResultOrError").makeError("missing_participants");if(c.length===0&&e.value.length===0)return d("WAResultOrError").makeResult({removedJids:[],addedJids:[],typeUpdateJids:[]});var f=new Map();e.value.forEach(function(a){f.set(a.user,a)});var g=new Set(c.map(function(a){return a.user})),h=[],i=[],j=[],k=[];f.forEach(function(a,c){g.has(c)||(a.type!=="invitedParticipant"?h.push({userJid:c,groupJid:b}):(k.push({previousType:a.type,newType:a.type,userJid:a.user}),j.push(babelHelpers["extends"]({},a))))});c.forEach(function(a){var b=f.get(a.user);b==null?(i.push(a),a.type==="admin"&&k.push({previousType:"nonparticipant",newType:a.type,userJid:a.user})):(b.type!==a.type&&k.push({previousType:b.type,newType:a.type,userJid:a.user}),j.push(babelHelpers["extends"]({},b,a)))});yield a.bulkPut(i);yield a.bulkPut(j);yield a.bulkDelete(h);return d("WAResultOrError").makeResult({removedJids:h.map(function(a){a=a.userJid;return a}),addedJids:i.map(function(a){return a.user}),typeUpdateJids:k})});return function(b,c,d){return a.apply(this,arguments)}}();g.syncParticipantsTransactor=a}),98);
__d("MAWResetGroupParticipantInfoApi",["MAWAdminMsgHelpers","MAWRunInTransaction","Promise","WAAPI","WALogger","WAParticipant","WAResultOrError","WASyncParticipantsApi","WATimeUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;a=function(){for(var a=arguments.length,e=new Array(a),f=0;f<a;f++)e[f]=arguments[f];return d("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0,ParticipantsStore:!0},function(a){return j.apply(void 0,[a].concat(e))},"resetGroupParticipantInfo").then(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a.success&&(yield c("WAAPI").setRotateSenderKeyToTrue([e[0]]));return a});return function(b){return a.apply(this,arguments)}}())};var j=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e,f){var g=a.GroupInfoStore,j=a.MessagesStore;a=a.ParticipantsStore;e=e.map(function(a){return{addressable:a.addressable,chatJid:c,type:a.type,user:a.user}});a=(yield d("WASyncParticipantsApi").syncParticipantsTransactor({ParticipantsStore:a},c,e));if(f!=null){e=(yield g.update(c,function(a){return babelHelpers["extends"]({},a,{participantVersion:f})}));if(!e.success)return e}if(a.success!==!0){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Unexpectedly received an error when sync-ing participants"])));return a}g=a.value;e=[];if(g.removedJids.length>0){a=d("MAWAdminMsgHelpers").createParticipantRemoveAdminMsg(c,g.removedJids,null,d("WATimeUtils").unixTime());e.push(j.create(a))}if(g.addedJids.length>0){a=d("MAWAdminMsgHelpers").createParticipantAddAdminMessage(c,g.addedJids,null,d("WATimeUtils").unixTime());e.push(j.create(a))}if(g.typeUpdateJids.length>0)for(a=0;a<g.typeUpdateJids.length;a++){var k=g.typeUpdateJids[a].previousType,l=g.typeUpdateJids[a].newType;k=d("WAParticipant").isGroupAdminParticipantType(k);l=d("WAParticipant").isGroupAdminParticipantType(l);var m=!k&&l;k=k&&!l;if(m){l=d("MAWAdminMsgHelpers").createParticipantPromoteAdminMsg(c,g.typeUpdateJids[a].userJid,null,d("WATimeUtils").unixTime());e.push(j.create(l))}else if(k){m=d("MAWAdminMsgHelpers").createParticipantDemoteAdminMsg(c,g.typeUpdateJids[a].userJid,null,d("WATimeUtils").unixTime());e.push(j.create(m))}}return(i||(i=b("Promise"))).all(e).then(function(){return d("WAResultOrError").makeResult()})});return function(b,c,d,e){return a.apply(this,arguments)}}();g.resetGroupParticipantInfo=a;g.resetGroupParticipantInfoTransactor=j}),98);
__d("MAWProtocolQueueGroupNotification",["FBLogger","MAWHandleGroupNotifications","MAWResetGroupParticipantInfoApi","Promise","WAAPI","WACreateGroup","WALogger","WAQueryGroup","WAResultOrError","WATimeUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p;function a(a){var b=a.notification;return d("MAWHandleGroupNotifications").persistGroupNotification(a).then(function(a){return a.success?a:d("WAResultOrError").makeResult({errorResult:a,groupNotification:b})})}function e(a){return q.apply(this,arguments)}function q(){q=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=[];yield (p||(p=b("Promise"))).all(a.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){try{var b=(yield d("WAQueryGroup").queryGroup(a,"participant_change_recovery"));if(b.success===!1){var f;d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[ParticipantRecovery] Cannot get a group, as per ",""])),b.error);throw c("FBLogger")("messenger_web").mustfixThrow("[ParticipantRecovery] Cannot get a group, as per "+JSON.stringify((f=b.error)!=null?f:null))}f=b.value;b=f.participants.map(function(a){if(a.error){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Unexpectedly received a participant with an error"])));return null}return a.value}).filter(Boolean);b=(yield d("MAWResetGroupParticipantInfoApi").resetGroupParticipantInfo(a,b,f.participantVersion));f=b.error;!b.success&&f==="missing_group"&&e.push(a)}catch(a){d("WALogger").DEV(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Failed to get group info"]))).devConsole(a)}});return function(b){return a.apply(this,arguments)}}()));try{c("WAAPI").queryGroups({groups:e,type:"array"})["catch"](function(a){d("WALogger").DEV(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Failed to query groups"]))).devConsole(a)})}catch(a){d("WALogger").DEV(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Failed to query groups"]))).devConsole(a)}});return q.apply(this,arguments)}function f(a){return r.apply(this,arguments)}function r(){r=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=[];yield (p||(p=b("Promise"))).all(a.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){try{a=(yield d("WAQueryGroup").queryGroup(a,"interactive"));if(a.success===!1){var b;d("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[doGroupRecovery] Cannot get a group, as per ",""])),a.error);throw c("FBLogger")("messenger_web").mustfixThrow("[doGroupRecovery] Cannot get a group, as per "+JSON.stringify((b=a.error)!=null?b:null))}e.push(a.value)}catch(a){d("WALogger").DEV(n||(n=babelHelpers.taggedTemplateLiteralLoose(["Failed to recover missing group info"]))).devConsole(a)}});return function(b){return a.apply(this,arguments)}}()));try{yield d("WACreateGroup").createGroups(e.map(function(a){return{extras:null,folder:null,groupStatus:"queried",groupToCreate:a,key:null,serverTs:d("WATimeUtils").unixTime()}}))}catch(a){d("WALogger").DEV(o||(o=babelHelpers.taggedTemplateLiteralLoose(["Failed to create group infos"]))).devConsole(a)}});return r.apply(this,arguments)}g.handleProtocolQueueGroupNotification=a;g.doParticipantRecovery=e;g.doGroupRecovery=f}),98);
__d("MAWAdminWriteUsersConnectedMsgTxn",["MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieTable","MAWExternalId","MAWIndexedDb","MAWLocalizationType","MAWLocalizationUtils","MAWMsgType","MAWUserJidWrapper","MAWWriteMsgTxns","MessengerMSplitFlag","WAJids","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function a(a,b,e,f){var g=d("MAWUserJidWrapper").getMyUserJid();if(b===g){d("WALogger").WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["writeUsersConnectedAdminMsg is called for self thread"])));return d("MAWDexieTable").dexieResolve()}return d("MAWDbThreadTxns").getThread(a,b).then(function(b){if(!b.success){d("WALogger").WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["writeUsersConnectedAdminMsg failed to create or get 1:1 thread"])));return}var h=b.value;b=d("MAWDbMsgTxns").doesThreadHaveMsgsMatchCriteria(a,h.jid,function(a){return a.type===d("MAWMsgType").MSG_TYPE.ADMIN?!1:a.author===g||a.author===d("WAJids").AUTHOR_ME});var k=d("MAWDbMsgTxns").doesThreadHaveMsgsMatchCriteria(a,h.jid,function(a){return a.type===d("MAWMsgType").MSG_TYPE.ADMIN?!1:a.author!==g&&a.author!==d("WAJids").AUTHOR_ME});return d("MAWDexieTable").dexieAll([b,k]).then(function(b){var g=b[0];b=b[1];if(!g||!b){d("WALogger").WARN(j||(j=babelHelpers.taggedTemplateLiteralLoose(["writeUsersConnectedAdminMsg found a thread without messages from both users, which we'll not append to."])));return}g=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:c("MessengerMSplitFlag").is_msplit_account||e?d("MAWLocalizationType").LOCALIZATION_TYPE.TWO_USERS_CONNECTED_ONE_MSPLIT:d("MAWLocalizationType").LOCALIZATION_TYPE.TWO_USERS_CONNECTED,version:1},h.jid,d("MAWExternalId").generateExternalId(),f);return d("MAWWriteMsgTxns").writeDedupedUsersConnectedAdminMessage(a,g,h).then(function(){var a=d("WAJids").interpretAsUserJid(h.jid);if(a==null)return;d("MAWIndexedDb").afterTransaction({tag:"UpdateContactAsConnected",value:{contactUserId:d("WAJids").extractUserId(a),threadJid:h.jid}})})})})}g.writeUsersConnectedAdminMsg=a}),98);
__d("MAWHandleConnectedAdminMsgApi",["MAWAdminWriteUsersConnectedMsgTxn","MAWIndexedDb","MAWTransactionMode","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;b=d("MAWIndexedDb").makeMsgrTransactor({ftsBackloggedMessages:(a=d("MAWTransactionMode")).READWRITE,groupInfo:a.READONLY,messages:a.READWRITE,threads:a.READWRITE},"handleConnectedAdminMsg",function(a){return function(b){var c=b.chatJid,e=b.isOtherContactMsplit;b=b.notificationTs;d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["handleConnectedAdminMsg: chat ",""])),c);return d("MAWAdminWriteUsersConnectedMsgTxn").writeUsersConnectedAdminMsg(a,c,e,b)}});g.handleConnectedAdminMsg=b}),98);
__d("MAWUpdateThreadFolderApi",["MAWBridgeTypesCreators","MAWDbThreadTxns","MAWIndexedDb","MAWTransactionMode","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i;a=d("MAWIndexedDb").makeMsgrTransactor({threads:d("MAWTransactionMode").READWRITE},"updateThreadFolder",function(a){return function(b,c){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Update thread ",""])),b);return d("MAWDbThreadTxns").getThread(a,b).then(function(b){if(!b.success)return;return d("MAWDbThreadTxns").updateThread(a,babelHelpers["extends"]({},b.value,{folder:c})).then(function(a){d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Update thread "," folder with folder id ",""])),b.value.jid,c);d("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedThread({folder:c,threadJid:b.value.jid})});return})})}});g.updateThreadFolder=a}),98);
__d("MAWProtocolQueueNotification",["MAWBridge","MAWFolderTypes","MAWHandleConnectedAdminMsgApi","MAWODSProxy","MAWProtocolQueueGroupNotification","MAWUpdateThreadFolderApi","MWFBLogger","Promise","WAJids","WAOdsEnums","WAResultOrError","asyncToGeneratorRuntime","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m=d("MWFBLogger").MWLogger.tags(["ProtocolQueue"]);function n(a){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.stanzaId;a=a.notification;var f=a.actions,g=a.chatJid,h=a.ts,n=d("WAJids").interpretAsUserJid(g),o=(yield d("MAWBridge").getBridge().sendAndReceive("event","getLSDBUsersIsMsplit",{users:[n].filter(Boolean)}));return(l||(l=b("Promise"))).all(f.map(function(a){switch(a.type){case"folder":var c;c=(c=a.folderId)!=null?c:d("MAWFolderTypes").FOLDER_ID.INBOX;m.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["handleThreadNotification (",") with folder id ",", jid: ",""])),e,c,g);return d("MAWUpdateThreadFolderApi").updateThreadFolder(g,c);case"connected":m.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["handleThreadNotification (",") connected, jid: ",""])),e,g);c=n!=null&&o.get(n)===!0;return d("MAWHandleConnectedAdminMsgApi").handleConnectedAdminMsg({chatJid:g,isOtherContactMsplit:c,notificationTs:h});default:a.type;m.MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["handleThreadNotification (",") unknown thread action, jid: ",""])),e,g);return(l||(l=b("Promise"))).reject("Handle thread notification: unknown thread action")}})).then(c("emptyFunction"))});return o.apply(this,arguments)}function a(a){return(l||(l=b("Promise"))).all(a.map(function(a){a=a.notification;a=p(a);return a})).then(function(b){var c={groupRecoveries:[],participantRecoveries:[]},d=[];b.map(function(b,e){if(b.success===!0){d.push(a[e].stanzaQueueId);if(b.value!=null){e=b.value;e.type==="group"&&c.groupRecoveries.push(e.data.groupNotification.groupJid)}}});return{followUpParams:c,toAck:d}})}function p(a){switch(a.type){case"group":d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.WA_PROTOCOL_QUEUE_NOTIFICATION,key:a.type+"."+a.notification.type});return d("MAWProtocolQueueGroupNotification").handleProtocolQueueGroupNotification(a).then(function(a){return a.value?d("WAResultOrError").makeResult({data:a.value,type:"group"}):d("WAResultOrError").makeResult()});case"thread":a.notification.actions.forEach(function(b){d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.WA_PROTOCOL_QUEUE_NOTIFICATION,key:a.type+"."+b.type})});return n(a).then(function(){return d("WAResultOrError").makeResult()});default:a;m.MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Received unsupported notification type: ",""])),a.type);return(l||(l=b("Promise"))).resolve(d("WAResultOrError").makeResult())}}g.handleIncomingNotificationStanzas=a}),98);
__d("MAWCOPNotificationsHandler",["MAWCommonScheduler","MAWIsQuotaExceededError","MAWProtocolQueueGroupNotification","MAWProtocolQueueNotification","MAWSharedCOPLogger","WorkerScheduler","asyncToGeneratorRuntime","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a){return j(a)["catch"](function(a){if(d("MAWIsQuotaExceededError").isQuotaExceededError(a))throw a;c("MAWSharedCOPLogger").catching(a).MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Notification consumer error"])));return[]})}function j(a){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(a.length===0)return[];var e=(yield d("MAWProtocolQueueNotification").handleIncomingNotificationStanzas(a));e.toAck.length!==a.length&&c("MAWSharedCOPLogger").WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Errors occurred while processing notifications batch, see transactor error reports."])));a=e.followUpParams;var f=a.groupRecoveries,g=a.participantRecoveries;g.length>0&&c("promiseDone")(d("MAWCommonScheduler").mawCommonScheduler().runTask({fn:function(){return d("MAWProtocolQueueGroupNotification").doParticipantRecovery(g)},name:"ParticipantsRecovery",priority:d("WorkerScheduler").BACKGROUND_PRIORITY}));f.length>0&&c("promiseDone")(d("MAWCommonScheduler").mawCommonScheduler().runTask({fn:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield d("MAWProtocolQueueGroupNotification").doGroupRecovery(f)});function c(){return a.apply(this,arguments)}return c}(),name:"GroupsRecovery",priority:d("WorkerScheduler").BACKGROUND_PRIORITY}));return e.toAck});return k.apply(this,arguments)}g["default"]=a}),98);
__d("MAWIncomingReceiptDataFormatTxns",["MAWDbMsgTxns","MAWDbUnrenderedMsgTxns","MAWDexieTable","MAWMsgType","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h=["protocolMsgId"],i;function j(a){var b=a.author,c=a.chat;a=a.externalId;return c+"_"+a+"_"+b}function a(a,b){if(b.length===0)return d("MAWDexieTable").dexieResolve();var c=new Map(),e=new Set();b.forEach(function(a){a=a.msgs;a.forEach(function(a){return e.add(babelHelpers["extends"]({},a))})});a=d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").getMsgsByProtocolMsgId(a,Array.from(e)),d("MAWDbUnrenderedMsgTxns").getUnrenderedMsgsByProtocolMsgId(a,Array.from(e))]).then(function(a){var b=a[0];a=a[1];var c=[];b.forEach(function(a){return c.push({msg:a,renderType:"regular"})});a.forEach(function(a){return c.push({msg:a,renderType:"unrendered"})});return{msgs:c}});return a.then(function(a){a=a.msgs;b.forEach(function(a){var b=a.msgs,d=a.receivers,e=a.type;b.forEach(function(a){var b=j(a),f=c.get(b)||{deliveryReceipts:[],protocolMsgId:a,readReceipts:[],senderReceipts:[]};d.forEach(function(a){if(e==="read"||e==="read-self"){f.readReceipts.push(a);return}else if(e==="delivered"){f.deliveryReceipts.push(a);return}else if(e==="sender"){f.senderReceipts.push(a);return}else if(e==="inactive"){f.deliveryReceipts.push(a);return}e});c.set(b,f)})});var e=new Map(),f=new Map(),g=[];a.forEach(function(a){var b=a.msg,g=b.author,k=b.externalId,l=b.msgId,m=b.threadJid;b=b.type;if(m==null){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Failed to map the threadId of a message to its threadJid during receipt-writing"])));return}if(b!==d("MAWMsgType").MSG_TYPE.CIPHERTEXT){b=j({author:g,chat:m,externalId:k});g=c.get(b);if(g!=null){g.protocolMsgId;m=babelHelpers.objectWithoutPropertiesLoose(g,h);k=babelHelpers["extends"]({msgId:l},m);f.set(l,k);c["delete"](b)}}e.set(l,a)});c.forEach(function(a){var b=a.deliveryReceipts,c=a.protocolMsgId;a=a.readReceipts;if(b.length===0&&a.length===0)return;var d=c.author,e=c.chat;c=c.externalId;g.push({author:d,deliveryReceipts:b,externalId:c,readReceipts:a,thread:e})});return{msgIdToDbMsgMap:e,pendingReceiptsToWrite:g,receiptsToWriteMap:f}})}g.prepareDataForReceiptsToWrite=a}),98);
__d("MAWIncomingReceiptUtils",["WALogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){var b=new Map();a.forEach(function(a){if(a.msgRenderType==="unrendered")return;a.affectedUserJids.forEach(function(c){var e=a.receipt.statusTsPerUser.get(c);if(e==null){d("WALogger").WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["User "," is in affectedUserJids in receipt-writing results, but they have no corresponding read/delivery receipt entry in the DB"])),c);return}c=[a.threadJid,c];var f=b.get(JSON.stringify(c)),g=e.deliveredTs!=null,i=e.readTs!=null;g=g?a.msgTs:0;i=i?a.msgTs:0;e=(e=e.readTs)!=null?e:0;if(f!=null){var j=f.lastDeliveredMsgTs,k=f.lastReadMsgTs;f=f.lastReadActionTs;g=Math.max(g,j);i=Math.max(i,k);e=Math.max(e,f)}b.set(JSON.stringify(c),{lastDeliveredMsgTs:d("WATimeUtils").castToUnixTime(g),lastReadActionTs:d("WATimeUtils").castToUnixTime(e),lastReadMsgTs:d("WATimeUtils").castToUnixTime(i)})})});return new Map(Array.from(b).map(function(a){var b=a[0];a=a[1];return[JSON.parse(b),a]}))}g.getMaxTimestampsPerParticipant=a}),98);
__d("MAWAckAndTimestampUpdatesForReceiptsTxns",["MAWDbMsgTxns","MAWDbParticipantTxns","MAWDbUnrenderedMsgTxns","MAWDexieTable","MAWIncomingReceiptUtils","MAWLoggerUtils","MWFBLogger","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h,i=d("MWFBLogger").MWLogger.tags([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.Countdown,d("MAWLoggerUtils").Tag.Incoming]);function a(a,b,e){b=d("MAWIncomingReceiptUtils").getMaxTimestampsPerParticipant(b);i.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Updating timestamps for "," participants"])),b.size);var f=[];b.forEach(function(a,b){f.push({deliveredWatermarkTs:a.lastDeliveredMsgTs,lastReadActionTs:a.lastReadActionTs,lastReadWatermarkTs:a.lastReadMsgTs,participantKey:b})});b=e.regular.length>0?d("MAWDbMsgTxns").bulkUpdateSystemAck(a,e.regular):d("MAWDexieTable").dexieResolve();e=e.unrendered.length>0?d("MAWDbUnrenderedMsgTxns").bulkUpdateSystemAckForUnrenderedMsgs(a,e.unrendered):d("MAWDexieTable").dexieResolve();b=d("MAWDexieTable").dexieAll([b,e]);return d("MAWDexieTable").dexieAll([b,f.length>0?d("MAWDbParticipantTxns").bulkUpdateParticipantTimestamps(a,f,i):d("MAWDexieTable").dexieResolve()]).then(c("emptyFunction"))}g.handleAckAndTimestampUpdatesForReceipts=a}),98);
__d("MAWDbPendingReceiptTxns",["WAJids","WAMsg"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=b.map(function(a){var b=a.author,c=a.externalId;a=a.thread;return d("WAMsg").craftWAMsgIdString({author:b,chat:a,externalId:c})});return a.pendingReceipts.where("id").anyOf(c).toArray().then(function(c){var e=new Map();c.forEach(function(a){e.set(a.id,a)});var f=b.map(function(a){var b=a.author,c=a.externalId,f=a.thread,g=d("WAMsg").craftWAMsgIdString({author:b,chat:f,externalId:c}),h=e.get(g),i=h!=null?h:{author:b,deliveryReceipts:[],externalId:c,id:g,readReceipts:[],thread:f};b===d("WAJids").AUTHOR_ME?(a.deliveryReceipts.forEach(function(a){i.deliveryReceipts.push(a)}),a.readReceipts.forEach(function(a){i.readReceipts.push(a)})):(i.deliveryReceipts=[],a.readReceipts.forEach(function(a){i.readReceipts.push(a)}));return i});return a.pendingReceipts.bulkPut(f).then(function(){return f})})}function b(a,b){return a.pendingReceipts.bulkGet(b)}g.bulkAddPendingReceipts=a;g.getPendingReceipts=b}),98);
__d("MAWIncomingReceiptDataFormatUtils",["MAWAckLevel","MAWDbMsg"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var c=[],e=[];a.forEach(function(a){var f=null,g=a.receipt.msgId,h=a.receipt.statusTsPerUser,i=b.get(g);if(i==null)return;var j=i.msg;i=i.renderType;a.affectedUserJids.forEach(function(a){var b,c=null;((b=h.get(a))==null?void 0:b.readTs)!=null?c=d("MAWAckLevel").ACK.read:((b=h.get(a))==null?void 0:b.deliveredTs)!=null&&(c=d("MAWAckLevel").ACK.received);f=f==null||c!=null&&c>f?c:f});f!=null&&f>j.ack&&(i==="regular"?c.push({ack:f,msgId:g,reportingMeta:null}):(i,e.push({ack:f,msgId:g})))});return{regular:c,unrendered:e}}function b(a,b,c){return a.map(function(a){var e=b.get(a.receipt.msgId);if(e==null)return null;var f=e.msg,g=c.get(f.msgId);return g==null||g.deliveryReceipts.length===0&&g.readReceipts.length===0?null:babelHelpers["extends"]({},a,{externalId:f.externalId,msgRenderType:e.renderType,msgTs:d("MAWDbMsg").getCanonicalTsFromMsg(f),threadJid:f.threadJid})}).filter(Boolean)}g.createUpdateSystemAckParams=a;g.formatWriteReceiptResultsWithExtras=b}),98);
__d("MAWReceiptTrace",["ArmadilloDataTraceType","MAWBridgeTrace","MAWBridgeTraceEvent","MAWIndexedDb"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){if(a==="delivered"){a=b.reduce(function(a,b){return b.externalId!=null?[].concat(a,[b.externalId]):a},[]);a.length>0&&d("MAWIndexedDb").afterTransaction({tag:"UpdateTrace",value:d("MAWBridgeTrace").createBridgeUpdateTraceData(a,c("MAWBridgeTraceEvent").ReceivedReceipt,d("ArmadilloDataTraceType").armadilloMessageSend)})}}g.flushTrace=a}),98);
__d("MAWIncomingReceiptTxns",["MAWAckAndTimestampUpdatesForReceiptsTxns","MAWDbPendingReceiptTxns","MAWDbReceiptTxns","MAWDexieTable","MAWIncomingReceiptDataFormatUtils","MAWReceiptTrace"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){if(b==null)return d("MAWDexieTable").dexieResolve();var c=b.msgIdToDbMsgMap,e=b.pendingReceiptsToWrite,f=b.receiptsToWriteMap;b=Array.from(f.values());return d("MAWDexieTable").dexieAll([d("MAWDbReceiptTxns").bulkWriteReceiptsForDevices(b),d("MAWDbPendingReceiptTxns").bulkAddPendingReceipts(a,e)]).then(function(b){b=b[0];var e=d("MAWIncomingReceiptDataFormatUtils").createUpdateSystemAckParams(b,c);b=d("MAWIncomingReceiptDataFormatUtils").formatWriteReceiptResultsWithExtras(b,c,f);var g=b.filter(function(a){a=((a=f.get(a.receipt.msgId))==null?void 0:a.deliveryReceipts)||[];return a.length>0});g.length>0&&d("MAWReceiptTrace").flushTrace("delivered",g);return d("MAWAckAndTimestampUpdatesForReceiptsTxns").handleAckAndTimestampUpdatesForReceipts(a,b,e)})}g.bulkHandleIncomingReceipts=a}),98);
__d("MAWWriteAppDataReceiptsApi",["MAWDexieTable","MAWIndexedDb","MAWTransactionMode","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({appData:d("MAWTransactionMode").READWRITE},"writeAppDataReceipts",function(a){return function(b){return h(a,b).then(function(b){return i(a,b)})}});function h(a,b){if(b.length===0)return d("MAWDexieTable").dexieResolve();b=b.reduce(function(a,b){var c=a.appDataExternalIdSet,d=a.appDataReceiversSet;a=b.externalIds;b=b.receivers;a.forEach(function(a){c.add(a)});b.forEach(function(a){d.add(a)});return{appDataExternalIdSet:c,appDataReceiversSet:d}},{appDataExternalIdSet:new Set(),appDataReceiversSet:new Set()});var c=b.appDataExternalIdSet;b=b.appDataReceiversSet;c=Array.from(c);var e=Array.from(b);return a.appData.where("externalId").anyOf(c).toArray().then(function(a){if(a.length===0)return;return j(a,e)})}function i(a,b){if(b==null)return d("MAWDexieTable").dexieResolve();var e=b.toDelete;b=b.toUpdate;return d("MAWDexieTable").dexieAll([e.length>0?a.appData.bulkDelete(e):d("MAWDexieTable").dexieResolve(),b.length>0?a.appData.bulkPut(b):d("MAWDexieTable").dexieResolve()]).then(c("emptyFunction"))}function j(a,b){return a.reduce(function(a,c){if(c==null)return a;for(var d of b)c.permittedIdentitiesPerDevice["delete"](d);if(c.permittedIdentitiesPerDevice.size===0){a.toDelete.push(c.appDataId);return a}else{a.toUpdate.push(c);return a}},{toDelete:[],toUpdate:[]})}g.writeAppDataReceipts=a;g.prepareBulkAppDataReceipts=h;g.writeBulkAppDataReceipts=i}),98);
__d("MAWWritePeerMsgReceiptsApi",["MAWDbMsg","MAWDbMsgTxns","MAWDbPendingReceiptTxns","MAWDexieTable","MAWLoggerUtils","MAWMarkThreadAsReadTxns","MAWMsgType","MWFBLogger","WAGlobals","WAJids","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,b,c){return d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(a){return a==null||a.type===d("MAWMsgType").MSG_TYPE.CIPHERTEXT?{msg:b,readReceipt:c,type:"missing"}:{dbMsg:a,msg:b,readReceipt:c,type:"found"}})}function j(a){a=a.map(function(a){return a.type==="missing"?null:a.dbMsg}).filter(Boolean);return a.reduce(function(a,b){var c=b.threadJid,e=d("WATimeUtils").castToMillisTime(d("MAWDbMsg").getSortOrderWithFallback(b)),f=a.get(c);(f==null||e>f.msgSortOrderMs)&&a.set(c,{msgId:b.msgId,msgSortOrderMs:e});return a},new Map())}function a(a,b){if(b.length===0)return d("MAWDexieTable").dexieResolve([]);b=b.map(function(a){d("MWFBLogger").MWLogger.tags([d("MAWLoggerUtils").Tag.Ephemeral,d("MAWLoggerUtils").Tag.PeerReceipt]).DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Processing "," receipt for messages not from me"])),a.type);if(a.type==="delivered")return;var b={device:void 0,ts:void 0};a.receivers.forEach(function(a){var c=a.device;a=a.ts;var e=d("WAJids").extractUserJid(c);e===d("WAGlobals").getMyUserJid()&&(b.ts==null||a<b.ts)&&(b.device=c,b.ts=a)});if(b.device!=null&&b.ts!=null)return babelHelpers["extends"]({},a,{receivers:{device:b.device,ts:b.ts}});else return}).filter(Boolean);var c=[];b.forEach(function(a){a.msgs.forEach(function(b){c.push([b,a.receivers])})});return d("MAWDexieTable").dexieAll(c.map(function(b){var c=b[0];b=b[1];return i(a,c,b)}))}function b(a,b){if(b.length===0)return d("MAWDexieTable").dexieResolve();var e=[],f=[];b.map(function(a){a.type==="missing"?e.push({author:a.msg.author,deliveryReceipts:[],externalId:a.msg.externalId,readReceipts:[a.readReceipt],thread:a.msg.chat}):f.push({msgId:a.msg,ts:a.readReceipt.ts})});var g=j(b);b=b.reduce(function(a,b){b=b.msg.chat;var c=g.get(b);c!=null&&a.set(b,{msgId:c.msgId,sortOrderMs:c.msgSortOrderMs});return a},new Map());return d("MAWDexieTable").dexieAll([d("MAWDbPendingReceiptTxns").bulkAddPendingReceipts(a,e),d("MAWMarkThreadAsReadTxns").bulkMarkThreadAsReadUpToMsgSortOrderMs(a,b)]).then(c("emptyFunction"))}g.getResultByProtocolMsgId=i;g.prepareReceiptsForMeToWrite=a;g.bulkWritePeerReceiptsForMsgsNotFromMeInternal=b}),98);
__d("MAWBulkWriteReceiptsApi",["MAWDexieTable","MAWIncomingReceiptDataFormatTxns","MAWIncomingReceiptTxns","MAWIndexedDb","MAWTransactionMode","MAWWriteAppDataReceiptsApi","MAWWritePeerMsgReceiptsApi","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b){var c=[],e=[],f=[];b.forEach(function(a){switch(a.type){case"msg-receipt":c.push(a.params);break;case"not-from-me":e.push(a.params);break;default:f.push(a.params);break}});return d("MAWDexieTable").dexieAll([f.length>0?d("MAWWriteAppDataReceiptsApi").prepareBulkAppDataReceipts(a,f):d("MAWDexieTable").dexieResolve(),c.length>0?d("MAWIncomingReceiptDataFormatTxns").prepareDataForReceiptsToWrite(a,c):d("MAWDexieTable").dexieResolve(),e.length>0?d("MAWWritePeerMsgReceiptsApi").prepareReceiptsForMeToWrite(a,e):d("MAWDexieTable").dexieResolve([])]).then(function(a){var b=a[0],c=a[1];a=a[2];if(b==null)return{incomingReceiptData:c,processedPeerReceiptsNotForMeResults:a};var d=b.toDelete;b=b.toUpdate;return{appDataReceipts:{toDelete:d,toUpdate:b},incomingReceiptData:c,processedPeerReceiptsNotForMeResults:a}})}b=d("MAWIndexedDb").makeMsgrTransactor({appData:(a=d("MAWTransactionMode")).READWRITE,chunk:a.READONLY,media:a.READONLY,messages:a.READWRITE,participants:a.READWRITE,pendingReceipts:a.READWRITE,receiverFetchInfo:a.READONLY,threads:a.READWRITE,unrenderedMessages:a.READWRITE,xma:a.READONLY},"bulkWriteReceipts",function(a){return function(b){return b.length===0?d("MAWDexieTable").dexieResolve():h(a,b).then(function(b){var e=b.appDataReceipts,f=b.incomingReceiptData;b=b.processedPeerReceiptsNotForMeResults;return d("MAWDexieTable").dexieAll([e!=null&&(e==null?void 0:e.toDelete.length)>0&&(e==null?void 0:e.toUpdate.length)>0?d("MAWWriteAppDataReceiptsApi").writeBulkAppDataReceipts(a,e):d("MAWDexieTable").dexieResolve(),f!=null?d("MAWIncomingReceiptTxns").bulkHandleIncomingReceipts(a,f):d("MAWDexieTable").dexieResolve(),b.length>0?d("MAWWritePeerMsgReceiptsApi").bulkWritePeerReceiptsForMsgsNotFromMeInternal(a,b):d("MAWDexieTable").dexieResolve()]).then(c("emptyFunction"))})}});g.bulkWriteReceipts=b}),98);
__d("MAWSharedProtocolQueueReceipt",["asyncToGeneratorRuntime"],(function(a,b,c,d,e,f){"use strict";function g(a){if(a.receiptType==="appdata")return{params:{externalIds:a.externalIds,receivers:[a.from]},type:"appdata"};var b,c,d=a.chat;switch(a.receiptType){case"user":c=a.externalIds;b=[{device:a.from.author,ts:a.ts}];break;case"group":c=a.externalIds;b=[{device:a.from.author,ts:a.ts}];break;default:a.receiptType;c=[a.externalId];b=a.receivers;break}var e=a.messageAuthor;a=a.type;if(e==="@me"||a==="sender")return{params:{msgs:c.map(function(a){return{author:"@me",chat:d,externalId:a}}),receivers:b,type:a},type:"msg-receipt"};else return{params:{msgs:c.map(function(a){return{author:e,chat:d,externalId:a}}),receivers:b,type:a},type:"not-from-me"}}function a(a,b){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=a.map(function(a){a=g(a.receipt);return a});yield b(c);return{followUpParams:void 0,toAck:a.map(function(a){return a.stanzaQueueId})}});return h.apply(this,arguments)}f.sharedHandleIncomingReceiptStanza=a}),66);
__d("WADbHandlePermitedIdentitiesApi",["MAWTransactionMode","WADbTransactor"],(function(a,b,c,d,e,f,g){"use strict";a=d("WADbTransactor").makeSignalTransactor({receipts:d("MAWTransactionMode").READWRITE},"handlePermitedIdentitiesPerDevice",function(a){return function(b){var c=Array.from(b.keys());return a.receipts.where("waMsgId").anyOf(c).toArray().then(function(a){return a.map(function(a){var c;c=(c=b.get(a.waMsgId))!=null?c:new Set();for(c of c){var d;(d=a.permittedIdentitiesPerDevice)==null||d["delete"](c)}return a})}).then(function(b){return a.receipts.bulkPut(b).then(function(){})})}});g.handlePermitedIdentitiesPerDevice=a}),98);
__d("WAPreKeysStanzaUtils",["WAWap"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b;return(b=d("WAWap")).wap("key",null,b.wap("id",null,b.BIG_ENDIAN_CONTENT(a.id,3)),b.wap("value",null,a.keyPair.publicKey))}function b(a){var b;return(b=d("WAWap")).wap("skey",null,b.wap("id",null,b.BIG_ENDIAN_CONTENT(a.id,3)),b.wap("value",null,a.keyPair.publicKey),b.wap("signature",null,a.signature))}function c(a){var b=a.child("skey"),c=null;if(a.hasChild("key")){var d=a.child("key");c={id:d.child("id").contentUint(3),publicKey:d.child("value").contentSerializedPubKey()}}return{identity:a.child("identity").contentSerializedPubKey(),signedKey:{id:b.child("id").contentUint(3),publicKey:b.child("value").contentSerializedPubKey(),signature:b.child("signature").contentBytes(64)},oneTimeKey:c}}g.xmppPreKey=a;g.xmppSignedPreKey=b;g.readSessionInfo=c}),98);
__d("WAReceiptUtils",["WACryptoManagerUtils","WADeprecatedSendIq","WAMapWithDefault","WAMsg","WAPreKeysStanzaUtils","WARequestPreKeyDigest","WAWap","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=a.retryCount;c=c+1;c>=3&&(yield d("WARequestPreKeyDigest").requestPreKeyDigestFn(function(a){return a(b)}));var e=null;c>=2&&(e=(yield d("WACryptoManagerUtils").getSignalInfoForRetry(b.cryptoManager)));var f=b.cryptoManager.regInfo.regId;return k(a,c,f,e)});return i.apply(this,arguments)}function a(a,b){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=a.externalId,e=a.from,f=a.participant,g;e.type==="group"?g=e.groupJid:(e.type,g=e.deviceJid);yield d("WADeprecatedSendIq").deprecatedSendStanzaAndWaitForAck(yield h(a,b),{id:c,"class":"receipt",from:g,participant:f})});return j.apply(this,arguments)}function k(a,b,c,e){var f=null;if(e!=null){var g=e.keyType,h=e.signedPreKey,i=e.preKey;e=e.publicKey;var j=a.deviceIdentity!=null?d("WAWap").wap("device-identity",null,a.deviceIdentity):null;f=d("WAWap").wap("keys",null,d("WAWap").wap("type",null,d("WAWap").BIG_ENDIAN_CONTENT(g,1)),d("WAWap").wap("identity",null,e),d("WAPreKeysStanzaUtils").xmppPreKey(i),d("WAPreKeysStanzaUtils").xmppSignedPreKey(h),j)}a.from.type==="group"?g=a.from.groupJid:(a.from.type,g=a.from.deviceJid);return d("WAWap").wap("receipt",{category:a.category!=null?d("WAWap").CUSTOM_STRING(a.category):d("WAWap").DROP_ATTR,id:d("WAWap").CUSTOM_STRING(a.externalId),participant:a.participant?d("WAWap").DEVICE_JID(a.participant):d("WAWap").DROP_ATTR,recipient:a.recipient?d("WAWap").USER_JID(a.recipient):d("WAWap").DROP_ATTR,to:d("WAWap").JID(g),type:"retry"},d("WAWap").wap("retry",{count:d("WAWap").INT(b),id:d("WAWap").CUSTOM_STRING(a.externalId),t:d("WAWap").INT(a.ts),v:"1"}),d("WAWap").wap("registration",null,d("WAWap").BIG_ENDIAN_CONTENT(c)),f)}function c(a){var b=new(d("WAMapWithDefault").MapWithDefault)(function(a){return new Set()});for(a of a){var c=a.receipt;if(c.receiptType==="group"||c.receiptType==="user")for(var e of c.externalIds)b.get(d("WAMsg").craftWAMsgIdString({author:c.messageAuthor,chat:c.chat,externalId:e})).add(c.from.author);else if(c.receiptType==="group-server-agg")for(e of c.receivers)b.get(d("WAMsg").craftWAMsgIdString({author:c.messageAuthor,chat:c.chat,externalId:c.externalId})).add(e.device)}return b.toMap()}g.makeRetryReceipt=h;g.sendRetryReceipt=a;g.calculateIdentitiesToDelete=c}),98);
__d("MAWProtocolQueueReceipt",["MAWBulkWriteReceiptsApi","MAWSharedProtocolQueueReceipt","WADbHandlePermitedIdentitiesApi","WAReceiptUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return d("WADbHandlePermitedIdentitiesApi").handlePermitedIdentitiesPerDevice(d("WAReceiptUtils").calculateIdentitiesToDelete(a)).then(function(){return d("MAWSharedProtocolQueueReceipt").sharedHandleIncomingReceiptStanza(a,d("MAWBulkWriteReceiptsApi").bulkWriteReceipts)})}g.handleIncomingReceiptStanza=a}),98);
__d("MAWCOPReceiptsHandler",["MAWIsQuotaExceededError","MAWProtocolQueueReceipt","MAWSharedCOPLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(a){return j(a)["catch"](function(a){if(d("MAWIsQuotaExceededError").isQuotaExceededError(a))throw a;c("MAWSharedCOPLogger").catching(a).MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Receipt consumer error"])));return[]})}function j(a){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(a.length===0)return[];var b=(yield d("MAWProtocolQueueReceipt").handleIncomingReceiptStanza(a));b.toAck.length!==a.length&&c("MAWSharedCOPLogger").WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Errors occurred while processing receipts batch, see transactor error reports."])));return b.toAck});return k.apply(this,arguments)}g["default"]=a}),98);
__d("MAWBulkGetAppDataForRetryApi",["MAWIndexedDb","MAWTransactionMode","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=30*d("WATimeUtils").DAY_SECONDS;a=d("MAWIndexedDb").makeMsgrTransactor({appData:d("MAWTransactionMode").READONLY},"bulkGetAppDataForRetry",function(a){return function(b){var c=b.map(function(a){a=a.externalId;return a});return a.appData.where("externalId").anyOf(c).toArray().then(function(a){var c=new Map(a.map(function(a){return[a.externalId,a]}));return b.map(function(a){var b=a.deviceJid;a=a.externalId;a=c.get(a);if(a==null)return{type:"missing"};b=a.permittedIdentitiesPerDevice.get(b);return b==null||!d("WATimeUtils").happenedWithin(a.ts,h)?{type:"unauthorized"}:{appData:a.contents,deviceIdentity:b,permittedIdentitiesPerDevice:a.permittedIdentitiesPerDevice,type:"unacked"}})})}});g.bulkGetAppDataForRetry=a}),98);
__d("MAWWriteAppDataRetryApi",["MAWIndexedDb","MAWTransactionMode","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({appData:d("MAWTransactionMode").READWRITE},"writeAppDataRetry",function(a){return function(b,d,e){return a.appData.get({externalId:b}).then(function(b){if(b==null)return;var f=b.permittedIdentitiesPerDevice,g=f.get(d);if(g==null)return;g.baseKey=e;f.set(d,g);return a.appData.update(b.appDataId,{permittedIdentitiesPerDevice:f}).then(c("emptyFunction"))})}});g.writeAppDataRetry=a}),98);
__d("WAMarkParticipantNeedsKeyApi",["WASignalDB","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";a=function(a,c){return d("WASignalDB").getDb().runInTransaction(["personalSenderKeyStatuses"],"readwrite",function(){var d=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var d=(yield b.stores.personalSenderKeyStatuses.get(a));if(d==null||d.rotateSenderKey)return;d.hasSenderKey["delete"](c);yield b.stores.personalSenderKeyStatuses.bulkPut([d])});return function(a){return d.apply(this,arguments)}}(),d("WASignalDB").signalOp("markParticipantNeedsKey"))};g.markParticipantNeedsKey=a}),98);
__d("WASendAppDataIndividualProtocol",["WAAsMessageApplication","WAConvertAppData","WAEncUserMsg","WAErrorMessage","WAGetCurrentUserDeviceInfoApi","WAGlobals","WAMsgApplication.pb","WAResultOrError","WASmaxAppdataPublishPeerRPC","WATagsLogger","WATimeUtils","asyncToGeneratorRuntime","encodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n=d("WATagsLogger").TAGS(["sendAppDataIndividual"]);function a(a,b,c,e,f){return o(a,b,c,void 0,e,f)["catch"](function(a){a=d("WAErrorMessage").maybeGetMessageFromError(a);n.ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Failed to send appdata to device with error: ",""])),a);return d("WAResultOrError").makeError("runtime-error")})}function c(a,b,c,e,f,g){return o(a,b,c,e,f,g)["catch"](function(a){a=d("WAErrorMessage").maybeGetMessageFromError(a);n.ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Failed to send appdata retry to device with error: ",""])),a);return d("WAResultOrError").makeError("runtime-error")})}function o(a,b,c,d,e,f){return p.apply(this,arguments)}function p(){p=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f,g){n.LOG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Sending appdata, externalId: ",""])),b);a=d("WAConvertAppData").convertAppData(a);var h={bytes:d("WAAsMessageApplication").castToMessageApplicationBytes(d("encodeProtobuf").encodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,a).readByteArrayView()),version:"v3"};a=(yield d("WAGlobals").getWaOneQueue().enqueue(function(a){a=a.cryptoManager;return d("WAEncUserMsg").encryptDeviceJidMessage(c,{messageBytes:h,type:"appdata"},{cryptoManager:a},void 0,g,f)},{operationType:"encrypt",flush:!0}));if(a==null){n.LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["MAWSendAppData Failed to encrypt appdata"])));return d("WAResultOrError").makeError("encrypt-failure")}var i;e!=null&&(i={appdataT:d("WATimeUtils").unixTime(),encRetryMixinArgs:{encCount:e}});e={appdataTo:c,encVersionFutureproofMixinArgs:{encV:parseInt(a.v,10)},encTypeIndividualMixinArgs:{encType:a.type,encElementValue:a.ciphertext},retryMixinArgs:i};e={peerPeerSingle:e};var o=void 0;if(a.type==="pkmsg"){var p=(yield d("WAGetCurrentUserDeviceInfoApi").getCurrentUserDeviceInfo());p=p==null?void 0:p.identityKey;if(p==null){n.ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Failed to fetch current device public identity key"])));return d("WAResultOrError").makeError("no-public-identity")}o={deviceIdentityElementValue:p}}p={appdataId:b,peerMsgTypesArgs:e,deviceIdentityMixinArgs:o};b=(yield d("WASmaxAppdataPublishPeerRPC").sendPeerRPC(p));switch(b.name){case"PeerResponseSuccess":return d("WAResultOrError").makeResult({baseKey:a.baseKey});default:b.name;n.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Failed to send appdata. Error: ",""])),b.value.error);return d("WAResultOrError").makeError("ack-failure")}});return p.apply(this,arguments)}g.sendAppDataToIndividualDeviceProtocol=a;g.sendAppDataRetryToIndividualDeviceProtocol=c}),98);
__d("WAWriteMsgRetryApi",["MAWTransactionMode","WADbTransactor","WAMsg"],(function(a,b,c,d,e,f,g){"use strict";a=d("WADbTransactor").makeSignalTransactor({receipts:d("MAWTransactionMode").READWRITE},"writeMsgRetry",function(a){return function(b,c,e){return h(a,d("WAMsg").craftWAMsgIdString({author:b.author,chat:b.chat,externalId:b.externalId}),c,e)}});function h(a,b,c,d){return a.receipts.get({waMsgId:b}).then(function(b){if(b==null||b.permittedIdentitiesPerDevice==null)return;var e=b.permittedIdentitiesPerDevice,f=e.get(c);if(f==null)return;f.baseKey=d;e.set(c,f);return a.receipts.put(babelHelpers["extends"]({},b,{permittedIdentitiesPerDevice:e})).then(function(){})})}g.writeMsgRetry=a}),98);
__d("WAWriteMsgRetryCountApi",["MAWTransactionMode","WADbTransactor","WAMsg"],(function(a,b,c,d,e,f,g){"use strict";a=d("WADbTransactor").makeSignalTransactor({receipts:d("MAWTransactionMode").READWRITE},"writeMsgRetryCount",function(a){return function(b,c,e){return h(a,d("WAMsg").craftWAMsgIdString({author:b.author,chat:b.chat,externalId:b.externalId}),c,e)}});function h(a,b,c,d){return a.receipts.get({waMsgId:b}).then(function(b){var e;if(b==null||d==null)return;e=(e=b.retryCountsPerDevice)!=null?e:new Map();e.set(c,d);return a.receipts.put(babelHelpers["extends"]({},b,{retryCountsPerDevice:e})).then(function(){})})}g.writeMsgRetryCount=a}),98);
__d("MAWSharedHandleRetryRequest",["MAWBulkGetAppDataForRetryApi","MAWConstants","MAWDebugMsg","MAWWriteAppDataRetryApi","Promise","WACryptoManagerUtils","WACryptoUtils","WAGenReportingMeta","WAGlobals","WAJids","WALoadReceiptApi","WALogger","WAMarkParticipantNeedsKeyApi","WAQPLProxy","WASendAppDataIndividualProtocol","WASendMsgInternal","WASentBytesCache","WAWap","WAWriteMsgRetryApi","WAWriteMsgRetryCountApi","asyncToGeneratorRuntime","gkx","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q;function r(){var a=0,b=0,c=new Map();return{getMetrics:function(){var d;return{appDataMissing:(d=c.get("appDatamissing"))!=null?d:0,appDataUnauthorized:(d=c.get("appDataunauthorized"))!=null?d:0,appDataUnsupported:(d=c.get("appDataunsupported"))!=null?d:0,msgMissing:(d=c.get("msgmissing"))!=null?d:0,msgUnauthorized:(d=c.get("msgunauthorized"))!=null?d:0,msgUnsupported:(d=c.get("msgunsupported"))!=null?d:0,receiptFailures:b,receiptSuccesses:a}},markError:function(){return b++},markSuccess:function(){return a++},setError:function(a){var b=c.get(a);b!=null?c.set(a,b+1):c.set(a,1)}}}function s(a,b){return b+"_"+a}function a(a){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(a.length===0)return[];d("WALogger").LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["bulkHandleRetryRequest called for ",""])),a.map(function(a){a=a.externalId;return a}).join(","));var e=d("WAQPLProxy").waQPLProxyStart(c("qpl")._(25308942,"164"),{bool:{bulk:!0},"int":{receipts:a.length},string:{origin:self.location.origin}}),f=new Set(a.filter(function(a){return a.category!=null&&!C(a)||D(a)}).map(function(a){return a.externalId})),g=a.filter(function(a){return!f.has(a.externalId)&&!C(a)}),h=a.filter(C);h=(yield (q||(q=b("Promise"))).all([u(h),x(g)]));g=h[0];h=h[1];e.addPoint("get_msg_for_retry_complete");var i=[],j=r();for(a of a){var m=g.get(a.externalId),n=h.get(s(a.from.author,a.externalId));f.has(a.externalId)?(e.addPoint("just_ack"),j.markError(),j.setError("just_ack"),E(a)):m!=null?(e.addPoint("app_data_for_retry"),yield F(a,m,e,!1,j),e.addPoint("app_data_for_retry_complete")):n!=null?(e.addPoint("msg_for_retry"),yield H(a,n,e,!1,j),e.addPoint("msg_for_retry_complete")):(d("WALogger").ERROR(l||(l=babelHelpers.taggedTemplateLiteralLoose(["bulkHandleRetryRequest unexpected receipt"]))),j.markError(),j.setError("unexpected_receipt"));i.push(B(a))}e.endSuccess({"int":babelHelpers["extends"]({},j.getMetrics())});return i});return t.apply(this,arguments)}function u(a){return v.apply(this,arguments)}function v(){v=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(a.length===0)return new Map();var b=a.map(function(a){var b=a.externalId;a=a.from;return{deviceJid:a.author,externalId:b}});b=(yield d("MAWBulkGetAppDataForRetryApi").bulkGetAppDataForRetry(b));return new Map(b.map(function(b,c){c=a[c];return[c.externalId,b]}))});return v.apply(this,arguments)}function w(a){return a.map(function(a){var b=a.externalId,c=a.from,e=a.recipient,f=c.chat;if(c.type==="device"&&d("WAJids").extractUserJid(c.author)===d("WAJids").extractUserJid(d("WAGlobals").getMyDeviceJid())){if(e==null){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Received retry request from peer without recipient set"])));return}f=e}e={author:"@me",chat:f,externalId:b};return{deviceJid:c.author,protocolMsgId:e,retryCount:a.retryCount}})}function x(a){return y.apply(this,arguments)}function y(){y=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(a.length===0)return new Map();var b=w(a),c=a.filter(function(a,c){return b[c]!=null}),e=b.filter(Boolean);a=(yield d("WASentBytesCache").sentBytesCache().getMsgsForRetry(e));a=new Map(a.map(function(a,b){return[s(e[b].deviceJid,c[b].externalId),{msgForRetry:a,retryRequest:e[b]}]}));return a});return y.apply(this,arguments)}function z(a,b){return A.apply(this,arguments)}function A(){A=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=void 0,e=(yield d("WAGlobals").getWaOneQueue().enqueue(function(b){b=b.cryptoManager;return d("WACryptoManagerUtils").getParticipantInfo(a.from.author,b)},{flush:!1,operationType:"get_participant_info"}));if(a.keys!=null){var f=a.keys,g=a.timestamp;b={baseKey:b.baseKey,keys:f,timestamp:g};f=J(a,e);f?c={session:b,type:"compareTSAndUseSession"}:c={session:b,type:"useSession"}}else{g=e==null||a.regId!==e.regId;g&&(c={type:"requestNewSession"})}return c});return A.apply(this,arguments)}function B(a){var b,c=a.externalId;a=a.from;return(b=d("WAWap")).wap("ack",{"class":"receipt",id:b.CUSTOM_STRING(c),participant:b.PARTICIPANT_JID(a),to:b.TO_JID(a),type:"retry"})}function C(a){a=a.category;return a==="peer_appdata"||a==="peer"}function D(a){a=a.retryCount;return a>=d("MAWConstants").MESSAGE_RETRY_COUNT_LIMIT}function E(a){if(D(a)){d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied due to retry count"])));return}if(a.category!=null){d("WALogger").WARN(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Unknown receipt categories: ",""])),a.category);return}}function F(a,b,c,d,e){return G.apply(this,arguments)}function G(){G=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f){e===void 0&&(e=!0);var g=a.externalId,h=a.from,i=a.retryCount;c.addPoint("get_app_data_for_retry");if(b.type!=="unacked"){d("WALogger").LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied with type "," id: ",""])),b.type,g);e?c.endFail(b.type):c.addPoint(b.type);f==null||f.markError();f==null||f.setError("appData"+b.type);return}e=b.appData;b=b.deviceIdentity;a=(yield z(a,b));c.addPoint("get_session_info");e=(yield d("WASendAppDataIndividualProtocol").sendAppDataRetryToIndividualDeviceProtocol(e,g,h.author,i,b.pubKey,a));c.addPoint("send_app_data");if(i>=2&&e.success===!0&&e.value.baseKey!=null){b=e.value.baseKey;yield d("MAWWriteAppDataRetryApi").writeAppDataRetry(g,h.author,b)}f==null||f.markSuccess();return e});return G.apply(this,arguments)}function H(a,b,c,d,e){return I.apply(this,arguments)}function I(){I=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g){var h;f===void 0&&(f=!0);var i=b.msgForRetry;b=b.retryRequest;var j=a.externalId,k=a.from,l=a.retryCount,m=b.protocolMsgId.chat;if(i.type!=="unacked"){f&&e.endFail(i.type);d("WALogger").LOG(n||(n=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied with type ",""])),i.type);g==null||g.markError();g==null||g.setError("msg"+i.type);return}if(i.retryCount!=null&&i.retryCount>0&&i.retryCount===l){f&&e.endFail("unauthorized");d("WALogger").LOG(o||(o=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied because (messageId, deviceJID, retryCount) is already executed for retryCount ",""])),l);g==null||g.markError();g==null||g.setError("msgunauthorized");return}k.type==="group"&&(yield d("WAMarkParticipantNeedsKeyApi").markParticipantNeedsKey(k.chat,k.author),e.addPoint("mark_participant_needs_key_complete"));var q=i.backupDirective,r=i.frankingKey,s=i.frankingVersion,t=i.isInstamadillo,u=i.messageBytes,v=i.messageType,w=i.protocolMsgId,x=(yield d("WALoadReceiptApi").loadReceipt({author:w.author,chat:w.chat,externalId:w.externalId}).then(function(a){return a.success?a.value:null})),y=x==null||(h=x.permittedIdentitiesPerDevice)==null?void 0:h.get(b.deviceJid);if(x==null||y==null){f&&e.endFail("unauthorized");d("WALogger").LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied because receipt is null"])));g==null||g.markError();g==null||g.setError("msgunauthorized");return}x=(yield z(a,y));e.addPoint("get_session_info_complete");c("gkx")("24021")&&(yield d("MAWDebugMsg").writeDebugMsg(m,"Handling retry request for message: "+i.protocolMsgId.externalId.toString()+" to user "+k.author));f=(yield d("WAGenReportingMeta").genReportingMeta(u.bytes,r,s));a=(yield d("WASendMsgInternal").sendMessage({backupDirective:q,chat:m,count:l,deviceIdentity:null,externalId:j,identityKey:y.pubKey,messageBytes:u,messageType:v,protocolMsgId:w,reportingMeta:f,sessionInfo:x,to:k.author,type:"direct"},e,t));e.addPoint("send_message_complete");if(l>=2&&a.success&&a.value.baseKey!=null){i=a.value.baseKey;yield d("WAWriteMsgRetryApi").writeMsgRetry(b.protocolMsgId,k.author,i)}l>=1&&a.success&&(yield d("WAWriteMsgRetryCountApi").writeMsgRetryCount(b.protocolMsgId,k.author,l));g==null||g.markSuccess()});return I.apply(this,arguments)}function J(a,b){if(a.offline==null)return!1;var c=b==null||a.regId!==b.regId;b=b!=null&&a.keys!=null&&!d("WACryptoUtils").uint8ArraysEqual(b.pubKey,a.keys.identity);return c||b}g.bulkHandleRetryRequest=a}),98);
__d("MAWCOPRetryHandler",["MAWIsQuotaExceededError","MAWSharedCOPLogger","MAWSharedHandleRetryRequest","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return i(a)["catch"](function(a){if(d("MAWIsQuotaExceededError").isQuotaExceededError(a))throw a;c("MAWSharedCOPLogger").catching(a).MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Receipt consumer error"])));return[]})}function i(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(a.length===0)return[];yield d("MAWSharedHandleRetryRequest").bulkHandleRetryRequest(a.map(function(a){return a.retry}));return a.map(function(a){return a.stanzaQueueId})});return j.apply(this,arguments)}g["default"]=a}),98);
__d("MAWSplitProtocolEntityByType",[],(function(a,b,c,d,e,f){"use strict";function a(a){var b={appdatas:[],instructions:[],messages:[],notifications:[],receipts:[],retries:[]};a.forEach(function(a){switch(a.type){case"message":b.messages.push(a);return;case"retryReceipt":b.retries.push(a);return;case"appdata":b.appdatas.push(a);return;case"notification":b.notifications.push(a);return;case"receipt":b.receipts.push(a);return;default:a;b.instructions.push(a);return}});return b}f["default"]=a}),66);
__d("MawMpsPayloadToWaProtocolEntry",["FBLogger","MAWJids","MAWProtobufDeserializers","MAWUnsafeCoerce","MpsFutureProofKey","MpsTypes","WAArmadilloTransportEvent.pb","WADecodeIncomingMsg","WAFranking","WAFrankingTypes","WAJids","WAProtocolQueue","WAStanzaUtils","WATimeUtils","err","gkx"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return null}function a(a){return i(a.payload,a.messageId,a.threadId,a.senderId,a.timestampMs,"wa")}function b(a){var b=a.toplevelProtobuf,e=b.messageId,f=b.payload,g=b.senderId,h=b.threadId;b=b.timestampMs;f=i(f,e,h,g,b,"ebrestore");e=a.supplementalProtobufs;g=Array.from(e.values()).map(function(a){var b;b=(b=d("MAWProtobufDeserializers").DeserializedBackupMessage.create(a.payload).proto.metadata)==null?void 0:b.senderId;if(b==null){c("FBLogger")("mps").mustfix("Supplemental message has no senderId");return null}b=i(a.payload,a.messageId,h,b,a.timestampMs,"ebrestore");return b});return[f].concat(g).filter(Boolean)}function i(a,b,e,f,g,i){a=d("MAWProtobufDeserializers").DeserializedBackupMessage.create(a);var j=a.payload();switch(j.kind){case"messageApplication":var k=j,l=k.subProtocol(),m;if(l==null){m=d("WADecodeIncomingMsg").parseEphemeralSetting(k.proto.metadata,j.bytes);if(m.type==="error")return null}else{var n;if(l.kind==="armadillo"&&((n=l.payload)==null?void 0:n.applicationData)!=null){n=d("MAWUnsafeCoerce").unsafeCoerce(b);return{appdata:d("WAProtocolQueue").appdataApplicationProtocol({payload:k.bytes,version:3}),deviceJid:d("WAJids").toDeviceJid(d("MAWJids").toUserJid(f),d("WAJids").DEFAULT_DEVICE_ID),jid:d("MAWJids").threadIdToChatJid(e),priority:d("WAProtocolQueue").WAProtocolQueuePriorityHigh,stanzaId:d("MpsTypes").messageIdToStanzaId(b),stanzaQueueId:n,type:"appdata"}}m={applicationPayload:k.bytes,backupDirective:null,frankingContent:k.bytes,icdc:null,metadata:(n=j.proto.metadata)!=null?n:null,protobuf:new Uint8Array(k.bytes),subprotocol:new Uint8Array(l.bytes),subprotocolType:l.kind==="armadillo"?"armadillo":"consumerMessage",type:"subprotocol",version:"v3"}}k={contentType:h(k),fbFolderId:null,from:d("WAJids").toDeviceJid(d("MAWJids").toUserJid(f),d("WAJids").DEFAULT_DEVICE_ID),incomingType:i,jid:d("MAWJids").threadIdToChatJid(e),message:m,offline:null,priority:d("WAProtocolQueue").WAProtocolQueuePriorityHigh,recipient:void 0,remoteIdentity:null,reportingMeta:{frankingKey:null,frankingTag:((n=a.proto.metadata)==null||(n=n.frankingMetadata)==null?void 0:n.frankingTag)!=null?d("WAFrankingTypes").castToFrankingTag(new Uint8Array(a.proto.metadata.frankingMetadata.frankingTag)):null,frankingVersion:d("WAFranking").getFrankingVersion(),reportingContent:null,reportingTag:((l=a.proto.metadata)==null||(l=l.frankingMetadata)==null?void 0:l.reportingTag)!=null?new Uint8Array(a.proto.metadata.frankingMetadata.reportingTag):null},retryCount:0,serverTs:d("WATimeUtils").castMilliSecondsToUnixTime(g),stanzaId:d("MpsTypes").messageIdToStanzaId(b),subtype:"armadillo",type:"message"};m=d("MAWUnsafeCoerce").unsafeCoerce(b);return babelHelpers["extends"]({},k,{stanzaQueueId:m});case"transportEvent":n=j;if(n.proto.event!=null){l=n.proto.event;if(l.icdcAlert!=null){k={instruction:"icdcError",jid:d("MAWJids").toUserJid(f),notificationTs:d("WATimeUtils").castMilliSecondsToUnixTime(g),priority:d("WAProtocolQueue").WAProtocolQueuePriorityHigh,type:"instruction"};m=d("MAWUnsafeCoerce").unsafeCoerce(b);return babelHelpers["extends"]({},k,{stanzaQueueId:m})}}if(n.proto.placeholder!=null&&n.proto.placeholder.type!=null)switch(n.proto.placeholder.type){case d("WAArmadilloTransportEvent.pb").TransportEvent$Placeholder$Type.DECRYPTION_FAILURE:n={contentType:null,decryptionError:"",fbFolderId:null,from:d("WAJids").toDeviceJid(d("MAWJids").toUserJid(f),d("WAJids").DEFAULT_DEVICE_ID),hideDecryptionFailure:((l=a.proto.metadata)==null?void 0:l.futureProofBehavior)===d("MpsFutureProofKey").WCEPlaintextPayloadFutureProof.WCEPlaintextPayloadFutureProofNoPlaceholder,jid:d("MAWJids").threadIdToChatJid(e),offline:null,priority:d("WAProtocolQueue").WAProtocolQueuePriorityHigh,recipient:void 0,reportingMeta:{frankingKey:null,frankingTag:((k=a.proto.metadata)==null||(k=k.frankingMetadata)==null?void 0:k.frankingTag)!=null?d("WAFrankingTypes").castToFrankingTag(new Uint8Array(a.proto.metadata.frankingMetadata.frankingTag)):null,frankingVersion:d("WAFranking").getFrankingVersion(),reportingContent:null,reportingTag:((m=a.proto.metadata)==null||(m=m.frankingMetadata)==null?void 0:m.reportingTag)!=null?new Uint8Array(a.proto.metadata.frankingMetadata.reportingTag):null},retryCount:0,serverTs:d("WATimeUtils").castMilliSecondsToUnixTime(g),stanzaId:d("WAStanzaUtils").toStanzaId(b),subtype:"ciphertext",type:"message"};l=d("MAWUnsafeCoerce").unsafeCoerce(b);return babelHelpers["extends"]({},n,{stanzaQueueId:l});case d("WAArmadilloTransportEvent.pb").TransportEvent$Placeholder$Type.UNAVAILABLE_MESSAGE:n={contentType:null,fbFolderId:null,from:d("WAJids").toDeviceJid(d("MAWJids").toUserJid(f),d("WAJids").DEFAULT_DEVICE_ID),jid:d("MAWJids").threadIdToChatJid(e),offline:null,priority:d("WAProtocolQueue").WAProtocolQueuePriorityHigh,recipient:void 0,reportingMeta:{frankingKey:null,frankingTag:((k=a.proto.metadata)==null||(k=k.frankingMetadata)==null?void 0:k.frankingTag)!=null?d("WAFrankingTypes").castToFrankingTag(new Uint8Array(a.proto.metadata.frankingMetadata.frankingTag)):null,frankingVersion:d("WAFranking").getFrankingVersion(),reportingContent:null,reportingTag:((m=a.proto.metadata)==null||(m=m.frankingMetadata)==null?void 0:m.reportingTag)!=null?new Uint8Array(a.proto.metadata.frankingMetadata.reportingTag):null},retryCount:0,serverTs:d("WATimeUtils").castMilliSecondsToUnixTime(g),stanzaId:d("WAStanzaUtils").toStanzaId(b),subtype:"unavailable",type:"message"};l=d("MAWUnsafeCoerce").unsafeCoerce(b);return babelHelpers["extends"]({},n,{stanzaQueueId:l})}break;case"locallyTransformedMessage":break;case"adminMessage":if(!c("gkx")("3049"))break;k=j;m={content:k.proto,type:"admin"};k={contentType:null,fbFolderId:null,from:d("WAJids").toDeviceJid(d("MAWJids").toUserJid(f),d("WAJids").DEFAULT_DEVICE_ID),incomingType:i,jid:d("MAWJids").threadIdToChatJid(e),message:m,offline:null,priority:d("WAProtocolQueue").WAProtocolQueuePriorityHigh,recipient:void 0,remoteIdentity:null,reportingMeta:{frankingKey:null,frankingTag:((n=a.proto.metadata)==null||(n=n.frankingMetadata)==null?void 0:n.frankingTag)!=null?d("WAFrankingTypes").castToFrankingTag(new Uint8Array(a.proto.metadata.frankingMetadata.frankingTag)):null,frankingVersion:d("WAFranking").getFrankingVersion(),reportingContent:null,reportingTag:((l=a.proto.metadata)==null||(l=l.frankingMetadata)==null?void 0:l.reportingTag)!=null?new Uint8Array(a.proto.metadata.frankingMetadata.reportingTag):null},retryCount:0,serverTs:d("WATimeUtils").castMilliSecondsToUnixTime(g),stanzaId:d("MpsTypes").messageIdToStanzaId(b),subtype:"armadillo",type:"message"};f=d("MAWUnsafeCoerce").unsafeCoerce(b);return babelHelpers["extends"]({},k,{stanzaQueueId:f});default:j}}function e(a,b,e){b=new Set(b);for(a of a)!b.has(d("MAWUnsafeCoerce").unsafeCoerce(a.message.messageId))&&!e.has(a.message.messageId)&&e.set(a.message.messageId,c("err")("Ack not received"));return e}g.mpsIncomingPayloadToWAProtocolEntry=a;g.mpsFullMessageToMawPayload=b;g.mawAcksToMpsIncomingPayloadErrorMap=e}),98);
__d("MAWProtocolQueueProcess",["FBLogger","MAWCOPAppdataHandler","MAWCOPInstructionsHandler","MAWCOPMessagesHandler","MAWCOPNotificationsHandler","MAWCOPReceiptsHandler","MAWCOPRetryHandler","MAWDbMsgTxns","MAWSharedCOPLogger","MAWSplitProtocolEntityByType","MawMpsPayloadToWaProtocolEntry","MpsTypes","Promise","WAJids","WebMps","asyncToGeneratorRuntime","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m;function a(a){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=c("MAWSplitProtocolEntityByType")(a);c("MAWSharedCOPLogger").DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["COP handler for "," msgs, "," appdatas, "," notifications, "," receipts, "," retries, "," instructions"])),a.messages.length,a.appdatas.length,a.notifications.length,a.receipts.length,a.retries.length,a.instructions.length);a=(yield (m||(m=b("Promise"))).all([c("MAWCOPMessagesHandler")(a.messages),c("MAWCOPInstructionsHandler")(a.instructions),c("MAWCOPReceiptsHandler")(a.receipts),c("MAWCOPAppdataHandler")(a.appdatas),c("MAWCOPNotificationsHandler")(a.notifications),c("MAWCOPRetryHandler")(a.retries)])).flat();return a});return n.apply(this,arguments)}function e(a){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=a;var e=a.map(function(a){return{chat:d("WAJids").unsafeCoerceToChatJid(a.toplevelProtobuf.threadId),externalId:d("MpsTypes").messageIdToStanzaId(a.toplevelProtobuf.messageId)}}),f=(yield d("MAWDbMsgTxns").checkMessagesExistenceByProtocolMsgIds(e));a=a.filter(function(a,b){return f[b]==null});if(a.length===0){c("MAWSharedCOPLogger").DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["MPS COP: All messages already exist in MAW DB, skipping"])));return}e=a.map(function(a){try{return d("MawMpsPayloadToWaProtocolEntry").mpsFullMessageToMawPayload(a)}catch(d){var b=c("getErrorSafe")(d);c("FBLogger")("COP").catching(b).mustfix("Failed to convert FullMessage %s to MAW payload",a.toplevelProtobuf.messageId);return null}}).flat().filter(Boolean);c("MAWSharedCOPLogger").DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["MPS COP handler for "," msgs"])),e.map(function(a){return a.stanzaId}).join(", "));a=c("MAWSplitProtocolEntityByType")(e);c("MAWSharedCOPLogger").DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["MPS COP handler for "," msgs, "," appdatas, "," notifications, "," receipts, "," retries, "," instructions"])),a.messages.length,a.appdatas.length,a.notifications.length,a.receipts.length,a.retries.length,a.instructions.length);yield (m||(m=b("Promise"))).all([c("MAWCOPMessagesHandler")(a.messages),c("MAWCOPInstructionsHandler")(a.instructions),c("MAWCOPAppdataHandler")(a.appdatas),c("MAWCOPNotificationsHandler")(a.notifications)])});return o.apply(this,arguments)}function p(a){return q.apply(this,arguments)}function q(){q=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.filter(function(a){return a.directive!=null&&a.directive.isTransportErrorPlaceholder&&a.directive.actionType===d("MpsTypes").ActionType.UpsertTopLevel});if(e.length===0)return a.map(function(a){return a.message});e=(yield (m||(m=b("Promise"))).all(e.map(function(a){return d("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!1,shouldFetchTags:!1,strategy:"local-only"},debug:{purpose:"decryption-error-recovery-m3"},messageId:a.message.messageId,threadId:a.message.threadId}).then(function(a){return a.success===!0&&a.value!=null?a.value.toplevelProtobuf:null})["catch"](function(a){c("FBLogger")("mps").catching(a).mustfix("Failed to load message to recover decryption error");return null})}))).filter(Boolean);if(e.length===0)return a.map(function(a){return a.message});var f=new Map();e.forEach(function(a){var b=a.threadId,c=f.get(b);c==null&&(c=new Map(),f.set(b,c));c.set(a.messageId,a)});return a.map(function(a){var b;b=(b=f.get(a.message.threadId))==null?void 0:b.get(a.message.messageId);return b!=null?b:a.message})});return q.apply(this,arguments)}function f(a){return r.apply(this,arguments)}function r(){r=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=new Map(),f=(yield p(a));f=f.map(function(a){try{return d("MawMpsPayloadToWaProtocolEntry").mpsIncomingPayloadToWAProtocolEntry(a)}catch(d){var b=c("getErrorSafe")(d);c("FBLogger")("COP").catching(b).mustfix("Failed to convert incoming payload to MAW payload");e.set(a.messageId,b);return null}}).flat().filter(Boolean);f=c("MAWSplitProtocolEntityByType")(f);c("MAWSharedCOPLogger").DEBUG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["MPS COP handler for "," msgs, "," appdatas, "," notifications, "," receipts, "," retries, "," instructions"])),f.messages.length,f.appdatas.length,f.notifications.length,f.receipts.length,f.retries.length,f.instructions.length);f=(yield (m||(m=b("Promise"))).all([c("MAWCOPMessagesHandler")(f.messages),c("MAWCOPInstructionsHandler")(f.instructions),c("MAWCOPAppdataHandler")(f.appdatas),c("MAWCOPNotificationsHandler")(f.notifications)])).flat();return d("MawMpsPayloadToWaProtocolEntry").mawAcksToMpsIncomingPayloadErrorMap(a,f,e)});return r.apply(this,arguments)}g.processProtocolQueueEntries=a;g.processMPSFullMessageEntries=e;g.processMPSIncomingPayloadEntries=f}),98);
__d("MAWDecryptUnstoredPollUpdateMessage",["FBLogger","MAWGroupPollsDualEncryptionUtils","Promise","WAGlobals","WAJids","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f){var g=e.encryptedMessage.vote,i=e.encryptedMessage.addOption,j=f.encKey,k=f.pollAuthor===d("WAJids").AUTHOR_ME?d("WAGlobals").getMyUserJid():d("WAJids").authorAsUserJid(f.pollAuthor);f=f.pollStanzaId;var l=a.externalId;a=a.author===d("WAJids").AUTHOR_ME?d("WAGlobals").getMyUserJid():d("WAJids").authorAsUserJid(a.author);if(a==null||l==null||k==null){c("FBLogger")("GroupPollsE2EE").mustfix("Missng param - pollUpdateSenderJid:%s pollUpdateStanzaId:%s pollCreationSenderJid:%s",a,l,k);return(h||(h=b("Promise"))).resolve(e)}j={pollCreationMessageKey:j,pollCreationSenderJid:k,pollCreationStanzaId:f,pollUpdateSenderJid:a,pollUpdateStanzaId:l};k=null;g!=null&&(k=(yield d("MAWGroupPollsDualEncryptionUtils").decryptGroupPollVote(g,j).then(function(a){if(a.success===!1){c("FBLogger")("GroupPollsE2EE").mustfix("Failed to decrypt vote for pollUpdateStanzaId:%s",l,a.error);return null}return a.value})));f=null;if(i!=null){a=(yield d("MAWGroupPollsDualEncryptionUtils").decryptGroupPollAddOption(i,j).then(function(a){if(a.success===!1){c("FBLogger")("GroupPollsE2EE").mustfix("Failed to decrypt poll options for pollUpdateStanzaId:%s",l,a.error);return null}return a.value}));a!=null&&(f=(yield (h||(h=b("Promise"))).all(a.pollOption.map(function(a){if(a.optionName==null)return null;var b=a.optionName;return d("MAWGroupPollsDualEncryptionUtils").getHashForOptionName(b).then(function(a){return{hashedOptionName:a,optionName:b}})}).filter(Boolean))))}return k==null&&f==null?e:babelHelpers["extends"]({},e,{decrypted:{optionsToAdd:f!=null?f:void 0,vote:k!=null?k:void 0}})});return i.apply(this,arguments)}g.decryptUnstoredPollUpdateMessage=a}),98);
__d("MAWProtocolQueueMsg",["MAWBulkHandleIncomingMsgApi","MAWDbPoll","MAWDbPollTxns","MAWDecryptUnstoredPollUpdateMessage","MAWGroupPollsDualEncryptionUtils","MAWHIMLogger","MAWIsRTCCallXmaEnabled","MAWMsgType","MAWParseXMAProtocol","MAWXMALoggingUtils","MAWXMAUtils","MWFBLogger","Promise","asyncToGeneratorRuntime","qex"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;function a(a,b){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e){var f=new Set(),g=a.map(function(a){var b,c,e,g,h,i=a.decodedMsg,j=a.receiveFlow;a=a.stanza;var k=a.message.decrypted,l=d("MAWXMALoggingUtils").getXmaTargetTypeStringFromEnum(i==null?void 0:i.xmaTargetTypeForLogging),m=i==null||(b=i.unstoredXMA)==null?void 0:b.unstoredDbXMA.xmaDataclass,n=i==null||(c=i.unstoredXMA)==null?void 0:c.unstoredDbXMA.targetType;n=d("MAWParseXMAProtocol").getUnsupportedMessageType(n,m);j.addAnnotations({bool:{furuteproof:(i==null||(e=i.unstoredDbMsg)==null?void 0:e.type)===d("MAWMsgType").MSG_TYPE.FUTUREPROOF},"int":{xmaTargetType:(m=i==null?void 0:i.xmaTargetTypeForLogging)!=null?m:-1},string:{contentType:(m=i==null?void 0:i.contentTypeForLogging)!=null?m:"",subtype:(m=i==null||(g=i.unstoredDbMsg)==null||(g=g.msgContent)==null?void 0:g.subtype)!=null?m:n,xmaTargetTypeString:l}});if(d("MAWXMAUtils").isRtcXMA(i==null||(h=i.unstoredXMA)==null||(h=h.unstoredDbXMA)==null?void 0:h.targetType)&&!d("MAWIsRTCCallXmaEnabled").isRTCCallXmaEnabled()){j.endFail("rtc_xma_not_supported");f.add(a.stanzaQueueId);return null}if(k.type==="InstamadilloMsg"){j.endFail("instamadillo_not_supported");f.add(a.stanzaQueueId);return null}if(k.type==="InvisibleMsg"){f.add(a.stanzaQueueId);return null}return{msgData:k,receiveFlow:j,stanzaSource:a.incomingType,unstoredContent:i}}).filter(Boolean),l=c("qex")._("3170")!==!0?g:yield (k||(k=b("Promise"))).all(g.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c,e=a.msgData,f=a.receiveFlow,g=a.stanzaSource,h=a.unstoredContent;if((h==null||(c=h.unstoredDbMsg)==null?void 0:c.type)===d("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE&&(h==null?void 0:h.unstoredDbGroupPollCreateInfo)!=null){var i,j=h.unstoredDbGroupPollCreateInfo;i=(i=j.options)!=null?i:[];i=(yield (k||(k=b("Promise"))).all(i.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield d("MAWGroupPollsDualEncryptionUtils").getHashForOptionName(a));return{optionHash:b,optionText:a}});return function(b){return a.apply(this,arguments)}}())));i=new Map(i.map(function(a){var b=a.optionHash;a=a.optionText;return[d("MAWDbPoll").convertStringToOptionHash(b),{optionText:a,voteAuthors:new Set()}]}));return{msgData:e,receiveFlow:f,stanzaSource:g,unstoredContent:babelHelpers["extends"]({},h,{unstoredDbGroupPollCreateInfo:babelHelpers["extends"]({},j,{optionsHashed:i})})}}if((h==null?void 0:h.unstoredDbGroupPollUpdateInfo)!=null){j=h.unstoredDbGroupPollUpdateInfo;i=(i=j.encryptedMessage.pollCreationMessageKey)==null?void 0:i.id;if(i==null){d("MWFBLogger").MWLogger.tags(["PollsE2EE"]).warn("pollStanzaId is null");return{msgData:e,receiveFlow:f,stanzaSource:g,unstoredContent:h}}i=(yield d("MAWDbPollTxns").getDbPoll(e.id.chat,i));if(i==null)return{msgData:e,receiveFlow:f,stanzaSource:g,unstoredContent:h};j=(yield d("MAWDecryptUnstoredPollUpdateMessage").decryptUnstoredPollUpdateMessage(e.id,j,i));return{msgData:e,receiveFlow:f,stanzaSource:g,unstoredContent:babelHelpers["extends"]({},h,{unstoredDbGroupPollUpdateInfo:j})}}return a});return function(b){return a.apply(this,arguments)}}()));c("MAWHIMLogger").DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Handle: "," msgs"])),l.length);return d("MAWBulkHandleIncomingMsgApi").bulkHandleIncomingMsgs(l,e).then(function(b){var d=b.msgResults;c("MAWHIMLogger").DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Handle: "," msgs: done"])),l.length);a.map(function(a){a=a.stanza;var b=d.get(a.message.decrypted.id);if(b==null){f.has(a.stanzaQueueId)||c("MAWHIMLogger").MUSTFIX(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Cannot have null result for non-invisible msgs"])));return}b.success===!0&&f.add(a.stanzaQueueId)});return{followUpParams:{incomingMsgResults:d,incomingMsgs:a},toAck:Array.from(f)}})["catch"](function(b){var c="Not an Error instance",d="N/A";typeof b.message==="string"&&(c=b.message);typeof b.stack==="string"&&(d=b.stack);a.forEach(function(a){a.receiveFlow.endFail("consumer_handle_message_transaction_error",{string:{errorDescription:c,errorStack:d}})});throw b})});return l.apply(this,arguments)}g.handleIncomingMessagesStanzas=a}),98);
__d("MawCopScheduler",["WorkerScheduler"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){h==null&&(h=d("WorkerScheduler").makeScheduler("cop",{concurrency:1,maxConcurrency:1,maxThrottleMs:1e5,timeToStuckMs:1e5}));return h}g.copScheduler=a}),98);
__d("MpsToUIPostProcessor",["FBLogger","MpsMessageToBridge","MpsMessageToBridgeWrapper","MpsToBridgeMessageId","MpsTypes","WAJids","WATimeUtils","WebMps","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return[{tag:"NewMsg",value:a}]}function i(a){return[{tag:"EditMsgHistoryAdded",value:[a]}]}function j(a){if(a.type==="upsert")return[{tag:"UpsertReaction",value:a.reaction}];else if(a.type==="delete")return[{tag:"DeleteReaction",value:a.reaction}];a.type;throw c("FBLogger")("messenger_web").mustfixThrow("unreachable")}function k(a){return[{tag:"NewMedia",value:a}]}function l(a){return[{tag:"MsgsStartCountdown",value:a}]}function m(a){return[{tag:"NewReceiverFetchInfo",value:a}]}function a(a){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(a.directive.actionType===d("MpsTypes").ActionType.DeleteTopLevel){var b=d("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(a.message),e=d("MpsToBridgeMessageId").mpsToBridgeMsgId(b.message.threadId,a.directive.targetMessageId);return[{tag:"DeleteMessages",value:{messages:[{msgId:e,ts:b.getUnixTs()}],threadJid:b.getChatJid()}}]}if(!(a.directive.actionType===d("MpsTypes").ActionType.UpsertTopLevel||a.directive.actionType===d("MpsTypes").ActionType.UpsertSupplemental||a.directive.actionType===d("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder))return[];e=a.directive.actionType===d("MpsTypes").ActionType.UpsertSupplemental?a.directive.targetMessageId:a.message.messageId;b=(yield d("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!0,strategy:"local-only"},debug:{purpose:"UI-fetch"},messageId:e,threadId:a.message.threadId}));e=b.value;if(!e)return[];a=d("MpsMessageToBridge").mpsFullMessagetoBridge(e);if(a==null)return[];b=[a.topLevel].concat(a.supplementals).map(function(a){switch(a.kind){case"bridgeMsg":return h(a.value);case"bridgeEditHistoryMsg":return i(a.value);case"bridgeReactionAction":return j(a.value);case"bridgeMedia":return k(a.value);case"bridgeMsgsStartCountdown":return l(a.value);case"bridgeReceiverFetchInfo":return m(a.value);default:a.kind;throw c("FBLogger")("messenger_web").mustfixThrow("unreachable")}});a=b.flat();b=d("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(e.toplevelProtobuf);e=[{tag:"VerifyThreadExists",value:{authoritativeThreadKey:null,cannotReplyReason:null,clientThreadKey:null,description:"mpsToUIPostProcessor",folder:null,instanceKey:null,isGroup:d("WAJids").switchOnMsgrChatJidType(b.getChatJid(),{group:function(){return!0},user:function(){return!1}}),jid:b.getChatJid(),lastActivityTs:d("WATimeUtils").castToMillisTime(0),lastReadTs:d("WATimeUtils").castToMillisTime(0)}}];return e.concat(a)});return n.apply(this,arguments)}g.mpsToUIEventPostProcessPayload=a}),98);
__d("MawMpsCop",["FBLogger","MAWBridge","MAWMpsGating","MAWProtocolQueueProcess","MawCopScheduler","MawMpsCopProtocolQueueProcessor","MpsToUIPostProcessor","MpsTypes","Promise","WAPubSub","WAWaitForUserUnblocked","WebMps","WorkerScheduler","asyncToGeneratorRuntime","getErrorSafe","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h,i=1,j=10,k=c("justknobx")._("4688"),l=function(){function a(){this.$1=d("WAPubSub").simplePubSub(),this.$3=new Map(),this.$2=new(d("MawMpsCopProtocolQueueProcessor").ProtocolQueueProcessor)()}var e=a.prototype;e.loadMsgIntoMaw=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=(yield d("WebMps").mps().loadMessage(a));if(a.success===!1)throw a.error;if(a.value==null)return;yield d("MAWProtocolQueueProcess").processMPSFullMessageEntries([a.value])});function c(b){return a.apply(this,arguments)}return c}();e.loadBatchMsgsIntoMaw=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield d("WebMps").mps().batchLoadMessages(babelHelpers["extends"]({},a,{config:{shouldFetchSupplementals:!0,shouldFetchTags:!0,strategy:"full-fetch"}})));return b.success===!1?b:d("MAWProtocolQueueProcess").processMPSFullMessageEntries(b.value.map(function(a){return a.messages}).flat()).then(function(){return b})});function c(b){return a.apply(this,arguments)}return c}();e.loadMoreMsgsIntoMaw=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield d("WebMps").mps().loadMessages(babelHelpers["extends"]({},a,{config:{shouldFetchSupplementals:!0,shouldFetchTags:!0,strategy:"full-fetch"}})));return b.success===!1?b:d("MAWProtocolQueueProcess").processMPSFullMessageEntries(b.value.messages).then(function(){return b})});function c(b){return a.apply(this,arguments)}return c}();e.subscribe=function(a){return this.$1.subscribe(a)};e.$4=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=this;if(this.$3.size===0)return{exhausted:!0};var e=[];this.$3.forEach(function(d,f){if(b!=null&&e.length>=b)return;e.push.apply(e,d.splice(-a));d.length===0&&c.$3["delete"](f)});if(d("MAWMpsGating").isFullMpsEnabled()){yield this.$5(e);return{exhausted:this.$3.size===0}}yield this.$6(e);return{exhausted:this.$3.size===0}});function c(b,c){return a.apply(this,arguments)}return c}();e.$7=function(a){var b=this;a.forEach(function(a){var c,d=a.message.threadId;c=(c=b.$3.get(d))!=null?c:[];c.push(a);b.$3.set(d,c)})};e.$5=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=new Map(),f=[];yield (h||(h=b("Promise"))).all(a.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){try{f.push.apply(f,yield d("MpsToUIPostProcessor").mpsToUIEventPostProcessPayload(a))}catch(b){e.set(a.message.messageId,c("getErrorSafe")(b))}});return function(b){return a.apply(this,arguments)}}()));d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:f});a.forEach(function(a){var b=e.get(a.message.messageId);if(b){b=b;c("FBLogger")("mps").catching(b).mustfix("Failed to process payload for UI for thread id = %s , message Id = %s",a.message.threadId,a.message.messageId)}})});function e(b){return a.apply(this,arguments)}return e}();e.$6=function(a){return d("MAWProtocolQueueProcess").processMPSIncomingPayloadEntries(a).then(function(a){a.forEach(function(a,b){c("FBLogger")("mps").catching(a).mustfix("Failed to process payload for MAW for message Id = %s",b)})})["catch"](function(a){c("FBLogger")("mps").catching(a).mustfix("Failed to process payload for MAW")})};e.postProcessMessages=function(a){var e=this;if(d("WAWaitForUserUnblocked").isStillWaitingForUserUnblocked()){this.$7(a);return(h||(h=b("Promise"))).resolve()}if(d("MAWMpsGating").isFullMpsEnabled())return this.$5(a);var f=a.filter(function(a){return a.insertionSource!==d("MpsTypes").InsertionSource.Send});if(f.length===0)return(h||(h=b("Promise"))).resolve();d("MawCopScheduler").copScheduler().runTask({fn:function(){return e.$6(f)},name:"online-message",priority:d("WorkerScheduler").BLOCKING_PRIORITY})["catch"](function(a){c("FBLogger")("cop").catching(a).mustfix("online message processing fails")});return(h||(h=b("Promise"))).resolve()};e.subscribeToOfflineQueue=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"offline-start":d("WAWaitForUserUnblocked").maybeResetWaitForUserUnblocked();break;case"offline-end":b.$1.publish({type:"maw-infra-start"});b.$4(d("MAWMpsGating").isFullMpsEnabled()?c("justknobx")._("4841"):i)["catch"](function(a){c("FBLogger")("cop").catching(a).mustfix("offline-end cop fails")})["finally"](function(){b.$8(),b.$2.startProcessing()});b.$1.publish({success:!0,type:"maw-infra-end"});d("WAWaitForUserUnblocked").unblockUser();break;default:a.type;break}})};e.$8=function(){var a=this;if(this.$9!=null)return;this.$9=d("MawCopScheduler").copScheduler().task({fn:function(){return a.$4(j,k)},name:"background-iterator"});this.$9.run().then(function(b){a.$9=null,b.exhausted===!1&&a.$8()})["catch"](function(b){c("FBLogger")("cop").catching(b).mustfix("Cop fails"),a.$9=null,a.$8()})};return a}(),m;function a(){if(!m){m=new l();return m}return m}g.MpsCop=l;g.mpsCop=a}),98);
__d("MAWSharedRestoreUnavailableMessages",["LSMEBTaskCreationSource","MAWBridgeEventTransmitter","WAGlobals","WAJids","setTimeout"],(function(a,b,c,d,e,f,g){"use strict";var h=1e4,i=new Map();function j(a){if(i.has(a.externalId))return;i.set(a.externalId,!0);c("setTimeout")(function(){var b=a.chat;d("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(a.externalId,d("WAJids").threadIdForChatJid(b),void 0,c("LSMEBTaskCreationSource").EB_POINT_QUERY_RETRY_DECRYPTION_FAILURES,b)},h)}function a(a){a.forEach(function(a){if(a.type!=="message")return;if(a.subtype!=null){if(a.subtype==="unavailable"||a.subtype==="ciphertext"){var b=d("WAJids").extractUserJid(a.from);j({author:d("WAGlobals").getMyUserJid()===b?"@me":b,chat:a.jid,externalId:a.stanzaId})}}else(a.message.decrypted.type==="IncomingCiphertextMsg"||a.message.decrypted.type==="UnavailableMsg")&&j(a.message.decrypted.id)})}g.restoreUnavailableMessages=a}),98);
__d("MAWSharedCOPHandleBatch",["MAWIsQuotaExceededError","MAWSharedCOPLogger","MAWSharedRestoreUnavailableMessages","WALogger","WAProtocolQueue","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n;function o(a,b,c){return p.apply(this,arguments)}function p(){p=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){e=(yield e(a).then(function(a){return[a,null,!1]})["catch"](function(a){if(d("MAWIsQuotaExceededError").isQuotaExceededError(a)){c("MAWSharedCOPLogger").catching(a).MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Quota exceeded while processing stanzas batch."])));return[[],null,!0]}c("MAWSharedCOPLogger").catching(a).MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Runtime error while processing stanzas batch"])));return[[],a instanceof Error?a:c("err")(""+a),!1]}));var f=e[0];e[1];e=e[2];if(e)return{entriesLeft:[],exhausted:!0,handled:0};yield d("WAProtocolQueue").protocolQueue().ack(f)["catch"](function(a){return c("MAWSharedCOPLogger").catching(a).MUSTFIX(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[ackProtocols] Cannot ack from MAWConsumer"])))});if(f.length>=a.length)return{entriesLeft:[],exhausted:!1,handled:f.length};c("MAWSharedCOPLogger").WARN(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Failed processing "," items"])),a.length-f.length);if(b===1){a.length>1&&c("MAWSharedCOPLogger").MUSTFIX(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Received more than 1 entry, despite having limit === 1"])));if(a.length===0)return{entriesLeft:[],exhausted:!1,handled:0};e=a[0];yield d("WAProtocolQueue").protocolQueue()["delete"]([e.stanzaQueueId]);return{entriesLeft:[],exhausted:!1,handled:1}}var g=new Map(a.map(function(a){return[a.stanzaQueueId,a]}));f.forEach(function(a){return g["delete"](a)});return{entriesLeft:Array.from(g.values()),error:!0,exhausted:!1,handled:f.length}});return p.apply(this,arguments)}function a(a,b,c){return q.apply(this,arguments)}function q(){q=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){a=(yield a(b));b.order==="desc"&&(a=a.toReversed());if(a.length===0)return{exhausted:!0,handled:0};c("MAWSharedCOPLogger").DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose([""," stanzas. Config:",""])),a.length,String(b));d("MAWSharedRestoreUnavailableMessages").restoreUnavailableMessages(a);a=(yield o(a,b.limit,e));if(a.error==null)return{exhausted:a.exhausted,handled:a.handled};d("WALogger").LOG(n||(n=babelHelpers.taggedTemplateLiteralLoose(["Linear COP v2"])));b=0;for(var f of a.entriesLeft){var g=(yield o([f],1,e));b+=g.handled;if(g.exhausted)return{exhausted:!0,handled:b+a.handled}}return{exhausted:!1,handled:b+a.handled}});return q.apply(this,arguments)}g.copHandleBatch=a}),98);
__d("MawMpsCopProtocolQueueProcessor",["FBLogger","MAWProtocolQueueProcess","MAWSharedCOPHandleBatch","MawCopScheduler","Promise","WAProtocolQueue","WAWaitForUserUnblocked","WorkerScheduler","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(){function a(){this.$2=c("justknobx")._("2539"),this.$3=null,this.$1()}var e=a.prototype;e.$4=function(){var a=this;if(this.$3!=null)return;this.$3=d("MawCopScheduler").copScheduler().task({fn:function(){return d("WAWaitForUserUnblocked").isStillWaitingForUserUnblocked()?(h||(h=b("Promise"))).resolve({exhausted:!0,handled:0}):d("MAWSharedCOPHandleBatch").copHandleBatch(d("WAProtocolQueue").protocolQueue().index("priority").read,{limit:a.$2,order:"desc"},d("MAWProtocolQueueProcess").processProtocolQueueEntries)},name:"protocol-queue",priority:d("WorkerScheduler").BACKGROUND_PRIORITY});this.$3.run().then(function(b){a.$3=null,b.exhausted===!1&&a.$4()})["catch"](function(b){c("FBLogger")("cop").catching(b).mustfix("ProtocolQueueProcessor fails"),a.$3=null,a.$4()})};e.startProcessing=function(){this.$4()};e.$1=function(){var a=this;d("WAProtocolQueue").protocolQueue().subscribe(function(b){switch(b.type){case"flush":if(d("WAWaitForUserUnblocked").isStillWaitingForUserUnblocked())return;a.startProcessing();return}})};return a}();g.ProtocolQueueProcessor=a}),98);
__d("MAWSharedOfflineQueueMetric",["$InternalEnum","MAWMpsGating","MWFBLogger","MawMpsCop","WAGlobals","WAPREList","WATimeUtils","WAWaterFlow"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=d("MWFBLogger").MWLogger.tags(["offline-resume"]);e=b("$InternalEnum").Mirrored(["OFFLINE","ONLINE"]);var m=b("$InternalEnum").Mirrored(["WA_CLIENT_INFRA","WA_CLIENT_INFRA_DUPLICATED_START","WA_PASSIVE_MODE","WA_PASSIVE_MODE_FAIL","MAW_INFRA","MAW_STUCK","WA_STUCK","MAW_NOT_IDLE_OQ"]),n=function(){function a(a,b,c,e){this.$1=0,this.$3=e,this.$2=d("WAWaterFlow").makeWaterflow("offline-resume",d("WAPREList").PRE_METRIC.OFFLINE_QUEUE),this.$6(a),this.$7(),this.$8(b),this.$9(c),this.$4=Math.round(d("WATimeUtils").performanceAbsoluteNow()/1e3)}var b=a.prototype;b.$8=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"passive-mode-start":b.$2.isOnGoing()||b.$2.startMetric();b.$2.startPoint(m.WA_PASSIVE_MODE,{passiveModeAcks:a.count});b.$10("wa");break;case"passive-mode-end":b.$2.endPoint(m.WA_PASSIVE_MODE);b.$10("wa");break;default:a.type,b.$2.addPoint(m.WA_PASSIVE_MODE_FAIL),b.$10("wa")}})};b.$9=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"new-message":if(a.commonMessageBase.offline==null)return;b.addWAMessage();b.$10("wa");break}})};b.$6=function(a){var b=this;a.subscribe(function(a){switch(a.type){case"offline-start":b.$11(a.offlineStats);b.$10("wa");break;case"offline-end":b.$2.isOnGoing()&&(b.$2.endPoint(m.WA_CLIENT_INFRA),b.$10("maw"));break;case"offline-entity":b.$12(a.serverTs,a.offline);b.$10("wa");break;case"offline-processed":b.$13(a.count);b.$10("wa");break;case"connection-lost":b.$2.isOnGoing()&&b.$2.endFail("connection-lost",{isConnectionLost:!0});b.$14();break;default:a}})};b.$10=function(a){var b=this;clearTimeout(this.$5);this.$2.isOnGoing()&&(this.$5=setTimeout(function(){b.$2.isOnGoing()&&(a==="wa"?b.$2.addPoint(m.WA_STUCK,{waStuck:!0}):b.$2.addPoint(m.MAW_STUCK,{mawStuck:!0}),l.WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Possible stuck reason: ",""])),a))},d("WAGlobals").getConfig().offlineQueueStuckTimeoutMs()))};b.$14=function(){clearTimeout(this.$5)};b.$7=function(){var a=this;d("MawMpsCop").mpsCop().subscribe(function(b){a.$15(b)});this.$3&&this.$3.subscribe(function(b){a.$15(b)})};b.$15=function(a){switch(a.type){case"maw-infra-start":if(!this.$2.isOnGoing())break;this.$10("maw");this.$2.startPoint(m.MAW_INFRA);break;case"maw-infra-end":if(!this.$2.isOnGoing())break;this.$2.endPoint(m.MAW_INFRA);this.$14();a.success?this.$2.endSuccess():this.$2.endFail("fail");break;default:a}};b.addWAMessage=function(){this.$2.isOnGoing()&&(this.$2.reAnnotate(function(a){a=a.waMessage;return{waMessage:(a!=null?a:0)+1}}),this.$10("wa"))};b.addMAWEntity=function(a){this.$2.isOnGoing()&&(this.$2.reAnnotate(function(b){b=b.mawProcessedCount;return{mawProcessedCount:(b!=null?b:0)+a}}),this.$10("maw"))};b.$11=function(a){this.$2.isOnGoing()?this.$2.addPoint(m.WA_CLIENT_INFRA_DUPLICATED_START):(this.$1++,this.$2.startMetric(),this.$4=Math.round(d("WATimeUtils").performanceAbsoluteNow()/1e3)),this.$2.startPoint(m.WA_CLIENT_INFRA,{expectedAppdata:a.appdata,expectedCount:a.count,expectedMessage:a.message,expectedNotification:a.notification,expectedReceipt:a.receipt,mpsStatus:this.$16(),offlineResumeCount:this.$1,waDanglingQueue:d("WAGlobals").getConfig().waDanglingQueue()})};b.$16=function(){return d("MAWMpsGating").isFullMpsEnabled()?"full":"mps"};b.getDetails=function(){var a;return((a=this.$2)==null?void 0:a.getAnnotations())||{}};b.$13=function(a){var b;(b=this.$2)==null||b.reAnnotate(function(b){return{waProcessed:((b=b.waProcessed)!=null?b:0)+a}})};b.addRuntimeErrorDuringOffflineQueue=function(){if(this.$2.isOnGoing()){var a;(a=this.$2)==null||a.reAnnotate(function(a){return{runtimeErrors:((a=a.runtimeErrors)!=null?a:0)+1}})}};b.addDecryptionError=function(){if(this.$2.isOnGoing()){var a;(a=this.$2)==null||a.reAnnotate(function(a){return{decryptErrors:((a=a.decryptErrors)!=null?a:0)+1}})}};b.addRetriesTrack=function(a){if(this.$2.isOnGoing()){var b;(b=this.$2)==null||b.reAnnotate(function(b){return{retries:((b=b.retries)!=null?b:0)+a}})}};b.$12=function(a,b){var c=this;if(!this.$2.isOnGoing()){l.WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Waterflow should start before the start of the processing"])));return}this.$2.reAnnotate(function(d){var e=d.mailboxAgeSec,f=d.maxOffline;d=d.waDownloaded;e=e;e==null&&a!=null&&(e=c.$4-a,l.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["New mailbox age is ",""])),e));e!=null&&a!=null&&(c.$4-a>e&&(e=c.$4-a,l.DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["New mailbox age is ",""])),e)));return{mailboxAgeSec:e,maxOffline:Math.max(f!=null?f:0,b),waDownloaded:(d!=null?d:0)+1}})};return a}(),o;function a(a,b,c,d){if(o!=null){var e=o;l.mustfix("Offline sync reported is inited twice");return e}o=new n(a,b,c,d);return o}function c(){if(o==null){l.mustfix("Offline sync reported is not inited");return null}return o}g.OfflineMode=e;g.OfflineStages=m;g.makeOfflineQueueMetric=a;g.getOfflineQueueMetric=c}),98);
__d("SendMsgArgsToProtobuf",["FBLogger","MAWAsConsumerApplication","MAWMsgType","MAWParseSubprotocolVersionConsts","WAArmadilloApplication.pb","WAConsumerApplication.pb","WAFranking","WAGlobals","WAJids","WAMsgApplication.pb","encodeMAWDocumentFileMessage","encodeProtobuf","nullthrows","qex"],(function(a,b,c,d,e,f,g){"use strict";function h(a){switch(a){case d("MAWMsgType").MSG_TYPE.IMAGE:return d("MAWAsConsumerApplication").encodeValidatedImageMessage;case d("MAWMsgType").MSG_TYPE.VIDEO:case d("MAWMsgType").MSG_TYPE.GIF:return d("MAWAsConsumerApplication").encodeValidatedVideoMessage;case d("MAWMsgType").MSG_TYPE.PTT:return d("MAWAsConsumerApplication").encodeValidatedAudioMessage;case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return d("encodeMAWDocumentFileMessage").encodeValidatedFileMessage;case d("MAWMsgType").MSG_TYPE.STICKER:return d("MAWAsConsumerApplication").encodeValidatedStickerMessage}return null}function i(a,b,e){var f=null,g=null,h=null,i=null;if(b.associatedMsgSendArgs!=null){e=d("encodeProtobuf").encodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,c("nullthrows")(m(d("MAWMsgType").MSG_TYPE.TEXT,b.associatedMsgSendArgs,e)));f={payload:e.readBuffer(),version:d("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION}}e=j(b.faviconMetadata,a.accessibilityLabel);e!=null&&(g={payload:e,version:d("MAWParseSubprotocolVersionConsts").XMA_FAVICON_SUBPROTOCOL_VERSION});e=j(b.headerMetadata,a.accessibilityLabel);e!=null&&(h={payload:e,version:d("MAWParseSubprotocolVersionConsts").XMA_HEADER_SUBPROTOCOL_VERSION});e=j(b.previewMetadata,a.accessibilityLabel);e!=null&&(i={payload:e,version:d("MAWParseSubprotocolVersionConsts").XMA_PREVIEW_SUBPROTOCOL_VERSION});e=b.xmaArgs;return{payload:{content:{extendedContentMessage:{associatedMessage:f,commands:a.commands,contentRef:e.contentRef,ctas:e.defaultCTA==null?void 0:[e.defaultCTA].concat(e.ctas).filter(Boolean),favicon:g,headerImage:h,headerTitle:e.headerTitle,maxSubtitleNumOfLines:e.maxSubtitleNumOfLines,maxTitleNumOfLines:e.maxTitleNumOfLines,mentionedJid:a.mentionedJids,messageText:a.content,overlayDescription:e.overlayDescription,overlayIconGlyph:e.overlayIconGlyph,overlayTitle:e.overlayTitle,previews:i?[i]:void 0,sentWithMessageId:f?b.xmaMsgExternalId:void 0,subtitleText:e.subtitleText,targetExpiringAtSec:e.targetExpiringAtSec,targetId:e.targetId,targetType:a.xmaMessageType,targetUsername:e.targetUsername,titleText:e.titleText,xmaLayoutType:e.xmaLayoutType}}}}}function j(a,b){return a==null?null:d("MAWAsConsumerApplication").encodeValidatedMediaToImageTransport(babelHelpers["extends"]({accessibilitySummaryText:b,mediaType:a.mediaType,size:a.file.size},a.mediaInfo),a.mediaEntry)}function k(a,b){var e;switch(a){case d("MAWMsgType").MSG_TYPE.TEXT:return{metadata:d("MAWAsConsumerApplication").encodeConsumerApplicationMetadata(b.specialTextSize),payload:{content:{messageText:{commands:b.commands,mentionedJid:b.mentionedJids,text:(e=b.content)!=null?e:""}}}};case d("MAWMsgType").MSG_TYPE.EDIT_ACTION:e=b;return{payload:{content:{editMessage:{key:{fromMe:!0,id:e.originalProtocolMsgId.externalId,remoteJid:e.originalProtocolMsgId.author},message:{commands:e.editMsgContent.commands,mentionedJid:e.editMsgContent.mentionedJids,text:e.editMsgContent.content},timestampMs:Date.now()}}}};case d("MAWMsgType").MSG_TYPE.REACTION:e=b;return{payload:{content:{reactionMessage:{groupingKey:e.groupingKey,key:{fromMe:!0,id:e.reactToProtocolMsgId.externalId,remoteJid:e.reactToProtocolMsgId.author},senderTimestampMs:Date.now(),text:e.reaction}}}};case d("MAWMsgType").MSG_TYPE.REVOKED:e=b;return{payload:{applicationData:{revoke:{key:{fromMe:!0,id:e.msgId.externalId}}}}};case d("MAWMsgType").MSG_TYPE.VIDEO:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.PTT:case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.IMAGE:e=c("nullthrows")(h(a));var f=b;return e(babelHelpers["extends"]({accessibilitySummaryText:b.accessibilityLabel,mediaType:a,size:f.fileSize},f.mediaInfo),f.mediaEntry);default:return null}}function l(a,b,e,f){switch(a){case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:a=b.quote;if(a==null){c("FBLogger")("mps").mustfix("bumps should always have quotes!");return null}var g=d("WAJids").isAuthorMe(a.author)||a.author===d("WAGlobals").getMyUserJid();return{payload:{content:{bumpExistingMessage:{key:{fromMe:g,id:a.externalId,participant:g?null:a.author,remoteJid:e}}}}};case d("MAWMsgType").MSG_TYPE.XMA:return!f?null:i(b,f,e);default:return null}}function m(a,b,e,f){var g;switch(a){case d("MAWMsgType").MSG_TYPE.TEXT:case d("MAWMsgType").MSG_TYPE.EDIT_ACTION:case d("MAWMsgType").MSG_TYPE.REACTION:case d("MAWMsgType").MSG_TYPE.IMAGE:case d("MAWMsgType").MSG_TYPE.VIDEO:case d("MAWMsgType").MSG_TYPE.PTT:case d("MAWMsgType").MSG_TYPE.GIF:case d("MAWMsgType").MSG_TYPE.STICKER:case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:case d("MAWMsgType").MSG_TYPE.REVOKED:var h=d("encodeProtobuf").encodeProtobuf(d("WAConsumerApplication.pb").ConsumerApplicationSpec,c("nullthrows")(k(a,b))).readBuffer();g={consumerMessage:{payload:h,version:1}};break;case d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:case d("MAWMsgType").MSG_TYPE.XMA:if(a===d("MAWMsgType").MSG_TYPE.XMA&&c("qex")._("310")!==!0)break;h=d("encodeProtobuf").encodeProtobuf(d("WAArmadilloApplication.pb").ArmadilloSpec,c("nullthrows")(l(a,b,e,f))).readBuffer();g={armadillo:{payload:h,version:1}};break}g=c("nullthrows")(g,"Unsupported message type");a=b.ephemeralSetting;e=b.forwardingScore;f=b.isForwarded;h=b.mediaGroupMetadata;var i=b.quote;a={metadata:babelHelpers["extends"]({chatEphemeralSetting:a&&{ephemeralExpiration:a.ephemeralExpirationInSec,ephemeralSettingTimestamp:a.ephemeralLastUpdatedOrSetTimestamp*1e3},forwardingScore:e!=null?e:0,frankingKey:d("WAFranking").createFrankingKey(),frankingVersion:d("WAFranking").getFrankingVersion()},h,{groupId:(a=b.mediaGroupMetadata)==null?void 0:a.groupId,groupIndex:(e=b.mediaGroupMetadata)==null?void 0:e.groupIndex,groupSize:(h=b.mediaGroupMetadata)==null?void 0:h.groupSize,isForwarded:f,quotedMessage:i&&{participant:i.author===d("WAJids").AUTHOR_ME?d("WAGlobals").getMyUserJid():i.author,stanzaId:i.externalId}}),payload:{subProtocol:g}};return a}g.createMessageApplication=m}),98);
__d("MAWTSUtils",["WATimeUtils","justknobx"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return!c("justknobx")._("2554")?null:a!=null?d("WATimeUtils").castToUnixTime(Math.floor(a/1e3)):a}g.gatedLSOptimisticTsToMaybeUnixTime=a}),98);
__d("MAWStateManagerSyncToMainThread",["FBLogger","MAWBridge","WACommsConnectionState"],(function(a,b,c,d,e,f,g){"use strict";var h={WACommsConnectionState:d("WACommsConnectionState").WACommsConnectionState};function a(){var a=function(a){var b=h[a];i(a,b.get());b.onSet(function(b){i(a,b)})};for(var b of Object.keys(h))a(b)}function b(a,b){var d=h[a];if(d==null){c("FBLogger")("messenger_e2ee_web").warn("Unable to find GenericStateManager for key %s",a);return}d.set(b)}function e(){for(var a of Object.keys(h)){var b=h[a];i(a,b.get())}}function i(a,b){d("MAWBridge").getBridge().fireAndForget("event","updateStateManagerStateInMainThread",{stateManagerKey:a,value:b})}g.subscribeAndSyncStateManagerValuesToMainThread=a;g.updateStateManagerInMainThreadFromBridgeCall=b;g.resendCurrentValuesToMainThread=e}),98);
__d("WAFrameSocket",["WABinary","WAErrors","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m=function(b){function a(a){var c="SocketClosed";a=b.call(this,a!=null?a:c)||this;a.name=c;return a}babelHelpers.inheritsLoose(a,b);var c=a.prototype;c.toString=function(){return this.name};return a}(babelHelpers.wrapNativeSuper(Error));a=function(){function a(a,b){var c=this;this.$3=new(d("WABinary").Binary)();this.closed=!1;this.$4=!1;this.onFrame=null;this.onClose=null;this.$5=function(a){c.$3.writeByteArray(a),c.convertBufferedToFrames()};this.$6=function(){if(c.$3.peek(n)){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["FrameSocket closed, waiting for pending processing"])));c.$4=!0;return}c.$9()};this.$7=function(a){d("WALogger").DEV(i||(i=babelHelpers.taggedTemplateLiteralLoose(["FrameSocket error"]))).devConsole(a)};this.$2=b;this.$1=a;a.onData=this.$5;a.onClose=this.$6;a.onError=this.$7}var b=a.prototype;b.sendFrame=function(a){if(this.$4)return;this.throwIfClosed();var b=this.$2,c=a.byteLength;this.$8(c);var d=this.$1.dataToSend;b?(this.$2=null,d.ensureAdditionalCapacity(b.length+3+c),d.writeByteArray(b)):d.ensureAdditionalCapacity(3+c);d.writeUint8(c>>16);d.writeUint16(c&65535);d.write(a);this.$1.requestSend()};b.$9=function(){if(this.closed)return;d("WALogger").LOG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["FrameSocket closed"])));this.$4=!1;this.closed=!0;var a=this.onClose;a&&a()};b.$8=function(a){if(a>=1<<24){d("WALogger").WARN(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Buffer to send: ",""])),a);throw new(d("WAErrors").BufferTooLargeError)("Buffer too large: "+a)}};b.convertBufferedToFrames=function(){var a=this.$3,b=this.onFrame;while(b&&a.peek(n)){var c=o(a);c=a.readByteArrayView(c);b(c);b=this.onFrame}this.$4&&!a.peek(n)&&this.$9();b&&a.size()&&d("WALogger").LOG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["FrameSocket: queueing partial frame of "," bytes"])),a.size())};b.throwIfClosed=function(){if(this.closed)throw new m()};b.close=function(){this.$1.close()};return a}();function n(a){if(a.size()<3)return!1;var b=o(a);return b<=a.size()}function o(a){return a.readUint8()<<16|a.readUint16()}g.SocketClosed=m;g.FrameSocket=a}),98);
__d("WANoiseSocket",["Promise","WACryptoDependencies","WALogger","WAPromiseQueue","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;a=(k||(k=b("Promise"))).reject("UNINITIALIZED HANDSHAKE");var l=new Uint8Array(0);a["catch"](function(){});c=function(){function a(a,b,c){var e=this;this.$4=[];this.$5=new(d("WAPromiseQueue").PromiseQueue)();this.$6=new(d("WAPromiseQueue").PromiseQueue)();this.$7=0;this.$8=0;this.$9=!1;this.$14=function(a){!e.$1.closed?(d("WALogger").DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Sending encrypted frame to web socket"]))).tags("WANoiseSocket"),e.$1.sendFrame(a)):d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["NoiseSocket socket closed while encrypting frame"])))};this.$12=function(a){var b=e.$7++;e.$5.enqueueHandlers(o(e.$2,b,void 0,a),e.$15)};this.$13=function(){e.$9=!0,e.$5.wait().then(function(){e.$9=!1;var a=e.$11;a&&a()})};this.$15=function(a){e.$10?e.$10(a):e.$4.push(a)};this.$1=a;this.$3=b;this.$2=c;a.onFrame=this.$12;this.$1.onClose=this.$13;a.convertBufferedToFrames()}var c=a.prototype;c.sendFrameAsync=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=(yield this.sendFrame(a));return a});function c(b){return a.apply(this,arguments)}return c}();c.sendFrame=function(a){if(this.$9)return(k||(k=b("Promise"))).resolve();this.$1.throwIfClosed();var c=this.$8++;d("WALogger").DEV(j||(j=babelHelpers.taggedTemplateLiteralLoose(["sendFrame adding to queue with frame size: "," bytes"])),a.length).tags("WANoiseSocket");return this.$6.enqueueHandlers(n(this.$3,c,void 0,a),this.$14)};c.setOnFrame=function(a){this.$10=a};c.setOnClose=function(a){this.$11=a};c.close=function(){this.$1.close()};return a}();function m(a){var b=new ArrayBuffer(12),c=new DataView(b);c.setUint32(8,a);return new Uint8Array(b)}function n(a,b,c,e){return d("WACryptoDependencies").getCrypto().subtle.encrypt({name:"AES-GCM",iv:m(b),additionalData:c?new Uint8Array(c):l},a,e)}function o(a,b,c,e){return d("WACryptoDependencies").getCrypto().subtle.decrypt({name:"AES-GCM",iv:m(b),additionalData:c?new Uint8Array(c):l},a,e)}g.NoiseSocket=c}),98);
__d("WAClearSignalStores",["MAWDexieTable","MAWTransactionMode","WADbTransactor"],(function(a,b,c,d,e,f,g){"use strict";a=d("WADbTransactor").makeSignalTransactor({tasks:d("MAWTransactionMode").READWRITE},"clearSignalStores",function(a){return function(){return d("MAWDexieTable").dexieAll([a.tasks.clear()]).then(function(){})}});g.clearSignalStores=a}),98);
__d("WAClearSignalStoresV2",["Promise","WASignalDB","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(){return d("WASignalDB").getDb().runInTransaction(["identity","contacts","meta","prekey","prekeyGeneration","senderKeySessions","session","signedPrekey","personalSenderKeyStatuses"],"readwrite",function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){yield (h||(h=b("Promise"))).all([a.stores.identity.clear(),a.stores.contacts.clear(),a.stores.meta.clear(),a.stores.prekey.clear(),a.stores.prekeyGeneration.clear(),a.stores.senderKeySessions.clear(),a.stores.session.clear(),a.stores.signedPrekey.clear(),a.stores.personalSenderKeyStatuses.clear()])});return function(b){return a.apply(this,arguments)}}(),d("WASignalDB").signalOp("clearSignalStores"))};g.clearSignalStores=a}),98);
__d("MAWClearSignalAndTempStores",["MAWDeleteOldLogsFromDisk","MAWJobActionsV2","MAWJobsIndexedDb","MAWLoggingSwitches","MAWTransactionMode","Promise","WAClearSignalStores","WAClearSignalStoresV2","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h,i=d("MAWJobsIndexedDb").makeJobsTransactor("jobs",d("MAWTransactionMode").READWRITE,"clearJob")(d("MAWJobActionsV2").clearJobs);a=function(){return(h||(h=b("Promise"))).all([d("MAWLoggingSwitches").removeLoggingFromBridge&&d("MAWDeleteOldLogsFromDisk").clearLogs(),d("WAClearSignalStores").clearSignalStores(),i(),d("WAClearSignalStoresV2").clearSignalStores()]).then(c("emptyFunction"))};g.clearSignalAndTempStores=a}),98);
__d("WAMockServerShell",["cr:8600"],(function(a,b,c,d,e,f,g){"use strict";a=b("cr:8600")!=null;g.isMockServerMode=a;g.getMockServer=b("cr:8600")}),98);
__d("MAWDbGetDeviceChangeAlertsTxn",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){return a.deviceChangeAlerts.get(b)}f.getDeviceChangeAlertsTxn=a}),66);
__d("WADevToolsDebugFns",["WADevToolsBridge"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b={};for(var c in a){var e=a[c];b[c]={id:c,args:e.serializedArgs,desc:e.desc,title:e.name}}d("WADevToolsBridge").getDevToolBridge().setHandlers("backend",{getDebugFns:function(){return b},callDebugFn:function(b){var c=b.id;b=b.args;(c=a[c]).execute.apply(c,b)}})}function b(a,b){return babelHelpers["extends"]({name:a},b)}g.registerDebugFnsToDevTool=a;g.defineDebugFunction=b}),98);
__d("MAWDebugSendMultipleMsgs",["MAWBridge","MAWExternalId","MAWLoggerUtils","Promise","WADevToolsDebugFns","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h;a=d("WADevToolsDebugFns").defineDebugFunction("sendMultipleMsgs",{desc:"Sends multiple messages to a thread",execute:function(a,e){return(h||(h=b("Promise"))).all(Array.from(Array(e).keys()).map(function(b){return d("MAWBridge").getBridge().sendAndReceive("backend","sendMsg",{args:{content:b+" message"},chatJid:a,externalId:d("MAWExternalId").generateExternalId(),qplEventType:c("qpl")._(25313175,"1551"),qplInstanceKey:d("MAWLoggerUtils").getInstanceKey()})}))},serializedArgs:[{desc:"ChatJid of the thread to send messages to",name:"chatJid",placeholder:"1234@msgr",type:"string"},{desc:"Number of messages to send",name:"numberOfMsgs",placeholder:"100",type:"number"}]});g.sendMultipleMsgs=a}),98);
__d("MAWSendSenderKeyDistributionMsg",["MAWDebugMsg","MAWMsgType","MAWSendWrittenMsg","MAWWriteOutgoingMsgApi","Promise","WAQPLProxy","WAResultOrError","WATimeUtils","asyncToGeneratorRuntime","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i=new Set();function a(a,b,c){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f){if(i.has(a))return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult());yield d("MAWDebugMsg").writeDebugMsg(a,"Sending key distribution msg");e=(yield d("MAWWriteOutgoingMsgApi").writeOutgoingMsg(e,a,d("WATimeUtils").unixTime(),{},d("MAWMsgType").MSG_TYPE.SK_DISTRIBUTION,c("qpl")._(25313175,"1551"),f));if(e.type==="already_sent")return d("WAResultOrError").makeError("already_sent");else if(e.type==="missing_thread")return d("WAResultOrError").makeError("missing_thread");yield d("MAWSendWrittenMsg").sendWrittenMsgExternal({protocolMsgId:e.protocolMsgId,type:"message"},d("WAQPLProxy").waQPLProxyStartResume(c("qpl")._(25313175,"1551"),f),"MAWSendSenderKeyDistributionMsg");return d("WAResultOrError").makeResult()});return j.apply(this,arguments)}g.sendSenderKeyDistributionMsg=a}),98);
__d("WAIndexDBStorage",["Promise","err"],(function(a,b,c,d,e,f,g){var h,i="idb-storage-testing-db",j="idb-storage-testing-store";function a(){return new(h||(h=b("Promise")))(function(a,b){var c=indexedDB.open(i);c.onerror=function(a){b(a.target.error)};c.onupgradeneeded=function(a){a=a.target.result;a.createObjectStore(j)};c.onsuccess=function(b){b=b.target.result;a(b)}})}function d(a){var c=a.idb,d=a.fileBuffer,e=a.key;return new(h||(h=b("Promise")))(function(a,b){var f=c.transaction([j],"readwrite");f.oncomplete=function(){a()};f.onerror=function(a){b(a.target.error)};f.onabort=function(a){b(a.target.error)};f=f.objectStore(j);f=f.put(d,e);f.onerror=function(a){b(a.target.error)};f.onsuccess=function(){a()}})}function e(a){var d=a.idb,e=a.key;return new(h||(h=b("Promise")))(function(a,b){var f=d.transaction([j],"readonly");f.onerror=function(a){b(a.target.error)};f.onabort=function(a){b(a.target.error)};f=f.objectStore(j);var g=f.get(e);g.onerror=function(a){b(a.target.error)};g.onsuccess=function(){if(!(g.result instanceof ArrayBuffer)){b(c("err")("Result is not an ArrayBuffer"));return}a(g.result)}})}function f(a){var c=a.idb;return new(h||(h=b("Promise")))(function(a,b){var d=c.transaction([j],"readwrite");d.oncomplete=function(){a()};d.onerror=function(a){b(a.target.error)};d.onabort=function(a){b(a.target.error)};d=d.objectStore(j);d=d.clear();d.onerror=function(a){b(a.target.error)};d.onsuccess=function(){a()}})}function k(a){a=a.idb;a.close();indexedDB.deleteDatabase(i)}g.prepareIDB=a;g.writeToIDB=d;g.readFromIDB=e;g.cleanupIDB=f;g.deleteIdb=k}),98);
__d("WAOpfsSyncStorage",["Promise","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f){"use strict";var g,h="opfs-storage-testing-filesystem";function a(){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a;if((navigator==null||(a=navigator.storage)==null?void 0:a.getDirectory)==null)return(g||(g=b("Promise"))).reject("OPFS is not supported");var c=(yield navigator.storage.getDirectory());c=(yield c.getDirectoryHandle(h,{create:!0}));return c});return i.apply(this,arguments)}function c(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.directoryHandle,c=a.fileBuffer;a=a.fileName;b=(yield b.getFileHandle(a,{create:!0}));a=(yield b.createSyncAccessHandle());b=new DataView(c);a.write(b,{at:0});return a.close()});return j.apply(this,arguments)}function d(a){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.directoryHandle;a=a.fileName;b=(yield b.getFileHandle(a));a=(yield b.createSyncAccessHandle());b=a.getSize();b=new ArrayBuffer(b);var c=new DataView(b);yield a.read(c,{at:0});a.close();return b});return k.apply(this,arguments)}function e(a){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c,d=a.directoryHandle;a=a.fileName;if((navigator==null||(c=navigator.storage)==null?void 0:c.getDirectory)==null)return(g||(g=b("Promise"))).reject("OPFS is not supported");yield d.removeEntry(a)});return l.apply(this,arguments)}f.prepareFileSystem=a;f.writeToFileSystem=c;f.readFromFileSystem=d;f.cleanupFileSystem=e}),66);
__d("WATestBenchmark",["asyncToGeneratorRuntime"],(function(a,b,c,d,e,f){var g=function(){return performance.now()};function a(a,b,c){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,d){var e={},f=[],h=function(){var d=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b,d){f.push(b);e[b]=[];for(var h=0;h<a;h++){var i=g();for(var j=0;j<c;j++)yield d(h,j);j=g();e[b].push((j-i)/c)}});return function(a,b){return d.apply(this,arguments)}}();yield d(h);return f.map(function(a){var b=e[a].sort(function(a,b){return a-b}),c=b.length;return{name:a,min:b[0],p50:b[Math.floor(c/2)],avg:b.reduce(function(a,b){return a+b},0)/c}})});return h.apply(this,arguments)}function i(a){if(a<1){var b=Math.round(a*1e4);return b+"\u03bcs"}b=Math.round(a);return b+"ms"}function c(a,b){b.forEach(function(b){var c=b.name,d=b.min,e=b.avg;b=b.p50;a("["+c+"] min: "+i(d)+", avg: "+i(e)+", p50: "+i(b))})}function d(a,b){var c="\n";b.forEach(function(a){var b=a.name,d=a.min,e=a.avg;a=a.p50;c+=b+","+Math.round(d)+","+Math.round(e)+","+Math.round(a)+"\n"});a(c)}f.createBenchmark=a;f.printReport=c;f.printAsCSVInMS=d}),66);
__d("WAWebCacheStorage",["asyncToGeneratorRuntime"],(function(a,b,c,d,e,f){var g="web-cache-storage-testing";function a(){return caches.open(g)}function c(a){var b=a.cache,c=a.fileBuffer;a=a.key;c=new Response(c);return b.put(a,c)}function d(a){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.cache;a=a.key;b=(yield b.match(a));return b.arrayBuffer()});return h.apply(this,arguments)}function e(){return caches["delete"](g).then(function(){})}f.prepareCache=a;f.writeToCache=c;f.readFromCache=d;f.cleanupCache=e}),66);
__d("WARunStorageBenchmark",["Promise","WAIndexDBStorage","WAOpfsSyncStorage","WATestBenchmark","WAWebCacheStorage","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e,f,g){var i=1024*e;i=new Blob([new Uint8Array(i).fill(255)]);var j=(yield i.arrayBuffer());a("datapoints: "+f+" repetitions: "+g+" blob size: "+e+"KB");var k=(yield d("WAIndexDBStorage").prepareIDB());yield d("WAIndexDBStorage").cleanupIDB({idb:k});yield d("WAWebCacheStorage").cleanupCache();var l=(yield d("WAWebCacheStorage").prepareCache()),m=(yield d("WAOpfsSyncStorage").prepareFileSystem());a("start write benchmark...");i=(yield d("WATestBenchmark").createBenchmark(f,g,function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){yield a("IndexedDB write",function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){yield d("WAIndexDBStorage").writeToIDB({idb:k,fileBuffer:yield j,key:a+"_"+b})});return function(b,c){return a.apply(this,arguments)}}()),yield a("Web Cache write",function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){yield d("WAWebCacheStorage").writeToCache({cache:l,fileBuffer:j,key:a+"_"+b})});return function(b,c){return a.apply(this,arguments)}}()),yield a("OPFS Sync write",function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){yield d("WAOpfsSyncStorage").writeToFileSystem({directoryHandle:m,fileBuffer:j,fileName:a+"_"+b})});return function(b,c){return a.apply(this,arguments)}}())});return function(b){return a.apply(this,arguments)}}()));a("end write benchmark...");c?d("WATestBenchmark").printAsCSVInMS(a,i):d("WATestBenchmark").printReport(a,i);a("start read benchmark...");e=(yield d("WATestBenchmark").createBenchmark(f,g,function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c;yield a("IndexedDB read",function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){c=(yield d("WAIndexDBStorage").readFromIDB({idb:k,key:a+"_"+b}))});return function(b,c){return a.apply(this,arguments)}}());var e;yield a("Web Cache read",function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){e=(yield d("WAWebCacheStorage").readFromCache({cache:l,key:a+"_"+b}))});return function(b,c){return a.apply(this,arguments)}}());var f;yield a("OPFS Sync read",function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){f=(yield d("WAOpfsSyncStorage").readFromFileSystem({directoryHandle:m,fileName:a+"_"+b})),yield d("WAOpfsSyncStorage").cleanupFileSystem({directoryHandle:m,fileName:a+"_"+b})});return function(b,c){return a.apply(this,arguments)}}());if(c instanceof ArrayBuffer&&e instanceof ArrayBuffer&&f instanceof ArrayBuffer)return;return(h||(h=b("Promise"))).reject("read result is not ArrayBuffer")});return function(b){return a.apply(this,arguments)}}()));a("end read benchmark...");c?d("WATestBenchmark").printAsCSVInMS(a,e):d("WATestBenchmark").printReport(a,e)});return function(b,c,d,e,f){return a.apply(this,arguments)}}();g.runStorageBenchmark=a}),98);
__d("WormDbDebuggingUtils",["WAJids","WASignalDB","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield d("WASignalDB").getDbPromise());return a.runInTransaction(["identity"],"readonly",function(a){return a.stores.identity.readAll()},"debug-get-identities")});return i.apply(this,arguments)}function j(){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield d("WASignalDB").getDbPromise());return a.runInTransaction(["contacts"],"readonly",function(a){return a.stores.contacts.readAll()},"debug-get-contacts")});return k.apply(this,arguments)}function l(){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield d("WASignalDB").getDbPromise());return a.runInTransaction(["session"],"readonly",function(a){return a.stores.session.readAll()},"debug-get-sessions")});return m.apply(this,arguments)}function n(){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield d("WASignalDB").getDbPromise());return a.runInTransaction(["senderKeySessions"],"readonly",function(a){return a.stores.senderKeySessions.readAll()},"debug-get-sender-key-sessions")});return o.apply(this,arguments)}function a(){return p.apply(this,arguments)}function p(){p=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield d("WASignalDB").getDbPromise());return a.runInTransaction(["prekey"],"readonly",function(a){return a.stores.prekey.readAll()},"debug-get-prekeys")});return p.apply(this,arguments)}function c(){return q.apply(this,arguments)}function q(){q=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield d("WASignalDB").getDbPromise());return a.runInTransaction(["prekeyGeneration"],"readonly",function(a){return a.stores.prekeyGeneration.readAll()},"debug-get-prekey-generations")});return q.apply(this,arguments)}function e(){return r.apply(this,arguments)}function r(){r=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield d("WASignalDB").getDbPromise());return a.runInTransaction(["signedPrekey"],"readonly",function(a){return a.stores.signedPrekey.readAll()},"debug-get-signed-prekeys")});return r.apply(this,arguments)}function f(){return s.apply(this,arguments)}function s(){s=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield d("WASignalDB").getDbPromise());return a.runInTransaction(["meta"],"readonly",function(a){return a.stores.meta.readAll()},"debug-get-meta-rows")});return s.apply(this,arguments)}function t(a){return h().then(function(b){return b.filter(function(b){return b.userJid===a})})}function u(a){return j().then(function(b){return b.find(function(b){return b.contactJid===a})})}function v(a){return l().then(function(b){return b.filter(function(b){return d("WAJids").extractUserJid(b.id)===a})})}function w(a){return n().then(function(b){return b.filter(function(b){return b.userJid===a})})}g.getIdentities=h;g.getContacts=j;g.getSessions=l;g.getSenderKeySessions=n;g.getPrekeys=a;g.getPrekeyGenerations=c;g.getSignedPrekeys=e;g.getMetaRows=f;g.getIdentitiesForUser=t;g.getContact=u;g.getSessionsForUser=v;g.getSenderKeySessionsForUser=w}),98);
__d("MAWDebug",["BlobStorageApi","EBDBConsistencyApi","EBDeps","EBLS","EBWorkerEBDBApi","EBWorkerEBSMStateUtils","ExecutionEnvironment","FBLogger","LSMEBTaskCreationSource","MAWAdminWriteCutoverThreadMsgTxn","MAWArmadilloPollTableSchema.pb","MAWBackend","MAWBridge","MAWBulkHandleIncomingMsgApi","MAWCacheServiceDB","MAWConfig","MAWCurrentUser","MAWDbAddDeviceChangeAlertsTxn","MAWDbAppDataTxns","MAWDbChunkTxns","MAWDbDeviceChangeAlerts","MAWDbEditMsgHistoryTxns","MAWDbGetDeviceChangeAlertsByOptionsTxn","MAWDbGetDeviceChangeAlertsTxn","MAWDbGetUnArchivedDeviceChangeAlertsCountTxn","MAWDbGroupInfoTxns","MAWDbGroupInviteTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbMsgTypeVersionTxns","MAWDbObjDecode","MAWDbObjEncode","MAWDbParticipantTxns","MAWDbPendingReceiptTxns","MAWDbPoll","MAWDbReactionsTxns","MAWDbThreadTxns","MAWDbUnrenderedMsgTxns","MAWDbUpdateDeviceChangeAlertsLogInStatusTxn","MAWDbUpdateDeviceChangeAlertsTxn","MAWDbVersion","MAWDbXMATxns","MAWDebugSendMultipleMsgs","MAWDexieTable","MAWEphemeralCleaner","MAWEphemeralSettingsTxns","MAWExternalId","MAWGroupSetMemberAddMode","MAWJids","MAWJobDefinitions","MAWJobManager","MAWKeychainNaClCrypto","MAWLoadMsgsApi","MAWLoggerUtils","MAWMediaUtils","MAWMsgType","MAWRotateDTSG","MAWSendEphemeralSettingMsg","MAWSendNoteReplyMsg","MAWSendSenderKeyDistributionMsg","MAWTransactionMode","MAWTransactor","MAWUnsafeCoerce","MAWVault","OfflineThreadingId","Promise","WAAPI","WAAbPropsInit","WABuildMpsPayload","WADbTransactor","WADevicesState","WAExceededStorageQuota","WAGatherMediaInfo","WAGetPlatformFromStanzaId","WAGlobals","WAGzip","WAHandleFailureUtils","WAJids","WAJobOrchestratorTypes","WALogger","WAMPSFlushable","WAMediaUtils","WAPREList","WAPREMetrics","WAProtocolQueue","WARotateSignedPreKey","WARunStorageBenchmark","WASignalDB","WASignalOther","WATimeUtils","WebStorageEstimator","WormDbDebuggingUtils","asyncToGeneratorRuntime","emptyFunction","err","gkx","promiseDone","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h=["s2sInstanceKey","s2sUserFlowQPLEvent"],i,j,k,l={addBadProtocolQueueInstruction:function(){var a={instruction:"bad",type:"instruction"};return d("WAProtocolQueue").protocolQueue().addAndCommit([a])},addDeviceChangeAlerts:function(a){return m(n({deviceChangeAlerts:d("MAWTransactionMode").READWRITE})(d("MAWDbAddDeviceChangeAlertsTxn").addDeviceChangeAlertsTxn)(a))},addGroupParticipants:function(a,b,c){return d("MAWJobManager").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.addGroupParticipants(a,b,c))},addICDCAlert:function(a){return d("WAGlobals").getWaOneQueue().enqueue(function(){d("WAMPSFlushable").mpsFlushable.enqueue(d("WABuildMpsPayload").buildMpsIcdcAdminMessage(a,d("WATimeUtils").unixTime(),d("WAGlobals").getDependencies().generateExternalId()),function(){},"maw_debug");return(k||(k=b("Promise"))).resolve()},{flush:!0,operationType:"debug_operation"}).then(c("emptyFunction"))},benchmarkStorage:function(a,b,c,e){a===void 0&&(a=!1),b===void 0&&(b=1),c===void 0&&(c=50),e===void 0&&(e=500),void d("WARunStorageBenchmark").runStorageBenchmark(function(a){return!1},a,b,c,e)},checkStorageQuota:function(){return d("WAExceededStorageQuota").checkStorageQuota()},clearBlobStorage:function(){return c("BlobStorageApi").clear().then(function(a){if(a.success)c("FBLogger")("BlobStorage").info("Blob storage cleared");else throw c("err")("Failed to clear blob storage")})},createGroup:function(a,b,c){return d("MAWJobManager").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").createStartJobInfo("createGroup",{extras:{clientThreadKey:c,platform:"msgr"},key:c,s2sInstanceKey:d("MAWLoggerUtils").getInstanceKey(),subject:a,users:b}))},createOrUpdateThread:function(a){return d("MAWBridge").getBridge().sendAndReceive("backend","createOrUpdateThread",{contactFbid:a,description:"MAWDebug",threadKey:d("OfflineThreadingId").createOfflineThreadingID()})},createTestPoll:function(a){void n({poll:d("MAWTransactionMode").READWRITE})(function(b){return b.poll.put({chatJid:a,encKey:new ArrayBuffer(0),latestSenderTimestampsMs:new Map([["@me",d("WATimeUtils").millisTime()]]),pollAuthor:"@me",pollOptions:new Map([[d("MAWDbPoll").convertStringToOptionHash("option1Hash"),{optionText:"option1",voteAuthors:new Set(["@me"])}]]),pollParticipantCount:2,pollStanzaId:d("MAWExternalId").generateExternalId(),pollState:d("MAWArmadilloPollTableSchema.pb").POLL_STATE.OPEN,selectableOptionsCount:0,title:"Test Poll"})})(a)},decodeEAR:function(a,b){return d("MAWDbObjDecode").decodeDbObj(a,b)},deflate:function(a){var b=d("WAGzip").createDeflate();b.push(a,!0);return b.result()},deleteGroupInvitesByThreadAndInvitedParticipant:function(a,b){return m(n({groupInvites:d("MAWTransactionMode").READWRITE})(d("MAWDbGroupInviteTxns").deleteGroupInvitesByThreadAndInvitedParticipant)(a,b))},demoteGroupParticipants:function(a,b){return d("MAWJobManager").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.demoteGroupParticipants(a,b))},deregisterPhone:function(){c("promiseDone")(d("WAHandleFailureUtils").deregisterPhone())},dropExpiredMessagesFromDB:function(){var a=d("MAWEphemeralCleaner").getEphemeralCleaner_FOR_TESTING_ONLY();if(a)a.backend.update(d("WATimeUtils").futureUnixTime(5));else throw c("err")("Cannot delete expired msgs as cleaner is not initialized!")},dropExpiredMessagesFromUI:function(){var a=d("MAWEphemeralCleaner").getEphemeralCleaner_FOR_TESTING_ONLY();if(a)a.ui.update(d("WATimeUtils").futureUnixTime(5));else throw c("err")("Cannot delete expired msgs as cleaner is not initialized!")},encodeEAR:function(a,b){return d("MAWDbObjEncode").encodeDbObj(a,b)},encryptEARTweetNaCl:function(a,b,c){return d("MAWKeychainNaClCrypto").encryptTweetNaCl(a,b,c)},estimateStorage:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield d("WebStorageEstimator").estimateStorage());return a});function c(){return a.apply(this,arguments)}return c}(),executeQuery:function(a){var b=Object.keys(d("MAWDbVersion").CURRENT_MAW_STORES).filter(function(a){return d("MAWDbVersion").CURRENT_MAW_STORES[a]!=null}).reduce(function(a,b){return babelHelpers["extends"]({},a,(a={},a[b+""]=d("MAWTransactionMode").READWRITE,a))},{});return n(b)(a)()},forwardMsg:function(a,b){return d("MAWBridge").getBridge().sendAndReceive("backend","forwardMsg",{args:{args:{},chatJid:a,externalId:d("MAWExternalId").generateExternalId(),protocolMsgId:b},qplEventType:c("qpl")._(25313175,"1551"),qplInstanceKey:d("MAWLoggerUtils").getInstanceKey()})},fromUnixTime:function(a){return d("WATimeUtils").toDate(a)},gatherMediaInfo:function(){c("promiseDone")(d("WAGatherMediaInfo").gatherMediaInfo())},generateAndUploadPreKeys:function(){return c("WAAPI").generateAndUploadPreKeys({reason:"test"})},generateAndUploadPreKeysMultipleCalls:function(){return(k||(k=b("Promise"))).all([c("WAAPI").generateAndUploadPreKeys({reason:"test"}),c("WAAPI").generateAndUploadPreKeys({reason:"test"}),c("WAAPI").generateAndUploadPreKeys({reason:"test"})])},generateCipherTextMessagesForChat:function(a,c){return(k||(k=b("Promise"))).all(Array.from({length:c}).map(function(b,c){b=d("WATimeUtils").castMilliSecondsToUnixTime(Date.now());var e=d("MAWExternalId").generateExternalId(),f={ack:2,altIndex:void 0,author:"@me",externalId:e,msgContent:{content:"Stub message #"+c},msgId:d("MAWDbMsg").craftMsgIdV2(1,1,{externalId:e}),serverTs:b,threadJid:a,ts:b,type:d("MAWMsgType").MSG_TYPE.CIPHERTEXT};return n({messages:d("MAWTransactionMode").READWRITE})(function(a){return a.messages.add(f)})(f)}))},generateDuplicateMessagesForChat:function(a,b){return l.generateMessagesForChat(a,b).then(function(a){var b=a.msgResults.values().map(function(a){return(a=a.value)==null?void 0:a.protocolMsgId.externalId}).filter(Boolean),e=b[0];return n({messages:d("MAWTransactionMode").READWRITE})(function(a){return d("MAWDexieTable").dexieAll(b.map(function(b){return a.messages.get({externalId:b}).then(function(b){if(b!=null)return a.messages.put(babelHelpers["extends"]({},b,{externalId:e,protocolMsgId:void 0}))})})).then(c("emptyFunction"))})(b)})},generateMessagesForChat:function(a,b){return d("MAWBulkHandleIncomingMsgApi").bulkHandleIncomingMsgs(Array.from({length:b}).map(function(b,c){b=d("WATimeUtils").castMilliSecondsToUnixTime(Date.now());var e=d("MAWExternalId").generateExternalId();c={ack:2,altIndex:void 0,author:"@me",externalId:e,msgContent:{content:"Stub message #"+c},serverTs:b,ts:b,type:"Text"};return{msgData:{folder:null,id:{author:"@me",chat:a,externalId:e},msg:{encoded:new Uint8Array(0),version:"v2"},recipientsCount:null,reportingMeta:null,ts:b,type:"IncomingMsg"},receiveFlow:d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.RECEIVE_MESSAGE,{}),stanzaSource:"wa",unstoredContent:{unstoredDbMedia:null,unstoredDbMsg:c,unstoredDbReaction:null,unstoredDbReceiverFetchInfo:null}}}),c("LSMEBTaskCreationSource").TEST_ONLY)},getAbProp:function(a){return d("WAAbPropsInit").getAbProp(a)},getAbProps:function(){return d("WAAbPropsInit").getAbProps()},getAppDatas:function(a){return m(n({appData:d("MAWTransactionMode").READONLY})(d("MAWDbAppDataTxns").bulkGetAppData)(a))},getAppMetaByKey:function(a){return m(n({appMeta:d("MAWTransactionMode").READONLY})(d("MAWDbMsgTypeVersionTxns").getAppMetaValue)(a))},getChunksByChunkId:function(a){return m(n({chunk:d("MAWTransactionMode").READONLY})(d("MAWDbChunkTxns").bulkGetChunks)(a))},getConfig:function(){return Object.fromEntries(Object.entries(d("MAWConfig").getConfig()).map(function(a){var b=a[0];a=a[1];var c;a;try{c=a()}catch(b){c=a}return[b,c]}))},getCurrentUserDeviceList:function(){return c("WAAPI").getCurrentUserDeviceList()},getDeviceChangeAlerts:function(a){return m(n({deviceChangeAlerts:d("MAWTransactionMode").READWRITE})(d("MAWDbGetDeviceChangeAlertsTxn").getDeviceChangeAlertsTxn)(a))},getDeviceChangeAlertsByOptions:function(a){return m(n({deviceChangeAlerts:d("MAWTransactionMode").READWRITE})(d("MAWDbGetDeviceChangeAlertsByOptionsTxn").getDeviceChangeAlertsByOptionsTxn)(a))},getDeviceChangeAlertsByOptionsLLA:function(a){return d("MAWBridge").getBridge().sendAndReceive("backend","getDeviceChangeAlertsByOptions",{options:a})},getDevices:function(a,b){return c("WAAPI").getDevices({ignoreDhash:b,reason:"debug",users:new Set(a)})},getDevicesState:function(){return d("WADevicesState").getDevicesState()},getEBDBClientState:function(){return d("EBWorkerEBDBApi").getSecureEBClientState()},getEBDeps:function(){return d("EBDeps").getDeps()},getEBSMConsistency:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){return d("EBDBConsistencyApi").checkRegistrationConsistency((yield d("EBLS").genLSClient()).db)});function c(){return a.apply(this,arguments)}return c}(),getEBSMWorkerState:function(){return(j||(j=c("ExecutionEnvironment"))).isInWorker?d("EBWorkerEBSMStateUtils").getEBSMWorkerState():d("MAWBridge").getBridge().sendAndReceive("backend","getEBSMWorkerState")},getEditMsgHistoryByEditMsgHistoryId:function(a){return m(n({editMsgHistory:d("MAWTransactionMode").READONLY})(d("MAWDbEditMsgHistoryTxns").bulkGetEditMsgHistorys)(a))},getEditMsgHistoryByProtocolMsgId:function(a){return m(n({editMsgHistory:d("MAWTransactionMode").READONLY})(d("MAWDbEditMsgHistoryTxns").maybeGetEditMsgHistoryFromProtocolMsgId)(a))},getGroupInfosByGroupJid:function(a){return m(n({groupInfo:d("MAWTransactionMode").READONLY})(d("MAWDbGroupInfoTxns").getGroupInfos)(a))},getGroupInvite:function(a,b){return m(n({groupInvites:d("MAWTransactionMode").READONLY})(d("MAWDbGroupInviteTxns").maybeGetGroupInvite)(a,b))},getGroupInvitesByThreadAndInvitedParticipant:function(a,b){return m(n({groupInvites:d("MAWTransactionMode").READONLY})(d("MAWDbGroupInviteTxns").getGroupInvitesByThreadAndInvitedParticipant)(a,b))},getHmacKeyFromGlobals:function(){return d("WAGlobals").getHMACKey()},getMediaBackupForObjectId:function(a){return m(n({mediaBackup:d("MAWTransactionMode").READONLY})(d("MAWDbMediaTxns").maybeGetMediaBackupRowFromObjectId)(a))},getMediaByIdWithDecodedMediaEntries:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=(yield n({media:d("MAWTransactionMode").READONLY})(d("MAWDbMediaTxns").bulkGetMedias)(a));a.forEach(function(a){if(!(a!=null&&a.mediaEntries))return;a.mediaEntries=new Map(Array.from(a.mediaEntries,function(a){var b=a[0];a=a[1];return[b,d("WAMediaUtils").decodeMediaEntryData(a)]}))});return m((k||(k=b("Promise"))).resolve(a))});function c(b){return a.apply(this,arguments)}return c}(),getMediaByMediaId:function(a){return m(n({media:d("MAWTransactionMode").READONLY})(d("MAWDbMediaTxns").bulkGetMedias)(a))},getMediaByPlaintextHash:function(a){return m(n({media:d("MAWTransactionMode").READONLY})(d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash)(a))},getMessagesByMsgIds:function(a){return m(n({messages:d("MAWTransactionMode").READONLY})(function(b){return b.messages.where("msgId").anyOf(a).toArray().then(function(a){return a.filter(Boolean)})})(a))},getMsgsByChat:function(a){return m(n({messages:d("MAWTransactionMode").READONLY})(function(b){return b.messages.where("threadJid").equals(a).toArray()})())},getMsgsByMsgId:function(a){return m(n({messages:d("MAWTransactionMode").READONLY})(d("MAWDbMsgTxns").getMsgsByMsgIds)(a))},getMsgsByProtocolMsgId:function(a){return m(n({messages:d("MAWTransactionMode").READONLY})(d("MAWDbMsgTxns").getMsgsByProtocolMsgId)(a))},getNewDTSG:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){return(yield d("MAWRotateDTSG").getNewDTSG()).token});function c(){return a.apply(this,arguments)}return c}(),getParticipantsByParticipantKeys:function(a){return m(n({participants:d("MAWTransactionMode").READONLY})(d("MAWDbParticipantTxns").bulkGetParticipants)(a))},getPendingReceipts:function(a){return m(n({pendingReceipts:d("MAWTransactionMode").READONLY})(d("MAWDbPendingReceiptTxns").getPendingReceipts)(a))},getPlatform:function(a){return d("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(a)},getProtocolMsgId:function(a){return d("MAWBridge").getBridge().sendAndReceive("backend","getProtocolMsgIdByMsgId",{msgId:a})},getReactionByReactToExternalId:function(a){return m(n({reactions:d("MAWTransactionMode").READONLY})(function(b){return b.reactions.where("reactToExternalId").anyOf(a).toArray()})(a))},getReactionByReactToMsgId:function(a){return m(n({messages:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY})(function(b){return b.messages.where("msgId").anyOf(a).toArray().then(function(a){return d("MAWDbReactionsTxns").getReactionsFromMessages(b,a)})})(a))},getReceiptByWAMsgId:function(a){return m(o({receipts:d("MAWTransactionMode").READONLY})(function(a,b){return a.receipts.get({waMsgId:b})})(a))},getThreadsByChatJids:function(a){return m(n({threads:d("MAWTransactionMode").READONLY})(d("MAWDbThreadTxns").getThreads)(a))},getUnArchivedDeviceChangeAlertsCount:function(){return m(n({deviceChangeAlerts:d("MAWTransactionMode").READWRITE})(d("MAWDbGetUnArchivedDeviceChangeAlertsCountTxn").getUnArchivedDeviceChangeAlertsCountTxn)())},getUnrenderedMsgsByMsgId:function(a){return m(n({unrenderedMessages:d("MAWTransactionMode").READONLY})(d("MAWDbUnrenderedMsgTxns").getUnrenderedMsgsByMsgIds)(a))},getXMAByXMAId:function(a){return m(n({xma:d("MAWTransactionMode").READONLY})(d("MAWDbXMATxns").bulkGetXMAs)(a))},hmacPlaintextHash:function(a){return d("MAWMediaUtils").genHMACPlaintextHash(a)},inflate:function(a){return d("WAGzip").inflate(a)},leaveGroups:function(a){return d("MAWJobManager").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.leaveGroups(a))},loadMsgs:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b;b=(yield d("MAWLoadMsgsApi").loadMsgsFromTs(a.chatJid,(b=a.numMsgs)!=null?b:10,a.direction,a.sortOrderMs,a.loadOriginalMsg,a.msgId,{admin:!0,editMsgHistory:!0,media:!0,polls:!0,reactions:!0,receiverFetch:!0,xma:!0}));return babelHelpers["extends"]({},b,{msgs:b.msgs.map(function(a){return babelHelpers["extends"]({},a,{content:a.content!=null?d("MAWVault").unvault(a.content):""})})})});function c(b){return a.apply(this,arguments)}return c}(),makeError:function(a){throw c("FBLogger")("messenger_web_devx").mustfixThrow(a)},makeWAError:function(a){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["",""])),a)},markThreadAsRead:function(a,b){return d("MAWJobManager").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.markThreadAsRead(a,null,!1,!1,b,{priority:d("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION}))},maybeGetChunksByPlaintextHash:function(a){return m(n({chunk:d("MAWTransactionMode").READONLY})(d("MAWDbChunkTxns").maybeGetChunkByPlaintextHash)(a))},maybeGetXMAFromProtocolMsgId:function(a){return m(n({xma:d("MAWTransactionMode").READONLY})(d("MAWDbXMATxns").maybeGetXMAFromProtocolMsgId)(a))},notifyDeviceChange:function(a){return c("WAAPI").notifyDeviceChange({users:a})},overrideAbProp:function(a,b){d("WAAbPropsInit").overrideAbProp(a,b)},promoteGroupParticipants:function(a,b){return d("MAWJobManager").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.promoteGroupParticipants(a,b))},protocolQueue:function(){return d("WAProtocolQueue").protocolQueue()},putGroupInvite:function(a){return m(n({groupInvites:d("MAWTransactionMode").READWRITE})(d("MAWDbGroupInviteTxns").putGroupInvite)(a))},queryAllGroups:function(){return c("WAAPI").queryGroups({type:"all"}).then(c("emptyFunction"))},readCacheStore:function(a){return d("MAWCacheServiceDB").getOrSetupMAWCacheDB().then(function(b){return b.runInTransaction([a],"readonly",function(b){return b.stores[a].readAll()},"Debug - read "+a,f.id+":1098")})},readProtocolQueue:function(){return d("WAProtocolQueue").protocolQueue().read()},readWormStore:function(a){return d("WASignalDB").getDb().runInTransaction([a],"readonly",function(b){return b.stores[a].readAll()},"Debug - read "+a,f.id+":1113")},removeDevice:function(a,b){return c("WAAPI").removeDevice({deviceId:a,identity:b})},removeGroupParticipants:function(a,b){return d("MAWJobManager").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.removeGroupParticipants(a,b))},reportUserSpam:function(a,b){return d("MAWJobManager").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.reportUserSpam(a,"frx",b,!1,["harassment"],"fake debug context"))},reregisterPhone:function(){return d("WAHandleFailureUtils").reregisterPhone()},revokeMsg:function(a){return d("MAWJobManager").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.revokeMsgs({msgIds:[a],s2sInstanceKey:d("MAWLoggerUtils").getInstanceKey()}))},rotateSignedPreKey:function(){return d("WARotateSignedPreKey").rotateSignedPreKey()},sendAppData:function(a,b){return d("MAWJobManager").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.sendAppData({contents:a,deviceJids:b}))},sendBumpMsg:function(a,b){return d("MAWJobManager").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.sendBumpMsg(a,b))},sendEditMsg:function(a,b){return d("MAWBridge").getBridge().sendAndReceive("backend","sendEditMsg",{args:{editMsgContent:{content:a.editMsgContent.content,mentionedJids:[]},originalProtocolMsgId:a.originalProtocolMsgId},chatJid:a.originalProtocolMsgId.chat,externalId:b,qplEventType:c("qpl")._(25313175,"1551"),qplInstanceKey:d("MAWLoggerUtils").getInstanceKey()})},sendEphemeralSettingMsg:function(a,b){return d("MAWSendEphemeralSettingMsg").sendEphemeralSettingMsgFn({args:b,chatJid:a,externalId:d("MAWExternalId").generateExternalId(),qplEventType:c("qpl")._(25313175,"1551"),qplInstanceKey:d("MAWLoggerUtils").getInstanceKey()})},sendInvisibleMsg:function(a){return d("MAWSendSenderKeyDistributionMsg").sendSenderKeyDistributionMsg(a,d("MAWExternalId").generateExternalId(),d("MAWLoggerUtils").getInstanceKey())},sendInvisibleMsgToAllExistingGroups:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield n({groupInfo:d("MAWTransactionMode").READONLY})(function(a){return a.groupInfo.toArray()})()),b=[];for(a of a)b.push(d("MAWSendSenderKeyDistributionMsg").sendSenderKeyDistributionMsg(a.groupJid,d("MAWExternalId").generateExternalId(),d("MAWLoggerUtils").getInstanceKey()));return b});function c(){return a.apply(this,arguments)}return c}(),sendMessageTooAllExistingGroups:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield n({groupInfo:d("MAWTransactionMode").READONLY})(function(a){return a.groupInfo.toArray()})()),b=[];for(a of a)b.push(l.sendMsg(a.groupJid,{content:"message to "+a.groupJid+" at "+new Date().getTime(),s2sInstanceKey:d("MAWLoggerUtils").getInstanceKey()}));return b});function c(){return a.apply(this,arguments)}return c}(),sendMsg:function(a,b){var e=b.s2sInstanceKey;b.s2sUserFlowQPLEvent;b=babelHelpers.objectWithoutPropertiesLoose(b,h);return d("MAWBridge").getBridge().sendAndReceive("backend","sendMsg",{args:b,chatJid:a,externalId:d("MAWExternalId").generateExternalId(),qplEventType:c("qpl")._(25313175,"1551"),qplInstanceKey:e})},sendMultipleMsgs:d("MAWDebugSendMultipleMsgs").sendMultipleMsgs.execute,sendNoteReplyMsg:function(a,b){return d("MAWSendNoteReplyMsg").sendNoteReplyMsgFn({args:{content:b.content,noteContent:b.noteContent,noteExpirationTs:b.noteExpirationTs},chatJid:a,externalId:d("MAWExternalId").generateExternalId(),qplEventType:c("qpl")._(25313175,"1551"),qplInstanceKey:d("MAWLoggerUtils").getInstanceKey()})},sendReaction:function(a,b,e,f){return d("MAWBridge").getBridge().sendAndReceive("backend","sendReactionMsg",{args:{groupingKey:"",reaction:f,reactToAuthor:e,reactToProtocolMsgId:b},chatJid:a,externalId:b.externalId,qplEventType:c("qpl")._(25313175,"1551"),qplInstanceKey:d("MAWLoggerUtils").getInstanceKey()})},setEphemeralSettingWithoutUpdate:function(a,b,c,e){c=c==null?d("WATimeUtils").unixTime():d("WATimeUtils").futureUnixTime(c);return m(n({ephemeralSettings:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE})(d("MAWEphemeralSettingsTxns").handleAndWriteOutgoingUserEphemeralSettingChange)(a,b,c,e))},setGroupSubject:function(a,b){return d("MAWJobManager").getJobManager().waitUntilCompleted(d("MAWJobDefinitions").jobSerializers.setGroupSubject(a,b))},setMemberAddMode:function(a,b){return d("MAWGroupSetMemberAddMode").setMemberAddModeFn({groupJid:a,memberAddMode:b})},startComms:function(){var a;void ((a=d("MAWBackend").getWaComms())==null?void 0:a.startComms())},stopComms:function(){var a;(a=d("MAWBackend").getWaComms())==null||a.stopComms()},syncAbProps:function(a){a=a!==!0;return c("WAAPI").syncAbProps({sendHash:a})},triggerSecureStorageKeyChangeAlert:function(){var a={action:d("MAWDbDeviceChangeAlerts").KEY_CHANGE,deviceJid:d("WAJids").toDeviceJid(d("MAWJids").toUserJid(d("MAWCurrentUser").getID()),d("WAGlobals").getMyDeviceJid()),identity:d("MAWUnsafeCoerce").unsafeCoerce(d("WASignalOther").makeBytes(33)),isArchived:!1,model:"secure_storage",platform:"Meta",ts:d("WATimeUtils").unixTime()};return m(n({deviceChangeAlerts:d("MAWTransactionMode").READWRITE})(d("MAWDbAddDeviceChangeAlertsTxn").addDeviceChangeAlertsTxn)(a))},updateDeviceChangeAlerts:function(a){return m(n({deviceChangeAlerts:d("MAWTransactionMode").READWRITE})(d("MAWDbUpdateDeviceChangeAlertsTxn").updateDeviceChangeAlertsTxn)(a))},updateDeviceChangeAlertsLLA:function(a){return d("MAWBridge").getBridge().sendAndReceive("backend","updateDeviceChangeAlerts",{alert:a})},updateDeviceChangeAlertsLogInStatus:function(a){return m(n({deviceChangeAlerts:d("MAWTransactionMode").READWRITE})(d("MAWDbUpdateDeviceChangeAlertsLogInStatusTxn").updateDeviceChangeAlertsLogInStatusTxn)(a))},wormGetContact:function(a){return d("WormDbDebuggingUtils").getContact(a)},wormGetContacts:function(){return d("WormDbDebuggingUtils").getContacts()},wormGetIdentities:function(){return d("WormDbDebuggingUtils").getIdentities()},wormGetIdentitiesForUser:function(a){return d("WormDbDebuggingUtils").getIdentitiesForUser(a)},wormGetMetaRows:function(){return d("WormDbDebuggingUtils").getMetaRows()},wormGetPrekeyGenerations:function(){return d("WormDbDebuggingUtils").getPrekeyGenerations()},wormGetPrekeys:function(){return d("WormDbDebuggingUtils").getPrekeys()},wormGetSenderKeySessions:function(){return d("WormDbDebuggingUtils").getSenderKeySessions()},wormGetSenderKeySessionsForUser:function(a){return d("WormDbDebuggingUtils").getSenderKeySessionsForUser(a)},wormGetSessions:function(){return d("WormDbDebuggingUtils").getSessions()},wormGetSessionsForUser:function(a){return d("WormDbDebuggingUtils").getSessionsForUser(a)},wormGetSignedPrekeys:function(){return d("WormDbDebuggingUtils").getSignedPrekeys()},writeCutoverThreadAdminMsg:function(a,b){var c;return m(n({chunk:(c=d("MAWTransactionMode")).READONLY,ftsBackloggedMessages:c.READWRITE,groupInfo:c.READONLY,media:c.READONLY,messages:c.READWRITE,threads:c.READWRITE})(d("MAWAdminWriteCutoverThreadMsgTxn").writeCutoverThreadAdminMsg)(a,b))},writeRollbackCutoverThreadAdminMsg:function(a){a=n({threads:d("MAWTransactionMode").READONLY})(d("MAWDbThreadTxns").getThread)(a);return a.then(function(a){if(!a.success)return(k||(k=b("Promise"))).resolve();a=a.value;return m(n({chunk:d("MAWTransactionMode").READONLY,ftsBackloggedMessages:d("MAWTransactionMode").READWRITE,groupInfo:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE})(d("MAWAdminWriteCutoverThreadMsgTxn").writeRollbackCutoverAdminMsg)(a))})}};function m(a){return a.then(function(a){return a})}c("gkx")("23903")&&(self.Debug=l,self.WAAPI=c("WAAPI"));function n(a){return function(b){return d("MAWTransactor").makeMsgrTransactor(a,"debug",function(a){return function(){for(var c=arguments.length,d=new Array(c),e=0;e<c;e++)d[e]=arguments[e];return b.apply(void 0,[a].concat(d))}})}}function o(a){return function(b){return d("WADbTransactor").makeSignalTransactor(a,"debug",function(a){return function(){for(var c=arguments.length,d=new Array(c),e=0;e<c;e++)d[e]=arguments[e];return b.apply(void 0,[a].concat(d))}})}}g.MAWDebugFuncs=l}),98);
__d("XPolarisIGXAPIDirectInstamadilloRestoreCDNUrlControllerRouteBuilder",["jsRouteBuilder"],(function(a,b,c,d,e,f,g){a=c("jsRouteBuilder")("/api/v1/direct_v2/restoration_cdn_url/",Object.freeze({}),void 0);b=a;g["default"]=b}),98);
__d("endpoints",["CSRFGuard","PolarisConfig","Promise","XHRRequest","XPolarisIGXAPIDirectInstamadilloRestoreCDNUrlControllerRouteBuilder","getAsyncParams"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return new(h||(h=b("Promise")))(function(b,e){var f=c("getAsyncParams")("POST"),g=new(c("XHRRequest"))(c("XPolarisIGXAPIDirectInstamadilloRestoreCDNUrlControllerRouteBuilder").buildURL({}));g.setMethod("POST").setRequestHeader("X-IG-App-ID",d("PolarisConfig").getIGAppID()).setData(babelHelpers["extends"]({},f,{payload:a})).setResponseHandler(function(a){try{a=a.trim();d("CSRFGuard").exists(a)&&(a=d("CSRFGuard").clean(a));a=JSON.parse(a);b(a.payload.restoration_cdn_url)}catch(a){e(a)}}).setErrorHandler(function(a){e(a)}).send()})}g.fetchEBRestoreCDNUrl=a}),98);
__d("IGDAWDebug",["I64","IGDAWProtocolQueueInstructions","MAWDebug","MAWReStoreDb","MAWUnsafeCoerce","WAJids","WAProtocolQueue","WASignalKeys","asyncToGeneratorRuntime","cr:7711","endpoints"],(function(a,b,c,d,e,f,g){"use strict";var h;a={UNSAFE_triggerICDCErrorForIGD:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=d("WAJids").toMsgrUserJid(a);var b=d("MAWUnsafeCoerce").unsafeCoerce(Math.floor(Date.now()/1e3)),c=d("MAWUnsafeCoerce").unsafeCoerce(42);a={instruction:"icdcError",jid:a,notificationTs:b,priority:d("WAProtocolQueue").WAProtocolQueuePriorityHigh,stanzaQueueId:c,type:"instruction"};yield d("IGDAWProtocolQueueInstructions").handleInstructions([a])});function c(b){return a.apply(this,arguments)}return c}(),UNSAFE_triggerIdentityAddedForIGD:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){a=d("WAJids").toMsgrUserJid(a);b=d("WAJids").toMsgrDeviceJid(a,b);var c=d("MAWUnsafeCoerce").unsafeCoerce(Math.floor(Date.now()/1e3)),e=d("MAWUnsafeCoerce").unsafeCoerce(42);b={device:b,identity:d("WASignalKeys").makeSerializedKeyPair().serializedPubKey,instruction:"identityAdded",jid:a,model:"Chrome",notificationTs:c,platform:"Instagram",priority:d("WAProtocolQueue").WAProtocolQueuePriorityHigh,stanzaQueueId:e,type:"instruction"};yield d("IGDAWProtocolQueueInstructions").handleInstructions([b])});function c(b,c){return a.apply(this,arguments)}return c}(),UNSAFE_triggerIdentityChangedForIGD:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){a=d("WAJids").toMsgrUserJid(a);b=d("WAJids").toMsgrDeviceJid(a,b);var c=d("MAWUnsafeCoerce").unsafeCoerce(Math.floor(Date.now()/1e3)),e=d("MAWUnsafeCoerce").unsafeCoerce(42);b={device:b,identity:d("WASignalKeys").makeSerializedKeyPair().serializedPubKey,instruction:"identityChanged",jid:a,model:"Chrome",notificationTs:c,platform:"Instagram",priority:d("WAProtocolQueue").WAProtocolQueuePriorityHigh,stanzaQueueId:e,type:"instruction"};yield d("IGDAWProtocolQueueInstructions").handleInstructions([b])});function c(b,c){return a.apply(this,arguments)}return c}(),UNSAFE_triggerIdentityRemovedForIGD:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){a=d("WAJids").toMsgrUserJid(a);b=d("WAJids").toMsgrDeviceJid(a,b);var c=d("MAWUnsafeCoerce").unsafeCoerce(Math.floor(Date.now()/1e3)),e=d("MAWUnsafeCoerce").unsafeCoerce(42);b={device:b,instruction:"identityRemoved",jid:a,notificationTs:c,priority:d("WAProtocolQueue").WAProtocolQueuePriorityHigh,stanzaQueueId:e,type:"instruction"};yield d("IGDAWProtocolQueueInstructions").handleInstructions([b])});function c(b,c){return a.apply(this,arguments)}return c}(),fetchEBRestoreCDNUrl:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){try{a=(yield d("endpoints").fetchEBRestoreCDNUrl(a))}catch(a){}});function c(b){return a.apply(this,arguments)}return c}(),fetchInstamadilloMessage:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e){try{var g=(yield d("MAWReStoreDb").getDB(f.id+":144"));yield b("cr:7711")==null?void 0:b("cr:7711")(g,(h||(h=d("I64"))).of_float(a),c,e)}catch(a){}});function c(b,c,d){return a.apply(this,arguments)}return c}()};Object.assign(d("MAWDebug").MAWDebugFuncs,a)}),34);
__d("MAWParseXMAIGConfig",["WAArmadilloXMA.pb"],(function(a,b,c,d,e,f,g){"use strict";b=new Set([(a=d("WAArmadilloXMA.pb")).EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE,a.EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE,a.EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE,a.EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE,a.EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE,a.EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE,a.EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE,a.EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY,a.EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION,a.EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION,a.EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_MENTION]);g.IGD_SUPPORTED_TARGET_TYPES=b}),98);
__d("IGDAWMainWebWorkerConfig",["MAWGK","MAWParseXMAIGConfig","WADbDeviceRegistration","WorkerUtils","getOrchestratorVersion","gkx","justknobx","qex"],(function(a,b,c,d,e,f,g){"use strict";var h,i=1;a={S508658PreventOldSessionLookupAndPromote:function(){return!0},armadilloWebProcessFutureproof:function(){return c("MAWGK").armadillo_web_process_futureproof},batchSize:function(){return 500},getDevicesV2:function(){return c("gkx")("4551")},getSignalFutureMessagesMax:function(){return c("justknobx")._("847")},icdcAlertTriggerFailureCounter:function(){return c("justknobx")._("1970")},icdcCooldownIntervalInMinutes:function(){return 1e4},icdcIntervalInMinutes:function(){return c("justknobx")._("1972")},ignoreReadReceipts:function(){return c("qex")._("3109")===!1},isDocumentReceiveEnabled:function(){return!1},isEphemeralMessagesEnabled:function(){return!0},isFrankingDropOnInvalid:function(){return c("gkx")("23973")},isFrankingDropOnMissing:function(){return c("gkx")("23974")},isFrankingEnabled:function(){return c("justknobx")._("1347")},isGifEnabled:function(){return c("justknobx")._("1147")},isICDCErrorEnabled:function(){return c("gkx")("23975")},isMediaFallbackToAlternativeHmacSaltsEnabled:function(){return c("gkx")("23976")},isMetaAiInvocationMessageRenderEnabled:function(){return!1},isOctetStreamAttachmentMimeTypeEnabled:function(){return c("gkx")("4644")},isPollsEnabled:function(){return!1},isProgressiveJpegSendEnabled:function(){return c("justknobx")._("2412")},isSenderKeyPredistributionEnabled:function(){return c("gkx")("23981")},isSharedWorkerContext:function(){return(h||(h=d("WorkerUtils"))).isSharedWorkerContext()},isStickerEnabled:function(){return c("justknobx")._("2619")},isStickerReceiverFetchEnabled:function(){return!1},isStoryMentionXMAEnabled:function(){return!1},jpegThumbnailTargetByteSizeKB:function(){return c("justknobx")._("2338")},maxPrekeysToUpload:function(){return 200},maxUsersForNotifyDeviceChange:function(){return d("WADbDeviceRegistration").MAX_USERS_FOR_NOTIFY_DEVICE_CHANGE},offlineQueueStuckTimeoutMs:function(){return c("justknobx")._("3264")},oneQueueTimeoutMs:function(){return c("justknobx")._("2583")},orchestratorVersion:function(){return c("getOrchestratorVersion")()},pjpegPreviewAvoidLastScan:function(){return c("justknobx")._("67")},sendMsgWithoutJob:function(){return!0},sessionDropIfTooOld:function(){return c("justknobx")._("2240")},shouldDeviceStateTimesout:function(){return!0},skipDownloadablePreviewForProgressiveJpeg:function(){return c("justknobx")._("2371")},skipProcessingGroupInvite:function(){return c("justknobx")._("3899")},useLongSessionDrop:function(){return c("gkx")("1244")},waDanglingQueue:function(){return c("justknobx")._("1921")}};b={productTypeForEBAttachments:"igd",shouldFallbackToPreviewForFailedProgressiveJpeg:function(){return c("gkx")("2909")},supportedTypesVersion:function(){return c("MAWGK").armadillo_web_process_futureproof?i+1:i},supportedXMATargetTypes:function(){return d("MAWParseXMAIGConfig").IGD_SUPPORTED_TARGET_TYPES}};g.waConfig=a;g.mawConfig=b}),98);
__d("IGDBridgedAPIHandler",["JSResourceForInteraction","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){var b=a.args;a=a.type;switch(a){case"46":return c("JSResourceForInteraction")("IGDSendMessageTaskHandler").__setRef("IGDBridgedAPIHandler").load().then(function(a){a=a.handleTask;return a.apply(void 0,b)});case"33":return c("JSResourceForInteraction")("IGDUnsendMessageTaskHandler").__setRef("IGDBridgedAPIHandler").load().then(function(a){a=a.handleTask;return a.apply(void 0,b)});case"sendEditMessage":return c("JSResourceForInteraction")("IGDEditMessageTaskHandler").__setRef("IGDBridgedAPIHandler").load().then(function(a){a=a.handleTask;return a.apply(void 0,b)});case"sendMediaMessage":return c("JSResourceForInteraction")("IGDSendMediaMessageTaskHandler").__setRef("IGDBridgedAPIHandler").load().then(function(a){a=a.handleTask;return a.apply(void 0,b)});case"sendOrRemoveReaction":return c("JSResourceForInteraction")("IGDSendRemoveReactionTaskHandler").__setRef("IGDBridgedAPIHandler").load().then(function(a){a=a.handleTask;return a.apply(void 0,b)});case"sendXmaReceiverFetch":return c("JSResourceForInteraction")("IGDSendXmaReceiverFetchTaskHandler").__setRef("IGDBridgedAPIHandler").load().then(function(a){a=a.handleTask;return a.apply(void 0,b)});default:d("WALogger").DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose(["igdapi: unsupported api call ",""])),a).devConsole(b);return}}g.igdapi=a}),98);
__d("IGDHandleContinueMediaDownload",["MediaDownloadMediator","Promise","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){yield d("MediaDownloadMediator").handleNewCDNUrlFromMI(a.deliveryObjectId,a.cdnUrl);return(h||(h=b("Promise"))).resolve()});return i.apply(this,arguments)}g.handleContinueMediaDownload=a}),98);
__d("MAWBulkCancelDownloadMediaForUI",["MAWMediaManager"],(function(a,b,c,d,e,f,g){"use strict";function a(a){a.forEach(function(a){d("MAWMediaManager").getMawMediaManager().dequeueDownload(a)})}g.bulkCancelDownloadMediaForUI=a}),98);
__d("MAWBulkLoadMessagesForThread",["MAWDexieTable","MAWIndexedDb","MAWLoadMsgsTxns","MAWTransactionMode","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,editMsgHistory:a.READONLY,groupInfo:a.READONLY,media:a.READONLY,messages:a.READONLY,poll:a.READONLY,reactions:a.READONLY,receiverFetchInfo:a.READONLY,threads:a.READONLY,xma:a.READONLY},"bulkLoadMessagesForThread",function(a){return function(b){b=b.threads;return d("MAWDexieTable").dexieAll(b.map(function(b){var c=b.jid;b=b.numOfMsgsToLoad;return d("MAWLoadMsgsTxns").loadMsgAndMedia_COMPAT(a,c,b,!0)})).then(c("emptyFunction"))}});g.bulkLoadMessagesForThread=b}),98);
__d("MAWBulkMaybeCreateOrUpdateThreadScheduler",["WorkerScheduler"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){h==null&&(h=d("WorkerScheduler").makeScheduler("bulk-maybe-create-or-update-thread",{maxConcurrency:1,maxThrottleMs:500,timeToStuckMs:6e4}));return h}g.bulkMaybeCreateOrUpdateThreadScheduler=a}),98);
__d("MAWCreateUpdateThreadUtils",["MAWMICSchema","MAWQplProxy","qpl"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,e,f){b.forEach(function(b){return d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(1056836502,"2778"),a,{annotations:e,instanceKey:b})}),f!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25313175,"1551"),"thread_mapping_"+a,{instanceKey:f})}function a(a,b,c,d){b!=null&&h(a,[b],c,d)}function b(a,b,e){b!=null&&d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(1056842055,"807"),a,{instanceKey:b},!1,e)}function e(a,b,c,e){a==="init_sync"&&d("MAWQplProxy").sendQplPointThroughBridge(d("MAWMICSchema").EVENT,b,{annotations:e!=null?e:{}},void 0,{toClientId:c})}function f(a,b,c){a==="init_sync"&&d("MAWQplProxy").sendQPLBoolAnnotationThroughBridge(d("MAWMICSchema").EVENT,b,!0,void 0,{toClientId:c})}g.sendThreadMappingQPLPoints=h;g.sendThreadMappingQPLPoint=a;g.sendBridgeQPLPoint=b;g.maybeSendMICPoint=e;g.maybeSendMICState=f}),98);
__d("MAWBulkMaybeUpsertThreadAndParticipants",["MAWBridgeThread","MAWCreateUpdateThreadUtils","MAWDbParticipantTxns","MAWDexieTable","MAWGetOrCreateThreadTxns","MAWIndexedDb","MAWODSProxy","MAWTransactionMode","MaybeCreateOrUpdateThreadResultCache","Promise","WAJids","WAOdsEnums","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(a,c){var e=a.threads.filter(function(a){return!d("MaybeCreateOrUpdateThreadResultCache").cache__I_KNOW_WHAT_I_AM_DOING.has(a.chatJid)});return(e.length>0?i(babelHelpers["extends"]({threads:e},a),c).then(function(a){return a.forEach(function(a){a.status==="fulfilled"&&d("MaybeCreateOrUpdateThreadResultCache").cache__I_KNOW_WHAT_I_AM_DOING.set(a.value.chatJid,a)})}):(h||(h=b("Promise"))).resolve()).then(function(){return a.threads.map(function(b){var c;return(c=d("MaybeCreateOrUpdateThreadResultCache").cache__I_KNOW_WHAT_I_AM_DOING.get(b.chatJid))!=null?c:{jid:b.chatJid,reason:a.reason,status:"rejected"}})})};var i=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READWRITE,participants:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READWRITE},"bulkMaybeCreateOrUpdateThread",function(a){return function(b,c){var e=b.reason,f=b.s2sInstanceKey,g=b.threads,h=function(a){d("MAWCreateUpdateThreadUtils").maybeSendMICState(e,a,c==null?void 0:c.fromClientId)};p(e,c,g.length);b=Array.from(new Map(g.map(function(a){return[a.authoritativeThreadKey,a]})).values());var i=new Map(),l=b.map(function(a){var b=a.chatJid;a=a.instanceKey;a!=null&&i.set(b,a);return a}).filter(Boolean);d("MAWCreateUpdateThreadUtils").sendThreadMappingQPLPoints("bulk_get_or_create_thread_start",l,void 0,f);return d("MAWGetOrCreateThreadTxns").bulkGetOrCreateThread(a,q(b),{logState:h}).then(function(a){h("threadMapping4BulkGetDone");return a.map(function(a){var b=a.adminMsgParams,c=a.created;a=a.thread;var e=i.get(a.jid);d("MAWCreateUpdateThreadUtils").sendThreadMappingQPLPoint("bulk_get_or_create_thread_end",e,void 0,f);return{adminMsgParams:b,created:c,instanceKey:e,thread:a}})}).then(function(b){return b.map(function(b){var c=b.adminMsgParams,e=b.created,g=b.instanceKey,h=b.thread;return d("WAJids").switchOnMsgrChatJidType(h.jid,{group:function(b){return j(a,b,g,f).then(function(a){return n(h,a,e,c)})},user:function(b){return k(a,b,g,f).then(function(a){return m(h,a,e,c)})}})})}).then(function(a){return d("MAWDexieTable").dexieAllSettled(a).then(function(a){o(c,h);var b=[];for(a of a.entries()){var d=a[0],e=a[1];e.status==="rejected"?b.push(babelHelpers["extends"]({jid:g[d].chatJid},e)):b.push(e)}return b})})}});function j(a,b,c,e){d("MAWCreateUpdateThreadUtils").sendThreadMappingQPLPoint("get_participants_for_group_start",c,void 0,e);return d("MAWDbParticipantTxns").getParticipantsInThreads(a,[b]).then(function(a){d("MAWCreateUpdateThreadUtils").sendThreadMappingQPLPoint("get_participants_for_group_end",c,{"int":{participantsLoaded:a.length}},e);return a})}function k(a,b,c,e){d("MAWCreateUpdateThreadUtils").sendThreadMappingQPLPoint("upsert_participants_in_1_to_1_start",c,void 0,e);return d("MAWDbParticipantTxns").bulkRemoveIncorrectAndInsertMissingParticipantsInOneToOneThread(a,b,!1).then(function(a){d("MAWCreateUpdateThreadUtils").sendThreadMappingQPLPoint("upsert_participants_in_1_to_1_end",c,{"int":{participantsLoaded:a.length}},e);return a})}function l(a,b,c,e){return{adminMsgParams:e,chatJid:a.jid,clientThreadKey:a.optimisticThreadKey,folder:a.folder,isCreated:c,lastActivityTs:d("MAWBridgeThread").getLastActivityTs(a.snippetMsgTs,a.newestMsgTs),participants:b.map(function(a){var b=a.type;a=a.userJid;return{type:b,userJid:a}})}}function m(a,b,c,d){return babelHelpers["extends"]({},l(a,b,c,d),{shouldQueryForGroup:!1})}function n(a,b,c,d){return babelHelpers["extends"]({},l(a,b,c,d),{shouldQueryForGroup:c||b.length===0||b.some(function(a){return a.addressable!==!0})})}function o(a,b){b("threadMapping5LoadedParticipantsAndMsg"),d("MAWCreateUpdateThreadUtils").sendBridgeQPLPoint("lla_end",a==null?void 0:a.bridgeQPLInstanceKey,{toClientId:a==null?void 0:a.fromClientId})}function p(a,b,c){d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_THREAD_MAPPING,key:"bulk_create_thread_backend."+(a!=null?a:"unknown")});var e=function(c,e){d("MAWCreateUpdateThreadUtils").maybeSendMICPoint(a,c,b==null?void 0:b.fromClientId,e)};d("MAWCreateUpdateThreadUtils").sendBridgeQPLPoint("lla_start",b==null?void 0:b.bridgeQPLInstanceKey,{toClientId:b==null?void 0:b.fromClientId});e("bulk_create_thread_start",{"int":{thread_mapping_unique_threads:c}})}function q(a){return a.map(function(a){return{authoritativeThreadKey:a.authoritativeThreadKey,description:"bulkCreateThread",instanceKey:a.instanceKey,jid:a.chatJid,lastActivityTimestamp:d("WATimeUtils").castToMillisTime(a.lastActivityTimestampMs),lastReadWatermarkTimestamp:d("WATimeUtils").castToMillisTime(a.lastReadWatermarkTimestampMs)}})}g.bulkMaybeCreateOrUpdateThread=a}),98);
__d("MAWCancelDownloadMediaForUI",["MAWMediaManager"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return d("MAWMediaManager").getMawMediaManager().dequeueDownload(a)}g.cancelDownloadMediaForUI=a}),98);
__d("MAWChangeSecurityAlertSettingApi",["MAWDbMsgTypeVersionTxns","MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({appMeta:d("MAWTransactionMode").READWRITE},"changeSecurityAlertSetting",function(a){return function(b){return d("MAWDbMsgTypeVersionTxns").updateSecurityAlertValueForContact(a,b)}});g.changeSecurityAlertSetting=a}),98);
__d("MAWChangeSecurityAlertSettingForSelfApi",["MAWDbMsgTypeVersionTxns","MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({appMeta:d("MAWTransactionMode").READWRITE},"changeSecurityAlertSettingForSelf",function(a){return function(b){return d("MAWDbMsgTypeVersionTxns").updateSecurityAlertValueForSelf(a,b)}});g.changeSecurityAlertSettingForSelf=a}),98);
__d("MAWCompleteUndoThreadCutoverApi",["MAWAdminWriteCutoverThreadMsgTxn","MAWDbThreadTxns","MAWIndexedDb","MAWTransactionMode","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,ftsBackloggedMessages:a.READWRITE,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,threads:a.READWRITE},"completeUndoThreadCutover",function(a){return function(b){b=b.threadJid;return d("MAWDbThreadTxns").getThread(a,b).then(function(b){if(!b.success){d("WALogger").WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["UpdateAdminMessageAfterUndoCutover failed to get the thread"])));return}b=b.value;if(b.isMigratedLocally===!0)return d("MAWDbThreadTxns").markCutoverThreadAsNotMigratedLocally(a,b).then(function(b){return d("MAWAdminWriteCutoverThreadMsgTxn").revertCutoverThreadAdminMsg(a,b).then(function(){return d("MAWAdminWriteCutoverThreadMsgTxn").writeRollbackCutoverAdminMsg(a,b)})})})}});g.completeUndoThreadCutover=b}),98);
__d("MAWConvertEchoMessagesToMsgStanzas",["MAWHandleEBRestoreWithHIM"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return d("MAWHandleEBRestoreWithHIM").convertEchoMessages(a,b)}g.convertEchoMessagesToMsgStanzas=a}),98);
__d("MAWCreateOrUpdateThreadApi",["MAWBridgeThread","MAWIndexedDb","MAWJids","MAWThreadManagementTxns","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,participants:a.READWRITE,reactions:a.READONLY,threads:a.READWRITE},"createOrUpdateThread",function(a){return function(b){var c=b.contactFbid,e=b.description,f=b.s2sInstanceKey;b=b.threadKey;return d("MAWThreadManagementTxns").getOrSetupOneToOneThread(a,{description:e,offlineThreadingId:b,skipVerifyThread:!0,userJid:d("MAWJids").toUserJid(c)},f).then(function(a){var b=a.created;a=a.thread;return{clientThreadKey:a.optimisticThreadKey,created:b,folder:a.folder,jid:a.jid,lastActivityTs:d("MAWBridgeThread").getLastActivityTs(a.snippetMsgTs,a.newestMsgTs)}})}});g.createOrUpdateThread=b}),98);
__d("MAWDeleteMediaChunks_FOR_TESTING_ONLY",["MAWIndexedDb","MAWMediaUtils","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READWRITE},"deleteMediaChunks_FOR_TESTING_ONLY",function(a){return function(b){b=b.map(d("MAWMediaUtils").genHMACPlaintextHash);return a.chunk.where("hashedPlaintextHash").anyOf(b)["delete"]().then(function(){})}});g.deleteMediaChunks_FOR_TESTING_ONLY=a}),98);
__d("MAWDeleteThreadApi",["FBLogger","MAWIndexedDb","MAWThreadManagementTxns","MAWTransactionMode","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READWRITE,deletedMessages:a.READWRITE,groupInfo:a.READWRITE,groupInvites:a.READWRITE,media:a.READWRITE,messages:a.READWRITE,participants:a.READWRITE,pendingStanzas:a.READWRITE,reactions:a.READWRITE,threads:a.READWRITE,unrenderedMessages:a.READWRITE},"deleteThread",function(a){return function(b){return a.threads.get({jid:b}).then(function(e){if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("There was no thread to delete in local delete thread");return d("MAWThreadManagementTxns").deleteAllThreadData(a,e).then(function(){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted thread ",""])),b)})})}});g.deleteThread=b}),98);
__d("MAWGetProtocolMsgIdByMediaMsgId",["MAWIndexedDb","MAWTransactionMode","WAJids"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY},"getProtocolMsgIdByMediaMsgId",function(a){return function(b){return a.messages.get({msgId:b}).then(function(b){return b==null?null:a.threads.get({jid:b.threadJid}).then(function(a){if(a==null)return null;return d("WAJids").isAuthorSystem(b.author)?null:{author:b.author,chat:a.jid,externalId:b.externalId}})})}});g.getProtocolMsgIdByMediaMsgId=a}),98);
__d("MAWDownloadMediaForUI",["MAWDownloadAndHandleMedia","MAWGetMediaApi","MAWGetProtocolMsgIdByMediaMsgId","MAWMediaDownloadStatus","MAWMediaDownloadStatusForUI","MAWMediaManager","MAWMpsGating","MWFBLogger","Promise","WAErrorMessage","WAFindMostRecentMediaEntry","WAHashUtils","WAMediaManager","WAPromiseManagement","WAResultOrError","WAStartMediaDownloadQplFlow","asyncToGeneratorRuntime","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p=d("MWFBLogger").MWMediaLogger.tags(["downloadMediaForUI"]);function a(a){return(o||(o=b("Promise"))).all(a.media.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield q(a));return{arg:a,result:b}});return function(b){return a.apply(this,arguments)}}()))}function q(a){return r(a)["catch"](function(a){p.catching(a).MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Runtime error"])));return d("WAResultOrError").makeError("runtime-error")})}var r=d("WAPromiseManagement").cacheWhilePending(function(a){var b;switch(a.type){case"mediaId":return"mediaId-"+a.mediaId.toString()+"-"+((b=a.downloadType)!=null?b:"fullsizeAndPreview");case"xmaId":return"xmaId-"+a.xmaId.toString();default:a.type;return"plaintextHash-"+a.plaintextHash+"-"+((b=a.downloadType)!=null?b:"fullsizeAndPreview")}},e);function e(a){return s.apply(this,arguments)}function s(){s=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=v(a);p.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["start downloadMediaForUILayout. ",""])),e);if(d("MAWMpsGating").isFullMpsEnabled()){var f=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"UILayout",msgType:null,protocolMsgId:null,triggerUIView:a.triggerUIView});if(a.type!=="plaintextHash"){p.MUSTFIX(j||(j=babelHelpers.taggedTemplateLiteralLoose(["downloadMediaForUILayout: args.type is not plaintextHash"])));return d("WAResultOrError").makeError("missing-media")}var g=a.plaintextHash;d("MAWDownloadAndHandleMedia").sendUIStatusDownloading(g,"download_and_handle_media");d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:"download_and_handle_media",hash:g,status:c("MAWMediaDownloadStatus").DOWNLOADING,type:"main"});var h=d("MAWMediaManager").getMawMediaManager().enqueueDownloadFullSizeAndPreview({fullSizePlaintextHash:g,mediaDownloadFlow:f,priority:d("WAMediaManager").MediaTaskPriority.HIGH}),q=h.fullsizePromise;h=h.previewPromise;void h.then(function(){d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:"handle_media_download_success",hash:g,status:c("MAWMediaDownloadStatus").SUCCESS,type:"preview"})});h=(yield q);if(h.success===!1){f.endFail("handle_media_download_fail",{string:{failReason:h.payload==null?h.error:d("WAErrorMessage").maybeGetMessageFromError(h.payload)}});d("MAWDownloadAndHandleMedia").sendUIStatusFailure(g,h.error);return d("WAResultOrError").makeError("runtime-error")}f.addPoint("handle_media_download_end");f.endSuccess();d("MAWDownloadAndHandleMedia").sendUIStatusSuccess(g,h.value.validatedResult);return d("WAResultOrError").makeResult()}var r;switch(a.type){case"xmaId":r=(yield d("MAWGetMediaApi").getMediaByXMAId(a.xmaId).then(function(a){return a.filter(Boolean)}));break;case"mediaId":r=(yield d("MAWGetMediaApi").getMediaByMediaId(a.mediaId).then(function(a){return a==null?[]:[{media:a}]}));break;default:a.type;r=(yield d("MAWGetMediaApi").getMediaByPlaintextHash(a.plaintextHash).then(function(a){return a==null?[]:[{media:a}]}));break}if(r.length===0){p.MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["cannot find media with ",""])),e);return d("WAResultOrError").makeError("missing-media")}q=(yield (o||(o=b("Promise"))).all(r.map(function(){var f=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var f,g=b.media;f=(f=a.xmaMediaType)!=null?f:b.xmaMediaType;try{b=(yield t(g));if(!b.success)return b;b=b.value;var h="UILayout";f=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:h,msgType:a.msgType,protocolMsgId:b,triggerUIView:a.triggerUIView,xmaMediaType:f});yield d("MAWDownloadAndHandleMedia").downloadAndHandleMediaImpl({downloadEntry:h,downloadType:a.downloadType,hash:g.plaintextHash,mediaDownloadFlow:f,msgType:a.msgType,protocolMsgId:b});return d("WAResultOrError").makeResult()}catch(a){p.catching(c("getErrorSafe")(a)).MUSTFIX(l||(l=babelHelpers.taggedTemplateLiteralLoose(["download media with "," runtime error"])),e);return d("WAResultOrError").makeError("runtime-error")}});return function(a){return f.apply(this,arguments)}}())));f=q.filter(function(a){return!a.success});if(f.length>0){p.MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["download media with "," errors: ",""])),e,f.map(function(a){return a.error}).toString());return f[0]}else{p.DEBUG(n||(n=babelHelpers.taggedTemplateLiteralLoose(["downloadMediaForUILayout success"])));return d("WAResultOrError").makeResult()}});return s.apply(this,arguments)}function t(a){return u.apply(this,arguments)}function u(){u=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=d("WAFindMostRecentMediaEntry").findMostRecentMediaEntry(a.mediaEntries);if(!a.success)return a;a=a.value;var b=a[0];a[1];a=(yield d("MAWGetProtocolMsgIdByMediaMsgId").getProtocolMsgIdByMediaMsgId(b));return a==null?d("WAResultOrError").makeError("no-protocol-msg-id"):d("WAResultOrError").makeResult(a)});return u.apply(this,arguments)}function v(a){switch(a.type){case"mediaId":return"mediaId: "+a.mediaId.toString();case"xmaId":return"xmaId: "+a.xmaId.toString();default:a.type;return"plaintextHash: "+d("WAHashUtils").sanitisePlaintextHash(a.plaintextHash)}}g.bulkDownloadMediaForUI=a;g.downloadMediaForUI=q;g.getMostRecentProtocolMsgId=t}),98);
__d("MAWDyiDownloadMedia",["MAWHandleMediaPreviewBeforeDownloadApi","MAWHandleMediaPreviewDownloadApi","MAWHandleMediaPreviewDownloadAsFailedApi","WAAPI","WAStartMediaDownloadQplFlow","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){var f=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"MAWDyiDownloadMedia",msgType:null,protocolMsgId:a,triggerUIView:null});b=(yield c("WAAPI").downloadMedia({downloadMediaMetric:f,handleMediaPreviewBeforeDownload:d("MAWHandleMediaPreviewBeforeDownloadApi").handleMediaPreviewBeforeDownload,handleMediaPreviewDownload:d("MAWHandleMediaPreviewDownloadApi").handleMediaPreviewDownload,handleMediaPreviewDownloadFailed:d("MAWHandleMediaPreviewDownloadAsFailedApi").handleMediaPreviewDownloadFailed,hash:b,mediaEntry:e,protocolMsgId:a}));b.success===!1?f.endFail(b.error):f.endSuccess();return b});return h.apply(this,arguments)}g.dyiDownloadMedia=a}),98);
__d("MAWFTSEBMessagesDataSync",["FBLogger","I64","MAWBridge","MAWDbFTSManifest","MAWFTSIndexedDb","MAWFTSWorker","MAWTransactionMode","MAWVault","Promise","asyncToGeneratorRuntime","err","isMAWUniversalSearchWithEBEnabled","justknobx","promiseDone","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=(a=c("justknobx"))._("2645"),m=a._("2606")+a._("2646"),n=a._("2647"),o=[],p=new Map(),q=[];function r(a){var b;o=o.filter(function(b){return b.tabId!==a});q=q.filter(function(b){return b!==a});if(!p.has(a))return;window.clearTimeout((b=p.get(a))==null?void 0:b.aliveTimeout);(b=p.get(a))==null||(b=b.ongoingTask)==null||b.reject(c("err")("Tab is closed"));p["delete"](a)}function s(a,b){var c=window.setTimeout(function(){r(a)},n),d=p.get(a);b&&t(a);if(d!=null){window.clearTimeout(d.aliveTimeout);d.aliveTimeout=c;return}p.set(a,{aliveTimeout:c,ongoingTask:null})}e=function(a){var c=a.hasFocus;a=a.tabId;s(a,c);return(k||(k=b("Promise"))).resolve()};f=function(a){a=a.tabId;r(a);return(k||(k=b("Promise"))).resolve()};function t(a){if(q.length>0&&q[0]===a)return;q=[a].concat(q.filter(function(b){return b!==a}))}a=function(a){a=a.tabId;s(a,!0);return(k||(k=b("Promise"))).resolve()};function u(a){return v.apply(this,arguments)}function v(){v=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var d=p.get(a);if(d==null)return;var e=new(k||(k=b("Promise")))(function(a,b){d.ongoingTask={reject:b,resolve:a}});try{yield (k||(k=b("Promise"))).race([e,new k(function(a,b){window.setTimeout(function(){b(c("err")("Task timeout"))},m)})])}catch(a){c("FBLogger")("fts_worker").mustfix("Failed to restore FTS index for tab %s",a.message)}finally{e=p.get(a);e!=null&&(e.ongoingTask=null);o=o.filter(function(b){return b.tabId!==a})}});return v.apply(this,arguments)}var w=function(a){var e=a.tabId,f=a.threadJid;if(!d("MAWFTSWorker").isFTSInitiated())return(k||(k=b("Promise"))).resolve(!1);if(o.length>=l)return(k||(k=b("Promise"))).resolve(!1);if(!q.slice(0,l).includes(e))return(k||(k=b("Promise"))).resolve(!1);if(o.some(function(a){return a.threadJid===f}))return(k||(k=b("Promise"))).resolve(!1);o.push({tabId:e,threadJid:f});c("promiseDone")(u(e));return(k||(k=b("Promise"))).resolve(!0)},x=function(a){var c=a.error;a=a.tabId;if(c==null){var d;(d=p.get(a))==null||(d=d.ongoingTask)==null||d.resolve()}else{(d=p.get(a))==null||(d=d.ongoingTask)==null||d.reject(c)}return(k||(k=b("Promise"))).resolve()},y=(i=d("MAWFTSIndexedDb")).makeMsgrFTSTransactor({ftsRestoreStatus:(j=d("MAWTransactionMode")).READWRITE},function(a){return function(b,c){return a.ftsRestoreStatus.get(b).then(function(e){var f;if(e!=null&&(h||(h=d("I64"))).lt((h||(h=d("I64"))).of_string(e.restoredUntilSortOrderMs),(h||(h=d("I64"))).of_string(c)))return;e=(f=(f=e==null?void 0:e.maxRestoredUntilSortOrderMs)!=null?f:e==null?void 0:e.restoredUntilSortOrderMs)!=null?f:c;return a.ftsRestoreStatus.put({maxRestoredUntilSortOrderMs:e,restoredUntilSortOrderMs:c,threadId:b})})}}),z=i.makeMsgrFTSTransactor({ftsRestoreStatus:j.READWRITE},function(a){return function(b){return a.ftsRestoreStatus.get(b)}}),A=i.makeMsgrFTSTransactor({ftsRestoreStatus:j.READWRITE},function(a){return function(b){return a.ftsRestoreStatus["delete"](b)}}),B=i.makeMsgrFTSTransactor({ftsManifest:j.READWRITE},function(a){return function(){return a.ftsManifest.get(d("MAWDbFTSManifest").ManifestKeys.CURR_VERSION).then(function(b){if(b!=null){if(b.restoreSessionId!=null)return b.restoreSessionId;var e=c("uuidv4")();return a.ftsManifest.update(d("MAWDbFTSManifest").ManifestKeys.CURR_VERSION,{restoreSessionId:e}).then(function(){return e})}return""})}}),C=i.makeMsgrFTSTransactor({ftsRestoreStatus:j.READWRITE},function(a){return function(){return a.ftsRestoreStatus.toCollection().toArray()}}),D=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.newSortOrderMs,e=a.threadId;a=a.unvaultedBridgeSearchMessages;var f=d("MAWFTSWorker").getFTSWorker(),g=a.map(function(a){var b;b=(b=a.msg)==null?void 0:b.content;return b==null?null:{chatId:e,id:a.externalId,textFragments:[d("MAWVault").isVaulted(b)?d("MAWVault").unvault(b):b],timestamp:a.sortOrderMs}}).filter(Boolean),h;c("isMAWUniversalSearchWithEBEnabled")()&&(h=(yield f.getExistingMessageIdsInIndex(a.map(function(a){return a.externalId}))));f.setEphemeralBacklog(g);yield f.index({estimatedNumMessages:g.length,type:"EB"});yield y(e,b);d("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"AddMessageSearchResult",value:h!=null?a.filter(function(a){return!h.has(a.externalId)}):a}]})});return function(b){return a.apply(this,arguments)}}(),E=i.makeMsgrFTSTransactor({mediaRestoreStatus:j.READWRITE},function(a){return function(b){return a.mediaRestoreStatus.get(b)}}),F=i.makeMsgrFTSTransactor({mediaRestoreStatus:j.READWRITE},function(a){return function(b,c){return a.mediaRestoreStatus.get(b).then(function(e){var f;if(e!=null&&(h||(h=d("I64"))).lt((h||(h=d("I64"))).of_string(e.restoredUntilSortOrderMs),(h||(h=d("I64"))).of_string(c)))return;e=(f=(f=e==null?void 0:e.maxRestoredUntilSortOrderMs)!=null?f:e==null?void 0:e.restoredUntilSortOrderMs)!=null?f:c;return a.mediaRestoreStatus.put({maxRestoredUntilSortOrderMs:e,restoredUntilSortOrderMs:c,threadId:b})})}});i=function(){return B()};j=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=a.threadId;a=(yield z(a));return(a=a==null?void 0:a.restoredUntilSortOrderMs)!=null?a:null});return function(b){return a.apply(this,arguments)}}();var G=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.newSortOrderMs;a=a.threadId;yield y(a,b)});return function(b){return a.apply(this,arguments)}}(),H=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=a.threadId;a=(yield z(a));return a});return function(b){return a.apply(this,arguments)}}(),I=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=a.threadId;yield A(a)});return function(b){return a.apply(this,arguments)}}(),J=function(){return C()},K=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=a.threadId;a=(yield E(a));return a});return function(b){return a.apply(this,arguments)}}(),L=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.newSortOrderMs;a=a.threadId;yield F(a,b)});return function(b){return a.apply(this,arguments)}}(),M=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=a.threadId;a=(yield E(a));return(a=a==null?void 0:a.restoredUntilSortOrderMs)!=null?a:null});return function(b){return a.apply(this,arguments)}}();g.searchFTSReportTabAlive=e;g.searchFTSReportTabDestroy=f;g.searchFTSReportTabForeground=a;g.searchFTSRequestRestoreTask=w;g.searchFTSReportTabTaskComplete=x;g.searchIndexUpdate=D;g.searchGetFTSRestoreSessionId=i;g.searchGetFTSNextTimestamp=j;g.searchSetFTSNextTimestamp=G;g.searchFTSGetThreadRestoreStatus=H;g.searchFTSClearThreadRestoreStatus=I;g.searchFTSGetThreadsRestoreStatus=J;g.getThreadMediaRestoreStatus=K;g.setThreadMediaRestoreStatus=L;g.getMediaRestoreNextTimestamp=M}),98);
__d("MAWFTSIssueGraphQLRangeRestoreRequest",["CurrentUser","EBAPI","MAWEBUnstoredDbMsgUtils","MAWJids","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b,c,e,f){if(a.protobufMessages!=null){f=d("MAWEBUnstoredDbMsgUtils").getUnstoredDbMsgFromProtobuf(a.protobufMessages,void 0,e,f);return{hasMoreAfter:a.hasMoreAfter,hasMoreBefore:a.hasMoreBefore,isPointQuery:!1,messages:f,nextMessageTimestampMsBefore:a.nextMessageTimestampMsBefore!=null?a.nextMessageTimestampMsBefore:void 0,protobufMessages:a.protobufMessages,referenceTimestamp:a.referenceTimestamp!=null?a.referenceTimestamp:void 0,requestId:c,restoreType:"protobuf",threadId:b}}else if(a.echoMessages!=null){f=d("MAWEBUnstoredDbMsgUtils").getUnstoredDbMsgFromEcho(a.echoMessages,e);return{echoMessages:a.echoMessages,hasMoreAfter:a.hasMoreAfter,hasMoreBefore:a.hasMoreBefore,isPointQuery:!1,messages:f,nextMessageTimestampMsBefore:a.nextMessageTimestampMsBefore!=null?a.nextMessageTimestampMsBefore:void 0,referenceTimestamp:a.referenceTimestamp!=null?a.referenceTimestamp:void 0,requestId:c,restoreType:"echo",threadId:b}}else return void 0}function a(a,b,c,d,e,f,g){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,i,j){b=(yield c("EBAPI").messageRangeQueryForIndexing({chatJid:a,direction:b,numMessages:j,sortOrderMs:e,source:f,traceId:g}));if(b.success){j=b.value;e=d("MAWJids").toUserJid(c("CurrentUser").getAccountID());f=h(j,i,g,a,e);if(f==null)return{error:"No echo message or protobuf payload returned from EB API for range restore"};else return{loadMessagesResponse:f}}else{j=b.error;return{error:j}}});return i.apply(this,arguments)}g.issueGraphQLRangeRestoreRequest=a}),98);
__d("MAWGetDownloadableThumbnailForMediaApi",["MAWOptimisticUploadManager","WALogger","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=d("MAWOptimisticUploadManager").getOptimisticUploadManager().get(a);if(a==null)return null;a=a.previewPlaintextHash;if(a==null)return null;a=d("MAWOptimisticUploadManager").getOptimisticUploadManager().get(a);if(a==null)return null;a=(yield (a=a.optimisticUploadPromise)==null?void 0:a["catch"](function(a){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["GetDownloadableThumbnail - previewEntry optimistedPromise rejected with ",""])),a);return d("WAResultOrError").makeError("runtime-error")}));if(a==null||a.success!==!0)return null;a=a.value;var b=a.directPath,c=a.fileEncSha256,e=a.fileSha256,f=a.mediaKey,g=a.mediaKeyTimestamp;a=a.objectId;return{directPath:b,fileEncSha256:c,fileSha256:e,mediaKey:f,mediaKeyTimestamp:g,objectId:a}});return function(b){return a.apply(this,arguments)}}();g.getDownloadableThumbnailForMedia=a}),98);
__d("MAWGetMediaPlaintextApi",["MAWIndexedDb","MAWMediaUtils","MAWOptimisticUploadManager","MAWTransactionMode","Promise","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i;a=function(a){var c=d("MAWOptimisticUploadManager").getOptimisticUploadManager();c=c.get(a);if(c==null)return j(a);else return(i||(i=b("Promise"))).resolve(c.file)};function j(a){return d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READONLY},"getMediaPlaintextFromDb",function(a){return function(b){b=d("MAWMediaUtils").genHMACPlaintextHash(b);return a.chunk.where("hashedPlaintextHash").equals(b).first().then(function(a){if(!a){d("WALogger").WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Media blob does not exist for the given hashedPlaintextHash"])));return null}return new Blob([a.blobData],{type:a.mimetype})})}})(a)}g.getMediaPlaintext=a}),98);
__d("MAWGetMediaKnownEntriesApi",["MAWDbMediaTxns","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWTransactionMode","MWFBLogger","WAHashUtils","WAJids","WAMsgMap","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=d("MWFBLogger").MWMediaLogger.tags(["GetMediaKnownEntries"]);a=d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READONLY},"getMediaKnownEntries",function(a){return function(b){return k(a,b)}});function k(a,b){return d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(a,b).then(function(c){if(!c){j.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["No existing media entry found for plaintextHash ",". Returning new MsgMap."])),d("WAHashUtils").sanitisePlaintextHash(b));return d("WAResultOrError").makeError("no-media-entry-by-plaintext-hash")}var e=Array.from(c.mediaEntries.keys());return d("MAWDexieTable").dexieAll(e.map(function(b){return d("MAWDbMsgTxns").maybeGetMsgListByMsgId_I_KNOW_WHAT_I_AM_DOING(a,b)})).then(function(a){a=a.map(function(a){return a.find(function(a){return(a==null?void 0:a.mediaId)===c.mediaId})});var f=[];a=a.reduce(function(a,g,h){if(!g){j.WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Message missing in messages table for given msgId for plaintextHash ",". Skipping..."])),d("WAHashUtils").sanitisePlaintextHash(b));f.push(e[h]);return a}h=c.mediaEntries.get(g.msgId);var k=g.author,l=g.threadJid;h&&!d("WAJids").isAuthorSystem(k)&&l!=null&&a.set({author:k,chat:l,externalId:g.externalId},h);return a},new(d("WAMsgMap").MsgMap)());return{missingMessages:f,msgMap:a,numEntries:e.length}}).then(d("WAResultOrError").makeResult)})}g.getMediaKnownEntries=a;g.getMediaKnownEntriesTxn=k}),98);
__d("MAWGetOrCreateMediaKnownEntriesApi",["MAWGetMediaKnownEntriesApi","MAWIndexedDb","MAWTransactionMode","WAMsgMap"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READONLY},"getOrCreateMediaKnownEntries",function(a){return function(b){return d("MAWGetMediaKnownEntriesApi").getMediaKnownEntriesTxn(a,b).then(function(a){if(a.success===!1)return new(d("WAMsgMap").MsgMap)();else return a.value.msgMap})}});g.getOrCreateMediaKnownEntries=a}),98);
__d("MAWMsgUtil",["MAWDbMsgTxns","MAWIndexedDb","MAWTransactionMode","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,media:a.READONLY,messages:a.READWRITE,receiverFetchInfo:a.READONLY,xma:a.READONLY},"updateSystemAckWithTxn",function(a){return function(b,e){return d("MAWDbMsgTxns").updateSystemAck(a,b,e).then(c("emptyFunction"))}});g.updateSystemAckWithTxn=b}),98);
__d("MAWStartMediaUploadQplFlow",["WAGetStorageQplAnnotations","WAJids","WAMediaQplHelper","WAPREList","WAPREMetrics","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.chatJid,e=a.fileSize,f=a.serverMediaType;a=a.uploadEntry;var g=d("WAPREMetrics").startMetric(d("WAPREList").PRE_METRIC.MEDIA_UPLOAD,{string:{chat_type:d("WAJids").switchOnMsgrChatJidType(b,{group:function(){return"group"},user:function(){return"user"}}),jid:b,media_size:d("WAMediaQplHelper").convertIntegerSizeToStringBucket(e),media_type:f,upload_entry:a}},void 0);c("promiseDone")(d("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(a){g.addAnnotations(a)}));return g}g.startMediaUploadQplFlow=a}),98);
__d("getProtocolMsgIdByMsgIdCommon",["MAWDexieTable","WAJids"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){return d("MAWDexieTable").dexieAll([a.messages.get({msgId:b}),a.unrenderedMessages.get({msgId:b}),a.reactions.get({reactionId:b})]).then(function(b){var c=b[0],e=b[1];b=b[2];if(b!=null)if(d("WAJids").isAuthorSystem(b.author))return null;else return{author:b.author,chat:b.threadJid,externalId:b.externalId};var f=c||e;return f==null?null:a.threads.get({jid:f.threadJid}).then(function(a){if(a==null)return null;return d("WAJids").isAuthorSystem(f.author)?null:{author:f.author,chat:a.jid,externalId:f.externalId}})})}g.getProtocolMsgIdByMsgIdCommon=a}),98);
__d("MAWGetProtocolMsgIdByMsgId",["MAWIndexedDb","MAWTransactionMode","getProtocolMsgIdByMsgIdCommon"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({messages:(a=d("MAWTransactionMode")).READONLY,reactions:a.READONLY,threads:a.READONLY,unrenderedMessages:a.READONLY},"getProtocolMsgByMsgId",function(a){return function(b){return d("getProtocolMsgIdByMsgIdCommon").getProtocolMsgIdByMsgIdCommon(a,b)}});g.getProtocolMsgIdByMsgId=b}),98);
__d("MAWUpdateMediaEntryForOptimisticUploadApi",["FBLogger","MAWGetProtocolMsgIdByMsgId","MAWOptimisticUploadManager","MAWUpdateMediaEntryForMsgApi","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f){var g=d("MAWOptimisticUploadManager").getOptimisticUploadManager(),h=g.get(a),i=h==null?void 0:h.msgId,j=b();if(i!=null){i=(yield d("MAWGetProtocolMsgIdByMsgId").getProtocolMsgIdByMsgId(i));i&&(yield d("MAWUpdateMediaEntryForMsgApi").updateMediaEntryForMsg(a,i,b,e,f))}else{if(!h)throw c("FBLogger")("messenger_web").mustfixThrow("Cannot update mediaEntry without both uploadEntry and msgId");g.set(a,babelHelpers["extends"]({},h,{mediaEntry:j}))}return});return function(b,c,d,e){return a.apply(this,arguments)}}();g.updateMediaEntryForOptimisticUpload=a}),98);
__d("MAWWriteForwardedMsgApi",["FBLogger","MAWAckLevel","MAWBridgeTypesCreators","MAWDbMsg","MAWDbMsgTxns","MAWDbXMATxns","MAWDexieTable","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWJidUtils","MAWMediaAfterTxns","MAWMediaManagementTxns","MAWMediaUtils","MAWMsgType","MAWQplProxy","MAWTransactionMode","MAWWriteMsgTxns","MAWXMAManagementTxns","MAWXMAUtils","WAJids","gkx"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,ftsBackloggedMessages:a.READWRITE,groupInfo:a.READONLY,media:a.READWRITE,mediaBackup:a.READWRITE,messages:a.READWRITE,threads:a.READWRITE,xma:a.READWRITE},"writeForwardedMsg",function(a){return function(b){var c=b.chatJid,e=b.ephemeralSetting,f=b.externalId,g=b.isFirstMsg,k=b.mediaGroupMetadata,l=b.openMessageParticipantCount,m=b.participantCount,n=b.protocolMsgId,o=b.qplEventType,p=b.qplInstanceKey,q=b.textWithSubstitutions,r=b.ts;return d("MAWDexieTable").dexieAll([a.threads.get({jid:c}),d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,n),a.messages.where("externalId").equals(f).toArray()]).then(function(b){var c=b[0],s=b[1];b=b[2];if(c==null)return{type:"missing_thread"};if(s==null)return{type:"missing_msg"};if(s.ephemeralSetting!=null&&s.ephemeralSetting.ephemeralExpirationInSec!==0)return{type:"forwarding_ephemeral_msg"};b=b.find(function(a){return a.threadJid===c.jid&&a.author===d("WAJids").AUTHOR_ME});if(b!=null)return b.ack>=d("MAWAckLevel").ACK.sent?{msgId:b.msgId,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:c.jid,externalId:b.externalId},type:"already_sent"}:{msgId:b.msgId,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:c.jid,externalId:b.externalId},type:"not_sent"};else{b={ack:d("MAWAckLevel").ACK.clock,altIndex:void 0,author:d("WAJids").AUTHOR_ME,ephemeralSetting:e!=null?e:void 0,externalId:f,forwardingScore:((b=s.forwardingScore)!=null?b:0)+1,groupId:k==null?void 0:k.groupId,groupIndex:k==null?void 0:k.groupIndex,groupSize:k==null?void 0:k.groupSize,hdType:s.hdType,isForwarded:s.author!==d("WAJids").AUTHOR_ME,mediaId:s.mediaId,msgContent:s.type==="Text"||s.type==="XMA"?s.msgContent:void 0,specialTextSize:s.specialTextSize,threadJid:c.jid,ts:r};var t=h(s.type,b,s.type==="Text"?s.msgContent:{content:""},s.xmaMessageType,q);return d("MAWWriteMsgTxns").writeMsg(a,t,c,{isFirstMsg:g,openMessageParticipantCount:l,participantCount:m}).then(function(b){return d("MAWDexieTable").dexieAll([j(a,n,b,s,c.jid,o,p),i(a,s.mediaId,b,s,c.jid)]).then(function(a){return{msgId:b.msgId,protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:c.jid,externalId:t.externalId},type:"not_sent"}})})}})}});function h(a,b,e,f,g){switch(a){case"Text":return babelHelpers["extends"]({},b,{msgContent:g!=null?{content:g}:e,type:d("MAWMsgType").MSG_TYPE.TEXT});case"Image":return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.IMAGE});case"Video":return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.VIDEO});case"Ptt":return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.PTT});case"Gif":return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.GIF});case"Sticker":return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.STICKER});case"DocumentFile":return babelHelpers["extends"]({},b,{type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE});case"XMA":if(f==null)throw c("FBLogger")("messenger_web").mustfixThrow("XMA type is null in forward msg");return babelHelpers["extends"]({},b,{msgContent:g!=null?{content:g}:b.msgContent,type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:f});default:throw c("FBLogger")("messenger_web").mustfixThrow("Should not be forwarding a message of type: "+a)}}function i(a,b,e,f,g){f=b!=null?a.media.get({mediaId:b}):d("MAWDexieTable").dexieResolve(null);return f.then(function(b){if(b==null&&d("MAWDbMsg").isMediaMsg(e))throw c("FBLogger")("messenger_web").mustfixThrow("Could not find media of forwarded message");return b==null?d("MAWDexieTable").dexieResolve():d("MAWMediaManagementTxns").linkMedia(a,e,b.plaintextHash,b.mediaType,b.size,null,{validatedAudioInfo:b.validatedAudioInfo,validatedDocumentFileInfo:b.validatedDocumentFileInfo,validatedImageInfo:b.validatedImageInfo,validatedVideoInfo:b.validatedVideoInfo},null,null,!1).then(function(b){if(b==null)return;return a.messages.where("msgId").anyOf(b.msgIds).toArray().then(function(c){var e=d("MAWMediaUtils").createHdTypesForBridgeMedia(c);c=d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:g,filteredMsgIds:d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(c,g),hasMediaForUI:!0,hdTypes:e,media:b});return d("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(a,c)})})})}function j(a,b,e,f,g,h,i){var j=c("gkx")("9841")?f.type===d("MAWMsgType").MSG_TYPE.XMA:d("MAWXMAUtils").isXMAShare_DO_NOT_USE(f.xmaMessageType);if(!j)return d("MAWDexieTable").dexieResolve();d("MAWQplProxy").sendQPLAnnotationsThroughBridge(h,{"int":{xma_message_type:f.xmaMessageType}},i);return d("MAWDbXMATxns").maybeGetXMAFromProtocolMsgId(a,b).then(function(b){if(b==null)return;var h=b.defaultPreviewMediaId,i=b.faviconMediaId,j=b.headerMediaId,k=Array.from(new Set([h,i,j].filter(Boolean)));k=k.map(function(b){return a.media.get(b).then(function(a){if(a==null)throw c("FBLogger")("messenger_web").mustfixThrow("Could not find media of forwarded xma message");return a})});return d("MAWDexieTable").dexieAll(k).then(function(k){k=k.map(function(b){return d("MAWMediaManagementTxns").linkMedia(a,e,b.plaintextHash,b.mediaType,b.size,b.mediaEntries.get(f.msgId),{validatedAudioInfo:b.validatedAudioInfo,validatedDocumentFileInfo:null,validatedImageInfo:b.validatedImageInfo,validatedVideoInfo:b.validatedVideoInfo},void 0,void 0,!0)});return d("MAWDexieTable").dexieAll(k).then(function(k){k=k.reduce(function(a,b){return a.set(b.mediaId,b)},new Map());var l=h==null?void 0:k.get(h);k=d("MAWXMAUtils").isXMAExternalLinkShare(f.xmaMessageType)||d("MAWXMAUtils").isReceiverFetchXMA(f.xmaMessageType);if(h==null&&!k)throw c("FBLogger")("messenger_web").mustfixThrow("Preview Media is missing");k=d("MAWJidUtils").maybeToProtocolMsgId(e.author,g,e.externalId);if(k==null)throw c("FBLogger")("messenger_web").mustfixThrow("ProtocolMsgId is null for forward XMA Share");d("MAWDexieTable").dexieResolve();return d("MAWXMAManagementTxns").saveXMA(a,h,j,i,b.targetType,e.msgId,void 0,k,{contentRef:b.contentRef,ctas:b.ctas,defaultCTA:b.defaultCTA,headerTitle:b.headerTitle,maxSubtitleNumOfLines:b.maxSubtitleNumOfLines,maxTitleNumOfLines:b.maxTitleNumOfLines,overlayDescription:b.overlayDescription,overlayIconGlyph:b.overlayIconGlyph,overlayTitle:b.overlayTitle,subtitleText:b.subtitleText,targetExpiringAtSec:b.targetExpiringAtSec,targetId:b.targetId,targetUsername:b.targetUsername,titleText:b.titleText,xmaLayoutType:b.xmaLayoutType},void 0,b.defaultPreviewMediaPlaintextHash,b.headerMediaPlaintextHash,b.faviconPlaintextHash).then(function(b){k=d("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(a,b,l);return k.then(function(){return})})})})})}g.writeForwardedMsg=b}),98);
__d("MAWForwardMsg",["FBLogger","MAWAckLevel","MAWDbMedia","MAWDbMediaTxns","MAWDbMsgTxns","MAWDbXMATxns","MAWDownloadAndHandleMedia","MAWGetDownloadableThumbnailForMediaApi","MAWGetMediaPlaintextApi","MAWGetOrCreateMediaKnownEntriesApi","MAWIndexedDb","MAWMediaManager","MAWMediaManagerUiIntegrationCheck","MAWMessageSendsCommon","MAWMpsGating","MAWMsgType","MAWMsgUtil","MAWProtobufDeserializers","MAWQplProxy","MAWSendWrittenMsg","MAWStartMediaUploadQplFlow","MAWTransactionMode","MAWUpdateMediaEntryForMsgApi","MAWUpdateMediaEntryForOptimisticUploadApi","MAWWriteForwardedMsgApi","MpsTypes","Promise","WAAPI","WAErrorMessage","WAFranking","WAGlobals","WAJids","WALogger","WAQPLProxy","WAResultOrError","WAStartMediaDownloadQplFlow","WebMps","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q=function(a,b){return function(c){if(b==null)return;d("MAWQplProxy").sendQplPointThroughBridge(a,c,{instanceKey:b})}};function r(a,b){var c=d("MAWProtobufDeserializers").DeserializedBackupMessage.create(a.toplevelProtobuf.payload);c=(c=c.encryptedTransportMessage())==null?void 0:c.proto;if(c==null)return null;a=d("WAJids").userIdFromJid(d("WAGlobals").getMyUserJid())===a.toplevelProtobuf.senderId;var e;b!=null&&(e={ephemeralExpiration:b.ephemeralExpirationInSec,ephemeralSettingTimestamp:b.ephemeralLastUpdatedOrSetTimestamp*1e3});return{metadata:babelHelpers["extends"]({},c.metadata,{chatEphemeralSetting:e,forwardingScore:((b=(b=c.metadata)==null?void 0:b.forwardingScore)!=null?b:0)+1,frankingKey:d("WAFranking").createFrankingKey(),frankingVersion:d("WAFranking").getFrankingVersion(),isForwarded:!a,quotedMessage:null}),payload:c.payload}}function s(a,b,c,d){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f){var g=a.args,o=a.chatJid,p=a.ephemeralSetting,s=a.externalId,t=a.protocolMsgId;a=a.textWithSubstitutions;d("WALogger").DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose(["forwardMsg: ",""])),o);var v=q(e,f);yield c("WAAPI").getDevicesBeforeSend({chatJid:o,reason:"ForwadMsg"});if(d("MAWMpsGating").isFullMpsEnabled()){var w=(yield d("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!1,shouldFetchTags:!1,strategy:"local-only"},debug:{purpose:"fetch-forwarded-message"},messageId:d("MpsTypes").toMessageId(t.externalId),threadId:d("MpsTypes").toThreadId(t.chat)})),x=w.value&&r(w.value,p);if(w.value==null||w.value.expiryTimestampMs!=null||x==null){c("FBLogger")("mps").mustfix("Original message not found for forwarding");return d("WAResultOrError").makeError({isRetriable:!1,type:"missing-referenced-msg"})}w={author:d("WAJids").AUTHOR_ME,chat:o,externalId:s};w=(yield d("MAWSendWrittenMsg").sendWrittenMsgExternal({protocolMsgId:w,referencedOriginalExternalId:s,type:"edit"},d("WAQPLProxy").waQPLProxyStartResume(e,f),"MAWSendEditMsg",{messageApplication:x}));if(w.success===!0)return d("WAResultOrError").makeResult({chatJid:o,content:g==null?void 0:g.content,ephemeralSetting:g==null?void 0:g.ephemeralSetting,externalId:s,initiatingSource:g==null?void 0:g.initiatingSource,messageType:"sendMsg",quote:g==null?void 0:g.quote,source:g==null?void 0:g.source,specialTextSize:g==null?void 0:g.specialTextSize,xmaMessageType:g==null?void 0:g.xmaMessageType});else return d("WAResultOrError").makeError(w.error)}x=(yield d("MAWWriteForwardedMsgApi").writeForwardedMsg({chatJid:o,ephemeralSetting:p,externalId:s,mediaGroupMetadata:g==null?void 0:g.mediaGroupMetadata,protocolMsgId:t,qplEventType:e,qplInstanceKey:f,textWithSubstitutions:a,ts:b}));if(x.type==="already_sent"){d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["forwardMsg already sent message"])));return d("WAResultOrError").makeError({isRetriable:!1,type:"already-sent"})}else if(x.type==="missing_thread"){d("WALogger").LOG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["forwardMsg cannot send to a non-existent thread"])));return d("WAResultOrError").makeError({isRetriable:!1,type:"missing-thread"})}else if(x.type==="missing_msg"){d("WALogger").LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["forwardMsg cannot forward a non-existent message"])));return d("WAResultOrError").makeError({isRetriable:!1,type:"missing-referenced-msg"})}else if(x.type==="forwarding_ephemeral_msg"){d("WALogger").LOG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["forwardMsg cannot forward an ephemeral message"])));return d("WAResultOrError").makeError({isRetriable:!1,type:"missing-referenced-msg"})}v("forwarded_message_written");w=(yield d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READONLY,messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY},"getMediaForForwardMsg",function(a){return function(){return d("MAWDbMsgTxns").maybeGetMsgResultByProtocolMsgId(a,t).then(function(b){if(!b.success)return b;var c=b.value;return b.value.type==="XMA"?d("MAWDbXMATxns").maybeGetXMAPayloadFromProtocolMsgId(a,t).then(function(a){if(a.success===!1)return d("WAResultOrError").makeError("missing-xma");return a.value==null||a.value.previews==null||a.value.previews.length===0?d("WAResultOrError").makeError("missing-xma-payload"):d("WAResultOrError").makeResult({media:a.value.previews[0],msg:c})}):d("MAWDbMediaTxns").getMediaFromMsgs(a,[c]).then(function(a){a=a[0];return a==null?d("WAResultOrError").makeError("missing-media"):d("WAResultOrError").makeResult({media:a,msg:c})})})}})());if(w.success){d("WALogger").LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["forwardMsg: media found for message, start media encrypt and upload"])));p=w.value;a=p.media;b=p.msg;w=(yield u({forwardedMsg:{chatJid:o,protocolMsgId:x.protocolMsgId},originalMedia:a,originalMsg:b}));if(!w.success){d("WALogger").ERROR(n||(n=babelHelpers.taggedTemplateLiteralLoose(["forwardMsg: failed to upload media. ",""])),w.error);v("failed_upload_media_to_backend");yield d("MAWMsgUtil").updateSystemAckWithTxn(x.msgId,d("MAWAckLevel").ACK.failed);return d("WAResultOrError").makeError({isRetriable:!1,type:"media-error"})}}p=(yield d("MAWSendWrittenMsg").sendWrittenMsgExternal({protocolMsgId:x.protocolMsgId,type:"message"},d("WAQPLProxy").waQPLProxyStartResume(e,f),"MAWForwardMsg"));if(p.success===!0)return d("WAResultOrError").makeResult({chatJid:o,content:g==null?void 0:g.content,ephemeralSetting:g==null?void 0:g.ephemeralSetting,externalId:s,initiatingSource:g==null?void 0:g.initiatingSource,messageType:"sendMsg",quote:g==null?void 0:g.quote,source:g==null?void 0:g.source,specialTextSize:g==null?void 0:g.specialTextSize,xmaMessageType:g==null?void 0:g.xmaMessageType});else return d("WAResultOrError").makeError(p.error)});return t.apply(this,arguments)}function a(a){var b=a.args,c=a.qplEventType,e=a.qplInstanceKey;return d("MAWMessageSendsCommon").messageSendObserver(c,e,function(a){return s(b,a,c,e)},"msg",{author:d("WAJids").AUTHOR_ME,chat:b.chatJid,externalId:b.externalId})}function u(a){return v.apply(this,arguments)}function v(){v=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.forwardedMsg,f=a.originalMedia;a=a.originalMsg;var g=d("MAWDbMedia").getServerMediaType(f,a.msgId);if(g.success===!1){d("WALogger").ERROR(o||(o=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadMediaForForwardMsg: can't get serverMediaType. ",""])),g.error);return g}g=g.value;a=a.type==="XMA"&&g==="image"?"xma-image":g;g=d("MAWStartMediaUploadQplFlow").startMediaUploadQplFlow({chatJid:e.chatJid,fileSize:f.size,serverMediaType:a,uploadEntry:"forwardMediaMsg"});if(!d("MAWMediaManagerUiIntegrationCheck").getIsMediaManagerUiIntegrationEnabled()){var h;h=(yield c("WAAPI").uploadMedia({chatJid:e.chatJid,filename:(h=f.validatedDocumentFileInfo)==null?void 0:h.filename,getDownloadableThumbnailForMedia:d("MAWGetDownloadableThumbnailForMediaApi").getDownloadableThumbnailForMedia,getMediaKnownEntries:d("MAWGetOrCreateMediaKnownEntriesApi").getOrCreateMediaKnownEntries,getMediaPlaintext:d("MAWGetMediaPlaintextApi").getMediaPlaintext,hash:f.plaintextHash,mediaTypeDetails:{mediaType:a,type:"regular"},protocolMsgId:e.protocolMsgId,size:f.size,updateMediaEntryForMsg:d("MAWUpdateMediaEntryForMsgApi").updateMediaEntryForMsg,updateMediaEntryForOptimisticUpload:d("MAWUpdateMediaEntryForOptimisticUploadApi").updateMediaEntryForOptimisticUpload,uploadMediaMetric:g}));return h}var i=(yield d("MAWGetMediaPlaintextApi").getMediaPlaintext(f.plaintextHash));if(i==null){h=(yield w(e.protocolMsgId,f));if(h.success===!1)return h;i=h.value}return c("WAAPI").uploadMedia({chatJid:e.chatJid,filename:(h=f.validatedDocumentFileInfo)==null?void 0:h.filename,getDownloadableThumbnailForMedia:d("MAWGetDownloadableThumbnailForMediaApi").getDownloadableThumbnailForMedia,getMediaKnownEntries:d("MAWGetOrCreateMediaKnownEntriesApi").getOrCreateMediaKnownEntries,getMediaPlaintext:function(){return(p||(p=b("Promise"))).resolve(i)},hash:f.plaintextHash,mediaTypeDetails:{mediaType:a,type:"regular"},protocolMsgId:e.protocolMsgId,size:f.size,updateMediaEntryForMsg:d("MAWUpdateMediaEntryForMsgApi").updateMediaEntryForMsg,updateMediaEntryForOptimisticUpload:d("MAWUpdateMediaEntryForOptimisticUploadApi").updateMediaEntryForOptimisticUpload,uploadMediaMetric:g})});return v.apply(this,arguments)}function w(a,b){return x.apply(this,arguments)}function x(){x=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c="ForwardMedia";a=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:c,msgType:d("MAWMsgType").MSG_TYPE.IMAGE,protocolMsgId:a,triggerUIView:null});b=(yield d("MAWMediaManager").getMawMediaManager().enqueueDownloadFullSize({fullSizePlaintextHash:b.plaintextHash,mediaDownloadFlow:a,priority:d("MAWDownloadAndHandleMedia").getPriorityFromDownloadEntry(c)}));if(b.success===!1){c=b.payload==null?b.error:d("WAErrorMessage").maybeGetMessageFromError(b.payload);a.endFail(b.error,{string:{failReason:c}});return d("WAResultOrError").makeError(c)}a.endSuccess();return d("WAResultOrError").makeResult(new Blob([b.value.validatedResult.validatedPlaintext],{type:(c=b.value.validatedResult.mimeType)!=null?c:b.value.unvalidatedMimeType}))});return x.apply(this,arguments)}g.forwardMsgFn=a}),98);
__d("MAWCreateMaybeAddPointForMediaRender",["MAWQplProxy","qpl"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return function(b,e){if(a==null)return;d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25302828,"2195"),b,{annotations:e,instanceKey:a},!0)}}g.createMaybeAddPointForMediaRender=a}),98);
__d("MAWGetBlobDataUrlByMediaIdApi",["FBLogger","MAWCreateMaybeAddPointForMediaRender","MAWDbChunkTxns","MAWDbMediaTxns","MAWIndexedDb","MAWLegacyMediaDownloadManager","MAWMaybeWithTimeout","MAWMediaManager","MAWMpsGating","MAWTransactionMode","Promise","WAAssertUnreachable","WAHashUtils","WALogger","WAMediaManager","WAResultOrError","WAStartMediaDownloadQplFlow","asyncToGeneratorRuntime","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m=c("gkx")("4307")?18e4:6e4;a=function(a,e,f){var g=d("MAWCreateMaybeAddPointForMediaRender").createMaybeAddPointForMediaRender(f);g("fetch_blob_api_start",{string:{call_site:e,fetch_by:"mediaId"}});return n(a,e).then(function(f){if(f.success===!1)switch(f.error){case"missing_media":g("fetch_blob_api_fail_no_media_found");throw c("FBLogger")("messenger_web_media").mustfixThrow("Failed to getBlobDataUrlByMediaId because media is not in the media db. mediaId is %s, from %s",a,e);default:f;throw c("WAAssertUnreachable")(f.error)}f=f.value;var i=f.blob,j=f.media;if(i!=null){g("fetch_blob_api_success",{bool:{has_blob:i.size>0}});return i}g("fetch_blob_api_no_media_blob_found");return d("MAWMaybeWithTimeout").maybeWithTimeout(new(l||(l=b("Promise")))(function(a){g("fetch_blob_api_fetch_chunk_start"),d("MAWLegacyMediaDownloadManager").setToMediaDownloadManager(j.mediaId,a)}).then(function(a){g("fetch_blob_api_fetch_chunk_success");g("fetch_blob_api_success",{bool:{has_blob:a.size>0}});return a}),m,function(){g("fetch_blob_api_fetch_chunk_fail_timeout");d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["getBlobDataUrlByMediaIdDbCall cannot find chunk with mediaId: ",", from ",""])),a,e);throw c("FBLogger")("messenger_web_media").mustfixThrow("Failed to getBlobDataUrlByMediaId in time. mediaId is %s, from %s",a,e)})})};var n=d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY},"getBlobDataUrlByMediaId",function(a){return function(b,c){return a.media.get(b).then(function(e){if(e==null){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["getBlobDataUrlByMediaIdDbCall cannot find media with mediaId: ",", from ",""])),b,c);return d("WAResultOrError").makeError("missing_media")}return a.chunk.where("hashedPlaintextHash").equals(e.hashedPlaintextHash).first().then(function(a){return a==null?d("WAResultOrError").makeResult({blob:null,media:e}):d("WAResultOrError").makeResult({blob:new Blob([a.blobData],{type:a.mimetype}),media:e})})})}});e=function(a,b,c){return o(a,b,c)};var o=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f){var g=d("MAWCreateMaybeAddPointForMediaRender").createMaybeAddPointForMediaRender(f);g("fetch_blob_api_start",{string:{call_site:e,fetch_by:"plaintextHash"}});if(d("MAWMpsGating").isFullMpsEnabled()){var h;f=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"UILayout",msgType:null,protocolMsgId:null,triggerUIView:null});f=(yield d("MAWMediaManager").getMawMediaManager().enqueueDownloadFullSize({fullSizePlaintextHash:a,mediaDownloadFlow:f,priority:d("WAMediaManager").MediaTaskPriority.HIGH}));if(!f.success){g("fetch_blob_api_fail_no_media_found");throw c("FBLogger")("messenger_web_media").mustfixThrow("Failed to getBlobDataUrlByPlaintextHash because hash is not in the media db. hash is %s, from %s",a,e)}f=f.value;var i=f.unvalidatedMimeType;f=f.validatedResult;h=(h=f.mimeType)!=null?h:i;i=new Blob([f.validatedPlaintext],{type:h});g("fetch_blob_api_success",{bool:{has_blob:i.size>0}});return i}return p(a,e).then(function(f){if(!f.success){g("fetch_blob_api_fail_no_media_found");throw c("FBLogger")("messenger_web_media").mustfixThrow("Failed to getBlobDataUrlByPlaintextHash because hash is not in the media db. hash is %s, from %s",a,e)}f=f.value;if(f.status==="found_media_and_blob"){g("fetch_blob_api_success",{bool:{has_blob:f.blob.size>0}});return f.blob}f.status;g("fetch_blob_api_no_media_blob_found");return d("MAWMaybeWithTimeout").maybeWithTimeout(new(l||(l=b("Promise")))(function(b){g("fetch_blob_api_fetch_chunk_start"),d("MAWLegacyMediaDownloadManager").setToMediaPlaintextDownloadManager(a,b)}).then(function(a){g("fetch_blob_api_fetch_chunk_success");g("fetch_blob_api_success",{bool:{has_blob:a.size>0}});return a}),m,function(){g("fetch_blob_api_fetch_chunk_fail_timeout");d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["getBlobDataUrlByPlaintextHash cannot find chunk with hash: ",", from ",""])),d("WAHashUtils").sanitisePlaintextHash(a),e);throw c("FBLogger")("messenger_web_media").mustfixThrow("Failed to getBlobDataUrlByPlaintextHash in time. hash is %s, from "+e,a,e)})})});return function(b,c,d){return a.apply(this,arguments)}}(),p=d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READONLY,media:d("MAWTransactionMode").READONLY},"getBlobDataUrlByPlaintextHash",function(a){return function(b,c){return d("MAWDbChunkTxns").maybeGetChunkByPlaintextHash(a,b).then(function(e){if(e!=null)return d("WAResultOrError").makeResult({blob:new Blob([e.blobData],{type:e.mimetype}),status:"found_media_and_blob"});else return d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(a,b).then(function(a){if(a!=null)return d("WAResultOrError").makeResult({media:a,status:"found_media_need_blob"});d("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["getBlobDataUrlByPlaintextHashCall cannot find media or chunk with hash: ",", from ",""])),d("WAHashUtils").sanitisePlaintextHash(b),c);return d("WAResultOrError").makeError("missing_media")})})}});g.getBlobDataUrlByMediaId=a;g.getBlobDataUrlByHashedPlaintextHash=e;g.getBlobDataUrlByPlaintextHash=o}),98);
__d("MAWGetDeviceChangeAlertsByOptionsApi",["MAWDbGetDeviceChangeAlertsByOptionsTxn","MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({deviceChangeAlerts:d("MAWTransactionMode").READWRITE},"getDeviceChangeAlertsByOptions",function(a){return function(b){return d("MAWDbGetDeviceChangeAlertsByOptionsTxn").getDeviceChangeAlertsByOptionsTxn(a,b)}});g.getDeviceChangeAlertsByOptions=a}),98);
__d("MAWGetGroupSuperAdminApi",["MAWDbParticipantTxns","MAWIndexedDb","MAWTransactionMode","WAJids"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({participants:d("MAWTransactionMode").READONLY},"getGroupSuperAdmin",function(a){return function(b){b=d("MAWDbParticipantTxns").getParticipantsInThread(a,b);return b.then(function(a){a=a.filter(function(a){return a.type==="superadmin"});if(a.length!==0&&a[0]){a=a[0];return d("WAJids").extractUserId(a.userJid)}else return null})}});g.getGroupSuperAdmin=a}),98);
__d("MAWGetLatestThreadIdsApi",["MAWDexieTable","MAWIndexedDb","MAWTransactionMode","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h,i;a=d("MAWIndexedDb").makeMsgrTransactor({threads:d("MAWTransactionMode").READONLY},"getLatestThreadIds",function(a){return function(b){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] getLatestThreadIds started"])));b=a.threads.orderBy("threadOrder").reverse().limit(b).toArray();return b.then(function(a){var b=[];a.forEach(function(a){b.push(a.jid.split("@")[0])});d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] getLatestThreadIds complete, threads count: ",""])),b.length);return d("MAWDexieTable").dexieResolve(b)})}});g.getLatestThreadIds=a}),98);
__d("MAWGetMaybeNextNonAdminMsgSortOrderMsApi",["MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWRestoreMsgsTxns","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY},"getMaybeNextNonAdminMsgSortOrderMs",function(a){return function(b,c){return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsg(a,c),d("MAWDbThreadTxns").getThread(a,b)]).then(function(b){var c=b[0];b=b[1];var e=0;if(d("MAWRestoreMsgsTxns").isE2eeOrCutoverAdminMsg(c)&&b.success&&c!=null)return d("MAWRestoreMsgsTxns").getNextMsgBasedOnSortOrderMs(a,b.value,c==null?void 0:c.msgId).then(function(a){a!=null&&a.sortOrderMs!=null&&(e=a.sortOrderMs);return{minMsgTimestampMs:e}});else c!=null&&c.sortOrderMs!=null&&(e=c.sortOrderMs);return{minMsgTimestampMs:e}})}});g.getMaybeNextNonAdminMsgSortOrderMs=a}),98);
__d("MAWGetMediaDownloadStatusApi",["MAWCreateMaybeAddPointForMediaRender","MAWDbChunkTxns","MAWDbMedia","MAWGetMediaApi","MAWIndexedDb","MAWLoggerUtils","MAWMediaDownloadStatus","MAWTransactionMode","MWFBLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=d("MWFBLogger").MWMediaLogger.tags([d("MAWLoggerUtils").Tag.MediaDownload,d("MAWLoggerUtils").Tag.MessageReceive]);a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){b=d("MAWCreateMaybeAddPointForMediaRender").createMaybeAddPointForMediaRender(b);b("get_media_download_status_api_start",{string:{fetch_by:"mediaId"}});b("get_media_download_status_api_get_media_start");var e=(yield d("MAWGetMediaApi").getMediaByMediaId(a));b("get_media_download_status_api_get_media_end",{bool:{has_media:e!=null}});if(e==null){b("get_media_download_status_api_fail",{string:{fail_reason:"media_not_found"}});j.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["getMediaDownloadStatusByMediaId - media not found for mediaId: ",""])),a);return{mainMediaStatus:c("MAWMediaDownloadStatus").MISSING_FILE,mainMediaStatusDetails:"get_by_mediaId_missing_media",previewMediaStatus:c("MAWMediaDownloadStatus").MISSING_FILE,previewMediaStatusDetails:"get_by_mediaId_missing_media"}}b("get_media_download_status_api_get_status_from_media_start");a=(yield k(e));b("get_media_download_status_api_get_status_from_media_end");b("get_media_download_status_api_end");return a});return function(b,c){return a.apply(this,arguments)}}();e=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){b=d("MAWCreateMaybeAddPointForMediaRender").createMaybeAddPointForMediaRender(b);b("get_media_download_status_api_start",{string:{fetch_by:"plaintextHash"}});b("get_media_download_status_api_get_media_start");var e=(yield d("MAWGetMediaApi").getMediaByPlaintextHash(a));b("get_media_download_status_api_get_media_end",{bool:{has_media:e!=null}});if(e==null){b("get_media_download_status_api_fail",{string:{fail_reason:"media_not_found"}});j.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["getMediaDownloadStatusByPlaintextHash - media not found for plaintextHash: ",""])),a);return{mainMediaStatus:c("MAWMediaDownloadStatus").MISSING_FILE,mainMediaStatusDetails:"get_by_mediaPlaintextHash_missing_media",previewMediaStatus:c("MAWMediaDownloadStatus").MISSING_FILE,previewMediaStatusDetails:"get_by_mediaPlaintextHash_missing_media"}}a=(yield k(e));b("get_media_download_status_api_get_status_from_media_end");b("get_media_download_status_api_end");return a});return function(b,c){return a.apply(this,arguments)}}();function k(a){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=(yield m(a));var b=a.hasDownloadedMainMedia,d=a.hasDownloadedThumbnail;a=a.hasThumbnail;return{mainMediaStatus:b?c("MAWMediaDownloadStatus").SUCCESS:c("MAWMediaDownloadStatus").MISSING_FILE,mainMediaStatusDetails:"status_from_media",previewMediaStatus:a?d?c("MAWMediaDownloadStatus").SUCCESS:c("MAWMediaDownloadStatus").MISSING_FILE:void 0,previewMediaStatusDetails:"status_from_media"}});return l.apply(this,arguments)}var m=d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READONLY},"checkMediaDownloadStatus",function(a){return function(b){var c=n(b);return d("MAWDbChunkTxns").hasMediaChunk(a,b.hashedPlaintextHash).then(function(a){return{hasDownloadedMainMedia:a,hasDownloadedThumbnail:(c==null?void 0:c.jpegThumbnail)!=null,hasThumbnail:c!=null}})}});function n(a){var b;switch(a.mediaType){case d("MAWDbMedia").MEDIA_TYPE.IMAGE:return{jpegThumbnail:(b=a.validatedImageInfo)==null?void 0:b.jpegThumbnail};case d("MAWDbMedia").MEDIA_TYPE.VIDEO:return{jpegThumbnail:(b=a.validatedVideoInfo)==null?void 0:b.jpegThumbnail}}}g.getMediaDownloadStatusByMediaId=a;g.getMediaDownloadStatusByPlaintextHash=e}),98);
__d("MAWGetMediaValidationResultApi",["MAWGetMediaApi","MAWVideoAudioValidationUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(a){a=a.validatedResult;return a==null?null:d("MAWVideoAudioValidationUtils").normalizeValidationResult({audioAvgBitsPerSecond:a.audioAvgBitsPerSecond,audioNumberOfChannels:a.audioNumberOfChannels,audioSamplingRate:a.audioSamplingRate,audioStreamType:a.audioStreamType,validatedMimeType:a.validatedMimeType,videoAvgBitsPerSecond:a.videoAvgBitsPerSecond,videoCalculatedFps:a.videoCalculatedFps,videoDuration:a.videoDuration,videoHeight:a.videoHeight,videoNominalFps:a.videoNominalFps,videoStreamType:a.videoStreamType,videoWidth:a.videoWidth})}a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){b=(yield d("MAWGetMediaApi").getMediaByMediaId(a));return b==null?null:h(b)});return function(b,c){return a.apply(this,arguments)}}();c=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){b=(yield d("MAWGetMediaApi").getMediaByPlaintextHash(a));return b==null?null:h(b)});return function(b,c){return a.apply(this,arguments)}}();g.getMediaValidationResultByMediaId=a;g.getMediaValidationResultByPlainTextHash=c}),98);
__d("MAWGetReceiverFetchInfoApi",["MAWDbReceiverFetchTxns","MAWIndexedDb","MAWTransactionMode","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({receiverFetchInfo:d("MAWTransactionMode").READONLY},"MAWGetReceiverFetchInfo",function(a){return function(b){b=b.receiverFetchId;return d("MAWDbReceiverFetchTxns").maybeGetReceiverFetchInfoFromReceiverFetchId(a,b).then(function(a){var b;if(a==null||a.previewUrl==null||a.previewUrlExpirationTimestampMs==null)return;return{accessibilitySummaryText:(b=a.accessibilitySummaryText)!=null?b:void 0,previewUrl:a.previewUrl,previewUrlExpirationTimestampMs:d("WATimeUtils").castLongIntToMillisTime(a.previewUrlExpirationTimestampMs)}})}});g.getReceiverFetchInfo=a}),98);
__d("WADbIdentityTxns",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){return a.identity.bulkGet(b).then(function(a){return a.map(function(a){if(a==null)return;return{id:a.deviceJid,identity:a.identity}}).filter(Boolean)})}f.bulkGetIdentities=a}),66);
__d("WACompareIdentity",["WACryptoUtils","WADbIdentityTxns","WADbSignal","WAJids","WASignalKeys","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield a.meta.bulkGet([d("WADbSignal").MetaKeysEnum.fbid,d("WADbSignal").MetaKeysEnum.deviceId,d("WADbSignal").MetaKeysEnum.identityKeyPair])),c=b[0],e=b[1];b=b[2];c=c==null?void 0:c.value.fbid;e=e==null?void 0:e.value.deviceId;b=b==null?void 0:b.value.identityKeyPair;if(c!=null&&e!=null){c=d("WAJids").toDeviceJid(d("WAJids").toMsgrUserJid(c),e);e=(yield d("WADbIdentityTxns").bulkGetIdentities(a,[c]));if(!(e.length===0)){a=e[0];if((b==null?void 0:b.publicKey)==null)return!0;if(!d("WACryptoUtils").serializedPubKeysEqual(a.identity,d("WASignalKeys").serializePubKey(b)))return!1}return!0}return!0});return h.apply(this,arguments)}g.compareIdentity=a}),98);
__d("WAGetRegistrationInfoApi",["Promise","WACompareIdentity","WADbSignal","WALogger","WASignalDB","WATimeUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;function a(){return d("WASignalDB").getDb().runInTransaction(["meta","identity"],"readonly",function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c,e,f,g,h,j,k,l,m;a=(yield (i||(i=b("Promise"))).all([a.stores.meta.bulkGet([d("WADbSignal").MetaKeysEnum.lastSignedPrekeyId,d("WADbSignal").MetaKeysEnum.deviceUUID,d("WADbSignal").MetaKeysEnum.lastSessionDeviceWasLinkedTo,d("WADbSignal").MetaKeysEnum.regId,d("WADbSignal").MetaKeysEnum.identityKeyPair,d("WADbSignal").MetaKeysEnum.fbid,d("WADbSignal").MetaKeysEnum.deviceId,d("WADbSignal").MetaKeysEnum.registrationVersion,d("WADbSignal").MetaKeysEnum.deviceRegUnixTime,d("WADbSignal").MetaKeysEnum.cat]),d("WACompareIdentity").compareIdentity(a.stores)]));var n=a[0],o=n[0],p=n[1],q=n[2],r=n[3],s=n[4],t=n[5],u=n[6],v=n[7],w=n[8];n=n[9];a=a[1];o=o==null||(c=o.value)==null?void 0:c.lastSignedPrekeyId;p=p==null||(e=p.value)==null?void 0:e.deviceUUID;q=q==null||(f=q.value)==null?void 0:f.lastSessionDeviceWasLinkedTo;r=r==null||(g=r.value)==null?void 0:g.regId;s=s==null||(h=s.value)==null?void 0:h.identityKeyPair;t=t==null||(j=t.value)==null?void 0:j.fbid;u=u==null||(k=u.value)==null?void 0:k.deviceId;v=v==null?void 0:v.value.registrationVersion;w=w==null||(l=w.value)==null?void 0:l.deviceRegUnixTime;n=n==null||(m=n.value)==null||(m=m.cat)==null?void 0:m.expiration_time_in_seconds;return{lastSignedPrekeyId:o,deviceUUID:p,lastSessionDeviceWasLinkedTo:q,regId:r,identityKeyPair:s,registrationUnixTime:w,fbid:t,deviceId:u,registrationVersion:v,identityCompareResult:a,catExpiryUnixTime:n!=null?d("WATimeUtils").castToUnixTime(n):void 0}});return function(b){return a.apply(this,arguments)}}(),d("WASignalDB").signalOp("getRegistrationInfo"))}function c(){return d("WASignalDB").getDb().runInTransaction(["plaintextMeta"],"readonly",function(a){return a.stores.plaintextMeta.get(d("WADbSignal").PlainTextMetaKeysEnum.registrationHistory).then(function(a){return a==null?void 0:a.value.registrationHistory})},"getRegistrationHistory")}var j=10;function e(a){return d("WASignalDB").getDb().runInTransaction(["plaintextMeta"],"readwrite",function(b){return b.stores.plaintextMeta.get(d("WADbSignal").PlainTextMetaKeysEnum.registrationHistory).then(function(c){var e=d("WATimeUtils").unixTime();c=c==null?void 0:c.value.registrationHistory;if(c==null&&a==null)return;var f;if(a!=null)f=[].concat(c!=null?c:[],[{deviceRegTime:a,lastActivityTime:e}]);else{c=c;if(c.length===0){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Registration history log unexpectedly empty"])));return}var g=c[c.length-1];f=[].concat(c.slice(0,-1),[babelHelpers["extends"]({},g,{lastActivityTime:e})])}return b.stores.plaintextMeta.bulkPut([{key:d("WADbSignal").PlainTextMetaKeysEnum.registrationHistory,value:{registrationHistory:f.slice(-j)}}])})},"updateRegistrationHistory")}g.getRegistrationInfo=a;g.getRegistrationHistory=c;g.updateRegistrationHistory=e}),98);
__d("MAWGetRedactedRegistrationInfoForBugnub",["WAGetRegistrationInfoApi","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield d("WAGetRegistrationInfoApi").getRegistrationInfo()),b=a.catExpiryUnixTime;a=a.registrationUnixTime;return{catExpiryUnixTime:b,registrationUnixTime:a}});return h.apply(this,arguments)}g.getRedactedRegistrationInfoForBugnub=a}),98);
__d("MessengerInfraReport",["gkx"],(function(a,b,c,d,e,f,g){"use strict";var h={};a=function(){for(var a of Object.keys(h))delete h[Number(a)]};b=function(){return c("gkx")("23390")};var i=20;d=function(a,b,c){var d=h[a];if(!d){h[a]=new Map([[c,babelHelpers["extends"]({},b,{latestTimestampMs:Date.now(),startTimestampMs:Date.now()})]]);return}var e=d.get(c);if(e!=null){d.set(c,babelHelpers["extends"]({},e,b,{latestTimestampMs:Date.now()}));return}if(d.size>=i){h[a]=new Map([[c,babelHelpers["extends"]({},b,{latestTimestampMs:Date.now(),startTimestampMs:Date.now()})]]);return}d.set(c,babelHelpers["extends"]({},b,{latestTimestampMs:Date.now(),startTimestampMs:Date.now()}))};e=function(a,b){return(a=h[a])==null?void 0:a.get(b)};f=function(a,b){(a=h[a])==null||a["delete"](b)};g.reportedEvents=h;g.clearReportedEvents=a;g.isEPD=b;g.MAX_SIZE=i;g.storeEventData=d;g.getEventData=e;g.deleteEventData=f}),98);
__d("MAWGetReportedQplEvents",["MessengerInfraReport","Promise"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(){return(h||(h=b("Promise"))).resolve(d("MessengerInfraReport").reportedEvents)};g.getReportedQplEvents=a}),98);
__d("MAWGetSecureThreadTotalCount",["MAWTransactionMode","MAWTransactor"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWTransactor").makeMsgrTransactor({threads:d("MAWTransactionMode").READONLY},"getSecureThreadTotalCount",function(a){return function(){return a.threads.count()}});g.getSecureThreadTotalCount=a}),98);
__d("MAWGetSecurityAlertSettingApi",["MAWDbMsgTypeVersionTxns","MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({appMeta:d("MAWTransactionMode").READONLY},"getSecurityAlertSetting",function(a){return function(){return d("MAWDbMsgTypeVersionTxns").getSecuritySettingForContact(a)}});g.getSecurityAlertSetting=a}),98);
__d("MAWGetSecurityAlertSettingForSelfAndContactApi",["MAWDbMsgTypeVersionTxns","MAWTransactionMode","MAWTransactor"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWTransactor").makeMsgrTransactor({appMeta:d("MAWTransactionMode").READONLY},"getSecurityAlertSettingForSelfAndContact",function(a){return function(){return d("MAWDbMsgTypeVersionTxns").maybeBulkGetSecuritySetting(a)}});g.getSecurityAlertSettingForSelfAndContact=a}),98);
__d("MAWGetThreadConsistencyInfo",["MAWDexieTable","MAWGetThreadUpdateType","MAWIndexedDb","MAWThreadSnippetUtils","MAWThreadUpdateType","MAWTransactionMode","err"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY,reactions:d("MAWTransactionMode").READONLY,xma:d("MAWTransactionMode").READONLY},"getThreadConsistencyInfo",function(a){return function(b){if(b.action==="GET_SNIPPETS_INFO")return d("MAWDexieTable").dexieAll(b.chatJids.map(function(b){return d("MAWThreadSnippetUtils").getThreadSnippetFromScratch(a,b)})).then(function(a){return{snippetsInfo:a}});if(b.action==="MSG_ELIGIBLE_FOR_SNIPPET_RECALCULATION")return a.messages.get({msgId:b.msgId,threadJid:b.chatJid}).then(function(a){var b=null;a!=null&&(b=d("MAWGetThreadUpdateType").getThreadUpdateTypeForMsg(a));return{isSnippetEligible:b!==d("MAWThreadUpdateType").THREAD_UPDATE_TYPE.NO_SNIPPET_OR_ACTIVITY_TS_UPDATE}});throw c("err")("Invalid params type")}});g.getThreadConsistencyInfo=a}),98);
__d("MAWGetThreadLastMessageTsApi",["MAWDbMsgTxns","MAWIndexedDb","MAWTransactionMode","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY},"getThreadLastMessageTs",function(a){return function(b){return a.threads.get({authoritativeThreadKey:b}).then(function(b){if(b==null)return;return d("MAWDbMsgTxns").getThreadNewestMessageBySortOrder(a,b.jid).then(function(a){return a==null?null:d("WATimeUtils").castUnixTimeToMillisTime((a=a.serverTs)!=null?a:d("WATimeUtils").castToUnixTime(0))})})}});g.getThreadLastMessageTs=a}),98);
__d("MAWGetThreadLastNumMessagesBySortOrderApi",["MAWDbMsgTxns","MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READONLY},"getThreadLastNumMessagesBySortOrder",function(a){return function(b,c){return a.threads.get({authoritativeThreadKey:b}).then(function(b){return b==null?[]:d("MAWDbMsgTxns").getThreadNewestNumMessagesBySortOrder(a,b.jid,c)})}});g.getThreadLastNumMessagesBySortOrder=a}),98);
__d("MAWGetThreadsInfoApi",["MAWDbThreadTxns","MAWIndexedDb","MAWTransactionMode","WALogger"],(function(a,b,c,d,e,f,g){"use strict";var h;a=d("MAWIndexedDb").makeMsgrTransactor({threads:d("MAWTransactionMode").READONLY},"getThreadIdByDeduplicationKey",function(a){return function(b){d("WALogger").DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose(["getThreadIdByDeduplicationKey ",""])),b);return d("MAWDbThreadTxns").getThreadByDeduplicationKey(a,b).then(function(a){return a.success?{jid:a.value.jid}:null})}});g.getThreadIdByDeduplicationKey=a}),98);
__d("blobToDataUri",["Promise","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var d=new FileReader(),e=new(h||(h=b("Promise")))(function(a,b){d.onloadend=a,d.onerror=b});d.readAsDataURL(a);yield e;a=d.result;if(typeof a!=="string")throw c("err")('Unexpected result type "%s" when reading Blob as DataURL.',a instanceof ArrayBuffer?"ArrayBuffer":typeof a);return a});return i.apply(this,arguments)}g["default"]=a}),98);
__d("MAWGetThumbnailBlobDataUrlByMediaIdApi",["MAWCreateMaybeAddPointForMediaRender","MAWDbChunkTxns","MAWDbMedia","MAWDbMediaTxns","MAWIndexedDb","MAWMaybeWithTimeout","MAWMediaManager","MAWMediaPreviewDownloadManager","MAWMpsGating","MAWTransactionMode","MWFBLogger","Promise","WAErrorMessage","WAHashUtils","WAMediaManager","WAResultOrError","WAStartMediaDownloadQplFlow","asyncToGeneratorRuntime","blobToDataUri"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D=d("MWFBLogger").MWMediaLogger.tags(["getThumbnailBlobDataUrlByMediaId"]);a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){D.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Get thumbnail blob for "," from , from ",""])),a,b);var f=d("MAWCreateMaybeAddPointForMediaRender").createMaybeAddPointForMediaRender(e),g={string:{description:b,fetch_by:"mediaId"}};f("fetch_thumbnail_blob_api_start",g);f("get_media_from_db_start",g);var q=(yield G(a));f("get_media_from_db_finish",{bool:{db_media_found:q!=null}});if(q==null){D.WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["No media found for ",""])),a);f("fetch_thumbnail_blob_api_fail_no_media_found_in_db",g);throw D.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because media is not in the media db. mediaId is %s, from %s",a,b)}var r=I(q);if(r.success===!0){D.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Found jpegThumbnail entry for ",""])),a);f("fetch_thumbnail_blob_api_success",g);var s=(yield c("blobToDataUri")(r.value));if(!Boolean(s)){D.MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Failed to create thumbnail data uri from blob for ",""])),a);f("fetch_thumbnail_blob_api_fail_no_data_uri",g);throw D.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because data uri is null. mediaId is %s, from %s",a,b)}D.DEBUG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Returning data uri for ",""])),a);return s}s=r.error;switch(s){case"missing_jpeg_thumbnail":if(q.mediaType===d("MAWDbMedia").MEDIA_TYPE.IMAGE||q.mediaType===d("MAWDbMedia").MEDIA_TYPE.VIDEO){r=(yield E(q,e));if(r!=null){f("fetch_thumbnail_blob_api_success",g);s=(yield c("blobToDataUri")(r));if(!Boolean(s)){D.MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Failed to create thumbnail data uri from blob for ",""])),a);f("fetch_thumbnail_blob_api_fail_no_data_uri",g);throw D.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because data uri is null. mediaId is %s, from %s",a,b)}D.DEBUG(n||(n=babelHelpers.taggedTemplateLiteralLoose(["Returning data uri for ",""])),a);return s}if((q==null?void 0:q.mediaType)===d("MAWDbMedia").MEDIA_TYPE.VIDEO){f("fetch_thumbnail_blob_api_fail_not_able_to_generate_video_thumbnail_on_the_fly",g);throw D.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId in time (for video). mediaId is %s, from %s",a,b)}r=(yield F(q,e));if(r==null){f("fetch_thumbnail_blob_api_fail_not_able_to_generate_image_thumbnail_on_the_fly",g);throw D.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId in time or to generate thumnbail on the fly. mediaId is %s, from %s",a,b)}f("fetch_thumbnail_blob_api_success",g);s=(yield c("blobToDataUri")(r));if(!Boolean(s)){D.MUSTFIX(o||(o=babelHelpers.taggedTemplateLiteralLoose(["Failed to create thumbnail data uri from blob for ",""])),a);f("fetch_thumbnail_blob_api_fail_no_data_uri",g);throw D.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because data uri is null. mediaId is %s, from %s",a,b)}D.DEBUG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Returning data uri for ",""])),a);return s}f("fetch_thumbnail_blob_api_fail_missing_thumbnail",g);throw D.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId, invalid media (missing_jpeg_thumbnail). mediaId is %s, from %s",a,b);case"invalid_media":f("fetch_thumbnail_blob_api_fail_invalid_media",g);throw D.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId, invalid media. mediaId is %s, from %s",a,b)}});return function(b,c,d){return a.apply(this,arguments)}}();e=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){var f=d("MAWCreateMaybeAddPointForMediaRender").createMaybeAddPointForMediaRender(e),g={string:{description:b,fetch_by:"hashedPlaintextHash"}};f("fetch_thumbnail_blob_api_start",g);D.DEBUG(q||(q=babelHelpers.taggedTemplateLiteralLoose(["Get thumbnail blob for "," from ",""])),d("WAHashUtils").sanitisePlaintextHash(a),b);if(d("MAWMpsGating").isFullMpsEnabled()){var h=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"UILayout",msgType:null,protocolMsgId:null,triggerUIView:null}),i=(yield d("MAWMediaManager").getMawMediaManager().enqueueDownloadPreview({fullSizePlaintextHash:a,mediaDownloadFlow:h,priority:d("WAMediaManager").MediaTaskPriority.HIGH}));if(i.success){var j=i.value.validatedResult.validatedPlaintext;j=new Blob([j],{type:(j=i.value.validatedResult.mimeType)!=null?j:void 0});j=(yield c("blobToDataUri")(j));return j}if(i.error!=="preview-not-supported")throw d("MWFBLogger").MPSLogger.mustfixThrow("Failed to getThumbnailBlobDataUrlByHashedPlaintextHash. plaintextHash is %s, from %s, error: %s",d("WAHashUtils").sanitisePlaintextHash(a),b,i.error);j=(yield d("MAWMediaManager").getMawMediaManager().enqueueDownloadFullSize({fullSizePlaintextHash:a,mediaDownloadFlow:h,priority:d("WAMediaManager").MediaTaskPriority.HIGH}));if(j.success){h=j.value.validatedResult.validatedPlaintext;j=new Blob([h],{type:(h=j.value.validatedResult.mimeType)!=null?h:void 0});h=(yield c("blobToDataUri")(j));return h}throw d("MWFBLogger").MPSLogger.mustfixThrow("Failed to getThumbnailBlobDataUrlByHashedPlaintextHash. plaintextHash is %s, from %s, error: %s",d("WAHashUtils").sanitisePlaintextHash(a),b,i.error)}j=(yield H(a));if(j==null){D.WARN(r||(r=babelHelpers.taggedTemplateLiteralLoose(["No media found for ",""])),d("WAHashUtils").sanitisePlaintextHash(a));f("fetch_thumbnail_blob_api_fail_no_media_found_in_db",g);throw D.mustfixThrow("Failed to getThumbnailBlobDataUrlByHashedPlaintextHash because media is not in the media db. plaintextHash is %s, from %s",d("WAHashUtils").sanitisePlaintextHash(a),b)}h=I(j);if(h.success===!0){D.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Found jpegThumbnail entry for ",""])),d("WAHashUtils").sanitisePlaintextHash(a));f("fetch_thumbnail_blob_api_success",g);i=(yield c("blobToDataUri")(h.value));if(!Boolean(i)){D.MUSTFIX(t||(t=babelHelpers.taggedTemplateLiteralLoose(["Failed to create thumbnail data uri from blob for ",""])),d("WAHashUtils").sanitisePlaintextHash(a));f("fetch_thumbnail_blob_api_fail_no_data_uri",g);throw D.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because data uri is null. plaintextHash is %s, from %s",d("WAHashUtils").sanitisePlaintextHash(a),b)}D.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Returning data uri for ",""])),d("WAHashUtils").sanitisePlaintextHash(a));return i}i=h.error;switch(i){case"missing_jpeg_thumbnail":if(j.mediaType===d("MAWDbMedia").MEDIA_TYPE.IMAGE||j.mediaType===d("MAWDbMedia").MEDIA_TYPE.VIDEO){h=(yield E(j,e));if(h!=null){f("fetch_thumbnail_blob_api_success",g);i=(yield c("blobToDataUri")(h));if(!Boolean(i)){D.MUSTFIX(v||(v=babelHelpers.taggedTemplateLiteralLoose(["Failed to create thumbnail data uri from blob for ",""])),d("WAHashUtils").sanitisePlaintextHash(a));f("fetch_thumbnail_blob_api_fail_no_data_uri",g);throw D.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because data uri is null. plaintextHash is %s, from %s",d("WAHashUtils").sanitisePlaintextHash(a),b)}D.DEBUG(w||(w=babelHelpers.taggedTemplateLiteralLoose(["Returning data uri for ",""])),d("WAHashUtils").sanitisePlaintextHash(a));return i}if((j==null?void 0:j.mediaType)===d("MAWDbMedia").MEDIA_TYPE.VIDEO){f("fetch_thumbnail_blob_api_fail_not_able_to_generate_video_thumbnail_on_the_fly",g);throw D.mustfixThrow("Failed to getThumbnailBlobDataUrlByHashedPlaintextHash in time (for video). plaintextHash is %s, from %s",d("WAHashUtils").sanitisePlaintextHash(a),b)}h=(yield F(j,e));if(h==null){f("fetch_thumbnail_blob_api_fail_not_able_to_generate_image_thumbnail_on_the_fly",g);throw D.mustfixThrow("Failed to getThumbnailBlobDataUrlByHashedPlaintextHash in time or to generate thumnbail on the fly. plaintextHash is %s, from %s",d("WAHashUtils").sanitisePlaintextHash(a),b)}i=(yield c("blobToDataUri")(h));if(!Boolean(i)){D.MUSTFIX(x||(x=babelHelpers.taggedTemplateLiteralLoose(["Failed to create thumbnail data uri from blob for ",""])),d("WAHashUtils").sanitisePlaintextHash(a));f("fetch_thumbnail_blob_api_fail_no_data_uri",g);throw D.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId because data uri is null. plaintextHash is %s, from %s",d("WAHashUtils").sanitisePlaintextHash(a),b)}D.DEBUG(y||(y=babelHelpers.taggedTemplateLiteralLoose(["Returning data uri for ",""])),d("WAHashUtils").sanitisePlaintextHash(a));return i}f("fetch_thumbnail_blob_api_fail_missing_thumbnail",g);throw D.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId, invalid media (missing_jpeg_thumbnail). plaintextHash is %s, from %s",d("WAHashUtils").sanitisePlaintextHash(a),b);case"invalid_media":f("fetch_thumbnail_blob_api_fail_invalid_media",g);throw D.mustfixThrow("Failed to getThumbnailBlobDataUrlByMediaId, invalid media. plaintextHash is %s, from %s",d("WAHashUtils").sanitisePlaintextHash(a),b)}});return function(b,c,d){return a.apply(this,arguments)}}();var E=function(a,c){var e=d("MAWCreateMaybeAddPointForMediaRender").createMaybeAddPointForMediaRender(c);e("fetch_thumbnail_blob_api_thumbnail_download_start");c=d("MAWMediaPreviewDownloadManager").getMediaPreviewDownloadingResolvable(a.plaintextHash);if(c==null){e("fetch_thumbnail_blob_api_thumbnail_download_fail_no_resolvable");return(C||(C=b("Promise"))).resolve(null)}return d("MAWMaybeWithTimeout").maybeWithTimeout(c.promise,1e4,function(){throw D.mustfixThrow("timeout waiting for thumbnail to download")}).then(function(a){e("fetch_thumbnail_blob_api_thumbnail_download_success");return a})["catch"](function(a){a=d("WAErrorMessage").maybeGetMessageFromError(a);D.MUSTFIX(z||(z=babelHelpers.taggedTemplateLiteralLoose(["Exception when waiting for thumbnail to download: ",""])),a);e("fetch_thumbnail_blob_api_thumbnail_download_fail_exception",{string:{wait_for_thumbnail_download_exception:a}});return null})},F=d("MAWIndexedDb").makeMsgrTransactor({chunk:(f=d("MAWTransactionMode")).READONLY,media:f.READONLY},"generateThumbnailFromMediaChunk",function(a){return function(b,c){var e=d("MAWCreateMaybeAddPointForMediaRender").createMaybeAddPointForMediaRender(c);e("fetch_thumbnail_blob_api_thumbnail_generate_from_media_start");return d("MAWDbChunkTxns").maybeGetChunkFromHash(a,b.hashedPlaintextHash).then(function(a){if(a==null){D.MUSTFIX(A||(A=babelHelpers.taggedTemplateLiteralLoose(["getImageThumbnail: unable to get a thumbnail as the media chunk is missing"])));e("fetch_thumbnail_blob_api_thumbnail_generate_from_media_fail_chunk_missing");return}D.WARN(B||(B=babelHelpers.taggedTemplateLiteralLoose(["getImageThumbnail: using media chunk as the thumbnail"])));e("fetch_thumbnail_blob_api_thumbnail_generate_from_media_success");return new Blob([a.blobData],{type:a.mimetype})})}}),G=d("MAWIndexedDb").makeMsgrTransactor({media:f.READONLY},"getFullMedia",function(a){return function(b){return d("MAWDbMediaTxns").maybeGetMediaFromMediaId(a,b)}}),H=d("MAWIndexedDb").makeMsgrTransactor({media:f.READONLY},"getFullMedia",function(a){return function(b){return d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(a,b)}}),I=function(a){a=J(a);if(a.success===!1)return a;a=a.value.jpegThumbnail;return a!=null?d("WAResultOrError").makeResult(new Blob([a],{type:"image/jpeg"})):d("WAResultOrError").makeError("missing_jpeg_thumbnail")},J=function(a){var b;switch(a.mediaType){case d("MAWDbMedia").MEDIA_TYPE.IMAGE:return d("WAResultOrError").makeResult({jpegThumbnail:(b=a.validatedImageInfo)==null?void 0:b.jpegThumbnail});case d("MAWDbMedia").MEDIA_TYPE.VIDEO:return d("WAResultOrError").makeResult({jpegThumbnail:(b=a.validatedVideoInfo)==null?void 0:b.jpegThumbnail});case d("MAWDbMedia").MEDIA_TYPE.PTT:case d("MAWDbMedia").MEDIA_TYPE.STICKER:case d("MAWDbMedia").MEDIA_TYPE.GIF:case d("MAWDbMedia").MEDIA_TYPE.DOCUMENT_FILE:return d("WAResultOrError").makeError("invalid_media");default:a.mediaType;return d("WAResultOrError").makeError("invalid_media")}};g.getThumbnailBlobDataUrlByMediaId=a;g.getThumbnailBlobDataUrlByHashedPlaintextHash=e}),98);
__d("MAWGetWAIDevices",["WADevicesState","WAGlobals","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.users;yield d("WAGlobals").getWaOneQueue().waitForWAInfraOfflineSyncEnd();yield d("WADevicesState").getDevicesState().waitForUserDevices(b,"getWAIDevices");a=(yield d("WAGlobals").getWaOneQueue().enqueue(function(a){a=a.cryptoManager;return a.storage.bulkLoadIdentities(b)},{afterInit:!0,flush:!1,operationType:"maw_load_identities"}));var c=[];if(a.size===0)c=[].concat(b);else for(var e of a){var f=e[0],g=e[1];g.size===0&&c.push(f)}c.length>0&&(yield d("WADevicesState").getDevicesState().waitForUserDevices(c,"getWAIDevices",!0),a=(yield d("WAGlobals").getWaOneQueue().enqueue(function(a){a=a.cryptoManager;return a.storage.bulkLoadIdentities(b)},{afterInit:!0,flush:!1,operationType:"maw_load_identities"})));g=new Map();for(f of a){e=f[0];c=f[1];g.set(e,Array.from(c.keys()))}return g});return h.apply(this,arguments)}g.getWAIDevices=a}),98);
__d("MAWGetWATimeApi",["Promise","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(){return(h||(h=b("Promise"))).resolve({clockSkew:d("WATimeUtils").getClockSkew(),millisTime:d("WATimeUtils").millisTime(),unixTime:d("WATimeUtils").unixTime()})};g.getWATime=a}),98);
__d("MAWGetWorkerHeartbeatApi",["Promise"],(function(a,b,c,d,e,f){"use strict";var g;a=function(){return(g||(g=b("Promise"))).resolve(!0)};f.getWorkerHeartbeat=a}),66);
__d("MAWLowLevelMediaDownloadQplBridgeHandler",["MAWDownloadAndRestoreMedia"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,c,e){b=d("MAWDownloadAndRestoreMedia").getMediaDownloadFlow(b,e);switch(a){case"success":b.endSuccess();break;case"fail":b.endFail(c,e);break;case"point":b.addPoint(c,e);break}}g.handleBridgeMediaDownloadQPL=a}),98);
__d("MAWHandleMediaRestoreCdnUrlResult",["EncryptedBackupsResignCdnUrl","MAWLowLevelMediaDownloadQplBridgeHandler","MWFBLogger","Promise","WADirectPath","WAPromiseDelays","WAResultOrError","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o=d("MWFBLogger").MWMediaLogger.tags(["RestoreCdnUrlThroughSproc"]);function a(a){var e;e=(e=(e=a.value)==null?void 0:e.rawTraceId)!=null?e:(e=a.error)==null?void 0:e.rawTraceId;if(e==null){var f;o.MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["handleMediaRestoreCdnUrlResult: traceId is null. success: ",", error: ",""])),a.success,a.success?"":(f=a.error.errorMessage)!=null?f:"");return}f=isNaN(parseInt(e,10))?null:parseInt(e,10);if(f==null){var g;o.MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["handleMediaRestoreCdnUrlResult: traceId is not a number. success: ",", error: ",""])),a.success,a.success?"":(g=a.error.errorMessage)!=null?g:"");return}g=o.tags([e]);e=d("EncryptedBackupsResignCdnUrl").getRestoredCdnUrlResolvable(f);if(e==null){o.MUSTFIX(j||(j=babelHelpers.taggedTemplateLiteralLoose(["handleMediaRestoreCdnUrlResult: restoredCdnUrlResolvable is null}"])));return}if(!a.success){var q;g.MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["handleMediaRestoreCdnUrlResult request error: ",""])),(q=a.error.errorMessage)!=null?q:"");e==null||e.resolve(d("WAResultOrError").makeError("resign-cdn-url-request-error"));e==null&&p(f,a.error.errorMessage);return}q=d("WADirectPath").validateDirectPath(a.value.rawDirectPath);if(!q.success){g.WARN(l||(l=babelHelpers.taggedTemplateLiteralLoose(["handleMediaRestoreCdnUrlResult direct path error: ",""])),q.error);e==null||e.resolve(q);return}f=q.value;o.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["handleMediaRestoreCdnUrlResult success. directPath: ",""])),f);void (n||(n=b("Promise"))).race([(a=e==null?void 0:e.resolve(d("WAResultOrError").makeResult(f)))!=null?a:(n||(n=b("Promise"))).resolve(),d("WAPromiseDelays").delayMs(c("justknobx")._("4255"))])}function p(a,b){d("MAWLowLevelMediaDownloadQplBridgeHandler").handleBridgeMediaDownloadQPL("fail",a,"attachment_restore_failure",{string:{error:b!=null?b:""}})}g.handleMediaRestoreCdnUrlResult=a}),98);
__d("MAWIdentifyCollapsedMessagesByExternalId",["MAWDbMsgTxns","MAWIndexedDb","MAWTransactionMode","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.externalIds;a=(yield d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY},"identifyCollapsedMessagesByExternalId",function(a){return function(){return d("MAWDbMsgTxns").UNSAFE_getMultipleMsgsByExternalId(a,b)}})());return a.filter(function(a){return a.isCollapsed===!0}).map(function(a){return a.externalId})});return h.apply(this,arguments)}g.identifyCollapsedMessagesByExternalId=a}),98);
__d("MAWIdentifyXMAWithAssociatedTextByExternalId",["MAWDbXMATxns","MAWIndexedDb","MAWTransactionMode","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.externalIds;a=(yield d("MAWIndexedDb").makeMsgrTransactor({xma:d("MAWTransactionMode").READONLY},"identifyXMAWithAssociatedTextByExternalId",function(a){return function(){return d("MAWDbXMATxns").getMultipleXMAByExternalId(a,b)}})());return a.filter(function(a){return a.associatedMessageId!=null}).map(function(a){return a.externalId})});return h.apply(this,arguments)}g.identifyXMAWithAssociatedTextByExternalId=a}),98);
__d("MAWInsertAdminMessageInCutoverThreadsApi",["MAWAdminWriteCutoverThreadMsgTxn","MAWDbThreadTxns","MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,ftsBackloggedMessages:a.READWRITE,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,threads:a.READWRITE},"insertAdminMessageInCutoverThreads",function(a){return function(b){var c=b.openThreadId,e=b.threadJid;b=b.traceId;return d("MAWAdminWriteCutoverThreadMsgTxn").writeCutoverThreadAdminMsg(a,e,c,b).then(function(b){b=b.needsMarkThreadAsMigrated;if(b)return d("MAWDbThreadTxns").markCutoverThreadAsMigratedLocally(a,e)}).then(function(){return!0})}});g.insertAdminMessageInCutoverThreads=b}),98);
__d("MAWLoadMediaApi",["FBLogger","LSThreadMediaGalleryGroup","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsg","MAWDexieTable","MAWIndexedDb","MAWMediaAfterTxns","MAWTransactionMode","WAHashUtils","WALogger","WATimeUtils","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=c("justknobx")._("1132");b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,media:a.READONLY,messages:a.READONLY,threads:a.READONLY},"loadMoreMedia",function(a){return function(b){var e=b.earliestLoadedMediaMessageId,f=b.earliestLoadedMediaTs,g=b.mediaGalleryGroup,m=b.pageSize,n=b.threadJid,o=0,p=!1,q=0,r=!1,s=m!=null?m:k;return a.threads.get({jid:n}).then(function(b){if(b==null)throw d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Unable to load media for thread. ThreadJid "," does not exist"])),n);b=a.messages.where(["threadJid","sortOrderMs"]).between([b.jid,d("MAWDbMsg").MIN_MSG_SORT_ORDER],[b.jid,f],!0,!0);return b.filter(function(a){return l(a,g)}).until(t).reverse().toArray()}).then(function(b){var f,h=b.findIndex(function(a){return a.msgId===e});h=p?h+1:0;b=b.slice(h,h+s+1);h=r;var k=b[b.length-1],l=Number.MAX_SAFE_INTEGER;f=(f=k==null?void 0:k.sortOrderMs)!=null?f:l;d("MAWIndexedDb").afterTransaction({tag:"NewMediaRange",value:{earliestLoadedMediaTs:f,hasMoreBefore:h,lastLoadedMessageId:(l=k==null?void 0:k.msgId)!=null?l:e,mediaGalleryGroup:g,threadJid:n}});d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[loadMoreMedia] foundMessages: ",""])),b.map(function(a){return""+a.msgId}));return d("MAWDbMediaTxns").getMsgMediaPairFromMsgs(a,b).then(function(b){d("WALogger").LOG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[loadMoreMedia] msgMediaPairs: ",""])),b.map(function(a){var b=a[0];a=a[1];return"["+b.msgId+", "+d("WAHashUtils").sanitisePlaintextHash(a.plaintextHash)+"]"}));return d("MAWDexieTable").dexieAll(b.map(function(b){var e=b[0],f=b[1];return d("MAWDbChunkTxns").hasMediaChunk(a,f.hashedPlaintextHash).then(function(b){b||c("FBLogger")("messenger_web_media").warn("loadMoreMedia cannot find chunk for mediaId: %s",f.mediaId);return d("MAWMediaAfterTxns").handleNewMediaAfterTxn(e,f,b,a,!0)})})).then(function(){})})});function t(a){o++;a.msgId===e?p=!0:(p||f===Number.MAX_SAFE_INTEGER)&&q++;if(q>s){r=!0;return!0}if(o>s&&!p&&a.sortOrderMs!==f){r=!0;return!0}return!1}}});function l(a,b){var e=d("WATimeUtils").unixTime(),f=!1;switch(b){case c("LSThreadMediaGalleryGroup").PHOTOS_AND_VIDEOS:f=d("MAWDbMsg").isPhotoOrVideoMediaMsg(a);break;case c("LSThreadMediaGalleryGroup").FILES_ONLY:f=d("MAWDbMsg").isDocumentFileMediaMsg(a);break;case c("LSThreadMediaGalleryGroup").LINKS:f=d("MAWDbMsg").isXMAMsg(a);break}b=a.messageExpirationTs==null||a.messageExpirationTs>e;return f&&b}g.loadMoreMedia=b;g.filterForMediaMessages=l}),98);
__d("WAWaitPromiseUntil",["Promise"],(function(a,b,c,d,e,f){"use strict";var g;function a(a,c){var d=new(g||(g=b("Promise")))(function(a){return void setTimeout(a,c)});return g.race([a.then(function(a){return{result:a}}),d.then(function(){return"timeout"})])}f.waitPromiseUntil=a}),66);
__d("MAWLoadMoreScheduler",["FBLogger","MAWEBLSInWorkerSwitch","MAWLoadMsgsApi","MAWMessagesDirection","MawMpsCop","MpsTypes","WALogger","WAResultOrError","WAWaitPromiseUntil","WorkerScheduler","asyncToGeneratorRuntime","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h,i=5,j=c("justknobx")._("4600"),k=c("justknobx")._("4703"),l;function m(){l==null&&(l=d("WorkerScheduler").makeScheduler("load-more",{concurrency:10,defaultSamplingRate:1e3,maxConcurrency:10,maxThrottleMs:0}));return l}function a(a){var b=a.actionType,c=a.chatJid,e=a.config,f=a.direction,g=a.externalId,h=a.includeOriginalMsg,i=a.msgId,j=a.numMsgs,k=a.sortOrderMs;return n({actionType:b,chatJid:c,direction:f,externalId:g,loadFn:function(){return d("MAWLoadMsgsApi").loadMsgsFromTs(c,j,f,k,h,i,e)},numMsgs:j,timestamp:k})}function e(a){return d("WAWaitPromiseUntil").waitPromiseUntil(c("MAWEBLSInWorkerSwitch").waitForEBEnabled(),k).then(function(c){if(c==="timeout")return;return m().runTask({customFlags:{runtimeReliability:!0},fn:function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield q(a.actionType,a.config.map(function(a){var b=a.chatJid,c=a.direction,e=a.lowerBoundExternalId,f=a.lowerBoundSortOrderMs;a=a.numMsgs;return{chatJid:b,direction:c,messageId:e!=null?d("MpsTypes").toMessageId(e):null,numMsgs:a,timestamp:d("MpsTypes").toTimestamp(f!=null?f:Date.now())}}))});function e(){return c.apply(this,arguments)}return e}(),name:"loadMessagesByChatJids",priority:d("WorkerScheduler").BLOCKING_PRIORITY})})}function f(a){var b=a.chatJid,c=a.config,e=a.direction,f=a.range;return n({actionType:a.actionType,chatJid:b,direction:e,externalId:f.lowerBoundExternalId,loadFn:function(){return d("MAWLoadMsgsApi").loadMsgsRange(b,c,e,f)},numMsgs:f.numMsgs,timestamp:f.lowerBoundSortOrderMs})}function n(a){return m().runTask({customFlags:{runtimeReliability:!0},fn:function(){try{var b;return s(a.actionType,a.chatJid,a.direction,a.numMsgs,d("MpsTypes").toTimestamp((b=a.timestamp)!=null?b:Date.now()),a.externalId!=null?d("MpsTypes").toMessageId(a.externalId):null,a.loadFn)}catch(a){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["LoadMoreMsgs from COP fails: ",""])),a)}return a.loadFn()},name:"maw_load_msgs",priority:d("WorkerScheduler").BLOCKING_PRIORITY})}function o(a){return a.hasNext===!0&&a.endCursor!=null?{cursor:a.endCursor,hasMore:!0}:{hasMore:!1}}function p(a,b,c){switch(b){case"before":b=c.msgs[c.msgs.length-1];return b.sortOrderMs>=a[0];case"after":b=c.msgs[0];return b.sortOrderMs<=a[0]}}function q(a,b){return r.apply(this,arguments)}function r(){r=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){yield d("MawMpsCop").mpsCop().loadBatchMsgsIntoMaw({debug:{purpose:"cop-load-batch-"+(a!=null?a:"")},ranges:b.map(function(a){var b=a.chatJid,c=a.direction,e=a.messageId,f=a.numMsgs;a=a.timestamp;return{direction:d("MAWMessagesDirection").translateMawDirectionToMwpDirection(c),from:[a,e],numMessages:f+j,threadId:d("MpsTypes").toThreadId(b)}})})});return r.apply(this,arguments)}function s(a,b,c,d,e,f,g){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,h,k){var l=c("FBLogger")("mps").tags(["MAW","loadMore"]);if(f===0)return k();g=[g,h];for(h=0;h<i;h++){h>1&&c("FBLogger")("mps").warn("MAW MPS Iteration %s Direction %s",h,e);var m=(yield d("MawMpsCop").mpsCop().loadMoreMsgsIntoMaw({debug:{purpose:"cop-load-more-"+(a!=null?a:"")},direction:d("MAWMessagesDirection").translateMawDirectionToMwpDirection(e),from:g,numMessages:f+j,threadId:d("MpsTypes").toThreadId(b)})["catch"](function(a){l.catching(a).mustfix("Failed to load more messages from MPS");return d("WAResultOrError").makeError("runtime-error")}));if(m.success===!1){l.warn("MPS Failed with result: %s",m.error);break}m=o(m.value.cursorInfo);var n=(yield k());if(m.hasMore===!1)return n;g=m.cursor;if(n.msgs.length<f)continue;if(p(m.cursor,e,n)===!1)continue;return n}l.warn("Returning best-effort loadMessages from MAW");return k()});return t.apply(this,arguments)}g.loadMoreScheduler=m;g.loadMoreMessages=a;g.loadMessagesByChatJidsIntoMaw=e;g.loadMoreMsgsRange=f}),98);
__d("MAWMarkBackupAsCompleted",["EncryptedBackupsUploadQueue"],(function(a,b,c,d,e,f,g){"use strict";function a(a){a=a.queueId;var b=d("EncryptedBackupsUploadQueue").ebUploadQueue();return b.ack([a])}g.markBackupAsCompleted=a}),98);
__d("MAWMarkThreadAsUnreadApi",["MAWDbMsgTxns","MAWIndexedDb","MAWThreadUtils","MAWTimeUtils","MAWTransactionMode","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({messages:d("MAWTransactionMode").READONLY,threads:d("MAWTransactionMode").READWRITE},"markThreadAsUnread",function(a){return function(b){return a.threads.get({jid:b}).then(function(c){if(c==null)return;return d("MAWDbMsgTxns").getThreadNewestMessageMs(a,c.jid).then(function(c){var e=d("MAWTimeUtils").ensureValidMillisTime(c),f=d("WATimeUtils").castToMillisTime(0);if(e==null||c===f)return;e={lastReadMsg:null};return d("MAWThreadUtils").updateThreadWithJid(a,b,e).then(function(){})})})}});g.markThreadAsUnread=a}),98);
__d("MAWMediaSizeCheck",[],(function(a,b,c,d,e,f){"use strict";function a(a){return a>100*1024}f.isMinSizeForImagePreviewGeneration=a}),66);
__d("MAWUploadAndHandleMedia",["FBLogger","MAWMediaManager","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=c("FBLogger")("messenger_web_media");function a(a){var b=a.chatJid,c=a.dbCallbacks,d=a.filename,e=a.hash,f=a.plaintext,g=a.protocolMsgId,h=a.serverMediaType,i=a.size;a=a.uploadMediaMetric;return k({chatJid:b,dbCallbacks:c,filename:d,hash:e,plaintext:f,protocolMsgId:g,serverMediaType:h,size:i,uploadMediaMetric:a})}function k(a){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.chatJid,c=a.dbCallbacks,e=a.filename,f=a.hash,g=a.plaintext,k=a.serverMediaType,l=a.size;a=a.uploadMediaMetric;b=(yield d("MAWMediaManager").getMawMediaManager().enqueueUploadFullSize({chatJid:b,mediaUploadFlow:a,plaintext:g,plaintextHash:f,serverMediaType:k}));if(b.success!==!0){j.WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Failed to enqueue upload full size: ",""])),b.error);a.endFail(b.error);return b}g=(yield c.getDownloadableThumbnailForMedia(f)["catch"](function(a){j.catching(a).MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["getDownloadableThumbnailForMedia unexpected runtime-erorr: ",""])),a);return null}));k=babelHelpers["extends"]({},b.value,{downloadableThumbnail:g,filename:e,size:l});a.endSuccess();return d("WAResultOrError").makeResult(k)});return l.apply(this,arguments)}g.uploadAndHandleMedia=a}),98);
__d("MAWOptimisticUploadMedia",["MAWConfig","MAWFrontendMediaUtils","MAWGetDownloadableThumbnailForMediaApi","MAWGetMediaPlaintextApi","MAWGetOrCreateMediaKnownEntriesApi","MAWMediaSizeCheck","MAWMediaUtils","MAWOptimisticUploadManager","MAWStartMediaUploadQplFlow","MAWUpdateMediaEntryForMsgApi","MAWUpdateMediaEntryForOptimisticUploadApi","MAWUploadAndHandleMedia","MWFBLogger","WABlobToArrayBuffer","WAHashUtils","WAMediaCrypto","WAProgressiveJpegGetScanLengths","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p,q,r=d("MWFBLogger").MWMediaLogger.tags(["OptimisticUploadMedia"]);function s(a,b,c){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){r.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["start uploading type: ",""])),String(c));var e=(yield d("MAWMediaUtils").hashBlob(a));e=d("WAHashUtils").toPlaintextHash(e);var f=d("MAWOptimisticUploadManager").getOptimisticUploadManager();f=f.get(e);if(f!=null)return d("WAResultOrError").makeError("already_uploading");f=c.type==="regular"?c.mediaType:"preview";var g=(yield d("MAWStartMediaUploadQplFlow").startMediaUploadQplFlow({chatJid:b,fileSize:a.size,serverMediaType:f,uploadEntry:"optimisticUploadMedia"}));b=d("MAWUploadAndHandleMedia").uploadAndHandleMedia({chatJid:b,dbCallbacks:{getDownloadableThumbnailForMedia:d("MAWGetDownloadableThumbnailForMediaApi").getDownloadableThumbnailForMedia,getMediaKnownEntries:d("MAWGetOrCreateMediaKnownEntriesApi").getOrCreateMediaKnownEntries,getMediaPlaintext:d("MAWGetMediaPlaintextApi").getMediaPlaintext,updateMediaEntryForMsg:d("MAWUpdateMediaEntryForMsgApi").updateMediaEntryForMsg,updateMediaEntryForOptimisticUpload:d("MAWUpdateMediaEntryForOptimisticUploadApi").updateMediaEntryForOptimisticUpload},filename:f==="document"?a.name:void 0,hash:e,mediaTypeDetails:c,plaintext:yield d("WABlobToArrayBuffer").blobToArrayBuffer(a),protocolMsgId:null,serverMediaType:f,size:a.size,uploadMediaMetric:g});return d("WAResultOrError").makeResult({plaintextHash:e,uploadPromise:b})});return t.apply(this,arguments)}function a(a){return u.apply(this,arguments)}function u(){u=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.file,c=a.jid;a=a.thumbnail;var e=d("MAWOptimisticUploadManager").getOptimisticUploadManager(),f=d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(b.type);f=f.serverMediaType;r.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["file uploading"])));var g=(yield s(b,c,{mediaType:f,type:"regular"}));g.success===!0?(r.DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["fileUploadResult success"]))),e.set(g.value.plaintextHash,{file:b,optimisticUploadPromise:g.value.uploadPromise,previewPlaintextHash:null})):(g.error,r.DEBUG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["File is already being uploaded"]))));var h=null;r.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["thumbnail_exists: ",""])),a!=null);var i=new Uint8Array(yield d("WABlobToArrayBuffer").blobToArrayBuffer(b));if(a&&v(f,b.size,i)){r.DEBUG(n||(n=babelHelpers.taggedTemplateLiteralLoose(["preview uploading"])));i=d("WAMediaCrypto").convertServerMediaTypeToPreviewMediaType(f);if(i==null){r.MUSTFIX(o||(o=babelHelpers.taggedTemplateLiteralLoose(["unsupported preview media type ",""])),f);return}f=(yield s(a,c,{messageType:i,type:"preview"}));f.success===!0&&(r.DEBUG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["previewUploadResult success"]))),h=f.value.plaintextHash,e.set(f.value.plaintextHash,{file:a,optimisticUploadPromise:f.value.uploadPromise}),g.success===!0&&(r.DEBUG(q||(q=babelHelpers.taggedTemplateLiteralLoose(["fileUploadResult success, setting with previewPlaintextHash"]))),e.set(g.value.plaintextHash,{file:b,optimisticUploadPromise:g.value.uploadPromise,previewPlaintextHash:h})))}});return u.apply(this,arguments)}function v(a,b,c){switch(a){case"gif":return!1;case"image":return w(b,c);case"video":return!0;default:r.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Skipping preview upload for media type ",""])),a);return!1}}function w(a,b){if(!d("MAWMediaSizeCheck").isMinSizeForImagePreviewGeneration(a))return!1;return!x(b)&&d("MAWConfig").getConfig().shouldFallbackToPreviewForFailedProgressiveJpeg()===!0?!0:!1}function x(a){a=d("WAProgressiveJpegGetScanLengths").getProgressiveJpegScanLengths(a);return a.length>0}g.optimisticUploadMedia=a;g.shouldUploadPreview=v}),98);
__d("MAWGetMsgIdByProtocolMsgId",["MAWDbMsgTxns","MAWDbReactionsTxns","MAWDbUnrenderedMsgTxns","MAWDexieTable","MAWIndexedDb","MAWMsgType","MAWTransactionMode","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({messages:(a=d("MAWTransactionMode")).READONLY,reactions:a.READONLY,threads:a.READONLY,unrenderedMessages:a.READONLY},"getMsgIdByProtocolMsgId",function(a){return function(b){return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsgResultByProtocolMsgId(a,b),d("MAWDbReactionsTxns").maybeGetReactionByProtocolMsgId(a,b),d("MAWDbUnrenderedMsgTxns").maybeGetUnrenderedMsgByProtocolMsgId(a,b)]).then(function(a){var b=a[0],c=a[1];a=a[2];if(b.success)return d("WAResultOrError").makeResult(b.value.msgId);else if(c!=null)return d("WAResultOrError").makeResult(c.reactionId);else if(a.success&&a.value.type===d("MAWMsgType").MSG_TYPE.DELETE_FOR_ME)return d("WAResultOrError").makeResult(a.value.msgId);var e="missing_msg_in_db";b=b.error;a=a.error;b==="missing_msg"&&c==null&&a==="missing_unrendered_msg"?e="missing_all_db_msg":b==="missing_thread_msg"&&a==="missing_thread_unrendered_msg"?e="missing_all_thread":(b==="missing_thread_msg"||a==="missing_thread_unrendered_msg")&&(e=b+"__"+(a!=null?a:"unrenderedMsgResultNoError"));return d("WAResultOrError").makeError(e)})}});g.getMsgIdByProtocolMsgId=b}),98);
__d("MAWCheckThreadExistsTxn",["MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return d("MAWIndexedDb").makeMsgrTransactor({threads:d("MAWTransactionMode").READONLY},"checkThreadExists",function(b){return function(){return b.threads.get({jid:a}).then(function(a){return a!=null})}})()}g.checkThreadExistsTxn=a}),98);
__d("MAWSendMediaMsg",["BlobStorageTypes","EBAPI","EBLogger","MAWAckLevel","MAWAsConsumerApplication","MAWBridge","MAWBridgeTypesCreators","MAWCastToMsgrServerMediaType","MAWCheckThreadExistsTxn","MAWDbChunkTxns","MAWDbMedia","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWDexieTable","MAWEphemeralMsgTxns","MAWFrontendMediaUtils","MAWGetDownloadableThumbnailForMediaApi","MAWGetMediaPlaintextApi","MAWGetMsgIdByProtocolMsgId","MAWGetOrCreateMediaKnownEntriesApi","MAWIndexedDb","MAWMediaAfterTxns","MAWMediaBackupTxns","MAWMediaDownloadStatus","MAWMediaDownloadStatusForUI","MAWMediaManagementTxns","MAWMediaUtils","MAWMessageSendsCommon","MAWMpsGating","MAWMsgType","MAWMsgUtil","MAWOptimisticUploadManager","MAWQplProxy","MAWSendWrittenMsg","MAWStartMediaUploadQplFlow","MAWTSUtils","MAWTransactionMode","MAWUpdateMediaEntryForMsgApi","MAWUpdateMediaEntryForOptimisticUploadApi","MAWUploadAndHandleMedia","MAWWriteOutgoingMsgApi","MpsMediaManager","MpsToBridgeMessageId","MpsTypes","Promise","SendMsgArgsToProtobuf","WAAPI","WAAsMessageApplication","WABlobToArrayBuffer","WAJids","WAMediaUtils","WAMsgApplication.pb","WAMsgMap","WAQPLProxy","WAResultOrError","WASortedLists","WAValidateMedia","asyncToGeneratorRuntime","encodeProtobuf","gkx","nullthrows","validateMAWMediaAndComposeEntryForProtoMsg"],(function(a,b,c,d,e,f,g){"use strict";var h=["qplEventType","qplInstanceKey"],i,j,k,l,m,n,o,p;function q(a){switch(a){case d("MAWDbMedia").MEDIA_TYPE.IMAGE:return d("MAWMsgType").MSG_TYPE.IMAGE;case d("MAWDbMedia").MEDIA_TYPE.VIDEO:return d("MAWMsgType").MSG_TYPE.VIDEO;case d("MAWDbMedia").MEDIA_TYPE.PTT:return d("MAWMsgType").MSG_TYPE.PTT;case d("MAWDbMedia").MEDIA_TYPE.GIF:return d("MAWMsgType").MSG_TYPE.GIF;case d("MAWDbMedia").MEDIA_TYPE.STICKER:return d("MAWMsgType").MSG_TYPE.STICKER;case d("MAWDbMedia").MEDIA_TYPE.DOCUMENT_FILE:return d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE;default:d("EBLogger").EBLogger.tags(["unsupported_media"]).mustfix("unsupported media type");throw d("MAWMessageSendsCommon").messageSendLogger.mustfixThrow("Expected media msg type")}}e=function(){function a(){this.mediaEntry=null}var e=a.prototype;e.writeToDb=function(a,b,c,e){throw d("MAWMessageSendsCommon").messageSendLogger.mustfixThrow("Not implemented")};e.attachHashAndSaveMedia=function(a,b,c,e,f,g,h,i,j,k){throw d("MAWMessageSendsCommon").messageSendLogger.mustfixThrow("Not implemented")};e.maybePersistMediaEntry=function(a,b,c,e){throw d("MAWMessageSendsCommon").messageSendLogger.mustfixThrow("Not implemented")};e.perisitMediaEntryForQuickMediaSend=function(a,b,c){return d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READWRITE},"perisitMediaEntryForQuickMediaSend",function(e){return function(){var f=d("WAMediaUtils").encodeMediaEntryForUpload(c);return d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(e,a).then(function(a){var g;if(a==null)throw d("MAWMessageSendsCommon").messageSendLogger.mustfixThrow("media should already exist upon this point");g=babelHelpers["extends"]({},a,{mediaEntries:a.mediaEntries.set(b,f),msgIds:d("WASortedLists").addToSet(a.msgIds,b),objectId:(g=c.objectId)!=null?g:void 0});return e.media.update(a.mediaId,g).then(function(){})})}})()};e.getUnderlyingMessage=function(a,b,c){throw d("MAWMessageSendsCommon").messageSendLogger.mustfixThrow("Not implemented")};e.updateSystemAckWithTxn=function(a,b){throw d("MAWMessageSendsCommon").messageSendLogger.mustfixThrow("Not implemented")};e.getProtobufData=function(a,b,c,e,f,g,h){throw d("MAWMessageSendsCommon").messageSendLogger.mustfixThrow("Not implemented")};e.uploadToWaapi=function(a,b,c,e,f,g,h){throw d("MAWMessageSendsCommon").messageSendLogger.mustfixThrow("Not implemented")};e.checkThreadExists=function(a){throw d("MAWMessageSendsCommon").messageSendLogger.mustfixThrow("Not implemented")};e.persistMessageAndMedia=function(a){throw d("MAWMessageSendsCommon").messageSendLogger.mustfixThrow("Not implemented")};e.constructMediaInfo=function(a,b){a={validatedAudioInfo:a==="Ptt"&&b.duration!=null?{duration:b.duration,mimetype:c("gkx")("3053")?d("MAWAsConsumerApplication").AUDIO_OGG_MIME_TYPE:d("MAWAsConsumerApplication").AUDIO_WAV_MIME_TYPE,played:!1}:null,validatedDocumentFileInfo:a==="DocumentFile"&&b.filename!=null?{filename:b.filename,mimetype:d("MAWAsConsumerApplication").FILE_MIME_TYPE}:null,validatedImageInfo:a==="Image"?{hdType:b.hdType,height:b.height,jpegThumbnail:b.jpegThumbnail,jpegThumbnailHeight:b.jpegThumbnailHeight,jpegThumbnailWidth:b.jpegThumbnailWidth,width:b.width}:a==="Gif"||a==="Sticker"?{height:b.height,jpegThumbnailHeight:b.height,jpegThumbnailWidth:b.width,width:b.width}:null,validatedVideoInfo:a==="Video"?{duration:b.duration,height:b.height,jpegThumbnail:b.jpegThumbnail,jpegThumbnailHeight:b.jpegThumbnailHeight,jpegThumbnailWidth:b.jpegThumbnailWidth,mimetype:d("MAWAsConsumerApplication").VIDEO_MIME_TYPE,width:b.width}:null};return a};e.getMediaEntry=function(a){var b,c=d("MAWOptimisticUploadManager").getOptimisticUploadManager();return(b=this.mediaEntry)!=null?b:(b=c.get(a))==null?void 0:b.mediaEntry};e.updateMediaEntry=function(a,b){d("MAWUpdateMediaEntryForMsgApi").maybeUpdateOptimisticUploadMediaEntry(a,b),this.mediaEntry=b()};e.saveAndPassOff=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f,g,h){e=b.mediaType;b=b.serverMediaType;var j=f.args;f.attachmentType;var k=f.chatJid;f.externalId;var l=f.file;f=f.filename;var m=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(b);if(!m){d("EBLogger").EBLogger.tags(["unsupported_media"]).mustfix("unsupported media type");d("MAWQplProxy").sendQplPointThroughBridge(g,"failed_media_unsupported_type",{instanceKey:h});throw d("MAWMessageSendsCommon").messageSendLogger.mustfixThrow("Media type unsupported: "+(b!=null?b:""))}yield this.getUnderlyingMessage(a,g,h);d("MAWQplProxy").sendQplPointThroughBridge(g,"get_validated_media_info_start",{instanceKey:h});m=a.msgId;var n=this.constructMediaInfo(e,j);d("MAWQplProxy").sendQplPointThroughBridge(g,"get_validated_media_info_end",{instanceKey:h});d("MAWQplProxy").sendQplPointThroughBridge(g,"attach_hash_and_save_media_start",{instanceKey:h});yield this.attachHashAndSaveMedia(k,a.protocolMsgId,l,c,void 0,void 0,e,n,j.offlineAttachmentId,j.accessibilityLabel);d("MAWQplProxy").sendQplPointThroughBridge(g,"attach_hash_and_save_media_end",{instanceKey:h});var o=d("MAWOptimisticUploadManager").getOptimisticUploadManager(),p=o.get(c),q=p==null?void 0:p.optimisticUploadPromise,r=q!=null;d("MAWQplProxy").sendQPLBoolAnnotationThroughBridge(g,"isOptimisticUpload",r,h);d("MAWQplProxy").sendQplPointThroughBridge(g,"upload_media_to_backend_start",{instanceKey:h});var s;q!=null&&(s=(yield q),s.success||d("MAWQplProxy").sendQplPointThroughBridge(g,"optimistic_upload_failure",{annotations:{string:{optimisticUploadError:s.error}},instanceKey:h}));if(s==null||!s.success){s==null&&d("MAWQplProxy").sendQplPointThroughBridge(g,"upload_media_when_no_existing_optimistic_upload",{instanceKey:h});r=(yield d("MAWStartMediaUploadQplFlow").startMediaUploadQplFlow({chatJid:k,fileSize:l.size,serverMediaType:b,uploadEntry:"sendMediaMsg"}));s=(yield this.uploadToWaapi(k,a,c,b,f,l,r))}if(!s.success){d("MAWMessageSendsCommon").messageSendLogger.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Failed to upload media for msgId: ",""])),m);d("MAWQplProxy").sendQplPointThroughBridge(g,"upload_media_to_backend_fail",{instanceKey:h});d("MAWQplProxy").sendQPLStringAnnotationThroughBridge(g,"errorDescription",s.error,h);yield this.updateSystemAckWithTxn(m,d("MAWAckLevel").ACK.failed);return d("WAResultOrError").makeError({isRetriable:!1,type:"media-error"})}d("MAWQplProxy").sendQplPointThroughBridge(g,"upload_media_to_backend_end",{instanceKey:h});d("MAWQplProxy").sendQplPointThroughBridge(g,"persist_media_entry_start",{instanceKey:h});yield this.perisitMediaEntryForQuickMediaSend(c,m,s.value);d("MAWQplProxy").sendQplPointThroughBridge(g,"persist_media_entry_end",{instanceKey:h});q=this.getProtobufData(e,j,c,l,n,k);d("MAWQplProxy").sendQplPointThroughBridge(g,"send_written_msg_start",{instanceKey:h});b=(yield d("MAWSendWrittenMsg").sendWrittenMsgExternal({protocolMsgId:a.protocolMsgId,type:"message"},d("WAQPLProxy").waQPLProxyStartResume(g,h),"MAWSendMediaMsg",q));d("MAWQplProxy").sendQplPointThroughBridge(g,"send_written_msg_end",{instanceKey:h});d("MAWQplProxy").sendQplPointThroughBridge(g,"clean_up_memory_start",{instanceKey:h});o["delete"](c);(p==null?void 0:p.previewPlaintextHash)!=null&&o["delete"](p.previewPlaintextHash);d("MAWQplProxy").sendQplPointThroughBridge(g,"clean_up_memory_end",{instanceKey:h});if(b.success===!1)return d("WAResultOrError").makeError(b.error);else{f={chatJid:a.protocolMsgId.chat,content:j.content,ephemeralSetting:j.ephemeralSetting,externalId:a.protocolMsgId.externalId,fileType:l.type,initiatingSource:j.initiatingSource,messageType:"sendMsg",quote:j.quote,source:j.source,specialTextSize:j.specialTextSize,xmaMessageType:j.xmaMessageType};return d("WAResultOrError").makeResult(f)}});function c(b,c,d,e,f,g,h){return a.apply(this,arguments)}return c}();e.saveAndPassOffForQuickSend=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g,h,i,k,l){var m=e.mediaType;e=e.serverMediaType;var n=g.args;g.attachmentType;var o=g.chatJid;g.externalId;var q=g.file;g=g.filename;var r=d("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(e);if(!r){d("EBLogger").EBLogger.tags(["unsupported_media"]).mustfix("unsupported media type");d("MAWQplProxy").sendQplPointThroughBridge(h,"failed_media_unsupported_type",{instanceKey:i});throw d("MAWMessageSendsCommon").messageSendLogger.mustfixThrow("Media type unsupported: "+(e!=null?e:""))}d("MAWQplProxy").sendQplPointThroughBridge(h,"get_validated_media_info_start",{instanceKey:i});r=a.msgId;var s=this.constructMediaInfo(m,n);d("MAWQplProxy").sendQplPointThroughBridge(h,"get_validated_media_info_end",{instanceKey:i});d("MAWQplProxy").sendQplPointThroughBridge(h,"attach_hash_and_save_media_start",{instanceKey:i});yield this.attachHashAndSaveMedia(o,a.protocolMsgId,q,f,void 0,void 0,m,s,n.offlineAttachmentId,n.accessibilityLabel);d("MAWQplProxy").sendQplPointThroughBridge(h,"attach_hash_and_save_media_end",{instanceKey:i});var t=d("MAWOptimisticUploadManager").getOptimisticUploadManager(),u=t.get(f),v=u==null?void 0:u.optimisticUploadPromise,w=v!=null;d("MAWQplProxy").sendQPLBoolAnnotationThroughBridge(h,"isOptimisticUpload",w,i);d("MAWQplProxy").sendQplPointThroughBridge(h,"upload_media_to_backend_start",{instanceKey:i});var x;if(v!=null){w=(yield (p||(p=b("Promise"))).all([v,l]));x=w[0];d("MAWQplProxy").sendQplPointThroughBridge(h,"fetch_devices_end",{instanceKey:i});x.success||d("MAWQplProxy").sendQplPointThroughBridge(h,"optimistic_upload_failure",{annotations:{string:{optimisticUploadError:x.error}},instanceKey:i})}if(x==null||!x.success){x==null&&d("MAWQplProxy").sendQplPointThroughBridge(h,"upload_media_when_no_existing_optimistic_upload",{instanceKey:i});v=(yield d("MAWStartMediaUploadQplFlow").startMediaUploadQplFlow({chatJid:o,fileSize:q.size,serverMediaType:e,uploadEntry:"sendMediaMsg"}));w=(yield (p||(p=b("Promise"))).all([this.uploadToWaapi(o,a,f,e,g,q,v),l]));x=w[0];d("MAWQplProxy").sendQplPointThroughBridge(h,"fetch_devices_end",{instanceKey:i})}if(!x.success){d("MAWMessageSendsCommon").messageSendLogger.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Failed to upload media for msgId: ",""])),r);d("MAWQplProxy").sendQplPointThroughBridge(h,"upload_media_to_backend_fail",{instanceKey:i});d("MAWQplProxy").sendQPLStringAnnotationThroughBridge(h,"errorDescription",x.error,i);return d("WAResultOrError").makeError({isRetriable:!1,type:"media-error"})}d("MAWQplProxy").sendQplPointThroughBridge(h,"upload_media_to_backend_end",{instanceKey:i});d("MAWQplProxy").sendQplPointThroughBridge(h,"persist_media_entry_start",{instanceKey:i});e=d("WAMediaUtils").encodeMediaEntryForUpload(x.value);d("MAWQplProxy").sendQplPointThroughBridge(h,"persist_media_entry_end",{instanceKey:i});g=this.getProtobufData(m,n,f,q,s,o,e);d("MAWQplProxy").sendQplPointThroughBridge(h,"send_written_msg_start",{instanceKey:i});v=(yield d("MAWSendWrittenMsg").sendWrittenMsgExternal({protocolMsgId:a.protocolMsgId,type:"message"},d("WAQPLProxy").waQPLProxyStartResume(h,i),"MAWSendMediaMsg",g));d("MAWQplProxy").sendQplPointThroughBridge(h,"send_written_msg_end",{instanceKey:i});d("MAWQplProxy").sendQplPointThroughBridge(h,"clean_up_memory_start",{instanceKey:i});t["delete"](f);(u==null?void 0:u.previewPlaintextHash)!=null&&t["delete"](u.previewPlaintextHash);d("MAWQplProxy").sendQplPointThroughBridge(h,"clean_up_memory_end",{instanceKey:i});if(v.success===!1)return d("WAResultOrError").makeError(v.error);else{d("MAWQplProxy").sendQplPointThroughBridge(h,"persist_message_and_media_start",{instanceKey:i});l=(yield this.persistMessageAndMedia({blob:q,blobArrayBuffer:yield d("WABlobToArrayBuffer").blobToArrayBuffer(q),chatJid:o,externalId:a.protocolMsgId.externalId,jobStartTime:k,mediaEntryData:e,mediaInfo:s,mediaSendArgs:n,mediaType:m,plaintextHash:f,protocolMsgId:a.protocolMsgId,qplEventType:h,qplInstanceKey:i,serverTs:v.value.serverTs}));d("MAWQplProxy").sendQplPointThroughBridge(h,"persist_message_and_media_end",{instanceKey:i});d("MAWQplProxy").sendQplPointThroughBridge(h,"persist_message_and_media_end",{instanceKey:i});w=l!=null?l:[];r=w[0];t=w[1];if(r!=null&&t!=null&&(g==null?void 0:g.messageApplication)!=null&&!d("MAWMpsGating").isEbUploadViaMpsEnabled()){d("MAWQplProxy").sendQplPointThroughBridge(h,"eb_upload_scheduling_start",{instanceKey:i});u=d("encodeProtobuf").encodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,g==null?void 0:g.messageApplication).readBuffer();yield c("EBAPI").uploadSentMessage({dbMsg:r,instanceKey:a.protocolMsgId.externalId,isXMAMsg:!1,media:t,messageApplication:g==null?void 0:g.messageApplication,messageApplicationBytes:d("WAAsMessageApplication").castToMessageApplicationBytes(new Uint8Array(u)),protocolMsgId:a.protocolMsgId,serverTs:v.value.serverTs,xmaPayload:void 0});d("MAWQplProxy").sendQplPointThroughBridge(h,"eb_upload_scheduling_end",{instanceKey:i})}o={chatJid:a.protocolMsgId.chat,content:n.content,ephemeralSetting:n.ephemeralSetting,externalId:a.protocolMsgId.externalId,fileType:q.type,initiatingSource:n.initiatingSource,messageType:"sendMsg",quote:n.quote,source:n.source,specialTextSize:n.specialTextSize,xmaMessageType:n.xmaMessageType};return d("WAResultOrError").makeResult(o)}});function e(b,c,d,e,f,g,h,i){return a.apply(this,arguments)}return e}();e.sendMediaMsg=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f){var g=c("gkx")("1165");d("MAWQplProxy").sendQplPointThroughBridge(e,"fetch_devices_start",{instanceKey:f});var h=c("WAAPI").getDevicesBeforeSend({chatJid:a.chatJid,reason:"SendMediaMsg"});g||(yield h,d("MAWQplProxy").sendQplPointThroughBridge(e,"fetch_devices_end",{instanceKey:f}));d("MAWQplProxy").sendQplPointThroughBridge(e,"write_msg_to_db_start",{instanceKey:f});var i=(yield this.writeToDb({args:a.args,attachmentType:a.attachmentType,chatJid:a.chatJid,externalId:a.externalId,file:a.file},b,e,f)),j=i[0];i=i[1];d("MAWQplProxy").sendQplPointThroughBridge(e,"write_msg_to_db_end",{instanceKey:f});d("MAWQplProxy").sendQplPointThroughBridge(e,"gen_blob_hashes_start",{instanceKey:f});var k=(yield d("MAWMediaUtils").genBlobHashes(a.file)),l=k[0];k=k[1];d("MAWQplProxy").sendQplPointThroughBridge(e,"gen_blob_hashes_end",{instanceKey:f});d("MAWQplProxy").sendQplPointThroughBridge(e,"save_and_pass_off_start",{instanceKey:f});g?g=(yield this.saveAndPassOffForQuickSend(j,i,l,a,e,f,b,h)):g=(yield this.saveAndPassOff(j,i,l,k,a,e,f));d("MAWQplProxy").sendQplPointThroughBridge(e,"save_and_pass_off_end",{instanceKey:f});return g});function e(b,c,d,e){return a.apply(this,arguments)}return e}();return a}();var r=function(e){function a(){return e.apply(this,arguments)||this}babelHelpers.inheritsLoose(a,e);var f=a.prototype;f.writeToDb=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g){var h=a.args,i=a.attachmentType,j=a.chatJid,m=a.externalId;a=a.file;d("MAWMessageSendsCommon").messageSendLogger.DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Chat ",": is received in job"])),j);a=d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(a.type,void 0,i);i=a.mediaType;a=a.serverMediaType;var n=q(i),o=c("gkx")("1165");d("MAWMessageSendsCommon").messageSendLogger.DEBUG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["MAWSendMediaMsg - begin writing "," media msg"])),n);if(o){o=(yield this.checkThreadExists(j));if(!o){d("MAWQplProxy").sendQplPointThroughBridge(f,"missing_db_thread",{instanceKey:g});throw d("MAWMessageSendsCommon").messageSendLogger.mustfixThrow("Failed to write msg to DB - thread missing")}return(p||(p=b("Promise"))).resolve([{msgId:c("nullthrows")(d("MAWDbMsg").toMsgId(j+"_"+m+"_m")),protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:j,externalId:m},type:"not_sent"},{mediaType:i,serverMediaType:a}])}o=(yield d("MAWWriteOutgoingMsgApi").writeOutgoingMsg(m,j,e,h,n,f,g));if(o.type==="missing_thread"){d("MAWQplProxy").sendQplPointThroughBridge(f,"writing_media_to_db_failed",{instanceKey:g});throw d("MAWMessageSendsCommon").messageSendLogger.mustfixThrow("Failed to write msg to DB - thread missing")}return[o,{mediaType:i,serverMediaType:a}]});function e(b,c,d,e){return a.apply(this,arguments)}return e}();f.attachHashAndSaveMedia=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g,h,i,j,k,l,n){var o=c("gkx")("1165");if(o)return(p||(p=b("Promise"))).resolve();var q=(yield d("WABlobToArrayBuffer").blobToArrayBuffer(f));c("gkx")("6236")&&(d("MAWMessageSendsCommon").messageSendLogger.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["writing blob to storage"]))),void b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield d("WAValidateMedia").validateMedia(q));a.success&&(yield d("MAWBridge").getBridge().fireAndForget("event","writeToMediaStorage",{blob:a.value.validatedPlaintext,fileName:d("BlobStorageTypes").toBlobFileName(g)}))})());return d("MAWIndexedDb").makeMsgrTransactor({chunk:d("MAWTransactionMode").READWRITE,media:d("MAWTransactionMode").READWRITE,mediaBackup:d("MAWTransactionMode").READWRITE,messages:d("MAWTransactionMode").READWRITE,unrenderedMessages:d("MAWTransactionMode").READWRITE},"attachHashAndSaveMedia",function(b){return function(){return d("MAWDexieTable").dexieAll([d("MAWMediaManagementTxns").attachHashToMediaMsg(b,e,g,h,i,j,f.size,k,!1,n!=null?n:void 0),d("MAWDbChunkTxns").getOrCreateMediaChunkWithPlaintextHash(b,g,q,f.type)]).then(function(e){var f=e[0];return b.messages.where("msgId").anyOf(f.msgIds).toArray().then(function(e){var h=d("MAWMediaUtils").createHdTypesForBridgeMedia(e);d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:"sent_media",hash:g,status:c("MAWMediaDownloadStatus").SUCCESS,type:"main"});e=d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:a,filteredMsgIds:d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(e,a),hasMediaForUI:!0,hdTypes:h,media:f,offlineAttachmentId:l});return d("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(b,e)})})}})()});function e(b,c,d,e,f,g,h,i,j,k){return a.apply(this,arguments)}return e}();f.maybePersistMediaEntry=function(a,c,e,f){var g=d("MAWOptimisticUploadManager").getOptimisticUploadManager(),h=g.get(a),i=h==null?void 0:h.mediaEntry;if(h==null){if(f!=null){var j=f.qplEventType,k=f.qplInstanceKey;d("MAWQplProxy").sendQplPointThroughBridge(j,"persist_media_skipped_because_upload_entry_null",{instanceKey:k})}return(p||(p=b("Promise"))).resolve()}g.set(a,babelHelpers["extends"]({},h,{msgId:c}));if(i==null){if(f!=null){j=f.qplEventType;k=f.qplInstanceKey;d("MAWQplProxy").sendQplPointThroughBridge(j,"persist_media_skipped_because_optimistic_media_entry_null",{instanceKey:k})}return(p||(p=b("Promise"))).resolve()}return d("MAWIndexedDb").makeMsgrTransactor({media:d("MAWTransactionMode").READWRITE,mediaBackup:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READONLY},"maybePersistMediaEntry",function(b){return function(){return d("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(b,a).then(function(a){if(a){var f=babelHelpers["extends"]({},a,{mediaEntries:a.mediaEntries.set(c,i),msgIds:d("WASortedLists").addToSet(a.msgIds,c)});e!=null&&(f=babelHelpers["extends"]({},f,{objectId:d("WAMediaUtils").stringToDeliveryObjectId(e)}));return b.media.update(a.mediaId,f).then(function(f){e!=null&&d("MAWMediaBackupTxns").linkMediaBackup(b,a.mediaId,c,d("WAMediaUtils").stringToDeliveryObjectId(e))})}else throw d("MAWMessageSendsCommon").messageSendLogger.mustfixThrow("media should already exist upon this point")})}})()};f.getUnderlyingMessage=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){d("MAWQplProxy").sendQplPointThroughBridge(b,"get_underlying_message_start",{instanceKey:c});var e=(yield d("MAWGetMsgIdByProtocolMsgId").getMsgIdByProtocolMsgId(a.protocolMsgId));if(!e.success){d("MAWQplProxy").sendQplPointThroughBridge(b,"failed_media_msgid_missing_in_db",{instanceKey:c});throw d("MAWMessageSendsCommon").messageSendLogger.mustfixThrow("Message missing in db")}e.value!==a.msgId&&d("MAWMessageSendsCommon").messageSendLogger.MUSTFIX(n||(n=babelHelpers.taggedTemplateLiteralLoose(["[MAWSendMediaMsg] - msgId mismatch between put msg and got msg"])));d("MAWQplProxy").sendQplPointThroughBridge(b,"get_underlying_message_end",{instanceKey:c})});function c(b,c,d){return a.apply(this,arguments)}return c}();f.updateSystemAckWithTxn=function(a,b){return d("MAWMsgUtil").updateSystemAckWithTxn(a,b)};f.getProtobufData=function(a,b,e,f,g,h,i){var j=c("gkx")("1165");if(!j)return null;j=q(a);a=d("validateMAWMediaAndComposeEntryForProtoMsg").validateMediaEntry(e,c("nullthrows")(i!=null?i:this.getMediaEntry(e)));return{messageApplication:d("SendMsgArgsToProtobuf").createMessageApplication(j,babelHelpers["extends"]({},b,{fileSize:f.size,mediaEntry:a,mediaInfo:g}),h)}};f.uploadToWaapi=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,h,i){var j=c("gkx")("1165"),k=function(){throw d("MAWMessageSendsCommon").messageSendLogger.mustfixThrow("Not implemented")};return d("MAWUploadAndHandleMedia").uploadAndHandleMedia({chatJid:a,dbCallbacks:{getDownloadableThumbnailForMedia:d("MAWGetDownloadableThumbnailForMediaApi").getDownloadableThumbnailForMedia,getMediaKnownEntries:j?k:d("MAWGetOrCreateMediaKnownEntriesApi").getOrCreateMediaKnownEntries,getMediaPlaintext:j?k:d("MAWGetMediaPlaintextApi").getMediaPlaintext,updateMediaEntryForMsg:j?k:d("MAWUpdateMediaEntryForMsgApi").updateMediaEntryForMsg,updateMediaEntryForOptimisticUpload:j?k:d("MAWUpdateMediaEntryForOptimisticUploadApi").updateMediaEntryForOptimisticUpload},filename:f==="document"?g:void 0,hash:e,mediaTypeDetails:{mediaType:f,type:"regular"},plaintext:yield d("WABlobToArrayBuffer").blobToArrayBuffer(h),protocolMsgId:b.protocolMsgId,serverMediaType:f,size:h.size,uploadMediaMetric:i})});function e(b,c,d,e,f,g,h){return a.apply(this,arguments)}return e}();f.checkThreadExists=function(a){return d("MAWCheckThreadExistsTxn").checkThreadExistsTxn(a)};f.persistMessageAndMedia=function(a){var e=a.blob,f=a.blobArrayBuffer,g=a.chatJid,h=a.externalId,i=a.jobStartTime,j=a.mediaEntryData,k=a.mediaInfo,l=a.mediaSendArgs,m=a.mediaType,n=a.plaintextHash,p=a.protocolMsgId,r=a.qplEventType,s=a.qplInstanceKey,t=a.serverTs;return d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READWRITE,ephemeralSettings:a.READWRITE,ftsBackloggedMessages:a.READWRITE,groupInfo:a.READONLY,media:a.READWRITE,mediaBackup:a.READWRITE,messages:a.READWRITE,receiverFetchInfo:a.READONLY,threads:a.READWRITE,unrenderedMessages:a.READWRITE,xma:a.READONLY},"persistMessageAndMedia",function(a){return function(){var u=q(m);d("MAWQplProxy").sendQplPointThroughBridge(r,"persist_message_start",{instanceKey:s});return d("MAWWriteOutgoingMsgApi").writeOutgoingMsgImpl(a,h,g,i,l,u,r,s).then(function(a){if(a.type==="missing_thread"){d("MAWQplProxy").sendQplPointThroughBridge(r,"writing_media_to_db_failed",{instanceKey:s});throw d("MAWMessageSendsCommon").messageSendLogger.mustfixThrow("Failed to write msg to DB - thread missing")}d("MAWQplProxy").sendQplPointThroughBridge(r,"persist_message_end",{instanceKey:s});return a}).then(function(h){var i;d("MAWQplProxy").sendQplPointThroughBridge(r,"persist_media_and_chunk_start",{instanceKey:s});return d("MAWDexieTable").dexieAll([d("MAWMediaManagementTxns").attachHashToMediaMsg(a,p,n,void 0,void 0,m,e.size,k,!1,(i=l.accessibilityLabel)!=null?i:void 0,j),d("MAWDbChunkTxns").getOrCreateMediaChunkWithPlaintextHash(a,n,f,e.type)]).then(function(e){var i=e[0];d("MAWQplProxy").sendQplPointThroughBridge(r,"persist_media_and_chunk_end",{instanceKey:s});c("gkx")("6236")&&(d("MAWMessageSendsCommon").messageSendLogger.DEBUG(o||(o=babelHelpers.taggedTemplateLiteralLoose(["writing blob to storage"]))),void b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield d("WAValidateMedia").validateMedia(f));a.success&&(yield d("MAWBridge").getBridge().fireAndForget("event","writeToMediaStorage",{blob:a.value.validatedPlaintext,fileName:d("BlobStorageTypes").toBlobFileName(n)}))})());d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:"sent_media",hash:n,status:c("MAWMediaDownloadStatus").SUCCESS,type:"main"});return a.messages.where("msgId").anyOf(i.msgIds).toArray().then(function(b){var c=d("MAWMediaUtils").createHdTypesForBridgeMedia(b);b=d("MAWBridgeTypesCreators").createBridgeMedia({chatJid:g,filteredMsgIds:d("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(b,g),hasMediaForUI:!0,hdTypes:c,media:i,offlineAttachmentId:l.offlineAttachmentId});return d("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(a,b)}).then(function(){d("MAWQplProxy").sendQplPointThroughBridge(r,"mark_message_as_sent_start",{instanceKey:s});return d("MAWDbMsgTxns").updateSystemAck(a,h.msgId,d("MAWAckLevel").ACK.sent,t)}).then(function(b){d("MAWQplProxy").sendQplPointThroughBridge(r,"mark_message_as_sent_end",{instanceKey:s});if(b!=null&&b.ephemeralSetting!=null){d("MAWQplProxy").sendQplPointThroughBridge(r,"mark_ephemeral_message_as_sent_start",{instanceKey:s});return d("MAWEphemeralMsgTxns").markEphemeralMessageAsSent(a,b,!0).then(function(a){d("MAWQplProxy").sendQplPointThroughBridge(r,"mark_ephemeral_message_as_sent_end",{instanceKey:s});return[a!=null?a:b,i]})}return[b,i]})})})}})()};return a}(e),s=function(e){function a(){return e.apply(this,arguments)||this}babelHelpers.inheritsLoose(a,e);var f=a.prototype;f.writeToDb=function(a){var c=a.attachmentType,e=a.chatJid,f=a.externalId;a=a.file;a=d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(a.type,void 0,c);c=a.mediaType;a=a.serverMediaType;return(p||(p=b("Promise"))).resolve([{msgId:d("MpsToBridgeMessageId").mpsToBridgeMsgId(d("MpsTypes").toThreadId(e),d("MpsTypes").toMessageId(f)),protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:e,externalId:f},type:"not_sent"},{mediaType:c,serverMediaType:a}])};f.attachHashAndSaveMedia=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e){a=(yield d("WABlobToArrayBuffer").blobToArrayBuffer(c));yield d("MpsMediaManager").storeChunk(e,a,c.type)});function c(b,c,d,e){return a.apply(this,arguments)}return c}();f.maybePersistMediaEntry=function(a,c){var e=d("MAWOptimisticUploadManager").getOptimisticUploadManager(),f=e.get(a);if(f==null)return(p||(p=b("Promise"))).resolve();e.set(a,babelHelpers["extends"]({},f,{msgId:c}));return(p||(p=b("Promise"))).resolve()};f.getUnderlyingMessage=function(){return(p||(p=b("Promise"))).resolve()};f.updateSystemAckWithTxn=function(){return(p||(p=b("Promise"))).resolve()};f.getProtobufData=function(a,b,e,f,g,h,i){a=q(a);i=d("validateMAWMediaAndComposeEntryForProtoMsg").validateMediaEntry(e,c("nullthrows")(i!=null?i:this.getMediaEntry(e)));return{messageApplication:d("SendMsgArgsToProtobuf").createMessageApplication(a,babelHelpers["extends"]({},b,{fileSize:f.size,mediaEntry:i,mediaInfo:g}),h)}};f.uploadToWaapi=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e,f,g,h,i){var j=this;return d("MAWUploadAndHandleMedia").uploadAndHandleMedia({chatJid:a,dbCallbacks:{getDownloadableThumbnailForMedia:d("MAWGetDownloadableThumbnailForMediaApi").getDownloadableThumbnailForMedia,getMediaKnownEntries:function(){return(p||(p=b("Promise"))).resolve(new(d("WAMsgMap").MsgMap)())},getMediaPlaintext:function(){return(p||(p=b("Promise"))).resolve(h)},updateMediaEntryForMsg:function(a,c,d){j.updateMediaEntry(a,d);return(p||(p=b("Promise"))).resolve()},updateMediaEntryForOptimisticUpload:function(a,c){j.updateMediaEntry(a,c);return(p||(p=b("Promise"))).resolve()}},filename:f==="document"?g:void 0,hash:e,mediaTypeDetails:{mediaType:f,type:"regular"},plaintext:yield d("WABlobToArrayBuffer").blobToArrayBuffer(h),protocolMsgId:c.protocolMsgId,serverMediaType:f,size:h.size,uploadMediaMetric:i})});function c(b,c,d,e,f,g,h){return a.apply(this,arguments)}return c}();f.checkThreadExists=function(a){return(p||(p=b("Promise"))).resolve(!0)};f.persistMessageAndMedia=function(a){return null};return a}(e);function t(){return d("MAWMpsGating").isFullMpsEnabled()?new s():new r()}function a(a){var b=a.qplEventType,c=a.qplInstanceKey,e=babelHelpers.objectWithoutPropertiesLoose(a,h),f=t();return d("MAWMessageSendsCommon").messageSendObserver(b,c,function(g){var h;return f.sendMediaMsg(e,(h=d("MAWTSUtils").gatedLSOptimisticTsToMaybeUnixTime((h=a.args)==null||(h=h.optimisticMsg)==null?void 0:h.ts))!=null?h:g,b,c)},"media",{author:d("WAJids").AUTHOR_ME,chat:a.chatJid,externalId:a.externalId})}g.mediaSender=t;g.sendMediaMsgFn=a}),98);
__d("MAWWriteLocalXMAMsgApi",["FBLogger","MAWAckLevel","MAWAuthor","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWMsgType","MAWTransactionMode","MAWVault","MAWWriteMsgTxns","WAJids","WALogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,ftsBackloggedMessages:a.READWRITE,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,threads:a.READWRITE,unrenderedMessages:a.READWRITE,xma:a.READONLY},"writeLocalXMAMsg",function(a){return function(b,c,e,f,g){f.content!=null&&(f.content=d("MAWVault").vault(f.content));return d("MAWDexieTable").dexieAll([a.threads.get({jid:c}),a.messages.where("externalId").equals(b).toArray(),i(a,f.quote,c)]).then(function(c){var h=c[0],i=c[1];c=c[2];if(h==null)return{type:"missing_thread"};i=i.find(function(a){return a.threadJid===h.jid&&a.author===g});if(i!=null)return{protocolMsgId:{author:g,chat:h.jid,externalId:i.externalId},type:"already_sent"};else{i={ack:d("MAWAckLevel").ACK.clock,altIndex:void 0,author:g,ephemeralSetting:f.ephemeralSetting,externalId:b,isForwarded:f.isForwarded,specialTextSize:f.specialTextSize,threadJid:h.jid,ts:e};i=j(i,f,c);c=f.isFirstMsg;var k=f.openMessageOtid,l=f.openMessageParticipantCount,m=f.optimisticMsg,n=f.participantCount;return d("MAWWriteMsgTxns").writeMsg(a,i,h,{isFirstMsg:c,isOutgoing:!0,openMessageOtid:k,openMessageParticipantCount:l,optimisticMsg:m,participantCount:n}).then(function(){return{protocolMsgId:{author:g,chat:h.jid,externalId:b},type:"sent"}})}})}});function i(a,b,c){return b==null?d("MAWDexieTable").dexieResolve(null):d("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(a,b).then(function(b){return b==null?null:a.threads.get({jid:b.threadJid}).then(function(a){var e=b?k(b):null;b.messageExpirationTs!=null&&b.messageExpirationTs<d("WATimeUtils").unixTime()&&e!=null&&(e=babelHelpers["extends"]({},e,{mediaId:void 0,msgContent:void 0,type:d("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL,xmaMessageType:void 0}));if(a==null||a.jid===c)return{content:e,remoteJid:null};a=d("WAJids").interpretAndValidateJid(a.jid);a=a.jidType==="group"?a.groupJid:null;return{content:e,remoteJid:a}})})}function j(a,b,e){var f,g;if(b.quote!=null&&(e==null?void 0:e.content)!=null){var h;g=e==null||(h=e.content)==null?void 0:h.externalId;f={content:e==null?void 0:e.content,remoteJid:(e=e==null?void 0:e.remoteJid)!=null?e:void 0}}if(b.xmaMessageType==null)throw c("FBLogger")("messenger_web").mustfixThrow("XMA Message Missing xmaMessageType");return babelHelpers["extends"]({},a,{quote:f,quoteExternalId:g,type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:b.xmaMessageType})}function k(a){var b={author:d("MAWAuthor").getAuthorUserJid(a.author)||d("WAJids").AUTHOR_ME,externalId:a.externalId,mediaId:a.mediaId,msgId:a.msgId,specialTextSize:a.specialTextSize,ts:a.ts,xmaMessageType:a.xmaMessageType};switch(a.type){case d("MAWMsgType").MSG_TYPE.IMAGE:return babelHelpers["extends"]({},b,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.IMAGE});case d("MAWMsgType").MSG_TYPE.VIDEO:return babelHelpers["extends"]({},b,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.VIDEO});case d("MAWMsgType").MSG_TYPE.PTT:return babelHelpers["extends"]({},b,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.PTT});case d("MAWMsgType").MSG_TYPE.TEXT:return babelHelpers["extends"]({},b,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.TEXT});case d("MAWMsgType").MSG_TYPE.STICKER:return babelHelpers["extends"]({},b,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.STICKER});case d("MAWMsgType").MSG_TYPE.GIF:return babelHelpers["extends"]({},b,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.GIF});case d("MAWMsgType").MSG_TYPE.XMA:return babelHelpers["extends"]({},b,{msgContent:a.msgContent,type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:a.xmaMessageType});case d("MAWMsgType").MSG_TYPE.RAVEN:return babelHelpers["extends"]({},b,{ravenEphemeralMediaState:a.ravenEphemeralMediaState,ravenEphemeralType:a.ravenEphemeralType,ravenMediaType:a.ravenMediaType,type:d("MAWMsgType").MSG_TYPE.RAVEN});default:d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["msgToQuotedMsg-XMA: Unsupported message type ",""])),a.type);throw c("FBLogger")("messenger_web").mustfixThrow("Trying to reply to a message type that does not support replies")}}g.writeLocalXMAMsg=b}),98);
__d("MAWSaveRTCCallXMAMsg",["MAWAckLevel","MAWBridgeXMA","MAWDexieTable","MAWExternalId","MAWFrontendMediaUtils","MAWGetDownloadableThumbnailForMediaApi","MAWGetMediaPlaintextApi","MAWGetMsgIdByProtocolMsgId","MAWGetOrCreateMediaKnownEntriesApi","MAWIndexedDb","MAWMediaManagementTxns","MAWMediaUtils","MAWMsgUtil","MAWOptimisticUploadManager","MAWSendMediaMsg","MAWStartMediaUploadQplFlow","MAWTransactionMode","MAWUpdateMediaEntryForMsgApi","MAWUpdateMediaEntryForOptimisticUploadApi","MAWWriteLocalXMAMsgApi","MAWXMAManagementTxns","Promise","WAAPI","WAArmadilloXMA.pb","WABlobToArrayBuffer","WALogger","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l;a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b,c=a.args,e=a.author,f=a.chatJid,g=a.faviconFile,l=a.ts;a=a.xmaArgs;var m=c.xmaMessageType;if(m==null){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["MAWSaveRTCCallXMAMsg - XMAMessageType is null"])));return}l=(yield d("MAWWriteLocalXMAMsgApi").writeLocalXMAMsg(d("MAWExternalId").generateExternalId(),f,l,c,e));if(l.type==="missing_thread"){d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Failed to send xma - missing thread"])));return}c=(yield d("MAWGetMsgIdByProtocolMsgId").getMsgIdByProtocolMsgId(l.protocolMsgId));if(!c.success){d("WALogger").ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["MAWSaveRTCCallXMAMsg - Message missing in db"])));return}e=c.value;a=babelHelpers["extends"]({},a,{overlayIconGlyph:(c=a.overlayIconGlyph)!=null?c:d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE});c=(yield p(g,e,m,l.protocolMsgId,a));g=d("MAWOptimisticUploadManager").getOptimisticUploadManager();m=(yield o(c,f,l.protocolMsgId,g));if(!(m!=null&&m.uploadResult.success)){d("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Failed to upload media xma"])));return d("MAWMsgUtil").updateSystemAckWithTxn(e,d("MAWAckLevel").ACK.failed)}a=m.uploadResult;c=m.media;yield d("MAWSendMediaMsg").mediaSender().maybePersistMediaEntry(c.plaintextHash,e,a==null||(b=a.value)==null?void 0:b.objectId);g["delete"](m.media.plaintextHash)});return function(b){return a.apply(this,arguments)}}();function m(a,b,c,d,e,f){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,h){h=h.get(a);h=h==null?void 0:h.optimisticUploadPromise;if(h!=null)return h;h=(yield d("MAWStartMediaUploadQplFlow").startMediaUploadQplFlow({chatJid:b,fileSize:g,serverMediaType:f,uploadEntry:"saveRTCCallXMAMsg"}));return c("WAAPI").uploadMedia({chatJid:b,getDownloadableThumbnailForMedia:d("MAWGetDownloadableThumbnailForMediaApi").getDownloadableThumbnailForMedia,getMediaKnownEntries:function(a){return d("MAWGetOrCreateMediaKnownEntriesApi").getOrCreateMediaKnownEntries(a)},getMediaPlaintext:d("MAWGetMediaPlaintextApi").getMediaPlaintext,hash:a,mediaTypeDetails:{mediaType:f,type:"regular"},protocolMsgId:e,size:g,updateMediaEntryForMsg:d("MAWUpdateMediaEntryForMsgApi").updateMediaEntryForMsg,updateMediaEntryForOptimisticUpload:d("MAWUpdateMediaEntryForOptimisticUploadApi").updateMediaEntryForOptimisticUpload,uploadMediaMetric:h})});return n.apply(this,arguments)}function o(a,c,e,f){if(a==null)return(l||(l=b("Promise"))).resolve();var g=d("MAWMediaUtils").getServerMediaTypeFromMediaType(a.mediaType,"xma-media");return m(a.plaintextHash,c,e,g,a.size,f).then(function(b){return{media:a,uploadResult:b}})}function p(a,b,c,d,e){return q.apply(this,arguments)}function q(){q=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,d,e){a=(yield r(a));return t(b,a,c,d,e)});return q.apply(this,arguments)}function r(a){return s.apply(this,arguments)}function s(){s=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(a==null)return a;var b=a.file,e=d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(b.type),f=e.mediaType;e=e.serverMediaType;var g=(yield d("MAWMediaUtils").genBlobHashes(b)),h=g[0];g=g[1];if(f!=="Image")throw c("err")("Expected Image when sending XMA share");var i=(yield d("WABlobToArrayBuffer").blobToArrayBuffer(b));return{blobArrayBuffer:i,file:b,hashedPlaintextHash:g,mediaInfo:{validatedAudioInfo:null,validatedDocumentFileInfo:null,validatedImageInfo:{height:a.height,width:a.width},validatedVideoInfo:null},mediaType:f,plaintextHash:h,serverMediaType:e}});return s.apply(this,arguments)}function t(a,b,c,e,f){var g;return d("MAWIndexedDb").makeMsgrTransactor({chunk:(g=d("MAWTransactionMode")).READWRITE,media:g.READWRITE,mediaBackup:g.READWRITE,messages:g.READWRITE,unrenderedMessages:g.READWRITE,xma:g.READWRITE},"saveRTCXMAMediaAndMetadata",function(g){return function(){var h=new Map();if(b!=null){var i=h.get(b.plaintextHash);i==null&&h.set(b.plaintextHash,d("MAWMediaManagementTxns").attachHashAndSaveMedia(g,e,b.blobArrayBuffer,b.plaintextHash,void 0,void 0,b.mediaType,b.mediaInfo,b.file,!1))}i=Array.from(h.values());return d("MAWDexieTable").dexieAll(i).then(function(h){h=h.reduce(function(a,b){return a.set(b.plaintextHash,b)},new Map());var i=b!=null?h.get(b.plaintextHash):void 0;return d("MAWXMAManagementTxns").saveXMA(g,void 0,void 0,i==null?void 0:i.mediaId,c,a,void 0,e,f,void 0,void 0,void 0,i==null?void 0:i.plaintextHash).then(function(a){d("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:d("MAWBridgeXMA").createBridgeXMA(i,a,{hasMedia:!1,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})});return i})})}})()}g.saveRTCCallXMAMsg=a}),98);
__d("MAWMessageComposingHooks",["MWFBLogger","Promise","WAAPI","WAJids"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=d("MWFBLogger").MWLogger.tags(["MAWMessageComposingHooks"]);function a(a,b){m(a)["catch"](function(a){k.catching(a).mustfix("Caught while calling maybeGetGroupInfoAheadOfGroupMessageSend hook for chat state composer.")})}var l=new Set();function m(a){return d("WAJids").switchOnMsgrChatJidType(a,{group:function(a){if(l.has(a))return(j||(j=b("Promise"))).resolve();k.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Querying group info ahead of group message send: ",""])),a);l.add(a);return c("WAAPI").queryGroups({groups:[a],type:"array"})["catch"](function(a){k.catching(a).MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Failed to query groups"])))})},user:function(){return(j||(j=b("Promise"))).resolve()}})}g.callMessageComposingHooks=a}),98);
__d("WASmaxOutChatstateInternalTestMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins","WAWap"],(function(a,b,c,d,e,f,g){function h(a){a=a.testConfig;a=d("WASmaxJsx").smax("smax$any",null,d("WASmaxJsx").smax("test",{config:d("WASmaxAttrs").OPTIONAL(d("WAWap").CUSTOM_STRING,a)}));return a}function a(a,b){b=h(b);return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeInternalTestMixin=a}),98);
__d("WASmaxOutChatstateComposingMixin",["WASmaxAttrs","WASmaxJsx","WASmaxMixins"],(function(a,b,c,d,e,f,g){function h(a){a=a.hasComposingMediaAudio;a=d("WASmaxJsx").smax("chatstate",null,d("WASmaxJsx").smax("composing",{media:d("WASmaxAttrs").OPTIONAL_LITERAL("audio",a)}));return a}function a(a,b){b=h(b);return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeComposingMixin=a}),98);
__d("WASmaxOutChatstatePausedMixin",["WASmaxJsx","WASmaxMixins"],(function(a,b,c,d,e,f,g){function h(){var a=d("WASmaxJsx").smax("chatstate",null,d("WASmaxJsx").smax("paused",null));return a}function a(a){var b=h();return d("WASmaxMixins").mergeStanzas(a,b)}g.mergePausedMixin=a}),98);
__d("WASmaxOutChatstateStateTypes",["WASmaxMixinGroupExhaustiveError","WASmaxOutChatstateComposingMixin","WASmaxOutChatstatePausedMixin"],(function(a,b,c,d,e,f,g){function a(a,b){if(b.composing)return d("WASmaxOutChatstateComposingMixin").mergeComposingMixin(a,b.composing);if(b.isPaused)return d("WASmaxOutChatstatePausedMixin").mergePausedMixin(a);throw new(d("WASmaxMixinGroupExhaustiveError").SmaxMixinGroupExhaustiveError)()}g.mergeStateTypes=a}),98);
__d("WASmaxOutChatstateClientNotificationRequest",["WASmaxJsx","WASmaxMixins","WASmaxOutChatstateInternalTestMixin","WASmaxOutChatstateStateTypes","WAWap"],(function(a,b,c,d,e,f,g){function a(a){var b=a.chatstateTo,c=a.internalTestMixinArgs;a=a.stateTypesArgs;b=d("WASmaxOutChatstateStateTypes").mergeStateTypes(d("WASmaxMixins").optionalMerge(d("WASmaxOutChatstateInternalTestMixin").mergeInternalTestMixin,d("WASmaxJsx").smax("chatstate",{to:d("WAWap").JID(b)}),c),a);return b}g.makeClientNotificationRequest=a}),98);
__d("WASmaxChatstateClientNotificationRPC",["WAComms","WASmaxOutChatstateClientNotificationRequest","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){function a(a){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=d("WASmaxOutChatstateClientNotificationRequest").makeClientNotificationRequest(a);yield d("WAComms").castSmaxStanza(a)});return h.apply(this,arguments)}g.sendClientNotificationRPC=a}),98);
__d("WASendChatStateProtocol",["WALogger","WASmaxChatstateClientNotificationRPC"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["sendChatStateProtocol Sending "," to ",""])),b,a);var c;b==="idle"?c={isPaused:!0}:(b,c={composing:{hasComposingMediaAudio:b==="recording_audio"}});return d("WASmaxChatstateClientNotificationRPC").sendClientNotificationRPC({chatstateTo:a,stateTypesArgs:c})}g.sendChatStateProtocol=a}),98);
__d("MAWSendChatStateFromComposerApi",["FBLogger","MAWMessageComposingHooks","Promise","WASendChatStateProtocol"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(a){var e=a.chatJid;a=a.state;d("WASendChatStateProtocol").sendChatStateProtocol(e,a)["catch"](function(a){return c("FBLogger")(a).mustfix("Caught while sending chat state from composer.")});d("MAWMessageComposingHooks").callMessageComposingHooks(e,a);return(h||(h=b("Promise"))).resolve()};g.sendChatStateFromComposer=a}),98);
__d("MAWWriteEditMsgApi",["MAWIndexedDb","MAWTransactionMode","MAWWriteEditTxns"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,editMsgHistory:a.READWRITE,media:a.READONLY,messages:a.READWRITE,receiverFetchInfo:a.READONLY,threads:a.READWRITE,xma:a.READONLY},"writeEditMsg",function(a){return function(b,c,e){c={args:c,externalId:b,ts:e};return d("MAWWriteEditTxns").writeEdit(a,c).then(function(a){return a})}});g.writeEditMsg=b}),98);
__d("MAWSendEditMsg",["MAWMessageSendsCommon","MAWMpsGating","MAWMsgType","MAWSendWrittenMsg","MAWWriteEditMsgApi","SendMsgArgsToProtobuf","WAJids","WAQPLProxy","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(a,b,c,d,e,f){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f,g){if(d("MAWMpsGating").isFullMpsEnabled()){var k={author:d("WAJids").AUTHOR_ME,chat:b,externalId:c};b={messageApplication:d("SendMsgArgsToProtobuf").createMessageApplication(d("MAWMsgType").MSG_TYPE.EDIT_ACTION,a,b)};b=(yield d("MAWSendWrittenMsg").sendWrittenMsgExternal({protocolMsgId:k,referencedOriginalExternalId:c,type:"edit"},d("WAQPLProxy").waQPLProxyStartResume(f,g),"MAWSendEditMsg",b));if(b.success===!1)return d("WAResultOrError").makeError(b.error);else return d("WAResultOrError").makeResult({chatJid:k.chat,content:a.editMsgContent.content,externalId:k.externalId,messageType:"editMsg",specialTextSize:a.specialTextSize})}b=(yield d("MAWWriteEditMsgApi").writeEditMsg(c,a,e));if(!b.success)if(b.error==="missing_thread"){d("MAWMessageSendsCommon").messageSendLogger.WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["sendEditMsg cannot send to a non-existent thread"])));return d("WAResultOrError").makeError({isRetriable:!1,type:"missing-thread"})}else if(b.error==="missing_msg"){d("MAWMessageSendsCommon").messageSendLogger.WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["sendEditMsg cannot edit to a non-existent message"])));return d("WAResultOrError").makeError({isRetriable:!1,type:"missing-referenced-msg"})}else{b.error;d("MAWMessageSendsCommon").messageSendLogger.WARN(j||(j=babelHelpers.taggedTemplateLiteralLoose(["sendEditMsg already sent a message"])));return d("WAResultOrError").makeError({isRetriable:!1,type:"already-sent"})}k=(yield d("MAWSendWrittenMsg").sendWrittenMsgExternal({protocolMsgId:b.value.protocolMsgId,referencedOriginalExternalId:b.value.originalMsgExternalId,type:"edit"},d("WAQPLProxy").waQPLProxyStartResume(f,g),"MAWSendEditMsg"));if(k.success===!1)return d("WAResultOrError").makeError(k.error);else return d("WAResultOrError").makeResult({chatJid:b.value.protocolMsgId.chat,content:a.editMsgContent.content,externalId:b.value.protocolMsgId.externalId,messageType:"editMsg",specialTextSize:a.specialTextSize})});return l.apply(this,arguments)}function a(a){var b=a.args,c=a.chatJid,e=a.externalId,f=a.qplEventType,g=a.qplInstanceKey;return d("MAWMessageSendsCommon").messageSendObserver(f,g,function(a){return k(b,c,e,a,f,g)},"edit",{author:d("WAJids").AUTHOR_ME,chat:c,externalId:e})}g.sendEditMsgFn=a}),98);
__d("MAWSendMsg",["MAWMessageSendsCommon","MAWMpsGating","MAWMsgType","MAWQplProxy","MAWSendWrittenMsg","MAWTSUtils","MAWWriteOutgoingMsgApi","SendMsgArgsToProtobuf","WAAPI","WAJids","WAQPLProxy","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function a(a){var b=a.args,c=a.chatJid,e=a.externalId,f=a.qplEventType,g=a.qplInstanceKey;return d("MAWMessageSendsCommon").messageSendObserver(f,g,function(a){var h;return k(b,c,e,(h=d("MAWTSUtils").gatedLSOptimisticTsToMaybeUnixTime((h=b.optimisticMsg)==null?void 0:h.ts))!=null?h:a,f,g)},"msg",{author:d("WAJids").AUTHOR_ME,chat:c,externalId:e})}function k(a,b,c,d,e,f){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f,g,k){d("MAWQplProxy").sendQplPointThroughBridge(g,"received_message_in_wajob",{instanceKey:k});d("MAWQplProxy").sendQplPointThroughBridge(g,"fetch_devices_start",{instanceKey:k});yield c("WAAPI").getDevicesBeforeSend({chatJid:b,reason:"sendMsg"});d("MAWQplProxy").sendQplPointThroughBridge(g,"fetch_devices_end",{instanceKey:k});var l=null;!d("MAWMpsGating").isFullMpsEnabled()?f=(yield d("MAWWriteOutgoingMsgApi").writeOutgoingMsg(e,b,f,a,d("MAWMsgType").MSG_TYPE.TEXT,g,k)):(f={protocolMsgId:{author:d("WAJids").AUTHOR_ME,chat:b,externalId:e}},l={messageApplication:d("SendMsgArgsToProtobuf").createMessageApplication(d("MAWMsgType").MSG_TYPE.TEXT,a,b)});d("MAWMessageSendsCommon").messageSendLogger.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["sendMsg: ",""])),b);if(f.type==="already_sent"){d("MAWMessageSendsCommon").messageSendLogger.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["sendMsg already sent message"])));d("MAWQplProxy").sendQplPointThroughBridge(g,"message_already_sent_to_backend",{instanceKey:k});return d("WAResultOrError").makeError({isRetriable:!1,type:"already-sent"})}if(f.type==="missing_thread"){d("MAWMessageSendsCommon").messageSendLogger.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["sendMsg cannot send to a non-existent thread"])));d("MAWQplProxy").sendQplPointThroughBridge(g,"failed_message_missing_thread",{instanceKey:k});return d("WAResultOrError").makeError({isRetriable:!1,type:"missing-thread"})}d("MAWQplProxy").sendQplPointThroughBridge(g,"sending_message_start",{instanceKey:k});e=(yield d("MAWSendWrittenMsg").sendWrittenMsgExternal({protocolMsgId:f.protocolMsgId,type:"message"},d("WAQPLProxy").waQPLProxyStartResume(g,k),"MAWSendMsg",l));if(e.success===!0){d("MAWQplProxy").sendQplPointThroughBridge(g,"sending_message_end",{instanceKey:k});b={chatJid:f.protocolMsgId.chat,content:a.content,ephemeralSetting:a.ephemeralSetting,externalId:f.protocolMsgId.externalId,initiatingSource:a.initiatingSource,messageType:"sendMsg",quote:a.quote,source:a.source,specialTextSize:a.specialTextSize,xmaMessageType:a.xmaMessageType};return d("WAResultOrError").makeResult(b)}else{d("MAWQplProxy").sendQplPointThroughBridge(g,"sending_message_fail",{annotations:{string:{errorType:e.error.type}},instanceKey:k});return d("WAResultOrError").makeError(e.error)}});return l.apply(this,arguments)}g.sendMsgFn=a}),98);
__d("MAWWritePollApi",["MAWIndexedDb","MAWTransactionMode","MAWWriteGroupPollCreateTxns","WAJids"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({participants:d("MAWTransactionMode").READONLY,poll:d("MAWTransactionMode").READWRITE},"writePoll",function(a){return function(b,c,e,f,g){return d("MAWWriteGroupPollCreateTxns").savePollToDb(a,e,f,d("WAJids").AUTHOR_ME,g).then(function(a){d("MAWWriteGroupPollCreateTxns").sendPollToUI(a,b,c)})}});g.writePoll=a}),98);
__d("MAWSendPoll",["MAWGroupPollsDualEncryptionUtils","MAWMessageSendsCommon","MAWMsgType","MAWWriteOutgoingMsgApi","MAWWritePollApi","Promise","WAJids","WAResultOrError","WATimeUtils","asyncToGeneratorRuntime","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i=0;function j(a){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.args,f=a.chatJid,g=a.externalId,j=a.qplInstanceKey;a=a.ts;var k=e.options,l=e.title,m=(yield (h||(h=b("Promise"))).all(k.map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield d("MAWGroupPollsDualEncryptionUtils").getHashForOptionName(a));return{optionHash:b,optionText:a}});return function(b){return a.apply(this,arguments)}}())));m=new Map(m.map(function(a){var b=a.optionHash;a=a.optionText;return[b,{optionText:a,voteAuthors:new Set()}]}));var n=self.crypto.getRandomValues(new Uint8Array(32)).buffer;e=(yield d("MAWWriteOutgoingMsgApi").writeOutgoingMsg(g,f,a,e,d("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE,c("qpl")._(25313175,"1551"),j));if(e.type==="missing_thread")return d("WAResultOrError").makeError({isRetriable:!1,type:"missing-thread"});if(e.type==="already_sent")return d("WAResultOrError").makeError({isRetriable:!1,type:"already-sent"});j=e.msgId;e={encKey:n,latestSenderTimestampsMs:new Map(),name:l,options:k,optionsHashed:m,selectableOptionsCount:i};yield d("MAWWritePollApi").writePoll(j,d("WATimeUtils").castUnixTimeToMillisTime(a),f,e,g);return d("WAResultOrError").makeResult({chatJid:f,externalId:g,messageType:"sendPoll"})});return k.apply(this,arguments)}function a(a){var b=a.args,e=a.chatJid,f=a.externalId,g=a.qplInstanceKey;return d("MAWMessageSendsCommon").messageSendObserver(c("qpl")._(25313175,"1551"),g,function(a){return j({args:b,chatJid:e,externalId:f,qplInstanceKey:g,ts:a})},"poll",{author:d("WAJids").AUTHOR_ME,chat:e,externalId:f})}g.sendPoll=a}),98);
__d("MAWSendPollUpdate",["Promise","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(){return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult({description:"sendPollUpdate",messageType:"fixMe"}))}g.sendPollUpdate=a}),98);
__d("MAWSendReactionMsg",["MAWIndexedDb","MAWMessageSendsCommon","MAWMpsGating","MAWSendWrittenMsg","MAWTransactionMode","MAWWriteReactionMsgApi","SendMsgArgsToProtobuf","WAAPI","WAJids","WALongInt","WAMsgType","WAQPLProxy","WAResultOrError","WATimeUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;function l(a){return a==="\u2764\ufe0f"?"\u2764":a}function m(a,b,c,d){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f){var g=a.args,m=a.chatJid;a=a.externalId;d("MAWMessageSendsCommon").messageSendLogger.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["sendReactionMsg: ",""])),m);if(d("MAWMpsGating").isFullMpsEnabled()){var n={author:d("WAJids").AUTHOR_ME,chat:m,externalId:a},q={messageApplication:d("SendMsgArgsToProtobuf").createMessageApplication(d("WAMsgType").MSG_TYPE.REACTION,g,m)};n=(yield d("MAWSendWrittenMsg").sendWrittenMsgExternal({protocolMsgId:n,referencedOriginalExternalId:a,type:"edit"},d("WAQPLProxy").waQPLProxyStartResume(e,f),"MAWSendEditMsg",q));if(n.success===!1)return d("WAResultOrError").makeError(n.error);else return d("WAResultOrError").makeResult({chatJid:m,externalId:a,messageType:"reactionMsg",reaction:g.reaction,source:g.source})}q=g.reaction;n=g.reactToProtocolMsgId;q=l(q);var r=d("WAJids").toMsgrUserJid(g.reactToAuthor),s=(yield p(n.externalId));s=(yield o(s));yield c("WAAPI").getDevicesBeforeSend({chatJid:m,reason:"sendReactionMsg"});q=(yield d("MAWWriteReactionMsgApi").writeReactionMsg(a,m,{groupingKey:q,reaction:q,reactToAuthor:r,reactToExternalId:n.externalId,senderTimestampMs:s},b));if(q.type==="already_sent"){d("MAWMessageSendsCommon").messageSendLogger.DEBUG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["sendReactionMsg already sent message"])));return d("WAResultOrError").makeError({isRetriable:!1,type:"already-sent"})}else if(q.type==="missing_thread"){d("MAWMessageSendsCommon").messageSendLogger.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["sendReactionMsg cannot send to a non-existent thread"])));return d("WAResultOrError").makeError({isRetriable:!1,type:"missing-thread"})}else if(q.type==="missing_msg"){d("MAWMessageSendsCommon").messageSendLogger.DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["sendReactionMsg cannot react to a non-existent message"])));return d("WAResultOrError").makeError({isRetriable:!1,type:"missing-referenced-msg"})}r=(yield d("MAWSendWrittenMsg").sendWrittenMsgExternal({protocolMsgId:q.protocolMsgId,type:"reaction"},d("WAQPLProxy").waQPLProxyStartResume(e,f),"MAWSendReactionMsg"));if(r.success===!1)return d("WAResultOrError").makeError(r.error);else return d("WAResultOrError").makeResult({chatJid:m,externalId:a,messageType:"reactionMsg",reaction:g.reaction,source:g.source})});return n.apply(this,arguments)}function a(a){var b=a.args,c=a.chatJid,e=a.externalId,f=a.qplEventType,g=a.qplInstanceKey;return d("MAWMessageSendsCommon").messageSendObserver(f,g,function(a){return m({args:b,chatJid:c,externalId:e},a,f,g)},"reaction",{author:d("WAJids").AUTHOR_ME,chat:c,externalId:e})}function o(a){a=a.map(function(a){return d("WALongInt").maybeNumberOrThrowIfTooLarge(a.senderTimestampMs)}).filter(Boolean).reduce(function(a,b){return Math.max(a,b)},0);return Math.max((a!=null?a:0)+1,d("WATimeUtils").unixTimeMs())}var p=d("MAWIndexedDb").makeMsgrTransactor({reactions:d("MAWTransactionMode").READONLY},"findMatchingReactionBeforeSendReactionMsg",function(a){return function(b){return a.reactions.where("reactToExternalId").equals(b).toArray()}});g.sanitizeReaction=l;g.sendReactionMsgFn=a;g.calculateSenderTimestampMs=o}),98);
__d("MAWSendXMAShareMsg",["MAWMessageSendsCommon","WAJids","cr:2959"],(function(a,b,c,d,e,f,g){"use strict";var h=["qplEventType","qplInstanceKey"];function a(a){var c=a.qplEventType,e=a.qplInstanceKey,f=babelHelpers.objectWithoutPropertiesLoose(a,h);return d("MAWMessageSendsCommon").messageSendObserver(c,e,function(a){return b("cr:2959")(f,a,c,e)},"xma",{author:d("WAJids").AUTHOR_ME,chat:a.chatJid,externalId:a.xmaMsgExternalId})}g.sendXMAShareMsgFn=a}),98);
__d("MAWSetEphemeralSettingsFromFrontendApi",["FBLogger","MAWEphemeralSettingsTxns","MAWExternalId","MAWIndexedDb","MAWSendEphemeralSettingMsg","MAWTransactionMode","Promise","WAResultOrError","WATimeUtils","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,ephemeralSettings:a.READWRITE,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,threads:a.READWRITE},"handleAndWriteOutgoingUserEphemeralSettingChange",function(a){return function(b,c,e,f){return d("MAWEphemeralSettingsTxns").handleAndWriteOutgoingUserEphemeralSettingChange(a,b,c,e,f)}});e=function(a){var e=a.chatJid,f=a.ephemeralExpirationInSec,g=a.ephemeralLastUpdatedOrSetTimestamp,j=a.isEphemeralSettingReset,k=a.s2sInstanceKey;if(e==null){c("FBLogger")("messenger_web").mustfix("Both chatJid and threadId passed to setEphemeralSettingsFromFrontend are null");return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeError({isRetriable:!1,type:"missing-thread"}))}var l=g!=null?g:d("WATimeUtils").unixTime();return i(e,f,l,j).then(function(a){if(a.value.shouldUpdateSetting===!1)return d("WAResultOrError").makeResult({description:"send not needed",messageType:"fixMe"});a={ephemeralExpirationInSec:f,ephemeralLastUpdatedOrSetTimestamp:l};return d("MAWSendEphemeralSettingMsg").sendEphemeralSettingMsgFn({args:{ephemeralSetting:a,isEphemeralSettingReset:j,isForSyncResponse:!1},chatJid:e,externalId:d("MAWExternalId").generateExternalId(),qplEventType:c("qpl")._(25313175,"1551"),qplInstanceKey:k})})};g.setEphemeralSettingsFromFrontend=e}),98);
__d("MAWSetEphemeralSettingsOfPeerFromMIApi",["MAWDbGroupInfoTxns","MAWDexieTable","MAWEphemeralSettingsTxns","MAWGetOrCreateThreadTxns","MAWIndexedDb","MAWTransactionMode","WAJids","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=d("MAWIndexedDb").makeMsgrTransactor({ephemeralSettings:(a=d("MAWTransactionMode")).READWRITE,groupInfo:a.READWRITE,messages:a.READWRITE,threads:a.READWRITE},"handleAndWriteIncomingEphemeralSetting",function(a){return function(b,c,e,f,g,h,i){var j=d("WAJids").interpretAsGroupJid(c);j=d("MAWDexieTable").dexieAll([d("MAWGetOrCreateThreadTxns").getExistingThread(a,c),j!=null?d("MAWDbGroupInfoTxns").getGroupInfo(a,j):d("MAWDexieTable").dexieResolve()]);return j.then(function(b){var e,f=b[0];b=b[1];if(f!=null)return{created:!1,thread:f};f=b==null||(e=b.value)==null?void 0:e.creationTs;return d("MAWGetOrCreateThreadTxns").getOrCreateThread(a,{createTs:f==null?null:d("WATimeUtils").castUnixTimeToMillisTime(f),description:"handleAndWriteIncomingEphemeralSetting",jid:c})}).then(function(c){c=c.thread;return d("MAWEphemeralSettingsTxns").handleAndWriteIncomingEphemeralSetting(a,b,e,f,g,c,i,null,h)})}});b=function(a){var b=a.author,c=a.chatJid,d=a.ephemeralExpirationInSec,e=a.ephemeralLastUpdatedOrSetTimestamp,f=a.fromWAI,g=a.isEphemeralSettingReset;a=a.serverTs;return h(b,c,d,e,g,f,a).then(function(){return{success:!0}})};g.setEphemeralSettingsFromMI=b}),98);
__d("MAWUpdateDeviceChangeAlertsApi",["MAWDbGetUnArchivedDeviceChangeAlertsCountTxn","MAWDbUpdateDeviceChangeAlertsTxn","MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({deviceChangeAlerts:d("MAWTransactionMode").READWRITE},"updateDeviceChangeAlerts",function(a){return function(b){return d("MAWDbUpdateDeviceChangeAlertsTxn").updateDeviceChangeAlertsTxn(a,b).then(function(b){return d("MAWDbGetUnArchivedDeviceChangeAlertsCountTxn").getUnArchivedDeviceChangeAlertsCountTxn(a).then(function(){return b})})}});g.updateDeviceChangeAlerts=a}),98);
__d("MAWUpdateLSThreadFromGroupInfoApi",["MAWBridgeTypesCreators","MAWIndexedDb","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({groupInfo:d("MAWTransactionMode").READONLY},"updateLSThreadFromGroupInfo",function(a){return function(b){return a.groupInfo.get(b).then(function(a){a!=null&&d("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:d("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(a)})})}});g.updateLSThreadFromGroupInfo=a}),98);
__d("MAWUpdateMediaDownloadStatusByObjectIdApi",["MAWGetMediaByObjectId","MAWMediaDownloadStatusForUI","MWFBLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){var e=(yield d("MAWGetMediaByObjectId").getMediaByObjectId(a)),f=e.value;if(f==null||e.success!==!0){d("MWFBLogger").MWMediaLogger.tags(["MediaDownload"]).WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["updateMediaDownloadStatusByObjectId - media not found for objectId: ",""])),a);return}d("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:c,hash:f.plaintextHash,status:b,type:"main"})});return function(b,c,d){return a.apply(this,arguments)}}();g.updateMediaDownloadStatusByObjectId=a}),98);
__d("MAWUpdateReceiverFetchInfoApi",["MAWIndexedDb","MAWTransactionMode","MAWWriteReceiverFetchTxns"],(function(a,b,c,d,e,f,g){"use strict";a=d("MAWIndexedDb").makeMsgrTransactor({receiverFetchInfo:d("MAWTransactionMode").READWRITE},"MAWUpdateReceiverFetchInfo",function(a){return function(b){var c=b.accessibilitySummaryText,e=b.mimetype,f=b.previewHeight,g=b.previewUrl,h=b.previewUrlExpirationTimestampMs,i=b.previewWidth,j=b.receiverFetchId;b=b.type;return d("MAWWriteReceiverFetchTxns").updateReceiverFetchInfoWithPreviewUrl(a,g,h,j,c,e,f,i,b)}});g.updateReceiverFetchInfo=a}),98);
__d("MpsToMawDbEditMsgHistory",["WAJids","WAStanzaUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b,c,e,f=a.deserialize().encryptedTransportMessage(),g=f==null||(b=f.consumerMessage())==null||(b=b.payload)==null||(b=b.content)==null?void 0:b.editMessage;f=f==null||(c=f.consumerMessage())==null||(c=c.metadata)==null?void 0:c.specialTextSize;return g==null?null:{author:a.getAuthor(),editExternalId:d("WAStanzaUtils").toStanzaId(a.getExternalId()),editTs:a.getUnixTs(),msgContent:{commands:(e=g.message)==null?void 0:e.commands,content:((e=(e=g.message)==null?void 0:e.text)!=null?e:"")+" *",mentionedJids:(e=g.message)==null?void 0:e.mentionedJid.map(d("WAJids").validateUserJid).filter(Boolean)},sendStatus:1,specialTextSize:f,threadJid:a.getChatJid()}}g.mpsToMawDbEditMsgHistory=a}),98);
__d("MpsToMawDbMsg",["FBLogger","MAWAckLevel","MAWMsgType","MpsAdminMsgToBridge","MpsMediaToBridge","MpsMessageToBridgeWrapper","MpsToMawDbEditMsgHistory","WAJids","WAStanzaUtils","getErrorSafe","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var e,f,g,h,i,j,k,l=a.deserialize().encryptedTransportMessage(),m=l==null||(e=l.consumerMessage())==null||(e=e.payload)==null||(e=e.content)==null?void 0:e.messageText,n=l==null||(f=l.consumerMessage())==null||(f=f.metadata)==null?void 0:f.specialTextSize,o=l==null||(g=l.proto.metadata)==null?void 0:g.isForwarded,p=l==null||(h=l.armadillo())==null||(h=h.proto.payload)==null||(h=h.content)==null||(h=h.bumpExistingMessage)==null?void 0:h.key,q=l==null||(i=l.armadillo())==null||(i=i.payload)==null||(i=i.content)==null?void 0:i.extendedContentMessage,r=l==null||(j=l.consumerMessage())==null||(j=j.payload)==null||(j=j.applicationData)==null?void 0:j.revoke;k=(k=a.deserialize().adminMessage())==null?void 0:k.proto;b=((b=b==null?void 0:b.supplementalProtobufs.values().toArray())!=null?b:[]).map(function(b){return d("MpsToMawDbEditMsgHistory").mpsToMawDbEditMsgHistory(d("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromSupplemental(b,a.message))}).filter(Boolean).sort(function(a,b){return b.editTs-a.editTs});var s=b.length<=0?null:b[0];s={ack:d("MAWAckLevel").ACK.received,altIndex:void 0,author:a.getAuthor(),editCount:b.length,externalId:d("WAStanzaUtils").toStanzaId(a.getExternalId()),isForwarded:o,msgContent:{commands:(o=(b=s==null?void 0:s.msgContent.commands)!=null?b:m==null?void 0:m.commands)!=null?o:[],content:(o=(b=s==null?void 0:s.msgContent.content)!=null?b:m==null?void 0:m.text)!=null?o:"",mentionedJids:(o=(b=s==null?void 0:s.msgContent.mentionedJids)!=null?b:m==null?void 0:m.mentionedJid.map(d("WAJids").validateUserJid).filter(Boolean))!=null?o:[]},msgId:a.getMsgId(),quote:void 0,quoteExpirationTs:void 0,quoteExternalId:void 0,serverTs:a.getUnixTs(),sortOrderMs:a.message.timestampMs,specialTextSize:n,threadJid:a.getChatJid(),ts:a.getUnixTs()};if(r!=null)return babelHelpers["extends"]({},s,{revokedExternalId:d("WAStanzaUtils").toStanzaId(a.getExternalId()),type:d("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:a.getUnixTs()});if(p!=null){b=p.id;m=d("WAStanzaUtils").toStanzaId(c("nullthrows")(b));o=d("WAJids").unsafeCoerceToUserJid(c("nullthrows")(p.remoteJid));return babelHelpers["extends"]({},s,{quote:{content:{author:o,externalId:m,ts:void 0,type:d("MAWMsgType").MSG_TYPE.IMAGE},remoteJid:null},quoteExternalId:m,type:d("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE})}if(q!=null){n=q.targetType;return babelHelpers["extends"]({},s,{type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:c("nullthrows")(n,"[MPS2MAW] XMA message must have targetType")})}if(k!=null)try{r=c("nullthrows")(d("MpsAdminMsgToBridge").getMessageContent(a.message.senderId,k));return babelHelpers["extends"]({},s,{author:"@system",msgContent:{adminMsgContent:r.adminMsgContent,adminType:r.adminType,version:r.version},type:d("MAWMsgType").MSG_TYPE.ADMIN})}catch(a){c("FBLogger")("mps").catching(c("getErrorSafe")(a)).warn("Failed to get admin message content")}b=d("MpsMediaToBridge").getMediaTypeForMedia(a.deserialize());if(b!=null)switch(b){case d("MAWMsgType").MSG_TYPE.PTT:return babelHelpers["extends"]({},s,{type:d("MAWMsgType").MSG_TYPE.PTT});case d("MAWMsgType").MSG_TYPE.IMAGE:return babelHelpers["extends"]({},s,{type:d("MAWMsgType").MSG_TYPE.IMAGE});case d("MAWMsgType").MSG_TYPE.VIDEO:return babelHelpers["extends"]({},s,{type:d("MAWMsgType").MSG_TYPE.VIDEO});case d("MAWMsgType").MSG_TYPE.GIF:return babelHelpers["extends"]({},s,{type:d("MAWMsgType").MSG_TYPE.GIF});case d("MAWMsgType").MSG_TYPE.STICKER:var t;o=(p=l==null||(t=l.consumerMessage())==null||(t=t.stickerMessage())==null?void 0:t.payload)!=null?p:{};m=o.ancillary;q=o.integral;k=(n=q==null?void 0:q.receiverFetchId)!=null?n:m==null?void 0:m.receiverFetchId;return k!=null?babelHelpers["extends"]({},s,{receiverFetchId:k,type:d("MAWMsgType").MSG_TYPE.RECEIVER_FETCH}):babelHelpers["extends"]({},s,{type:d("MAWMsgType").MSG_TYPE.STICKER});case d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return babelHelpers["extends"]({},s,{type:d("MAWMsgType").MSG_TYPE.DOCUMENT_FILE})}return babelHelpers["extends"]({},s,{type:d("MAWMsgType").MSG_TYPE.TEXT})}g.mpsToMawDbMsg=a}),98);
__d("MpsToMawDbReaction",["MAWAckLevel","MpsTypes","WAJids","WAStanzaUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=d("WAJids").createJidUtils({platform:"msgr"});function a(a){var b;b=(b=a.deserialize().encryptedTransportMessage())==null||(b=b.consumerMessage())==null||(b=b.payload)==null||(b=b.content)==null?void 0:b.reactionMessage;return b==null?null:{ack:d("MAWAckLevel").ACK.received,author:a.getAuthor(),externalId:d("WAStanzaUtils").toStanzaId(a.getExternalId()),groupingKey:void 0,reaction:b.text,reactToAuthor:h.toUserJid(a.topLevel.senderId),reactToExternalId:d("MpsTypes").messageIdToStanzaId(a.topLevel.messageId),senderTimestampMs:b.senderTimestampMs,threadJid:a.getChatJid(),ts:a.getUnixTs()}}g.mpsToMawDbReaction=a}),98);
__d("MAWSnippetsCacheServiceForMPS",["MAWCacheServiceBase","MAWDbMsg","MAWDbReaction","MAWGetThreadUpdateType","MAWThreadNewestMsgOrReactionUtils","MAWThreadSnippet","MAWThreadSnippetBuildTxns","MpsMessageToBridgeWrapper","MpsToMawDbMsg","MpsToMawDbReaction","MpsTypes","Promise","WAJids","WALongInt","WebMps","asyncToGeneratorRuntime","cr:21515","nullthrows","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(a){function e(){return a.call(this,"snippets")||this}babelHelpers.inheritsLoose(e,a);var f=e.prototype;f.$MAWSnippetsCacheService$p_1=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=d("MpsToMawDbMsg").mpsToMawDbMsg(d("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(a),null),e=d("MAWThreadNewestMsgOrReactionUtils").filterForSnippet(d("MAWGetThreadUpdateType").getThreadUpdateTypeForMsg(c),!1);if(!e)return;var f=d("WAJids").unsafeCoerceToChatJid(a.threadId);e=(yield this.getValueFromCache(f));if(e==null)return this.$MAWSnippetsCacheService$p_2(f).then(function(a){if(a==null)return;return[f,a]});if(e.timestamp>a.timestampMs)return;e=d("MAWThreadSnippet").buildThreadSnippetV2({chatJid:f,dbMsg:c});return(h||(h=b("Promise"))).resolve([f,{key:f,timestamp:d("MAWDbMsg").getSortOrderWithFallback(c),value:{snippet:e,snippetMsgId:c.msgId}}])});function c(b){return a.apply(this,arguments)}return c}();f.$MAWSnippetsCacheService$p_3=function(a){var e=c("nullthrows")(a.directive);switch(e.actionType){case d("MpsTypes").ActionType.Unknown:case d("MpsTypes").ActionType.Noop:case d("MpsTypes").ActionType.Preprocess:case d("MpsTypes").ActionType.DeleteThread:case d("MpsTypes").ActionType.DeleteSupplemental:return(h||(h=b("Promise"))).resolve();case d("MpsTypes").ActionType.UpsertTopLevel:return this.$MAWSnippetsCacheService$p_1(a.message);case d("MpsTypes").ActionType.DeleteTopLevel:case d("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder:case d("MpsTypes").ActionType.UpsertSupplemental:return this.$MAWSnippetsCacheService$p_2(d("WAJids").unsafeCoerceToChatJid(a.message.threadId)).then(function(b){return b==null?void 0:[a.message.threadId,b]})}};f.calculateDelta=function(a){var c=this;return(h||(h=b("Promise"))).all(a.map(function(a){return c.$MAWSnippetsCacheService$p_3(a)})).then(function(a){return a.filter(Boolean)})};f.$MAWSnippetsCacheService$p_2=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=(yield d("WebMps").mps().loadMessages({config:{shouldFetchSupplementals:!0,strategy:"local-only"},debug:{purpose:"update_snippet_from_scratch"},direction:"desc",from:[d("MpsTypes").toTimestamp(Number.MAX_SAFE_INTEGER),null],numMessages:20,threadId:d("MpsTypes").toThreadId(a)}));if(e.success===!1)return;b("cr:21515")&&c("promiseDone")(b("cr:21515").submitEBMessagesToPLL(e.value));var f=e.value.messages.map(function(a){return d("MpsToMawDbMsg").mpsToMawDbMsg(d("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(a.toplevelProtobuf),a)});f=f.find(function(a){return d("MAWThreadNewestMsgOrReactionUtils").filterForSnippet(d("MAWGetThreadUpdateType").getThreadUpdateTypeForMsg(a),!1)});e=e.value.messages.flatMap(function(a){return Array.from(a.supplementalProtobufs.values()).map(function(b){return{supplemental:b,topLevel:a.toplevelProtobuf}})}).map(function(a){var b=a.supplemental;a=a.topLevel;return d("MpsToMawDbReaction").mpsToMawDbReaction(d("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromSupplemental(b,a))}).filter(Boolean).map(function(a){return d("MAWDbReaction").maybeCastToIncomingDbReaction(a)}).filter(Boolean);e=e.length===0?null:e.sort(function(a,b){return b.ts-a.ts})[0];if(f==null&&e==null)return;var g=null;if(e!=null&&e.ts>(f!=null?d("MAWDbMsg").getCanonicalTsFromMsg(f):0)){var h;g=d("MAWThreadSnippetBuildTxns").buildReactionThreadSnippet(e.author,e.reaction,a);return{key:a,timestamp:(h=d("WALongInt").maybeNumber(e.senderTimestampMs))!=null?h:0,value:{snippet:g,snippetReactionId:e.reactionId}}}else if(f!=null){g=d("MAWThreadSnippet").buildThreadSnippetV2({chatJid:a,dbMsg:f});return{key:a,timestamp:d("MAWDbMsg").getSortOrderWithFallback(f),value:{snippet:g,snippetMsgId:f.msgId}}}});function e(b){return a.apply(this,arguments)}return e}();f.computeCachePayloadFromScratch=function(a){var c=this;return(h||(h=b("Promise"))).all(a.map(function(a){return c.$MAWSnippetsCacheService$p_2(d("WAJids").unsafeCoerceToChatJid(a)).then(function(b){return b==null?null:[a,b]})})).then(function(a){return a.filter(Boolean)})};f.shouldDropDelta=function(a){return(h||(h=b("Promise"))).resolve(!1)};return e}(c("MAWCacheServiceBase"));var i=new a();e=function(){return i};g.MAWSnippetsCacheService=a;g.getMAWSnippetsCacheService=e}),98);
__d("MAWWorkerCacheServicesForMPS",["FBLogger","MAWBridge","MAWCacheServiceDB","MAWCacheServiceQPL","MAWCacheServiceUtils","MAWLoggerUtils","MAWMpsGating","MAWSnippetsCacheServiceForMPS","Promise","WorkerScheduler","asyncToGeneratorRuntime","err","gkx","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";var h;a=d("MAWSnippetsCacheServiceForMPS").getMAWSnippetsCacheService();var i=[a],j=function(){function a(){this.$1=d("MAWCacheServiceUtils").getMAWCacheServiceBroadcastChannel(),this.registry=i,this.schedulerRegistry=i.map(function(a){return a.namespace}).reduce(function(a,b){return babelHelpers["extends"]({},a,(a={},a[b]=d("WorkerScheduler").makeScheduler(d("MAWCacheServiceUtils").getSchedulerName(b),d("MAWCacheServiceUtils").SCHEDULER_CONFIG),a))},{})}var e=a.prototype;e.$2=function(a,b,c,e){if(!d("MAWMpsGating").isFullMpsEnabled())return;b={cache:b,instanceKey:e,namespace:a,source:c};this.$1==null?d("MAWBridge").getBridge().fireAndForget("event","broadcastChannelFallback",{event:{data:b},namespace:d("MAWCacheServiceUtils").MAW_CACHE_SERVICE_BROADCAST_CHANNEL}):this.$1.postMessage(b)};e.$3=function(a){return d("MAWMpsGating").isFullMpsEnabled()?a:a+"_mps_reactive"};e.$4=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f){var g=this,h=a.namespace,i=d("MAWCacheServiceUtils").findDuplicates(b,function(a){var b=a[0];a[1];return b});i.length>0&&(c("FBLogger")("MAWCacheService").mustfix("Found duplicate keys in cache: %s. Original keys: %s, Namespace: %s, Source: %s",i.map(function(a){var b=a[0];a[1];return b}).join(", "),b.map(function(a){var b=a[0];a[1];return b}).join(", "),h,e),f!=null&&c("MAWCacheServiceQPL").addAnnotationsQPL(f,{bool:{hasDuplicateKeys:!0},string_array:{duplicateKeys:c("MAWCacheServiceQPL").redactKeysForNonEmployee(i.map(function(a){var b=a[0];a[1];return b}))}}));if(b.length===0){f!=null&&(c("MAWCacheServiceQPL").addPointQPL(f,"nothing_to_update_in_cache",e),c("MAWCacheServiceQPL").endSuccessQPL(f));return}f!=null&&c("MAWCacheServiceQPL").addPointQPL(f,"updating_cache_in_persisted_start",e);a.updateInMemoryCacheBulk(b);try{var j=d("MAWCacheServiceDB").convertCacheValueToDBRawValue(b).map(function(a){return babelHelpers["extends"]({},a,{key:g.$3(a.key)})});i=(yield d("MAWCacheServiceDB").getOrSetupMAWCacheDB());yield i.runInTransaction([h],"readwrite",function(a){var b=j.map(function(a){return{item:a,selector:[a.key]}});return a.stores[h].bulkUpsert("key",b)},"update_cache_"+h);f!=null&&c("MAWCacheServiceQPL").addPointQPL(f,"updating_cache_in_persisted_end",e)}catch(a){f!=null&&(c("MAWCacheServiceQPL").addAnnotationsQPL(f,{string:{error:a.message}}),c("MAWCacheServiceQPL").addPointQPL(f,"updating_cache_in_persisted_failed",e)),c("FBLogger")("MAWCacheService").catching(a).mustfix("Failed to update persisted cache")}f!=null&&c("MAWCacheServiceQPL").addPointQPL(f,"broadcasting_to_ui_start",e);this.$2(h,b,e,f)});function e(b,c,d,e){return a.apply(this,arguments)}return e}();e.$5=function(a,e){var f=this,g=c("gkx")("14458")?a.shouldDropDelta(e):(h||(h=b("Promise"))).resolve(!1);return g.then(function(b){if(b)return;b=f.schedulerRegistry[a.namespace];return b.runTask({fn:function(){return a.calculateDelta(e).then(function(b){var e=b.map(function(a){var b=a[0];a[1];return b}),g=d("MAWLoggerUtils").getInstanceKey();b.length!==0&&(c("MAWCacheServiceQPL").startQPL(g,a.namespace),c("MAWCacheServiceQPL").addAnnotationsQPL(g,{bool:{isRealtimeUpdate:!0},"int":{instanceKey:g},string_array:{realtimeUpdatedKeys:e}}));return f.$4(a,b,"realtime-update",g)})["catch"](function(b){c("FBLogger")("MAWCacheService").catching(b).warn("Failed to calculate delta for: %s",a.namespace)})},name:"maw_calculate_delta",priority:d("WorkerScheduler").REGULAR_PRIORITY})})};e.calculateDelta=function(a){var d=this,e=this.registry.map(function(b){return d.$5(b,a)});(h||(h=b("Promise"))).all([].concat(e))["catch"](function(a){c("FBLogger")("MAWCacheService").catching(a).mustfix("Failed to calculate delta for all services")})};e.computeCachePayloadFromScratch=function(a,b,e,f){var g=this;f!=null&&c("MAWCacheServiceQPL").registerInstanceKeyInWorker(f);c("MAWCacheServiceQPL").addPointQPL(f,"compute_from_scratch_start",e);c("MAWCacheServiceQPL").addAnnotationsQPL(f,{string_array:{keysReceivedInWorker:c("MAWCacheServiceQPL").redactKeysForNonEmployee(b)}});var h=c("nullthrows")(this.registry.find(function(b){return b.namespace===a})),i=this.schedulerRegistry[h.namespace];if(h==null)throw c("err")("No service found for namespace: "+a);return i.runTask({fn:function(){return h.computeCachePayloadFromScratch(b).then(function(a){c("MAWCacheServiceQPL").addPointQPL(f,"compute_from_scratch_end",e);return g.$4(h,a,e,f)})["catch"](function(a){c("MAWCacheServiceQPL").endFailureQPL(f,"compute_from_scratch_failed",e),c("FBLogger")("MAWCacheService").catching(a).warn("Failed to compute cache payload from scratch")})},name:"maw_compute_cache_payload_from_scratch",priority:d("WorkerScheduler").REGULAR_PRIORITY})};return a}(),k=null;e=function(){k==null&&(k=new j());return k};g.getMAWWorkerCacheServices=e}),98);
__d("mawAdminWriteDualThreadCutoverMsgTxns",["MAWDbThreadTxns","MAWExternalId","MAWLocalizationType","MAWLocalizationUtils","MAWWriteMsgTxns","WALogger","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,c){return d("MAWDbThreadTxns").getThread(a,b).then(function(b){if(!b.success){d("WALogger").WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["dualThreadCutover failed to get the thread"])));return{needsMarkThreadAsMigrated:!1}}b=b.value;if(b.didInsertDualThreadCutoverAdminMsg===!0)return{needsMarkThreadAsMigrated:!1};var e=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:d("MAWLocalizationType").LOCALIZATION_TYPE.DUAL_THREAD_CUTOVER_ADMIN_MESSAGE,version:1},b.jid,d("MAWExternalId").generateExternalId(),d("WATimeUtils").castMillisTimeToUnixTime(c)),f=babelHelpers["extends"]({},b,{didInsertDualThreadCutoverAdminMsg:!0});return a.threads.put(f).then(function(){return d("MAWWriteMsgTxns").writeMsg(a,e,f).then(function(){return{needsMarkThreadAsMigrated:!0}})})})}g["default"]=a}),98);
__d("MAWWriteAdminMessageForDualThreadCutoverApi",["MAWDbThreadTxns","MAWIndexedDb","MAWTransactionMode","mawAdminWriteDualThreadCutoverMsgTxns"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,ftsBackloggedMessages:a.READWRITE,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,threads:a.READWRITE},"writeAdminMessageForDualThreadCutover",function(a){return function(b){var e=b.chatJid;b=b.cutoverTimestampMs;return c("mawAdminWriteDualThreadCutoverMsgTxns")(a,e,b).then(function(b){b=b.needsMarkThreadAsMigrated;if(b)return d("MAWDbThreadTxns").markCutoverThreadAsMigratedLocally(a,e)})}});g.writeAdminMessageForDualThreadCutover=b}),98);
__d("MAWWriteAdminMessageForEphemeralSettingsChange",["MAWDbGroupInfoTxns","MAWDexieTable","MAWEphemeralAdminMsgBuildTxns","MAWGetOrCreateThreadTxns","MAWHIMLogger","MAWIndexedDb","MAWTransactionMode","WAJids","WAResultOrError","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";var h;a=6*d("WATimeUtils").HOUR_SECONDS;e=d("MAWIndexedDb").makeMsgrTransactor({chunk:(b=d("MAWTransactionMode")).READONLY,ephemeralSettings:b.READWRITE,ftsBackloggedMessages:b.READWRITE,groupInfo:b.READWRITE,groupInvites:b.READONLY,media:b.READONLY,messages:b.READWRITE,reactions:b.READONLY,threads:b.READWRITE,xma:b.READONLY},"writeAdminMessageForEphemeralSettingsChange",function(a){return function(b){var e=b.author,f=b.chatJid,g=b.expirationInSec,i=b.externalId,j=b.isEphemeralSettingReset,k=b.isTurningOnEphemeralSetting,l=b.serverTs;b=d("WAJids").interpretAsGroupJid(f);b=d("MAWDexieTable").dexieAll([d("MAWGetOrCreateThreadTxns").getExistingThread(a,f),b!=null?d("MAWDbGroupInfoTxns").getGroupInfo(a,b):d("MAWDexieTable").dexieResolve()]);return b.then(function(b){var c,e=b[0];b=b[1];if(e!=null)return{created:!1,thread:e};e=b==null||(c=b.value)==null?void 0:c.creationTs;return d("MAWGetOrCreateThreadTxns").getOrCreateThread(a,{createTs:e==null?null:d("WATimeUtils").castUnixTimeToMillisTime(e),description:"writeAdminMessageForEphemeralSettingsChange",jid:f})}).then(function(b){b=b==null?void 0:b.thread;if(b==null){c("MAWHIMLogger").MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Cannot create a thread for message after missing thread creation attempt"])));return d("WAResultOrError").makeError({type:"no_thread"})}return d("MAWEphemeralAdminMsgBuildTxns").writeEphemeralSettingAdminMsg(a,e,g,l,b,k,j,i)}).then(c("emptyFunction"))}});g.REVOKE_CONTENT_EXPIRATION_IN_SEC=a;g.writeAdminMessageForEphemeralSettingsChange=e}),98);
__d("MAWWriteLimitSharingAdminMsgTxns",["MAWLocalizationUtils","MAWWriteLimitSharingAdminMsgContent","MAWWriteMsgTxns","WATimeUtils","emptyFunction","err"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e,f,g,h){return a.threads.get({jid:e}).then(function(e){if(e==null)throw c("err")("Invalid chat Id when try to write admin message for limit sharing");var i=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg(d("MAWWriteLimitSharingAdminMsgContent").getAdminMsgContent(b,g),e.jid,f,d("WATimeUtils").castMillisTimeToUnixTime(h),void 0,h);return d("MAWWriteMsgTxns").writeDedupedAdminMessage(a,i,e,h).then(c("emptyFunction"))})}g.writeLimitSharingAdminMsg=a}),98);
__d("MAWWriteAdminMessageForLimitSharingApi",["MAWIndexedDb","MAWTransactionMode","MAWWriteLimitSharingAdminMsgTxns"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,ftsBackloggedMessages:a.READWRITE,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,threads:a.READWRITE},"MAWWriteAdminMessageForLimitSharing",function(a){return function(b){var c=b.actorFbid,e=b.chatJid,f=b.externalId,g=b.isLimitSharingEnabled;b=b.serverAuthoritativeTimestampMs;return d("MAWWriteLimitSharingAdminMsgTxns").writeLimitSharingAdminMsg(a,c,e,f,g,b)}});g.writeAdminMessageForLimitSharing=b}),98);
__d("MAWWritePinMessageAdminMsgTxns",["FBLogger","MAWLocalizationUtils","MAWWriteMsgTxns","MAWWritePinMessageAdminMsgContent","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e,f,g){return a.threads.get({jid:e}).then(function(e){if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("Invalid chat Id when try to write admin message for pin message");var h=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg(d("MAWWritePinMessageAdminMsgContent").getAdminMsgContent(b),e.jid,f,d("WATimeUtils").castMillisTimeToUnixTime(g),void 0,g);return d("MAWWriteMsgTxns").writeDedupedAdminMessage(a,h,e,g).then(c("emptyFunction"))})}g.writePinMessageAdminMsg=a}),98);
__d("MAWWriteAdminMessageForPinMessageApi",["MAWIndexedDb","MAWTransactionMode","MAWWritePinMessageAdminMsgTxns"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,ftsBackloggedMessages:a.READWRITE,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,threads:a.READWRITE},"MAWWriteAdminMessageForPinMessage",function(a){return function(b){var c=b.actorFbid,e=b.chatJid,f=b.externalId;b=b.serverAuthoritativeTimestampMs;return d("MAWWritePinMessageAdminMsgTxns").writePinMessageAdminMsg(a,c,e,f,b)}});g.writeAdminMessageForPinMessage=b}),98);
__d("MAWWriteThreadHotlikeCustomizationAdminMsgTxns",["FBLogger","MAWLocalizationUtils","MAWWriteMsgTxns","MAWWriteThreadHotlikeCustomizationAdminMsgContent","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e,f,g,h){return a.threads.get({jid:f}).then(function(f){if(f==null)throw c("FBLogger")("messenger_web").mustfixThrow("Invalid chat Id when try to write admin message for thread hotlike customization");var i=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg(d("MAWWriteThreadHotlikeCustomizationAdminMsgContent").getAdminMsgContent(b,e),f.jid,g,d("WATimeUtils").castMillisTimeToUnixTime(h),void 0,h);return d("MAWWriteMsgTxns").writeDedupedAdminMessage(a,i,f,h).then(c("emptyFunction"))})}g.writeThreadHotlikeCustomizationAdminMsg=a}),98);
__d("MAWWriteAdminMessageForThreadHotlikeCustomizationApi",["MAWIndexedDb","MAWTransactionMode","MAWWriteThreadHotlikeCustomizationAdminMsgTxns"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,ftsBackloggedMessages:a.READWRITE,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,threads:a.READWRITE},"writeAdminMessageForThreadHotlikeCustomization",function(a){return function(b){var c=b.actorFbid,e=b.chatJid,f=b.externalId,g=b.serverAuthoritativeTimestampMs;b=b.threadIcon;return d("MAWWriteThreadHotlikeCustomizationAdminMsgTxns").writeThreadHotlikeCustomizationAdminMsg(a,c,b,e,f,g)}});g.writeAdminMessageForThreadHotlikeCustomization=b}),98);
__d("MAWWriteThreadNicknameCustomizationAdminMsgTxns",["FBLogger","MAWLocalizationUtils","MAWWriteMsgTxns","MAWWriteThreadNicknameCustomizationAdminMsgContent","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e,f,g,h,i){return a.threads.get({jid:e}).then(function(e){if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("Invalid chat Id when try to write admin message for thread nickname customization");var j=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg(d("MAWWriteThreadNicknameCustomizationAdminMsgContent").getAdminMsgContent(b,g,f),e.jid,h,d("WATimeUtils").castMillisTimeToUnixTime(i),void 0,i);return d("MAWWriteMsgTxns").writeDedupedAdminMessage(a,j,e,i).then(c("emptyFunction"))})}g.writeThreadNicknameCustomizationAdminMsg=a}),98);
__d("MAWWriteAdminMessageForThreadNicknameCustomizationApi",["MAWIndexedDb","MAWTransactionMode","MAWWriteThreadNicknameCustomizationAdminMsgTxns"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,ftsBackloggedMessages:a.READWRITE,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,threads:a.READWRITE},"writeAdminMessageForThreadNicknameCustomization",function(a){return function(b){var c=b.actorFbid,e=b.chatJid,f=b.externalId,g=b.nickName,h=b.participantId;b=b.serverAuthoritativeTimestampMs;return d("MAWWriteThreadNicknameCustomizationAdminMsgTxns").writeThreadNicknameCustomizationAdminMsg(a,c,e,g,h,f,b)}});g.writeAdminMessageForThreadNicknameCustomization=b}),98);
__d("MAWWriteThreadPhotoCustomizationAdminMsgTxns",["FBLogger","MAWLocalizationUtils","MAWWriteMsgTxns","MAWWriteThreadPhotoCustomizationAdminMsgContent","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e,f,g){return a.threads.get({jid:e}).then(function(e){if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("Invalid chat Id when try to write admin message for thread photo customization");var h=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg(d("MAWWriteThreadPhotoCustomizationAdminMsgContent").getAdminMsgContent(b),e.jid,f,d("WATimeUtils").castMillisTimeToUnixTime(g),void 0,g);return d("MAWWriteMsgTxns").writeDedupedAdminMessage(a,h,e,g).then(c("emptyFunction"))})}g.writeThreadPhotoCustomizationAdminMsg=a}),98);
__d("MAWWriteAdminMessageForThreadPhotoCustomizationApi",["MAWIndexedDb","MAWTransactionMode","MAWWriteThreadPhotoCustomizationAdminMsgTxns"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,ftsBackloggedMessages:a.READWRITE,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,threads:a.READWRITE},"writeAdminMessageForThreadPhotoCustomization",function(a){return function(b){var c=b.actorFbid,e=b.chatJid,f=b.externalId;b=b.serverAuthoritativeTimestampMs;return d("MAWWriteThreadPhotoCustomizationAdminMsgTxns").writeThreadPhotoCustomizationAdminMsg(a,c,e,f,b)}});g.writeAdminMessageForThreadPhotoCustomization=b}),98);
__d("MAWWriteThreadThemeCustomizationAdminMsgTxns",["FBLogger","MAWLocalizationUtils","MAWWriteMsgTxns","MAWWriteThreadThemeCustomizationAdminMsgContent","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e,f,g,h,i,j){return a.threads.get({jid:g}).then(function(g){if(g==null)throw c("FBLogger")("messenger_web").mustfixThrow("Invalid chat Id when try to write admin message for thread theme customization");var k=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg(d("MAWWriteThreadThemeCustomizationAdminMsgContent").getAdminMsgContent(b,e,f,j),g.jid,h,d("WATimeUtils").castMillisTimeToUnixTime(i),void 0,i);return d("MAWWriteMsgTxns").writeDedupedAdminMessage(a,k,g,i).then(c("emptyFunction"))})}g.writeThreadThemeCustomizationAdminMsg=a}),98);
__d("MAWWriteAdminMessageForThreadThemeCustomizationApi",["MAWIndexedDb","MAWTransactionMode","MAWWriteThreadThemeCustomizationAdminMsgTxns"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,ftsBackloggedMessages:a.READWRITE,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,threads:a.READWRITE},"writeAdminMessageForThreadThemeCustomization",function(a){return function(b){var c=b.actorFbid,e=b.chatJid,f=b.externalId,g=b.serverAuthoritativeTimestampMs,h=b.themeEmoji,i=b.themeNameWithSubtitle;b=b.themeType;return d("MAWWriteThreadThemeCustomizationAdminMsgTxns").writeThreadThemeCustomizationAdminMsg(a,c,h,i,e,f,g,b)}});g.writeAdminMessageForThreadThemeCustomization=b}),98);
__d("MAWWriteUKOSAAdminMsgTxns",["FBLogger","MAWLocalizationUtils","MAWWriteMsgTxns","MAWWriteUKOSAAdminMsgContent","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e,f,g){return a.threads.get({jid:e}).then(function(e){if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("Invalid chat Id when try to write admin message for UK OSA");var h=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg(d("MAWWriteUKOSAAdminMsgContent").getAdminMsgContent(b),e.jid,f,d("WATimeUtils").castMillisTimeToUnixTime(g),void 0,g);return d("MAWWriteMsgTxns").writeDedupedAdminMessage(a,h,e,g).then(c("emptyFunction"))})}g.writeUKOSAAdminMsg=a}),98);
__d("MAWWriteAdminMessageForUKOSAApi",["MAWIndexedDb","MAWTransactionMode","MAWWriteUKOSAAdminMsgTxns"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,ftsBackloggedMessages:a.READWRITE,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,threads:a.READWRITE},"MAWwriteAdminMessageForUKOSA",function(a){return function(b){var c=b.actorFbid,e=b.chatJid,f=b.externalId;b=b.serverAuthoritativeTimestampMs;return d("MAWWriteUKOSAAdminMsgTxns").writeUKOSAAdminMsg(a,c,e,f,b)}});g.writeAdminMessageForUKOSA=b}),98);
__d("MAWWriteUnpinMessageAdminMsgTxns",["FBLogger","MAWLocalizationUtils","MAWWriteMsgTxns","MAWWriteUnpinMessageAdminMsgContent","WATimeUtils","emptyFunction"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,e,f,g){return a.threads.get({jid:e}).then(function(e){if(e==null)throw c("FBLogger")("messenger_web").mustfixThrow("Invalid chat Id when try to write admin message for unpin message");var h=d("MAWLocalizationUtils").buildUnstoredDbAdminMsg(d("MAWWriteUnpinMessageAdminMsgContent").getAdminMsgContent(b),e.jid,f,d("WATimeUtils").castMillisTimeToUnixTime(g),void 0,g);return d("MAWWriteMsgTxns").writeDedupedAdminMessage(a,h,e,g).then(c("emptyFunction"))})}g.writeUnpinMessageAdminMsg=a}),98);
__d("MAWWriteAdminMessageForUnpinMessageApi",["MAWIndexedDb","MAWTransactionMode","MAWWriteUnpinMessageAdminMsgTxns"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,ftsBackloggedMessages:a.READWRITE,groupInfo:a.READONLY,media:a.READONLY,messages:a.READWRITE,threads:a.READWRITE},"MAWWriteAdminMessageForUnpinMessage",function(a){return function(b){var c=b.actorFbid,e=b.chatJid,f=b.externalId;b=b.serverAuthoritativeTimestampMs;return d("MAWWriteUnpinMessageAdminMsgTxns").writeUnpinMessageAdminMsg(a,c,e,f,b)}});g.writeAdminMessageForUnpinMessage=b}),98);
__d("WAGetRemotePublicIdentity",["WAJids","WASignalDB","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";a=function(a,c){return d("WASignalDB").getDb().runInTransaction(["identity"],"readonly",function(){var e=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var e=d("WAJids").toMsgrUserJid(c);e=d("WAJids").toDeviceJid(e,a);b=(yield b.stores.identity.get(e));return b==null?void 0:b.identity});return function(a){return e.apply(this,arguments)}}(),d("WASignalDB").signalOp("getRemotePublicIdentityKey"))};g.getRemotePublicIdentity=a}),98);
__d("WAGetThreadDevicesInfoApi",["WAHex","WAJids","WASignalDB","WATimeUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";a=function(a){var c=a.fbid;return d("WASignalDB").getDb().runInTransaction(["identity"],"readonly",function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=d("WAJids").toMsgrUserJid(c);a=(yield a.stores.identity.readIndex("userJid",[b]));return a.map(function(a){return{deviceId:d("WAJids").extractDeviceId(a.deviceJid),firstSeenTs:a.firstSeenTs!=null?d("WATimeUtils").toDate(a.firstSeenTs):null,identityKey:d("WAHex").toHex(a.identity).replace(/(.{2})/g,"$1 ").trim()}})});return function(b){return a.apply(this,arguments)}}(),d("WASignalDB").signalOp("getThreadDevicesInfo"))};g.getThreadDevicesInfo=a}),98);
__d("MAWBridgeHandlers",["EBGating","EBLS","EBMessageMetadataCache","EBSMDBAPI","EBWorkerAddDeviceUtils","EBWorkerAddDeviceWithKeys","EBWorkerAddDeviceWithPin","EBWorkerEBSMStateUtils","EBWorkerGetEBState","EBWorkerOptOut","EncryptedBackupsDYIMediaDownload","EncryptedBackupsUploadQueueAckUtils","IGDHandleContinueMediaDownload","MAWAddGroupParticipants","MAWBulkCancelDownloadMediaForUI","MAWBulkLoadMessagesForThread","MAWBulkMaybeCreateOrUpdateThreadScheduler","MAWBulkMaybeUpsertThreadAndParticipants","MAWCancelDownloadMediaForUI","MAWChangeSecurityAlertSettingApi","MAWChangeSecurityAlertSettingForSelfApi","MAWClearSignalAndTempStores","MAWCommonScheduler","MAWCompleteUndoThreadCutoverApi","MAWConvertEchoMessagesToEBProtobufs","MAWConvertEchoMessagesToMsgStanzas","MAWCreateGroup","MAWCreateOrUpdateThreadApi","MAWDeleteMediaChunks_FOR_TESTING_ONLY","MAWDeleteMsgsForMe","MAWDeleteThreadApi","MAWDownloadMediaForUI","MAWDyiDownloadMedia","MAWEBLSInWorkerSwitch","MAWEBUploadTrackingUtils","MAWEncryptedBackupsStateManager","MAWEphemeralSettingsCache","MAWFTSDataSync","MAWFTSEBMessagesDataSync","MAWFTSIssueGraphQLRangeRestoreRequest","MAWForwardEBLSEbEnabledStateChangesToMainThread","MAWForwardMsg","MAWGetBlobDataUrlByMediaIdApi","MAWGetDeviceChangeAlertsByOptionsApi","MAWGetEphemeralSettingsApi","MAWGetGroupSuperAdminApi","MAWGetLatestChatJids","MAWGetLatestThreadIdsApi","MAWGetMaybeNextNonAdminMsgSortOrderMsApi","MAWGetMediaDownloadStatusApi","MAWGetMediaValidationResultApi","MAWGetProtocolMsgIdByMediaMsgId","MAWGetProtocolMsgIdByMsgId","MAWGetReceiverFetchInfoApi","MAWGetRedactedRegistrationInfoForBugnub","MAWGetReportedQplEvents","MAWGetSecureThreadTotalCount","MAWGetSecurityAlertSettingApi","MAWGetSecurityAlertSettingForSelfAndContactApi","MAWGetThreadConsistencyInfo","MAWGetThreadLastMessageTsApi","MAWGetThreadLastNumMessagesBySortOrderApi","MAWGetThreadsInfoApi","MAWGetThumbnailBlobDataUrlByMediaIdApi","MAWGetWAIDevices","MAWGetWATimeApi","MAWGetWorkerHeartbeatApi","MAWGroupSetMemberAddMode","MAWHandleMediaRestoreCdnUrlResult","MAWIdentifyCollapsedMessagesByExternalId","MAWIdentifyXMAWithAssociatedTextByExternalId","MAWInsertAdminMessageInCutoverThreadsApi","MAWLoadMediaApi","MAWLoadMoreScheduler","MAWLoadMsgsApi","MAWLoadThreadsTxns","MAWLowLevelMediaDownloadQplBridgeHandler","MAWMarkBackupAsCompleted","MAWMarkThreadAsUnreadApi","MAWMpsGating","MAWOptimisticUploadMedia","MAWRemoveGroupParticipants","MAWRestoreMsgsTxns","MAWRevokeMsg","MAWSaveRTCCallXMAMsg","MAWSendBumpMsg","MAWSendChatStateFromComposerApi","MAWSendEditMsg","MAWSendGroupInviteMsg","MAWSendMediaMsg","MAWSendMsg","MAWSendNoteReplyMsg","MAWSendPoll","MAWSendPollUpdate","MAWSendReactionMsg","MAWSendXMAShareMsg","MAWSetEphemeralSettingsFromFrontendApi","MAWSetEphemeralSettingsOfPeerFromMIApi","MAWSetGroupSubject","MAWStateManagerSyncToMainThread","MAWUpdateDeviceChangeAlertsApi","MAWUpdateLSThreadFromGroupInfoApi","MAWUpdateMediaDownloadStatusByObjectIdApi","MAWUpdateReceiverFetchInfoApi","MAWWorkerCacheServices","MAWWorkerCacheServicesForMPS","MAWWriteAdminMessageForDualThreadCutoverApi","MAWWriteAdminMessageForEphemeralSettingsChange","MAWWriteAdminMessageForLimitSharingApi","MAWWriteAdminMessageForPinMessageApi","MAWWriteAdminMessageForThreadHotlikeCustomizationApi","MAWWriteAdminMessageForThreadNicknameCustomizationApi","MAWWriteAdminMessageForThreadPhotoCustomizationApi","MAWWriteAdminMessageForThreadThemeCustomizationApi","MAWWriteAdminMessageForUKOSAApi","MAWWriteAdminMessageForUnpinMessageApi","Promise","WAGetCurrentUserDeviceInfoApi","WAGetRemotePublicIdentity","WAGetThreadDevicesInfoApi","WALogger","WorkerScheduler","asyncToGeneratorRuntime","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h=["mimeType","plaintext"],i,j,k,l,m;a={ackWithInstanceKey:function(a){return d("EncryptedBackupsUploadQueueAckUtils").ackWithInstanceKey(a.instanceKey,a.success)},ackWithInstanceKeyBatched:function(a){return d("EncryptedBackupsUploadQueueAckUtils").ackWithInstanceKeyBatched(a)},addDeviceWithKeysInWorker:function(a){return d("EBWorkerAddDeviceWithKeys").addDeviceWithKeysInWorker(a.source)},addDeviceWithPinInWorker:function(a){return d("EBWorkerAddDeviceWithPin").addDeviceWithPinInWorker(a.recoveryCode,a.userId)},addEbUploadTrackingWorkerQPL:function(a){return d("MAWEBUploadTrackingUtils").handleBridgeEbUploadTrackingQPL(a.qplType,a.qplInstanceKey,a.pointName,a.annotations)},addGroupParticipants:function(a){return d("MAWAddGroupParticipants").addGroupParticipantsFn(a)},addMediaDownloadQpl:function(a){return d("MAWLowLevelMediaDownloadQplBridgeHandler").handleBridgeMediaDownloadQPL(a.qplType,a.qplInstanceKey,a.pointName,a.annotations)},backupWriteCompletionHook:function(){d("WALogger").WARN(i||(i=babelHelpers.taggedTemplateLiteralLoose(["[messenger_e2ee_web] Handler not implemented and should not be used outside of Instamadillo"])));return(m||(m=b("Promise"))).resolve()},bulkCancelDownloadMediaForUI:function(a){return d("MAWBulkCancelDownloadMediaForUI").bulkCancelDownloadMediaForUI(a.hashes)},bulkDownloadMediaForUI:function(a){return d("MAWDownloadMediaForUI").bulkDownloadMediaForUI(a)},bulkLoadMessagesForThread:function(a){return d("MAWBulkLoadMessagesForThread").bulkLoadMessagesForThread(a)},bulkMaybeCreateOrUpdateThread:function(a,b){return d("MAWBulkMaybeCreateOrUpdateThreadScheduler").bulkMaybeCreateOrUpdateThreadScheduler().runTask({fn:function(){return d("MAWBulkMaybeUpsertThreadAndParticipants").bulkMaybeCreateOrUpdateThread(a,b)},name:"maw_maybe_create_or_update_thread",priority:d("WorkerScheduler").BLOCKING_PRIORITY})},cancelDownloadMediaForUI:function(a){return d("MAWCancelDownloadMediaForUI").cancelDownloadMediaForUI(a.hash)},changeSecurityAlertSetting:function(a){return d("MAWChangeSecurityAlertSettingApi").changeSecurityAlertSetting(a.isEnableAlert)},changeSecurityAlertSettingForSelf:function(a){return d("MAWChangeSecurityAlertSettingForSelfApi").changeSecurityAlertSettingForSelf(a.isEnableSelfAlert)},checkForDecryptionFailuresToPointRestore:function(){return d("MAWRestoreMsgsTxns").checkForDecryptionFailuresToPointRestore()},checkIfGroupParticipant:function(a){return d("MAWLoadThreadsTxns").checkIfGroupParticipant(a)},clearSignalAndTempStores:function(a){return d("MAWClearSignalAndTempStores").clearSignalAndTempStores()},clearWorkerEBSMReStore:function(a){return d("EBLS").clearEBSMStorage()},clearWorkerEBStateDBOnLogout:function(a){return d("EBSMDBAPI").clearEBIDBNonPersistedRows({hasUserGivenAutoRestoreConsent:a.hasUserGivenAutoRestoreConsent})},completeUndoThreadCutover:function(a){return d("MAWCompleteUndoThreadCutoverApi").completeUndoThreadCutover(a)},computeCachePayloadFromScratch:function(a){var b=d("MAWMpsGating").isFullMpsEnabled()?d("MAWWorkerCacheServicesForMPS").getMAWWorkerCacheServices:d("MAWWorkerCacheServices").getMAWWorkerCacheServices;if(a.isLowPriority)return d("MAWCommonScheduler").mawCommonScheduler().runTask({fn:function(){return b().computeCachePayloadFromScratch(a.namespace,a.keys,"cache-invalidation",a.instanceKey)},name:"maw_compute_cache_payload_from_scratch",priority:d("WorkerScheduler").BACKGROUND_PRIORITY});else return b().computeCachePayloadFromScratch(a.namespace,a.keys,"from-scratch",a.instanceKey)},continueMediaDownload:function(a){return d("IGDHandleContinueMediaDownload").handleContinueMediaDownload(a)},convertEchoMessagesToEBProtobufs:function(a){return d("MAWConvertEchoMessagesToEBProtobufs").convertEchoMessagesToEBProtobufs(a.encodedEchoMessages,a.chatJid)},convertEchoMessagesToMsgStanzas:function(a){return d("MAWConvertEchoMessagesToMsgStanzas").convertEchoMessagesToMsgStanzas(a.encodedEchoMessages,a.chatJid)},createGroup:function(a){return d("MAWCreateGroup").createGroupFn(a)},createOrUpdateThread:function(a){return d("MAWCreateOrUpdateThreadApi").createOrUpdateThread(a)},deleteMediaChunks_FOR_TESTING_ONLY:function(a){return d("MAWDeleteMediaChunks_FOR_TESTING_ONLY").deleteMediaChunks_FOR_TESTING_ONLY(a.plaintextHashes)},deleteMsgsForMe:function(a){return d("MAWDeleteMsgsForMe").deleteMsgsForMeFn(a)},deleteThread:function(a){return d("MAWDeleteThreadApi").deleteThread(a.chatJid)},downloadMediaForUI:function(a){return d("MAWDownloadMediaForUI").downloadMediaForUI(a)},dyiDownloadMedia:function(a){return d("MAWDyiDownloadMedia").dyiDownloadMedia(a.protocolMsgId,a.hash,a.mediaEntry)},dyiDownloadMediaV2:function(a){return d("EncryptedBackupsDYIMediaDownload").downloadDYIMedia({mediaEntry:a.mediaEntry,plaintextHash:a.plaintextHash,protocolMsgId:a.protocolMsgId,sortOrderMs:a.sortOrderMs})},dyiGetThreadList:function(){d("WALogger").WARN(j||(j=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][labyrinth_dyi] Attempted to call the old DYI V1 flow"])));return(m||(m=b("Promise"))).resolve()},ebOptOutInWorker:function(a){return d("EBWorkerOptOut").ebOptOutInWorker()},forwardMsg:function(a){return d("MAWForwardMsg").forwardMsgFn(a)},getAllThreadsAsJson:function(){d("WALogger").WARN(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][labyrinth_dyi] Attempted to call the old DYI V1 flow"])));return(m||(m=b("Promise"))).resolve({})},getBlobDataUrlByHashedPlaintextHash:function(a){return d("MAWGetBlobDataUrlByMediaIdApi").getBlobDataUrlByHashedPlaintextHash(a.plaintextHash,a.description,a.qplInstanceKey)},getBlobDataUrlByMediaId:function(a){return d("MAWGetBlobDataUrlByMediaIdApi").getBlobDataUrlByMediaId(a.mediaId,a.description,a.qplInstanceKey)},getBlobDataUrlByPlaintextHash:function(a){return d("MAWGetBlobDataUrlByMediaIdApi").getBlobDataUrlByPlaintextHash(a.plaintextHash,a.description,a.qplInstanceKey)},getCurrentUserDeviceId:function(){return d("WAGetCurrentUserDeviceInfoApi").getCurrentUserDeviceId()},getCurrentUserDeviceInfo:function(){return d("WAGetCurrentUserDeviceInfoApi").getCurrentUserDeviceInfo()},getDeviceChangeAlertsByOptions:function(a){return d("MAWGetDeviceChangeAlertsByOptionsApi").getDeviceChangeAlertsByOptions(a.options)},getEBMetadataCacheDetailsForThread:function(a){return d("EBMessageMetadataCache").getCacheDetailsForThreadForLogging(a)},getEBSMWorkerState:function(){return d("EBWorkerEBSMStateUtils").getEBSMWorkerState()},getEphemeralSettings:function(a){return d("MAWGetEphemeralSettingsApi").getEphemeralSettings(a.threadId)},getGroupSuperAdmin:function(a){return d("MAWGetGroupSuperAdminApi").getGroupSuperAdmin(a.chatJid)},getIdentityKeys:function(a){return d("EBWorkerAddDeviceUtils").getIdentityKeysInWorker()},getLatestChatJids:function(a){return d("MAWGetLatestChatJids").getLatestChatJids(a.count)},getLatestThreadIds:function(a){return d("MAWGetLatestThreadIdsApi").getLatestThreadIds(a.numThreads)},getMaybeNextNonAdminMsgSortOrderMs:function(a){return d("MAWGetMaybeNextNonAdminMsgSortOrderMsApi").getMaybeNextNonAdminMsgSortOrderMs(a.chatJid,a.mayBeAdminMsgId)},getMediaDownloadStatusByMediaId:function(a){return d("MAWGetMediaDownloadStatusApi").getMediaDownloadStatusByMediaId(a.mediaId,a.qplInstanceKey)},getMediaDownloadStatusByPlaintextHash:function(a){return d("MAWGetMediaDownloadStatusApi").getMediaDownloadStatusByPlaintextHash(a.plaintextHash,a.qplInstanceKey)},getMediaRestoreNextTimestamp:function(a){return d("MAWFTSEBMessagesDataSync").getMediaRestoreNextTimestamp(a)},getMediaValidationResultByMediaId:function(a){return d("MAWGetMediaValidationResultApi").getMediaValidationResultByMediaId(a.mediaId,a.qplInstanceKey)},getMediaValidationResultByPlainTextHash:function(a){return d("MAWGetMediaValidationResultApi").getMediaValidationResultByPlainTextHash(a.plaintextHash,a.qplInstanceKey)},getProtocolMsgIdByMediaMsgId:function(a){return d("MAWGetProtocolMsgIdByMediaMsgId").getProtocolMsgIdByMediaMsgId(a.msgId)},getProtocolMsgIdByMsgId:function(a){return d("MAWGetProtocolMsgIdByMsgId").getProtocolMsgIdByMsgId(a.msgId)},getReceiverFetchInfo:function(a){return d("MAWGetReceiverFetchInfoApi").getReceiverFetchInfo(a)},getRedactedRegistrationInfoForBugnub:function(a){return d("MAWGetRedactedRegistrationInfoForBugnub").getRedactedRegistrationInfoForBugnub()},getRemotePublicIdentityKey:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=(yield d("WAGetRemotePublicIdentity").getRemotePublicIdentity(a.deviceId,a.userId));return a==null?null:{remotePublicIdentityKey:a}});function c(b){return a.apply(this,arguments)}return c}(),getReportedQplEvents:function(a){return d("MAWGetReportedQplEvents").getReportedQplEvents()},getSecureThreadTotalCount:function(a){return d("MAWGetSecureThreadTotalCount").getSecureThreadTotalCount()},getSecurityAlertSetting:function(a){return d("MAWGetSecurityAlertSettingApi").getSecurityAlertSetting()},getSecurityAlertSettingForSelfAndContact:function(a){return d("MAWGetSecurityAlertSettingForSelfAndContactApi").getSecurityAlertSettingForSelfAndContact()},getThreadConsistencyInfo:function(a){return d("MAWGetThreadConsistencyInfo").getThreadConsistencyInfo(a)},getThreadDevicesInfo:function(a){return d("WAGetThreadDevicesInfoApi").getThreadDevicesInfo(a)},getThreadIdByDeduplicationKey:function(a){return d("MAWGetThreadsInfoApi").getThreadIdByDeduplicationKey(a.deduplicationKey)},getThreadLastMessageTs:function(a){return d("MAWGetThreadLastMessageTsApi").getThreadLastMessageTs(a.threadKey)},getThreadLastNumMessagesBySortOrder:function(a){return d("MAWGetThreadLastNumMessagesBySortOrderApi").getThreadLastNumMessagesBySortOrder(a.threadKey,a.numMsgs)},getThreadMediaRestoreStatus:function(a){return d("MAWFTSEBMessagesDataSync").getThreadMediaRestoreStatus(a)},getThumbnailBlobDataUrlByHashedPlaintextHash:function(a){return d("MAWGetThumbnailBlobDataUrlByMediaIdApi").getThumbnailBlobDataUrlByHashedPlaintextHash(a.plaintextHash,a.description,a.qplInstanceKey)},getThumbnailBlobDataUrlByMediaId:function(a){return d("MAWGetThumbnailBlobDataUrlByMediaIdApi").getThumbnailBlobDataUrlByMediaId(a.mediaId,a.description,a.qplInstanceKey)},getWAIDevices:function(a){return d("MAWGetWAIDevices").getWAIDevices(a)},getWATime:function(){return d("MAWGetWATimeApi").getWATime()},getWorkerEBState:function(){return d("EBWorkerGetEBState").getEBWorkerState()},getWorkerHeartbeat:function(){return d("MAWGetWorkerHeartbeatApi").getWorkerHeartbeat()},handleInstamadilloDYIRangeQueryRestore:function(){d("WALogger").WARN(l||(l=babelHelpers.taggedTemplateLiteralLoose(["[maw_core_lla] Handler not implemented and should not be used outside Instamadillo"])));return(m||(m=b("Promise"))).resolve()},identifyCollapsedMessagesByExternalId:function(a){return d("MAWIdentifyCollapsedMessagesByExternalId").identifyCollapsedMessagesByExternalId(a)},identifyXMAWithAssociatedTextByExternalId:function(a){return d("MAWIdentifyXMAWithAssociatedTextByExternalId").identifyXMAWithAssociatedTextByExternalId(a)},insertAdminMessageInCutoverThreads:function(a){return d("MAWInsertAdminMessageInCutoverThreadsApi").insertAdminMessageInCutoverThreads(a)},issueGraphQLRangeRestoreRequest:function(a){return d("MAWFTSIssueGraphQLRangeRestoreRequest").issueGraphQLRangeRestoreRequest(a.chatJid,a.direction,a.sortOrderMs,a.source,a.traceId,a.threadId,a.numMessages)},loadMoreMedia:function(a){return d("MAWLoadMediaApi").loadMoreMedia(a)},loadMsgsByExternalId:function(a){return d("MAWLoadMsgsApi").loadMsgsByExternalId(a.externalId,a.config)},markBackupAsCompleted:function(a){return d("MAWMarkBackupAsCompleted").markBackupAsCompleted(a)},markThreadAsUnread:function(a){return d("MAWMarkThreadAsUnreadApi").markThreadAsUnread(a.chatJid)},maw_load_msgs:function(a){return d("MAWLoadMoreScheduler").loadMoreMessages(a)},maw_load_msgs_by_chat_jids_into_maw:function(a){return d("MAWLoadMoreScheduler").loadMessagesByChatJidsIntoMaw(a)},maw_load_msgs_range:function(a){return d("MAWLoadMoreScheduler").loadMoreMsgsRange(a)},mediaRestoreCdnUrlResult:function(a){return d("MAWHandleMediaRestoreCdnUrlResult").handleMediaRestoreCdnUrlResult(a)},optimisticUploadMedia:function(a){return d("MAWOptimisticUploadMedia").optimisticUploadMedia(a)},removeGroupParticipants:function(a){return d("MAWRemoveGroupParticipants").removeGroupParticipantsFn(a)},resendEBLSInWorkerEbEnabledState:function(a){return d("MAWForwardEBLSEbEnabledStateChangesToMainThread").sendEBLSEbEnabledStateToMainThread()},resendWorkerStateManagerValuesToMainThread:function(a){return d("MAWStateManagerSyncToMainThread").resendCurrentValuesToMainThread()},saveRTCCallXMAMsg:function(a){return d("MAWSaveRTCCallXMAMsg").saveRTCCallXMAMsg(a)},search:function(a){return d("MAWFTSDataSync").search(a)},searchFTSClearThreadRestoreStatus:function(a){return d("MAWFTSEBMessagesDataSync").searchFTSClearThreadRestoreStatus(a)},searchFTSGetThreadRestoreStatus:function(a){return d("MAWFTSEBMessagesDataSync").searchFTSGetThreadRestoreStatus(a)},searchFTSGetThreadsRestoreStatus:function(a){return d("MAWFTSEBMessagesDataSync").searchFTSGetThreadsRestoreStatus(a)},searchFTSReportTabAlive:function(a){return d("MAWFTSEBMessagesDataSync").searchFTSReportTabAlive(a)},searchFTSReportTabDestroy:function(a){return d("MAWFTSEBMessagesDataSync").searchFTSReportTabDestroy(a)},searchFTSReportTabForeground:function(a){return d("MAWFTSEBMessagesDataSync").searchFTSReportTabForeground(a)},searchFTSReportTabTaskComplete:function(a){return d("MAWFTSEBMessagesDataSync").searchFTSReportTabTaskComplete(a)},searchFTSRequestRestoreTask:function(a){return d("MAWFTSEBMessagesDataSync").searchFTSRequestRestoreTask(a)},searchGetFTSNextTimestamp:function(a){return d("MAWFTSEBMessagesDataSync").searchGetFTSNextTimestamp(a)},searchGetFTSRestoreSessionId:function(a){return d("MAWFTSEBMessagesDataSync").searchGetFTSRestoreSessionId(a)},searchIndexUpdate:function(a){return d("MAWFTSEBMessagesDataSync").searchIndexUpdate(a)},searchSetFTSNextTimestamp:function(a){return d("MAWFTSEBMessagesDataSync").searchSetFTSNextTimestamp(a)},sendBumpMsg:function(a){return d("MAWSendBumpMsg").sendBumpMsgFn(a)},sendChatStateFromComposer:function(a){return d("MAWSendChatStateFromComposerApi").sendChatStateFromComposer(a)},sendEditMsg:function(a){return d("MAWSendEditMsg").sendEditMsgFn(a)},sendGroupInviteMsg:function(a){return d("MAWSendGroupInviteMsg").sendGroupInviteMsgFn(a)},sendMediaMsgV2:function(a){var b=a.mimeType,c=a.plaintext;a=babelHelpers.objectWithoutPropertiesLoose(a,h);c=new Blob([c],{type:b});return d("MAWSendMediaMsg").sendMediaMsgFn(babelHelpers["extends"]({},a,{file:c,filename:(b=a.args.filename)!=null?b:"document"}))},sendMsg:function(a){return d("MAWSendMsg").sendMsgFn(a)},sendNoteReplyMsg:function(a){return d("MAWSendNoteReplyMsg").sendNoteReplyMsgFn(a)},sendPoll:function(a){return d("MAWSendPoll").sendPoll(a)},sendPollUpdate:function(a){return d("MAWSendPollUpdate").sendPollUpdate()},sendReactionMsg:function(a){return d("MAWSendReactionMsg").sendReactionMsgFn(a)},sendRevokeMsg:function(a){return d("MAWRevokeMsg").sendRevokeMsgFn(a)},sendXMAShareMsg:function(a){return d("MAWSendXMAShareMsg").sendXMAShareMsgFn(a)},setEncryptedBackupsState:function(a){(!c("gkx")("12414")||!d("EBGating").isEBSMv2Phase1Enabled())&&d("MAWEncryptedBackupsStateManager").setEncryptedBackupsState(a.newState)},setEphemeralSettingCache:function(a){return d("MAWEphemeralSettingsCache").setEphemeralSettingCache(a.jid,a.settings)},setEphemeralSettingsFromFrontend:function(a){return d("MAWSetEphemeralSettingsFromFrontendApi").setEphemeralSettingsFromFrontend(a)},setEphemeralSettingsFromMI:function(a){return d("MAWSetEphemeralSettingsOfPeerFromMIApi").setEphemeralSettingsFromMI(a)},setGroupMemberAddMode:function(a){return d("MAWGroupSetMemberAddMode").setMemberAddModeFn(a)},setGroupSubject:function(a){return d("MAWSetGroupSubject").setGroupSubjectFn(a)},setThreadMediaRestoreStatus:function(a){return d("MAWFTSEBMessagesDataSync").setThreadMediaRestoreStatus(a)},updateDeviceChangeAlerts:function(a){return d("MAWUpdateDeviceChangeAlertsApi").updateDeviceChangeAlerts(a.alert)},updateLSThreadFromGroupInfo:function(a){return d("MAWUpdateLSThreadFromGroupInfoApi").updateLSThreadFromGroupInfo(a.groupJid)},updateMediaDownloadStatusByObjectId:function(a){return d("MAWUpdateMediaDownloadStatusByObjectIdApi").updateMediaDownloadStatusByObjectId(a.objectId,a.downloadStatus,a.details)},updateReceiverFetchInfo:function(a){return d("MAWUpdateReceiverFetchInfoApi").updateReceiverFetchInfo(a)},waitForEBLSEbEnabled:function(a){return c("MAWEBLSInWorkerSwitch").waitForEBEnabled()},writeAdminMessageForDualThreadCutover:function(a){return d("MAWWriteAdminMessageForDualThreadCutoverApi").writeAdminMessageForDualThreadCutover(a)},writeAdminMessageForEphemeralSettingsChange:function(a){return d("MAWWriteAdminMessageForEphemeralSettingsChange").writeAdminMessageForEphemeralSettingsChange(a)},writeAdminMessageForLimitSharing:function(a){return d("MAWWriteAdminMessageForLimitSharingApi").writeAdminMessageForLimitSharing(a)},writeAdminMessageForPinMessage:function(a){return d("MAWWriteAdminMessageForPinMessageApi").writeAdminMessageForPinMessage(a)},writeAdminMessageForThreadHotlikeCustomization:function(a){return d("MAWWriteAdminMessageForThreadHotlikeCustomizationApi").writeAdminMessageForThreadHotlikeCustomization(a)},writeAdminMessageForThreadNicknameCustomization:function(a){return d("MAWWriteAdminMessageForThreadNicknameCustomizationApi").writeAdminMessageForThreadNicknameCustomization(a)},writeAdminMessageForThreadPhotoCustomization:function(a){return d("MAWWriteAdminMessageForThreadPhotoCustomizationApi").writeAdminMessageForThreadPhotoCustomization(a)},writeAdminMessageForThreadThemeCustomization:function(a){return d("MAWWriteAdminMessageForThreadThemeCustomizationApi").writeAdminMessageForThreadThemeCustomization(a)},writeAdminMessageForUKOSA:function(a){return d("MAWWriteAdminMessageForUKOSAApi").writeAdminMessageForUKOSA(a)},writeAdminMessageForUnpinMessage:function(a){return d("MAWWriteAdminMessageForUnpinMessageApi").writeAdminMessageForUnpinMessage(a)}};g.bridgeHandlers=a}),98);
__d("IGDLowLevelApiBridgeHandlers",["EncryptedBackupsUploadQueue","EncryptedBackupsUploadQueueProcessor","MAWBridgeHandlers","Promise","WALogger","asyncToGeneratorRuntime","cr:8399"],(function(a,b,c,d,e,f,g){"use strict";var h,i;a=babelHelpers["extends"]({},d("MAWBridgeHandlers").bridgeHandlers,{backupWriteCompletionHook:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=d("EncryptedBackupsUploadQueue").ebUploadQueue();yield a.queueIds.map(function(a){return b.ack([a])});d("EncryptedBackupsUploadQueueProcessor").scheduleNextRun()});function c(b){return a.apply(this,arguments)}return c}(),handleInstamadilloDYIRangeQueryRestore:function(a){if(b("cr:8399")==null){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[DYI] Instamadillo DYI is not enabled"])));return(i||(i=b("Promise"))).resolve()}return b("cr:8399")(a.threadId,a.messages,a.hasMoreBefore,a.nextMessageTimestampMsBefore)}});g.igdBridgeHandlers=a}),98);
__d("IGDBackendBridgeHandlers",["EBBridgedAPIHandler","IGDBridgedAPIHandler","IGDLowLevelApiBridgeHandlers","MAWJobManager","Promise","WABridgedAPIHandler","WAMockServerShell","WAWaitForComms","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function a(a){return babelHelpers["extends"]({},d("IGDLowLevelApiBridgeHandlers").igdBridgeHandlers,{ebapi:function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){yield d("WAWaitForComms").waitForComms();var c=d("EBBridgedAPIHandler").ebapi[b.type];c==null&&a.TAGS(["EBBridgedAPI"]).ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["handle with type "," not found"])),b.type);return c.apply(void 0,b.args)});function e(a){return c.apply(this,arguments)}return e}(),igdapi:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){yield d("WAWaitForComms").waitForComms();return d("IGDBridgedAPIHandler").igdapi(a)});function c(b){return a.apply(this,arguments)}return c}(),initMockServer:function(a){return d("WAMockServerShell").getMockServer==null?(j||(j=b("Promise"))).reject("Mock server is not available. Make sure you use worker v2"):d("WAMockServerShell").getMockServer().init(a)},minosEBAPI:function(){throw c("err")("not implemented")},runJobFireAndForget:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){yield d("WAWaitForComms").waitForComms();return d("MAWJobManager").getJobManager().fireAndForget(a)});function c(b){return a.apply(this,arguments)}return c}(),runJobWaitUntilCompleted:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){yield d("WAWaitForComms").waitForComms();return d("MAWJobManager").getJobManager().waitUntilCompleted(a)});function c(b){return a.apply(this,arguments)}return c}(),runJobWaitUntilPersisted:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){yield d("WAWaitForComms").waitForComms();return d("MAWJobManager").getJobManager().waitUntilPersisted(a)});function c(b){return a.apply(this,arguments)}return c}(),runMock:function(a){return d("WAMockServerShell").getMockServer==null?(j||(j=b("Promise"))).reject("Mock server is not available. Make sure you use worker v2"):d("WAMockServerShell").getMockServer().runMock(a)},setMockVariables:function(a){if(d("WAMockServerShell").getMockServer==null)throw c("err")("Mock server is not available. Make sure you use worker v2");d("WAMockServerShell").getMockServer().setVariables(a.variables)},waapi:function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){yield d("WAWaitForComms").waitForComms();var c=d("WABridgedAPIHandler").waapi[b.type];c==null&&a.TAGS(["WABridgedAPI"]).ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["handle with type "," not found"])),b.type);return c.apply(void 0,b.args)});function e(a){return c.apply(this,arguments)}return e}()})}g.getIGDBridgeHandlers=a}),98);
__d("IGDCOP",["MawCopScheduler","Promise","WAPubSub","WAWaitForUserUnblocked"],(function(a,b,c,d,e,f,g){"use strict";var h,i=function(){function a(){this.$1=d("WAPubSub").simplePubSub(),this.scheduler=d("MawCopScheduler").copScheduler()}var c=a.prototype;c.handleThreadMetadata=function(a){return};c.onlineProcessing=function(){return(h||(h=b("Promise"))).resolve()};c.loadMoreMsgs=function(a,c){return(h||(h=b("Promise"))).resolve()};c.subscribeToOfflineQueue=function(a,b){var c=this;a.subscribe(function(a){switch(a.type){case"offline-start":break;case"offline-end":c.$1.publish({success:!0,type:"maw-infra-end"});d("WAWaitForUserUnblocked").unblockUser();break;default:a.type;break}})};c.subscribe=function(a){return this.$1.subscribe(a)};c.TEST_ONLY_setMode=function(a){return};c.TEST_ONLY_getMode=function(){return"online"};return a}();function a(){c=new i();return c}e=a();g.cop=e}),98);
__d("IGDGetMediaKnownEntriesApi",["I64","MAWDbMsg","MAWJids","MAWMediaUtils","MAWReStoreDb","Promise","WAJids","WALogger","WAMsgMap","WAStanzaUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=(yield d("MAWReStoreDb").getDB(f.id+":35")),e=d("MAWMediaUtils").genHMACPlaintextHash(a);a=(yield c.runInTransaction(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=(yield a.e2ee_media.index("hashedPlaintextHash").get(e));if(c==null){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["No existing media entry found for hashedPlaintextHash ",". Returning new MsgMap."])),e);return new(d("WAMsgMap").MsgMap)()}var f=Array.from(c.mediaEntries.keys());f=(yield (j||(j=b("Promise"))).all(f.map(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){b=(yield a.messages.index("messageId").get(b));return b});return function(a){return c.apply(this,arguments)}}())));f=f.reduce(function(a,b){if(b!=null){var e=c.mediaEntries.get(d("MAWDbMsg").instamadilloMsgIdToMsgId(b.messageId)),f=d("WAJids").validateUserJid(d("WAJids").toMsgrUserJid((i||(i=d("I64"))).to_string(b.threadKey))),g=d("WAStanzaUtils").toStanzaId(b.offlineThreadingId);if(e&&!b.isAdminMessage&&f!=null){b={author:d("MAWJids").toUserJid((i||(i=d("I64"))).to_string(b.senderId)),chat:f,externalId:g};a.set(b,e)}}return a},new(d("WAMsgMap").MsgMap)());return f});return function(b){return a.apply(this,arguments)}}(),"readonly",void 0,void 0,f.id+":38"));return a});return function(b){return a.apply(this,arguments)}}();g.getMediaKnownEntries=a}),98);
__d("IGDGetMediaPlaintextApi",["MAWMediaUtils","MAWReStoreDb","WALogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield d("MAWReStoreDb").getDB(f.id+":25"));a=d("MAWMediaUtils").genHMACPlaintextHash(a);b=(yield b.tables.e2ee_chunk.index("hashedPlaintextHash").get(a));if(!b){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Media blob does not exist for the given hashedPlaintextHash"])));return null}return new Blob([b.blobData],{type:b.mimetype})});return function(b){return a.apply(this,arguments)}}();g.getMediaPlaintext=a}),98);
__d("IGDUpdateMediaEntryForMsgApi",["FBLogger","MAWDbMsg","MAWMediaUtils","MAWReStoreDb","WALogger","WAMediaUtils","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h,i;a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,g,j,k){var l=(yield d("MAWReStoreDb").getDB(f.id+":37"));if(!k){c("FBLogger")("igd_web","unsupported_media").mustfix("unsupported media type");throw c("err")("Media type unsupported: ")}var m=d("MAWMediaUtils").genHMACPlaintextHash(a);return l.runInTransaction(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield a.e2ee_media.index("hashedPlaintextHash").get(m)),f=(yield a.messages.index("messageId").get(e.externalId));if(!f)throw c("err")("Message does not exist for the given protocolMsgId");if(!b)throw c("err")("Media does not exist for the given hashedPlaintextHash");if(!b.msgIds.includes(f.messageId)){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose([""," msgId does not exist within media entries"])),f.messageId);return}f=d("MAWDbMsg").stanzaIdToMsgId(e.externalId);var k=b.mediaEntries.get(f);k=g(k);if(k==null){d("WALogger").LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Nothing to update if updatedMediaEntry is null"])));return}f=b.mediaEntries.set(f,k);k=babelHelpers["extends"]({},b,{mediaEntries:f});j!=null&&(k=babelHelpers["extends"]({},k,{objectId:d("WAMediaUtils").stringToDeliveryObjectId(j)}));yield a.e2ee_media.put(k)});return function(b){return a.apply(this,arguments)}}(),"readonly",void 0,void 0,f.id+":45")});return function(b,c,d,e,f){return a.apply(this,arguments)}}();g.updateMediaEntryForMsg=a}),98);
__d("InstamadilloMediaUpload",["FBLogger","IGDGetMediaKnownEntriesApi","IGDGetMediaPlaintextApi","IGDUpdateMediaEntryForMsgApi","LSIntEnum","MAWFetchXMABlob","MAWFrontendMediaUtils","MAWGetDownloadableThumbnailForMediaApi","MAWMediaUtils","MAWOptimisticUploadMedia","MAWStartMediaUploadQplFlow","MAWUpdateMediaEntryForOptimisticUploadApi","MessagingAttachmentType","WAAPI","WABlobToArrayBuffer","WAHashUtils","WAMediaCrypto","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,b,c){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){var f=(yield d("MAWMediaUtils").hashBlob(b));f=d("WAHashUtils").toPlaintextHash(f);var g=e.type==="regular"?e.mediaType:"preview",h=(yield d("MAWStartMediaUploadQplFlow").startMediaUploadQplFlow({chatJid:a.chat,fileSize:b.size,serverMediaType:g,uploadEntry:"InstamadilloMediaUpload"}));return c("WAAPI").uploadMedia({chatJid:a.chat,filename:g==="document"?b.name:void 0,getDownloadableThumbnailForMedia:d("MAWGetDownloadableThumbnailForMediaApi").getDownloadableThumbnailForMedia,getMediaKnownEntries:d("IGDGetMediaKnownEntriesApi").getMediaKnownEntries,getMediaPlaintext:d("IGDGetMediaPlaintextApi").getMediaPlaintext,hash:f,mediaTypeDetails:e,protocolMsgId:a,size:b.size,updateMediaEntryForMsg:d("IGDUpdateMediaEntryForMsgApi").updateMediaEntryForMsg,updateMediaEntryForOptimisticUpload:d("MAWUpdateMediaEntryForOptimisticUploadApi").updateMediaEntryForOptimisticUpload,uploadMediaMetric:h})});return j.apply(this,arguments)}function a(a,b,c){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){if(e.playableUrlMimeType==null)throw c("FBLogger")("igd_web").mustfixThrow("instamadilloUpload: mimeType is null");var f=d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(e.playableUrlMimeType);f=f.serverMediaType;var g=(yield i(a,b,{mediaType:f,type:"regular"}));if(g.success!==!0)throw c("FBLogger")("igd_web").mustfixThrow("instamadilloUpload: Failed to upload media");var j=null,k=(h||(h=d("LSIntEnum"))).unwrapIntEnum(e.attachmentType);e=(yield d("MAWFetchXMABlob").fetchBlob({descriptionForLogging:"InstamadilloMediaUpload",url:e.previewUrl}));if(e!=null){e=(yield e.arrayBuffer());k=k===c("MessagingAttachmentType").IMAGE||k===c("MessagingAttachmentType").VIDEO?d("MAWMediaUtils").convertJpegThumbnailArrayBufferToFile(e):null;e=new Uint8Array(yield d("WABlobToArrayBuffer").blobToArrayBuffer(b));if(k&&d("MAWOptimisticUploadMedia").shouldUploadPreview(f,b.size,e)){b=d("WAMediaCrypto").convertServerMediaTypeToPreviewMediaType(f);if(b==null)throw c("FBLogger")("igd_web").mustfixThrow("unsupported preview media type %s",f);e=(yield i(a,k,{messageType:b,type:"preview"}));if(e.success!==!0)throw c("FBLogger")("igd_web").mustfixThrow("instamadilloUpload: Failed to upload preview media");j=e.value}}return{mediaEntry:g.value,thumbnailMediaEntry:j}});return k.apply(this,arguments)}g.instamadilloUpload=a}),98);
__d("createInstamadilloMediaPayload",["FBLogger"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.directPath,d=a.duration,e=a.fileEncSha256,f=a.fileLength,g=a.fileSha256,m=a.height,n=a.isAnimated,o=a.isSticker,p=a.mediaId,q=a.mediaKey,r=a.mediaKeyTimestamp,s=a.mediaType,t=a.mimetype,u=a.objectId,v=a.sidecar,w=a.thumbnail,x=a.waveforms,y=a.waveformSamplingFrequencyHz;a=a.width;b={directPath:b,fileEncSha256:e,fileLength:f,fileSha256:g,mediaId:p,mediaKey:q,mediaKeyTimestamp:r,mimetype:t,objectId:u,sidecar:v};switch(s){case"Image":return h(m,a,b,w);case"Video":return i(m,a,b,w);case"Ptt":if(x==null)throw c("FBLogger")("igd_web").mustfixThrow("createInstamadilloMedia: waveforms is null");return j(d,b,x,y);case"Gif":return k(m,a,b,o);case"Sticker":return l(b,n);default:throw c("FBLogger")("igd_web").mustfixThrow("createInstamadilloMedia: mediaType is unsupported")}}function h(a,b,c,d){return{staticPhoto:{height:a,mediaTransport:c,thumbnail:d,width:b}}}function i(a,b,c,d){return{video:{height:a,mediaTransport:c,thumbnail:d,width:b}}}function j(a,b,c,d){return{voice:{duration:a,mediaTransport:b,waveforms:c,waveformSamplingFrequencyHz:d}}}function k(a,b,c,d){return{gif:{height:a,isSticker:d,mediaTransport:c,width:b}}}function l(a,b){return{avatarSticker:{isAnimated:b,mediaTransport:a}}}g.createInstamadilloMediaEncode=a}),98);
__d("InstamadilloSendMediaMessageUtils",["FBLogger","I64","InstamadilloMediaUpload","LSIntEnum","MAWDbMsg","MAWFetchXMABlob","MAWFrontendMediaUtils","MAWMediaUtils","MAWReStoreDb","MessagingAttachmentType","ReQL","WABase64","WABlobToArrayBuffer","WAMediaUtils","WASortedLists","WATimeUtils","asyncToGeneratorRuntime","createInstamadilloMediaPayload"],(function(a,b,c,d,e,f,g){"use strict";var h=["$$unknownFieldCount"],i=["$$unknownFieldCount"],j,k;function a(a,b,c){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){a=(yield d("ReQL").firstAsync(d("ReQL").fromTableAscending(a.attachments).getKeyRange(b,c)));return a});return l.apply(this,arguments)}function m(a){return{validatedAudioInfo:n(a),validatedDocumentFileInfo:null,validatedImageInfo:o(a),validatedVideoInfo:p(a)}}function n(a){return(j||(j=d("I64"))).equal(a==null?void 0:a.attachmentType,(k||(k=d("LSIntEnum"))).ofNumber(c("MessagingAttachmentType").AUDIO))?{duration:a.playableDurationMs!=null?(j||(j=d("I64"))).to_float(a.playableDurationMs):0,mimetype:a.playableUrlMimeType}:null}function o(a){return(j||(j=d("I64"))).equal(a==null?void 0:a.attachmentType,(k||(k=d("LSIntEnum"))).ofNumber(c("MessagingAttachmentType").IMAGE))?{height:a.previewHeight!=null?(j||(j=d("I64"))).to_float(a.previewHeight):0,width:a.previewWidth!=null?(j||(j=d("I64"))).to_float(a.previewWidth):0}:null}function p(a){return(j||(j=d("I64"))).equal(a==null?void 0:a.attachmentType,(k||(k=d("LSIntEnum"))).ofNumber(c("MessagingAttachmentType").VIDEO))?{duration:a.playableDurationMs!=null?(j||(j=d("I64"))).to_float(a.playableDurationMs):0,height:a.previewHeight!=null?(j||(j=d("I64"))).to_float(a.previewHeight):0,mimetype:a.playableUrlMimeType,width:a.previewWidth!=null?(j||(j=d("I64"))).to_float(a.previewWidth):0}:null}function q(a){var b=a.directPath,c=a.fbid,e=a.fileEncSha256,f=a.fileSha256,g=a.mediaKey,h=a.mediaKeyTimestamp;a=a.objectId;return{directPath:b!=null?b:void 0,fileEncSha256:d("WABase64").encodeB64(e),fileSha256:d("WABase64").encodeB64(f),mediaId:c!=null?c:void 0,mediaKey:d("WABase64").encodeB64(g),mediaKeyTimestamp:String(h),objectId:a!=null?a:void 0}}function e(a,b){return r.apply(this,arguments)}function r(){r=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e){var g,k=(yield d("MAWFetchXMABlob").fetchBlob({descriptionForLogging:"InstamadilloSendMediaMessageUtils",url:e.playableUrl}));if(k==null)throw c("FBLogger")("igd_web").mustfixThrow("Blob is null");var l=e.playableUrlMimeType;if(l==null)throw c("FBLogger")("igd_web").mustfixThrow("IGDSendMessageTaskHandler: mimeType is null");var n=d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(l),o=n.mediaType;n=n.serverMediaType;if(o==null)throw c("FBLogger")("igd_web").mustfixThrow("handleInstamadilloMediaSends: mediaType is null");var p=(yield d("MAWMediaUtils").genBlobHashes(k)),r=p[0],s=p[1];p=(yield d("MAWReStoreDb").getDB(f.id+":193"));var t=(yield p.runInTransaction(function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var c=(yield b.e2ee_media.index("hashedPlaintextHash").get(s)),f=new Map(c==null?void 0:c.mediaEntries),g=m(e),h=d("MAWDbMsg").stanzaIdToMsgId(a.externalId);if(c!=null){var i=d("WASortedLists").addToSet(c.msgIds,h);c=babelHelpers["extends"]({},c,g,{mediaEntries:f,msgIds:i})}else c=babelHelpers["extends"]({hashedPlaintextHash:s,mediaEntries:f,mediaType:o,msgIds:d("WASortedLists").singleElement(h),plaintextHash:r,size:k.size,ts:d("WATimeUtils").unixTime()},g);yield b.e2ee_media.put(c);i=(yield d("WABlobToArrayBuffer").blobToArrayBuffer(k));f=(yield b.e2ee_chunk.index("hashedPlaintextHash").get(s));f==null&&(yield b.e2ee_chunk.put({blobData:i,hashedPlaintextHash:s,mimetype:l,plaintextHash:r}));return c});return function(a){return c.apply(this,arguments)}}(),"readwrite",void 0,void 0,f.id+":194"));g=new File([k],(g=e.filename)!=null?g:"",{type:l});var u=(yield d("InstamadilloMediaUpload").instamadilloUpload(a,g,e)),v=u.mediaEntry;u=u.thumbnailMediaEntry;var w=babelHelpers["extends"]({},t,{objectId:v.objectId!=null?d("WAMediaUtils").stringToDeliveryObjectId(v.objectId):void 0});yield p.runInTransaction(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){yield a.e2ee_media.put(w)});return function(b){return a.apply(this,arguments)}}(),"readwrite",void 0,void 0,f.id+":261");t=q(v);t.$$unknownFieldCount;p=babelHelpers.objectWithoutPropertiesLoose(t,h);v=babelHelpers["extends"]({},p,{duration:e.playableDurationMs!=null?(j||(j=d("I64"))).to_int32(e.playableDurationMs):void 0,fileLength:g.size,height:e.previewHeight!=null?(j||(j=d("I64"))).to_int32(e.previewHeight):void 0,isAnimated:!1,isSticker:!1,mediaType:o,mimetype:l,sidecar:void 0,waveforms:e.waveformData!=null?e.waveformData.split(",").map(Number):void 0,waveformSamplingFrequencyHz:e.samplingFrequencyHz!=null?(j||(j=d("I64"))).to_int32(e.samplingFrequencyHz):void 0,width:e.previewWidth!=null?(j||(j=d("I64"))).to_int32(e.previewWidth):void 0});if(u!=null){t=q(u);t.$$unknownFieldCount;p=babelHelpers.objectWithoutPropertiesLoose(t,i);g={mediaTransport:p};v=babelHelpers["extends"]({},v,{thumbnail:g})}u=d("createInstamadilloMediaPayload").createInstamadilloMediaEncode(v);return{media:w,mediaEncode:u,serverMediaType:n}});return r.apply(this,arguments)}g.getMediaAttachment=a;g.generateValidatedMediaInfoFromAttachment=m;g.prepareMediaProtobuf=e}),98);
__d("MAWDbChunk",[],(function(a,b,c,d,e,f){"use strict";function a(a){return a}function b(a){return a}f.convertNumberToChunkId=a;f.convertToChunkId64=b}),66);
__d("IGDReportUserSpamJob",["FBLogger","I64","InstamadilloSendMediaMessageUtils","LSIntEnum","MAWDbChunk","MAWDbMedia","MAWDbMsg","MAWGetGroupInfoApi","MAWJids","MAWJobManager","MAWReStoreDb","MAWSpamReportUtils","Promise","WABase64","WADeprecatedSendIq","WAGlobals","WAJids","WAMediaUtils","WAResultOrError","WAWap","asyncToGeneratorRuntime","createInstamadilloMediaPayload","err","isStringNullOrEmpty"],(function(a,b,c,d,e,f,g){"use strict";var h=["$$unknownFieldCount"],i,j,k;a=d("MAWJobManager").getPersistedJobsApi().definePersistedJob().finalStep("reportUserSpam",function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.chatJid,f=a.context,g=a.frxParams,h=a.frxTags,i=a.msgs,j=a.reportedMessageId,k=a.spamFlow,m=a.userJid;a=null;if(h!=null){if(h.length===0)throw c("err")("spam reasons should not be an empty array");a=d("WAWap").wap("tagset",null,h.map(function(a){return d("WAWap").wap("tag",{value:d("WAWap").CUSTOM_STRING(a)})}))}h=null;c("isStringNullOrEmpty")(g)||(h=d("WAWap").wap("parameters",null,g));g=null;f!=null&&(g=d("WAWap").wap("context",null,f));var n=null;(a!=null||g!=null||h!=null)&&(n=d("WAWap").wap("frx",null,a,g,h));var o=(yield l(i,e,m,j));f=(yield d("WAJids").switchOnMsgrChatJidType(e,{group:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=d("WAWap").DROP_ATTR,c=d("WAWap").DROP_ATTR,e=(yield d("MAWGetGroupInfoApi").getGroupInfo(a));e!=null&&e.subject!=null&&e.subject.content!=null&&(b=d("WAWap").CUSTOM_STRING(e.subject.content));e!=null&&e.inviter!=null&&(c=d("WAWap").USER_JID(e.inviter));return p(o,a,m,c,b,k,n)});function c(b){return a.apply(this,arguments)}return c}(),user:function(){return q(o,m,k,n)}}));d("WADeprecatedSendIq").deprecatedCastStanza(f);return d("WAResultOrError").makeResult()});return function(b){return a.apply(this,arguments)}}()).end();function l(a,c,e,f){a=(a!=null?a:[]).map(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=d("MAWJids").toUserJid((j||(j=d("I64"))).to_string(a.senderId)),g;a.transportKey==="Instamadillo"&&(j||(j=d("I64"))).equal(a.displayedContentTypes,(k||(k=d("LSIntEnum"))).ofNumber(2))&&(g=(yield m(a)));if(d("WAJids").interpretAsGroupJid(c)!=null)return d("MAWSpamReportUtils").formatLSDbMsgForSpamReport(a,null,d("WAJids").toGroupJid(c),b);else{var h=(j||(j=d("I64"))).equal(a.senderId,(j||(j=d("I64"))).of_string(d("WAJids").userIdFromJid(d("WAGlobals").getMyUserJid())))?e:d("WAGlobals").getMyUserJid();return d("MAWSpamReportUtils").formatLSDbMsgForSpamReport(a,h,null,b,g,f===a.messageId)}});return function(b){return a.apply(this,arguments)}}());return(i||(i=b("Promise"))).all(a)}function m(a){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=(yield d("MAWReStoreDb").getDB(f.id+":244"));e=(yield e.runInTransaction(function(){var e=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var e=(yield d("InstamadilloSendMediaMessageUtils").getMediaAttachment(b,a.threadKey,a.messageId));if(e==null)throw c("FBLogger")("igd_web").warn("IGDReportUserSpam: Tried to send a message with associated attachment");var f=d("MAWDbMedia").convertToMediaId64((j||(j=d("I64"))).of_string(e.attachmentFbid));f=(yield b.e2ee_media.get(f));if(f==null)throw c("FBLogger")("igd_web").warn("IGDReportUserSpam: Tried to send an E2EE media message without associated e2ee_media");var g=d("MAWDbChunk").convertToChunkId64(j.of_string(e.attachmentFbid));b=(yield b.e2ee_chunk.get(g));if(b==null)throw c("FBLogger")("igd_web").warn("IGDReportUserSpam: Tried to send an E2EE media message without associated e2ee_chunk");return{attachment:e,chunk:b,media:f}});return function(a){return e.apply(this,arguments)}}(),"readonly",void 0,void 0,f.id+":245"));var g=e.attachment;e=e.media;var i=d("MAWDbMsg").instamadilloMsgIdToMsgId(a.messageId);if(!e.msgIds.includes(i))throw c("FBLogger")("igd_web").warn("IGDReportUserSpam: media is not linked to this message");i=e.mediaEntries.get(i);if(i==null)throw c("FBLogger")("igd_web").warn("IGDreportUserSpam: media entry not found");i=d("WAMediaUtils").mediaEntryDataToRawData(e.plaintextHash,i);i=o(i);i.$$unknownFieldCount;i=babelHelpers.objectWithoutPropertiesLoose(i,h);i=babelHelpers["extends"]({},i,{duration:g.playableDurationMs!=null?(j||(j=d("I64"))).to_int32(g.playableDurationMs):void 0,fileLength:e.size!=null?e.size:void 0,height:g.previewHeight!=null?(j||(j=d("I64"))).to_int32(g.previewHeight):void 0,isAnimated:!1,isSticker:!1,mediaType:e.mediaType,mimetype:g.playableUrlMimeType,sidecar:void 0,waveforms:g.waveformData!=null?g.waveformData.split(",").map(Number):void 0,waveformSamplingFrequencyHz:g.samplingFrequencyHz!=null?(j||(j=d("I64"))).to_int32(g.samplingFrequencyHz):void 0,width:g.previewWidth!=null?(j||(j=d("I64"))).to_int32(g.previewWidth):void 0});e=d("createInstamadilloMediaPayload").createInstamadilloMediaEncode(i);return e});return n.apply(this,arguments)}function o(a){var b=a.directPath,c=a.fbid,e=a.fileEncSha256,f=a.fileSha256,g=a.mediaKey,h=a.mediaKeyTimestamp;a=a.objectId;return{directPath:b!=null?b:void 0,fileEncSha256:e!=null?d("WABase64").encodeB64(e):void 0,fileSha256:f!=null?d("WABase64").encodeB64(f):void 0,mediaId:c!=null?c:void 0,mediaKey:g!=null?d("WABase64").encodeB64(g):void 0,mediaKeyTimestamp:String(h),objectId:a!=null?a:void 0}}function p(a,b,c,e,f,g,h){var i;return(i=d("WAWap")).wap("iq",{id:i.generateId(),to:i.S_WHATSAPP_NET,type:"set",xmlns:"spam"},i.wap("spam_list",{jid:i.GROUP_JID(b),reportee:i.USER_JID(c),source:e,spam_flow:i.CUSTOM_STRING(g),subject:f},a),h)}function q(a,b,c,e){var f;return(f=d("WAWap")).wap("iq",{id:f.generateId(),to:f.S_WHATSAPP_NET,type:"set",xmlns:"spam"},f.wap("spam_list",{jid:f.USER_JID(b),reportee:f.USER_JID(b),spam_flow:f.CUSTOM_STRING(c)},a),e)}g.igdReportUserSpam=a}),98);
__d("IGDStartInstamadilloDYIJob",["EncryptedBackupsDYISingleton","EncryptedBackupsDYITypes","MAWJobManager","MAWReStoreDb","asyncToGeneratorRuntime","cr:1288"],(function(a,b,c,d,e,f,g){"use strict";var h,i;a=d("MAWJobManager").getPersistedJobsApi().definePersistedJob().finalStep("startInstamadilloDYI",function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=a.qplInstanceKey;d("EncryptedBackupsDYISingleton").initSingleton(d("EncryptedBackupsDYITypes").EncryptedBackupsDYIConfig.Instamadillo,d("MAWReStoreDb").getDB,a);a=d("EncryptedBackupsDYISingleton").getSingleton();var c=a.getLogger();c.LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Started job startInstamadilloDYI"])));a.logDYIQPLPoint("instamadillo_dyi_job_start");b("cr:1288")!=null?(yield b("cr:1288").getInstance().startDYI(),a.logDYIQPLPoint("instamadillo_dyi_started")):c.ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Instamadillo DYI not enabled"])))});return function(b){return a.apply(this,arguments)}}()).end();g.startInstamadilloDYI=a}),98);
__d("IGDJobHandlers",["IGDReportUserSpamJob","IGDStartInstamadilloDYIJob","MAWCreateJobNotImplemented"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a;return{acceptGroupInvite:(a=d("MAWCreateJobNotImplemented")).createNotImplementedJob("acceptGroupInvite"),addGroupParticipants:a.createNotImplementedJob("addGroupParticipants"),createGroup:a.createNotImplementedJob("createGroup"),deleteMsgsForMe:a.createNotImplementedJob("deleteMsgsForMe"),deleteThread:a.createNotImplementedJob("deleteThread"),demoteGroupParticipants:a.createNotImplementedJob("demoteGroupParticipants"),downloadAndHandleMedia:a.createNotImplementedJob("downloadAndHandleMedia"),downloadAndRestoreMedia:a.createNotImplementedJob("downloadAndRestoreMedia"),getSpams:a.createNotImplementedJob("getSpams"),handleFutureproofMsg:a.createNotImplementedJob("handleFutureproofMsg"),handleSpamMsg:a.createNotImplementedJob("handleSpamMsg"),igdReportUserSpam:d("IGDReportUserSpamJob").igdReportUserSpam,leaveGroups:a.createNotImplementedJob("leaveGroups"),markThreadAsRead:a.createNotImplementedJob("markThreadAsRead"),promoteGroupParticipants:a.createNotImplementedJob("promoteGroupParticipants"),removeGroupParticipants:a.createNotImplementedJob("removeGroupParticipants"),reportUserSpam:a.createNotImplementedJob("reportUserSpam"),requestReuploadMedia:a.createNotImplementedJob("requestReuploadMedia"),resendWrittenAppData:a.createNotImplementedJob("resendWrittenAppData"),restoreMessagesFromEncryptedBackups:a.createNotImplementedJob("restoreMessagesFromEncryptedBackups"),restoreProtobufsFromEncryptedBackups:a.createNotImplementedJob("restoreProtobufsFromEncryptedBackups"),restoreThreadsFromEncryptedBackups:a.createNotImplementedJob("restoreThreadsFromEncryptedBackups"),reuploadMedia:a.createNotImplementedJob("reuploadMedia"),revokeMsgs:a.createNotImplementedJob("revokeMsgs"),sendAppData:a.createNotImplementedJob("sendAppData"),sendBumpMsg:a.createNotImplementedJob("sendBumpMsg"),sendGroupInviteMsg:a.createNotImplementedJob("sendGroupInviteMsg"),sendWrittenAppData:a.createNotImplementedJob("sendWrittenAppData"),setGroupSubject:a.createNotImplementedJob("setGroupSubject"),startInstamadilloDYI:d("IGDStartInstamadilloDYIJob").startInstamadilloDYI,updateBackupEntFbidForMedia:a.createNotImplementedJob("updateBackupEntFbidForMedia")}}g.getJobHandlers=a}),98);
__d("IGDLoadRecentParticipantsApi",["I64","LSIntEnum","MAWReStoreDb","ReQL","WAJids","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i;a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=(yield d("MAWReStoreDb").getDB(f.id+":30"));c=(yield d("ReQL").toArrayAsync(d("ReQL").fromTableDescending(c.tables.threads.index("lastActivityTimestampMs")).filter(function(a){return(h||(h=d("I64"))).equal(a.threadType,(i||(i=d("LSIntEnum"))).ofNumber(1))}).take(a)));var e=[];c.forEach(function(a){a=d("WAJids").interpretAsUserJid(d("WAJids").toMsgrUserJid((h||(h=d("I64"))).to_string(a.threadKey)));a!=null&&a!==b&&e.push(a)});return new Set(e)});return function(b,c){return a.apply(this,arguments)}}();g.loadRecentParticipants=a}),98);
__d("InstamadilloBackend",["cr:10745","cr:10746","cr:10747","cr:4772","cr:4849","cr:7098","cr:7691","cr:8224","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h=(d=b("cr:7098"))!=null?d:b("cr:10746"),i=(e=b("cr:4849"))!=null?e:b("cr:10747");function a(a){i!=null&&c("promiseDone")(i.setDeviceJid(a.deviceJid)),b("cr:8224")==null||b("cr:8224").initEbUploadQueue(),b("cr:7691")==null||b("cr:7691").initIGDEbRestoreProcessor(),b("cr:4772")==null||b("cr:4772").listenForEbUploadQueueFlush(),h!=null&&(h.initPendingMessageStanzaQueue(),c("promiseDone")(h.processFutureproofPendingMessageStanzas())),b("cr:10745")==null||b("cr:10745").startIGDDisappearingMsgCleaner()}g.init=a}),98);
__d("MAWDebugDefineFunctions",["MAWDebug","MAWDebugSendMultipleMsgs"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b){return{desc:a,execute:b,name:a,serializedArgs:[]}}function a(){var a=Object.keys(d("MAWDebug").MAWDebugFuncs).reduce(function(a,b){return Object.assign(a,(a={},a[b]=h(b,d("MAWDebug").MAWDebugFuncs[b]),a))},{});return babelHelpers["extends"]({},a,{sendMultipleMsgs:d("MAWDebugSendMultipleMsgs").sendMultipleMsgs})}g.getAllDebugFunctions=a}),98);
__d("MAWServerRPC",["MAWHandleAbPropsRefreshNotification","MAWHandleAppdataMessage","MAWHandleChatState","MAWHandleFailure","MAWHandleFbDeviceChangeNotification","MAWHandleFbMultiwayNotification","MAWHandleFbThreadNotification","MAWHandleGroupNotification","MAWHandleGroupReceipt","MAWHandleGroupRetryReceipt","MAWHandleIndividualRetryReceipt","MAWHandleLoginSuccess","MAWHandlePeerAppdataReceipt","MAWHandlePeerAppdataRetryReceipt","MAWHandleRtcE2eeCallEventNotification","MAWHandleSpam","MAWHandleThreadMetadata","Promise","WAHandleErrorStanza","WAHandleIncomingMsg","WAHandleInfoBulletin","WAHandlePrekeyContactIDChangedNotification","WAHandlePrekeyDigestNotification","WAHandlePrekeyLowCountNotification","WAHandleReceipt","WAHandleServerPing","WAHandleStreamError","WALogger","WAServerRPC"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function a(){var a;return d("WAServerRPC").makeServerRPC({abprops:{handleAbPropsRefreshNotification:d("MAWHandleAbPropsRefreshNotification").handleAbPropsRefreshNotification},accountSync:null,appdataMessage:{handleAppdataMessage:d("MAWHandleAppdataMessage").handleAppdataMessage,handlePeerAppdataReceipt:d("MAWHandlePeerAppdataReceipt").handlePeerAppdataReceipt,handlePeerAppdataRetryReceipt:d("MAWHandlePeerAppdataRetryReceipt").handlePeerAppdataRetryReceipt},broadcast:{handleBroadcastMessage:function(a){a=a.makeAck;d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Broadcast messages are not supported"])));return(j||(j=b("Promise"))).resolve(a())}},call:{handleRtcE2eeCallEvent:d("MAWHandleRtcE2eeCallEventNotification").handleRtcE2eeCallEventNotification},clientLog:null,comms:{handleEdgeRoutingInfo:d("WAHandleInfoBulletin").handleEdgeRoutingInfo,handleServerPing:d("WAHandleServerPing").handleServerPing},error:{handleErrorStanza:d("WAHandleErrorStanza").handleErrorStanza,handleSmaxErrorStanza:d("WAHandleErrorStanza").handleSmaxErrorStanza},fb:{handleFbDeviceChangeNotification:d("MAWHandleFbDeviceChangeNotification").handleFbDeviceChangeNotification,handleFbMultiwayNotification:d("MAWHandleFbMultiwayNotification").handleFbMultiwayNotification,handleFbThreadNotification:d("MAWHandleFbThreadNotification").handleFbThreadNotification},groupMessage:{handleGroupChatState:d("MAWHandleChatState").handleGroupChatState,handleGroupDirtyBit:null,handleGroupMessage:d("WAHandleIncomingMsg").handleGroupMessage,handleGroupNotification:d("MAWHandleGroupNotification").handleGroupNotification,handleGroupReceipt:d("MAWHandleGroupReceipt").handleGroupReceipt,handleGroupRetryReceipt:d("MAWHandleGroupRetryReceipt").handleGroupRetryReceipt},individualMessage:{handleIndividualChatState:d("MAWHandleChatState").handleIndividualChatState,handleIndividualMessage:d("WAHandleIncomingMsg").handleIncomingIndividualMsg,handleIndividualReceipt:d("WAHandleReceipt").handleIndividualReceipt,handleIndividualRetryReceipt:d("MAWHandleIndividualRetryReceipt").handleIndividualRetryReceipt},login:{handleLoginFailure:d("MAWHandleFailure").handleLoginFailure,handleLoginSuccess:d("MAWHandleLoginSuccess").handleLoginSuccess},md:null,newsletter:null,offline:{handleOfflineEnd:d("WAHandleInfoBulletin").handleOfflineEnd,handleOfflineStart:d("WAHandleInfoBulletin").handleOfflineStart,handleThreadMetadata:d("MAWHandleThreadMetadata").handleThreadMetadata},peerMessage:{handlePeerMessage:function(a){a=a.makeAck;d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Peer messages are not supported"])));return(j||(j=b("Promise"))).resolve(a())}},prekey:{handlePrekeyContactIDChangedNotification:d("WAHandlePrekeyContactIDChangedNotification").handlePrekeyContactIDChangedNotification,handlePrekeyDigestNotification:d("WAHandlePrekeyDigestNotification").handlePrekeyDigestNotification,handlePrekeyLowCountNotification:d("WAHandlePrekeyLowCountNotification").handlePrekeyLowCountNotification},presence:null,serverProps:null,spam:{handleSpam:d("MAWHandleSpam").handleSpam},status:null,streamError:{handleAckKick:(a=d("WAHandleStreamError")).handleAckKick,handleBadMac:a.handleBadMac,handleConflict:a.handleConflict,handlePingKick:a.handlePingKick,handleStreamErrorCode:a.handleStreamErrorCode,handleXmlNotWellFormed:a.handleXmlNotWellFormed},syncd:null,usync:null})}g.makeServerRPC=a}),98);
__d("WADebugTools",["WADevToolsDebugFns"],(function(a,b,c,d,e,f,g){"use strict";function a(a){self.Debug==null&&(self.Debug={});var b=function(){var b=a[c];self.Debug[b.name]=function(){return b.execute.apply(b,arguments)}};for(var c in a)b();d("WADevToolsDebugFns").registerDebugFnsToDevTool(a)}g.initDebugFunctions=a}),98);
__d("IGDBackend",["IGDAWDebug","IGDAWMainWebWorkerConfig","IGDBackendBridgeHandlers","IGDCOP","IGDJobHandlers","IGDLoadRecentParticipantsApi","InstamadilloBackend","MAWClearSignalAndTempStores","MAWCommsConfig","MAWConfig","MAWCreateGroupApi","MAWCurrentUser","MAWDebugDefineFunctions","MAWDefinePersistedJob","MAWEphemeralConsts","MAWExternalId","MAWExtractMsFromExternalId","MAWFbCat","MAWHandleReachabilityErrorAdminMsgApi","MAWMpsBridgeHandlers","MAWPREListeners","MAWQplProxy","MAWReStoreDb","MAWServerRPC","MAWSharedOfflineQueueMetric","MAWSharedOfflineResumeUINotifier","MAWTaskDefinitions","Promise","WAArrayBufferUtils","WADebugTools","WAMessageLoggingPublisher","WAMockServerShell","WAPassiveMode","WAService","WATagsLogger","WAWaitForComms","WAWaitForUserUnblocked","asyncToGeneratorRuntime","isUseridAnnotationEnabled","promiseDone","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m=d("WATagsLogger").TAGS(["backend"]);function a(a,b,c,d,e){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e,f,g,n){m.LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["initWAInfra"])));m.LOG(i||(i=babelHelpers.taggedTemplateLiteralLoose(["deviceJid: ",""])),a.deviceJid);d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25310776,"6155"),"igd_backend_setup_start");d("MAWFbCat").setFbCat(d("WAArrayBufferUtils").stringToArrayBuffer(a.fbCat));g=d("MAWServerRPC").makeServerRPC();n=(yield d("WAService").makeWAService({config:n,dependencies:{clearSignalAndTempStores:d("MAWClearSignalAndTempStores").clearSignalAndTempStores,createGroups:d("MAWCreateGroupApi").createGroups,ephemeralMaxDeletionWindowForUnseenMessage:function(){return d("MAWEphemeralConsts").ephemeralMaxDelectionWindowForUnseenMessage},extractMsFromStanzaId:d("MAWExtractMsFromExternalId").extractMsFromStanzaId,generateExternalId:d("MAWExternalId").generateExternalId,handleReachabilityErrorAdminMsg:d("MAWHandleReachabilityErrorAdminMsgApi").handleReachabilityErrorAdminMsg,isEmployee:d("MAWCurrentUser").isEmployee,isUseridAnnotationEnabled:c("isUseridAnnotationEnabled"),loadRecentParticipants:d("MAWReStoreDb").shouldUseReStoreDb()?d("IGDLoadRecentParticipantsApi").loadRecentParticipants:function(){return(l||(l=b("Promise"))).resolve(new Set())},mediaUploadRoot:function(){return"/wa-igd/mms"},waMessageReceiveReliabilityQplEvent:function(){return c("qpl")._(25306682,"11176")}},getCommsConfig:d("MAWCommsConfig").getCommsConfig,hmacKey:e,regData:a,serverRPC:g})["catch"](function(a){m.ERROR(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Failed to init worker (post-startup): ",""])),a);throw a}));d("MAWSharedOfflineQueueMetric").makeOfflineQueueMetric(n.oneQueue,d("WAPassiveMode").passiveModeNotifier,d("WAMessageLoggingPublisher").messageLoggingPublisher,d("IGDCOP").cop);d("MAWConfig").setConfig(d("IGDAWMainWebWorkerConfig").mawConfig);d("IGDCOP").cop.subscribeToOfflineQueue(n.oneQueue,n.protocolQueue);d("MAWSharedOfflineResumeUINotifier").offlineResumeUINotifier.subscribeToWAEvents(n.oneQueue);d("MAWSharedOfflineResumeUINotifier").offlineResumeUINotifier.subscribeToMawEvents(d("IGDCOP").cop);d("WAMockServerShell").isMockServerMode||c("promiseDone")(d("WAWaitForComms").waitForComms().then(function(){return d("MAWTaskDefinitions").registerTasks(d("WAWaitForUserUnblocked").waitForUserUnblocked())}));f.setHandlers("backend",d("IGDBackendBridgeHandlers").getIGDBridgeHandlers(m));d("MAWPREListeners").initializeWAPREMetrics();f.setHandlers("mps",d("MAWMpsBridgeHandlers").mpsBridgeHandlers);d("InstamadilloBackend").init(a);d("MAWDefinePersistedJob").setMsgrJobImplementations(d("IGDJobHandlers").getJobHandlers());yield n.startComms();m.LOG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Worker inited"])));d("WAWaitForComms").unblockComms();d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25310776,"6155"),"igd_backend_setup_end")});return n.apply(this,arguments)}g.startIGDBackend=a}),98);
__d("IGDLowLevelApiImpl",["IGDLowLevelApiBridgeHandlers"],(function(a,b,c,d,e,f,g){"use strict";function a(){return{bridgeHandlers:d("IGDLowLevelApiBridgeHandlers").igdBridgeHandlers}}g.makeLowLevelApi=a}),98);
__d("MAWBackendBridgeSetup",["MAWBridge","WACrossWorkerPortal","WAResultOrError","pageID"],(function(a,b,c,d,e,f,g){"use strict";function a(a){try{var b=h();b.setPort(a.getBridgePort());return d("WAResultOrError").makeResult(null)}catch(a){return d("WAResultOrError").makeError(a)}}function h(){var a=d("MAWBridge").getBridge();a=d("WACrossWorkerPortal").attachPortal(a,["event","threadEvent"],function(a,b){var c=a.length>0?a[a.length-1]:null;c!=null&&c.type==="request"&&c.content.name==="uiUpdate"&&c.content.arg.events&&b.type==="request"&&b.content.name==="uiUpdate"?Array.prototype.push.apply(c.content.arg.events,b.content.arg.events):a.push(b);return a},c("pageID"),{bridgeBatcherMaxTokens:Number.MAX_SAFE_INTEGER});return a}g.initWorkerBridge=a}),98);
__d("MAWCompareWorkerSetupArgs",["BackendInitLoggingUtils","FBLogger","MAWCurrentUser","MessengerWebInitData","WACryptoUtils","gkx","justknobx"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b){if(a.prefixAndSuffix!==b.prefixAndSuffix)return!1;a=a.encryptionKey;b=b.encryptionKey;if(a==null&&b==null)return!0;if(a==null&&b!=null||a!=null&&b==null)return!1;if(a==null||b==null)throw c("FBLogger")("messenger_web").mustfixThrow("encryptionKeyA and encryptionKeyB cannot be null at this point");return d("WACryptoUtils").arrayBuffersEqual(a,b)}function a(a,b){c("MessengerWebInitData").sessionId===b.sessionId?d("BackendInitLoggingUtils").MAWInitPoint("setup_args_session_ids_match"):d("BackendInitLoggingUtils").MAWInitPoint("setup_args_session_ids_mismatch");var e=c("justknobx")._("2218");if(b.sessionId!==c("MessengerWebInitData").sessionId){var f=!0;c("gkx")("8512")&&(c("MessengerWebInitData").createdAt!=null&&b.createdAt!=null&&(f=b.createdAt>c("MessengerWebInitData").createdAt),b.createdAt==null&&c("MessengerWebInitData").createdAt!=null&&(f=!1));if(f){d("BackendInitLoggingUtils").MAWInitPoint("setup_args_current_session_ids_mismatch");return{hasArgsChanged:!0,reason:"session_id_change"}}}f=e?d("MAWCurrentUser").getID():a.fbId;if(b.fbId!==f){c("FBLogger")("messenger_web").mustfix("FBID mismatch during worker setup. %s:%s:%s:%s",f==="0",f.length,b.fbId==="0",b.fbId.length);return{hasArgsChanged:!0,reason:"fbid_change"}}else d("BackendInitLoggingUtils").MAWInitPoint("setup_args_fb_ids_match");return!h(b.vaultMaterials,a.vaultMaterials)?{hasArgsChanged:!0,reason:"vault_materials_change"}:{hasArgsChanged:!1,reason:"args_ok"}}g.didWorkerSetupArgsChange=a}),98);
__d("MAWDeviceRegistrationODSBump",["MAWCurrentUser","MAWODSProxy","WAOdsEnums"],(function(a,b,c,d,e,f,g){"use strict";function a(a){d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.DEVICE_REGISTRATION,key:a}),d("MAWCurrentUser").isEmployee()||d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.DEVICE_REGISTRATION_NON_EMPLOYEE,key:a})}g["default"]=a}),98);
__d("MAWCryptoAuthTokenWrapper",["MessengerWebInitData"],(function(a,b,c,d,e,f,g){"use strict";function a(){return d("MessengerWebInitData").cryptoAuthToken}g.getCryptoAuthToken=a}),98);
__d("WASignedKeyApi",["WASignalDB"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return d("WASignalDB").getDb().runInTransaction(["signedPrekey"],"readonly",function(b){return b.stores.signedPrekey.get(a)},d("WASignalDB").signalOp("getSignedKey"))}g.getSignedKey=a}),98);
__d("MAWDeviceRegistrationActions",["MAWLoggerUtils","MAWODSProxy","MWFBLogger","MessengerWebInitData","WADbSignal","WAGetRegistrationInfoApi","WAOdsEnums","WASignedKeyApi","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p="Device registration meta is incomplete: ",q=d("MWFBLogger").MWLogger.tags([d("MAWLoggerUtils").Tag.DeviceRegistration]);function r(a,b,c,e,f){(a!=null||b!=null||c!=null||e!=null||f!=null)&&(a==null&&q.MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["",": ",""])),p,d("WADbSignal").MetaKeysEnum.lastSignedPrekeyId),b==null&&q.MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["",": ",""])),p,d("WADbSignal").MetaKeysEnum.deviceUUID),c==null&&q.MUSTFIX(j||(j=babelHelpers.taggedTemplateLiteralLoose(["",": ",""])),p,d("WADbSignal").MetaKeysEnum.regId),e==null&&q.MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["",": ",""])),p,d("WADbSignal").MetaKeysEnum.identityKeyPair),f==null&&q.MUSTFIX(l||(l=babelHelpers.taggedTemplateLiteralLoose(["",": ",""])),p,d("WADbSignal").MetaKeysEnum.fbid))}function a(){return s.apply(this,arguments)}function s(){s=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield d("WAGetRegistrationInfoApi").getRegistrationInfo()),b=a.deviceId,e=a.deviceUUID,f=a.fbid,g=a.identityCompareResult,h=a.identityKeyPair,i=a.lastSessionDeviceWasLinkedTo,j=a.lastSignedPrekeyId,k=a.regId,l=a.registrationUnixTime;a=a.registrationVersion;g||d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.COMPARE_IDENTITY,key:"meta_identity_mismatch"});if(j==null||e==null||k==null||h==null||f==null){r(j,e,k,h,f);return null}c("MessengerWebInitData").sessionId==null&&q.MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["MAWDeviceRegistrationActions: sessionId is null"])));if(b!=null&&typeof b!=="number"){q.MUSTFIX(n||(n=babelHelpers.taggedTemplateLiteralLoose(["[Device Registration Meta Check] Device Id should be a number"])));return null}f=(yield d("WASignedKeyApi").getSignedKey(j));if(f==null){q.MUSTFIX(o||(o=babelHelpers.taggedTemplateLiteralLoose(["",": signedPrekey}"])),p);return null}return{deviceId:b,deviceUUID:e,identityCompareResult:g,lastSessionDeviceWasLinkedTo:i,lastSignedPrekeyId:j,registrationUnixTime:l,registrationVersion:a!=null?a:void 0,signalRegInfo:{identityKeyPair:h,regId:k,signedPreKey:f}}});return s.apply(this,arguments)}g.getRegistrationMetaWorm=a}),98);
__d("XArmadilloWebLinkDeviceToSessionControllerRouteBuilder",["jsRouteBuilder"],(function(a,b,c,d,e,f,g){a=c("jsRouteBuilder")("/messenger/armadillo/link_device/",Object.freeze({}),void 0);b=a;g["default"]=b}),98);
__d("MAWDeviceRegistrationSessionUtil",["CSRFGuard","CurrentMessengerUser","DTSG","DTSGUtils","MAWLoggerUtils","MWFBLogger","PHPQuerySerializer","SprinkleConfig","WAAPI","WAWorkerGlobalScope","XArmadilloWebLinkDeviceToSessionControllerRouteBuilder","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o=d("MWFBLogger").MWLogger.tags([d("MAWLoggerUtils").Tag.DeviceRegistration,"LinkDeviceToTheSession"]);function a(a,b){return p.apply(this,arguments)}function p(){p=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var e;e=(e=d("WAWorkerGlobalScope").workerGlobalScope.location)==null?void 0:e.origin;if(e==null||e==="")return;if(d("CurrentMessengerUser").isTestUser()&&e.includes("twshared"))return;if(a==null){o.MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["DeviceUUID is null"])));return}e=new URL(e).hostname;e=(e=c("XArmadilloWebLinkDeviceToSessionControllerRouteBuilder").buildUri({}).setDomain(e))==null||(e=e.setProtocol("https"))==null?void 0:e.toString();if(e==null)return;var f=d("DTSG").getToken();if(f==null)return;a={device_id:a,fb_dtsg:f};c("SprinkleConfig").param_name&&(a[c("SprinkleConfig").param_name]=c("DTSGUtils").getNumericValue(f));f=d("WAWorkerGlobalScope").workerGlobalScope.fetch;var g;try{g=(yield f(e,{body:(n||(n=c("PHPQuerySerializer"))).serialize(a),headers:{"Content-Type":"application/x-www-form-urlencoded"},method:"POST",redirect:"error"}))}catch(a){o.catching(a).MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Fetch error, fetch defined: ",""])),f!=null);return}if(!g.ok){o.MUSTFIX(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Fetch is not 200: ",""])),g.status);return}e=(yield g.text());d("CSRFGuard").exists(e)&&(e=d("CSRFGuard").clean(e));var p;try{p=JSON.parse(e)}catch(a){o.catching(a).MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Parse response error"])));return}((a=p)==null?void 0:a.success)===!0?(o.DEBUG(l||(l=babelHelpers.taggedTemplateLiteralLoose(["LinkDeviceToTheSession success"]))),yield c("WAAPI").saveLastSessionDeviceWasLinkedTo({sessionId:b})):o.WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["fetch result is not succesful"])))});return p.apply(this,arguments)}g.linkDeviceToTheSession=a}),98);
__d("WAIdentityApi",["WASignalDB"],(function(a,b,c,d,e,f,g){"use strict";a=function(a){return d("WASignalDB").getDb().runInTransaction(["identity"],"readwrite",function(b){return b.stores.identity.bulkPut([a])},d("WASignalDB").signalOp("saveIdentity"))};g.saveIdentity=a}),98);
__d("MAWDeviceRegistrationWorker",["IGDWebUtils","MAWClearSignalAndTempStores","MAWCryptoAuthTokenWrapper","MAWCurrentUser","MAWDeviceRegistrationActions","MAWDeviceRegistrationODSBump","MAWDeviceRegistrationSessionUtil","MAWDeviceRegistrationUtilWorker","MAWJids","MAWLoggerUtils","MAWODSProxy","MAWQplProxy","MWFBLogger","MessengerWebInitData","Promise","UserAgentData","WADbDeviceRegistration","WADbMetaTxns","WADbRegistrationApi","WAGetSafeQPLError","WAICDCUtils","WAIdentityApi","WAIdentityUtils","WAJids","WAMockServerShell","WAOdsEnums","WAPreRegistrationCrypto","WASignalKeys","WATimeUtils","asyncToGeneratorRuntime","cr:7755","promiseDone","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o=d("MWFBLogger").MWLogger.tags([d("MAWLoggerUtils").Tag.DeviceRegistration]),p=function(){return d("IGDWebUtils").isInstagramWebSupportedApp(Number(d("MAWCurrentUser").getAppID()))};function q(a){switch(a){case 1217981644879628:case 936619743392459:case 487152425211411:case 1035956773910536:return"instagram.com";case 772021112871879:return"messenger.com";case 2220391788200892:return"facebook.com";default:return"unknown"}}function r(a,b){b===void 0&&(b=400);return{message:a,registrationState:{type:d("WADbDeviceRegistration").RegistrationStatesEnum.failed},status:b}}function s(a,b,c){return t.apply(this,arguments)}function t(){t=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){function f(a){b.addPoint(a),e!=null&&d("MAWQplProxy").sendQplPointThroughBridge(e,"device_registration_"+a)}o.DEBUG(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Beginning device registration"])));var g=(yield d("MAWDeviceRegistrationUtilWorker").createNewRegistrationMeta());f("registration_created");b.addAnnotations({string:{unique_device_id:g.deviceUUID}});yield d("WADbRegistrationApi").saveRegistrationMeta(d("MAWCurrentUser").getID(),g);f("registration_saved");var h=d("MAWCurrentUser").getID(),i=g.deviceUUID,l=d("WAPreRegistrationCrypto").serializeRegistrationData(g.signalRegInfo),m=null,n=!1;n=(n=n?1019394685547802:d("MAWCurrentUser").getAppID())==null?void 0:n.toString();if(n==null)return r("appId is null, cannot register to WhatsApp");if(h==="0")return r(d("WADbDeviceRegistration").DEVICE_REGISTER_ERROR_ZERO_AS_USER_ID);var q=null,s=null;try{var t=(yield d("MAWDeviceRegistrationUtilWorker").fetchICDC(h,a.encrypted_serialized_cat,n,i));f("icdc_fetched");var u=[].concat(d("WAICDCUtils").base64DeviceIdentitiesToSerializedPubKeys(t.device_identities));if(t.curr_identity_idx!=null){var v=t.curr_identity_idx;u[v]=d("WASignalKeys").serializeIdentity(l.identityPubKey)}else u.push(d("WASignalKeys").serializeIdentity(l.identityPubKey));q=d("WAICDCUtils").computeICDCInfoForUpload(g.signalRegInfo.identityKeyPair,t.icdc_seq,u,"registration","registration");s=(yield d("WAIdentityUtils").computeIdentitiesHash(u));f("identities_computed")}catch(a){o.catching(a).MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Cannot process ICDC payload during registration"])))}v=!1;try{t=(yield d("MAWDeviceRegistrationUtilWorker").register(h,a.encrypted_serialized_cat,n,i,l.regId,l.identityPubKeyType,l.identityPubKey,l.signedPreKey,q&&s?{ihash:s,seq:q.icdcInfo.seq,signedICDCIdentityList:q.encodedSignedICDC,ts:q.icdcInfo.timestamp}:null));f("device_registered");u=t==null?void 0:t.type;u!=null&&d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.REGISTRATION_TYPE,key:u});if(!t||!(t!=null&&t.success)){return{message:(a=t==null?void 0:t.message)!=null?a:d("WADbDeviceRegistration").NULL_RESPONSE_FROM_SERVER,registrationState:{type:d("WADbDeviceRegistration").RegistrationStatesEnum.failed},status:(n=t==null?void 0:t.status)!=null?n:"400"}}m=t.wa_device_id;v=(l=t.icdc_success)!=null?l:!1}catch(a){return r(d("WAGetSafeQPLError").getSafeQPLErrorMessage(a))}if(m==null)return r(d("WADbDeviceRegistration").NULL_RESPONSE_FROM_SERVER);s=d("MAWJids").toUserJid(h);if(!p()){f=c("MessengerWebInitData").sessionId;f!=null&&c("promiseDone")(d("MAWDeviceRegistrationSessionUtil").linkDeviceToTheSession(i,f))}if(q!=null&&v){u=q.icdcInfo;yield d("WADbRegistrationApi").saveICDC(s,{devices:u.devices,dirty:!0,sequence:u.seq,signingDeviceIndex:u.signingDeviceIndex,timestamp:u.timestamp});b.addPoint("icdc_saved")}yield d("WADbRegistrationApi").saveDeviceId(m);b.addPoint("device_saved");a={deviceJid:d("WAJids").toDeviceJid(s,m),identity:d("WASignalKeys").serializeIdentity(g.signalRegInfo.identityKeyPair.publicKey),userJid:s};yield d("WAIdentityApi").saveIdentity(a);b.addPoint("identity_saved");return{message:d("WADbDeviceRegistration").DEVICE_SUCCESSFULLY_REGISTERED,registrationState:{registrationTime:g.registrationUnixTime,type:d("WADbDeviceRegistration").RegistrationStatesEnum.finished},status:200}});return t.apply(this,arguments)}function a(a,b){return u.apply(this,arguments)}function u(){u=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e){var f=d("MAWQplProxy").startQplUserFlow(c("qpl")._(25307273,"1410"),{string:{browser_name:c("UserAgentData").browserName,device_os:c("UserAgentData").platformName,device_os_version:c("UserAgentData").platformVersion,"interface":q(Number(d("MAWCurrentUser").getAppID()))}},{providedTimeoutInMs:2e4}),g=function(a,b){return d("MAWQplProxy").measurePerfInQPL(f,a,b)};try{e=e!=null?e:d("MAWCryptoAuthTokenWrapper").getCryptoAuthToken();if(e==null||e.encrypted_serialized_cat===""){o.WARN(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Crypto Auth Token was null or incomplete"])));f.endFail("empty_cat_token");return r(d("WADbDeviceRegistration").DEVICE_REGISTER_ERROR_EMPTY_CAT_TOKEN,414)}a!=null&&d("MAWQplProxy").sendQPLAnnotationsThroughBridge(a,{"int":{secondsUntilCATExpiration:Math.floor(e.expiration_time_in_seconds-Date.now()/1e3)}});if(!d("WATimeUtils").isInFuture(d("WATimeUtils").castToUnixTime(e.expiration_time_in_seconds))){f.endFail("expired_cat_token");return r(d("WADbDeviceRegistration").DEVICE_REGISTER_ERROR_EXPIRED_CAT_TOKEN,413)}if(d("WAMockServerShell").isMockServerMode){var h=(yield d("MAWDeviceRegistrationUtilWorker").createNewRegistrationMeta());yield (n||(n=b("Promise"))).all([d("WADbRegistrationApi").saveRegistrationMeta(d("MAWCurrentUser").getID(),h),d("WADbRegistrationApi").saveDeviceId(d("WAJids").interpretAsDeviceId(1)),d("WADbMetaTxns").saveCAT(e)]);f.addPoint("wa_device_registration_mock_server");f.endSuccess();return{message:"Skipping registration because of Mock Server",registrationState:{registrationTime:h.registrationUnixTime,type:d("WADbDeviceRegistration").RegistrationStatesEnum.finished},status:200}}b("cr:7755")!=null&&(yield b("cr:7755").updateRegDataFromLocalStorage());h=d("MAWDeviceRegistrationActions").getRegistrationMetaWorm();h=(yield g("get_registration_data",h));f.addAnnotations({string:{unique_device_id:h==null?void 0:h.deviceUUID}});a!=null&&d("MAWQplProxy").sendQplPointThroughBridge(a,"device_registration_check",{annotations:{bool:{identityCompareResult:h==null?void 0:h.identityCompareResult},"int":{registrationVersion:h==null?void 0:h.registrationVersion}}});var i=(h==null?void 0:h.identityCompareResult)===!1;if(h==null||h.deviceId==null||i){f.addAnnotations({bool:{isNewRegistartion:!0}});a!=null&&d("MAWQplProxy").sendQplPointThroughBridge(a,"device_registration_new_reg_start");try{yield g("clear_signal_stores",d("MAWClearSignalAndTempStores").clearSignalAndTempStores()),a!=null&&d("MAWQplProxy").sendQplPointThroughBridge(a,"device_registration_signal_temp_stores_cleared"),yield g("save_cat",d("WADbMetaTxns").saveCAT(e)),a!=null&&d("MAWQplProxy").sendQplPointThroughBridge(a,"device_registration_cat_saved")}catch(a){return r(d("WAGetSafeQPLError").getSafeQPLErrorMessage(a))}i=(yield g("try_register",s(e,f,a)));i.registrationState.type===d("WADbDeviceRegistration").RegistrationStatesEnum.failed?f.endFail("wa_device_registration_failed",{string:{errorMsg:i.message}}):(f.addPoint("wa_device_registration_successful"),f.endSuccess());a!=null&&d("MAWQplProxy").sendQplPointThroughBridge(a,"device_registration_new_reg_end");return i}else{f.addAnnotations({bool:{isNewRegistartion:!1}});a!=null&&d("MAWQplProxy").sendQplPointThroughBridge(a,"device_registration_existing_reg_start");yield g("save_cat",d("WADbMetaTxns").saveCAT(e));i=c("MessengerWebInitData").sessionId;g=h.lastSessionDeviceWasLinkedTo==null||h.lastSessionDeviceWasLinkedTo!==i;i!=null&&!(h.deviceUUID===i||h.deviceUUID.startsWith(i+"-"))&&g&&!p()&&c("promiseDone")(d("MAWDeviceRegistrationSessionUtil").linkDeviceToTheSession(h.deviceUUID,i));a!=null&&d("MAWQplProxy").sendQplPointThroughBridge(a,"device_registration_existing_reg_end")}c("MAWDeviceRegistrationODSBump")("already_registered");f.addPoint("wa_device_registration_persisted");f.endSuccess();o.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Skipping device registration"])));return{message:d("WADbDeviceRegistration").DEVICE_ALREADY_REGISTERED,registrationState:{type:d("WADbDeviceRegistration").RegistrationStatesEnum.finished},status:200}}catch(a){f.endFail("uncaught_exception",{string:{errorMsg:(e=a==null?void 0:a.message)!=null?e:"No error message"}});throw a}});return u.apply(this,arguments)}function e(a){c("MAWDeviceRegistrationODSBump")("fail");o.MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["",""])),d("WADbDeviceRegistration").FAILED_REGISTRATION_RETRIES);for(a of a)o.MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Device registration failure - ",""])),a)}g.handleRegistrationError=r;g.setupDeviceRegistration=a;g.logDeviceRegistrationRetryFailure=e}),98);
__d("MAWDeviceRegistrationInitWorker",["BackendInitLoggingUtils","BrowserLockManager","MAWDeviceRegistrationODSBump","MAWDeviceRegistrationWorker","MAWHMACKey","MAWQplProxy","MAWRotateCAT","MWFBLogger","Promise","WADbDeviceRegistration","WADbRegistrationApi","WAGetRegistrationInfoApi","WAPromiseRetryLoop","WARetryUtils","asyncToGeneratorRuntime","justknobx","memoizeOneWithArgs","promiseDone","qpl","shouldUseMAWSharedWorker"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o,p=d("MWFBLogger").MWLogger.tags(["backend","init","deviceRegistration"]);function a(){var a=d("shouldUseMAWSharedWorker").shouldUseMAWSharedWorker();return c("BrowserLockManager")!=null&&!a?d("BackendInitLoggingUtils").measureMawInit("request_maw_registration_lock",function(){return new(o||(o=b("Promise")))(function(a,d){c("promiseDone")(c("BrowserLockManager").request("maw_registration_lock",b("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{var b=(yield q());a(b)}catch(a){d(a)}})))})}):q()}var q=c("memoizeOneWithArgs")(b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield d("BackendInitLoggingUtils").measureMawInit("init_device_reg_overall",function(){return r()})),c=a.message;a=a.registrationState;if(a===d("WADbDeviceRegistration").RegistrationStatesEnum.failed)throw p.mustfixThrow("registration_failed: "+c);a=(yield (o||(o=b("Promise"))).all([d("BackendInitLoggingUtils").measureMawInit("load_reg_in_txn",function(){return d("WADbRegistrationApi").loadAllRegistrationMetaInTransaction()}),d("BackendInitLoggingUtils").measureMawInit("gen_insert_hmac",function(){return d("MAWHMACKey").generateAndInsertHMACKey()})]));c=a[0];a=a[1];return{hmacKey:a,regData:c}}));function r(){var a=0,e=new Set(),f=0,g=new(d("WAPromiseRetryLoop").PromiseRetryLoop)({code:function(){var g=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){a++;if(a>d("WADbDeviceRegistration").MAX_DEVICE_REGISTRATION_RETRIES){d("MAWDeviceRegistrationWorker").logDeviceRegistrationRetryFailure(e);var g=d("MAWDeviceRegistrationWorker").handleRegistrationError(d("WADbDeviceRegistration").FAILED_REGISTRATION_RETRIES);b(g);return}try{g=null;switch(f){case 414:case 413:case 418:p.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["DeviceRegistration ",". Rotate CAT"])),f);g=(yield d("MAWRotateCAT").rotateCAT({initiator:"MAWDeviceRegistrationInitWorker::initDeviceRegistration",qplAnnotations:{"int":{prevStatusCode:f}}}));break;case 400:case 401:p.MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["DeviceRegistration ",": User should re-login"])),f);c("justknobx")._("3526")&&(g=(yield d("MAWRotateCAT").rotateCAT({initiator:"MAWDeviceRegistrationInitWorker::initDeviceRegistration",qplAnnotations:{"int":{prevStatusCode:f}}})));break;case 415:p.MUSTFIX(j||(j=babelHelpers.taggedTemplateLiteralLoose(["DeviceRegistration 415: User should take action to  re-register to WAI"])));break;case 403:p.MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["DeviceRegistration 403: User is banned"])));break;case 500:p.MUSTFIX(l||(l=babelHelpers.taggedTemplateLiteralLoose(["DeviceRegistration 500: Retry is needed"])));break}var o=a===1?c("qpl")._(25310776,"6155"):null;o=(yield d("MAWDeviceRegistrationWorker").setupDeviceRegistration(o,g));f=o.status;c("MAWDeviceRegistrationODSBump")("attempt."+a+".result."+o.registrationState.type);o.registrationState.type===d("WADbDeviceRegistration").RegistrationStatesEnum.finished&&(o.registrationState.registrationTime!=null&&c("MAWDeviceRegistrationODSBump")("success"),p.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Registration finished, ending device registration promise retry loop"]))),b(o));e.add(o.message);d("MAWQplProxy").sendQPLAnnotationsThroughBridge(c("qpl")._(25310776,"6155"),{"int":{deviceRegistrationLastAttemptCount:a},string:{deviceRegistrationLastAttemptMessages:Array.from(e).join(", ")}})}catch(b){g="Uncaught device registration error - "+b;p.WARN(n||(n=babelHelpers.taggedTemplateLiteralLoose(["",""])),g);e.add(""+g);d("MAWQplProxy").sendQPLAnnotationsThroughBridge(c("qpl")._(25310776,"6155"),{"int":{deviceRegistrationLastAttemptCount:a},string:{deviceRegistrationLastAttemptMessages:Array.from(e).join(", ")}})}});function o(a){return g.apply(this,arguments)}return o}(),name:"deviceRegistration",timer:d("WARetryUtils").fibonacciBackoff(!0)});g.start();return g.promise().then(function(a){a.registrationState.type===d("WADbDeviceRegistration").RegistrationStatesEnum.finished&&c("promiseDone")(d("WAGetRegistrationInfoApi").updateRegistrationHistory(a.registrationState.registrationTime));return a})}g.registerDevice=a;g.performDeviceRegistration=q;g.initDeviceRegistration=r}),98);
__d("MAWMpsAppdataEncryptedBackupsSecretsPreprocessor",["FBLogger","MAWHandleEncryptedBackupsSecretsApi","MAWProtobufDeserializers","MpsTypes","Promise","asyncToGeneratorRuntime","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a){var e=a.backupId,f=a.epoch,g=a.mailboxRootKey,i=a.obliviousValidationToken,j=a.serverDataId;a=a.tempOcmfClientState;if(e==null||f==null||g==null||i==null||j==null||a==null){c("FBLogger")("mps").warn("Cannot process encrypted backups secrets - mandatory data missing");return(h||(h=b("Promise"))).resolve()}f=f.map(function(a){var b=a.anonId,d=a.id,e=a.rootKey;a=a.status;if(b==null||d==null||e==null||a==null){c("FBLogger")("mps").warn("Encountered invalid epoch when processing encrypted backups secrets");return null}return{anonId:b,id:d,rootKey:e,status:a}}).filter(Boolean);e={backupId:e,epoch:f,mailboxRootKey:g,obliviousValidationToken:i,serverDataId:j,tempOcmfClientState:a};return d("MAWHandleEncryptedBackupsSecretsApi").handleEncryptedBackupsSecret(e)}function j(a,b){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){yield i(b);return{directive:{actionType:d("MpsTypes").ActionType.Noop,debugFlags:["WA"],isLocalOnly:!1,isTransportErrorPlaceholder:!1,tags:[],targetMessageId:a.message.messageId},insertionSource:a.insertionSource,message:a.message}});return k.apply(this,arguments)}a={name:"MAWMpsAppdataEncryptedBackupsSecretsPreprocessorAsync",processAsync:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e){e.metric.addPoint("eb_appdata_secret_start");var f=new Array(a.length),g=new Map();a=a.map(function(a,b){var e=d("MAWProtobufDeserializers").DeserializedBackupMessage.create(a.message.payload);if(e.payload().kind!=="messageApplication"){f[b]=a;return}e=(e=e.encryptedTransportMessage())==null||(e=e.armadillo())==null||(e=e.payload)==null||(e=e.signal)==null?void 0:e.encryptedBackupsSecrets;if(e==null){f[b]=a;return}return j(a,e).then(function(a){f[b]=a})["catch"](function(b){g.set(a.message.messageId,c("getErrorSafe")(b))})});a.length>0&&(yield (h||(h=b("Promise"))).all(a));e.metric.addPoint("eb_appdata_secret_end");return{errors:g,payload:f}});function e(b,c){return a.apply(this,arguments)}return e}()};g.MAWMpsAppdataEncryptedBackupsSecretsPreprocessor=a}),98);
__d("MAWMpsGenerateMessageFromBackupMessage",["FBLogger","MAWProtobufDeserializers","MpsTypes"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){try{var e,f=a.decryptedProtobuf,g=d("MAWProtobufDeserializers").DeserializedBackupMessage.create(f);if(g.payload().kind!=="messageApplication"){c("FBLogger")("mps").warn("Expected messageApplication, got %s",g.payload().kind);return null}e=(e=g.proto.metadata)==null?void 0:e.senderId;g=(g=g.proto.metadata)==null?void 0:g.messageId;return e!=null&&g!=null?{messageId:d("MpsTypes").toMessageId(g),payload:d("MpsTypes").toBytes(f),senderId:e,threadId:b,timestampMs:a.protobufTimestampMS}:null}catch(a){c("FBLogger")("mps").catching(a).mustfix("Runtime error performing generateMessage: %s",a);throw a}}g.generateMessage=a}),98);
__d("MAWMpsGenerateSupplementalFromBackupMessage",["FBLogger","MAWProtobufDeserializers","MpsTypes","WALongInt"],(function(a,b,c,d,e,f,g){"use strict";function a(a){try{var b,e=d("MAWProtobufDeserializers").DeserializedBackupMessage.create(a);if(e.payload().kind!=="messageApplication"){c("FBLogger")("mps").warn("Expected messageApplication, got %s",e.payload().kind);return null}b=(b=e.proto.metadata)==null?void 0:b.messageId;e=(e=e.proto.metadata)==null?void 0:e.timestampMs;return b!=null&&e!=null?{messageId:d("MpsTypes").toMessageId(b),payload:d("MpsTypes").toBytes(a),timestampMs:d("WALongInt").numberOrThrowIfTooLarge(e)}:null}catch(a){c("FBLogger")("mps").catching(a).mustfix("Runtime error performing generateSupplemental: %s",a);throw a}}g.generateSupplemental=a}),98);
__d("MAWMpsDecodeAndParseEbProtobufs",["FBLogger","MAWMpsGenerateMessageFromBackupMessage","MAWMpsGenerateSupplementalFromBackupMessage","MpsTypes"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){var e=[];try{a.forEach(function(a){if(a==null)return;var c=d("MAWMpsGenerateMessageFromBackupMessage").generateMessage(a.toplevelProtobuf,b);if(c==null)return;var f=new Map();a.supplementalProtobufs.forEach(function(a,b){a=a.decryptedProtobuf;a=d("MAWMpsGenerateSupplementalFromBackupMessage").generateSupplemental(a);a!=null&&f.set(d("MpsTypes").toSupplementalKey(b),a)});a={expiryTimestampMs:null,supplementalProtobufs:f,tags:(a=a.tags)!=null?a:[],toplevelProtobuf:c};e.push(a)});return e}catch(a){c("FBLogger")("labyrinth_web").catching(a).mustfix("Runtime error performing decodeAndParseEbProtobufs for MPS: %s",a);throw a}}g.decodeAndParseEbProtobufs=a}),98);
__d("MAWMpsTypes",["$InternalEnum"],(function(a,b,c,d,e,f){"use strict";a=b("$InternalEnum")({REACTION:"reaction",EDIT:"edit",RAVEN_ACTION_MESSAGE:"raven_action_message",RAVEN_ORIGINAL_MESSAGE:"raven_original_message"});f.SupplementalKeyPrefixMps=a}),66);
__d("MAWMpsDirectiveGenerator",["FBLogger","MAWMpsGating","MAWMpsTypes","MAWProtobufDeserializers","MSGDataclassTypes.flow","MWFBLogger","MpsFutureProofKey","MpsTypes","WAResultOrError","err","getErrorSafe","getMediaTypeFromConsumerMessage","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";function h(a){return d("MpsTypes").toSupplementalKey(d("MAWMpsTypes").SupplementalKeyPrefixMps.REACTION+":"+a.senderId)}var i={status:"next"};function j(a,b){var c;b=b.subProtocol();if((b==null?void 0:b.kind)!=="consumerApplication")return d("WAResultOrError").makeError("edit_protobuf_invalid");return((c=b.payload)==null||(c=c.content)==null||(c=c.editMessage)==null?void 0:c.timestampMs)==null?d("WAResultOrError").makeError("edit_protobuf_invalid"):d("WAResultOrError").makeResult(d("MpsTypes").toSupplementalKey(d("MAWMpsTypes").SupplementalKeyPrefixMps.EDIT+":"+a.senderId+":"+b.payload.content.editMessage.timestampMs))}function k(a){return d("MpsTypes").toSupplementalKey(d("MAWMpsTypes").SupplementalKeyPrefixMps.RAVEN_ACTION_MESSAGE+":"+a.senderId)}function l(a){return d("MpsTypes").toSupplementalKey(a.messageId)}function m(a){switch(a){case"image":return d("MSGDataclassTypes.flow").MpsMessageTag.Photo;case"video":return d("MSGDataclassTypes.flow").MpsMessageTag.Video;case"gif":return d("MSGDataclassTypes.flow").MpsMessageTag.Gif;case"ptt":return d("MSGDataclassTypes.flow").MpsMessageTag.Audio;case"document":return d("MSGDataclassTypes.flow").MpsMessageTag.File;case"sticker":case"md-app-state":case"xma-image":case void 0:case null:return;default:a}}function n(a,b){b=b.subProtocol();if((b==null?void 0:b.kind)!=="armadillo")return i;return((b=b.payload)==null||(b=b.content)==null?void 0:b.ravenMessageMsgr)==null?i:{directive:{actionType:d("MpsTypes").ActionType.Preprocess,isLocalOnly:!1,isTransportErrorPlaceholder:!1,tags:[],targetMessageId:a.messageId},status:"success"}}function o(a,b){b=b.subProtocol();if((b==null?void 0:b.kind)!=="consumerApplication")return i;return((b=b.payload)==null||(b=b.content)==null?void 0:b.pollCreationMessage)==null?i:{directive:{actionType:d("MpsTypes").ActionType.UpsertTopLevel,isLocalOnly:!1,isTransportErrorPlaceholder:!1,tags:[],targetMessageId:a.messageId},status:"success"}}function p(a,b){var c;b=b.subProtocol();if((b==null?void 0:b.kind)!=="consumerApplication")return i;if(((c=b.payload)==null||(c=c.content)==null?void 0:c.pollUpdateMessage)==null)return i;if(((c=b.payload.content.pollUpdateMessage.pollCreationMessageKey)==null?void 0:c.id)==null)return{errorMessage:"no target message id found for poll update message",status:"drop"};c=b.payload.content.pollUpdateMessage.pollCreationMessageKey.id;return{directive:{actionType:d("MpsTypes").ActionType.UpsertSupplemental,isLocalOnly:!1,isTransportErrorPlaceholder:!1,supplementalKey:l(a),tags:[],targetMessageId:d("MpsTypes").toMessageId(c)},status:"success"}}function q(a,b){var c;b=b.subProtocol();if((b==null?void 0:b.kind)!=="armadillo")return i;if(((c=b.payload)==null||(c=c.content)==null?void 0:c.ravenActionNotifMessage)==null)return i;if(((c=b.payload.content.ravenActionNotifMessage.key)==null?void 0:c.id)==null)return{errorMessage:"no target message id found for raven action message",status:"drop"};b=(c=b.payload)==null||(c=c.content)==null||(c=c.ravenActionNotifMessage.key)==null?void 0:c.id;return{directive:{actionType:d("MpsTypes").ActionType.Preprocess,isLocalOnly:!1,isTransportErrorPlaceholder:!1,supplementalKey:k(a),tags:[],targetMessageId:d("MpsTypes").toMessageId(b)},status:"success"}}function r(a,b){var c;b=b.subProtocol();if((b==null?void 0:b.kind)!=="consumerApplication")return i;b=b.proto;c=(c=b.payload)==null?void 0:c.content;b=d("getMediaTypeFromConsumerMessage").getMediaTypeFromConsumerMessage(b);if(b==null&&(c==null?void 0:c.messageText)==null&&(c==null?void 0:c.pollCreationMessage)==null)return i;c=[];b=m(b);b!=null&&c.push(b);return{directive:{actionType:d("MpsTypes").ActionType.UpsertTopLevel,isLocalOnly:!1,isTransportErrorPlaceholder:!1,tags:c,targetMessageId:a.messageId},status:"success"}}function s(a,b){b=b.subProtocol();if((b==null?void 0:b.kind)!=="armadillo")return i;b=b;b=(b=b.payload)==null?void 0:b.content;return(b==null?void 0:b.extendedContentMessage)==null&&(b==null?void 0:b.bumpExistingMessage)==null&&(b==null?void 0:b.noteReplyMessage)==null&&(b==null?void 0:b.screenshotAction)==null?i:{directive:{actionType:d("MpsTypes").ActionType.UpsertTopLevel,isLocalOnly:!1,isTransportErrorPlaceholder:!1,tags:[],targetMessageId:a.messageId},status:"success"}}function t(a,b){return b.proto.payload!=null||((b=b.proto.metadata)==null?void 0:b.chatEphemeralSetting)==null?i:{directive:{actionType:d("MpsTypes").ActionType.Noop,isLocalOnly:!0,isTransportErrorPlaceholder:!1,tags:[],targetMessageId:a.messageId},status:"success"}}function u(a,b){var c,e=b.subProtocol();if((e==null?void 0:e.kind)!=="consumerApplication")return i;e=e.proto;if(((c=e.payload)==null||(c=c.content)==null?void 0:c.editMessage)==null)return i;e=(c=e.payload)==null||(c=c.content)==null?void 0:c.editMessage;e=(c=e.key)==null?void 0:c.id;c=j(a,b);if(e==null)return{errorMessage:"no target message id found for edit supplemental message",status:"drop"};return!c.success?{errorMessage:"no edit timestampMs found for edit supplemental message",status:"drop"}:{directive:{actionType:d("MpsTypes").ActionType.UpsertSupplemental,isLocalOnly:!1,isTransportErrorPlaceholder:!1,supplementalKey:c.value,tags:[],targetMessageId:d("MpsTypes").toMessageId(e)},status:"success"}}function v(a,b){var c;b=b.subProtocol();if((b==null?void 0:b.kind)!=="consumerApplication")return i;b=b.proto;if(((c=b.payload)==null||(c=c.content)==null?void 0:c.reactionMessage)==null)return i;b=(c=b.payload)==null||(c=c.content)==null?void 0:c.reactionMessage;if(((c=b.key)==null?void 0:c.id)==null)return{errorMessage:"no target message id found for reaction supplemental message",status:"drop"};b=(c=b.key)==null?void 0:c.id;return{directive:{actionType:d("MpsTypes").ActionType.UpsertSupplemental,isLocalOnly:!1,isTransportErrorPlaceholder:!1,supplementalKey:h(a),tags:[],targetMessageId:d("MpsTypes").toMessageId(b)},status:"success"}}function w(a,b){a=b.subProtocol();if((a==null?void 0:a.kind)!=="consumerApplication")return i;b=a.proto;b=(a=b.payload)==null||(a=a.applicationData)==null?void 0:a.revoke;if(b==null)return i;if(((a=b.key)==null?void 0:a.id)==null)return{errorMessage:"no target message id found for revoked message",status:"drop"};a=b.key.id;return{directive:{actionType:d("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder,isLocalOnly:!1,isTransportErrorPlaceholder:!1,tags:[],targetMessageId:d("MpsTypes").toMessageId(a)},status:"success"}}function x(a,b){a=a.locallyTransformedMessage();a=(a==null?void 0:a.proto.pollUpdateMessage)!=null;return{actionType:d("MpsTypes").ActionType.UpsertTopLevel,isLocalOnly:!a,isTransportErrorPlaceholder:!1,tags:[],targetMessageId:b.messageId}}function y(a,b){var c;b=b.subProtocol();if((b==null?void 0:b.kind)!=="armadillo")return i;b=b;return((c=b.payload)==null||(c=c.applicationData)==null||(c=c.metadataSync)==null?void 0:c.actions)!=null||((c=b.payload)==null||(c=c.signal)==null?void 0:c.encryptedBackupsSecrets)!=null?{directive:{actionType:d("MpsTypes").ActionType.Preprocess,isLocalOnly:!1,isTransportErrorPlaceholder:!1,tags:[],targetMessageId:a.messageId},status:"success"}:i}function z(a,b){try{a=c("nullthrows")(a.encryptedTransportMessage());var e=[r,s,v,u,w,y,q,p,o,n,t];for(e of e){var f=e(b,a);if(f.status==="success")return d("WAResultOrError").makeResult(f.directive);if(f.status==="drop")return d("WAResultOrError").makeError(f.errorMessage)}d("MWFBLogger").MPSLogger.mustfix("Unknown message type %s",(f=a.subProtocol())==null?void 0:f.kind);return d("WAResultOrError").makeResult({actionType:d("MpsTypes").ActionType.Unknown,isLocalOnly:!0,isTransportErrorPlaceholder:!1,tags:[],targetMessageId:b.messageId})}catch(a){e=c("getErrorSafe")(a);c("FBLogger")("mps").catching(e).mustfix("Directive generation failed for message");return d("WAResultOrError").DEPRECATED_makeError("runtime-error",e)}}function A(a,b){var e;a=c("nullthrows")(a.encryptedTransportEvent()).proto;if(((e=a.placeholder)==null?void 0:e.type)!=null)return{actionType:d("MpsTypes").ActionType.UpsertTopLevel,isLocalOnly:!0,isTransportErrorPlaceholder:!0,tags:[],targetMessageId:b.messageId};if(a.event!=null)return{actionType:d("MpsTypes").ActionType.UpsertTopLevel,isLocalOnly:!0,isTransportErrorPlaceholder:!1,tags:[],targetMessageId:b.messageId}}function B(a,b){var e,f=c("nullthrows")(a.encryptedTransportEvent()).proto;f=f.placeholder!=null;switch((e=a.proto.metadata)==null?void 0:e.futureProofBehavior){case d("MpsFutureProofKey").WCEPlaintextPayloadFutureProof.WCEPlaintextPayloadFutureProofPlaceholder:return d("WAResultOrError").makeResult({actionType:d("MpsTypes").ActionType.UpsertTopLevel,isLocalOnly:!0,isTransportErrorPlaceholder:f,tags:[],targetMessageId:b.messageId});case d("MpsFutureProofKey").WCEPlaintextPayloadFutureProof.WCEPlaintextPayloadFutureProofNoPlaceholder:case d("MpsFutureProofKey").WCEPlaintextPayloadFutureProof.WCEPlaintextPayloadFutureProofIgnore:return d("WAResultOrError").makeResult({actionType:d("MpsTypes").ActionType.Noop,isLocalOnly:!0,isTransportErrorPlaceholder:f,tags:[],targetMessageId:b.messageId});default:e=A(a,b);return d("WAResultOrError").makeResult(e!=null?e:{actionType:d("MpsTypes").ActionType.UpsertTopLevel,isLocalOnly:!0,isTransportErrorPlaceholder:f,tags:[],targetMessageId:b.messageId})}}function C(a){return{actionType:d("MpsTypes").ActionType.UpsertTopLevel,isLocalOnly:!d("MAWMpsGating").isMpsUploadAdminMessageEnabled(),isTransportErrorPlaceholder:!1,tags:[],targetMessageId:a.messageId}}function D(a){var b=d("MAWProtobufDeserializers").DeserializedBackupMessage.create(a.payload),c=b.payload();switch(c.kind){case"messageApplication":return z(b,a);case"transportEvent":return B(b,a);case"locallyTransformedMessage":return d("WAResultOrError").makeResult(x(b,a));case"adminMessage":return d("WAResultOrError").makeResult(C(a));default:c.kind}return d("WAResultOrError").makeError("Incoming message has no payload")}a={name:"MawMpsDirectiveGeneratorPreprocessor",process:function(a,b){b.metric.addPoint("directive_generation_start");var d=[],e=new Map();a.forEach(function(a){var b=a.directive,f=a.insertionSource;a=a.message;var g=D(a);if(g.success&&g.value!=null){d.push({directive:babelHelpers["extends"]({},g.value,{debugFlags:["WA"]}),insertionSource:f,message:a});return}if(b!=null){d.push({directive:b,insertionSource:f,message:a});return}e.set(a.messageId,(b=g.payload)!=null?b:c("err")("Directive generation failed for message - runtime error"))});b.metric.addPoint("directive_generation_end");return{errors:e,payload:d}}};g.createRavenActionSupplementalKeyMps=k;g.createPollUpdateSupplementalKeyMps=l;g.generateDirectiveForMessage=D;g.MawMpsDirectiveGeneratorPreprocessor=a}),98);
__d("MAWMpsMessageRangeQuery",["CoalescingLoader","EBLS","EBMessageRangeQueryForThreads","LSVec","MAWConvertEchoMessagesToEBProtobufs","MAWEncryptedBackupUtils","MAWJobDefinitions","Promise","asyncToGeneratorRuntime","first","justknobx","last"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a){var b=a.args,e=a.echo,f=a.messageRangeInfo;a=a.protobuf;a=[].concat(d("MAWEncryptedBackupUtils").convertLSTypesToJSTypesForRestoreJob(a),d("MAWConvertEchoMessagesToEBProtobufs").convertEchoMessagesToEBProtobufs(c("LSVec").toArray(e).map(d("MAWJobDefinitions").toEncodedEchoMessage),b.chatJid));a.sort(function(a,b){return a.toplevelProtobuf.protobufTimestampMS-b.toplevelProtobuf.protobufTimestampMS});e=b.direction==="after"?f.has_more_after:f.has_more_before;b=b.direction==="after"?f.has_more_before:f.has_more_after;f=c("first")(a);var g=c("last")(a);f={endCursor:f&&[f.otid,String(f.toplevelProtobuf.protobufTimestampMS)],hasNext:e,hasPrevious:b,startCursor:g&&[g.otid,String(g.toplevelProtobuf.protobufTimestampMS)]};return{success:!0,value:{cursorInfo:f,messages:a}}}function a(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b;for(var c of a)c.ctx.metric.addPoint("mps_message_range_query_start",{"int":{batchSize:a.length}});c=(yield d("EBLS").init()).db;var e=a[0].instanceKey;b=(b=a[0].source)!=null?b:-1;var f=(yield d("EBMessageRangeQueryForThreads").messageRangeQueryForThreads({instanceKey:e,restoreType:"range",source:b,storage:c,threads:a.map(function(a){return{chatJid:a.chatJid,direction:a.direction,from:a.after,numMessages:a.numMessages}})}));for(e of a)e.ctx.metric.addPoint("mps_message_range_query_end",{bool:{rangeQuerySuccess:f.success}});return f.success===!1?a.map(function(){return f}):f.value.map(function(a){return a.success===!1?a:i(a.value)})});return j.apply(this,arguments)}f=function(){return new(h||(h=b("Promise")))(function(a){return setTimeout(a,0)})};f=c("justknobx")._("4737")?f:function(){return(h||(h=b("Promise"))).resolve()};var k=new(d("CoalescingLoader").CoalescingLoader)(a,f);function e(a){return k.gen(a)}g.LOADER=k;g.MAWMpsMessageRangeQuery=e}),98);
__d("MAWMpsMutateMessagePreprocessor",["FBLogger","MAWMpsTypes","MAWProtobufDeserializers","MpsTypes","WAArmadilloApplication.pb","WAArmadilloBackupMessage.pb","WAJids","WAMsgApplication.pb","WAResultOrError","encodeProtobuf","err","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";var h=[e,b,a];function i(a,b,c){c={ephemeralType:c};c={payload:{content:{ravenMessage:c}}};b={metadata:b.metadata,payload:{subProtocol:{armadillo:{payload:d("encodeProtobuf").encodeProtobuf(d("WAArmadilloApplication.pb").ArmadilloSpec,c).readBuffer(),version:1}}}};c=d("encodeProtobuf").encodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,b).readBuffer();b={encryptedTransportMessage:c,metadata:a.proto.metadata};return d("encodeProtobuf").encodeProtobuf(d("WAArmadilloBackupMessage.pb").BackupMessageSpec,b).readBuffer()}function a(a,b){var e=a.directive,f=a.insertionSource;a=a.message;b=(b=b.encryptedTransportMessage())==null||(b=b.armadillo())==null||(b=b.payload)==null||(b=b.content)==null?void 0:b.ravenActionNotifMessage;if(b==null)return;var g={actionType:d("MpsTypes").ActionType.UpsertSupplemental,debugFlags:e==null?void 0:e.debugFlags,isLocalOnly:!1,isTransportErrorPlaceholder:!1,supplementalKey:e==null?void 0:e.supplementalKey,tags:[],targetMessageId:a.messageId};b=c("nullthrows")((b=b.key)==null?void 0:b.id);e={actionType:d("MpsTypes").ActionType.DeleteSupplemental,debugFlags:e==null?void 0:e.debugFlags,isLocalOnly:!0,isTransportErrorPlaceholder:!1,supplementalKey:d("MpsTypes").toSupplementalKey(d("MAWMpsTypes").SupplementalKeyPrefixMps.RAVEN_ORIGINAL_MESSAGE),tags:[],targetMessageId:d("MpsTypes").toMessageId(b)};b={messageId:d("MpsTypes").toMessageId(b),payload:a.payload,senderId:a.senderId,threadId:a.threadId,timestampMs:a.timestampMs};return[{directive:g,insertionSource:f,message:a},{directive:e,insertionSource:f,message:b}]}function b(a,b){var c,e=a.directive,f=a.insertionSource;a=a.message;var g=b.encryptedTransportMessage();c=(c=b.encryptedTransportMessage())==null||(c=c.armadillo())==null||(c=c.payload)==null||(c=c.content)==null||(c=c.ravenMessageMsgr)==null?void 0:c.ephemeralType;if(g==null||c==null)return;var h=[];b={messageId:a.messageId,payload:i(b,g.proto,c),senderId:a.senderId,threadId:a.threadId,timestampMs:a.timestampMs};g={actionType:d("MpsTypes").ActionType.UpsertTopLevel,debugFlags:e==null?void 0:e.debugFlags,isLocalOnly:!1,isTransportErrorPlaceholder:!1,tags:[],targetMessageId:a.messageId};c={actionType:d("MpsTypes").ActionType.UpsertSupplemental,debugFlags:e==null?void 0:e.debugFlags,isLocalOnly:!0,isTransportErrorPlaceholder:!1,supplementalKey:d("MpsTypes").toSupplementalKey(d("MAWMpsTypes").SupplementalKeyPrefixMps.RAVEN_ORIGINAL_MESSAGE),tags:[],targetMessageId:a.messageId};h.push({directive:g,insertionSource:f,message:b},{directive:c,insertionSource:f,message:a});return h}function j(a){if(a==null)return null;a=d("WAJids").interpretAndValidateJid(a);if(a.jidType==="msgrUser")return a.userJid;else if(a.jidType==="group")return a.groupJid;else{a.jidType;return null}}function e(a,b){var e=a.directive,f=a.insertionSource,g=a.message;b=(a=b.encryptedTransportMessage())==null||(a=a.armadillo())==null||(a=a.payload)==null?void 0:a.applicationData;if(b==null)return;var h=[];(a=b.metadataSync)==null||a.actions.forEach(function(a){if(a.chatAction!=null){var b=a.chatAction;if(b.chatId==null){c("FBLogger")("mps").warn("Chat id not defined for appdata chat action");return}b.chatDelete!=null&&h.push({directive:{actionType:d("MpsTypes").ActionType.DeleteThread,debugFlags:e==null?void 0:e.debugFlags,isLocalOnly:!0,isTransportErrorPlaceholder:!1,tags:[],targetMessageId:g.messageId},insertionSource:f,message:babelHelpers["extends"]({},g,{threadId:d("MpsTypes").toThreadId(b.chatId)})});if(b.chatArchive!=null){c("FBLogger")("mps").warn("Chat archive not supported for appdata");return}if(b.chatRead!=null){c("FBLogger")("mps").warn("Chat read not supported for appdata");return}}if(a.messageAction!=null){b=a.messageAction;if(b.key==null){c("FBLogger")("mps").warn("Message key not defined for appdata message");return}a=b.key.id;var i=j(b.key.remoteJid);if(i==null){c("FBLogger")("mps").warn("Message key remoteJid incomplete for appdata message");return}if(a==null){c("FBLogger")("mps").warn("Message key id is incomplete for appdata message");return}b.messageDelete!=null&&h.push({directive:{actionType:d("MpsTypes").ActionType.DeleteTopLevel,debugFlags:e==null?void 0:e.debugFlags,isLocalOnly:!1,isTransportErrorPlaceholder:!1,tags:[],targetMessageId:d("MpsTypes").toMessageId(a)},insertionSource:f,message:babelHelpers["extends"]({},g,{threadId:d("MpsTypes").toThreadId(i)})})}});return h}function k(a){try{for(var b of h){var e=d("MAWProtobufDeserializers").DeserializedBackupMessage.create(a.message.payload);e=b(a,e);if(e!=null)return d("WAResultOrError").makeResult(e)}c("FBLogger")("mps").warn("mutate preprocessor failed to mutate payload");return d("WAResultOrError").makeResult([a])}catch(a){c("FBLogger")("mps").catching(a).mustfix("Preprocess directive handling failed for message");return d("WAResultOrError").DEPRECATED_makeError("runtime-error",a)}}f={name:"MAWMpsMutateMessagePreprocessor",process:function(a,b){b.metric.addPoint("mutate_start");var e=[],f=new Map();a.forEach(function(a){var b;if(((b=a.directive)==null?void 0:b.actionType)!==d("MpsTypes").ActionType.Preprocess){e.push(a);return}b=k(a);if(b.success)e.push.apply(e,b.value);else{f.set(a.message.messageId,(a=b.payload)!=null?a:c("err")("Preprocess directive handler failed - runtime error"))}});b.metric.addPoint("mutate_end");return{errors:f,payload:e}}};g.MAWMpsMutateMessagePreprocessor=f}),98);
__d("MAWMpsSetExpiryPreprocessor",["FBLogger","MAWProtobufDeserializers","MpsTypes","WAResultOrError","getErrorSafe","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";function h(a){var b=a.payload;a=a.timestampMs;b=d("MAWProtobufDeserializers").DeserializedBackupMessage.create(b);b=(b=(b=b.encryptedTransportMessage())==null||(b=b.proto.metadata)==null||(b=b.chatEphemeralSetting)==null?void 0:b.ephemeralExpiration)!=null?b:0;if(b<=0)return;return a+b*1e3}function i(a){var b=a.insertionSource,e=a.message,f=c("nullthrows")(a.directive),g=f.actionType===d("MpsTypes").ActionType.UpsertTopLevel||f.actionType===d("MpsTypes").ActionType.DeleteTopLevel||f.actionType===d("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder;if(!g)return a;g=h(e);return g==null?a:{directive:babelHelpers["extends"]({},f,{expiryTimestampMs:g,isLocalOnly:!0}),insertionSource:b,message:e}}function j(a){try{return d("WAResultOrError").makeResult(i(a))}catch(b){a=c("getErrorSafe")(b);c("FBLogger")("mps").catching(a).mustfix("SetExpiry Preprocess failed");return d("WAResultOrError").makeError(a)}}a={name:"MAWMpsSetExpiryPreprocessor",process:function(a,b){b.metric.addPoint("set_expiry_start");var c=[],d=new Map();a.forEach(function(a){var b=j(a);b.success?c.push(b.value):d.set(a.message.messageId,b.error)});b.metric.addPoint("set_expiry_end");return{errors:d,payload:c}}};g.MAWMpsSetExpiryPreprocessor=a}),98);
__d("MAWMpsXMAValidationPreprocessor",["ACTSanitizerApiLazyLoader","ACTSanitizerApiTypes","FBLogger","MAWParseXMAFBConfig","MAWParseXMAProtocol","MAWProtobufDeserializers","Promise","WAResultOrError","asyncToGeneratorRuntime","err","getErrorSafe","getMediaTypeFromConsumerMessage"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a){if(a.payload==null)return;a=new(d("MAWProtobufDeserializers").DeserializedMessageApplication)(a.payload);a=a.subProtocol();if((a==null?void 0:a.kind)==="consumerApplication")return a.proto}function j(){var a=null;return function(){var e=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){try{if(a==null){var e=(yield d("ACTSanitizerApiLazyLoader").loadACTSanitizerApi());a=e.isXMAValid}e=a;e=e(b);if(e!==d("ACTSanitizerApiTypes").ACTSanitizerValidationResult.Valid)throw c("FBLogger")("mps").mustfixThrow("XMA validation failed - extendedContentMessage does not have valid XMA content");e=b.associatedMessage;var f=b.sentWithMessageId,g=b.targetType;b=b.xmaDataclass;if(g==null||!d("MAWParseXMAFBConfig").isFBSupportedTargetType({fbTargetType:g,xmaDataclass:b})){c("FBLogger")("mps").warn("XMA Validation - found futureproof message");return d("WAResultOrError").makeResult()}if(e!=null&&f==null)throw c("FBLogger")("mps").mustfixThrow("XMA validation failed - XMA associatedMessage cannot be received without sentWithMessageId field");if(e!=null){b=i(e);if(d("getMediaTypeFromConsumerMessage").getMediaTypeFromConsumerMessage(b)!=null&&!d("MAWParseXMAProtocol").SUPPORTED_XMA_ASSOC_MEDIA_TARGET_TYPES.has(g))throw c("FBLogger")("mps").mustfixThrow("XMA validation failed - XMA associated msg has unsupported media type")}return d("WAResultOrError").makeResult()}catch(a){f=c("getErrorSafe")(a);c("FBLogger")("mps").catching(c("getErrorSafe")(f)).mustfix("XMA Validation failed for message");return d("WAResultOrError").DEPRECATED_makeError("runtime-error",f)}});return function(a){return e.apply(this,arguments)}}()}a={name:"MAWMpsXMAValidationPreprocessorAsync",processAsync:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e){e.metric.addPoint("xma_validator_start");var f=new Array(a.length),g=new Map(),i=j();a=a.map(function(a,b){var e;e=(e=d("MAWProtobufDeserializers").DeserializedBackupMessage.create(a.message.payload).encryptedTransportMessage())==null||(e=e.armadillo())==null||(e=e.payload)==null||(e=e.content)==null?void 0:e.extendedContentMessage;if(e==null){f[b]=a;return}return i(e).then(function(d){if(d.success)f[b]=a;else{g.set(a.message.messageId,(d=d.payload)!=null?d:c("err")("XMA validation failed for message - runtime error"))}})}).filter(Boolean);a.length>0&&(yield (h||(h=b("Promise"))).all(a));e.metric.addPoint("xma_validator_end");return{errors:g,payload:f.filter(Boolean)}});function e(b,c){return a.apply(this,arguments)}return e}()};g.MAWMpsXMAValidationPreprocessor=a}),98);
__d("MAWThreadUpdatePostProcessors",["FBLogger","MAWWorkerCacheServicesForMPS","Promise","asyncToGeneratorRuntime","cr:21515"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){d("MAWWorkerCacheServicesForMPS").getMAWWorkerCacheServices().calculateDelta(a);return(h||(h=b("Promise"))).resolve(new Map())}var i;function e(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(b("cr:21515")!=null){i==null&&(i=b("cr:21515").subscribeToPLLAndWriteToCache());try{yield b("cr:21515").submitMPSMessagesToPLL(a.map(function(a){a=a.message;return a}))}catch(a){c("FBLogger")("messenger_e2ee_web").catching(a).warn("Snippet PLL update failure")}}return(h||(h=b("Promise"))).resolve(new Map())});return j.apply(this,arguments)}f={isCritical:!1,name:"MAWReactiveThreadUpdatePostProcessor",process:a};a={isCritical:!1,name:"MAWPLLThreadUpdatePostProcessor",process:e};g.MAWReactiveThreadUpdatePostProcessor=f;g.MAWPLLThreadUpdatePostProcessor=a}),98);
__d("MawMpsCopPostprocessor",["MawMpsCop","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){b.metric.addPoint("cop_start");yield d("MawMpsCop").mpsCop().postProcessMessages(a);b.metric.addPoint("cop_end");return new Map()});return i.apply(this,arguments)}a={isCritical:!0,name:"MpsCopPostProcessor",process:function(a,b){return h(a,b)}};g.MpsCopPostProcessor=a}),98);
__d("MawMpsDeleteTopLevelWithPlaceholderProcessor",["MpsTypes","Promise","WAWaitForUserUnblocked","WebMps","asyncToGeneratorRuntime","getErrorSafe","justknobx","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,b){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var e=c("justknobx")._("4369")?c("justknobx")._("4370")?d("WAWaitForUserUnblocked").isStillWaitingForUserUnblocked()?"local-only":"local-first":"local-first":"local-only";e=(yield d("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!1,shouldFetchTags:!1,strategy:e},debug:{purpose:"preprocess_revoke_fetch_local"},messageId:b,threadId:a}));return e.value});return j.apply(this,arguments)}function k(a,b){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var e=c("nullthrows")(a.directive),f=a.insertionSource,g=a.message;a={directive:{actionType:d("MpsTypes").ActionType.DeleteTopLevel,isLocalOnly:!1,isTransportErrorPlaceholder:!1,tags:[],targetMessageId:e.targetMessageId},insertionSource:f,message:{messageId:e.targetMessageId,payload:g.payload,senderId:g.senderId,threadId:g.threadId,timestampMs:g.timestampMs}};var h=g.timestampMs;b=b.find(function(a){return a.message.messageId===e.targetMessageId&&g.threadId===a.message.threadId});if(b!=null)h=b.message.timestampMs;else{b=(yield i(g.threadId,e.targetMessageId));b!=null&&(h=b==null?void 0:b.toplevelProtobuf.timestampMs)}b={directive:e,insertionSource:f,message:babelHelpers["extends"]({},g,{timestampMs:h})};return[a,b]});return l.apply(this,arguments)}a={name:"MawMpsDeleteTopLevelWithPlaceholderProcessorAsync",processAsync:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,e){e.metric.addPoint("delete_top_level_start");var f=[],g=new Map(),i=function(){var d=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b,d){try{var e=(yield k(b,a));f[d]=e}catch(a){g.set(b.message.messageId,c("getErrorSafe")(a))}});return function(a,b){return d.apply(this,arguments)}}(),j=a.map(function(a,b){var c;c=(c=a.directive)==null?void 0:c.actionType;if(c===d("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder)return i(a,b);else{f[b]=[a];return null}}).filter(Boolean);j.length!==0&&(yield (h||(h=b("Promise"))).all(j));e.metric.addPoint("delete_top_level_end");return{errors:g,payload:f.flat().filter(Boolean)}});function e(b,c){return a.apply(this,arguments)}return e}()};g.MawMpsDeleteTopLevelWithPlaceholderProcessor=a}),98);
__d("MawMpsMinosUploadPostProcessor",["EBEnqueueMinosMessage","MpsTypes","Promise","WAJids","asyncToGeneratorRuntime","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=new Map(),f=[];a=a.filter(function(a){var b=a.directive,c=a.insertionSource;a=a.message;a=d("WAJids").switchOnMsgrChatJidType(d("WAJids").unsafeCoerceToChatJid(a.threadId),{group:function(){return"group"},user:function(){return"one_to_one"}});return c===d("MpsTypes").InsertionSource.Send&&a==="one_to_one"&&k(b.actionType)&&!l(b)&&!m(b)});var g=new Map(),i=new Map();a.forEach(function(a){var b=a.directive;a=a.message;b.actionType===d("MpsTypes").ActionType.DeleteTopLevel?g.set(a.messageId,{message:a,updateDirective:b}):b.actionType===d("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder?i.set(b.targetMessageId,{message:a,updateDirective:b}):f.push({message:a,updateDirective:b})});i.forEach(function(a,b){g.has(b)&&g["delete"](b),f.push(a)});g.forEach(function(a){f.push(a)});if(f.length===0)return e;yield (h||(h=b("Promise"))).all(f.map(function(a){var b=a.message;a=a.updateDirective;return d("EBEnqueueMinosMessage").enqueueSentMinosMessageForUpload({message:b,updateDirective:a}).then(function(a){a.success===!1&&e.set(b.messageId,c("getErrorSafe")(a.error))})["catch"](function(a){return e.set(b.messageId,c("getErrorSafe")(a))})}));return e});return j.apply(this,arguments)}function k(a){switch(a){case d("MpsTypes").ActionType.UpsertTopLevel:case d("MpsTypes").ActionType.UpsertSupplemental:case d("MpsTypes").ActionType.DeleteTopLevel:case d("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder:return!0;default:return!1}}function l(a){return a.expiryTimestampMs!=null}function m(a){return a.isLocalOnly}a={isCritical:!0,name:"MawMpsMinosUploadPostProcessor",process:function(a){return i(a)}};g.MawMpsMinosUploadPostProcessor=a}),98);
__d("MawMpsPayloadValidatorPreprocessor",["FBLogger","MAWProtobufDeserializers","MpsTypes","getErrorSafe","justknobx","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";var h=["directive","message"],i=new Date(2e3,1,1).getTime(),j=new Date(2500,1,1).getTime();function k(a,b){if(!a)throw c("FBLogger")("mps").mustfixThrow(b)}function l(a,b){var e=d("MAWProtobufDeserializers").DeserializedBackupMessage.create(b.payload);e=e.proto.metadata;k(a!=null,"directive is missing");a=c("nullthrows")(a);switch(c("nullthrows")(a.actionType)){case d("MpsTypes").ActionType.UpsertSupplemental:k(a.supplementalKey!=null,"supplemental key must be set");break;case d("MpsTypes").ActionType.UpsertTopLevel:k(a.targetMessageId===b.messageId,"messageId mismatch between directive and message");break;case d("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder:case d("MpsTypes").ActionType.DeleteTopLevel:case d("MpsTypes").ActionType.Unknown:case d("MpsTypes").ActionType.Noop:case d("MpsTypes").ActionType.Preprocess:case d("MpsTypes").ActionType.DeleteSupplemental:case d("MpsTypes").ActionType.DeleteThread:break}k(a.expiryTimestampMs==null||a.isLocalOnly,"If expiryTimestampMs is set, isLocalOnly must be true. we do not want to upload ephemeral messages to the server. Action type: "+String(a.actionType));k(e!=null,"metadata is missing in the protobuf");k((e==null?void 0:e.senderId)===b.senderId,"senderId mismatch between protobuf metadata and message");k((e==null?void 0:e.timestampMs)===b.timestampMs||(a==null?void 0:a.actionType)===d("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder,"timestamp mismatch between protobuf metadata and message");k(!b.senderId.includes("@"),"senderId should just be an FBID, got "+b.senderId+" instead");e=b.threadId;k(e.includes("@"),"threadId should be a JID, got "+e+" instead");k(b.timestampMs>i,"timestampMs should be millisecond timestamps, got "+b.timestampMs+" instead");k(b.timestampMs<j,"timestampMs should be millisecond timestamps, got "+b.timestampMs+" instead")}function m(a,b){try{l(a,b)}catch(a){return c("getErrorSafe")(a)}}a={name:"MawMpsPayloadValidatorPreprocessor",process:function(a,b){if(c("justknobx")._("1008")===!1)return{errors:new Map(),payload:a};b.metric.addPoint("payload_validator_start");var d=[],e=new Map();a.forEach(function(a){var b=a.directive,c=a.message;a=babelHelpers.objectWithoutPropertiesLoose(a,h);var f=m(b,c);f==null?d.push(babelHelpers["extends"]({directive:b,message:c},a)):e.set(c.messageId,f)});b.metric.addPoint("payload_validator_end");return{errors:e,payload:d}}};g.MawMpsPayloadValidatorPreprocessor=a}),98);
__d("MawMpsUploadMessagesToEBPostprocessor",["EBEnqueueMessagesForUpload","EncryptedBackupsUploadEntity","FBLogger","MAWMPSCreateBackupDirective","MpsTypes","WAAsMessageApplication","WAJids","WATimeUtils","asyncToGeneratorRuntime","err"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=new Map();try{var e=a.map(function(a){var b=a.directive;a=a.message;var c=d("MAWMPSCreateBackupDirective").getTargetProtocolMsgIdForMessage(b,a);b=d("MAWMPSCreateBackupDirective").createBackupDirectiveFromMPSMessage(b,c);if(b==null)return;var e=b.actionType===3?k(c,d("WATimeUtils").castToMillisTime(a.timestampMs)):d("EncryptedBackupsUploadEntity").toEbBackupMessageBytes(a.payload);return{backupDirective:b,externalId:c.externalId,payload:e,threadId:d("WAJids").unsafeCoerceToChatJid(a.threadId)}}).filter(Boolean);e=(yield c("EBEnqueueMessagesForUpload")({messages:e,triggerSource:"upload-message-from-mps"}));for(e of e.entries()){var f=e[0],g=e[1];if(g.success)continue;b.set(d("MpsTypes").toMessageId(f),(f=g.payload)!=null?f:c("err")(g.error))}}catch(d){c("FBLogger")("mps").MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Failed to enqueue messages to upload queue: ",""])),String(d)),a.forEach(function(a){a=a.message;b.set(a.messageId,c("err")("runtime-error",d))})}return b});return j.apply(this,arguments)}function k(a,b){return d("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:d("WAAsMessageApplication").castToMessageApplicationBytes(new Uint8Array(0)),msgId:a,reportingMeta:void 0,sortOrderMs:b})}a={isCritical:!0,name:"MawMpsUploadMessagesToEBPostprocessor",process:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=(yield i(a.filter(function(a){return!a.directive.isLocalOnly})));return a});function c(b){return a.apply(this,arguments)}return c}()};g.MawMpsUploadMessagesToEBPostprocessor=a}),98);
__d("MpsExtensionConfiguration",[],(function(a,b,c,d,e,f){"use strict";a=function(a){var b=a.postProcessors;a=a.preprocessors;var c=[],d=[];b.forEach(function(a){a.isCritical?c.push(a):d.push(a)});this.postProcessors={critical:c,nonCritical:d};this.preprocessors=a};f.MpsExtensionConfiguration=a}),66);
__d("MpsFtsPostProcessor",["MAWDexieTable","MAWFTSTxns","MAWFTSWorker","MAWIndexedDb","MAWTransactionMode","MpsMessageToBridgeWrapper","MpsTypes","WAStanzaUtils","asyncToGeneratorRuntime","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";function h(a){var b,c=d("WAStanzaUtils").toStanzaId(a.directive.targetMessageId),e=d("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(a.message);if(a.directive.actionType===d("MpsTypes").ActionType.UpsertTopLevel&&a.directive.expiryTimestampMs==null&&((b=e.deserialize().encryptedTransportMessage())==null||(b=b.consumerMessage())==null||(b=b.payload)==null||(b=b.content)==null?void 0:b.messageText)!=null)return function(a){return d("MAWFTSTxns").maybePutMessageToBacklog(a,c)};if(a.directive.actionType===d("MpsTypes").ActionType.DeleteTopLevel)return function(a){return d("MAWFTSTxns").maybePutMessageToPurgeBacklog(a,c)};if(a.directive.actionType===d("MpsTypes").ActionType.DeleteThread)return function(a){return d("MAWFTSTxns").maybePutThreadToPurgeBacklog(a,e.getChatJid())}}function a(a){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.map(h).map(function(b,c){return b!=null?[b,a[c]]:null}).filter(Boolean);if(b.length===0)return new Map();var e=new Map();try{yield d("MAWIndexedDb").makeMsgrTransactor({ftsBackloggedMessages:d("MAWTransactionMode").READWRITE,ftsPurgeBacklog:d("MAWTransactionMode").READWRITE,ftsPurgeThreadBacklog:d("MAWTransactionMode").READWRITE},"mpsFts",function(a){return function(){return d("MAWDexieTable").dexieAll(b.map(function(b){var d=b[0],f=b[1];return d(a)["catch"](function(a){e.set(f.message.messageId,c("getErrorSafe")(a))})}))}})()}catch(a){b.forEach(function(b){b[0];b=b[1];e.set(b.message.messageId,c("getErrorSafe")(a))})}yield d("MAWFTSWorker").getFTSWorker().index({estimatedNumMessages:b.length,type:"LOCAL"});return e});return i.apply(this,arguments)}e={isCritical:!1,name:"MpsFtsPostProcessor",process:a};g.MpsFtsPostProcessor=e}),98);
__d("MpsMediaPostProcessor",["MpsMediaEntryCache","Promise","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a){try{d("MpsMediaEntryCache").hydrateCache(a.message)}catch(a){return c("getErrorSafe")(a)}}function j(a){var c=new Map();a.forEach(function(a){var b=i(a);b!=null&&c.set(a.message.messageId,b)});return(h||(h=b("Promise"))).resolve(c)}a={isCritical:!0,name:"MpsMediaPostProcessor",process:function(a){return j(a)}};g.MpsMediaPostProcessor=a}),98);
__d("MAWMpsSetup",["BackendInitLoggingUtils","EBAPIMessagePointQuery","EBMessageMetadataCache","MAWCurrentUser","MAWEBLSInWorkerSwitch","MAWIndexedDbMetadata","MAWMpsAppdataEncryptedBackupsSecretsPreprocessor","MAWMpsDecodeAndParseEbProtobufs","MAWMpsDirectiveGenerator","MAWMpsGating","MAWMpsMessageRangeQuery","MAWMpsMutateMessagePreprocessor","MAWMpsSetExpiryPreprocessor","MAWMpsXMAValidationPreprocessor","MAWODSProxy","MAWQplProxy","MAWThreadUpdatePostProcessors","MawMpsCopPostprocessor","MawMpsDeleteTopLevelWithPlaceholderProcessor","MawMpsMinosUploadPostProcessor","MawMpsPayloadValidatorPreprocessor","MawMpsUploadMessagesToEBPostprocessor","MessengerWebInitData","MpsExtensionConfiguration","MpsFtsPostProcessor","MpsMediaPostProcessor","WAOdsEnums","WebMps","asyncToGeneratorRuntime","gkx","justknobx","qpl"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=[d("MawMpsCopPostprocessor").MpsCopPostProcessor];d("MAWMpsGating").isFullMpsEnabled()&&(a.push(d("MpsFtsPostProcessor").MpsFtsPostProcessor),a.push(d("MpsMediaPostProcessor").MpsMediaPostProcessor));(d("MAWMpsGating").isFullMpsEnabled()||c("gkx")("2792"))&&(a.push(d("MAWThreadUpdatePostProcessors").MAWReactiveThreadUpdatePostProcessor),a.push(d("MAWThreadUpdatePostProcessors").MAWPLLThreadUpdatePostProcessor));(c("gkx")("14827")||c("gkx")("14828"))&&a.push(d("MawMpsMinosUploadPostProcessor").MawMpsMinosUploadPostProcessor);d("MAWMpsGating").isEbUploadViaMpsEnabled()&&a.push(d("MawMpsUploadMessagesToEBPostprocessor").MawMpsUploadMessagesToEBPostprocessor);return new(d("MpsExtensionConfiguration").MpsExtensionConfiguration)({postProcessors:a,preprocessors:[d("MAWMpsDirectiveGenerator").MawMpsDirectiveGeneratorPreprocessor,d("MawMpsDeleteTopLevelWithPlaceholderProcessor").MawMpsDeleteTopLevelWithPlaceholderProcessor,d("MAWMpsAppdataEncryptedBackupsSecretsPreprocessor").MAWMpsAppdataEncryptedBackupsSecretsPreprocessor,d("MAWMpsMutateMessagePreprocessor").MAWMpsMutateMessagePreprocessor,d("MAWMpsSetExpiryPreprocessor").MAWMpsSetExpiryPreprocessor,d("MAWMpsXMAValidationPreprocessor").MAWMpsXMAValidationPreprocessor,d("MawMpsPayloadValidatorPreprocessor").MawMpsPayloadValidatorPreprocessor]})}function a(){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield d("BackendInitLoggingUtils").measureMawInit("make_mps",function(){return d("WebMps").makeMps({db:{blockingErrorThreshold:c("justknobx")._("3218"),name:d("MAWIndexedDbMetadata").webReverDbbName(d("MAWCurrentUser").getID()),onBlockingError:function(a){d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25310776,"6155"),"database_mps_setup_failed"),d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.WORM,key:"reverb.unrecoverable."+a})},qplEvent:c("qpl")._(1056840657,"2716"),strEncKey:c("MessengerWebInitData").accountKeyV2},dependencies:{decodeAndParseEbProtobufs:d("MAWMpsDecodeAndParseEbProtobufs").decodeAndParseEbProtobufs,eb:{getMetadataFromCache:d("EBMessageMetadataCache").getEBMetadataFromCache,isEbEnabled:function(){return c("MAWEBLSInWorkerSwitch").isEnabled()},messagePointQuery:c("EBAPIMessagePointQuery"),messageRangeQuery:d("MAWMpsMessageRangeQuery").MAWMpsMessageRangeQuery}},extensionConfiguration:h()})})});return i.apply(this,arguments)}g.getMpsExtensionConfiguration=h;g.mawMpsSetup=a}),98);
__d("MAWPersistedQueuesSetup",["BackendInitLoggingUtils","MAWCurrentUser","MAWIndexedDbMetadata","MAWODSProxy","MessengerWebInitData","PersistedQueueDB","WAOdsEnums","asyncToGeneratorRuntime","gkx","justknobx","qpl"],(function(a,b,c,d,e,f,g){"use strict";function a(){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){c("gkx")("7318")&&(yield d("BackendInitLoggingUtils").measureMawInit("persisted_queues_init",function(){return d("PersistedQueueDB").makePersistedQueues({blockingErrorThreshold:c("justknobx")._("3218"),dbName:d("MAWIndexedDbMetadata").persistedQueueDbName(d("MAWCurrentUser").getID()),onBlockingError:function(a){d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.WORM,key:"reverb.unrecoverable."+a})},qplEvent:c("qpl")._(1056840657,"2716"),strEncKey:c("MessengerWebInitData").accountKeyV2})}))});return h.apply(this,arguments)}g.mawPersistedQueuesSetup=a}),98);
__d("MAWDeleteDanglingParticipantsStartupJob",["MAWDbVersion","MAWIndexedDb","MAWODSProxy","MAWQplProxy","MAWTransactionMode","WALogger","WAOdsEnums","asyncToGeneratorRuntime","gkx","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a){d("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[Delete Dangling Participants] ",""])),a)}var j=d("MAWIndexedDb").makeMsgrTransactor({participants:d("MAWTransactionMode").READWRITE,threads:d("MAWTransactionMode").READONLY},"deleteDanglingParticipantsStartupJob",function(a){return function(){return a.threads.toArray().then(function(b){return a.participants.where("threadJid").noneOf(b.map(function(a){return a.jid}))["delete"]()})}});a={run:function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(c("gkx")("24027")){i("Starting job...");d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_DELETE_DANGLING_PARTICIPANTS,key:"start"});var a=(yield d("MAWDbVersion").getDBVersion());if(a!=null&&a>=85){i(""+(a!=null?a:"null"));var b=(yield d("MAWQplProxy").measurePerfInQPL_USE_WITH_CARE(c("qpl")._(25310776,"6155"),"startup_job:delete_dangling_participants",function(){return j()}));d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_DELETE_DANGLING_PARTICIPANTS,key:b>0?"deleted":"good"});i("Found and deleted "+b+" dangling participants")}else i("Expected DBVersion >= 85, but got "+(a!=null?a:"null")+" instead"),d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.MAW_DELETE_DANGLING_PARTICIPANTS,key:"db_version_not_ready"})}});function e(){return a.apply(this,arguments)}return e}()};e=a;g["default"]=e}),98);
__d("MAWStartupJob",["MAWDeleteDanglingParticipantsStartupJob","MAWQplProxy","Promise","asyncToGeneratorRuntime","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i=[c("MAWDeleteDanglingParticipantsStartupJob")];function a(){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25310776,"6155"),"backend_startup_jobs"),yield (h||(h=b("Promise"))).all(i.map(function(a){return a.run()}))});return j.apply(this,arguments)}g.runMAWStartupJobs=a}),98);
__d("MAWSetupAllDatabases",["BackendInitLoggingUtils","EBDB","MAWCacheServiceDB","MAWCurrentUser","MAWDBKeychain","MAWDbInitIndexedDb","MAWEARGenNewKeychainCryptoKey","MAWFTSIndexedDb","MAWIndexedDb","MAWIndexedDbMetadata","MAWJobsIndexedDb","MAWMpsSetup","MAWODSProxy","MAWPersistedQueuesSetup","MAWQplProxy","MAWStartupJob","MAWWormOdsLogger","MWEARKeychainV3","MessengerWebInitData","WAHex","WAOdsEnums","WASignalDB","WormGlobalConfig","asyncToGeneratorRuntime","cr:21079","cr:21080","gkx","justknobx","promiseDone","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h=b("cr:21079")||b("cr:21080");function a(){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a,e=c("qpl")._(25310776,"6155");d("WormGlobalConfig").setWormGlobalConfig({useNoWABinary:function(){return c("gkx")("14807")}});yield (a=d("BackendInitLoggingUtils")).measureMawInit("make_jobs_db",d("MAWJobsIndexedDb").makeJobsDb);yield a.measureMawInit("make_fts_db",d("MAWFTSIndexedDb").makeFTSDB);var f=(yield a.measureMawInit("make_maw_ear",d("MAWDBKeychain").initEAR)),g=f.isNewUser,i=f.reinitEAR,j=f.useMawEAR;yield a.measureMawInit("make_db",b("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(!j)return d("MAWDbInitIndexedDb").dbInit({});var a;g===!0&&(a=babelHelpers["extends"]({},yield c("MAWEARGenNewKeychainCryptoKey")(),{randomisedVersion:d("MWEARKeychainV3").generateNewRandomisedVersionNumber([]),version:1}));return d("MAWDbInitIndexedDb").dbInit({onDbPopulate:function(b){d("MAWDBKeychain").onDbPopulateMAWKeychain(b,a)}}).then(b("asyncToGeneratorRuntime").asyncToGenerator(function*(){i===!0&&(yield d("MAWDBKeychain").initEAR()),d("MWEARKeychainV3").setNamespaceSourceDbAndMarkAsReady("maw_ear",(yield d("MAWIndexedDb").getDB()).stores.backendDB())}))}));yield a.measureMawInit("make_signal_db",function(){return d("WASignalDB").makeSignalDb(d("MAWIndexedDbMetadata").signalWorm(d("MAWCurrentUser").getID()),c("MessengerWebInitData").accountKeyV2,c("justknobx")._("3218"),function(a){d("MAWQplProxy").sendQplPointThroughBridge(e,"database_signal_db_setup_failed"),d("MAWODSProxy").odsBumpEntityKey({entity:d("WAOdsEnums").Entity.WORM,key:"unrecoverable."+a})},d("MAWWormOdsLogger").wormOdsWorkerLogger,c("qpl")._(1056840657,"2716"))});yield d("MAWMpsSetup").mawMpsSetup();yield d("MAWPersistedQueuesSetup").mawPersistedQueuesSetup();yield a.measureMawInit("make_ebdb",function(){return d("EBDB").makeEBDB(d("MAWIndexedDbMetadata").ebdbName(d("MAWCurrentUser").getID()),c("qpl")._(1056840657,"2716"),d("WAHex").parseHex(c("MessengerWebInitData").accountKeyV2),d("EBDB").EBDBEnvironment.Worker,d("MAWWormOdsLogger").wormOdsWorkerLogger)});yield a.measureMawInit("make_cache_service_db",function(){return d("MAWCacheServiceDB").getOrSetupMAWCacheDB()});h!=null&&(yield h.makeEBMinosDevDB(d("MAWIndexedDbMetadata").ebMinosDbDevName(d("MAWCurrentUser").getID()),c("qpl")._(1056840657,"2716"),d("WAHex").parseHex(c("MessengerWebInitData").accountKeyV2)));c("promiseDone")(d("MAWStartupJob").runMAWStartupJobs())});return i.apply(this,arguments)}g.setupAllDatabases=a}),98);
__d("MAWSetupWorkerMsg",["FBLogger","ifRequired"],(function(a,b,c,d,e,f,g){"use strict";b=function(){function a(a,b){this.setupHash=a,this.currentWorker=b}var b=a.prototype;b.postAck=function(){this.currentWorker.postMessage({setupHash:this.setupHash,type:"worker-setup-ack"})};b.postSuccess=function(){this.currentWorker.postMessage({setupHash:this.setupHash,status:"success",type:"worker-setup"})};b.postFailure=function(a){this.currentWorker.postMessage({msg:a,setupHash:this.setupHash,status:"failure",type:"worker-setup"})};b.postNoActionRequired=function(){this.currentWorker.postMessage({action:"no-action",setupHash:this.setupHash,status:"already-setup",type:"worker-setup"})};b.postRebootRequired=function(a){this.currentWorker.postMessage({action:"reboot-required",reason:a,setupHash:this.setupHash,status:"already-setup",type:"worker-setup"})};b.postBackendState=function(a){this.currentWorker.postMessage({backendState:a,setupHash:this.setupHash,type:"worker-setup-ack"})};return a}();function a(a){var b;(b=c("ifRequired")("CurrentSharedWorkerExperimental",function(b){b.shutdownWorker(a)},function(){}))!=null?b:c("ifRequired")("CurrentSharedWorker",function(b){b.shutdownWorker(a)},function(){throw c("FBLogger")("messenger_web").mustfixThrow("Failed to update shared worker, reason: "+(a!=null?a:""))})}g.WorkerSetupComms=b;g.shutdownSharedWorker=a}),98);
__d("MAWWorkerEBDeps",["EBDeps","EBLS"],(function(a,b,c,d,e,f,g){"use strict";function a(){d("EBDeps").setDeps({getLSDB:function(){return d("EBLS").init().then(function(a){return a.db})}},"MAW worker")}g.initEBDeps=a}),98);
__d("MessengerInfraReportUtils",[],(function(a,b,c,d,e,f){"use strict";a=function(a){return a===2};b=function(a){switch(a){case 1:return"START";case 2:return"SUCCESS";case 3:return"FAIL";case 4:return"CANCEL";case 113:return"TIMEOUT";case 706:return"CANCEL_UNLOAD";case 4158:return"INVALID";case 87:return"ERROR";case 5947:return"SUCCESS_PAST_TIMEOUT";case 160:return"OFFLINE";default:return String(a)}};f.isQplActionSuccessful=a;f.qplStatusStr=b}),66);
__d("MessengerInfraQplReport",["FBLogger","MAWCurrentUser","MWBroadcastChannel","MessengerInfraReport","MessengerInfraReportUtils","QPLEvent","QuickPerformanceLogger","memoizeOneWithArgs"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=(a={},a[1056839232]={annotations:{string:["errorDescription","failReason","backendAckState"]},name:"MAW_TTRC",single:!0},a[25310776]={annotations:{string:["errorDescription","failReason"]},name:"MAW_INIT",single:!0},a[25305590]={annotations:{string:["uncaught_error"]},name:"LS_INIT",single:!0},a[25313175]={annotations:{"int":["errorCode","applicationError"],string:["errorDescription","thread_type"],string_array:["worker_restart_msgs","worker_restart_reasons"]},name:"MESSAGE_SEND_TO_SENT",single:!1},a[30605380]={annotations:{string:["thread_type","cancelType"]},name:"CHAT_TAB_OPEN",single:!1},a[25303796]={annotations:{string:["eb_failure_reason","range_extension_error","cancel_reason"]},name:"LOAD_MORE_MESSAGES",single:!1},a[1056843758]={annotations:{string:["range_extension_error"],string_array:["message_ranges_source"]},name:"MAW_MLV2_RANGE_EXTENSION",single:!1},a[30605361]={annotations:{string:["cancelType"]},name:"POPOVER_SHOW",single:!1},a[398998698]={annotations:{bool:["isE2eeMandated"],string:["errorDescription"]},name:"E2EE_COMPONENTS_CREATION",single:!1},a[398997251]={annotations:{string:["endCallReason"]},name:"CALL_JOIN",single:!1},a[398989351]={name:"ZENON_SDK",single:!1},a[521476165]={annotations:{string:["type","taskSource","triggerType","querySource","error","exception","thread_state_by_jid"]},name:"RESTORE_END_TO_END",single:!1},a[521471755]={annotations:{string:["error_description","exception","source","restoreType"]},name:"EB_API_MESSAGE_RANGE_QUERY",single:!1},a[25302828]={annotations:{string:["fail_reason"]},name:"MEDIA_RENDER",single:!1},a[1056846543]={annotations:{bool:["is_otid","is_thread_requested"],string:["threadState","description"]},name:"MAW_ON_ACT_THREAD_READY_USAGE",single:!1},a[25302828]={annotations:{string:["fail_reason"]},name:"MEDIA_RENDER",single:!1},a[521474469]={name:"EB_API_MESSAGE_POINT_QUERY",single:!1},a[521473213]={name:"EB_API_MEDIA_RESTORE_PROBE",single:!1},a[521476367]={name:"EB_API_MESSAGE_RANGE_QUERY_SEARCH",single:!1},a[521477507]={name:"EBLSDB_INIT",single:!0},a[1056836502]={annotations:{bool:["isMawThreadCreated","hasMappingRowAlready","hasPlaceholderRowInserted","isResultVerified"],string:["flushReason","trigger"]},name:"THREAD_MAPPING",single:!1},a[521471024]={annotations:{string:["backup_id"]},name:"FETCH_BACKUP_IDS",single:!1},a[25307273]={annotations:{string:["errorMsg"]},name:"MAW_DEVICE_REGISTRATION_ALL",single:!0},a),k=c("memoizeOneWithArgs")(function(a){return d("MWBroadcastChannel").MWBroadcastChannel("msgr_qpl_logger_"+a)}),l="not_started";b=function(){return l};e=function(){try{if(d("MessengerInfraReport").isEPD()){l="epd_blocked";return function(){}}var a=k(d("MAWCurrentUser").getID()),b=function(a){if(e[a.data[0]]==null)return c("FBLogger")("msgr_web_flytrap").warn("Handler %s is not set for QPL listener",a.data[0]);switch(a.data[0]){case"onMarkerEnd":e.onMarkerEnd==null||e.onMarkerEnd.apply(e,a.data[1]);break;case"onAnnotation":e.onAnnotation==null||e.onAnnotation.apply(e,a.data[1]);break;case"onMarkerStart":e.onMarkerStart==null||e.onMarkerStart.apply(e,a.data[1]);break;case"onMarkerPoint":e.onMarkerPoint==null||e.onMarkerPoint.apply(e,a.data[1]);break;default:c("FBLogger")("maw_init").mustfix("Must implement QPL forwarding for event name: %s",a.data[0])}};a.addEventListener("message",b);var e={onAnnotation:function(a,b,c,d,e){n(a,b,c,d,e)},onMarkerEnd:function(a,b,c){o(a,b,c)},onMarkerPoint:function(a,b,c,d){p(a,b,c,d)},onMarkerStart:function(a,b){q(a,b)}},f=(i||(i=c("QuickPerformanceLogger"))).addListener(e);l="started";return function(){f.dispose(),a.removeEventListener("message",b)}}catch(a){l="error";c("FBLogger")("msgr_web_flytrap").catching(a).mustfix("Failed to initialize QPL logger");return function(){}}};f=function(a){return(a=(a=j[a])==null?void 0:a.name)!=null?a:"UNKNOWN_QPL_NAME"};a=function(a){a=(h||(h=d("QPLEvent"))).getMarkerId(a);return j[a]};var m=function(a,b){a=d("MessengerInfraReport").getEventData(a,b);return a};function n(a,b,c,d,e){a=a.i;var f=j[a];if(!f)return;if(!((f=f.annotations)!=null&&(f=f[e])!=null&&f.includes(c)))return;e=m(a,b);if(!e)return;if(e.status!==1)return;e.annotations[c]=d}function o(a,b,c){b=b.i;var e=j[b];if(!e)return;var f=m(b,c);if(!f)return;if(f.status!==1)return;e.single&&(f.status=a,f.latestTimestampMs=Date.now());e.single||(d("MessengerInfraReportUtils").isQplActionSuccessful(a)?d("MessengerInfraReport").deleteEventData(b,c):(f.status=a,f.latestTimestampMs=Date.now()))}function p(a,b,c,d){a=a.i;var e=j[a];if(!e)return;var f=m(a,b);if(!f)return;if(f.status!==1)return;f.lastPoints.push(c);if(d!=null&&e.annotations!=null){a=function(a){var b;if(d[a]==null)return 1;(b=e.annotations)==null||b[a].forEach(function(b){var c;c=(c=d[a])==null?void 0:c[b];c!=null&&(f.annotations[b]=c)})};for(b of Object.keys(e.annotations))if(a(b))continue}}function q(a,b){a=a.i;var c=j[a];if(!c)return;var e=m(a,b);if(e!=null&&e.status!==1)return;d("MessengerInfraReport").storeEventData(a,{annotations:{},lastPoints:[],single:c.single,status:1},b)}g.ReportedQPLEvents=j;g.getLoggerTabCommunication=k;g.getQplLoggerInitStatus=b;g.initializeLogger=e;g.getQplName=f;g.getReportedEvent=a;g.getCurrentEventData=m;g.onAnnotationHandler=n;g.onMarkerEndHandler=o;g.onMarkerPointHandler=p;g.onMarkerStartHandler=q}),98);
__d("MessengerInfraQplReportInWorker",["MessengerInfraQplReport","MessengerInfraReport","QuickPerformanceLogger"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(){if(d("MessengerInfraReport").isEPD())return function(){};var a=(h||(h=c("QuickPerformanceLogger"))).addListener({onAnnotation:function(a,b,c,e,f){d("MessengerInfraQplReport").onAnnotationHandler(a,b,c,e,f)},onMarkerEnd:function(a,b,c){d("MessengerInfraQplReport").onMarkerEndHandler(a,b,c)},onMarkerPoint:function(a,b,c,e){d("MessengerInfraQplReport").onMarkerPointHandler(a,b,c,e)},onMarkerStart:function(a,b){d("MessengerInfraQplReport").onMarkerStartHandler(a,b)}});return function(){a.dispose()}};g.initializeWorkerLogger=a}),98);
__d("getBroadcastChannelForExecutionContext",["CometTaskFrameworkTypes","MWBroadcastChannel"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return d("MWBroadcastChannel").MWBroadcastChannel(d("CometTaskFrameworkTypes").TASK_FRAMEWORK_PREFIX+"_"+String(a))}g["default"]=a}),98);
__d("loadTaskHandlerResource",["asyncToGeneratorRuntime","cr:3760"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return h.apply(this,arguments)}function h(){h=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=b("cr:3760").TASK_HANDLERS_RESOURCES[a];return a==null?null:a.getModuleIfRequired()||a.load()});return h.apply(this,arguments)}g["default"]=a}),98);
__d("registerExecutionContext",["BroadcastChannelClientServerHandshake","FBLogger","asyncToGeneratorRuntime","getBroadcastChannelForExecutionContext","loadTaskHandlerResource","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";function h(a,b){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var d=a.context,e=a.name,f=a.payload;try{var g=(yield c("loadTaskHandlerResource")(e));if(g==null)throw c("FBLogger")("messenger_web").mustfixThrow("No task handler found in context %s",e);e=(yield g.handleTask(f,d));g={context:d,result:e,type:"task_success"};b.postMessage(g)}catch(g){c("FBLogger")("messenger_web").catching(g).mustfix("%s executionContext: Failed to execute task %s",String(a.context.executionContext),a.name);e={context:d,reason:(f=g.message)!=null?f:"",type:"task_failure"};b.postMessage(e)}return});return i.apply(this,arguments)}function a(a){var b=c("getBroadcastChannelForExecutionContext")(a);d("BroadcastChannelClientServerHandshake").listen(b);var e=new Set();b.addEventListener("message",function(a){switch(a.data.type){case"execute_task":a=a.data;var d=a.context.taskID;if(e.has(d))return;e.add(d);c("promiseDone")(h(a,b)["finally"](function(){e["delete"](d)}));break;default:}});return function(){return b.close()}}g["default"]=a}),98);
__d("registerMAWExecutionContext",["CometTaskFrameworkTypes","registerExecutionContext"],(function(a,b,c,d,e,f,g){"use strict";function a(){return c("registerExecutionContext")(d("CometTaskFrameworkTypes").ExecutionContext.MAW_WORKER)}g["default"]=a}),98);
__d("MAWCommonMainWebWorker",["BackendInitLoggingUtils","BrowserLockManager","EBIsEbEnabledSubscriber","EBLS","FBLogger","IGDWebUtils","MAWBackendBridgeSetup","MAWBridge","MAWCompareWorkerSetupArgs","MAWDataSyncQueue","MAWDeleteOldLogsFromDisk","MAWDeviceRegistrationInitWorker","MAWGetDbVersion","MAWLoggingSwitches","MAWQplProxy","MAWRotateDTSG","MAWSetupAllDatabases","MAWSetupWorkerMsg","MAWVaultMaterials","MAWWebWorkerLogger","MAWWorkerEBDeps","MAWWorkerSetupArgs","MessengerInfraQplReportInWorker","WACrossWorkerPortal","WADevToolsBridge","WAGetSafeQPLError","WALogger","asyncToGeneratorRuntime","gkx","justknobx","pageID","promiseDone","qpl","registerMAWExecutionContext"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j=c("justknobx")._("1495"),k,l,m=!1;d("BackendInitLoggingUtils").initializeBackendLogging();function a(a){if(m){d("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["Worker should not run initWorker() more than once."])));return}var e=a.currentWorker,f=d("MAWBackendBridgeSetup").initWorkerBridge(e);d("MessengerInfraQplReportInWorker").initializeWorkerLogger();v(e);e.addMessageListener("worker-setup",function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){yield n(b,a,f)});return function(a){return c.apply(this,arguments)}}());d("MAWWorkerEBDeps").initEBDeps();l=c("BrowserLockManager")!=null&&!j?w():null;e.addMessageListener("force-flush-data",function(){self.dispatchEvent(new CustomEvent("force-flush-logs")),c("promiseDone")(d("MAWDataSyncQueue").forceFlushDataSyncQueue())});e.addMessageListener("force-flush-logs-only",function(){self.dispatchEvent(new CustomEvent("force-flush-logs"))});m=!0}function n(a,b,c){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e){var f=b.config,g=b.currentWorker;g=new(d("MAWSetupWorkerMsg").WorkerSetupComms)(a.setupHash,g);g.postAck();d("MAWQplProxy").resolveWorkerBridge();var h=d("MAWWorkerSetupArgs").getWorkerSetupArgs();try{h==null?yield p(a,b,e,g):yield r(h,a,f,g)}catch(a){c("gkx")("23986")&&c("promiseDone")(d("MAWWebWorkerLogger").flushLogs());g.postFailure(d("WAGetSafeQPLError").getSafeQPLErrorMessage(a));throw a}});return o.apply(this,arguments)}function p(a,b,c,d){return q.apply(this,arguments)}function q(){q=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f){if(!e.success){f.postFailure((e=(e=e.payload)==null?void 0:e.message)!=null?e:"bridge_setup_fail");return}var g=b.config,h=b.initBackend,i=b.makeLowLevelApi;d("MAWWorkerSetupArgs").setWorkerSetupArgs(a.content);f.postBackendState("starting_new_setup");t(a.content.vaultMaterials,f);d("MAWGetDbVersion").setArmadilloDbVersionForTest(a.content.testDbVersion);l=l!=null?l:w();k=l.then(function(a){var b=a.hmacKey;a=a.regData;return h(a,b,d("MAWBridge").getBridge(),i(a.regInfo),g)});d("MAWLoggingSwitches").removeLoggingFromBridge&&void d("MAWDeleteOldLogsFromDisk").deleteOldLogsOnStartup();u(a.content.devToolMessageChannelPort2);d("EBLS").init().then(function(a){return d("EBIsEbEnabledSubscriber").initIsEbEnabledPubSub(a.db)})["catch"](function(){d("MAWQplProxy").sendQplPointThroughBridge(c("qpl")._(25310776,"6155"),"ebls_init_failed")});yield k;c("registerMAWExecutionContext")();f.postSuccess()});return q.apply(this,arguments)}function r(a,b,c,d){return s.apply(this,arguments)}function s(){s=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,e,f){if(!e.isSharedWorkerContext())throw c("FBLogger")("messenger_web").mustfixThrow("only shared workers can perform re-init!");a=d("MAWCompareWorkerSetupArgs").didWorkerSetupArgsChange(a,b.content);if(a.hasArgsChanged){f.postRebootRequired(a.reason);if(e.isSharedWorkerContext()){b="update-required-"+a.reason;d("MAWSetupWorkerMsg").shutdownSharedWorker(b)}else self.close();return}k==null&&f.postFailure("No setup happened");f.postBackendState("setup_ongoing");yield k;f.postNoActionRequired()});return s.apply(this,arguments)}function t(a,b){if(c("gkx")("23909")){if(a==null||a.encryptionKey==null||a.prefixAndSuffix==null){b.postFailure("null_vault_materials");throw c("FBLogger")("messenger_web").mustfixThrow("Vault materials was null in worker setup")}d("MAWVaultMaterials").initializeVaultMaterials(a)}else d("IGDWebUtils").isOnInstagramWeb()||c("FBLogger")("messenger_web").mustfix("[Vaulting] Vaulting GK disabled on worker init")}function u(a){if(c("gkx")("3282"))if(a==null)d("WALogger").ERROR(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Missing DevTool port. Not able to setup DevTool"])));else{var b=d("WACrossWorkerPortal").attachPortal(d("WADevToolsBridge").getDevToolBridge(),["devtool","mawDbDevTool"],function(a,b){a.push(b);return a},c("pageID"));b.setPort(a)}}function e(a,b){k=a,m=b}function v(a){a.postMessage({status:"worker-ready",type:"worker-setup"})}function w(){return x.apply(this,arguments)}function x(){x=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){c("promiseDone")(d("MAWRotateDTSG").tryRotateDTSG());yield d("MAWSetupAllDatabases").setupAllDatabases();d("BackendInitLoggingUtils").MAWMICPoint("backend_db_ready");return d("MAWDeviceRegistrationInitWorker").registerDevice().then(function(a){d("BackendInitLoggingUtils").MAWMICPoint("backend_device_ready");return a})});return x.apply(this,arguments)}g.initWorker=a;g.presetBackend_TEST_ONLY=e}),98);
__d("WorkerBanzaiLazyQueueChannelWorker",["BanzaiLazyQueue","WorkerFuncChannel"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=d("WorkerFuncChannel").importChannel({queuePost:null},a,"banzai_lazyqueue_channel");c("BanzaiLazyQueue").onQueue.add(function(){h(b)});h(b)}function h(a){c("BanzaiLazyQueue").flushQueue().forEach(function(b){a.queuePost.apply(a,b)})}g.init=a}),98);
__d("WorkerSelf",["WorkerBanzaiLazyQueueChannelWorker","WorkerFuncChannel","WorkerQPLChannel"],(function(a,b,c,d,e,f,g){"use strict";function a(a){d("WorkerFuncChannel").activateChannels(a,"worker","client"),d("WorkerBanzaiLazyQueueChannelWorker").init(a),d("WorkerQPLChannel").setMessagePort(a)}g.init=a}),98);
__d("WorkerBridgeAdaptor",["WorkerMessagePort","WorkerSelf"],(function(a,b,c,d,e,f,g){"use strict";a=function(a){function b(b,c){var e;e=a.call(this,b,c)||this;e.onmessage=null;d("WorkerSelf").init(e);e.$WorkerBridgeAdaptor$p_1=b;e.onUnhandledMessage.add(function(a){e.onmessage&&e.onmessage({data:a})});return e}babelHelpers.inheritsLoose(b,a);var c=b.prototype;c.getBridgePort=function(){return this};return b}(d("WorkerMessagePort").WorkerSyncedMessagePort);g["default"]=a}),98);
__d("IGDAWMainWebWorker",["CurrentWorkerMessagePort","FalcoLoggerTransports","IGDAWMainWebWorkerConfig","IGDBackend","IGDLowLevelApiImpl","MAWCommonMainWebWorker","WorkerBridgeAdaptor"],(function(a,b,c,d,e,f,g){"use strict";function a(){self.Env=self.Env||{};var a=new(c("WorkerBridgeAdaptor"))(d("CurrentWorkerMessagePort").getMessagePort(),"IGDAWMainWebWorker");d("MAWCommonMainWebWorker").initWorker({config:d("IGDAWMainWebWorkerConfig").waConfig,currentWorker:a,initBackend:d("IGDBackend").startIGDBackend,makeLowLevelApi:d("IGDLowLevelApiImpl").makeLowLevelApi});d("FalcoLoggerTransports").attach()}g["default"]=a}),98);
__d("MAWFetchAndEmitThreadApi",["MAWIndexedDb","MAWThreadFetchAndEmitTxns","MAWTransactionMode"],(function(a,b,c,d,e,f,g){"use strict";b=d("MAWIndexedDb").makeMsgrTransactor({chunk:(a=d("MAWTransactionMode")).READONLY,editMsgHistory:a.READONLY,groupInfo:a.READWRITE,groupInvites:a.READONLY,media:a.READONLY,messages:a.READWRITE,participants:a.READWRITE,poll:a.READONLY,reactions:a.READONLY,receiverFetchInfo:a.READONLY,threads:a.READWRITE,xma:a.READONLY},"fetchAndEmitThread",function(a){return function(b,c){c===void 0&&(c="fetchAndEmitThreadInTxn");return d("MAWThreadFetchAndEmitTxns").fetchAndEmitThread(a,b,void 0,void 0,c)}});g.fetchAndEmitThreadInTxn=b}),98);
__d("MAWSendXMAShareMsgUtils",["MAWBridgeMsg","MAWDbMsgTxns","MAWDexieTable","MAWFrontendMediaUtils","MAWGetDownloadableThumbnailForMediaApi","MAWGetMediaPlaintextApi","MAWGetOrCreateMediaKnownEntriesApi","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWMediaManagementTxns","MAWMediaUtils","MAWMessageSendsCommon","MAWMsgType","MAWStartMediaUploadQplFlow","MAWTransactionMode","MAWUpdateMediaEntryForMsgApi","MAWUpdateMediaEntryForOptimisticUploadApi","MAWUploadAndHandleMedia","MAWXMAManagementTxns","MAWXMAUtils","Promise","WABlobToArrayBuffer","WAJids","asyncToGeneratorRuntime","validateMAWMediaAndComposeEntryForProtoMsg"],(function(a,b,c,d,e,f,g){"use strict";var h,i=d("MAWMessageSendsCommon").messageSendLogger.tags(["XMAShare"]);function j(a,b,c,d,e,f,g){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f,g,h){h=h.get(a);h=h==null?void 0:h.optimisticUploadPromise;if(h!=null)return h;var i=d("MAWStartMediaUploadQplFlow").startMediaUploadQplFlow({chatJid:b,fileSize:f,serverMediaType:e,uploadEntry:"sendXMAShareMsg"});return d("MAWUploadAndHandleMedia").uploadAndHandleMedia({chatJid:b,dbCallbacks:{getDownloadableThumbnailForMedia:d("MAWGetDownloadableThumbnailForMediaApi").getDownloadableThumbnailForMedia,getMediaKnownEntries:d("MAWGetOrCreateMediaKnownEntriesApi").getOrCreateMediaKnownEntries,getMediaPlaintext:d("MAWGetMediaPlaintextApi").getMediaPlaintext,updateMediaEntryForMsg:d("MAWUpdateMediaEntryForMsgApi").updateMediaEntryForMsg,updateMediaEntryForOptimisticUpload:d("MAWUpdateMediaEntryForOptimisticUploadApi").updateMediaEntryForOptimisticUpload},filename:void 0,hash:a,mediaTypeDetails:{mediaType:e,type:"regular"},plaintext:yield d("WABlobToArrayBuffer").blobToArrayBuffer(g.file),protocolMsgId:c,serverMediaType:e,size:f,uploadMediaMetric:i})["catch"](function(a){i.endFail("xma_upload_unknown_failure",{string:{errorDescription:a.toString()}});throw a})});return k.apply(this,arguments)}function a(a){var c=a.chatJid,e=a.favicon,f=a.header,g=a.optimisticUploadManager,i=a.preview,k=a.protocolMsgId;a=[i,e,f].filter(Boolean);i=a.map(function(a){var b=a.dbMedia;a=a.file;var e=d("MAWMediaUtils").getServerMediaTypeFromMediaType(b.mediaType,"xma-media");return j(b.plaintextHash,c,k,e,b.size,a,g).then(function(a){return{media:b,uploadResult:a}})});return(h||(h=b("Promise"))).all(i)}function c(a){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=a.chatJid,e=a.favicon,f=a.header,g=a.optimisticUploadManager,i=a.preview,k=a.protocolMsgId;a=(yield (h||(h=b("Promise"))).all([l(i),l(e),l(f)]));i=a[0];e=a[1];l=a[2];return{favicon:e,header:l,preview:i};function l(a){if(a==null)return(h||(h=b("Promise"))).resolve(null);var e=a.file,f=a.mediaType,i=a.plaintextHash;a=d("MAWMediaUtils").getServerMediaTypeFromMediaType(f,"xma-media");return j(i,c,k,a,e.file.size,e,g).then(function(a){return{plaintextHash:i,uploadResult:a}})}});return l.apply(this,arguments)}function e(a,b,c,d,e,f,g,h,i,j,k){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,d,e,f,g,i,j,k,l,m){a=(yield (h||(h=b("Promise"))).all([n(a,m,"preview"),n(c,m,"header"),n(d,m,"favicon")]));c=a[0];d=a[1];m=a[2];return p(e,c,d,m,f,g,i,j,k,l)});return m.apply(this,arguments)}function f(a){var b=a.associatedMsgId,c=a.chatJid,d=a.db,e=a.faviconMediaEntry,f=a.faviconMetadata,g=a.headerMediaEntry,h=a.headerMetadata,i=a.msgId,j=a.offlineAttachmentId,k=a.previewMediaEntry,l=a.previewMetadata,m=a.targetType,n=a.xmaArgs;a=a.xmaMsgProtocolMsgId;return q({associatedMsgId:b,chatJid:c,db:d,faviconMediaEntry:e,faviconMetadata:f,headerMediaEntry:g,headerMetadata:h,msgId:i,offlineAttachmentId:j,previewMediaEntry:k,previewMetadata:l,targetType:m,xmaArgs:n,xmaMsgProtocolMsgId:a})}function n(a,b,c){return o.apply(this,arguments)}function o(){o=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){if(a==null)return a;var e=a.file,f=d("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(e.type,!0),g=f.mediaType;f=f.serverMediaType;var h=(yield d("MAWMediaUtils").genBlobHashes(e)),j=h[0];h=h[1];if(g!=="Image"){b==null||b("xma_media_type_not_image",{string:{xma_get_media_metadata_source:c,xma_media_type:g}});throw i.mustfixThrow("Expected Image when sending XMA share")}b=(yield d("WABlobToArrayBuffer").blobToArrayBuffer(e));return{blobArrayBuffer:b,file:e,hashedPlaintextHash:h,mediaInfo:{validatedAudioInfo:null,validatedDocumentFileInfo:null,validatedImageInfo:{height:a.height,width:a.width},validatedVideoInfo:null},mediaType:g,plaintextHash:j,serverMediaType:f}});return o.apply(this,arguments)}function p(a,b,c,e,f,g,h,i,j,k){var l;return d("MAWIndexedDb").makeMsgrTransactor({chunk:(l=d("MAWTransactionMode")).READWRITE,media:l.READWRITE,mediaBackup:l.READWRITE,messages:l.READWRITE,unrenderedMessages:l.READWRITE,xma:l.READWRITE},"saveXMAMediaAndMetadata",function(d){return function(){return q({associatedMsgId:g,chatJid:j,db:d,faviconMetadata:e,headerMetadata:c,msgId:a,offlineAttachmentId:k,previewMetadata:b,targetType:f,xmaArgs:i,xmaMsgProtocolMsgId:h})}})()}function q(a){var b=a.associatedMsgId,c=a.chatJid,e=a.db,f=a.faviconMediaEntry,g=a.faviconMetadata,h=a.headerMediaEntry,i=a.headerMetadata,j=a.msgId,k=a.offlineAttachmentId,l=a.previewMediaEntry,m=a.previewMetadata,n=a.targetType,o=a.xmaArgs,p=a.xmaMsgProtocolMsgId;a=new Map();m!=null&&a.set(m.plaintextHash,d("MAWMediaManagementTxns").attachHashAndSaveMedia(e,p,m.blobArrayBuffer,m.plaintextHash,void 0,void 0,m.mediaType,m.mediaInfo,m.file,!0,void 0,l));if(i!=null){l=a.get(i.plaintextHash);l==null&&a.set(i.plaintextHash,d("MAWMediaManagementTxns").attachHashAndSaveMedia(e,p,i.blobArrayBuffer,i.plaintextHash,void 0,void 0,i.mediaType,i.mediaInfo,i.file,!0,void 0,h))}if(g!=null){l=a.get(g.plaintextHash);l==null&&a.set(g.plaintextHash,d("MAWMediaManagementTxns").attachHashAndSaveMedia(e,p,g.blobArrayBuffer,g.plaintextHash,void 0,void 0,g.mediaType,g.mediaInfo,g.file,!0,void 0,f))}h=Array.from(a.values());return d("MAWDexieTable").dexieAll([d("MAWDbMsgTxns").maybeGetMsg(e,b),d("MAWDexieTable").dexieAll(h)]).then(function(a){var f=a[0];a=a[1];a=a.reduce(function(a,b){return a.set(b.plaintextHash,b)},new Map());var h=m!=null?a.get(m.plaintextHash):void 0,l=i!=null?a.get(i.plaintextHash):void 0,q=g!=null?a.get(g.plaintextHash):void 0;d("MAWDexieTable").dexieResolve();return d("MAWXMAManagementTxns").saveXMA(e,h==null?void 0:h.mediaId,l==null?void 0:l.mediaId,q==null?void 0:q.mediaId,n,j,b,p,o,k,h==null?void 0:h.plaintextHash,l==null?void 0:l.plaintextHash,q==null?void 0:q.plaintextHash).then(function(b){d("MAWXMAUtils").isXMAStoryReply(n)&&f!=null?a=r(e,c,b,h,f):a=d("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(e,b,h);return a.then(function(){return{dbXMA:b,faviconDbMedia:q,headerDbMedia:l,previewDbMedia:h}})})})}function r(a,b,c,e,f){var g=d("WAJids").interpretAsUserJid(b);if(g==null)throw i.mustfixThrow("this is a flow check, participant jid can not be null");var h=c.defaultCTA;h=h==null?void 0:h.nativeUrl;g={author:g,expirationTs:c.targetExpiringAtSec,externalId:c.externalId,mediaId:e==null?void 0:e.mediaId,plaintextHash:e==null?void 0:e.plaintextHash,sourceId:h,ts:f.ts,type:d("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:c.targetType};e={content:g,remoteJid:b};if(f.type!==d("MAWMsgType").MSG_TYPE.TEXT)throw i.mustfixThrow("flow check, this message type is only in text type");var j=babelHelpers["extends"]({},f,{quote:e});return a.messages.put(j).then(function(){d("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:d("MAWBridgeMsg").createBridgeMsg(j)})})}function s(a,b){return a==null||b==null?null:{file:a.file,mediaEntry:d("validateMAWMediaAndComposeEntryForProtoMsg").validateMediaEntry(a.plaintextHash,b),mediaInfo:a.mediaInfo,mediaType:a.mediaType}}g.uploadXMAMediasLegacy=a;g.uploadXMAMediasForQuickSend=c;g.saveXMAContentLegacy=e;g.saveXMAContent=f;g.getMediaMetadata=n;g.getXMAMediaMetadataForSending=s}),98);
__d("MAWSendXMAShareMsgImplLegacy",["MAWAckLevel","MAWBridge","MAWExpiredXMACleaner","MAWFetchAndEmitThreadApi","MAWGetMsgIdByProtocolMsgId","MAWMessageSendsCommon","MAWMsgType","MAWMsgUtil","MAWOptimisticUploadManager","MAWQplProxy","MAWSendMediaMsg","MAWSendWrittenMsg","MAWSendXMAShareMsgUtils","MAWVault","MAWWriteOutgoingMsgApi","MAWXMAUtils","Promise","WAArmadilloXMA.pb","WAMediaQplHelper","WAQPLProxy","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l,m,n,o=d("MAWMessageSendsCommon").messageSendLogger.tags(["XMAShare"]);function a(a,b,c,d){return p.apply(this,arguments)}function p(){p=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e,f){var g,p=function(a,b){b===void 0&&(b={}),f!=null&&d("MAWQplProxy").sendQplPointThroughBridge(e,a,{annotations:b,instanceKey:f})};p("received_message_in_wajob");var q=Boolean(a.associatedMsgContent)&&a.associatedMsgContent!=null?d("MAWVault").vault(a.associatedMsgContent):void 0,r=void 0,s=a.associatedMsgContentExternalId,t=a.args.xmaMessageType;if(t==null){o.MUSTFIX(h||(h=babelHelpers.taggedTemplateLiteralLoose(["XMAMessageType is null"])));return d("WAResultOrError").makeError({isRetriable:!1,type:"xma-content-error"})}p("fetch_thread_start");yield d("MAWFetchAndEmitThreadApi").fetchAndEmitThreadInTxn(a.chatJid,"sendXMAShareMsg");p("fetch_thread_end");p("write_msg_to_db_start");var u=(yield d("MAWWriteOutgoingMsgApi").writeOutgoingMsg(a.xmaMsgExternalId,a.chatJid,c,a.args,d("MAWMsgType").MSG_TYPE.XMA,e,f));p("write_msg_to_db_end");if(q!=null&&s!=null){q=babelHelpers["extends"]({},a.args,{content:q});p("write_associated_msg_to_db_start");s=(yield d("MAWWriteOutgoingMsgApi").writeOutgoingMsg(s,a.chatJid,c,q,d("MAWMsgType").MSG_TYPE.TEXT,e,f));if(s.type==="missing_thread"){o.MUSTFIX(i||(i=babelHelpers.taggedTemplateLiteralLoose(["Failed to send xma associated msg - missing thread"])));return d("WAResultOrError").makeError({isRetriable:!1,type:"missing-thread"})}c=(yield d("MAWGetMsgIdByProtocolMsgId").getMsgIdByProtocolMsgId(s.protocolMsgId));if(!c.success){o.MUSTFIX(j||(j=babelHelpers.taggedTemplateLiteralLoose(["Associated Message missing in db"])));return d("WAResultOrError").makeError({isRetriable:!1,type:"missing-referenced-msg"})}r=c.value;p("write_associated_msg_to_db_end")}if(u.type==="missing_thread"){o.MUSTFIX(k||(k=babelHelpers.taggedTemplateLiteralLoose(["Failed to send xma - missing thread"])));return d("WAResultOrError").makeError({isRetriable:!1,type:"missing-thread"})}p("get_underlying_message_start");q=(yield d("MAWGetMsgIdByProtocolMsgId").getMsgIdByProtocolMsgId(u.protocolMsgId));if(!q.success){o.MUSTFIX(l||(l=babelHelpers.taggedTemplateLiteralLoose(["Message missing in db"])));return d("WAResultOrError").makeError({isRetriable:!1,type:"missing-referenced-msg"})}var v=q.value;p("get_underlying_message_end");p("write_xma_content_to_db_start");s=a.previewFile;c=a.headerFile;q=a.faviconFile;g=babelHelpers["extends"]({},a.xmaArgs,{overlayIconGlyph:(g=a.xmaArgs.overlayIconGlyph)!=null?g:d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE,xmaLayoutType:(g=a.xmaArgs.xmaLayoutType)!=null?g:d("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE});t=(yield d("MAWSendXMAShareMsgUtils").saveXMAContentLegacy(s,c,q,v,t,r,u.protocolMsgId,g,a.chatJid,a.args.offlineAttachmentId,p));p("write_xma_content_to_db_end");r=g.targetExpiringAtSec;g=d("MAWXMAUtils").isXMAExpired(!1,r);if(!g&&r!=null)p("add_expired+xma_cleaner_timestamp"),d("MAWExpiredXMACleaner").addNewExpiredXMACleanerTimestamp(r);else if(g){p("send_expired_written_msg_start");r=(yield d("MAWSendWrittenMsg").sendWrittenMsgExternal({protocolMsgId:u.protocolMsgId,type:"message"},d("WAQPLProxy").waQPLProxyStartResume(e,f),"MAWSendXMAShareMsg-isExpired"));r.success===!0?(p("send_expired_written_msg_end"),d("MAWBridge").getBridge().fireAndForget("event","handleMessageSendResult",{report:{chatJid:u.protocolMsgId.chat,content:a.args.content,ephemeralSetting:a.args.ephemeralSetting,externalId:u.protocolMsgId.externalId,initiatingSource:a.args.initiatingSource,messageType:"sendMsg",quote:a.args.quote,source:a.args.source,specialTextSize:a.args.specialTextSize,xmaMessageType:a.args.xmaMessageType},success:!0},!0)):(p("send_expired_written_msg_fail",{string:{errorType:r.error.type}}),d("MAWBridge").getBridge().fireAndForget("event","handleMessageSendResult",{success:!1},!0))}p("upload_media_to_backend_start",{bool:{has_xma_favicon:t.faviconDbMedia!=null,has_xma_header:t.headerDbMedia!=null,has_xma_preview:t.previewDbMedia!=null},string:{xma_favicon_size_bucket:t.faviconDbMedia!=null?d("WAMediaQplHelper").convertIntegerSizeToStringBucket(t.faviconDbMedia.size):void 0,xma_header_size_bucket:t.headerDbMedia!=null?d("WAMediaQplHelper").convertIntegerSizeToStringBucket(t.headerDbMedia.size):void 0,xma_preview_size_bucket:t.previewDbMedia!=null?d("WAMediaQplHelper").convertIntegerSizeToStringBucket(t.previewDbMedia.size):void 0}});var w=d("MAWOptimisticUploadManager").getOptimisticUploadManager();g=(yield d("MAWSendXMAShareMsgUtils").uploadXMAMediasLegacy({chatJid:a.chatJid,favicon:t.faviconDbMedia!=null&&q!=null?{dbMedia:t.faviconDbMedia,file:q}:null,header:t.headerDbMedia!=null&&c!=null?{dbMedia:t.headerDbMedia,file:c}:null,optimisticUploadManager:w,preview:t.previewDbMedia!=null&&s!=null?{dbMedia:t.previewDbMedia,file:s}:null,protocolMsgId:u.protocolMsgId}));r=g.filter(function(a){return!a.uploadResult.success}).length;if(r>0){o.MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Failed to upload media xma"])));p("upload_media_to_backend_fail");yield d("MAWMsgUtil").updateSystemAckWithTxn(v,d("MAWAckLevel").ACK.failed);return d("WAResultOrError").makeError({isRetriable:!1,type:"xma-content-error"})}p("upload_media_to_backend_end");p("write_upload_result_to_db_start");q=g.map(function(a){var c=a.uploadResult;a=a.media;return c.success===!1?(n||(n=b("Promise"))).resolve():d("MAWSendMediaMsg").mediaSender().perisitMediaEntryForQuickMediaSend(a.plaintextHash,v,c.value)});yield (n||(n=b("Promise"))).all(q);p("write_upload_result_to_db_end");p("send_written_msg_start");c=(yield d("MAWSendWrittenMsg").sendWrittenMsgExternal({protocolMsgId:u.protocolMsgId,type:"message"},d("WAQPLProxy").waQPLProxyStartResume(e,f),"MAWSendXMAShareMsg"));if(c.success===!0){p("clean_up_memory_start");g.forEach(function(a){w["delete"](a.media.plaintextHash)});p("clean_up_memory_end");p("send_written_msg_end");t={chatJid:u.protocolMsgId.chat,content:a.args.content,ephemeralSetting:a.args.ephemeralSetting,externalId:u.protocolMsgId.externalId,initiatingSource:a.args.initiatingSource,messageType:"sendMsg",quote:a.args.quote,source:a.args.source,specialTextSize:a.args.specialTextSize,xmaMessageType:a.args.xmaMessageType};return d("WAResultOrError").makeResult(t)}else{p("clean_up_memory_start");g.forEach(function(a){w["delete"](a.media.plaintextHash)});p("clean_up_memory_end");p("send_written_msg_fail",{string:{errorType:c.error.type}});return d("WAResultOrError").makeError(c.error)}});return p.apply(this,arguments)}g["default"]=a}),98);
__d("SharedWorkerBootstrap",["CurrentSharedWorker","CurrentSharedWorkerAdapter"],(function(a,b,c,d,e,f,g){"use strict";function a(a){h(function(){return b.call(null,a)})}function c(a){h(function(){return a})}function h(a){d("CurrentSharedWorker").onInitComplete(function(){var b=a();if(typeof b==="function"||b!==null)try{b(new(d("CurrentSharedWorkerAdapter").CurrentSharedWorkerAdapter)())}catch(a){}})}g.start=a;g.startServerJS=c}),98);
__d("SharedOrWebWorkerBootstrapInit",["SharedWorkerBootstrap","WorkerBootstrap"],(function(a,b,c,d,e,f){"use strict";function a(a){"SharedWorkerGlobalScope"in self&&self instanceof self.SharedWorkerGlobalScope?b("SharedWorkerBootstrap").startServerJS(a):b("WorkerBootstrap").startServerJS(a)}f.startServerJS=a}),66);